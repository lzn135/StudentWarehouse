这个 疯子 整理 的 十 万字 java 面试题 汇总 终于 拿下 40w offer jdk 源码 微 服务 合集 并发 编程 性能 优化 合集 分布式 中间件 合集 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 收藏 党 可以 通过 百度网 盘 下载 全部 文档 链接 提 取码 目录 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 javajdk 源码 合 辑 hashmap 篇 篇 常用 主流 框架 面试 合 辑 spring 框架 篇 springmvc 原理篇 mybatis 框架 篇 netty 篇 微 服务 面试 合 辑 springboot 篇 dubbo 篇 springcloud 篇 并发 编程 面试 篇 合 辑 并发 编程 上 并发 编程 下 分布式 中间件 面试 合 辑 分布式 调用 rpc 篇 分布式 限流 zookeeper 篇 分布式 负载 均衡 nginx 篇 分布式 消息 通讯 rabbitmq 篇 分布式 消息 通讯 kafka 篇 分布式 消息 通讯 activemq 篇 分布式数据库 reids 篇 分布式数据库 mongodb 篇 分布式数据库 memcached 性能 调 优 合集 jvm 性能 优化 面试 篇 tomcat 调 优 面试 篇 mysql 调 优 面试 篇 word 文档 下载 地址 链接 提 取码 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 hashmap 篇 并发 修改 异常 原因 迭代 器 中 修 改数 和 hashmap 中 的 modcount 不相等 目的 暴露 异常 快速 失败 出现 场景 多线程 一个 迭代 器 迭代 一个 线程 增删 操作 迭代 器 迭代 的 时候 使用 hashmap 本身 的 remove 方法 解决方案 多个 线程 操作 使用 或者 hashtable 在 迭代 的 时候 使用 迭代 器 中 的 remove 方法 保存 修 改数 和 modcount 一致 hashmap 底层 数据结构 数组 链表 数组 链表 红 黑 树 其中 红 黑 树 也是 用了 双向 链表 主要 是为了 链表 操作 方 便在 扩容 链表 转 红 黑 树 红 黑 树 转 链表 的 过程中 都要 操作 链表 hash 数组 的 最大值 ltlt 首先 必须 是的 倍数 方便 计算 对应 的 table 下标 为什么 不是 位 高位 为 正负 标识 不能 占有 为什么 不是 位 他 达不到 因为 integer 的 最大值 就是 如果 threadhold 超过 会把 integer 的 最大值 赋 给他 hash 寻址 算法 hash 值 和数 组 长度 做 与 运算 数组 长度 为 的 幂 次方 长度 那么 低位 全部 为 做 运算 那么 下标 肯定 落到 数组 长度 范围内 hashmap 的 put 方法 的 实现 过程 判断 当前 的 数组 是否 为 空 如果 为 空 则 初始化 该 数组 判断 key 是否 为 null 遍历 tab 如果有 key 为 null 的 entry 重新 设置 新 值 返回 oldvalue 没有 找到 则将 keyvalue 封 装成 entry 存到 数组 下标 的 位置 返回 null 根据 key 做 hash 运算 得到 hashcode 根据 hashcode 和数 组 长度 逻辑 与 运算 算出 hashcode 基于 当前 数组 对应 的 数组 下标 i 遍历 tabi 位置 的 链表 当 找到 节点 的 key 和 传入 的 key 相 同时 则 重新 设置 为 新 值 返回 oldvalue 没有 找到 这说明 是 新 的 keymodcount 再将 封 装成 entry 对象 通 过头 插 法 插入 到 改 tabi 位置 如果 当前 size 是否 大于 等于 阈值 并且 当前 桶 位 不为 null 则 进行 扩容 hashmap 扩容 机制 扩容 条件 当前 容量 大于 等于 阈值 并且 当前 桶 位 不为 null 扩容 流程 rehash 当 容量 大于 等于 我们 设置 的 hash 阈值 生成 一个 新 的 hash 种子 new 一个 倍 长度 的 新 数组 循环 每个 桶 上 的 链表 重新 计算 hashcode 然后再 和 新 的 数组 长度 做 与 运算 得到 新 数组 下标 判断 新 数组 当 tabi 位置 是否 有 元素 没有 元素 则 直接 封 装成 entry 对象 赋值 到 当前 tabi 位置 有 元素 则 通 过头 插 法 插入 到 链表 中 再 赋值 到 tabi 位置 hashmap 扩容 产生 循环 链表 场景 两个 多线程 同时 转移 同一个 桶 对应 的 链表 线程 依次 将 链表 倒 序 方式 转移到 新 数组 中 线程 此时 转移 比如 当前 指针 指向 节点 下个 指针 指向 节点 而 链表 中 的 next 节点 指向 的 是 节点 当 插入 的 时候 会 节点 会 指向 节点 节点 指向 节点 形成 环形 链表 影响 put 时候 会 造成 死循环 需要 循环 判断 链表 中 是否 有 相同 的 keyget 时候 会 造成 死循环 hash 运算 的 实现 方式 将 hashcode 高 和 低位 异 或 算出 hash 值 然后再 和 数组 的 长度 比较 要高 和 低 异 或 目的 是 当 数组 的 的 长度 为 的 小于 等于 次方 也是 就是 进制 小于 等于 位 两个 key 的 hashcode 运 算出 的 低位 一样 而 高位 不一样 如果 高 低位 不做 运算 那么 他们 做 与 运算 等到 的 是 通过 样 的 数组 下标 对 每个 hash 值 在他 的 低位 中 让 高 低位 进行了 异 或 让 他 的 低位 同时 保持 了 高 低位 的 特征 尽量 避免 一些 hash 值 后续 出现 冲突 大家 可能会 进入 数组 的 同一个 位置 key 更加 散 列 hashmap 的 put 方法 的 实现 过程 根据 key 生成 hash 值 判断 当前 hashmap 对象 的 数组 是否 为 空 如果 为 空 则 初始化 该 数组 根据 逻辑 与 运算 算出 hashcode 基于 当前 数组 对应 的 数组 下标 i 判断 数组 的 第 i 个 位置 的 元素 tabi 是否 为 空 如果 为 空 则将 keyvalue 封 装成 node 对象 赋值 给 tabi 如果 不为 空 如果 put 方法 传入 进来 的 key 等于 tabikey 那么 证明 存在 相同 的 key 如果 不等于 tabikey 则 如果 tabi 的 类型 是 treenode 则 表示 数组 的 第 i 位置 上 是 一颗 红 黑 树 那么 将 key 和 value 插入 到 红 黑 树 中 并且在 插入 之前 会 判断 在 红 黑 树 中 是否 存在 相同 的 key 如果 tabi 的 类型 不是 treenode 则 表示 数组 的 第 i 位子 上 是 一个 链表 那么 遍历 循环 找 是否 存在 相同 的 key 并且在 遍历 的 过程中 会对 链表 中 的 节 点数 进行 计数 当 遍历 到最后 一个 节点 时 会将 keyvalue 封 装成 node 插入 到 链表 的 尾部 同时 判断 在 插入 新 节点 之前 的 链表 节点 个数 是不是 大于 等于 并且 table 长度 大于 等 如果是 则将 链表 改为 红 黑 树 如果 上述 步骤 中发 现 存在 相同 的 key 则 根据 onlyifabsent 标记 来 判断 是否 需要 更新 value 值 然后 返回 的 元素 个数 size 加 如果 size 大于 扩容 的 阈值 则 进行 扩容 hashmap 扩容 机制 扩容 条件 当前 容量 大于 等于 阈值 或在 树 化 之前 当前 数组 的 长度 小于 链表 长度 大于 等于 也 会 发生 扩容 扩容 流程 new 倍数 组 长度 的 新 数组 节点 对应 的 hashcode 和 新 数组 长度 做 与 运算 结果 为 为 低位 链表 不为 为 高位 链表 低位 插入 新 数组 老 下标 位置 i 高位 插入 新 数组 的 老 数组 长度 老 下标 位置 oldlengthi 判断 是否 进 行树 化 hashmap 树 化 过程 树 化 条件 链表 的 长度 大于 等于 且 数组 的 长度 大于 等于 树 化 实现 现将 单向 链表 转变为 双向 链表 再将 双向 链表 将 头 结点 作为 root 节点 然后 依次 将 next 节点 插入 到 根 节点 转 变红 黑 树 再 插入 时候 key 比较 如果 key 实现 了 comparable 接口 通过 实现 方式 比较 否则 比较 key 的 hashcode 否则 比较 key 的 classgetname 否则 比较 key 的 比较 最后 树 化 后 取出 root 节点 treenode 放到 entry 位置 hashmap 的 get 实现 过程 根据 key 生成 hashcode 如果 数组 为 空 则 直接 返 回空 如果 数组 不为 空 则 利用 hashcode 和数 组 长度 通过 逻辑 与 操作 算出 key 所 对应 的 数组 下标 i 如果 数组 的 第 i 个 位置 上 没有 元素 则 直接 返 回空 如果 数组 的 第 i 个 位置 的 元素 的 key 等于 get 方法 锁 传 进来 的 key 则 返回 该 元素 并 获取 该 元素 的 value 如果 不等于 则 判断 该 元素 还有 没有 下个 元素 如果 没有 返 回空 如果有 则 判断 钙 元素 的 类型 是 链表 节点 还是 红 黑 树 节点 如果是 链表 则 遍历 链表 如果是 红 黑 树 则 遍历 红 黑 树 找到 即 返回 元素 没找到 则 返 回空 hashmap 的 remove 实现 过程 找到 对应 的 位置 和 get 方式 类似 链表 节点 直接 删除 红 黑 树 节点 先 删除 链表 的 对应 的 节点 实现 方式 将 上个 节点 指向 下 下个 节点 然后再 维护 红 黑 树上 的 节点 可能会 发生 退 化成 链表 为什么 使用 红 黑 树 不 使用 avl 树 二分 查找 树 链表 因为 avl 树 插入 节点 或者 删除 节点 整体 的 性能 是 不如 红 黑 树 的 avl 每个 左右 节点 的 高度 是 不能 大于 的 所以 维持 这种 结构 比较 消耗 性能 二分 查找 树 他 的 左右 节点 不平衡 一开始 就 固定 了 root 那么 极端 的 情况下 会 成为 链表 结构 链表 长度 越长 那么 他 的 插入 和 查询 效率 都 很低 而 红 黑 树 他 的 整体 查找 增删 节点 的 效率 都是 比 较高 的 hashmap 什么时候 将 链表 转化成 红 黑 树 当 发现 链表 的 元素 个数 大于 并且 当前 的 数组 长度 大于 等于 的 时候 因为 当 数组 比 较小 的 时候 我们 可以 通过 扩容 的 方式 将 链表 的 长度 变短 这样 就用 树 化 和 hashmap 不同点 结构 使 用了 红 黑 树 插入法 使 用了 头 插 法 多线程 情况 会 出现 循环 链表 导致 cpu 飙升 是 用来 尾 插 法 中 反正 要去 计算 链表 当前 节点 的 个数 需要 遍历 链表 所以 直接 使 用了 尾 插 法 hash 算法 复杂度 的 hash 算法 比 钟 的 更 复杂 hash 算法 越 复杂 生成 hashcode 则 更 散 列 那么 hashmap 中 的 元素 则 更 散 列 更 散 列 则 hashmap 的 查询 性能 更好 jdk 中 没有 红 黑 树 所以 只能 优化 hash 算法 使 元素 更 散 列 中 重 甲 了 红 黑 树 查询 性能 得 到了 保障 所以 可以 简化 一下 hash 算法 毕竟 hash 算法 越 复杂 越 消耗 cpu 扩容 的 过程中 可能会 重新 对 key 进行 哈希 重新 hash 跟 哈希 种子 有 关系 而 中 没有 这 部分 逻辑 扩容 的 条件 不一样 除了 判断 是否 大于 等于 阈值 同时 还 判 断了 tabi 是否 为 空 不为 空 才会 进行 扩容 则没 有这 部分 逻辑 扩容 的 转移 逻辑 不一样 jdk 是 每次 转移 一个 元素 jdk 是 先 算出 当前 位置 高 低位 链表 再 一次性 转移 过去 jdk 多了 一个 apiputifabsent keyvalue 篇 是 怎么 保证 并发 安全 的 主要 利 用了 unsafe 操作 reentrantlock 分段 思想 主要 使 用了 unsafe 操作 中 的 通过 cas 的 方式 修改 对象 的 属性 并发 安全 的 给 数组 的 某个 位置 赋值 并发 安全 的 获取 数组 某个 位置 的 元素 分段 思想 为了 提高 的 并发 量 分 段数 越高 则 支持 的 最大 并发 量 越高 程序员 可以 通过 参 数来 指定 并发 量 concurr renthashmap 的 内 部类 segment 就是 用来 表示 某一个 段 的 reentrantlock 每个 segement 就是 一个 小型 的 hashmap 当 调用 的 put 方法 时 最终 会调 用到 segment 的 put 方法 而 segment 类 继承 了 reentrantlock 所以 segment 自带 可 重入 锁 当 调 用到 segment 的 put 方法 时会 先 利用 可 重入 锁 加锁 加锁 成功 后 再将 待 插入 的 keyvalue 插入 到 小型 hashmap 中 插入 完成后 解锁 的 底层 原理 底层 是 由 两层 嵌套 数组 来 实现 的 对象 中有 一个 属性 segments 类型 为 segmentsegment 对象 中有 一个 属性 table 类型 为 hashentry 当 调用 的 put 方法 时 先 根据 key 计算出 对应 的 segment 数组 下标 j 确定 好 当前 keyvalue 应该 插入 到 哪个 segment 对象 中 如果 segmentsj 为 空 则 利用 自旋 锁 的 方式 在 j 位置 生成 一个 segment 对象 然后 调用 segment 对象 的 put 方法 segment 对象 的 put 方 法会 先 加锁 然后 也 根据 key 计算出 对应 的 hashentry 数组 下标 i 然后 将 keyvalue 封 装为 entry 对象 放入 该 位置 此 过程 和 的 put 方法 一样 然后 解锁 的 put 实现 过程 判断 key 不 能为 null 通过 hashcode 和 segment 数组 长度 算出 segment 下标 判断 segement 是否 为 空 如果 为 空 从 segment 原型 中 获取 segment 初始化 的 属性 用来 初始化 segment 对象 trylock 获取 锁 走 类似 put 的 插入 逻辑 没有 获取 锁 通过 自旋 的 方式 找到 head 节点 算出 key 对应 的 hashentry 数组 下标 i 走 类似 put 的 插入 逻辑 的 扩容 特点 局部 扩容 只 扩容 segment 中 的 hashentry 数组 并且在 单线程 下 扩容 不会有 并发 问题 条件 当 segment 中 hashentry 数组 容量 大于 等于 阈值 就会 发生 扩容 流程 new 倍数 组 长度 得到 新 数组 循环 hashentry 处理 每一个 桶 位 链表 循环 链表 计算出 每个 节点 新 的 数组 的 下标 这里会 找到 不间断 的 局部 链表 都在 同一个 下标 位置 将从 不 变化 的 开始 位置 到 链表 的 尾部 一次性 到 转移到 新 的 数组 下 标上 再循环 链表 将其 他 的 节点 依次 转移到 新 的 数组 中 的 size 第一层 死循环 为 每个 segment 加锁 第二层 循环 累加 每个 segment 的 modcount 和 size 然后 比较 上次 循 环中 的 modcount 总数 和 当前 循环 的 modcount 总和 相等 则 跳出 死循环 返回 size 总和 是 怎么 保证 并发 安全 的 主要 利用 unsafe 操作 synchronized 关键字 主要 使 用了 unsafe 操作 中 的 通过 cas 的 方式 修改 对象 的 属性 并发 安全 的 给 数组 的 某个 位置 赋值 并发 安全 的 获取 数组 某个 位置 的 元素 synchronized 主要 负责 在 需要 操作 某个 位置 时 进行 加锁 该 位置 不 能为 空 比如 向 某个 位置 的 链表 进行 插入 节点 向 某个 位置 的 红 黑 树 插入 节点 jdk 中 其实 仍然 有 分段 锁 的 思想 只不过 jdk 中 段数 是 可以 控制 的 而 jdk 中 是 数组 的 每一个 位置 都有 一把 锁 的 put 实现 过程 首先 根据 key 计算 对应 的 数组 下标 i 如果 该 位置 没有 元素 则 通过 自旋 的 方式 去向 该 位置 赋值 如果 该 位置 有 元素 则 通过 synchronized 将 tabi 元素 加锁 加锁 成功 之后 再 判断 该 元素 的 类型 如果是 链表 节点 则 进行 添加 节 点到 链表 中 如果是 红 黑 树 则 添加到 红 黑 树 中 添加 成功 后走 出了 同步 块 判断 是否 需要 进 行树 化 addcount 这个 方法 的 意思 是 的 元素 个数 加 但是 这个 操作 也是 需要 并发 安全 的 并且 元素 个数 加 成功 后会 继续 判断 是否 需要 进行 扩容 如果 需要 则会 进行 扩容 所以 这个 方法 很重 要 同时 一个 线程 在 put 时 如果 发现 当前 正则 进行 扩容 则 会去 帮助 扩容 的 树 化 树 化 条件 当 发现 链表 的 元素 个数 大于 等于 hashmap 还会 判断 数组 大小 大于 等于 树 化 流程 对 当前 tabi 加锁 锁 treebin 对象 将 链表 转变成 双向 链表 目的 是 方便 红 黑 树 操作 将 双向 链表 插入 到 treebin 中 的 treebin 相当于 红 黑 树 的 壳子 他 本身 就是 红 黑 树 他 有 属性 root 表示 根 节点 无论 树结构 怎么 变 treebin 都不会 变 的 addcount 判断 是否 初始 化了 basecount 没有 通过 自旋 的 方式 去 初始化 通过 随机数 计算出 对应 的 countcells 下标 icountcells 数组 不为 空 判断 当前 conuntcellsi 是否 有 值 有 值 自旋 方式 conuntcellsi 值 为 空 循环 先 自旋 方式 basecount 不成功 则 初始化 countcells 数组 找到 对应 的 countcells 数组 下标 自旋 方式 conuntcellsi 值 再不 成功 再 自旋 的 扩容 扩容 条件 当 一个 线程 自旋 次 为 countercells 都 失败 或 元素 个数 大于 等于 了 阈值 特点 当 线程 在 put 的 时候 发现有 正在 扩容 标记 的 时候 他 会 加入 协助 扩容 扩容 到 一定 程度 就不会 扩容 了 扩容 流程 new 倍数 组 长度 得到 新 数组 首 先为 线程 设置 固定 长度 的 步长 分配 起始 位置 和 结束 位置 每个 线程 都会 扩容 自己 那 部分 每个 线程 先 锁住 桶 依次 将 自己 负责 的 桶 转移到 新 数组 中 节点 对应 的 hashcode 和 新 数组 长度 做 与 运算 结果 为 为 低位 链表 不为 为 高位 链表 低位 插入 新 数组 老 下标 位置 i 高位 插入 新 数组 的 老 数组 长度 老 下标 位置 oldlengthi 这里会 先找 局部 链表 该 链表 从头到尾 节点 的 下标 都 一致 对应 新 数组 的 位置 直接 转移 过去 再将 其他 的 节点 转移 过去 判断 是否 进 行树 化 的 size 累加 countcells 数组 每个 元素 值 再加上 的 remove 减 size 不减 容量 jdk 和 的 区别 jdk 中 没有 分段 锁 而是 使 用了 synchronize 的 来 进行 控制 jdk 中 的 扩容 性能 更高 支持 多线程 同时 扩容 实际上 jdk 中 也 支持 多线程 扩容 因为 jdk 中 的 扩容 是 针对 每个 segment 的 所以 也 可能 多线程 扩容 但是 性能 没有 jdk 高 因为 jdk 中 对于 任何 一个 线程 都可以 去 帮助 扩容 jdk 的 元素 个数 统计 实现 不一样 jdk 是 countercell 数组 元素 basecountjdk 是 通过 循环 遍历 每个 segment 对象 加锁 统计 累加 的 modcount 和 累加 的 size 和 上次 得出 modcount 的 结果 比较 外加 hashmap 中 的 不同点 javajdk 源码 word 文档 下载 地址 链接 提 取码 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 常用 主流 框架 面试 合 辑 spring 框架 篇 什么 是 spring 框架 spring 框架 有 哪些 主要 模块 spring 框架 是 一个 为 java 应用程序 的 开发 提供 了 综合 广泛 的 基础性 支持 的 java 平台 spring 帮助 开发者 解决 了 开发 中 基础性 的 问题 使得 开发人员 可以 专注 于 应用程序 的 开发 spring 框架 本身 亦是 按照 设计 模式 精心 打造 这 使得 我们 可以 在 开发 环境 中 安心 的 集成 spring 框架 不必 担心 spring 是 如何 在 后台 进行 工作 的 spring 框架 至今 已 集 成了 多个 模块 这些 模块 主 要被 分 如 下图 所示 的 核心 容器 数据 访问 集成 webaop 面向 切面 编程 工具 消息 和 测试 模块 使用 spring 框架 能 带来 哪些 好处 下面 列 举了 一些 使用 spring 框架 带来 的 主要 好处 di 方法 使得 构造 器 和 文件 中 的 依赖 关系 一目了然 与 ejb 容器 相比较 ioc 容器 更加 趋向于 轻量级 这样一来 ioc 容器 在 有限 的 内存 和 cpu 资源 的 情况下 进行 应用程序 的 开发 和 发布 就 变得 十分 有利 spring 并没有 闭门造车 spring 利 用了 已有 的 技术 比如 orm 框架 logging 框架 jeequartz 和 jdktimer 以及 其他 视图 技术 spring 框架 是 按照 模块 的 形式 来 组织 的 由 包 和 类 的 编号 就可以 看出 其 所属 的 模块 开发者 仅仅 需要 选用 他们 需要 的 模块 即 可要 测试 一项 用 spring 开发 的 应用程序 十分 简单 因为 测试 相关 的 环境 代码 都 已经 囊括 在 框架 中了 更加 简单 的 是 利用 javabean 形式 的 pojo 类 可以 很 方便 的 利用 依赖 注入 来 写入 测试数据 spring 的 web 框架 亦是 一个 精心设计 的 webmvc 框 架为 开发者 们 在 web 框架 的 选择 上 提供 了 一个 除了 主流 框架 比如 struts 过度 设计 的 不流行 web 框架 的 以外 的 有力 选项 spring 提供 了 一个 便捷 的 事务管理 接口 适用于 小型 的 本地 事物 处理 比 如在 单 db 的 环境 下 和 复杂 的 共同 事物 处理 比如 利用 jta 的 复杂 db 环境 什么 是 控制 反转 ioc 什么 是 依赖 注入 控制 反转 是 应用于 软件工程 领 域中 的 在运 行时 被 装 配器 对象 来 绑定 耦合 对象 的 一种 编程 技巧 对象 之间 耦合 关系 在 编译 时 通常是 未知 的 在 传统 的 编程 方式 中 业务 逻辑 的 流程 是 由 应用程序 中 的 早 已被 设 定好 关联 关系 的 对象 来 决定 的 在 使用 控制 反转 的 情况下 业务 逻辑 的 流程 是 由 对象 关系 图 来 决定 的 该 对象 关系 图 由 装 配器 负责 实例 化 这种 实现 方式 还 可以 将 对象 之间 的 关联 关系 的 定义 抽象化 而 绑定 的 过程 是 通过 依赖 注入 实现 的 控制 反转 是 一种 以 给予 应用程序 中 目标 组件 更多 控 制为 目的 设计 范式 并在 我们 的 实际 工作中 起 到了 有效 的 作用 依赖 注入 是 在 编译 阶段 尚 未知 所需 的 功能 是 来自 哪个 的 类 的 情况下 将其 他 对象 所 依赖 的 功能 对象 实例 化 的 模式 这就 需要 一种 机制 用来 激活 相应 的 组件 以 提供 特定 的 功能 所以 依赖 注入 是 控制 反转 的 基础 否则 如果在 组件 不受 框架 控制 的 情况下 框架 又 怎么 知道 要 创建 哪个 个 组件 在 java 中 依然 注入 有 以下 三种 实现 方式 构造 器 注入 setter 方法 注入 接口 注入 请 解释 下 spring 框架 中 的 iocspring 中 的 包 和 包 构 成了 spring 框架 ioc 容器 的 基础 beanfactory 接口 提供 了 一个 先进 的 配置 机制 使得 任何 类型 的 对象 的 配置 成为可能 接口 对 beanfactory 是 一 个子 接口 进行了 扩展 在 beanfactory 的 基础上 添 加了 其他 功能 比 如与 spring 的 aop 更 容易 集成 也 提供 了 处理 messageresource 的 机制 用于 国际化 事件 传播 以及 应用层 的 特别 配置 比如 针对 web 应用 的 是 springioc 容器 的 具体 实现 用来 包装 和 管理 前面 提到 的 各种 beanbeanfactory 接口 是 springioc 容器 的 核心 接口 ioc 把 对象 的 创建 初始化 销毁 交给 spring 来 管理 而 不是 由 开发者 控制 实现 控制 反转 beanfactory 和 有 什么区别 beanfactory 可以 理解为 含有 bean 集合 的 工厂 类 beanfactory 包 含了 种 bean 的 定义 以 便在 接 收到 客户端 请求 时 将 对应 的 bean 实例 化 beanfactory 还 能在 实例 化 对象 的 时 生成 协作 类 之间 的 关系 此举 将 bean 自身 与 bean 客户端 的 配置 中 解放出来 beanfactory 还 包 含了 bean 生命周期 的 控制 调用 客户端 的 初始化 方法 和 销毁 方法 从表面上看 如同 beanfactory 一样 具有 bean 定义 bean 关联 关系 的 设置 根据 请求 分发 bean 的 功能 但 在此基础上 还 提供 了 其他 的 功能 提供 了 支持 国际化 的 文本 消息 统一 的 资源 文件 读取 方式 已在 监听器 中 注册 的 bean 的 事件 以下 是 三种 较 常见 的 实现 方式 从 classpath 的 xml 配置文件 中 读取 上下文 并 生成 上下文 定义 应用程序 上下文 从 程序 环境变量 中 beanxml 由 文件 系统 中 的 xml 配置文件 读取 上下文 beanxml 由 web 应用 的 xml 文件 读取 上下文 基于 java 配置 启动 容器 spring 有 几种 配置 方式 将 spring 配置 到 应用 开发 中有 以下 三种 方式 基于 xml 的 配置 基于 注解 的 配置 基于 java 的 配置 如 何用 基于 xml 配置 的 方式 配置 spring 在 spring 框架 中 依赖 和 服务 需 要在 专门 的 配置文件 来 实现 我 常用 的 xml 格式 的 配置文件 这些 配置文件 的 格式 通常 ltbeansgt 开头 然后 一系列 的 bean 定义 和 专门 的 应用 配置 选项 组成 springxml 配置 的 主要 目的 时候 是 使 所有 的 spring 组件 都 可以用 xml 文件 的 形式 来 进行 配置 这 意味着 不会 出现 其他 的 spring 配置 类型 比如 声明 的 方式 或 基于 javaclass 的 配置 方式 spring 的 xml 配置 方式 是 使用 被 spring 命名 空间 的 所 支持 的 一系列 的 xml 标签 来 实现 的 spring 有 以下 主要 的 命名 空间 和 aso 如 下面 这个 webxml 仅仅 配置 了 这件 最 简单 的 配置 便能 满足 应用程序 配置 运行时 组件 的 需求 如 何用 基于 java 配置 的 方式 配置 springspring 对 java 配置 的 支持 是 由 configuration 注解 和 bean 注解 来 实现 的 由 bean 注解 的 方法 将会 实例 化 配置 和 初始化 一个 新 对象 这个 对象 将由 spring 的 ioc 容器 来 管理 bean 声明 所 起到 的 作用 与 ltbeangt 元素 类似 被 configuration 所 注解 的 类 则 表示 这个 类 的 主要 目的 是 作为 bean 定义 的 资源 被 configuration 声明 的 类 可以 通过 在 同一个 类 的 内部 调用 bean 方法来 设置 嵌入 bean 的 依赖 关系 最 简单 的 configuration 声明 类 请 参考 下面 的 代码 对于 上面 的 beans 配置文件 相同 的 xml 配置文件 如下 上述 配置 方式 的 实例 化 方式 如下 利用 stringargs appconfigclass myserviceclass 要 使用 组件 组建 扫描 仅 需用 configuration 进行 注解 即可 在上 面的 例子 中 comacme 包 首先 会被 扫到 然后再 容器 内 查找 被 component 声明 的 类 找到 后 将 这些 类 按照 sringbean 定义 进行 注册 如果 你 要在 你 的 web 应用 开发 中选 用 上述 的 配置 的 方式 的话 需要用 类 来 读取 配置文件 可以 用来 配置 spring 的 servlet 监听器 或者 springmvc 的 怎样用 注解 的 方式 配置 springspring 在 版本 以后 开始 支持 用 注解 的 方式 来 配置 依赖 注入 可以用 注解 的 方式 来 替代 xml 方式 的 bean 描述 可以 将 bean 描述 转移到 组件 类 的 内部 只需 要在 相关 类 上 方法 上 或者 字段 声明 上 使用 注解 即可 注解 注入 将 会被 容器 在 xml 注入 之前 被 处理 所以 后者 会 覆 盖掉 前者 对于 同一个 属性 的 处理结果 注解 装 配在 spring 中 是 默认 关闭 的 所以 需 要在 spring 文件 中 配置 一下 才能 使用 基于 注解 的 装配 模式 如果 你 想要 在你 的 应用程序 中 使用 关于 注解 的 方法 法 的话 请 参考 如下 的 配置 在 标签 配置 完成 以后 就 可以用 注解 的 方式 在 spring 中 向 属性 方法 和 构造 方法 中 自动 装配 变量 下面 是 几种 比较 重要 的 注解 类型 required 该 注解 应用于 设 值 方法 autowired 该 注解 应用于 有 值 设 值 方法 非 设 值 方法 构造 方法 和 变量 qualifier 该 注解 和 autowired 注解 搭配 使用 用于 消除 特定 bean 自动 装配 的 歧义 支持 基于 jsr 注解 的 以下 注解 和 predestroy 请 解释 springbean 的 生命周期 springbean 的 生命周期 简单 易懂 在 一个 bean 实例 被 初始 化时 需要 执行 一系列 的 初始化 操作 以 达到 可用 的 状态 同样 的当 一个 bean 不 在被 调 用时 需要 进行 相关 的 析 构 操作 并从 bean 容器 中 移除 负责 管理 在 spring 容器 中被 创建 的 bean 的 生命周期 bean 的 生命周期 由 两组 回 调 callback 方法 组成 初始化 之后 调用 的 回 调 方法 销毁 之前 调用 的 回 调 方法 spring 框架 提供 了 以下 四种 方式 来 管理 bean 的 生命周期 事件 和 disposablebean 回 调 接口 针对 特殊 行为 的 其他 aware 接口 bean 配置文件 中 的 custominit 方法 和 destroy 方法 postconstruct 和 predestroy 注解 方式 使用 custominit 和 customdestroy 方法 管理 bean 生命周期 的 代码 样 例 如下 的 作用 域 之间 有 什么区别 spring 容器 中 的 bean 可以 分为 个 范围 所有 范围 的 名称 都是 自 说明 的 但是 为了 避免 混淆 还是 让我们 来 解释一下 singleton 这种 bean 范围 是 默认 的 这种 范围 确保 不管 接受到 多少个 请求 每个 容器 中 只有 一个 bean 的 实例 单 例 的 模式 由 beanfactory 自身 来 维护 prototype 原形 范围 与 单 例 范围 相 反为 每一个 bean 请求 提供 一个 实例 request 在 请求 bean 范围内 会 每一个 来自 客户端 的 网络 请求 创建 一个 实例 在 请求 完成 以后 bean 会 失效 并 被 垃圾 回收 器 回收 session 与 请求 范围 类似 确保 每个 session 中有 一个 bean 的 实例 在 session 过期 后 bean 会 随之 失效 和 portlet 应用 相关 当你 的 应用 部署 在 portlet 容器 中 工作 时 它 包含 很多 portlet 如果 你 想要 声明 让 所有 的 portlet 共用 全局 的 存储 变量 的话 那么 这 全局变量 需要 存储 在 globalsession 中 全局 作用 域 与 servlet 中 的 session 作用 域 效果 相同 什么 是 在 spring 框架 中 无论 何时 bean 被 使 用时 当 仅 被 调 用了 一个 属性 一个 明智 的 做法 是 将 这个 bean 声 明为 内部 bean 内部 bean 可以用 setter 注入 属性 和 构造 方法 注入 构造 参数 的 方式 来 实现 比 如在 我们 的 应用程序 中一 个 customer 类 引 用了 一个 person 类 我们 的 要做 的 是 创建 一个 person 的 实例 然后 在 customer 内部 使用 内部 bean 的 声明 方式 如下 框架 中 的 单 例 beans 是 线程 安全 的 么 spring 框架 并没有 对 单 例 bean 进行 任何 多线程 的 封装 处理 关于 单 例 bean 的 线程 安全 和 并发 问题 需要 开发者 自行 去 搞定 但 实际上 大部分 的 springbean 并没有 可变 的 状态 比如 serview 类 和 dao 类 所以在 某种程度 上说 spring 的 单 例 bean 是 线程 安全 的 如果 你 的 bean 有 多种 状态 的话 比如 viewmodel 对象 就需要 自行 保证 线程 安全 最 浅显 的 解决办法 就是 将 多态 bean 的 作用 域 由 singleton 变更为 prototype 请 举例说明 如 何在 spring 中 注入 一个 提供 了 以下 四种 集合 类 的 配置 元素 ltlistgt 该 标签 用来 装配 可 重复 的 list 值 ltsetgt 该 标签 用来 装配 没有 重复 的 set 值 ltmapgt 该 标签 可 用来 注入 键 和 值 可 以为 任何 类型 的 键值 对 ltpropsgt 该 标签 支持 注入 键 和 值 都是 字符串 类型 的 键值 对 下面 看一下 具体 的 例子 如何 向 springbean 中 注入 一个 第一 种方法 是 使用 如 下面 代码 所示 的 ltpropsgt 标签 也 可用 util 命名 空间 来 从 properties 文件 中 创 建出 一个 propertiesbean 然后 利用 setter 方法 注入 bean 的 引用 请 解释 springbean 的 自动 装 配在 spring 框架 中 在 配置文件 中 设定 bean 的 依赖 关系 是 一个 很好 的 机制 spring 容器 还 可以 自动 装配 合作关系 bean 之间 的 关联 关系 这 意味着 spring 可以 通过 向 beanfactory 中 注入 的 方式 自动 搞定 bean 之间 的 依赖 关系 自动 装配 可以 设置 在 每个 bean 上 也 可以 设 定在 特定 的 bean 上下 面的 xml 配置文件 表明 了 如何 根据 名称 将 一个 bean 设置 为 自动 装配 除了 bean 配置文件 中 提供 的 自动 装配 模式 还可 以 使用 autowired 注解 来 自动 装配 指定 的 bean 在 使用 autowired 注解 之前 需要 在 按照 如下 的 配置 方式 在 spring 配置文件 进行 配置 才 可以 使用 也 可以 通过 在 配置文件 中 配置 达到 相同 的 效果 配置 好 以后 就可以 使用 autowired 来 标注 了 请 解释 自动 装配 模式 的 区 别在 spring 框架 中共 有种 自动 装配 让我们 逐一 分析 no 这是 spring 框架 的 默认设置 在 该 设置 下 自动 装配 是 关闭 的 开发者 需要 自 行在 bean 定义 中用 标签 明确 的 设置 依赖 关系 byname 该 选项 可以 根据 bean 名称 设置 依赖 关系 系 当 向 一个 bean 中 自动 装配 一个 属性 时 容器 将 根据 bean 的 名称 自动 在在 配置文件 中 查询 一个 匹配 的 bean 如果 找到 的话 就 装配 这个 属性 如果 没找到 的话 就 报错 bytype 该 选项 可以 根据 bean 类型 设置 依赖 关系 当 向 一个 bean 中 自动 装配 一个 属性 时 容器 将 根据 bean 的 类型 自动 在在 配置文件 中 查询 一个 匹配 的 bean 如果 找到 的话 就 装配 这个 属性 如果 没找到 的话 就 报错 constructor 构造 器 的 自动 装配 和 bytype 模式 类似 但是 仅仅 适用于 与 有 构造 器 相同 参数 的 bean 如果在 容器 中 没有 找到 与 构造 器 参数 类型 一致 的 bean 那么 将会 抛出 异常 autodetect 该 模式 自动 探测 使用 构造 器 自动 装配 或者 bytype 自动 装配 首先 首 先会 尝试 找 合适 的 带 参数 的 构造 器 如果 找到 的话 就是 用 构造 器 自动 装配 如果在 bean 内部 没有 找到 相应 的 构造 器 或者是 无 参 构造 器 容器 就会 自动 选择 bytpe 的 自动 装配 方式 如何 开启 基于 注解 的 自动 装配 要 使用 autowired 需要 注册 可以 有 以下 两种 方式 来 实现 引入 配置文件 中 的 ltbeangt 下 引入 在 bean 配置文件 中直 接 引入 请 举例 解释 required 注解 在产品 级别 的 应用 中 ioc 容器 可能 声 明了 数十万 了 beanbean 与 bean 之间 有着 复杂 的 依赖 关系 设 值 注解 方法 的 短板 之一 就是 验证 所有 的 属性 是否 被 注解 是 一项 十分困难 的 操作 可以 通过 在 中 设置 dependencycheck 来 解决 这个 问 题在 应用程序 的 生命周期 中 你 可能 不大 愿意 花时间 在 验证 所有 bean 的 属性 是否 按照 上下 文件 正确 配置 或者 你 宁可 验证 某个 bean 的 特定 属性 是否 被 正确 的 设置 即使是 用 dependencycheck 属性 也 不能 很好 的 解决 这个 问题 在 这种 情况下 你 需要 使用 required 注解 需要用 如下 的 方式 使 用来 标明 bean 的 设 值 方法 是 spring 中 的 后置 处理 用来 验证 被 required 注解 的 bean 属性 是否 被 正确 的 设置 了 在 使用 来 验证 bean 属性 之前 首先 要在 ioc 容器 中 对 其 进行 注册 但是 如果 没有 属性 被 用 required 注解 过 的话 后置 处理器 会 抛出 一个 异常 请 举例 解释 autowired 注解 autowired 注解 对 自动 装配 何时 何处 被 实现 提供 了 更多 细粒度 的 控制 autowired 注解 可以 像 required 注解 构造 器 一样 被 用于 在 bean 的 设置 方法 上 自动 装配 bean 的 属性 一个 参数 或者 带有 任意 名称 或 带有 多个 参数 的 方法 比如 可以 在 设 值 方法 上 使用 autowired 注解 来 替代 配置文件 中 的 ltpropertygt 元素 当 spring 容器 在 setter 方法 上 找到 autowired 注解 时会 尝 试用 bytype 自动 装配 当然 我们 也 可以 在 构造 方法 上 使用 autowired 注解 带有 autowired 注解 的 构造 方法 意味着 在 创建 一个 bean 时 将 会被 自动 装配 即 便在 配置文件 中 使用 ltpropertygt 元素 下面 是 没有 构造 参数 的 配置 方式 请 举例说明 qualifier 注解 qualifier 注解 意味着 可以 在被 标注 bean 的 字段 上 可以 自动 装配 qualifier 注解 可以 用来 取消 spring 不能取消 的 bean 应用 下面 的 示例 将 会在 customer 的 person 属性 中 自动 装配 person 的 值 下面 我们 要在 配置文件 中 来 配置 person 类 spring 会 知道 要 自动 装配 哪个 personbean 么 不会 的 但是 运行 上面 的 示例 时会 抛出 下面 的 异常 要 解决 上面 的 问题 需要 使用 quanlifier 注解 来 告诉 spring 容器 要 装配 哪个 persona 构造 方法 注入 和 设 值 注入 有 什么区别 请注意 以下 明显 的 区 别在 设 值 注入 方法 支持 大部分 的 依赖 注入 如果 我们 仅 需要 注入 intstring 和 long 型 的 变量 我们 不 要用 设 值 的 方法 注入 对于 基本 类型 如果 我们 没有 注入 的话 可 以为 基本 类型 设置 默认值 在 构造 方法 注入 不支持 大部分 的 依赖 注入 因为 在 调用 构造 方法 中 必须 传入 正确 的 构造 参数 否则 的话 为 报错 设 值 注入 不会 重写 构造 方法 的 值 如果 我们 对 同一个 变量 同时 使 用了 构造 方法 注入 又使 用了 设置 方法 注入 的话 那么 构造 方法 将 不能 覆盖 由 设 值 方法 注入 的 值 很明显 因为 构造 方法 在 对象 被 创建 时调 用在 使用 设 值 注入 时有 可能 还 不能 保证 某种 依赖 是否 已经 被 注入 也就是说 这时 对象 的 依赖 关系 有 可能是 不完整 的 而在 另一种 情况下 构造 器 注入 则不 允许 生成 依赖 关系 不完整 的 对象 在 设 值 注 入时 如果 对象 a 和 对象 b 互相 依赖 在 创建 对象 a 时 spring 会 抛出 异常 因为 在 b 对象 被 创建 之前 a 对 象是 不能 被 创建 的 反之亦然 所以 spring 用 设 值 注入 的 方法 解决 了 循环 依赖 的 问题 因 对象 的 设 值 方法 是 在 对象 被 创建 之前 被 调用 的 spring 框架 中有 哪些 不同 类型 的 事件 spring 的 提供 了 支持 事件 和 代码 中 监听器 的 功能 我们 可以 创建 bean 用来 监听 在 中 发布 的 事件 类 和在 接 口中 处理 的 事件 如果 一个 bean 实现 了 接口 当 一个 被 发布 以后 bean 会 自动 被 通知 提供 了 以 下种 标准 的 事件 上下文 更新 事件 该 事件 会在 被 初始化 或者 更新 时 发布 也 可以 在 调用 接 口中 的 refresh 方法 时 被 触发 上下文 开始 事件 当 容器 调用 的 start 方法 开始 重新开始 容器 时 触发 该 事件 上下文 停止 事件 当 容器 调用 的 stop 方法 停止 容器 时 触发 该 事件 上下文 关闭 事件 当 被 关闭 时 触发 该 事件 容器 被 关闭 时 其 管理 的 所有 单 例 bean 都被 销毁 请求 处理 事件 在 web 应用 中 当 一个 http 请求 request 结束 触发 该 事件 super source 为了 监听 这个 事件 还需要 创建 一个 监听器 handleevent 之后 通过 接口 的 publishevent 方法来 发布 自定义 事件 customevent 和 有 何 区 别在 中 需要 给出 springconfigxml 文件 在你 项 目中 的 相对路径 或者 绝对路径 在 中 spring 会在 classpath 中 自动 搜寻 配置文件 所以 要把 文件 放在 classpath 下 如果 将 springconfigxml 保 存在 了 src 文件 央 下 的话 只需 给出 配置文件 的 名称 即可 因为 src 文件 央 是 默认 简而言之 在 环境变量 中 读取 配置文件 在 配置文件 中 读取 配置文件 spring 框架 中都 用 到了 哪些 设计 模式 spring 框架 中使 用 到了 大量 的 设计 模式 下面 列 举了 比较 有 代表性 的 代理 模式 在 aop 和 remoting 中被 用 的 比 较多 单 例 模式 在 spring 配置文件 中 定义 的 bean 默 认为 单 例 模式 模板 方法 用来 解决 代码 重复 的 问题 比如 前端 控制器 spring 提供 了 来 对 请求 进行 分发 视图 帮助 viewhelper spring 提供 了 一系列 的 jsp 标签 高效 宏 来 辅助 将 分散 的 代码 整 合在 视 图里 依赖 注入 贯穿 于 接口 的 核心理念 工厂 模式 beanfactory 用来 创建 对象 的 实例 开发 中 主要 使用 spring 的 什么 技术 ioc 容器 管理 各层 的 组件 使用 aop 配置 声明 式 事务 整合 其他 框架 简述 aop 和 ioc 概念 面向 方面 切 面的 编程 filter 过滤器 也是 一种 aopaop 是 一种 新 的 方法论 是 对 传统 oop 面向对象 编程 的 补充 aop 的 主要 编程 对 象是 切面 aspect 而 切面 模块化 横切 关注点 可以 举例 通过 事务 说明 控制 反转 也 成为 di 依赖 注入 其 思想 是 反转 资源 获取 的 方向 传统 的 资源 查找 方式 要求 组件 向 容器 发起 请求 查找 资源 作为 回应 容器 适时 的 返回 资源 而应 用了 ioc 之后 则是 容器 主 动地 将 资源 推送 给它 所 管理 的 组件 组件 所要 做的 仅是 选择 一种 合适 的 方式 来 接受 资源 这种 行为 也 被称为 查找 的 被动 形式 在 spring 中 如何 配置 beanbean 的 配置 方式 通过 全 类 名 反射 通过 工厂 方法 静态 工厂 方法 amp 实例 工厂 方法 factorybeanioc 容器 对 bean 的 生命周期 通过 构造 器 或 工厂 方法 创建 bean 实例 为 bean 的 属性 设置 值 和 对 其他 bean 的 引用 将 bean 实例 传 递给 bean 后置 处理器 的 方法 调用 bean 的 初始化 方法 initmethod 将 bean 实例 传 递给 bean 后置 处理器 的 方法 bean 可以 使用 了当 容器 关闭 时 调用 bean 的 销毁 方法 destroymethod 下载 链接 提 取码 springmvc 原理篇 什么 是 是 spring 的 一个 模块 基于 mvc 的 一个 框架 无需 中间 整合 层 来 整合 springmvc 的 优点 它是 基于 组件 技术 的 全部 的 应用 对象 无论 控制器 和 视图 还是 业务 对象 之类 的 都是 java 组件 并且 和 spring 提供 的 其他 基础 结构 紧密 集成 不依 赖于 servletapi 目标 虽是 如此 但是在 实现 的 时候 确 实是 依赖于 servlet 的 可以 任意 使用 各种 视图 技术 而 不仅仅 局限于 jsp 支持 各种 请求 资源 的 映射 策略 它 应是 易于 扩展 的 springmvc 工作 原理 客户端 发送 请求 到 查询 handlermapping 找到 处理 请求 的 调用 业务 逻辑 后 返回 查询 modelandview 找到 指定 视图 视图 将 结果 返 回到 客户端 springmvc 流程 用户 发送 请求 至 前端 控制器 收到 请求 调用 handlermapping 处理器 映射器 处理器 映射器 找到 具体 的 处理器 可以 根据 xml 配置 注解 进行 查找 生成 处理器 对象 及 处理器 拦截器 如果有 则 生成 一并 返回 给 调用 handleradapter 处理器 适配器 handleradapter 经过 适配 调用 具体 的 处理器 controller 也 叫 后端 控制器 controller 执行 完成 返回 将 controller 执行 结果 modelandview 返回 给 将 modelandview 传给 viewreslover 视图 解析器 viewreslover 解析 后 返回 具体 根据 view 进行 渲染 视图 即将 模型 数据 填充 至 视 图中 响应 用户 springmvc 的 控制器 是不是 单 例 模式 如果是 有 什么问题 怎么 解决 是 单 例 模式 所以在 多线程 访问 的 时候 有 线程 安全问题 不 要用 同步 会 影响 性能 的 解决方案 是 在 控制器 里面 不能 写 字段 如果 你 也 用过 struts 简单 介绍 下 springmvc 和 struts 的 区别 有 哪些 springmvc 的 入口 是 一个 servlet 即 前端 控制器 而 struts 入口 是 一个 filter 过滤器 springmvc 是 基于 方法 开发 一个 url 对应 一个 方法 请求 参数 传递 到 方法 的 形 参 可以 设计 为 单 例 或 多例 建议 单 例 struts 是 基于 类 开发 传递 参数 是 通过 类 的 属性 只能 设计 为 多例 struts 采用 值 栈 存储 请 求和 响应 的 数据 通过 ognl 存取 数据 springmvc 通过 参数 解析器 是 将 request 请求 内容 解析 并 给 方法 形 参 赋值 将 数据 和 视图 封 装成 modelandview 对象 最后 又将 modelandview 中 的 模型 数据 通过 reques 域 传 输到 页面 jsp 视图 解析器 默认 使用 jstlspringmvc 中 的 控制器 的 注解 一般 用 那个 有没有 别的 注解 可以 替代 一般 用 conntroller 注解 表示 是 表现 层 不能 用用 别的 注解 代替 requestmapping 注解 用在 类 上面 有 什么 作 用是 一个 用来 处理 请求 地址 映射 的 注解 可 用于 类 或 方法 上 用于 类 上 表示 类 中 的 所有 响应 请求 的 方法 都 是以 该 地址 作为 父 路径 怎么样 把 某个 请求 映 射到 特定 的 方法 上面 答 直 接在 方法 上面 加上 注解 requestmapping 并且在 这个 注解 里面 写上 要 拦截 的 路径 如果在 拦截 请求 中 我 想 拦截 get 方式 提交 的 方法 怎么 配置 可以 在 requestmapping 注解 里面 加上 怎么样 在 方法 里面 得到 request 或者 session 直 接在 方法 的 形 参 中 声明 就 自动 把 request 对象 传入 我 想在 拦截 的 方法 里面 得到 从 前台 传入 的 参数 怎么 得到 答 直 接在 形 参 里面 声明 这个 参数 就可以 但 必须 名字 和 传过来 的 参数 一样 如果 前台 有 很 多个 参数 传入 并且 这些 参数 都是 一个 对象 的 那么 怎么样 快速 得到 这个 对象 直 接在 方法 中 声明 这个 对象 springmvc 就 自动 会把 属性 赋值 到 这个 对象 里面 springmvc 中 函数 的 返回值 是什么 答 返回值 可以 有 很多 类型 有 但 一般 用 string 比较好 springmvc 怎么样 设定 重定向 和 转发 的 在 返回值 前面 加 forward 就可以 让 结果 转发 比如 在 返回值 前面 加 redirect 就可以 让 返回值 重定向 比如 用 什么 对象 从 后台 向 前台 传递 数据 的 答 通过 modelmap 对象 可以 在 这个 对象 里面 用 put 方法 把 对象 加到 里面 前台 就可以 通过 el 表达式 拿到 springmvc 中有 个 类 把 视图 和 数据 都 合并 的 一起 的 叫什么 叫 modelandview 怎么样 把 modelmap 里面 的 数据 放入 session 里面 可以 在 类 上面 加上 注解 里面 包含 的 字符串 就是 要 放入 session 里面 的 ke eyspringmvc 怎么 和 ajax 相互 调用 的 通过 jackson 框架 就可以 把 java 里面 的 对象 直接 转化成 js 可以 识别 的 json 对象 具体步骤 如下 加入 jacksonjar 在 配置文件 中 配置 json 的 映 射在 接受 ajax 方法 里面 可以 直接 返回 objectlist 等 但 方法 前面 要 加上 responsebody 注解 当 一个 方法 向 ajax 返回 特殊 对象 譬如 objectlist 等 需要 做什么 处理 要 加上 responsebody 注解 springmvc 里面 拦截器 是 怎么 写 的 有 两种 写法 一种 是 实现 接口 另外 一种 是 继承 适配器 类 然后 在 springmvclt 配置 springmvc 的 拦截器 配置 个 拦截器 的 bean 就可以 了 默认 是 对 所有 请求 都 拦截 只 针对 部分 请求 拦截 讲 下 springmvc 的 执行 流程 系统启动 的 时候 根据 配置文件 创建 spring 的 容器 首先是 发送 http 请求 到 核心 控制器 容器 通过 映射器 去 寻找 业务 控制器 使用 适配器 找到 相应 的 业务 类 在 进 业务 类 时 进行 数据 封 装在 封装 前 可能会 涉及到 类型 转换 执行 完 业务 类 后 使用 modelandview 进行 视图 转发 数据 放在 model 中用 map 传递 数据 进行 页面 显示 mybatis 框架 篇 什么 是 mybatismybatis 是 一个 可以 自定义 sql 存储 过程 和 高级 映射 的 持久 层 框架 讲 下 mybatis 的 缓存 mybatis 的 缓存 分为 一级 缓存 和 二级缓存 一级 缓存 放在 session 里面 默认 就有 二级缓存 放在 它 的 命名 空 间里 默认 是 不 打开 的 使用 二级缓存 属性 类 需要 实现 serializable 序列化 接口 可 用来 保存 对象 的 状态 可在 它 的 映射 文件 中 配置 是 如何 进行 分页 的 分页 插件 的 原理 是什么 mybatis 使用 rowbounds 对象 进行 分页 也 可以 直接 编写 sql 先 分页 也 可以 使用 mybatis 的 分页 插件 分页 插件 的 原理 实现 mybatis 提供 的 接口 实现 自定义 插件 在 插件 的 拦截 方法 内 拦截 待 执行 的 sql 然后 重写 拦截 sql 后 重写 为 selecttfrom tlimit 简述 mybatis 的 插件 运行 原理 以及 如何 编写 一个 插件 mybatis 仅 可以 编写 针对 这种 接口 的 插件 mybatis 通过 动态 代理 为 需要 拦截 的 接口 生成 代理 对象 以 实现 接口 方法 拦截 功能 每当 执行 这种 接口 对象 的 方法 时 就会 进入 拦截 方法 具体 就是 的 invoke 方法 当然 只会 拦截 那些 你 指定 需要 拦截 的 方法 实现 mybatis 的 interceptor 接口 并 复写 intercept 方法 然后 在给 插件 编写 注解 指 定要 拦截 哪一个 接口 的 哪些 方法 即可 记住 别忘了 在 配置文件 中 配置 你 编写 的 插件 mybatis 动态 sql 是 做什么 的 都有 哪些 动态 sql 能 简述 一下 动态 sql 的 执行 原理 吗 mybatis 动态 sql 可以 让我们 在 xml 映射 文件 内 以 标签 的 形式 编写 动态 sql 完成 逻辑 判断 和 动态 拼接 sql 的 功能 mybatis 提供 了 种 动态 sql 标签 其 执行 原理 为 使用 ognl 从 sql 参数 对象 中 计算 表达式 的 值 根据 表达式 的 值 动态 拼接 sql 以此来 完成 动态 sql 的 功能 和 的 区别 是什么 是 预 编译 处理 是 字符串 替换 mybatis 在 处理 时 会将 sql 中 的 替 换为 号 调用 的 set 方法来 赋值 mybatis 在 处理 时 就是 把 替换成 变量 的 值 使用 可以 有效 的 防止 sql 注入 提高 系统 安全性 为什么 说 mybatis 是 半自动 orm 映射 工具 它与 全自动 的 区别 在 哪里 hibernate 属于 全自动 orm 映射 工具 使用 hibernate 查询 关联 对象 或者 关联 集合 对象 时 可以 根据 对象 关系 模型 直接 获取 所以 它是 全自动 的 而 mybatis 在 查询 关联 对象 或 关联 集合 对象 时 需要 手动 编写 sql 来 完成 所以 称之为 半自动 orm 映射 工具 mybatis 是否 支持 延迟 加载 如果 支持 它 的 实现 原理 是什么 mybatis 仅 支持 association 关联 对象 和 collection 关联 集合 对象 的 延迟 加载 association 指 的 就是 一对一 collection 指 的 就是 一对 多 查询 在 mybatis 配置文件 中 可以 配置 是否 启用 延迟 加载 它 的 原理 是 使用 cglib 创建 目标 对象 的 代理 对象 当 调用 目标 方法 时 进入 拦截器 方法 比如 调用 agetb getname 拦截器 invoke 方法 发现 agetb 是 null 值 那么 就会 单独 发送 事先 保存 好 的 查询 关联 b 对象 的 sql 把 b 查询 上来 然后 调 asetb b 于是 a 的 对象 b 方法 的 属性 性 调用 就有 值了 接着 完成 agetb getname 这 就是 延迟 加载 的 基本原理 mybatis 与 hibernate 有 哪些 不同 mybatis 和 hibernate 不同 它不 完全是 一个 orm 框架 因为 mybatis 需要 程序员 自己 编写 sql 语句 不过 mybatis 可以 通过 xml 或 注解 方式 灵活 配置 要 运行 的 sql 语句 并将 java 对象 和 sql 语句 映射 生成 最终 执行 的 sql 最后 将 sql 执行 的 结果 再 映射 生成 java 对象 mybatis 学习 门槛 低 简单 易学 程序员 直接 编写 原生态 sql 可 严格控制 sql 执行 性能 灵活 度 高 非常 适合 对 关系 数据模型 要求 不高 的 软件开发 例如 互联网 软件 企业 运营 类 软件 等 因为 这类 软件 需求 变化 频繁 一 但 需求 变化 要求 成果 输出 迅速 但是 灵活 的 前提 是 mybatis 无法 做到 数据库 无关 性 如果 需要 实现 支持 多种 数据库 的 软件 则 需要 自定义 多 套 sql 映射 文件 工作 量大 hibernate 对象 关系 映射 能力强 数据库 无关 性 好 对于 关系 模型 要求 高 的 软件 例如 需求 固定 的 定制 化 软件 如果 用 hibernate 开发 可以 节省 很多 代码 提高 效率 但是 hibernate 的 缺点 是 学习 门槛 高要 精通 门槛 更高 而且 怎么 设计 or 映 射在 性能 和 对象 模型 之间 如何 权衡 以及 怎样 用好 hibernate 需要 具有 很强 的 经验 和 能力 才 行 总之 按照 用户 的 需求 在 有限 的 资源 环境 下 只要 能 做出 维护 性 扩展性 良好 的 软件 架构 都是 好 架构 所以 框架 只有 适合 才是 最好 mybatis 的 好处 是什么 mybatis 把 sql 语句 从 java 源程序 中 独立 出来 放在 单独 的 xml 文件 中 编 写给 程序 的 维护 带 来了 很大 便利 mybatis 封 装了 底层 jdbcapi 的 调用 细节 并能 自动 将 结果 集 转换成 javabean 对象 大大 简 化了 java 数据库 编程 的 重复 工作 因为 mybatis 需要 程序员 自己 去 编写 sql 语句 程序员 可以 结合 数据库 自身 的 特点 灵活 控制 sql 语句 因此 能够 实现 比 hibernate 等 全自动 orm 框架 更高 的 查询 效率 能够 完成 复杂 查询 简述 mybatis 的 xml 映射 文件 和 mybatis 内部 数据结构 之间 的 映射 关系 mybatis 将 所有 xml 配置 信息 都 封 装到 allinone 重量级 对象 configuration 内部 在 xml 映射 文件 中 ltprametermapgt 标签 会被 解析 为 parametermap 对象 其 每 个子 元素 会被 解析 为 对象 ltresultmapgt 标签 会被 解析 为 resultmap 对象 其 每 个子 元素 会被 解析 为 resultmapping 对象 每一个 标签 均 会被 解析 为 mappedstatement 对象 标签 内 的 sql 会被 解析 为 boundsql 对象 什么 是 mybatis 的 接口 绑定 有 什么 好处 接口 映射 就是在 mybatis 中 任意 定义 接口 然后 把 接口 里面 的 方法 和 sql 语句 绑定 我们 直接 调用 接口 方法 就可以 这样 比起 原 来了 sqlsession 提供 的 方法 我们 可以 有 更加 灵活 的 选择 和 设置 接口 绑定 有 几种 实现 方式 分 别是 怎么 实现 的 接口 绑定 有 两种 实现 方式 一种 是 通过 注解 绑定 就是在 接口 的 方法 上面 加上 selectupdate 等 注解 里面 包含 sql 语句 来 绑定 另外 一种 就是 通过 xml 里面 写 sql 来 绑定 在 这种 情况下 要 指定 xml 映射 文件 里面 的 namespace 必须 为 接口 的 全 路径名 什么 情况下 用 注解 绑定 什么 情况下 用 xml 绑 定当 sql 语句 比较简单 时候 用 注解 绑 定当 sql 语句 比较复杂 时候 用 xml 绑定 一般 用 xml 绑定 的 比 较多 mybatis 实现 一对 一有 几种 方式 具体 怎么 操作 的 有 联合 查询 和 嵌套 查询 联合 查询 是 几个 表 联合 查询 只 查询 一次 通过 在 resultmap 里面 配置 association 节点 配置 一对一 的 类 就可以 完成 嵌套 查询 是 先查 一个 表 根据 这个 表里 面的 结果 的 外 键 id 去 再 另外 一个 表 里面 查询 数据 也是 通过 association 配置 但 另外 一个 表 的 查询 通过 select 属性 配置 mybatis 能 执行 一对一 一对 多 的 关联 查询 吗 都有 哪些 实现 方式 以及 它们 之间 的 区别 能 mybatis 不仅 可以 执行 一对一 一对 多 的 关联 查询 还 可以 执行 多 对 一多 对 多 的 关联 查询 多 对 一 查询 其实 就是 一对一 查询 只需 要把 selectone 修 改为 selectlist 即 可多 对 多 查询 其实 就是 一对 多 查询 只需 要把 selectone 修 改为 selectlist 即可 关联 对象 查询 有 两种 实现 方式 一种 是 单独 发送 一个 sql 去 查询 关联 对象 赋 给 主 对象 然后 返回 主 对象 另一种 是 使用 嵌套 查询 嵌套 查询 的 含义 为 使用 join 查询 一部 分列 是 a 对象 的 属性 值 另外 一部 分列 是 关联 对象 b 的 属性 值 好处 是 只 发 一个 sql 查询 就可以 把 主 对象 和 其 关联 对象 查出来 mybatis 里面 的 动态 sql 是 怎么 设定 的 用 什么 语法 mybatis 里面 的 动 动态 sql 一般 是 通过 if 节 点来 实现 通过 ognl 语法 来 实现 但是 如果 要写 的 完整 必须 配合 wheretrim 节点 where 节点 是 判断 包含 节点 有 内容 就 插入 where 否 则不 插入 trim 节点 是 用来 判断 如果 动态 语句 是以 and 或 or 开始 那么 会 自动 把 这个 and 或者 or 取掉 mybatis 是 如何将 sql 执行 结果 封 装为 目标 对象 并 返回 的 都有 哪些 映射 形式 第一种 是 使用 ltresultmapgt 标签 逐一 定义 列名 和 对象 属性 名 之间 的 映射 关系 第二种 是 使用 sql 列 的 别名 功 能将 列 别名 书写 为 对象 属性 名 比如 tnameasname 对象 属性 名 一般 是 name 小写 但是 列名 不 区分 大小写 mybatis 会 忽略 列名 大小写 只能 找到 与 之 对应 对象 属性 名 你 甚至 可以 写成 一样 可以 正常 工作 有 了 列名 与 属性 名 的 映射 关系 后 mybatis 通过 反射 创建 对象 同时 使用 反 射给 对象 的 属性 逐一 赋值 并 返回 那些 找不到 映射 关系 的 属性 是 无法 完成 赋值 的 xml 映射 文件 中 除了 常见 的 标签 之外 还有 哪些 标签 还有 很多 其他 的 标签 加上 动态 sql 的 个 标签 等 其中 ltsqlgt 为 sql 片段 标签 通过 ltincludegt 标签 引入 sql 片段 ltselectkeygt 为 不支持 自 增 的 主键 生成 策略 标签 当 实体类 中 的 属性 名 和 表 中 的 字段名 不一样 如果 将 查询 的 结果 封 装到 指定 pojo 通过 在 查询 的 sql 语 句中 定义 字段名 的 别名 通过 ltresultmapgt 来 映射 字段名 和 实体类 属性 名 的 一一对应 的 关系 模糊 查询 like 语句 该 怎么 写在 java 中 拼接 通配符 通过 赋值 在 sql 语 句中 拼接 通配符 不安全 会引起 sql 注入 通常 一个 xml 映射 文件 都 会写 一个 dao 接口 与 之 对应 dao 的 工作 原理 是否 可以 重载 不能 重载 因为 通过 dao 寻找 xml 对应 的 sql 的 时候 权限 名 方 法名 的 保存 和 寻找 策略 接口 工作 原理 为 jdk 动态 代理 原理 运行时 会为 dao 生成 proxy 代理 对象 会 拦截 接口 方法 去 执行 对应 的 sql 返回 数据 mybatis 映射 文件 中 如果 a 标签 通过 include 引 用了 b 标签 的 内容 请问 b 标签 能否 定义 在 a 标签 的 后面 还是 说 必须 定义 在 a 标签 的 前面 虽然 mybatis 解析 xml 映射 文件 是 按照 顺序 解析 的 但是 被 引用 的 b 标签 依然 可以 定义 在 任何地方 mybatis 都可以 正确 识别 原理 是 mybatis 解析 a 标签 发现 a 标签 引 用了 b 标签 但是 b 标签 尚未 解析 到 尚不 存在 此时 mybatis 会将 a 标签 标 记为 未 解析 状态 然后 继续 解析 余下 的 标签 包含 b 标签 待 所有 标签 解析 完毕 mybatis 会 重新 解析 那些 被 标 记为 未 解析 的 标签 此时 再 解析 a 标签 时 b 标签 已经 存在 a 标签 也就 可以 正常 解析 完 成了 mybatis 的 xml 映射 文件 中 不同 的 xml 映射 文件 id 是否 可以 重复 不同 的 xml 映射 文件 如果 配置 了 namespace 那么 id 可以 重复 如果 没有 配置 namespace 那么 id 不能 重复 毕竟 namespace 不是 必须 的 只是 最佳 实践 而已 原因 就是 namespaceid 是 作为 的 key 使用 的 如果 没有 namespace 就 剩下 id 那么 id 重 复会 导致 数据 互相 覆盖 有 了 namespace 自然 id 就可以 重复 namespace 不同 namespaceid 自然 也就 不同 mybatis 中 如何 执行 批处理 使用 batchexecutor 完成 批处理 mybatis 都有 哪些 executor 执行器 它们 之间 的 区别 是什么 mybatis 有 三种 基本 的 excutor 执行器 每 执行 一次 updata 或者 select 就 开启 一个 statement 对象 用完 立刻 关闭 statement 对象 reuseexecutor 执行 update 或 select 以 sql 作为 key 查找 statement 对象 存在 就使 用不 存在 就 创建 用完 后 不 关闭 statement 对象 而是 放 置于 完成 批处理 mybatis 中 如何 指定 使用 哪一种 executor 执行器 在 mybatis 配置文件 中 可以 指定 默认 的 executortype 执行器 类型 也 可以 手动 给 的 创建 sqlsession 的 方法 传递 executortype 类型 参数 mybatis 执行 批量 插入 能 返回 数据库 主键 列表 吗 能 jdbc 都能 mybatis 当然 也 能 mybatis 是否 可以 映射 enum 枚举 类 mybatis 可以 映射 枚举 类 不单 可以 映射 枚举 类 mybatis 可以 映射 任何 对象 到 表 的 一 列上 映射 方式 为 自定义 一个 typehandler 实现 typehandler 的 setparameter 和 getresult 接口 方法 typehandler 有 两个 作用 一是 完成 从 javatype 至 jdbctype 的 转换 二是 完成 jdbctype 至 javatype 的 转换 体 现为 setparameter 和 getresult 两个 方法 分别 代表 设置 sql 问号 占位 符 参数 和 获取 列 查询 结果 如何 获取 自动 生成 的 主 键值 配置文件 设置 为 true 在 mapper 中 如何 传递 多个 参数 直 接在 方法 中 传递 参数 xml 文件 用来 获取 使用 param 注解 这样 可以 直 接在 xml 文件 中 通过 name 来 获取 的 区别 类 的 名字 和 数据库 相 同时 可以 直接 设置 resulttype 参数 为 pojo 类 若 不同 需要 设置 resultmap 将 结果 名字 和 pojo 名字 进行 转换 使用 mybatis 的 mapper 接口 调用 时有 哪些 要求 类型 相同 mapper 接口 方 法名 和 mapperxml 中 定义 的 每个 sql 的 id 相同 mapper 接口 方法 的 输入 参数 类型 和 mapperxml 中 定义 的 每个 sql 的 parametertype 的 类型 相同 mapper 接口 方法 的 输出 参数 类型 和 mapperxml 中 定义 的 每个 sql 的 resulttype 的 类型 相同 mapperxml 文件 中 的 namespace 即是 mapper 接口 的 类 路径 mybatis 比 ibatis 比 较大 的 几个 改进 是什么 有 接口 绑定 包括 注解 绑定 sql 和 xml 绑定 sql 动态 sql 由 原来 的 节点 配置 变成 ognl 表达式 在 一对一 一对 多 的 时候 引 进了 association 在 一对 多 的 时候 引 入了 collection 节点 不过 都是 在 resultmap 里面 配置 ibatis 和 mybatis 在 核心 处理 类 分别 叫什么 ibatis 里面 的 核心 处理 类 叫 里面 的 核心 处理 类 叫做 和 mybatis 在 细节 上 的 不同 有 哪些 在 sql 里面 变量 命名 有 原来 的 变量 变 成了 变量 原来 的 变量 变 成了 变量 原来 在 sql 节点 里面 的 class 都 换 名字叫 type 原来 的 变 成了 原来 的 别名 设置 在 映射 文件 里面 放在 了 核心 配置文件 里 netty 篇 bionio 和 aio 的 区别 bio 一个 连接 一个 线程 客户端 有 连接 请求 时 服务器端 就需要 启动 一个 线程 进行 处理 线程 开销 大 伪 异步 io 将 请求 连接 放入 线程 池 一对 多 但 线程 还是 很 宝贵 的 资源 nio 一个 请求 一个 线程 但 客户端 发送 的 连接 请求 都会 注册 到 多路 复用器 上 多路 复用器 轮询 到 连接 有 io 请求 时 才 启动 一个 线程 进行 处理 aio 一个 有效 请求 一个 线程 客户端 的 io 请求 都是 由 os 先 完 成了 再 通知 服务器 应 用去 启动 线程 进行 处理 bio 是 面向 流 的 nio 是 面向 缓冲区 的 bio 的 各种 流 是 阻塞 的 而 nio 是非 阻塞 的 bio 的 stream 是 单向 的 而 nio 的 channel 是 双向 的 nio 的 特点 事件 驱动 模型 单线程 处理 多任务 非 阻塞 ioio 读写 不再 阻塞 而是 返回 基于 block 的 传输 比 基于 流 的 传输 更 高效 更 高级 的 io 函数 zerocopyio 多路复用 大大 提高了 java 网络 应用 的 可 伸缩性 和 实用性 基于 reactor 线程 模型 在 reactor 模式 中 事件 分发 器 等待 某个 事件 或者 可应用 或 个 操作 的 状态 发生 事件 分发 器 就把 这个 事件 传给 事先 注册 的 事件 处理 函数 或 者回 调 函数 由 后者 来 做 实际 的 读写 操作 如在 reactor 中 实现 读 注册 读 就绪 事件 和 相应 的 事件 处理器 事件 分发 器 等待 事件 事件 到来 激活 分发 器 分发 器 调用 事件 对应 的 处理器 事件 处理器 完成 实际 的 读 操作 处理 读到 的 数据 注册 新 的 事件 然后 返还 控制权 nio 的 组成 buffer 与 channel 进行 交互 数据 是 从 channel 读入 缓冲区 从 缓冲区 写入 channel 中 的 flip 方法 反转 此 缓冲区 将 position 给 limit 然后 将 position 置 为 其实 就是 切换 读写 模式 clear 方法 清 除此 缓冲区 将 position 置 为 把 capacity 的 值 给 limitrewind 方法 重 绕 此 缓冲区 将 position 置 为 可 减少 一次 系统 空间 到 用户 空间 的 拷贝 但 buffer 创 建和 销毁 的 成本 更高 不 可控 通常 会用 内存 池 来 提高 性能 直接 缓冲区 主要 分配给 那些 易 受 基础 系统 的 本机 io 操作 影响 的 大型 持久 的 缓冲区 如果 数据量 比 较小 的 中小 应用 情况下 可以 考虑 使用 heapbuffer 由 jvm 进行 管理 channel 表示 io 源 与 目标 打开 的 连接 是 双向 的 但 不能 直接 访问 数据 只 能与 buffer 进行 交互 通过 源码 可知 filechannel 的 read 方法 和 write 方法 都 导致 数据 复制 了 两次 selector 可使 一个 单独 的 线程 管理 多个 channelopen 方法 可 创建 方法 向 多路 复用器 器 注册 通道 可以 监听 的 事件 类型 读写 连接 accept 注册 事件 后会 产生 一个 selectionkey 它 表示 和 selector 之间 的 注册 关系 wakeup 方法 使 尚未 返回 的 第一个 选择 操作 立即 返回 唤醒 的 原因是 注册 了 新 的 channel 或者 事件 channel 关闭 取消 注册 优先级 更高 的 事件 触发 如 定时器 事件 希望 及时处理 理 selector 在 linux 的 实现 类 是 委托 给 实现 其中 三个 native 方法 是 对 epoll 的 封装 而 方法 通过 调用 epollctl 向 epoll 实例 中 注册 事件 还将 注册 的 文件 描述符 fd 与 selectionkey 的 对应 关系 添加到 fdtokey 中 这个 map 维护 了 文件 描述符 与 selectionkey 的 映射 fdtokey 有时会 变得 非常大 因为 注册 到 selector 上 的 channel 非常 多 百万 连接 过期 或 失效 的 channel 没有 及时 关闭 fdtokey 总是 串行 读取 的 而 读取 是 在 select 方法 中 进行 的 该 方法 是非 线程 安全 的 pipe 两个 线程 之间 的 单向 数据 连接 数据 会被 写到 sink 通道 从 source 通道 读取 nio 的 服务端 建立 过程 selectoropen 打开 一个 创建 服务端 的 channelbind 绑定 到 某个 端 口上 并 配置 非 阻塞 模式 register 注册 channel 和 关注 的 事件 到 selector 上 select 轮询 拿到 已经 就绪 的 事件 netty 的 特点 一个 高性能 异步 事件 驱动 的 nio 框架 它 提供 了 对 tcpudp 和 文件 传输 的 支持 使用 更 高效 的 socket 底层 对 epoll 空 轮询 引起 的 cpu 占用 飙升 在内部 进行了 处理 避免了 直接 使用 nio 的 陷阱 简 化了 nio 的 处理方式 采用 多种 decoderencoder 支持 对 tcp 粘 包 分包 进行 自动化 处理 可 使用 接受 处理 线程 池 提高 连接 效率 对重 连 心跳 检测 的 简单 支持 可 配置 io 线程 数 tcp 参数 tcp 接收 和 发送 缓冲区 使用 直接 内存 代替 堆 内存 通过 内存 池 的 方式 循环 利用 bytebuf 通过 引用 计数器 及时 申请 释放 不再 引用 的 对象 降 低了 gc 频率 使用 单线程 串行化 的 方式 高效 的 reactor 线程 模型 大量 使 用了 volitale 使 用了 cas 和 原 子类 线程 安全类 的 使用 读写 锁 的 使用 netty 的 线程 模型 netty 通过 reactor 模型 基于 多路 复用器 接收 并 处理 用户 请求 内部 实现 了 两个 线程 池 boss 线程 池 和 work 线程 池 其中 boss 线程 池 的 线程 负责处理 请求 的 accept 事件 当 接 收到 accept 事件 的 请求 时 把 对应 的 socket 封 装到 一个 中 并 交给 work 线程 池 其中 work 线程 池 负责 请求 的 read 和 write 事件 由 对应 的 handler 处理 单线程 模型 所有 io 操作 都由 一个 线程 完成 即 多路复用 事件 分发 和 处理 都是 在 一个 reactor 线程 上 完成 的 既要 接收 客户端 的 连接 请求 向 服务端 发起 连接 又要 发送 读取 请求 或 应答 响应 消息 一个 nio 线程 同时 处理 成百上千 的 链 路 性 能上 无法 支撑 速度慢 若 线程 进入 死循环 整个 程序 不可用 对于 高 负载 大 并发 的 应用 场景 不合适 多线程 模型 有 一个 nio 线程 acceptor 只 负责 监听 服务端 接收 客户端 的 tcp 连接 请求 nio 线程 池 负责 网络 io 的 操作 即 消息 的 读取 解码 编码 和 发 送个 nio 线程 可以 同时 处理 n 条 链 路 但是 个 链 路 只 对应 个 nio 线程 这是 为了 防止 发生 并发 操作 问题 但在 并发 百万 客户端 连接 或 需要 安全 认证 时 一个 acceptor 线程 可能会 存在 性能 不足 问题 主从 多线程 模型 acceptor 线程 用于 绑定 监听 端口 接收 客户端 连接 将 socketchannel 从 主 线程 池 的 reactor 线程 的 多路 复用器 上 移除 重新 注册 到 sub 线程 池 的 线程 上 用于 处理 io 的 读写 等 操作 从而 保证 mainreactor 只 负责 接入 认证 握手 等 操作 tcp 粘 包 拆 包 的 原因 及 解决方法 tcp 是以 流 的 方式 来 处理 数据 一个 完整 的 包 可能 会被 tcp 拆 分成 多个 包 进行 发送 也 可 能把 小 的 封 装成 一个 大 的 数据包 发送 tcp 粘 包 分包 的 原因 应用程序 写入 的 字节 大小 大于 套接 字 发送 缓冲区 的 大小 会 发生 拆 包 现象 而 应用程序 写入 数据 小于 套接 字 缓冲区 大小 网卡 将 应用 多次 写入 的 数据 发送到 网络 上 这将 会 发生 粘 包 现象 进行 mss 大小 的 tcp 分段 当 tcp 报文 长度 tcp 头部 长度 gtmss 的 时候 将 发生 拆 包 以太网 帧 的 payload 净 荷 大于 mtu 字节 进行 ip 分片 解决方法 消息 定长 类 包 尾 增加 特殊 字符 分割 行 分隔符 类 或 自定义 分隔符 类 将 消息 分为 消息 头 和 消息 体 类 分为 有 头部 的 拆 包 与 粘 包 长度 字段 在前 且有 头部 的 拆 包 与 粘 包 多 扩展 头部 的 拆 包 与 粘 包 了解 哪几种 序列化 协议 序列化 编码 是 将 对象 序列 化为 二进制 形式 字节 数组 主要 用于 网络 传输 数据 持久 化 等 而 反 序列化 解码 则是 将从 网络 磁盘 等 读取 的 字节 数组 还原成 原始 对象 主要 用于 网络 传输 对象 的 解码 以便 完成 远程 调用 影响 序列化 性能 的 关键因素 序列化 后 的 码 流 大小 网络带宽 的 占用 序列化 的 性能 cpu 资源 占用 是否 支持 跨 语言 异构 系统 的 对接 和 开发 语言 切换 java 默认 提供 的 序列化 无法 跨 语言 序列化 后 的 码 流 太大 序列化 的 性能 差 xml 优点 人机 可读性 好 可 指定 元素 或 特性 的 名称 缺点 序列化 数据 只 包含 数据 本身 以及 类 的 结构 不包括 类型 标识 和 程序 集 信息 只能 序列化 公共 属性 和 字段 不能 序列化 方法 文件 庞大 文件 格式 复杂 传输 占 带宽 适用 场景 当做 配置文件 存储 数据 实时 数据 转换 json 是 一种 轻量级 的 数据交换 格式 优点 兼容性 高 数据格式 比较简单 易于 读写 序列化 后 数据 较 小可 扩展性 好 兼容性 好 与 xml 相比 其 协议 比较简单 解析 速度 比 较快 缺点 数据 的 描述性 比 xml 差 不适合 性能 要求 为 ms 级别 的 情况 额外 空间 开销 比 较大 适用 场景 可 替代 跨 防火墙 访问 可 调式 性要求 高 基于 webbrowser 的 ajax 请求 传输 数据量 相对 小 实时 性要求 相对 低 例如 秒 级别 的 服务 fastjson 采用 一种 假定 有序 快速 匹配 的 算法 优点 接口 简单 易用 目前 java 语言 中 最快 的 json 库 缺点 过于 注重 快 而 偏 离了 标准 及 功能性 代码 质量 不高 文档 不全 适用 场景 协议 交互 web 输出 android 客户端 thrift 不仅是 序列化 协议 还是 一个 rpc 框架 优点 序列化 后 的 体积小 速度快 支持 多种语言 和 丰富 的 数据类型 对于 数据 字段 的 增删 具有 较强 的 兼容性 支持 二进制 压缩 编码 缺点 使用者 较少 跨 防火墙 访问 时 不安全 不具有 可读性 调试 代码 时 相对 困难 不能 与其 他 传输 层 协议 共同 使用 例如 http 无法 支持 向 持久 层 直接 读写 数据 即 不适 合做 数据 持久 化 序列化 协议 适用 场景 分布式 系统 的 rpc 解决方案 avrohadoop 的 一个 子项目 解决 了 json 的 冗长 和 没有 idl 的 问题 优点 支持 丰富 的 数据类型 简单 的 动态 语言 结合 功能 具有 自我 描述 属性 提高了 数据 解析 速度 快速 可压缩 的 二进制 数据 形式 可以 实现 远程过程调用 rpc 支持 跨 编程 语言 实现 缺点 对于 习惯于 静态 类型 语言 的 用户 不 直观 适用 场景 在 hadoop 中 做 hivepig 和 mapreduce 的 持久 化 数据格式 protobuf 将 数据结构 以 proto 文件 进行 描述 通过 代码 生成 工具 可以 生成 对应 数据结构 的 pojo 对象 和 protobuf 相关 的 方法 和 属性 优点 序列化 后 码 流 小 性能 高 结构化 数据 存储 格式 xmljson 等 通过 标识 字段 的 顺序 可以 实现 协议 的 前 向 兼容 结构化 的 文档 更 容易 管理 和 维护 缺点 需要 依赖于 工具 生成 代码 支持 的 语言 相对 较少 官方 只 支持 javacpython 适用 场景 对 性能 要求 高 的 rpc 调用 具有 良好 的 跨 防火墙 的 访问 属性 适合 应用层 对象 的 持久 化 protostuff 基于 protobuf 协议 但不 需要 配置 proto 文件 直接 导 包 即可 jbossmarshaling 可以 直接 序列化 java 类 无须 实 接口 messagepack 一个 高效 的 二进制 序列化 格式 hessian 采用 二进制 协议 的 轻量级 remotingonhttp 工具 kryo 基于 protobuf 协议 只 支持 java 语言 需要 注册 registration 然后 序列化 output 反 序列化 input 如何 选择 序列化 协议 具体 场景 对于 公司 间 的 系统 调用 如果 性能 要求 在 ms 以上 的 服务 基于 xml 的 soap 协议 是 一个 值得 考虑 的 方案 基于 webbrowser 的 ajax 以及 mobileapp 与 服务端 之间 的 通讯 json 协议 是 首选 对于 性能 要求 不 太高 或者 以 动态 类型 语言 为主 或者 传输 数据 载荷 很小 的 的 运用 场景 json 也是 非常 不错 的 选择 对于 调试 环境 比较 恶劣 的 场景 采用 json 或 xml 能够 极大 的 提高 调试 效率 降低 系统开发 成 本当 对 性能 和 简洁性 有极 高要求 的 场景 之间 具有 一定 的 竞争 关系 对于 t 级别 的 数据 的 持久 化 应用 场景 protobuf 和 avro 是 首要 选择 如果 持久 化 后 的 数据 存储 在 hadoop 子项目 里 avro 会是 更好 的 选择 对于 持久 层 非 hadoop 项目 以 静态 类型 语言 为主 的 应用 场景 protobuf 会 更 符合 静态 类型 语言 工程师 的 开发 习惯 由于 avro 的 设计 理念 偏向 于 动态 类型 语言 对于 动态 语言 为主 的 应用 场景 avro 是 更好 的 选择 如果 需要 提供 一个 完整 的 rpc 解决方案 thrift 是 一个 好 的 选择 如果 序列化 之后 需要 支持 不同 的 传输 层 协议 或者 需要 跨 防火墙 访问 的 高性能 场景 protobuf 可以 优先 考虑 protobuf 的 数据类型 有 多种 的 限定符 required 必须 赋值 不 能为 空 optional 字段 可以 赋值 也 可以 不 赋值 repeated 该 字段 可以 重复 任意 次数 包括 次 枚举 只 能用 指定 的 常量 集中 的 一个 值 作为 其 值 protobuf 的 基本 规则 每个 消息 中 必须 至少 留有 一个 required 类型 的 字段 包含 个 或 多个 optional 类型 的 字段 repeated 表示 的 字段 可以 包含 个 或 多个 数据 之内 的 标识号 在 编码 的 时候 会 占用 一个 字节 常用 之内 的 标识号 则 占用 个 字节 标识号 一定 不能 重复使用 消息 类型 也 可以 将 消息 嵌套 任意 多层 可用 嵌套 消息 类型 来 代替 组 protobuf 的 消息 升级 原则 不要 更改 任何 已有 的 字段 的 数值 标识 不能 移除 已经 存在 的 required 字段 optional 和 repeated 类型 的 字段 可以 被 移除 但要 保留 标号 不能 被 重用 新 添加 的 字段 必须 是 optional 或 repeated 因为 旧版本 程序 无法 读取 或 写入 新增 的 required d 限定符 的 字段 编译器 为 每一个 消息 类型 生 成了 一个 java 文件 以及 一个 特殊 的 builder 类 该类 是 用来 创建 消息 类 接口 的如 builderbuild netty 中 的 使用 是 用于 处理 半包 消息 的 解码 类 protobufdecoder 这是 创建 的 userprotojava 文件 中 的 解码 类 对 protobuf 协议 的 消息 头上 加上 一个 长度 为 的 整形 字段 用于 标志 这个 消息 的 长度 的 类 protobufencoder 是 编码 类 将 stringbuilder 转 换为 bytebuf 类型 copiedbuffer 方法 netty 的 零 拷贝 实现 netty 的 接收 和 发送 bytebuffer 采用 directbuffers 使用 堆 外 直接 内存 进行 socket 读写 不需要 进行 字节 缓冲区 的 二次 拷贝 堆 内存 多了 一次 内存 拷贝 jvm 会将 堆 内存 buffer 拷贝 一份 到 直接 内存 中 然后 才 写入 socket 中 bytebuffer 由 channelconfig 分配 由 channelconfig 创建 默认 使用 类 可以 将 多个 bytebuf 合 并为 一个 逻辑 上 的 bytebuf 避免了 传统 通过 内存 拷贝 的 方式 将 几个 小 buffer 合 并成 一个 大 的 方法 将 header 与 body 合 并为 一个 逻辑 上 的 bytebuf 这两个 bytebuf 在 内部 都是 单独 存在 的 只是 逻辑 上 是 一个 整体 通过 fileregion 包装 的 方法 实现 文件 传输 可以 直接 将 文件 缓冲区 的 数据 发送到 目标 channel 避免了 传统 通过 循环 write 方式 导致 的 内存 拷贝 问题 通过 wrap 方法 我们 可以 将 byte 数组 等 包 装成 一个 nettybytebuf 对象 进而 避免了 拷贝 操作 selectorbug 若 selector 的 轮询 结果 为 空 也没有 wakeup 或 新消息 处 理则 发生 空 轮询 cpu 使用率 netty 的 解决办法 对 selector 的 select 操作 周期 进行 统计 每 完成 一次 空 的 select 操作 进行 一次 计数 若在 某个 周 期内 连续 发生 n 次 空 轮询 则 触 发了 epoll 死循环 bug 重建 selector 判断 是否 是 其他 线程 发起 的 重建 请求 若不是 则将 原 socketchannel 从 旧 的 selector 上 去除 注册 重新 注册 到 新 的 selector 上 并将 原来 的 selector 关闭 netty 的 高性能 表现 在 哪些方面 心跳 对 服务端 会 定时 清除 闲置 会话 inactive netty 对 客户端 用来 检测 会话 是否 断开 是否 重来 检测 网络 延迟 其中 类 用来 检测 会话 状态 串行 无 锁 化 设计 即 消息 的 处理 尽可 能在 同一个 线程 内 完成 期间 不 进行 线程 切换 这样 就 避免了 多线程 竞争 和 同步 锁 表面上 看 串行化 设计 似乎 cpu 利用率 不高 并发 程度 不够 但是 通过 调整 nio 线程 池 的 线程 参数 可以 同时 启动 多个 串行化 的 线程 并行 运行 这种 局部 无 锁 化 的 串行 线程 设计 相比 一个 队列 多个 工作 线程 模型 性能 更优 可靠性 链 路 有效性 检测 链 路 空闲 检测 机制 读写 空闲 超时 机制 内存保护 机制 通过 内存 池 重用 bytebufbytebuf 的 解码 保护 优雅 停机 不再 接收 新消息 退出 前 的 预处理 操作 资源 的 释放 操作 netty 安全性 支持 的 安全 协议 sslv 和 vtlsssl 单向 认证 双向 认证 和 第三方 ca 认证 高效 并发 编程 的 体现 volatile 的 大量 正确 使用 cas 和 原 子类 的 广泛 使用 线程 安全 容器 的 使用 通过 读写 锁 提升 并发 性能 io 通信 性能 三原则 传输 aio 协议 http 线程 主从 多线程 流量 整型 的 作用 变压器 防止 由于 上下游 网 元 性能 不 均衡 导致 下游 网 元 被 压垮 业务 流 中断 防止 由于 通信 模块 接受 消息 过快 后端 业务 线程 处理 不 及时 导致 撑死 问题 tcp 参数 配置 sorcvbuf 和 sosndbuf 通常 建议 值 为 k 或者 算法 通过 将 缓冲 区内 的 小 封包 自动 相连 组成 较大 的 封包 阻止 大量 小 封包 的 发送 阻塞 网络 从而 提高 网络 应用 效率 但是 对于 时 延 敏感 的 应用 场景 需要 关闭 该 优化 算法 源码 其实是 内部 维护 一个 类型 为 默认 大小 是 处理器 核 数 这样 就 构 成了 一个 线程 池 初始化 eventexecutor 时 重载 newchild 方法 所以 children 元素 的 实际 类型 为 nioeventloop 线程 启动时 调用 的 构造 方法 执行 nioeventloop 类 的 run 方法 首先 会 调用 hastasks 方法 判断 当前 taskqueue 是否 有 元素 如果 taskqueue 中有 元素 执行 selectnow 方法 最终 执行 该 方 法会 立即 返回 如果 taskqueue 没有 元素 执行 select oldwakenup 方法 select oldwakenup 方法 解决 了 nio 中 的 bugselectcnt 用来 记录 selectorselect 方法 的 执行 次数 和 标识 是否 执行 若 触 发了 epoll 的 空 轮询 bug 则会 反复 执行 selectorselect timeoutmillis 变量 selectcnt 会 逐渐 变 大当 selectcnt 达到 阈值 默认 则 执行 rebuildselector 方法 进行 selector 重建 解决 cpu 占用 的 方法 先 通过 openselector 方法 创建 一个 新 的 selector 然后 将 oldselector 的 selectionkey 执行 cancel 最后 将 oldselector 的 channel 重新 注册 到 新 的 selector 中 rebuild 后 需要 重新 执行 方法 selectnow 检查 是否 有 已 ready 的 selectionkey 接下来 调用 方法 处理 io 任 务当 时 调用 方法 迭代 selectedkeys 获取 就绪 的 io 事件 的 selectkey 存放在 数组 selectedkeys 中 然 后为 每个 事件 都 调用 来 处理 它 中分 别 处理 事件 最后 调用 runalltasks 方法 非 io 任务 该 方法 首先 会 调用 方法 把 中 已经 超过 延迟 执行时间 的 任务 移到 taskqueue 中 等待 被执行 然后 依次 从 taskqueue 中 取 任务 执行 每 执行 个 任务 进行 耗时 检查 如果 已 执行时间 超过 预先 设定 的 执行时间 则 停止 执行 非 io 任务 避免 非 io 任务 太多 影响 io 任务 的 执行 每个 nioeventloop 对应 一个 线程 和 一个 会 主动 注册 到 某一个 nioeventloop 的 selector 上 nioeventloop 负责 事件 轮询 outbound 事件 都是 请求 事件 发起者 是 channel 处理 者 是 unsafe 通过 outbound 事件 进行 通知 传播 方向 是 tail 到 headinbound 事件 发起者 是 unsafe 事件 的 处理 者 是 channel 是 通知 事件 传播 方向 是 从头到尾 内存 管理机制 首 先会 预 申请 一大块 内存 arenaarena 由 许多 chunk 组成 而 每个 chunk 默认 由 个 page 组成 chunk 通过 avl 树 的 形式 组织 page 每个 叶子 节点 表示 一个 page 而 中间 节点 表示 内存 区域 节点 自己 记录 它在 整个 arena 中 的 偏移 地址 当 区域 被 分配 出去 后 中间 节点 上 的 标记 位 会被 标记 这样 就 表示 这个 中间 节点 以下 的 所有 节点 都 已被 分 配了 大于 k 的 内存 分 配在 poolchunklist 中 而 poolsubpage 用于 分配 小于 k 的 内存 它 会把 一个 page 分 割成 多 段 进行 内存 分配 bytebuf 的 特点 支持 自动 扩容 m 保证 put 方法 不会 抛出 异常 通过 内置 的 复合 缓冲 类型 实现 零 拷贝 zerocopy 不需要 调用 flip 来 切换 读写 模式 读取 和 写入 索引 分开 方法 链 引用 计数 基于 用于 内存 回收 pooledbytebuf 采用 二叉树 来 实现 一个 内存 池 集中 管理 内存 的 分配 和 释放 不用 每次 使用 都 新建 一个 缓冲区 对象 每次 都会 新建 一个 缓冲区 对象 并发 编程 面试 合 辑 word 文档 下载 地址 链接 提 取码 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 微 服务 面试 合 辑 springboot 篇 什么 是 springboot 多年来 随着 新功能 的 增加 spring 变得 越来越 复杂 只需 访问 页面 我们 就会 看到 可以 在 我们 的 应用程序 中 使用 的 所有 spring 项目 的 不同 功能 如果 必须 启动 一个 新 的 spring 项目 我们 必须 添加 构建 路径 或 添加 maven 依赖 关系 配置 应用程序 服务器 添加 spring 配置 因此 开始 一个 新 的 spring 项目 需要 很多 努力 因为 我们 现在 必须 从头开始 做 所有 事情 springboot 是 解决 这个 问题 的 方法 springboot 已经 建立在 现有 spring 框架 之上 使用 spring 启动 我们 避免了 之前 我们 必须 做的 所有 样板 代码 和 配置 因此 springboot 可以 帮助 我们 以 最少 的 工作量 更加 健壮 地 使用 现有 的 spring 功能 springboot 有 哪些 优点 springboot 的 优点 有 减少 开发 测试 时间 和 努力 使用 javaconfig 有助 助于 避免 使用 xml 避免 大量 的 maven 导入 和 各种 版本 冲突 提供 意见 发展 方法 通过 提供 默认值 快速 开始 开发 没有 单独 的 web 服务器 需要 这 意味着 你 不再 需要 启动 tomcatglassfish 或 其他 任何东西 需要 更少 的 配置 因为 没有 webxml 文件 只需 添加 用 configuration 注释 的 类 然后 添加 用 bean 注释 的 方法 spring 将 自动 加载 对象 并 像 以前 一样 对 其 进行 管理 您 甚至 可以 将 autowired 添加到 bean 方法 中 以使 spring 自动 装入 需要 的 依赖 关系 中 基于 环境 的 配置 使用 这些 属性 您 可以 将 您 正在 使用 的 环境 传递 到 应用程序 在 加载 主 应用程序 属性 文件 后 spring 将在 中 加载 后续 的 应用程序 属性 文件 什么 是 是 spring 社区 的 产品 它 提供 了 配置 springioc 容器 的 纯 java 方法 因此 它有 助于 避免 使用 xml 配置 使用 javaconfig 的 优点 在于 面向对象 的 配置 由于 配置 被 定义 为 javaconfig 中 的 类 因此 用户 可以 充分利用 java 中 的 面向对象 功能 一个 配置 类 可以 继承 另一个 重写 它 的 bean 方法 等 减少 或 消除 xml 配置 基于 依赖 注入 原则 的 外化 配置 的 好处 已被 证明 但是 许多 开发人员 不 希望 在 xml 和 java 之间 来回 切换 javaconfig 为 开发人员 提供 了 一种 纯 java 方法来 配置 与 xml 配置 概念 相似 的 spring 容器 从 技术 角度 来讲 只 使用 javaconfig 配置 类 来 配置 容器 是 可行 的 但 实际上 很多人 认为 将 javaconfig 与 xml 混合 匹配 是 理想 的 类型 安全 和 重构 友好 javaconfig 提供 了 一种 类型 安全 的 方法来 配置 spring 容器 由于 java 对 泛 型 的 支持 现在 可以 按 类型 而 不是 按 名称 检索 bean 不需要 任何 强制 转换 或 基于 字符串 的 查找 如何 重新 加载 springboot 上 的 更改 而 无需 重新启动 服务器 这可 以 使用 dev 工具 来 实现 通过 这种 依赖 关系 您 可以 节省 任何 更改 嵌入式 tomcat 将 重新启动 springboot 有 一个 开发工具 devtools 模块 它有 助于 提高 开发人员 的 生产力 java 开发人员 面临 的 一个 主要 挑战 是 将 文件 更改 自动 部署 到 服务器 并 自动 重启 服务器 开发人员 可以 重新 加载 springboot 上 的 更改 而 无需 重新启动 服务器 这将 消除 每次 手动 部署 更改 的 需要 springboot 在 发布 它 的 第一个 版本 时 没有 这个 功能 这是 开发人员 最 需要 的 功能 devtools 模块 完全 满足 开发人员 的 需求 该 模块 将在 生产 环境 中被 禁用 它还 提供 h 数据库 控制台 以 更好 地 测试 应用程序 中 的 监视器 是什么 是 spring 启动 框架 中 的 重要 功能 之一 springboot 监视器 可 帮 助您 访问 生产 环境 中正 在 运行 的 应用程序 的 当前 状态 有 几个 指标 必须 在 生产 环境 中 进行检查 和 监控 即使 一些 外部 应用程序 可能 正在 使用 这些 服务 来向 相关 人员 触发 警报 消息 监视器 模块 公 开了 一组 可直接 作为 httpurl 访问 的 rest 端 点来 检查 状态 如 何在 springboot 中 禁用 actuator 端点 安全性 默认 情况下 所有 敏感 的 http 端点 都是 安全 的 只有 具有 actuator 角色 的 用户 才能 访问 它们 安全性 是 使用 标准 的 方法 实施 的 我们 可以 使用 来 禁用 安全性 只有 在 执行机构 端 点在 防火墙 后 访问 时 才 建议 禁用 安全性 如 何在 自定义 端 口上 运行 springboot 应用程序 为了 在 自定义 端 口上 运行 springboot 应用程序 您 可以 在 中 指定 端口 serverport 什么 是 yamlyaml 是 一种 人类 可读 的 数据 序列化 语言 它 通常 用于 配置文件 与 属性 文件 相比 如果 我们 想 要在 配置文件 中 添加 复杂 的 属性 yaml 文件 就 更加 结构化 而且 更少 混淆 可以 看出 yaml 具有 分层 配置 数据 如何 实现 springboot 应用程序 的 安全性 为了 实现 springboot 的 安全性 我们 使用 依赖 项 并且 必须 添加 安全 配置 它 只需要 很少 的 代码 配置 类 将 必须 扩展 并 覆盖 其 方法 如何 集成 springboot 和 activemq 对于 集成 springboot 和 activemq 我们 使用 依赖 关系 它 只需要 很少 的 配置 并且 不需要 样板 代码 如何 使用 springboot 实现 分页 和 排序 使用 springboot 实现 分页 非常 简单 使用 springdatajpa 可以 实现 将可 分页 的 传 递给 存储 库 方法 什么 是 swagger 你 用 springboot 实现 了 它 吗 swagger 广泛 用于 可视化 api 使用 swaggerui 为 前端 开发人员 提供 在线 沙箱 swagger 是 用于 生成 restfulweb 服务 的 可视化 表示 的 工具 规范 和 完整 框架 实现 它 使 文档 能够 以 与 服务器 相同 的 速度 更新 当 通过 swagger 正确 定义 时 消费者 可以 使用 最 少量 的 实现 逻辑 来 理解 远程 服务 并 与其 进行 交互 因此 swagger 消 除了 调用 服务 时 的 猜测 什么 是 允许 用户 根据 配置文件 devtestprod 等 来 注册 bean 因此 当 应用程序 在 开发 中 运行时 只有 某些 bean 可以 加载 而在 production 中 某些 其他 bean 可以 加载 假设 我们 的 要 求是 swagger 文档 仅 适用于 qa 环境 并且 禁用 所有 其他 文档 这可 以 使用 配置文件 来 完成 springboot 使得 使用 配置文件 非常 简单 什么 是 提供 可 重用 的 函数 这些 函数 在 处理 大量 记录 时 非常重要 包括 日志 跟踪 事务管理 作业 处理 统计 信息 作业 重新启动 跳过 和 资源管理 它还 提供 了 更 先进 的 技术服务 和 功能 通过 优化 和 分区 技术 可以 实现 极高 批量 和 高性能 批处理 作业 简单 以及 复杂 的 大批量 批处理 作业 可以 高度 可 扩展 的 方式 利用 框架 处理 重要 大量 的 信息 什么 是 freemarker 模板 freemarker 是 一个 基于 java 的 模板 引擎 最初 专注 于 使用 mvc 软件 架构 进行 动态 网页 生成 使用 freemarker 的 主要 优点 是 表示 层 和 业务 层 的 完全 分离 程序员 可以 处理 应用 程序代码 而设 计 人员 可以 处理 html 页面 设计 最后 使用 freemarker 可以 将 这些 结合起来 给出 最终 的 输出 页面 如何 使用 springboot 实现 异常 处理 spring 提供 了 一种 使用 处理 异常 的 非常 有用 的 方法 我们 通过 实现 一个 controleradvice 类 来 处理 控制器 类 抛出 的 所有 异常 您 使 用了 哪些 startermaven 依赖 项 使 用了 下面 的 一些 依赖 项 这有 助于 增加 更少 的 依赖 关系 并 减少 版本 的 冲突 什么 是 csrf 攻击 csrf 代表 跨 站 请求 伪造 这是 一种 攻击 迫使 最终用户 在 当前 通过 身份验证 的 web 应用 程序上 执行 不需要 的 操作 csrf 攻击 专门 针对 状态 改变 请求 而 不是 数据 窃取 因为 攻击者 无法 查看 对 伪造 请求 的 响应 什么 是 是 一种 计算机 通信协议 通过 单个 tcp 连接 提供 全双工 通信 信道 websocket 是 双向 的 使用 websocket 客户端 或 服务器 可以 发起 消息 发送 websocket 是 全双工 的 客户端 和 服务器 通信 是 相互 独立 的 单个 tcp 连接 初始 连接 使用 http 然后 将此 连接 升级到 基于 套接 字 的 连接 然后 这个 单一 连接 用于 所有 未来 的 通信 light 与 http 相比 websocket 消息 数据交换 要 轻 得多 什么 是 aop 在 软件开发 过程中 跨越 应用程序 多个 点 的 功能 称为 交叉 问题 这些 交叉 问题 与 应用程序 的 主要 业务 逻辑 不同 因此 将 这些 横切 关注 与 业务 逻辑 分开 是 面向 方面 编程 aop 的 地方 什么 是 是 一个 分布式 发布 订阅 消息 系统 它是 一个 可 扩展 的 容错 的 发布 订阅 消息 系统 它 使 我们 能够 构建 分布式 应用程序 这是 一个 apache 顶级 项目 kafka 适合 离线 和 在线 消息 消费 我们 如何 监视 所有 springboot 微 服务 springboot 提供 监视器 端点 以 监控 各个 微 服务 的 度量 这些 端点 对于 获取 有关 应用程序 的 信息 如 它们 是否 已 启动 以及 它们 的 组件 如 数据库 等 是否 正常 运行 很有 帮助 但是 使用 监视器 的 一个 主要 缺点 或 困难 是 我们 必须 单独 打开 应用程序 的 知识点 以 了解 其 状态 或 健康状况 想象 一下 涉及 个 应用程序 的 微 服务 管理员 将不 得不 击中 所有 个 应用程序 的 执行 终端 dubbo 篇 dubbo 中 zookeeper 做 注册 中心 如果 注册 中心 集群 都 挂掉 发布者 和 订阅 者 之间 还能 通信 么 可以 通信 的 启动 dubbo 时 消费者 会 从 zk 拉 取 注册 的 生产者 的 地址 接口 等 数据 缓 存在 本地 每次 调 用时 按照 本地 存储 的 地址 进行 调用 注册 中心 对等 集群 任意 一台 宕机 后 将会 切 换到 另一台 注册 中心 全部 宕机 后 服务 的 提供者 和 消费者 仍能 通过 本地 缓存 通讯 服务 提供者 无 状态 任一 台 宕机 后 不影响 使用 服务 提供者 全部 宕机 服务 消费者 会 无法 使用 并无 限次 重 连 等待 服务 者 恢复 挂掉 是 不要紧 的 但 前提 是 你 没有 增加 新 的 服务 如果 你 要 调用 新 的 服务 则是 不能 办到 的 dubbo 服务 负载 均衡 策略 随机 按 权重 设置 随机 概率 在 一个 截 面上 碰撞 的 概率 高 但 调 用量 越大 分布 越 均匀 而且 按 概率 使用 权重 后 也 比较 均匀 有利于 动态 调整 提供者 权重 权重 可以 在 dubbo 管 控 台 配置 轮 循 按 公约 后 的 权重 设置 轮 循 比率 存在 慢 的 提供者 累积 请求 问题 比如 第二 台 机器 很慢 但 没 挂 当 请求 调到 第二 台 时 就 卡 在那 久而久之 所有 请求 都 卡在 调到 第二 台上 最少 活跃 调用 数 相同 活跃 数 的 随机 活跃 数 指 调用 前后 计数 差使 使 慢 的 提供者 收到 更少 请求 因为 越慢 的 提供者 的 调用 前后 计数 差 会 越大 一致性 hash 相同 参数 的 请求 总是 发到 同一 提供者 当 某一 台 提供者 挂 时 原本 发往 该 提供者 的 请求 基于 虚拟 节点 平 摊到 其它 提供者 不会 引起 剧烈 变动 缺省 只对 第一个 参数 hash 如果 要 修改 请 配置 在 安全 机制 方面 是 如何 解决 的 dubbo 通过 token 令牌 防止 用户 绕过 注册 中心 直连 然后 在 注册 中 心上 管理 授权 dubbo 还 提供 服务 黑白 名单 来 控制 服务所 允许 的 调用 方 dubbo 连接 注册 中心 和 直连 的 区 别在 开发 及 测试 环境 下 经常 需要 绕过 注册 中心 只 测试 指定 服务 提供者 这时候 可能 需要 点对点 直连 点对点 直 联 方式 将以 服务 接口 为 单位 忽略 注册 中心 的 提供者 列表 失败 安全 出现异常 时 直接 忽略 通常 用于 写入 审计 日志 等 操作 applescript 纯 文本 查看 复制 代码 服务 注册 中心 动态 的 注册 和 发现 服 务使 服务 的 位置 透明 并 通过 在 消费 方 获取 服务 提供方 地址 列表 实现 软 负载 均衡 和 failover 注册 中心 返回 服务 提供者 地址 列表 给 消费者 如果有 变更 注册 中心 将 基于 长 连接 推送 变更 数据 给 消费者 服务 消费者 从 提供者 地址 列表 中 基于 软 负载 均衡 算法 选 一台 提供者 进行 调用 如果 调用 失败 再选 另一台 调用 注册 中心 负责 服务 地址 的 注册 与 查找 相当于 目录 服务 服务 提供者 和 消费者 只 在 启动时 与 注册 中心 交互 注册 中心 不 转发 请求 服务 消费者 向 注册 中心 获取 服务 提供者 地址 列表 并 根据 负载 算法 直接 调用 提供者 注册 中心 服务 提供者 服务 消费者 三者 之间 均为 长 连接 监控 中心 除外 注册 中心 通 过长 连接 感知 服务 提供者 的 存在 服务 提供者 宕机 注册 中心 将 立即 推送 事件 通知 消费者 注册 中心 和 监控 中心 全部 宕机 不影响 已 运行 的 提供者 和 消费者 消费者 在 本地 缓存 了 提供者 列表 注册 中心 和 监控 中心 都是 可选 的 服务 消费者 可以 直连 服务 提供者 dubbo 服务 集群 配置 集群 容错 模式 在 集群 调用 失败 时 dubbo 提供 了 多种 容错 方案 缺省 为 failover 重试 可以 自行 扩展 集群 容错 策略 默认 失败 自动 切换 当 出现 失败 重试 其它 服务器 缺省 通常 用于 读 操作 但 重试 会 带来 更长 延迟 可通过 retries 来 设置 重试 次数 不含 第一次 或 可以 不用 写 因为 默认 就是 快速 失败 只 发起 一次 调用 失败 立即 报错 通常 用于 非 幂 等 性 的 写 操作 比如 新增 记录 或 和 把 是 样 的 效果 retries 就是 不 重试 失败 安全 出现异常 时 直接 忽略 通常 用于 写入 审计 日志 等 操作 或 失败 自动 恢复 后台 记录 失败 请求 定时 重发 通常 用于 消息 通知 操作 或 并行 调用 多个 服务器 只要 一个 成功 即 返回 通常 用于 实时 性要求 较高 的 读 操作 但 需要 浪费 更多 服务 资源 可通过 forks 来 设置 最大 并 行数 或 配置 服务端 服务 级别 客户端 服务 级别 服务端 方法 级别 客户端 方法 级别 通信协议 dubbo 协议 为什么 要 消费者 比 提供者 个数 多 因 dubbo 协议 采用 单 一长 连接 假设 网络 为 千兆 网卡 mbitmbyte 根据 测试 经验 数据 每条 连接 最多 只能 压 满 mbyte 不同 的 环境 可能 不一样 供 参考 理论 上个 服务 提供者 需要 个 服务 消费者 才能 压 满 网卡 dubbo 通信协议 dubbo 协议 为什么 不能 传 大包 因 dubbo 协议 采用 单 一长 连接 如果 每次 请求 的 数据包 大小 为 kbyte 假设 网络 为 千兆 网卡 mbitmbyte 每条 连接 最大 mbyte 不同 的 环境 可能 不一样 供 参考 单个 服务 提 的 tps 每秒 处理事务 数 最 大为 mbytekbyte 单个 消费者 调用 单个 服务 提供者 的 tps 每秒 处理事务 数 最 大为 mbytekbyte 如果能 接受 可以 考虑 使用 否则 网络 将 成为 瓶颈 dubbo 通信协议 dubbo 协议 为什么 采用 异步 单 一长 连接 因为 服务 的 现状 大都是 服务 提供者 少 通常 只有 几台 机器 而 服务 的 消费者 多 可能 整个 网站 都在 访问 该 服务 比如 morgan 的 提供者 只有 台 提供者 却有 上百 台 消费者 每天 有 亿次 调用 如果 采用 常规 的 hessian 服务 服务 提供者 很 容易 就被 压 跨 通过 单一 连接 保证 单一 消费者 不会 压 死 提供者 长 连接 减少 连接 握手 验证 等 并 使用 异步 io 复用 线程 池 防止 ck 问题 dubbo 通信协议 dubbo 协议 适用范围 和 适用 场景 适用范围 传入 传出 参数 数据包 较小 建议 小于 k 消费者 比 提供者 个数 多 单一 消费者 无法 压 满 提供者 尽量 不 要用 dubbo 协议 传输 大文件 或 超大 字符串 适用 场景 常规 远程 服务 方法 调用 dubbo 协议 补充 连接 个数 单 连接 连接 方式 长 连接 传输 协议 tcp 传输 方式 nio 异步 传输 序列化 hessian 二进制 序列化 rmi 协议 rmi 协议 采用 的 标准 jdk 标准 的 javarmi 实现 采用 阻塞 式 短 连接 和 jdk 标准 序列化 方式 java 标准 的 远程 调用 协议 连接 个数 多 连接 连接 方式 短 连接 传输 协议 tcp 传输 方式 同步 传输 序列化 java 标准 二进制 序列化 适用范围 传入 传出 参数 数据包 大小 混合 消费者 与 提供者 个数 差不多 可传 文件 适用 场景 常规 远程 服务 方法 调用 与 原生 rmi 服务 互 操作 什么 是 hessian 协议 hessian 协议 用于 集成 hessian 的 服务 hessian 底层 采用 http 通讯 采用 servlet 暴露 服务 dubbo 缺省 内嵌 jetty 作为 服务器 实现 基于 hessian 的 远程 调用 协议 连接 个数 多 连接 连接 方式 短 连接 传输 协议 http 传输 方式 同步 传输 序列化 hessian 二进制 序列化 适用范围 传入 传出 参数 数据包 较大 提供者 比 消费者 个数 多 提供者 压力 较大 可传 文件 适用 场景 页面 传输 文件 传输 或与 原生 hessian 服务 互 操作 http 采用 spring 的 httpinvoker 实现 基于 http 表单 的 远程 调用 协议 连接 个数 多 连接 连接 方式 短 连接 传输 协议 http 传输 方式 同步 传输 序列化 表单 序列化 json 适用范围 传入 传出 参数 数据包 大小 混合 提供者 比 消费者 个数 多 可用 浏览器 查看 可用 表单 或 url 传入 参数 暂不 支持 传 文件 适用 场景 需 同时 给 应用程序 和 浏览器 js 使用 的 服务 webservice 基于 cxf 的 frontendsimple 和 transportshttp 实现 基于 webservice 的 远程 调用 协议 连接 个数 多 连接 连接 方式 短 连接 传输 协议 http 传输 方式 同步 传输 序列化 soap 文本 序列化 适用 场景 系统集成 跨 语言 调用 概述 下 thrifthrift 是 facebook 捐给 apache 的 一个 rpc 框架 当前 dubbo 支持 的 thrift 协议 是 对 thrift 原生 协议 的 扩展 在 原生 协议 的 基础上 添 加了 一些 额外 的 头 信息 比如 等 springcloud 篇 画出 springcloud 基本 架构图 eureka 服务 注册 中心 feign 服务 调用 ribbon 负载 均衡 网关 这么多 的 系统 电 商 系统 包 含了 个子 系统 每个 子系统 有 个 核心 接口 一共 电 商 系统 有 个 接口 这么多 的 接口 直接 对外 暴露 前 后端 分离 的 架构 难道 你 让 前端 的 同学 必须 记住 你 的 个 系统 的 部署 的 机器 他们 去做 负载 均衡 记 住个 接口 微 服务 那块 网关 灰度 发布 统一 熔断 统一 降级 统一 缓存 统一 限流 统一 授权 认证 hystrix 链 路 追踪 stream 很多 组件 hystrix 这块 东西 其实是 会 放在 高 可用 的 环节 去 说的 并 不是说 一个 普通 系统 刚开始 就必须 得用 的 没有 用好 的话 反而会 出问题 hystrix 线路 熔断 的 框架 必 须得 设计 对应 的 一整套 的 限流 方案 熔断 方案 资源 隔离 降级 机制 配合 降级 机制 来 做 springcloud 组件 原理 eureka 原理图 eureka 缓存 的 设计 目的 优化 并发 并发 冲突 如果 操作 服务 注册表 读 时 加锁 防止 写写 时 加锁 不能读 效率 降低 feign 原理 在 配置 类 上 加上 那么 该 注解 是 基于 import 注解 注册 有关 fegin 的 解析 注册 类 这个 类 是 实现 这个 接口 重写 方法 他 会 扫描 所有 加了 feginclient 的 接口 然后 针对 这个 注解 的 接口 生成 动态 代理 然后 你 针对 fegin 的 动态 代 理去 调用 他 方法 的 时候 此时 会在 底层 生成 http 协议 格式 的 请求 ribbo 原理 底层 的话 使用 http 通信 的 框架 组件 httpclient 先得 使用 ribbon 去 本地 的 eureka 注册表 的 缓存 里 获取 出来 对方 机器 的 列表 然后 进行 负载 均衡 选出 一台 机器 接着 针对 那台 机器 发送 http 请求 过去 即可 zuul 原理 配置 一下 不同 的 请求 路径 和 服务 的 对应 关系 你 的 请求 到了 网关 他 直接 查 找到 匹配 的 服务 然后就 直接 把 请求 转发给 服务 的 某 台 机器 ribbon 从 eureka 本地 地 的 缓存 列 表里 获取 一台 机器 负载 均衡 把 请求 直接 用 http 通信 扩建 发送到 指定 机器 上去 springcloud 和 dubbo 的 区别 dubborpc 的 性能比 http 的 性能 更好 并发 能力 更强 经过 深度 优化 的 rpc 服务 框架 性能 和 并发 能力 是 更好 一些 很多 中小型 公司 而言 其实 稍微 好 一点 的 性能 dubbo 一次 请求 msspringcloud 耗费 ms 对 很多 中小型 公司 而言 性能 并发 并不是 最主要 的 因素 springcloud 这套 架构 原理 走 http 接口 和 http 请求 就 足够 满足 性能 和 并发 的 需 要了 没必要 使用 高度 优化 的 rpc 服务 框架 dubbo 之前 的 一个 定位 就是 一个 单纯 的 服务 框架 而已 不 提供 任何 其他 的 功能 配合 的 网关 还得 选择 其他 的 一些 技术 springcloud 中小型 公司 用 的 特别 多老 系统 从 dubbo 迁 移到 springcloud 新系统 都是 用 springcloud 来 进行 开发 全家 桶 主 打的 是 微 服务 架构 里 组件 齐全 功能 齐全 网关 直接 提供 了 分布式 配置 中心 授权 认证 服务 调用 链 路 追踪 hystrix 可以 做 服务 的 资源 隔离 熔断 降级 服务 请求 qps 监控 契约 测试 消息 中间件 封装 zk 封装 胜 是 胜在 功能 齐全 中小型 公司 开箱 即用 直接 满足 系统 的 开发 需求 springcloud 原来 支持 的 一些 技术 慢慢 的 未来 会演 变为 跟 阿里 技术 体系 进行 融合 阿里 技术 会 融入 springcloud 里面 去 你们 的 服务 注册 中心 进行 过 选型 调研 吗 对比 一下 各种 服务 注册 中心 作为 服务 框架 的 一般 注册 中心 会 选择 zkspringcloud 作为 服务 框架 的 一般 服务 注册 中心 会 选择 eureka 服务 注册 发现 的 原理 集群 模式 部署 一个 集群 但是 集群 里 每个 机器 的 地位 是 对等 的 各个 服务 可以 向 任何 一个 eureka 实例 服务 注册 和 服务 发现 集群 里 任何 一个 euerka 实例 接 收到 写 请求 之 后会 自动 同步 给 其他 所有 的 eureka 实例 zookeeper 服务 注册 和 发现 的 原理 leaderfollower 两种 角色 只有 leader 可以 负责 写 也 就是 服务 注册 他 可以 把 数据 同步 给 follower 读 的 时候 leaderfollower 都可以 读 一致性 保障 cporapcapc 是 一致性 a 是 可用性 p 是 分区 容错 性 cpapzookeeper 是 有 一个 leader 节点 会 接收 数据 然后 同步 写 其他 节点 一旦 leader 挂了 要 重新 选举 leader 这个 过程 里 为了 保证 c 就 牺牲 了 a 不可用 一段时间 但是 一个 leader 选举 好了 那么 就可以 继续 写 数据 了 保证 一致性 eureka 是 peer 模式 可能 还没 同步 数据 过去 结果 自己 就 死了 此时 还是 可以 继续 从 别的 机器 上 拉 取 注册表 但是 看到 的 就不是 最新 的 数据 了 但是 保证 了 可用性 强 一致 最终 一致性 服务 注册 发现 的 时效性 zk 时效性 更好 注册 或者是 挂了 一般 秒 级 就能 感知 到 eureka 默认 配置 非常 糟糕 服务 发现 感知 要到 几十 秒 甚至 分钟 级别 上线 一个 新 的 服务 实例 到 其他人 可以 发现 他 极端 情况下 可能要 分钟 的 时间 ribbon 去 获取 每个 服务 上 缓存 的 eureka 的 注册表 进行 负载 均衡 服务 故障 隔 秒 才 去 检查 心跳 发现 这个 服务 上 一次 心跳 是 在 秒 之前 隔 秒 去 检查 心跳 超过 秒 没有 心跳 才会 认为 他 死了 分钟 都 过去 秒 才会 更新 缓存 秒 其他 服务 才 会来 拉 取 最新 的 注册表 三分钟 都 过去了 如果 你 的 服务 实例 挂 掉了 此时 别人 感知 到 可能要 两三 分钟 的 时间 一两 分钟 的 时间 很 漫长 容量 zk 不适合 大规模 的 服务 实例 因为 服务 上 下线 的 时候 需要 瞬间 推送 数据 通知 到 所有 的 其他 服务 实例 所以 一旦 服务 规模 太大 到了 几千个 服务 实例 的 时候 会 导致 网络带宽 被 大量 占用 eureka 也 很难 支撑 大规模 的 服务 实例 因为 每个 eureka 实例 都要 接受 所有 的 请求 实例 多了 压力 太大 扛不住 也 很 难到 几千 服务 实例 之前 dubbo 技术 体系 都是 用 zk 当 注册 中心 springcloud 技术 体系 都是 用 eureka 当 注册 中心 这两种 是 运用 最 广泛 的 但是 现在 很多 中小型 公司 以 springcloud 居多 所以 后面 基于 eureka 说 一下 服务 注册 中心 的 生产 优化 画图 阐述 一下 你们 的 服务 注册 中心 部署 架构 生产 环境 下 怎么 保证 高 可用 你们 系统 遇到过 服务 发现 过慢 的 问题 吗 怎么 优化 和 解决 的 zk 一般来说 还好 服务 注册 和 发现 都是 很快 的 eureka 必须 优化 参数 服务器 到 注册 中心 心跳 时间 设置 注册 中心 定时 检测 心跳 时间 设置 心跳 失效 时间 设置 readwrite 缓存 定 更 新到 readonly 时间 设置 客户端 定时 拉 取 readwrite 缓存 时间 设置 服务 发现 的 时效性 变成 秒 级 几秒钟 可以 感知 服务 的 上线 和 下线 说 一下 自己 公司 的 服务 注册 中心 怎么 技术 选型 的 生产 环境 中 应该 怎么 优化 l 可用性 l 时效性 l 数据一致性 cpapl 容量 通过 集群 保证 可用性 你们 对 网关 的 技术 选型 是 怎么 考虑 的 能 对比 一下 各种 网关 技术 的 优劣 吗 网关 的 核心 功能 动态 路由 新 开发 某个 服务 动态 把 请求 路径 和 服务 的 映射 关系 热加 载到 网关 里 去 服务 增减 机器 网关 自动 热 感知 灰度 发布 授权 认证 性能 监控 每个 api 接口 的 耗时 成功率 qps 系统 日志 数据 缓存 限流 熔断 几种 技术 选型 自 研 网关 kongnginx 里面 的 一个 基于 lua 写 的 模块 实现 了 网关 的 功能 zuul 基于 java 开发 核心 网关 功能 都 比较简单 但是 比如 灰度 发布 限流 动态 路由 之类 的 很多 都要 自己 做 二次开发 高 并发 能力 不强 部署 到 一些 机器 上去 还要 基于 tomcat 来 部署 springboot 用 tomcat 把 网关 系统 跑起来 java 语言 开发 可以 直接 把 控 源码 可以 做 二次开发 封装 各种 需要 的 功能 直接 通过 nginx 来 当做 网关 自 研 网关 自己 来写 类似 zuul 的 网关 基于 servletnetty 来 做 网关 实现 上述 所有 的 功能 如果 网关 需要 抗 每秒 万 的 高 并发 访问 你 应该 怎么 对 网关 进行 生产 优化 zuul 网关 部署 的 是什么 配置 的 机器 部署 核 g 对 网关 路由 转发 的 请求 每秒 抗 个 小 几万 请 求是 不成问题 的 几台 zuul 网关 机器 每秒 是 万 请求 核 g 的 机器 部署 zuul 网关 台 机器 就 够了 生产 级 的 网关 应该 具备 我 刚才 说的 几个 特点 和 功能 动态 路由 新 开发 某个 服务 动态 把 请求 路径 和 服务 的 映射 关系 热加 载到 网关 里 去 服务 增减 机器 网关 自动 热 感知 灰度 发布 基于 现成 的 开源 插件 来 做 授权 认证 限流 熔断 性能 监控 每个 api 接口 的 耗时 成功率 qps 系统 日志 数据 缓存 如果 需要 部署 上万 服务 实例 现有 的 服务 注册 中心 能否 抗 住 如何 优化 eureka 和 zk 都是 扛不住 了 可以 主动 说 出 注册 中心 的 缺点 每台 机器 都是 高 并发 请求 有 瓶颈 zookeeper 服务 上 下线 全 量 通知 其他 服务 网络带宽 被打 满有 瓶颈 可以 加 一个 数据库 层 或者是 redis 缓存 层 每个 服务 定时 通过 数据库 redis 缓存 层 来 更新 服务 注册表 然后 数据库 redis 缓存 层 定时 拉 取 注册 中心 来 更新 注册表 可以 自 研 类似于 redis 集群 加 主 备 架构 将 压力 分 散开 按需 拉 取 局部 的 注册表 比如说 服务 a 在 注册 中心 那么 只用 拉 取 注册 中心 的 注册表 而 不用 将 注册 中心 等等 其他 注册 拉 取 过来 缓解 压力 说说 生产 环境 下 你们 是 怎么 实现 网关 对 服务 的 动态 路由 的 l 通过 数据库 网关 定时 拉 取 数据库 服务 注册 中心 配置 l 首先 开发 注册 中心 配置 系统 通过 页面 可以 动态 的 将 增加 新老 服务 写入 到 数据库 l 同时 也 可以 通过 拉 取 eureka 来 最新 的 服务 注册 中心 配置 写入 到 数据库 l 网关 定时 秒 拉 取 数据库 的 最新 配置 这样 好处 减 少了 eureka 的 压力 同时 当 注册 中心 服务 宕机 也 不影响 当前 网关 的 路由 你们 是 如何 基于 网关 实现 灰度 发布 的 说说 你们 的 灰度 发布 方案 准备 一个 数据库 和 一个 表 也 可以用 apollo 配置 中心 rediszookeeper 其实 都可以 放 一个 灰度 发布 启用 表 写 一个 zuul 的 filter 对 每个 请求 zuul 都会 调用 这个 filter 当 尝试 新版本 发布 修改 新 服务 的 版本 为 new 通过 页面 修改 配置 中心 或者 修改 数据库 表 开 灰度 发布 开 灰度 发布 网关 的 filter 就会 随机 百分之 的 请求 带上 new 版本 这样 请求 就会 跑到 新 服 务当 新 服务 使用 一段时间 没有问题 再将 old 服务 全部 替换成 new 服务 版本 设置 为 current 关闭 灰度 发布 说说 你们 一个 服务 从 开发 到 上线 服务 注册 网关 路由 服务 调用 的 流程 springcloud 原理图 注册 中心 eureka 网关 zuul 服务 调用 fegin 负载 均衡 ribbon 什么 是 流 应用程序 启动器 是 基于 springboot 的 spring 集成 应用程序 提供 与 外部 系统 的 集成 springcloudtask 一个 生命周期 短暂 的 微 服务 框架 用于 快速 构建 执行 有限 数据处理 的 应用程序 使用 springcloud 有 什么 优势 使用 springboot 开发 分布 式微 服务 时 我们 面临 以下 问题 与 分布式 系统 相关 的 复杂性 这种 开销 包括 网络 问题 延迟 开销 带宽 问题 安全问题 服务 发现 服务 发现 工具 管理 群 集中 的 流程 和 服务 如何 查找 和 互相 交谈 它 涉及 一个 服务 目 录在 该 目录 中 注册 服务 然后 能够 查找 并 连 接到 该 目录 中 的 服务 冗余 分布式 系统 中 的 冗余 问题 负载平衡 负载平衡 改善 跨 多个 计算 资源 的 工作 负荷 诸如 计算机 计算机 集群 网络 链 路 中央处理 单元 或 磁盘驱动器 的 分布 性能 问题 由于 各种 运营 开销 导致 的 性能 问题 部署 复杂性 devops 技能 的 要求 服务 注册 和 发现 是什么 意思 springcloud 如何 实现 当 我们 开始 一个 项目 时 我们 通常在 属性 文件 中 进行 所有 的 配置 随着 越来越多 的 服务 开发 和 部署 添加 和 修改 这些 属性 变得 更加 复杂 有些 服务 可能会 下降 而 某些 位置 可能会 发生变化 手动 更改 属性 可能会 产生 问题 eureka 服务 注册 和 发现 可以 在 这种 情况下 提供 帮助 由于 所有 服务 都在 eureka 服务器 上 注册 并 通过 调用 eureka 服务器 完成 查找 因此 无需 处理 服务 地点 的 任何 更改 和 处理 负载平衡 的 意义 什么 在 计算 中 负载平衡 可以 改善 跨 计算机 计算机 集群 网络 链接 中央处理 单元 或 磁盘驱动器 等 多种 计算 资源 的 工作 负载 分布 负载平衡 旨在 优化 资源 使用 最大化 吞吐量 最小化 响应 时间 并 避免 任何 单一 资源 的 过载 使用 多个 组件 进行 负载平衡 而 不是 单个 组件 可能会 通过 冗余 来 提高 可靠性 和 可用性 负载平衡 通常 涉及 专用 软件 或 硬件 例如 多层 交换机 或 域名 系统 服务器 进程 什么 是 hystrix 它 如何 实现 容错 hystrix 是 一个 延迟 和 容错 库 旨在 隔离 远程 系统 服务 和 第三方 库 的 访 问点 当 出现 故障 是 不可避免 的 故障 时 停止 级 级联 故障 并在 复杂 的 分布式 系统 中 实现 弹性 通常 对于 使用 微 服务 架构 开发 的 系统 涉及到 许多 微 服务 这些 微 服务 彼此 协作 思考 一下 微 服务 假设 如果 上 图中 的 微 服务 失败 了 那么 使用 传统 方法 我们 将 传播 一个 异常 但 这 仍然会 导致 整个 系统 崩溃 随着 微 服务 数量 的 增加 这个 问题 变得 更加 复杂 微 服务 的 数量 可以 高达 这是 hystrix 出现 的 地方 我们 将 使用 hystrix 在 这种 情况下 的 fallback 方法 功能 我们 有 两个 服务 使用 由 公开 的 服务 什么 是 hystrix 断路器 我们 需要 它 吗 由于 某些 原因 公开 服务 会 引发 异常 在 这种 情况下 使用 hystrix 我们 定义 了 一个 回退 方法 如果在 公开 服务 中 发生 异常 则 回退 方法 返回 一些 默认值 如果 firstpagemethod 中 的 异常 继续 发生 则 hystrix 电路 将 中断 并且 员工 使用者 将 一起 跳过 firtspage 方法 并 直接 调用 回退 方法 断路器 的 目的 是 给 第一页 方法 或 第一页 方法 可能 调用 的 其他 方法 留出 时间 并 导致 异常 恢复 可能发生 的 情况 是 在 负载 较小 的 情况下 导致 异常 的 问题 有 更好 的 恢复 机会 什么 是 netflixfeign 它 的 优点 是什么 feign 是 受到 retrofitjaxrs 和 websocket 启发 的 java 客户端 联 编 程序 feign 的 第一个 目标 是 将 约束 分母 的 复杂性 统 一到 httpapis 而 不 考虑 其 稳定性 在 的 例子 中 我们 使 用了 使用 rest 模板 公开 的 rest 服务 但是 我们 必须 编写 大量 代码 才能 执行 以下 步骤 使用 功能 区 进行 负载平衡 获取 服务 实例 然后 获取 基本 url 利用 rest 模板 来 使用 服务 前面 的 代码 如下 tostring stringclass catch exceptionex ex responsegetbody 之前 的 代码 有 像 nullpointer 这样 的 例外 的 机会 并不是 最优 的 我们 将 看到 如何 使用 netflixfeign 使 呼叫 变得 更加 轻松 和 清洁 如果 netflixribbon 依赖 关系 也 在 类 路径 中 那么 feign 默认 也 会 负责 负载平衡 什么 是 springcloudbus 我们 需要 它 吗 考虑 以下 情况 我们 有 多个 应用程序 使用 读取 属性 而 从 git 读取 这些 属性 下面 的 例子 中 多个 员工 生产者 模块 从 获取 eureka 注册 的 财产 如果 假设 git 中 的 eureka 注册 属性 更 改为 指向 另一台 eureka 服务器 会 发生 什么情况 在 这种 情况下 我们 将不 得不 重新启动 服务 以 获取 更新 的 属性 还有 另一种 使用 执行器 断点 刷新 的 方式 使 我们 将不 得 不为 每个 模块 单独 调用 这个 url 例如 如果 部署 在 端 口上 则 调用 同样 对于 等等 这又 很 麻烦 这 就是 springcloudbus 发挥作用 的 地方 springcloudbus 提供 了 跨 多个 实例 刷新 配置 的 功能 因此 在上面 的 示例 中 如果 我们 刷新 则会 自动 刷新 所有 其他 必需 的 模块 如果 我们 有 多个 微 服务 启动 并 运行 这 特别 有用 这是 通过 将 所有 微 服务 连 接到 单个 消息 代理 来 实现 的 无论 何时 刷新 实例 此 事件 都会 订阅 到 侦听 此 代理 的 所有 微 服务 并且 它们 也 会 刷新 可以 通过 使用 端点 总线 刷 新来 实现 对 任何 单个 实例 的 刷新 微 服务 面试 合 辑 word 文档 下载 地址 链接 提 取码 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 并发 编程 面试 篇 合 辑 并发 编程 上 synchronized 用过 吗 其 原理 是什么 这是 一道 java 面试 中 几乎 百分 百会 问到 的 问题 因为 没有 任何 写过 并发 程序 的 开发者 会 没听说 或者 没 接触 过 是 由 jvm 实现 的 一种 实现 互斥 同步 的 一种 方式 如果 你 查看 被 synchronized 修 饰过 的 程序 块 编译 后 的 字节 码 会发 现被 synchronized 修 饰过 的 程序 块 在 编译 前后 被 编译器 生 成了 monitorenter 和 monitorexit 两个 字节 码 指令 这两个 指令 是什么 意思 呢 在 虚拟机 执行 到 monitorenter 指令 时 首先要 尝试 获取 对象 的 锁 如果 这个 对象 没有 锁定 或者 当前 线程 已经 拥有 了 这个 对象 的 锁 把 锁 的 计数器 当 执行 monitorexit 指令 时 将 锁 计数器 当 计数器 为时 锁 就被 释放 了 如果 获取 对象 失败 了 那 当前 线程 就要 阻塞 等待 直到 对象 锁 被 另外 一个 线程 释放 为止 java 中 synchronize 通过 在对 象头 设置 标记 达 到了 获取 锁 和 释放 锁 的 目的 你 刚才 提到 获取 对象 的 锁 这个 锁 到底 是什么 如何 确定 对象 的 锁 锁 的 本质 其实是 monitorenter 和 monitorexit 字节 码 指令 的 一个 reference 类型 的 参数 即要 锁定 和 解锁 的 对象 我们 知道 使用 synchronized 可以 修饰 不同 的 对象 因此 对应 的 对象 锁 可以 这么 确定 如果 synchronized 明确 指定 了 锁 对象 比如 synchronized 变量名 synchronized this 等 说明 加 解锁 对象 为 该 对象 如果 没有 明确 指定 若 synchronized 修饰 的 方法 为 非 静态 方法 表示 此 方法 对应 的 对象 为 锁 对象 若 synchronized 修饰 的 方法 为 静态 方 法则 表示 此 方法 对应 的 类 对象 为 锁 对象 注意 当 一个 对象 被 锁住 时 对象 里面 所 有用 synchronized 修饰 的 方法 都将 产生 堵塞 而 对象 里 非 synchronized 修饰 的 方法 可 正 常被 调用 不受 锁 影响 什么 是 可 重入 性 为什么 说 synchronized 是 可 重入 锁 可 重入 性 是 锁 的 一个 基本要求 是为了 解决 自己 锁 死 自己 的 情况 比如 下面 的 伪 代码 一个 类 中 的 同步 方法 调用 另一个 同步 方法 假如 synchronized 不支持 重入 进入 method 方法 时 当前 线程 获得 锁 method 方法 里面 执行 method 时 当前 线程 又 要去 尝试 获取 锁 这时 如果 不支持 重入 它就 要等 释放 把 自己 阻塞 导致 自己 锁 死 自己 对 synchronized 来说 可 重入 性 是 显而易见 的 刚才 提到 在 执行 monitorenter 指令 时 如果 这个 对象 没有 锁定 或者 当前 线程 已经 拥有 了 这个 对象 的 锁 而 不是 已 拥有 了 锁 则 不能 继续 获取 就把 锁 的 计数器 其实 本质上 就 通过 这种 方式 实现 了 可 重入 性 jvm 对 java 的 原生 锁 做了 哪些 优化 在 java 之前 monitor 的 实现 完全 依赖 底层 操作系统 的 互斥 锁 来 实现 也 就是 我们 刚才在 问题 二 中所 阐述 的 获取 释放 锁 的 逻辑 由于 java 层面 的 线程 与 操作系统 的 原生 线程 有 映射 关系 如果 要将 一个 线程 进行 阻塞 或 唤起 都 需要 操作系统 的 协助 这就 需 要从 用户 态 切 换到 内核 态 来 执行 这种 切换 代价 十分 昂贵 很 耗 处理器 时间 现代 jdk 中 做了 大量 的 优化 一种 优化 是 使用 自旋 锁 即在 把 线程 进行 阻塞 操作 之前 先让 线程 自旋 等待 一段时间 可能在 等待 期间 其他 线程 已经 解锁 这时 就 无需 再让 线程 执行 阻塞 操作 避免了 用户 态 到 内核 态 的 切换 现代 jdk 中 还 提供 了 三种 不同 的 monitor 实现 也 就是 三种 不同 的 锁 偏向 锁 biasedlocking 轻量级 锁 重量级 锁 这三种 锁 使得 jdk 得以 优化 synchronized 的 运 行当 jvm 检 测到 不同 的 竞争 状况 时会 自动 切 换到 适合 的 锁 实现 这 就是 锁 的 升级 降级 当 没有 竞争 出 现时 默认 会 使用 偏向 锁 jvm 会 利用 cas 操作 在对 象 头上 的 markword 部分 设置 线程 id 以 表示 这个 对象 偏向 于 当前 线程 所以 并不 涉及 真正 的 互斥 锁 因为 在 很多 应用 场景 中大 部分 对象 生命周期 中最 多 会被 一个 线程 锁定 使用 偏斜 锁 可以 降低 无 竞争 开销 如果有 另一 线程 试图 锁定 某个 被 偏 斜过 的 对象 jvm 就 撤销 偏斜 锁 切 换到 轻量级 锁 实现 轻量级 锁 依赖 cas 操作 markword 来 试图 获取 锁 如果 重试 成功 就 使用 普通 的 轻量级 锁 否则 进一步 升级 为重 量级 锁 为什么 说 synchronized 是非 公平 锁 非 公平 主要 表 现在 获取 锁 的 行为 上 并非是 按照 申请 锁 的 时间 前后 给 等待 线程 分 配锁 的 每当 锁 被 释放 后 任何 一个 线程 都有 机会 竞争 到 锁 这样 做的 目的 是为了 提高 执行 性能 缺点 是 可能会 产生 线程 饥饿 现象 什么 是 锁 消除 和 锁 粗 化 锁 消除 指 虚拟机 即时 编译器 在运 行时 对 一些 代码 上 要求 同步 但 被 检 测到 不可能 存在 共享 数据 竞争 的 锁 进行 消除 主要 根据 逃逸 分析 程序员 怎么 会在 明 知道 不存在 数据 竞争 的 情况下 使用 同步 呢 很多 不是 程序员 自己 加入 的 锁 粗 化 原则上 同步 块 的 作用 范围 要 尽量 小 但是 如果 一系列 的 连续 操作 都对 同一个 对象 反复 加锁 和 解锁 甚至 加锁 操作 在 循环 体内 频繁 地 进行 互斥 同步操作 也 会 导致 不必要 的 性能 损耗 锁 粗 化 就是 增大 锁 的 作用 域 为什么 说 synchronized 是 一个 悲观 锁 乐观 锁 的 实现 原理 又是 什么 什么 是 cas 它有 什么 特性 synchronized 显然是 一个 悲观 锁 因为 它 的 并发 策略 是 悲观 的 不管 是否 会 产生 竞争 任何 的 数据 操作 都必须 要 加锁 用户 态 核 心态 转换 维护 锁 计数器 和 检查 是否 有 被 阻塞 的 线程 需 要被 唤醒 等 操作 随着 硬件 指令集 的 发展 我们 可以 使用 基于 冲突 检测 的 乐观 并发 策略 先 先 进行 操作 如果 没有 其他 线程 征用 数据 那 操作 就 成功 了 如果 共享 数据 有 征用 产 生了 冲突 那就 再 进行 其他 的 补偿 措施 这种 乐观 的 并发 策略 的 许多 实现 不需要 线程 挂起 所以 被称为 非 阻塞 同步 乐观 锁 的 核心 算法 是 cas compareandswap 比较 并 交换 它 涉及到 三个 操作数 内存 值 预期 值 新 值当 且 仅 当 预期 值 和 内存 值 相等 时 才 将 内存 值 修 改为 新 值 这样 处理 的 逻辑 是 首先 检查 某 块 内存 的 值 是否 跟 之前 我 读取 时 的 一样 如不 一样 则 表示 期间 此 内存 值 已经 被 别的 线程 更 改过 舍弃 本次 操作 否则 说明 期间 没有 其他 线程 对此 内存 值 操作 可以 把 新 值 设置 给 此 块 内存 cas 具有 原子 性 它 的 原子 性 由 cpu 硬件 指令 实现 保证 即 使用 jni 调用 native 方法 调用 由 c 编写 的 硬件 级别 指令 jdk 中 提供 了 unsafe 类 执行 这些 操作 乐观 锁 一定 就是 好 的 吗 乐观 锁 避免了 悲观 锁 独占 对象 的 现象 同时 也 提高了 并发 性能 但它 也有 缺点 乐观 锁 只能 保证 一个 共享 变量 的 原子 操作 如果 多 一个 或 几个 变量 乐观 锁 将 变得 力不从心 但 互斥 锁 能 轻易 解决 不管 对象 数量 多少 及 对象 颗 粒度 大小 长时间 自旋 可能 导致 开销 大 假如 cas 长时间 不成功 而 一直 自旋 会给 cpu 带来 很大 的 开销 aba 问题 cas 的 核心 思想 是 通过 比对 内存 值 与 预期 值 是否 一样 而 判断 内存 值 是否 被 改过 但 这个 判断 逻辑 不 严谨 假如 内存 值 原来是 a 后来 被 一条 线程 改为 b 最后 又被 改 成了 a 则 cas 认 为此 内存 值 并没有 发生 改变 但 实际上 是 有 被 其他 线程 改过 的 这种 情况 对 依赖 过程 值 的 情景 的 运算 结果 影响很大 解决 的 思路 是 引入 版本号 每次 变量 更 新都 把 版本号 加 一跟 synchronized 相比 可 重入 锁 reentrantlock 其 实现 原理 有 什么 不同 其实 锁 的 实现 原理 基本 是为了 达到 一个 目的 让 所有 的 线程 都能 看到 某种 标记 synchronized 通过 在对 象 头中 设置 标记 实现 了 这一 目的 是 一种 jvm 原生 的 锁 实现 方式 而 reentrantlock 以及 所有 的 基于 lock 接口 的 实现 类 都是 通过 用 一个 volitile 修饰 的 int 型 变量 并 保证 每个 线程 都能 拥有 对 该 int 的 可 见性 和 原子 修改 其本质 是 基于 所谓 的 aqs 框架 那么 请 谈谈 aqs 框架 是 怎么 回事儿 aqs 类 是 一个 用来 构建 锁 和 同步器 的 框架 各种 lock 包 中 的 锁 常用 的 有 以及 其他 如 甚至 是 早期 的 futuretask 等 都是 基于 aqs 来 构建 aqs 在内部 定义 了 一个 变量 表示 同步 状态 当 线程 调用 lock 方法 时 如果 state 说明 没有 任何 线程 占有 共享资源 的 锁 可以获得 锁 并将 state 如果 state 则 说明 有 线程 目前 正在 使用 共享 变量 其他 线程 必须 加入 同步 队列 进行 等待 aqs 通过 node 内 部类 构成 的 一个 双向 链表 结构 的 同步 队列 来 完成 线程 获取 锁 的 排队 工作 当 有 线程 获取 锁 失败 后 就被 添加到 队列 末尾 node 类 是 对 要 访问 同步 代码 的 线程 的 封装 包 含了 线程 本身 及其 状态 叫 waitstatus 有 五种 不同 取值 分别 表示 是否 被 阻塞 是否 等待 唤醒 是否 已经 被 取消 等 每个 node 结点 关联 其 prev 结点 和 next 结点 方便 线程 释放 锁 后 快速 唤醒 下一个 在 等待 的 线程 是 一个 fifo 的 过程 node 类 有 两个 常量 shared 和 exclusive 分别 代表 共享 模式 和 独占 模式 所谓 共享 模式 是 一个 锁 允许 多条 线程 同时 操作 信号量 semaphore 就是 基于 aqs 的 共享 模式 实现 的 独占 模式 是 同一个 时间段 只能 有 一个 线程 对 共享资源 进行 操作 多余 的 请求 线程 需要 排队 等待 如 reentranlock aqs 通过 内 部类 conditionobject 构建 等待 队列 可有 多个 当 condition 调用 wait 方法 后 线程 将会 加入 等待 队列 中 而 当 condition 调用 signal 方法 后 线程 将从 等待 队列 转 移动 同步 队列 中 进行 锁 竞争 aqs 和 condition 各自 维护 了 不同 的 队列 在 使用 lock 和 condition 的 时候 其实 就是 两个 队列 的 互相 移动 请 尽可能 详尽 地 对 比下 synchronized 和 reentrantlock 的 异同 reentrantlock 是 lock 的 实现 类 是 一个 互斥 的 同步 锁 从 功能 角度 reentrantlock 比 synchronized 的 同步操作 更 精细 因为 可以 像 普通 对象 一样 使用 甚至 实现 synchronized 没有 的 高级 功能 如 等待 可 中断 当 持有 锁 的 线程 长期 不 释放 锁 的 时候 正在 等待 的 线程 可以 选择 放弃 等待 对 处理 执行时间 非常 长 的 同步 块 很 有用 带 超时 的 获取 锁 尝试 在 指定 的 时间 范围内 获取 锁 如果 时间 到了 仍然 无法 获取 则 返回 可以 判断 是否 有 线程 在 排队 等待 获取 锁 可以 响应 中断请求 与 synchronized 不 同当 获 取到 锁 的 线程 被 中断 时 能够 响应 中断 中断 异常 将 会被 抛出 同时 锁 会被 释放 可以 实现 公平 锁 从 锁 释放 角度 synchronized 在 jvm 层 面上 实现 的 不但 可以 通过 一些 监控 工具 监控 synchronized 的 锁定 而且 在 代码 执行 出现异常 时 jvm 会 自动 释放 锁定 但是 使用 lock 则 不行 lock 是 通过 代码 实现 的 要 保证 锁定 一定 会被 释放 就必须 将 unlock 放到 finally 中 从 性能 角度 synchronized 早期 实现 比较 低效 对比 reentrantlock 大多数 场景 性能 都 相差 较大 但是在 java 中 对 其 进行了 非常 多 的 改 进在 竞争 不 激烈 时 synchronized 的 性能 要 优于 reetrantlock 在 高 竞争 情况下 synchronized 的 性能 会 下降 几十倍 但是 reetrantlock 的 性能 能 维持 常态 reentrantlock 是 如何 实现 可 重入 性 的 reentrantlock 内部 自定义 了 同步器 sync sync 既 实现 了 aqs 又 实现 了 aos 而 aos 提供 了 一种 互斥 锁 持有 的 方式 其实 就是 加锁 的 时候 通过 cas 算法 将 线程 对象 放到 一个 双向 链表 中 每次 获取 锁 的 时候 看下 当前 维护 的 那个 线程 id 和 当前 请求 的 线程 id 是否 一样 一样 就可 重 入了 除了 reetrantlock 你 还 接触 过 juc 中 的 哪些 并发 工具 通常 所说 的 并 发包 juc 也 就是 及其 子 包 集 中了 java 并发 的 各种 基础 工具 类 具体 主要 包括 几个 方面 提供 了 等比 synchronized 更加 高级 可以 实现 更加 丰富 多线程 操作 的 同步 结构 提供 了 有序 的 或者 通过 类似 快照 机制 实现 线程 安全 的 动态 数组 等 各种 线程 安全 的 容器 提供 了 或 针对 特定 场景 的 等 各种 并发 队列 实现 强大 的 executor 框架 可以 创建 各种不同类型 的 线程 池 调度 任务 运行 等 请 谈谈 readwritelock 和 stampedlock 虽然 reentrantlock 和 synchronized 简单 实用 但是 行为 上有 一定 局限性 要么 不占 要么 独占 实际 应用 场景 中有 时候 不需要 大量 竞争 的 写 操作 而 是以 并发 读取 为主 为了 进一步 优化 并发 操作 的 粒度 java 提供 了 读写 锁 读写 锁 基于 的 原理 是 多个 读 操作 不需要 互斥 如果 读 锁 试图 锁 定时 写 锁 是 被 某个 线程 持有 读 锁 将 无法 获得 而 只好 等待 对方 操作 结束 这样 就可以 自动 保证 不会 读 取到 有 争议 的 数据 读写 锁 看起 来比 synchronized 的 粒度 似乎 细 一些 但在 实际 应用 中 其 表现 也 并不 尽如人意 主要 还是 因为 相对 比 较大 的 开销 所以 jdk 在 后期 引 入了 stampedlock 在 提供 类似 读写 锁 的 同时 还 支持 优化 读 模式 优化 读 基于 假设 大多数 情况下 读 操作 并不会 和 写 操作 冲突 其 逻辑 是 先 试着 修改 然后 通过 validate 方法 确认 是否 进 入了 写 模式 如果 没有 进入 就 成功 避免了 开销 如果 进入 则 尝试 获取 读 锁 如何 让 java 的 线程 彼此 同步 你 了解 过 哪些 同步器 请 分别 介绍 下 juc 中 的 同步器 三个 主要 的 成员 和 semaphore 通过 它们 可以 方便地 实现 很多 线程 之间 协作 的 功能 countdownlatch 叫 倒 计数 允许 一个 或 多个 线程 等待 某些 操作 完成 看 几个 场景 跑步 比赛 裁判 需要 等到 所有 的 运动员 其他 线程 都 跑到 终点 达到 目标 才 能去 算 排名 和 颁奖 模拟 并发 我 需要 启动 个 线程 去 同时 访问 某一个 地址 我 希望 它们 能 同时 并发 而 不是 一个一个 的 去 执行 用法 countdownlatch 构造 方法 指明 计数 数量 被 等待 线程 调用 countdown 将 计数器 减 等待 线程 使用 await 进行 线程 等待 一个 简单 的 例子 cyclicbarrier 叫 循环 栅栏 它 实现 让 一组 线程 等待 至 某个 状态 之后 再 全部 同时 执行 而且 当 所有 等待 线程 被 释放 后 cyclicbarrier 可以 被 重复使用 cyclicbarrier 的 典型 应用 场景 是 用来 等待 并发 线程 结束 cyclicbarrier 的 主要 方法 是 await await 每 被 调用 一次 计数 便会 减少 并 阻塞住 当前 线程 当 计数 减至 时 阻塞 解除 所有 在此 cyclicbarrier 上面 阻塞 的 线程 开始 运行 在这 之后 如果 再次 调用 await 计数 就 又会 变成 n 新一轮 重新开始 这便是 cyclic 的 含义 所在 带有 返回值 用来 表示 当前 线程 是 第几个 到达 这个 barrier 的 线程 举例说明 如下 semaphorejava 版本 的 信号量 实现 用于 控制 同时 访问 的 线程 个 数来 达到 限制 通用 资源 访问 的 目的 其 原理 是 通过 acquire 获取 一个 许可 如果 没有 就 等待 而 release 释放 一个 许可 如果 semaphore 的 数值 被 初始 化为 那么 一个 线程 就可以 通过 acquire 进入 互斥 状态 本质上 和 互斥 锁 是 非常 相似 的 但是 区别 也 非常 明显 比如 互斥 锁 是 有 持有者 的 而 对于 semaphore 这种 计数器 结构 虽然有 类似 功能 但 其实 不存在 真正 意义 的 持有者 除非 我们 进行 扩展 包装 cyclicbarrier 和 countdownlatch 看起来 很 相似 请 对 比下 呢 它们 们 的 行为 有 一定 相似 度 区别 主要 在于 countdownlatch 是 不可以 重置 的 所以 无法 重用 cyclicbarrier 没有 这种 限制 可以 重用 countdownlatch 的 基本 操作 组合 是 countdownawait 调用 await 的 线程 阻塞 等待 countdown 足够 的 次数 不管 你 是 在 一个 线程 还是 多个 线程 里 countdown 只要 次数 足够 即可 cyclicbarrier 的 基本 操作 组合 就是 await 当 所有 的 伙伴 都 调 用了 await 才会 继续进行 任务 并 自动 进行 重置 countdownlatch 目的 是 让 一个 线程 等待 其他 n 个 线程 达到 某个 条件 后 自己 再 去做 某个 事 通过 cyclicbarrier 的 第二个 构造 方法 在 新 线程 里 做事 可以 达到 同样 的 效果 而 cyclicbarrier 的 目的 是 让 n 多线程 互相 等待 直到 所有 的 都 达到 某个 状态 然后 这 n 个 线程 再 继续 执行 各自 后续 通过 countdownlatch 在 某些 场合 也 能 完成 类似 的 效果 java 中 的 线程 池 是 如何 实现 的 在 java 中 所谓 的 线程 池中 的 线程 其实是 被 抽象 为了 一个 静态 内 部类 worker 它 基于 aqs 实现 存放在 线程 池 的 hashsetworkers 成员 变量 中 而 需要 执行 的 任务 则 存放在 成员 变量 workqueue 中 这样 整个 线程 池 实现 的 基本思想 就是 从 workqueue 中 不断 取出 需要 执行 的 任务 放在 workers 中 进行 处理 创建 线程 池 的 几个 核心 构造 参数 java 中 的 线程 池 的 创建 其实 非常 灵活 我们 可以 通过 配置 不同 的 参数 创建 出 行为 不同 的 线程 池 这 几个 参数 包括 corepoolsize 线程 池 的 核心 线程 数 maximumpoolsize 线程 池 允许 的 最大 线程 数 keepalivetime 超过 核心 线程 数 时 闲置 线程 的 存活 时间 workqueue 任务 执 行前 保存 任务 的 队列 保存 由 execute 方法 提交 的 runnable 任务 线程 池中 的 线程 是 怎么 创建 的 是 一开始 就 随着 线程 池 的 启动 创 建好 的 吗 显然 不是 的 线程 池 默认 初始化 后 不 启动 worker 等待 有 请求 时 才 启动 每当 我们 调用 execute 方法 添加 一个 任务 时 线程 池 会做 如下 判断 如果 正在 运行 的 线程 数量 小于 corepoolsize 那么 马上 创建 线程 运行 这个 任务 如果 正在 运行 的 线程 数量 大于 或 等于 corepoolsize 那么 将 这个 任务 放入 队列 如果 这时候 队列 满了 而且 正在 运行 的 线程 数量 小于 maximumpoolsize 那么 还是 要 创建 非 核心 线程 立刻 运行 这个 任务 如果 队列 满了 而且 正在 运行 的 线程 数量 大于 或 等于 maximumpoolsize 那么 线程 池 会 抛出 异常 当 一个 线程 完成任务 时 它会 从 队列 中 取下 一个 任务 来 执 行当 一个 线程 无事 可 做 超过 一定 的 时间 keepalivetime 时 线程 池 会 判断 如果 当前 运行 的 线程 数 大于 corepoolsize 那么 这个 线程 就被 停掉 所以 线程 池 的 所有 任务 完成后 它最 终会 收缩到 corepoolsize 的 大小 既然 提到 可以 通过 配置 不同 参数 创 建出 不同 的 线程 池 那么 java 中 默认 实现 好 的 线程 池 又有 哪些 呢 请 比较 它们 的 异同 线程 池 这个 线程 池 只有 一个 核心 线程 在 工作 也 就是 相当于 单线程 串行 执行 所有 任务 如果 这个 唯一 的 线程 因为 异常 结束 那么 会有 一个 新 的 线程 来 替代 它 此 线程 池 保证 所有 任务 的 执行 顺序 按照 任务 的 提交 顺序 执行 corepoolsize 只有 一个 核心 线程 在 工作 其 缓冲 队列 是 无界 的 fixedthreadpool 线程 池 fixedthreadpool 是 固定 大小 的 线程 池 只有 核心 线程 每次 提交 一个 任务 就 创建 一个 线程 直到 线程 达到 线程 池 的 最大 大小 线程 池 的 大小 一旦 达到 最大值 就会 保持 不变 如果 某个 线程 因为 执行 异常 而 结束 那么 线程 池 会 补充 一个 新 线程 fixedthreadpool 多数 针对 一些 很 稳定 很 固定 的 正规 并发 线程 多 用于 服务器 其 缓冲 队列 是 无界 的 线程 池 是 无界 线程 池 如果 线程 池 的 大小 超 过了 处理 任务 所 需要 的 线程 那么 就会 回收 部分 空闲 秒 不 执行任务 线程 当 任务 数 增加 时 此 线程 池 又 可以 智能 的 添加 新 线程 来 处理 任务 线程 池 大小 完全 依赖于 操作系统 或者说 jvm 能够 创建 的 最大 线程 大小 是 一个是 缓冲区 为 的 阻塞 队列 缓存 型 池子 通常 用于 执行 一些 生存期 很短 的 异步 型 任务 因此在 一些 面向 连接 的 daemon 型 server 中用 得 不多 但 对于 生存期 短 的 异步 任务 它是 executor 的 首选 一个是 缓冲区 为 的 阻塞 队列 线程 池 核心 线程 池 固定 大小 无限 的 线程 池 此 线程 池 支持 定时 以及 周期性 执行任务 的 需求 创建 一个 周期性 执行任务 的 线程 池 如果 闲置 非 核心 线程 池 会在 时间内 回收 如 何在 java 线程 池中 提交 线程 线程 池 最 常用 的 提交 任务 的 方法 有 两种 execute 方法 接收 一 个例 它 用来 执行 一个 任务 submit 方法 返回 的 是 future 对象 可以用 isdone 来 查询 future 是否 已经 完成 当 任务 完成 时 它 具有 一个 结果 可以 调用 get 来 获取 结果 也 可以 不用 isdone 进行检查 就 直接 调用 get 在 这种 情况下 get 将 阻塞 直至 结果 准备就绪 什么 是 java 的 内存 模型 java 中 各个 线程 是 怎么 彼此 看到 对方 的 变量 的 java 的 内存 模型 定义 了 程序 中 各个 变量 的 访问 规则 即在 虚拟机 中将 变量 存储 到 内存 和 从 内存 中 取出 这样 的 底层 细节 此处 的 变量 包括 实例 字段 静态 字段 和 构成 数组 对象 的 元素 但是 不包括 局部变量 和 方法 参数 因为 这些 是 线程 私有 的 不 会被 共享 所以 不存在 竞争 问题 java 中 各个 线程 是 怎么 彼此 看到 对方 的 变量 的 呢 java 中 定义 了 主 内存 与 工作 内存 的 概念 所有 的 变量 都 存储 在 主 内存 每条 线程 还有 自己 的 工作 内存 保存 了 被 该 线程 使 用到 的 变量 的 主 内存 副本 拷贝 线程 对 变量 的 所有 操作 读取 赋值 都必须 在 工作 内存 中 进行 不能 直接 读写 主 内存 的 变量 不同 的 线程 之间 也 无法 直接 访问 对方 工作 内存 的 变量 线程 间 变量值 的 传递 需要 通过 主 内存 请 谈谈 volatile 有 什么 特点 为什么 它能 保证 变量 对 所有 线程 的 可 见性 关键字 volatile 是 java 虚拟机 提供 的 最轻量级 的 同步 机制 当 一个 变量 被 定义 成 volatile 之后 具备 两种 特性 保证 此 变量 对 所有 线程 的 可 见性 当 一条 线程 修 改了 这个 变量 的 值 新 值 对于 其他 线程 是 可以 立即 得知 的 而 普通 变量 做不到 这一点 禁止 指令 重 排序 优化 普通 变量 仅 仅能 保证 在 该 方法 执行 过程中 得到 正确 结果 但是 不 保证 程序代码 的 执行 顺序 java 的 内存 模型 定义 了 种 内存 间 操作 lock 和 unlock 把 一个 变量 标识 为 一条 线程 独占 的 状态 把 一个 处于 锁定 状态 的 变量 释放出来 释放 之后 的 变量 才能 被 其他 线程 锁定 read 和 write 把 一个 变量值 从 主 内存 传 输到 线程 的 工作 内存 以便 load 把 store 操作 从 工作 内存 得到 的 变量 的 值 放 入主 内存 的 变量 中 load 和 store 把 read 操作 从 主 内存 得到 的 变量值 放入 工作 内存 的 变量 副本 中 把 工作 内存 的 变量值 传 送到 主 内存 以便 writeuse 和 assgin 把 工作 内存 变量值 传 递给 执行 引擎 将 执行 引擎 值 传 递给 工作 内存 变量值 volatile 的 实现 基于 这种 内存 间 操作 保证 了 一个 线程 对 某个 volatile 变量 的 修改 一定 会被 另一个 线程 看见 即 保证 了 可 见性 既然 volatile 能够 保证 线程 间 的 变量 可 见性 是不是 就 意味着 基于 volatile 变量 的 运算 就是 并发 安全 的 显然 不是 的 基于 volatile 变量 的 运 算在 并发 下不 一 定是 安全 的 volatile 变量 在 各个 线程 的 工作 内存 不存在 一致 性问题 各个 线程 的 工作 内存 中 volatile 变量 每次 使用 前 都要 刷 新到 主 内存 但是 java 里面 的 运算 并非 原子 操作 导致 volatile 变量 的 运 算在 并发 下一 样 是 不安全 的 请 对 比下 volatile 对比 synchronized 的 异同 synchronized 既能 保证 可 见性 又能 保证 原子 性 而 volatile 只能 保证 可 见性 无法 保证 原子 性 threadlocal 和 synchonized 都 用于 解决 多线程 并发 访问 防止 任务 在 共享资源 上 产生 冲突 但是 threadlocal 与 synchronized 有 本质 的 区别 synchronized 用于 实现 同步 机制 是 利用 锁 的 机制 使 变量 或 代码 块 在 某一 时刻 只能 被 一个 线程 访问 是 一种 以 时间 换 空间 的 方式 而 threadlocal 为 每一个 线程 都 提供 了 变量 的 副本 使得 每个 线程 在 某一时间 访 问到 的 并不是 同一个 对象 根 除了 对 变量 的 共享 是 一种 以 空间 换 时间 的 方式 请 谈谈 threadlocal 是 怎么 解决 并发 安全 的 threadlocal 这是 java 提供 的 一种 保存 线程 私有 信息 的 机制 因为 其 在 整个 线程 生命周期 内有效 所以 可以 方便地 在 一个 线程 关联 的 不同 业务 模块 之间 传递信息 比如 事务 idcookie 等上 下文 相关 信息 threadlocal 为 每一个 线程 维护 变量 的 副 本把 共享 数据 的 可见 范围 限制 在 同一个 线程 之内 其 实现 原理 是 在 th hreadlocal 类 中有 一个 map 用于 存储 每一个 线程 的 变量 的 副本 很多人 都说 要 慎用 threadlocal 谈谈 你 的 理解 使用 threadlocal 需要 注意 些 什么 使用 threadlocal 要注意 的 实 现是 基于 一个 所谓 的 threadlocalmap 在 threadlocalmap 中 它 的 key 是 一个 弱 引用 通常 弱 引用 都会 和 引用 队列 配合 清理 机制 使用 但是 threadlocal 是 个 例外 它 并没有 这么做 这 意味着 废弃 项目 的 回收 依赖于 显 式 地 触发 否则 就要 等待 线程 结束 进而 回收 相应 threadlocalmap 这 就是 很多 oom 的 来源 所以 通常 都会 建议 应用 一 定要 自己 负责 remove 并且 不 要和 线程 池 配合 因为 worker 线程 往往是 不会 退出 的 并发 编程 下 javastart 如何 调 用到 run 方法 java 层面 startgtstart gtnativestart c jvm 层面 jvmstartthread os 层面 pthreadcreate 这里会 回 调 jvm 的 run 方法 java 调用 native 方法 native 方法 对 应着 头文件 头文件 会 动态 链 接到 c 文件 c 文件 会 调用 系统 函数 synchronized 关键字 的 底层 原理 synchronize 锁 是 如何 实现 的 首先 每个 类 都由 objec 派 生出 每个 对象 都有 objectmonitor 当 线程 发生 同步 会去 尝试 将 objectmonitor 的 owner 设置 为 自己 如果 没有 获得 就会 进入 entrylist 中 获取 锁 monitor 的 计数器 就 会加 owner 就 指向 当前 线程 同时 synchronized 是 支持 重入 锁 也 就是 同一个 线程 对 同一个 对象 多次 加锁 每 加锁 一次 计数器 就 会加 获取 锁 线程 进入 同步 块 虚拟机 就会 设置 monitorenter 进入 同步 块 退出 同步 就会 设置 为 monitorexit 为了 防止 同步 中 出现异常 设置 了 第二个 monitorexit 当 退出 同步 计数器 就 变为 owner 设置 为 nullentrylist 中 线程 就会 cas 去 竞争 获取 对象 monitor 关联 的 锁 只有 一个 线程 可以 获 取到 锁 当 遇到 wait 就将 同步 的 线程 放入 waitset 中 当 对象 调用 notify 就会 随机 从 waitset 取 一个 线程 放到 entrylist 中 然后 线程 去 竞争 monitor 当 对象 调用 notifyall 就会 从 waitset 将 持有 该 对象 的 所有 的 线程 放到 entrylist 中 然后 线程 去 竞争 monitorwaitwait 会将 线程 从 entrylist 放 回到 waitset 中 notify 区别 和 notifyallnotify 会 从 waitset 等待 队列 中 随机 拿取 那一个 线程 放到 entrylist 阻塞 队列 中 notifyall 会将 waitset 所有 线程 都 放到 entrylist 中 唤醒 哪个 不确定 因为 不确定 谁 竞争 到了 锁 优化 锁 膨胀 过程 首先 synchronize 的 锁 的 状态 在对 象 头中 位 jdk 对应 的 对象 头中 一共 个 字节 个 字节 为 markword 个 字节 为 klassword 我们 主 要看 markword 结构 无 锁 主要 的 头 信息 lock 锁 状态 个 字节 biasedlock 是否 偏向 锁 个 字节 年轻 代 年龄 个字 节 用于 晋升 到老 年代 阈值 对象 标识 hash 码 个 字节 剩下 的 字节 没有用 偏向 锁 主要 的 头 信息 位 当先 线程 idage 字节 轻 量 锁 主要 的 头 信息 lock 重量 锁 主要 的 头 信息 lockgc 主要 的 头 信息 lock 对 象头 我们 可以 使用 openjdk 的 jol 插件 测试 打印头 信息 从无 锁 到 偏向 锁 默认 开启 延迟 偏向 锁 jvm 运行 默认 超过 s 那么 对象 就会 开启 偏向 锁 当 第一个 线程 来访问 它 的 时候 它会 修改 threadid 改为 当前 线程 的 id 之后 再 访问 这个 对象 时 只要 对比 threadid 一样 就不会 再 cas 他 默认 第一次 会 调用 os 加锁 可以 修改 os 上锁 函数 打印 系统 线程 id 再 修改 c 文件 打印 c 的 线程 id 当 开启 一个 线程 然后 同步 只 打印 一次 系统 线程 id 和 c 的 线程 id 而 开启 两个 线程 对 同一个 对象 加锁 会 发现 系统 线程 id 和 c 的 线程 id 同步 打印 多个 线程 通过 cas 来 获取 锁 偏向 上个 拥有 的 线程 是 乐观 锁 一般 是 单个 线程 执行 从 偏向 锁 到 轻量级 锁 当 前为 无 锁 直接 修 改为 轻量级 锁 当 前为 偏向 锁 并且 偏向 的 线程 不是 当前 线程 他 会 判断 该 锁 的 偏向 线程 是否 存活 没有 存活 将 偏向 锁 变为 无 锁 然后 变为 轻量级 锁 多个 线程 通过 cas 来 获取 锁 是 乐观 锁 一般 是 多个 线程 交替 执行 从轻 量级 锁 到 重量级 锁 轻量级 锁 自旋 一定 次数 或者 一个 线程 在 持有 锁 一个 在 自旋 另外 一个 线程 来访 时 轻量级 膨胀 为重 量级 锁 对象 调 用了 wait 也 会 变为 重量级 锁 重量级 锁 是 调 用了 os 函数 加锁 使 除了 拥有 锁 的 线程 以为 的 线程 都是 阻塞 防止 cpu 空转 是 悲观 锁 一般 是 多个 线程 竞争 执行 aqs 原理 aqs 全称 抽象 的 队列 同步器 他 是 一个 抽象类 aqs 通过 clh 队列 一个 带有 虚拟 头 节点 的 双向 链表 来 唤醒 线程 是否 可以 竞争 获取 锁 他 主要有 两种 方式 一种 是 独占 方式 只有 一个 线程 能 执行 一种 是 共享 方式 多个 线程 可以 同时 执行 我 主要 研究 了 独占 方式 的 aqs 实现 reentrantlock 的 实现 方式 reentrantlock 中有 个 内 部类 也就 sync 类 他 继承 了 aqs 抽象类 aqs 结构 head 头 结点 tail 尾 结点 state 加锁 次数 当前 占有 锁 的 线程 node 结构 pre 上个 节点 next 下个 节点 waitstate 节点 等待 状态 node 当前 线程 lock 加锁 步骤 整体 步骤 尝试 加锁 tryacquire 封装 线程 为 node 初始化 队列 唤醒 队列 竞争 锁 重置 interrupt 状态 尝试 加锁 tryacquire 首先 调用 tryacquire 主要 判断 aqs 中 的 state 是否 为 两种 情况 一种 是 长时间 为 自由 锁 状态 一种 是 短暂 刚 释放 锁 到 自由 锁 状态 如果 为 判断 是否 有 head 和 head 是否 有 next 节点 并且 node 线程 是否 是 当前 线程 主要 目的 就是 判断 是否 有 队列 以及 第二 节点 是否 为 当前 节点 如果 没有 队列 或者 下个 node 当前 线程 直接 cas 尝试 获取 锁 获取 锁 成功 返回 true 失败 返回 fasle 然后 判断 是否 是 重入 锁 也 就是 判断 当前 线程 是否 是 aqs 中 占有 锁 的 线程 如果是 重入 锁 state 返回 true 其他 情况 有 队列 且 不是 重入 锁 且 第二个 节点 线程 不是 当前 线程 返回 false 封装 线程 为 node 初始化 队列 先将 当前 线程 封 装成 node 判断 head 是否 为 null 不为 null 说明 已经 存在 队列 直接 设置 nodepre 为 tail 自己 设置 为 新 tail 为 null 说明 不存在 队列 直接 死循环 进行 以下 步骤 先 判断 tail 是否 为 null 为 null 通过 cas 设置 一个 空 节点 赋值 给 head 同时 tailhead 如果 tail 不为 null 将 node 的 pre 设置 为 tail 同时 cas 将 node 设置 为 新 tail 跳出 循环 唤醒 队列 竞争 锁 死循环 判断 当前 节点 pre 是否 是 head 目的 是 判断 自己 是否 为 队列 的 第二个 节点 如果是 队列 的 第二个 节点 就 cas 尝试 获取 锁 走 tryacquire 方法 获取 锁 成功 aqs 就是 当前 node 的 线程 设置 当前 node 为 head 旧 的 head 断开 连接 方便 gc 回收 获取 失败 走 下面 步骤 获取 失败 或者 不是 第二个 节点 首先 将 上个 节点 设置 为 waitstate 为 默认 waitstate 为 目的 是为了 解锁 用 然后 再次 循环 到 这里 执行 locksupportpark 等待 被 唤醒 如果 被 唤醒 会 调用 这个 方法 对 lock 没什么 作用 主要 是为了 lockinterruptor 方法 他 会 抛 异 常被 唤醒 后 继续 走 循环 逻辑 尝试 获取 锁 出现异常 会 走 finally 曲线 当前 线程 获取 锁 重置 interrupt 当 为 true 主要 目的 是为了 保持 线程 的 interrupt 的 状态 一直 非 公平 锁 会上 来就 尝试 获取 锁 获取 锁 失败 就走 公平 锁 逻辑 也 就是 一朝 排队 永久 排队 unlock 解锁 步骤 公平 锁 和 非 公平 锁 一直 unlock 调用 aqs 的 release 解锁 尝试 解锁 tryrelease 该 方法 返回 true 解锁 成功 false 解锁 失败 首先 state 得到 c 当前 线程 不是 aqs 中 占有 锁 的 线程 直接 抛 异常 c 解锁 成功 将 aqs 的 站 有 锁 的 线程 设置 为 null 其他 情况 返回 false 比如 重入 锁 state 可能 大于 解锁 成功 则 需要 判断 是否 需要 唤醒 其他 节点 通过 是否 有 head 判断 是否 存在 队列 因为 只有 一个 线程 可能 不会 初始化 队列 没有 队列 不需要 唤醒 有 队列 再 判断 head 的 waitstate 是否 为 不等于 说明 队列 还有 其他 节点 需要 唤醒 等于 head 为 tail 队列 不需要 唤醒 在 判断 headnext 节点 正常 情况 是 nextnode 不为 null 且 waitstate 为 lt 直接 唤醒 下个 一个 节点 极端 情况 nextnode 可 能为 null 或者 nextnode 的 gt 比如 放弃 索取 线程 那么 我们 可以 通 过从 链表 尾 往前 遍历 找到 离 当前 node 后面 最近 的 节点 且 该 node 的 和 synchronized 区别 相同点 都 实现 了 多线程 同步 和 内存 可 见性 语义 都是 可 重入 锁 不同点 同步 实现 机制 不同 synchronized 通过 java 对 象头 锁 标记 和 monitor 对象 实现 同步 reentrantlock 通过 和 locksupport 用于 阻塞 和 解除 阻塞 实现 同步 使用 方式 不同 synchronized 可以 修饰 实例 方法 锁住 实例 对象 静态 方法 锁住 类 对象 代码 块 显示 指定 锁 对象 reentrantlock 显示 调用 trylock 和 lock 方法 需 要在 finally 块 中 释放 锁 功能 丰富 程度不同 synchronized 不可 设置 等待时间 不 可被 中断 提供 有限 时间 等候 锁 设置 过期 时间 可 中断 锁 提供 awaitsignal 等 方法 等 丰富 功能 锁 类型 不同 synchronized 只 支持 非 公平 锁 reentrantlock 提供 公平 锁 和 非 公平 锁 实现 lock 高级 功能 countdownlatch 减法 计数器 减为 执行 本 线程 任务 场景 某个 线程 需 要等 其他 线程 程 执行 完 再 继续 执 行当 设置 了 await 时间 那么 时间 到了 主 线程 就 继续 执 行了 cyclicbarrier 加分 计数器 循环 屏障 场景 当前 线程 任务 需 要等 其他 线程 全部 到达 再一 起 执行 semaphore 停车场 场景 同一时间 可执行 固定 数量 的 线程 acquire 是 并发 执行 如果是 tryacquire 则不 一 定是 并发 执行 可能会 串行 执行 读写 锁 不同 线程 读读 不 互斥 其他 都 互斥 简述 下 cascas 有 三个 参数 第一个 参数 是 指针 原来 的 值 第二 参数 是 预期 值 第三个 参数 是 新 值 首先 拿到 旧 值 然后 比较 交换 的 时候 判断 预期 值 是不是 旧 值 如果 一样 就 赋值 为 新 值 否则 就不 交换 因为 cas 在 主 要是 mesi 协议 将 高速缓存 区 的 对应 要 修改 的 条目 加 独占 锁 通过 总线 通知 其他 的 处理器 然后 来 比较 修改 cas 虽然 高效 的 解决 了 原子 操作 问题 但仍然 存在 三 大问题 aba 问题 如果 变量 v 初次 读取 的 时候 值 是 a 后来 变 成了 b 然后又 变 成了 a 你 本来 期望 的 值 是 第一个 a 才会 设置 新 值 第二个 a 跟 期望 不符合 但 却也 能 设置 新 值 针对 这种 情况 java 并 发包 中 提供 了 一个 带有 标记 的 原子 引用 类 它 可以 通过 控制 变量值 的 版本号 来 保证 cas 的 正确性 比较 两个 值 的 引用 是否 一致 如果 一致 才会 设置 新 值 打 一个 比方 如果有 一家 蛋糕店 为了 挽留 客户 绝对 为 贵宾 卡里 余额 小于 元 的 客户 一次性 赠送 元 刺激 消费者 充值 和 消费 但 条件 是 每一位 客户 只能 被 赠送 一次 此时 如果 很 不幸 的 用户 正好 正在进行 消费 就在 赠予 金额 到 账 的 同时 他 进行了 一次 消费 使得 总金额 又 小于 元 并且 正好 累计 消 费了 元 使得 消费 赠予 后 的 金额 等于 消费 前 赠予 前 的 金额 这时 后台 的 赠予 进程 就会 误以为 这个 账户 还没有 赠予 所以 存 在被 多次 赠予 的 可能 但 使用 就可以 很好 的 解决 这个 问题 无限 循环 问题 自旋 看 源码 可知 atomic 类 设置 值 的 时候 会 进入 一个 无限 循环 只要 不成功 就会 不停 的 循环 再次 尝试 在 高 并发 时 如果 大量 线程 频繁 修改 同一个 值 可能会 导致 大量 线程 执行 compareandset 方法 时 需要 循环 n 次 才能 设置 成功 即 大量 线程 执行 一个 重复 的 空 循环 自旋 造成 大量 开销 解决 无线 循环 问题 可以 使用 java 中 的 longadder 有点像 的 高 并发 情况 new 一个 的 幂 次方 的 数组 最 大为 cpu 的 核 数 采用 对数 组 分段 cas 的 方式 进行 修改 每个 数组 下 标值 获取 总数 的 时候 采用 原值 数组 每个 下 标值 的 累加 多 变量 原子 问题 只能 保证 一个 共享 变量 的 原子 操作 一般 的 atomic 类 只能 保证 一个 变量 的 原子 性 但 如果是 多个 变量 呢 可以用 atomicreference 这个 是 封装 自定义 对象 的 多个 变量 可以 放 一个 自定义 对象 里 然后 他 会 检查 这个 对象 的 引用 是不是 同一个 如果 多个 线程 同时 对 一个 对象 变量 的 引用 进行 赋值 用 atomicreference 的 cas 操作 可以 解决 并发 冲突 问题 但是 如果 遇到 aba 问题 atomicreference 就 无能为力 了 需要 使用 来 解决 interrupt 方法 中断 几种 区别 interrupt 线程 标 记为 中断 抛 异常 interrupted 判断 线程 是否 中断 并且 重置 为 判断 线程 是否 中断 runnale 和 callable 区别 callable 执行 的 callrunnable 执行 的 是 runcallable 可以 获取 future 对象 可以 获取 返回值 run 方法 不行 线程 的 几种 状态 新建 new 新建 一个 线程 对象 可 运行 runnable 调用 start 的 方法 但是 没有 湖区 cpu 使用权 运行 running 调用 run 方法 获得 cpu 使用权 阻塞 blocked 调 用了 sleepwait 或者 运行时 等待 获取 锁 死亡 dead 线程 执行 完了 或者 异常 退 出了 run 方法 线程 池 几种 状态 running 新建 线程 池 shutdown 调用 shutdown 不在 接受 新任务 但是 会 继续 执行 已经 添加 的 任务 stop 调用 shutdownnow 不在 接受 新任务 同时 不会 执行 已 添加 任务 并且 终止 正在 执行 的 线程 tidying 任务 线程 停止 和 队 列为 空 的 状态 terminated 在 tidying 状态 调用 terminated 方法 线程 池 销毁 线程 池 参数 介绍 核心 线程 数 最大 线程 数 线程 空闲 时间 阻塞 队列 饱和 策略 线程 工厂 线程 池 的 分发 新任务 先 判断 核心 线程 数 是否 全部 再 执行 没有 就 新建 一个 执行 核心 线程 数 全部 在 执行 那么 就去 判断 队列 中 是否 已满 未满 添加到 队列 中 已满 就 判断 是否 达 到了 最大 线程 数 没有 达到 就 新建 线程 去 执行 当前 线程 已经 达 到了 就 调用 线程 池 的 饱和 策略 几种 线程 池 一般 是 使用 自己 根据 业务 cpu 核 数 设置 cpu 密集型 一般 是 核心 线程 数 和 cpu 核 数 因为 cpu 一直在 运行 cpu 利用率 高 io 密集型 一般 是 倍 核 数 cpu 利用 低 其他 线程 可以 继续 使用 cpu 提高 cpu 利用率 固定 核心 线程 数 无线 队列 没有 空闲 时间 的 适合 压力 较大 的 服务器 可以 控制 线程 数 合理 利用 资源 单一 线程 无线 队列 没有 空闲 时间 适合 串 型 任务 按 顺序 执行 的 任务 没有 核心 线程 数只 有 maxinteger 大 的 最大 核心 线程 数 无线 队列 有 较短 的 空闲 时间 适合 并发 高 周期短 的 任务 定时 线程 固定 线程 数 采用 延迟 或 定时 的 方式 来 执行任务 线程 池 的 饱和 策略 不 处理 抛 异常 不 处理 不 抛 异常 让 调用者 的 线程 处理 任务 丢弃 队列 头 消息 接下来 直接 执行 当前任务 自己 实现 接口 自定义 策略 submit 和 execut 区别 接受 参数 不同 execut 参数 为 runnablesubmit 可 用时 可以 通过 futuretask 获取 返回值 execut 是 没有 返回值 的 submit 最终 也是 调 用了 execut 线程 池 是 如何 做到 线程 复用 的 通过 work 的 runwork 方法 该 方法 第一次 通过 work 的 firsttask 获取 任务 之 后会 循环 通过 gettask 从 workqueue 中 不停地 获取 任务 并 直接 调用 task 的 task 是 实现 了 runnable run 方法来 执行任务 这样 就 保证 了 每个 线程 都 始终 在 一个 循 环中 反复 获取 任务 然后 执行任务 从而 实现 了 线程 的 复用 当 gettask 返回 null 就会 销毁 线程 空闲 线程 超时 销毁 如何 实现 的 首先 线程 池 会将 新建 的 work 放进 一个 set 集合 里 worksgettask 时候 先 判读 works 大小 是否 超过 核心 线程 数 超过 核心 线程 数 使用 poll 空闲 时间 去 获取 taskpoll 他 是非 阻塞 的 没用 超过 核心 线程 数 使用 的 是 take take 是 阻塞 的 一直 等待 回去 线程 当 poll 空闲 时间 到了 也没有 获取 到 任务 返回 nullrunwork 循环 条件 不成立 跳出 循环 最终 会 调用 销毁 work 逻辑 是 future 接口 的 一个 唯一 实现 类 futuretask 实现 了 runnable 因此 它 既可以 通过 thread 包装 来 直接 执行 也 可以 提 交给 executeservice 来 执行 futuretask 实现 了 futrue 可以 直接 通过 get 函数 获取 执行 结果 该 函数 会 阻塞 直到 结果 返回 threadlocal 起 什么 作用 线程 隔离 保证 线程 安全 threadlocal 内部 实现 原理 每个 thread 都有 内部 为 entry 数组 entry 对象 key 为 threadlocal 变量 value 是 存 的 变量 的 值 entry 的 key 也 就是 threadlocal 为 弱 引用 那么 也就是说 threadlocal 容易 被 gc 回 收掉 set 会 判断 是否 初始 化了 map 没有 就 初始化 同时 将 当前 threadlocal 作为 key 变量值 作为 value 存入 同时 可能会 触发 回收 失效 的 值 get 也 会 判断 是否 初始化 map 没有 就 初始化 初始化 默认 entry 长度 为 阈值 为 长度 threadlocal 引发 的 内存 泄漏 问题 entry 的 key 是 弱 引用 那么 就是说 threadlocal 容易 被 gc 回 收掉 当 key 被 gc 为 null 但是 entry 本身 被 map 引 用着 而 entry 又 引 用着 不为 null 的 value 我们 线程 一直 存活 且 一直 不 调用 getsetremove 方法 那么 这条 链 一直 存在 不 会被 gc 回收 导致 内存 泄漏 所以 最好 一旦 数据 不 使用 最好 直接 remove 掉 其实 threadlocalmap 的 设计 中 已经 考虑到 这种 情况 也 加 上了 一些 防护 措施 在 threadlocal 的 get set remove 的 时候 都会 清除 线程 threadlocalmap 里 所有 key 为 null 的 什么时候 可能会 出现 线程 不安全 问题 当 entry 的 value 为 共享 变量 的 时候 比如 加了 static 那么 就会 出现 不安全 问题 jmmjava 的 内存 模型 是 分 为主 内存 和 线程 的 工作 内存 两部分 进行 工作 的 工作 内存 从 主 内存 read 数据 load 到 工作 内存 中 线程 对 数据 进行 use 然后 将 数据 assign 到 工作 内存 从 工作 内存 store 处 理过 的 数据 最后 将 新 数据 write 进 主 内存 硬件 层面 原理 主 内存 cpu 寄存器 cpu 写 缓冲器 暂存 修改 的 变量 发送 消息 给 总线 通知 就 完事 等到 总线 通知 其他 处理器 全部 返 回了 收到 ack 它会 修改 高速缓存 优 化了 cpu 不需要 串行 等待 其他 cpu 返回 ack 再 写入 高速缓存 cpu 无效 队列 缓存 失效 变量 立刻 返回 ack 给 总线 收到 消息 优 化了 cpu 不需要 串行 等待 变更 高速缓存 再 发送 ack 通知 到 总线 cpu 高速缓存 缓 存着 主 内存 的 数据 总线 接受 发送 通知 每个 处理器 工作 流程 某个 cpu 对 本地 内存 数据 需要 修改 先在 写 缓存 器 修改 然后 发送 invalidate 消息 到 总线 其他 cpu 处理器 会 不停 的 嗅 探 总线 当 嗅 探 到 变量 需要 变更 会将 变量 放到 无效 队列 里 返回 invalidateack 消息 给 总线 之 后会 根据 无效 队列 将 对应 高速缓存 变量 标 记为 失效 标记 i 当 cpu 收到 所有 其他 的 cpu 发来 的 invalidateack 消息 就会 从 写 缓冲器 取出 数据 锁定 高速缓存 中 的 条目 标记 e 独占 锁 然后 将 写 缓存 器 的 数据 写到 高速缓存 主 内存 标 记为 m 解决 可 见性 store 屏障 flush 操作 强制 要求 写 操作 必须 阻塞 等 待到 其他 的 处理器 返回 invalidateack 之后 加锁 然后 修改 数据 到 高速缓存 效果 就是 要求 一个 西 曹 佐 必须 刷 到 高速缓存 或者 主 内存 不能 停留在 写 缓存 中 load 屏障 refresh 操作 从 高速缓存 中 中 读取 数据 的 时候 如果 发现 无效 队列 里面 有 一个 invalidate 消息 此 时会 立马 强制 根据 那个 invalidate 消息 把 自己 本地 高速缓存 的 数据 设置 为 i 过期 然后 就可以 强制 从 其他 处理器 的 高速缓存 中 加载 最新 的 值 解决 有序性 acquire 屏障 storestore 屏障 会 强制 让 写 数据 的 操作 全部 按照 顺序 写入 写 缓冲器 里 他 不会 让 你 第一个 写到 写 缓冲器 去 第二个 写 直接 修改 高速缓存 resource 屏障 storeload 屏障 他 会 强制 先将 写 缓冲器 里 的 数据 写入 高速缓存 中 接着 读 数据 的 时候 强制 清空 无效 队列 对立 面的 validate 消息 全部 过期 掉 高速缓存 中 的 条目 然后 强制 从 主 内存 里 重新 加载 数据 你 知道 java 内存 模型 中 的 原子 性 有序性 可 见性 是什么 吗 可 见性 是 指 线程 之间 的 可 见性 一个 线程 修改 的 状态 对 另一个 线程 是 可见 的 也 就是 一个 线程 修改 的 结果 另一个 线程 马上 就能 看到 加 load 屏障 执行 refresh 指令 加 store 屏障 执行 flush 操作 原子 性 线程 必须 是 独立 执行 的 没有人 影响 我 的 一 定是 我 自己 执行 成功 之后 别 人才 可以 执行 objectmonitor 对象 加锁 有序性 javagtjavac 静态 编译 gtclassgtjit 动态 编译 gt 机器码 指令 gt 处理器 为了 加速 程序 的 执行 速度 在 一定 规则 的 情况下 发生 指令 重 排序 javacjit 处理器 三个 层次 都会 发生 指令 重排 代码 必须 是 按 顺序 执行 的 不能 重 排序 在 进入 代码 加 acquire 屏障 和 之后 加 release 屏障 保证 代码 块 的 不和 屏障 之外 的 代码 发送 指令 重排 synchronized 关键字 同时 可以 保证 原子 性 可 见性 以及 有序性 的 原子 性 加锁 和 释放 锁 的 机制 objectmonitor 保证 只有 一个 线程 能 进入 同步 块 加锁 和 释放 锁 可 见性 在 monitorenter 之后 load 屏障 monitorexit 之后 加 store 屏障 他 在 同步 代码 块 对 变量 做的 写 操作 都 会在 释放 锁 的 时候 全部 强制执行 flush 操作 在 进入 同步 代码 块 的 时候 对 变量 的 读 操作 全部会 强制执行 refresh 的 操作 内存 屏障 mesi 协议 有序性 同步 开始 加 acquire 屏障 同步 之后 加 release 屏障 通过 内存 屏障 来 保证 同步 代码 内部 的 指令 可以 重排 但是 同步 代码 块 内部 的 指令 和 外面 的 指令 是 不能 重排 的 内存 屏障 volatile 关键字 有 什么 作用 先说 jmm 抽象 原理 gt 硬件 原理 gtmesi 协议 gt 内存 屏障 保证 了 可 见性 load 屏障 refresh 操作 store 屏障 flush 操作 有序性 acquirerelease 屏障 保证 指令 之间 不能 重排 gt 原子 性 objectmonitor 结构 加锁 原理 讲清楚 volatile 关键字 直接 问你 volatile 关键字 的 理解 对 前面 的 一些问题 这个 时候 你 就应该 自己 去 主动 从 内存 模型 开始 讲起 原子 性 可 见性 有序性 的 理解 volatile 关键字 的 原理 volatile 关键字 是 用来 解决 可 见性 和 有序性 大量 用在 开源 项目 主要 用在 有 读 有 写 的 多线程 场景 可 见性 volatile 读 之前 加 load 屏障 写 之后 加 store 屏障 保证 读 之前 mesi 缓存 一致性 协议 执行 refresh 操作 写 之后 执行 flush 操作 有序性 volatile 修饰 的 变量 读写 前面 加 acquire 屏障 和 之后 加 release 屏障 保证 代码 块 的 不和 屏障 之外 的 代码 发送 指令 重排 避免 前后 的 读写 操作 发生 指令 重排 doublecheck 单 例 实践 线程 gt 这个 是 我们 自己 写 的 一行 代码 步骤 以 myobject 类 作为 原型 给他 的 对象 实例 分配 一块 内存空间 objref 就是 指向 了 分配 好 的 内存空间 的 地址 的 引用 指针 objrefallocate myobjectclass 步骤 就是 针对 分配 好 内存空间 的 一个 对象 实例 执行 他 的 构造 函数 对 这个 对象 实例 进行 初始化 的 操作 执行 我们 自己 写 的 构造 函数 里 的 一些 代码 对 各个 实例 变量 赋值 初始化 的 逻辑 objref 步骤 上 两个 步骤 搞定 之后 一个 对象 实例 就 搞定 了 此时 就是 把 objref 指针 指向 的 内存地址 赋值 给 我们 自己 的 引用 类型 的 变量 myobj 就可以 作为 一个 类似 指针 的 概念 指向 了 myobject 对象 实例 的 内存地址 myobjobjref 有 可能 jit 动态 编译 为了 加速 程序 的 执行 速度 因为 步骤 是 在 初始化 一个 对象 实例 这个 步骤 是 有 可能 很 耗时 的 比如说 你 可能会 在里面 执行 一些 网络 的 通信 磁盘 文件 的 读写 都有 可能 jit 动态 编译 指令 重排 为了 加速 程序 的 执行 性能 和 效率 可能会 重排 为 步骤 gt 步骤 gt 步骤 线程 刚刚 执行 完了 步骤 和 步骤 步骤 还没 执行 此时 myobj 已经 不是 null 了 但是 myobject 对象 实例 内部 的 resource 是 null 线程 直接 调用 myobjexecute 方法 此时 内部 会 调用 resourceexecute 方法 但是 此时 resource 是 null 直接 导致 空 指针 如果 加了 volatile 关键字 步骤 是 需要 一起 完成 其他 线程 才 可 使用 防止 指令 重 排序 有 什么 好处 如何 实现 防止 指令 重 排序 的 防止 指令 重 排序 好处 保证 代码 的 有序性 规则 制定 了 在 一些 特殊 情况下 不允许 编译器 指令器 对 你 写 的 代码 进行 指令 重排 必须 保证 你 的 代码 的 有序性 这 句话 要说 然后 找个 几条 happenbefore 原则 说说 就可以 了 happenbefore 原则 程序 次序 规则 一个 线程 内 按照 代码 顺序 书写 在前 面的 操作 先行 发 生于 书写 在后 面的 操作 锁定 规则 一个 unlock 操作 先行 发 生于 后 面对 同一个 锁 的 lock 操作 比如说 在 代码 里 有 先 对 一个 locklock lockunlock locklock volatile 变量 规则 对 一个 volatile 变量 的 写 操作 先行 发 生于 后 面对 这个 volatile 变量 的 读 操作 volatile 变量 写 再 是 读 必须 保证 是 先写 再读 传递 规则 如果 操作 a 先行 发 生于 操作 b 而 操作 b 又 先行 发 生于 操作 c 则 可以 得出 操作 a 先行 发 生于 操作 c 线程 启动 规则 thread 对象 的 start 方法 先行 发生 于此 线程 的 每个 一个 动作 threadstart threadinterrupt 线程 中断 规则 对 线程 interrupt 方法 的 调用 先行 发 生于 被 中断 线程 的 代码 检 测到 中断 事件 的 发生 线程 终结 规则 线程 中所 有的 操作 都 先行 发 生于 线程 的 终止 检测 我们 可以 通过 threadjoin 方法 结束 threadisalive 的 返回值 手段 检 测到 线程 已经 终止 执行 对象 终结 规则 一个 对象 的 初始化 完成 先行 发 生于 他 的 finalize 方法 的 开始 并发 编程 面试 合 辑 word 文档 下载 地址 链接 提 取码 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 分布式 中间件 面试 合 辑 分布式 调用 rpc 篇 什么 是 rpcrpc 即 远程过程调用 是 分布式 系统 常见 的 一种 通信 方法 它 允许 程序 调用 另一个 地址 空间 通常是 共享 网络 的 另一台 机器 上 的 过程 或 函数 而 不用 程序员 显 式 编码 这个 远程 调用 的 细节 除 rpc 之外 常见 的 多 系统 数据 交互 方案 还有 分布式 消息 队列 http 请求 调用 数据库 和 分布式 缓存 等 其中 rpc 和 http 调 用是 没有 经过 中间件 的 它们 是 端 到 端 系统 的 直接 数据 交互 简单 的 说 rpc 就是 从一 台 机器 客户 端上 通过 参数 传递 的 方式 调用 另一台 机器 服务器 上 的 一个 函数 或 方法 可以 统 称为 服务 并 得到 返回 的 结果 rpc 会 隐藏 底层 的 通讯 细节 不需要 直接 处理 socket 通讯 或 http 通讯 客户端 发起 请求 服务器 返回 响应 类似于 http 的 工作方式 rpc 在 使用 形式上 像 调用 本地 函数 或 方法 一样 去 调用 远程 的 函数 或 方法 为什么 我们 要用 rpcrpc 的 主要 目标 是 让 构建 分布式 应用 更 容易 在 提供 强大 的 远程 调用 能力 时 不 损失 本地 调用 的 语义 简洁性 为 实现 该 目标 rpc 框架 需 提供 一种 透明 调用 机制 让 使用者 不必 显 式 的 区分 本地 调用 和 远程 调用 rpc 需要 解决 的 三个 问题 rpc 要 达到 的 目标 远程 调 用时 要 能够 像 本地 调用 一样 方便 让 调用者 感知 不到 远程 调用 的 逻辑 callid 映射 我们 怎么 告诉 远程 机器 我们 要 调用 哪个 函数 呢 在 本地 调用 中 函数 体 是 直接 通过 函数 指针 来 指定 的 我们 调用 具体 函数 编译器 就 自动 帮 我们 调 用它 相应 的 函数 指针 但是在 远程 调用 中 是 无法 调用 函数 指针 的 因为 两个 进程 的 地址 空间 是 完全 不一样 所以在 rpc 中所 有的 函数 都必须 有 自己 的 一个 id 这个 id 在所 有 进程 中 都是 唯一 确定 的 客户端 在做 远程过程调用 时 必须 附上 这个 id 然后 我们 还需 要在 客户端 和 服务端 分别 维护 一个 函数 ltgtcallid 的 对应 表 两者 的 表 不一定 需要 完全相同 但 相同 的 函数 对应 的 callid 必须 相 同当 客户端 需要 进行 远程 调 用时 它就 查 一下 这个 表 找出 相应 的 callid 然后 把 它 传给 服务端 服务端 也 通过 查表 来 确定 客户端 需要 调用 的 函数 然后 执行 相应 函数 的 代码 序列化 和 反 序列化 客户端 怎么 把 参 数值 传给 远程 的 函数 呢 在 本地 调用 中 我们 只需 要把 参数 压到 栈 里 然后 让 函数 自己 去 栈 里 读 就行 但是在 远程过程调用 时 客户端 跟 服务端 是 不同 的 进程 不能通过 内存 来 传递 参数 甚至 有时候 客户端 和 服务端 使用 的 都不是 同一种 语言 比如 服务端 用 c 客户端 用 java 或者 python 这时候 就需要 客户端 把 参数 先 转成 一个字 节流 传给 服务端 后 再把 字节 流 转成 自己 能 读取 的 格式 这个 过程 叫 序列化 和 反 序列化 同理 从 服务端 返回 的 值 也 需要 序列化 反 序列化 的 过程 网络 传输 远程 调用 往往是 基于 网络 的 客户端 和 服务端 是 通过 网络连接 的 所有 的 数据 都 需要 通过 网络 传输 因此 就需要 有 一个 网络 传输 层 网络 传输 层 需 要把 callid 和 序列化 后 的 参数 字节 流 传给 服务端 然后 再把 序列化 后 的 调用 结果 传回 客户端 只 要能 完成 这两者 的 都可以 作为 传输 层 使用 因此 它所 使用 的 协议 其实是 不限 的 能 完成 传输 就行 尽管 大部分 rpc 框架 都 使用 tcp 协议 但 其实 udp 也 可以 而 grpc 干脆 就 用了 httpjava 的 netty 也 属于 这 层 的 东西 实现 高 可用 rpc 框架 需要 考虑到 的 问题 既然 系统 采用 分布式 架构 那一个 服务 势必 会有 多个 实例 要 解决 如何 获取 实例 的 问题 所以 需要 一个 服务 注册 中心 比 如在 dubbo 中就 可以 使用 zookeeper 作为 注册 中心 在 调 用时 从 zookeeper 获取 服务 的 实例 列表 再从 中 选择 一个 进行 调用 如何 选择 实例 呢 就要 考虑 负载 均衡 例如 dubbo 提供 了 种 负载 均衡 策略 如果 每次 都去 注册 中心 查询 列表 效率 很低 那么 就要 加 缓存 客户端 总不能 每次 调 用完 都 等着 服务端 返回 数据 所以 就要 支持 异步 调用 服务端 的 接 接口 修 改了 老 的 接口 还有 人 在用 这就 需要 版本 控制 服务端 总不能 每次 接到 请求 都 马上 启动 一个 线程 去 处理 于是 就需要 线程 池 理论 结构 模型 rpc 服务端 通过 rpcserver 去 导出 export 远程 接口 方法 而 客户端 通过 rpcclient 去 导入 import 远程 接口 方法 客户端 像 调用 本地 方法 一样 去 调用 远程 接口 方法 rpc 框架 提供 接口 的 代理 实现 实际 的 调用 将 委托 给 代理 rpcproxy 代理 封装 调用 信息 并将 调用 转 交给 rpcinvoker 去 实际 执 行在 客户端 的 rpcinvoker 通过 连接器 rpcconnector 去 维持 与 服务端 的 通道 rpcchannel 并 使用 rpcprotocol 执行 协议 编码 encode 并将 编码 后 的 请求 消息 通过 通道 发送给 服务端 rpc 服务端 接收器 rpcacceptor 接收 客户端 的 调用 请求 同样 使用 rpcprotocol 执行 协议 解码 decode 解码 后 的 调用 信息 传 递给 rpcprocessor 去 控制 处理 调用 过程 最后 再 委托 调用 给 rpcinvoker 去 实际 执行 并 返回 调用 结果 分布式 限流 zookeeper 篇 zookeeper 是什么 zookeeper 是 一个 分布式 的 开放源码 的 分布式 应用程序 协调 服务 是 google 的 chubby 一个 开源 的 实现 它是 集群 的 管理者 监视 着 集群 中 各个 节点 的 状态 根据 节点 提交 的 反馈 进行 下一步 合理 操作 最 终将 简单 易用 的 接口 和 性能 高效 功能 稳定 的 系统 提供给 用户 客户端 的 读 请求 可以 被 集群 中 的 任意 一台 机器 处理 如果 读 请求 在 节点 上 注册 了 监听器 这个 监听器 也是 由 所 连接 的 zookeeper 机器 来 处理 对于 写 请求 这些 请求 会 同时 发给 其他 zookeeper 机器 并且 达成 一致 后 请求 才会 返回 成功 因此 随着 zookeeper 的 集群 机器 增多 读 请求 的 吞吐 会 提高 但是 写 请求 的 吞吐 会 下降 有序性 是 zookeeper 中 非常重要 的 一个 特性 所有 的 更新 都是 全局 有序 的 每个 更新 都有 一个 唯一 的 时间 戳 这个 时间 戳 称为 zxid 而 读 请求 只会 相对于 更新 有序 也 就是 读 请求 的 返回 结果 中会 带有 这个 zookeeper 最新 的 zxidzookeeper 提供 了 什么 文件 系统 通知 机制 zookeeper 文件 系统 zookeeper 提供 一个 多 层级 的 节点 命名 空间 节点 称为 znode 与 文件 系统 不同 的 是 这些 节点 都可以 设置 关联 的 数据 而 文件 系统 中 只有 文件 节点 可以 存放 数据 而 目录 节点 不行 zookeeper 为了 保证 高 吞吐 和 低 延迟 在 内存 中 维护 了 这个 树状 的 目录 结构 这种 特性 使得 zookeeper 不能 用于 存放 大量 的 数据 每个 节点 的 存放 数据 上 限为 m 说一说 四种 类型 的 持久 化 目录 节点 客户端 与 zookeeper 断开 连接 后 该 节点 依旧 存在 持久 化 顺序 编号 目录 节点 客户端 与 zookeeper 断开 连接 后 该 节点 依旧 存在 只是 zookeeper 给 该 节点 名称 进行 顺序 编号 ephemeral 临时 目录 节点 客户端 与 zookeeper 断开 连接 后 该 节点 被 删除 临时 顺序 编号 目录 节点 客户端 与 zookeeper 断开 连接 后 该 节点 被 删除 只是 zookeeper 给 该 节点 名称 进行 顺序 编号 zookeeper 通知 机制 client 端 会对 某个 znode 建立 一个 watcher 事件 当 该 znode 发生变化 时 这些 client 会 收到 zk 的 通知 然后 client 可以 根据 znode 变化 来 做出 业务 上 的 改变 等 zookeeper 做了 什么 命名 服务 配置管理 集群 管理 分布式 锁 队列 管理 zk 的 命名 服务 文件 系统 命名 服务 是 指 通过 指定 的 名字 来 获取 资源 或者 服务 的 地址 利用 zk 创建 一个 全局 的 路径 即是 唯一 的 路径 这个 路径 就可以 作为 一个 名字 指向 集群 中 的 集群 提供 的 服务 的 地址 或者 一个 远程 的 对象 等等 zk 的 配置管理 文件 系统 通知 机制 程序 分布式 的 部署 在 不同 的 机器 上将 程序 的 配置 信息 放在 zk 的 znode 下 当 有 配置 发生 改变 时 也 就是 znode 发生变化 时 可以 通过 改变 zk 中 某个 目录 节点 的 内容 利用 watcher 通知 给 各个 客户端 从而 更改 配置 zookeeper 集群 管理 文件 系统 通知 机制 所谓 集群 管理 不外乎 两点 是否 有 机器 退出 和加 入 选举 master 对于 第一点 所有 机器 约 定在 父 目 录下 创建 临时 目录 节点 然后 监听 父 目录 节点 的 子 节点 变化 消息 一旦 有 机器 挂掉 该 机器 与 zookeeper 的 连接 断开 其所 创建 的 临时 目录 节点 被 删除 所有 其他 机器 都 收到 通知 某个 兄弟 目录 被 删除 于是 所有人 都 知道 它 上船 了 新机器 加入 也是 类似 所有 机器 收到 通知 新 兄弟 目录 加入 highcount 又有 了 对于 第二 点 我们 稍微 改变 一下 所有 机器 创建 临时 顺序 编号 目录 节点 每次 选取 编号 最小 的 机器 作为 master 就好 zookeeper 分布式 锁 文件 系统 通知 机制 有 了 zookeeper 的 一致性 文件 系统 锁 的 问题 变得 容易 锁 服务 可以 分为 两类 一个是 保持 独占 另 一个是 控制 时序 对于 第一类 我们 将 zookeeper 上 的 一个 znode 看作 是 一把 锁 通过 createznode 的 方式 来 实现 所有 客户端 都去 创建 distributelock 节点 最终 成功 创建 的 那个 客户端 也 即 拥有 了 这把 锁 用完 删 除掉 自己 创建 的 distributelock 节点 就 释放出 锁 对于 第二类 distributelock 已经 预先 存在 所有 客户端 在 它 下面 创建 临时 顺序 编号 目录 节点 和 选 master 一样 编号 最小 的 获得 锁 用完 删除 依次 方便 获取 分布式 锁 的 流程 在 获取 分布式 锁 的 时候 在 locker 节点 下 创建 临时 顺序 节点 释放 锁 的 时候 删除 该 临时 节点 客户端 调用 createnode 方法 在 locker 下 创建 临时 顺序 节点 然后 调用 getchildren locker 来 获取 locker 下面 的 所有 子 节点 注意 此时 不用 设置 任何 watcher 客户端 获 取到 所有 的 子 节点 path 之后 如果 发现 自己 创建 的 节点 在所 有 创建 的 子 节点 序号 最小 那么 就 认为 该 客户端 获取 到了 锁 如果 发现 自己 创建 的 节点 并非 locker 所有 子 节点 中 最小 的 说明 自己 还没有 获 取到 锁 此时 客户端 需要 找到 比 自己 小 的 那个 节点 然后 对 其 调用 exist 方法 同时 对 其 注册 事件 监听器 之后 让 这个 被 关注 的 节点 删除 则 客户端 的 watcher 会 收到 相应 通知 此时 再次 判断 自己 创建 的 节点 是否 是 locker 子 节 点中 序号 最小 的 如果是 则 获取 到了 锁 如果 不是 则 重复 以上 步骤 继续 获 取到 比 自己 小 的 一个 节点 并 注册 监听 当前 这个 过程中 还需要 许多 的 逻辑 判断 代码 的 实现 主 要是 基于 互斥 锁 获取 分布式 锁 的 重点 逻辑 在于 实现 了 基于 zookeeper 实现 分布式 锁 的 细节 zookeeper 队列 管理 文件 系统 通知 机制 两种 类型 的 队列 同步 队 列当 一个 队列 的 成员 都 聚齐 时 这个 队列 才 可用 否则 一直 等待 所有 成员 到达 队列 按照 fifo 方式 进行 入队 和 出 队 操作 第一类 在 约定 目 录下 创建 临时 目录 节点 监听 节点 数目 是否 是 我们 要求 的 数目 第二类 和 分布式 锁 服务 中 的 控制 时序 场景 基本原理 一致 入列 有 编号 出列 按 编号 在 特定 的 目 录下 创建 节点 创建 成功 时 watcher 通知 等待 的 队列 队列 删除 序列号 最小 的 节点 用以 消费 此 场景 下 zookeeper 的 znode 用于 消息 存储 znode 存储 的 数据 就是 消息 队列 中 的 消息 内容 sequential 序列号 就是 消息 的 编号 按序 取出 即可 由于 创建 的 节点 是 持久 化 的 所以 不必 担心 队列 消息 的 丢失 问题 zookeeper 数据 复制 zookeeper 作为 一个 集群 提供 一致 的 数据服务 自然 它要 在所 有 机器 间 做 数据 复制 数据 复制 的 好处 容错 一个 节点 出错 不致于 让 整个 系统 停止工作 别的 节点 可以 接 管它 的 工作 提高 系统 的 扩展 能力 把 负载 分布 到 多个 节点 上 或者 增加 节 点来 提高 系统 的 负载 能力 提高 性 能让 客户端 本地 访问 就近 的 节点 提高 用户 访问 速度 从 客户端 读写访问 的 透明度 来看 数据 复制 集群 系 统分 下面 两种 写 主 writemaster 对 数据 的 修改 提 交给 指定 的 节点 读 无 此 限制 可以 读取 任何 一个 节点 这种 情况下 客户端 需要 对读 与 写 进行 区别 俗称 读写 分离 写 任意 writeany 对 数据 的 修改 可 提 交给 任意 的 节点 跟读 一样 这种 情况下 客户端 对 集群 节点 的 角色 与 变化 透明 对 zookeeper 来 说它 采用 的 方式 是 写 任意 通过 增加 机器 它 的 读 吞吐能力 和 响应 能力 扩展性 非常好 而 写 随着 机器 的 增多 吞吐能力 肯定 下降 这 也是 它 建立 observer 的 原因 而 响应 能力 则 取决于 具体 实现 方式 是 延迟 复制 保持 最终 一致性 还是 立即 复制 快速 响应 zookeeper 工作 原理 zookeeper 的 核心 是 原子 广播 这个 机制 保证 了 各个 server 之间 的 同步 实现 这个 机制 的 协议 叫做 zab 协议 zab 协议 有 两种 模式 它们 分 别是 恢复 模式 选 主 和 广播 模式 同步 当 服务 启动 或者 在 领导者 崩溃 后 zab 就进 入了 恢复 模式 当 领导者 被选 举出来 且 大多数 server 完 成了 和 leader 的 状态 同步 以后 恢复 模式 就 结束 了 状态 同步 保证 了 leader 和 server 具有 相同 的 系统 状态 zookeeper 是 如何 保证 事务 的 顺序 一致性 的 zookeeper 采 用了 递增 的 事务 id 来 标识 所有 的 proposal 提议 都 在被 提出 的 时候 加 上了 zxidzxid 实际上 是 一 个位 的 数字 高位 是 epoch 时期 纪元 世新 时代 用来 标识 leader 是否 发生 改变 如果有 新 的 leader 产生 出来 epoch 会 自 增 低位 用来 递增 计数 当 新 产生 proposal 的 时候 会 依据 数据库 的 两 阶段 过程 首 先会 向 其他 的 server 发出 事务 执行 请求 如果 超过 半数 的 机器 都能 执行 并且 能够 成功 那么 就会 开始 执行 zookeeper 下 server 工作 状态 每个 server 在 工作 过程 中有 三种 状态 looking 当前 server 不知道 leader 是 谁 正在 搜寻 leading 当前 server 即为 选举 出来 的 已经 选举 出来 当前 server 与 之 同步 zookeeper 是 如何 选取 主 leader 的当 leader 崩溃 或者 leader 失去 大多数 的 follower 这时 zk 进入 恢复 模式 恢复 模式 需要 重新 选 举出 一个 新 的 leader 让 所有 的 server 都 恢复 到 一个 正确 的 状态 zk 的 选举 算法 有 两种 一种 是 基于 basicpaxos 实现 的 另外 一种 是 基于 fastpaxos 算法 实现 的 系统 默认 的 选举 算法 为 选 主流 流程 basicpaxos 选举 线程 由 当前 server 发起 选举 的 线程 担任 其主要 功能 是 对 投票 结果 进行 统计 并 选出 推荐 的 server 选举 线程 首 先向 所有 server 发起 一次 询问 包括 自己 选举 线程 收到 回复 后 验证 是否 是 自己 发起 的 询问 验证 zxid 是否 一致 然后 获取 对方 的 id myid 并 存储 到 当前 询问 对象 列表 中 最后 获取 对方 提议 的 leader 相关 信息 idzxid 并将 这些 信息 存储 到 当次 选举 的 投票 记录 表 中 收到 所有 server 回复 以后 就 计算出 zxid 最大 的 那个 server 并将 这个 server 相关 信息 设置成 下一 次要 投票 的 server 线程 将 当前 zxid 最大 的 server 设置 为 当前 server 要 推荐 的 leader 如果 此时 获胜 的 server 获得 n 的 server 票数 设置 当前 推荐 的 leader 为 获胜 的 server 将 根据 获胜 的 server 相关 信息 设置 自己 的 状态 否则 继续 这个 过程 直到 leader 被选 举出来 通过 流程 分析 我们 可以 得出 要使 leader 获得 多数 server 的 支持 则 server 总数 必须 是 奇数 n 且 存活 的 server 的 数目 不得 少于 n 每个 server 启动 后 都会 重复 以上 流程 在 恢复 模式 下 如果是 刚从 崩溃 状态 恢复 的 或者 刚 启动 的 server 还会 从 磁盘 快照 中 恢复 数据 和 会话 信息 zk 会 记录 事务 日志 并 定期 进行 快照 方 便在 恢复 时 进行 状态 恢复 zookeeper 选 主流程 basicpaxos fastpaxos 流程 是 在 选举 过程中 某 server 首 先向 所有 server 提议 自己 要 成为 leader 当 其它 server 收到 提议 以后 解决 epoch 和 zxid 的 冲突 并 接受 对方 的 提议 然 后向 对方 发送 接受 提议 完成 的 消息 重复 这个 流程 最后 一 定能 选 举出 leaderzookeeper 同步 流程 选 完 leader 以后 zk 就 进入状态 同步 过程 leader 等待 server 连接 follower 连接 leader 将 最大 的 zxid 发送给 leaderleader 根据 follower 的 zxid 确定 同步 点 完成 同步 后 通知 follower 已经成为 uptodate 状态 分布式 通知 和协调 实现 方式 对于 系统 调度 来说 操作 人员 发送 通知 实际 是 通过 控制台 改变 某个 节点 的 状态 然后 zk 将 这些 变化 发送给 注册 了 这个 节点 的 watcher 的 所有 客户端 对于 执行 情况汇报 每个 工作 进程 都在 某个 目 录下 创建 一个 临时 节点 并 携带 工作 的 进度 数据 这样 汇总 的 进程 可以 监控 目录 子 节点 的 变化 获得 工作进度 的 实时 的 全局 情况 机器 中 为什么 会有 leader 在 分布式 环境 中 有些 业务 逻辑 只需要 集群 中 的 某一 台 机器 进行 执行 其他 的 机器 可以 共享 这个 结果 这样 可以 大大 减少 重复 计算 提高 性能 于是 就需要 进行 leader 选举 zk 节点 宕机 如何 处理 zookeeper 本身 也是 集群 推荐 配置 不少于 个 服务器 zookeeper 自身 也要 保证 当 一个 节点 宕 机时 其他 节点 会 继续 提供 服务 如果是 一个 follower 宕机 还有 台 服务器 提供 访问 因为 zookeeper 上 的 数据 是 有 多个 副本 的 数据 并不会 丢失 如果是 一个 leader 宕机 zookeeper 会选 举 出新 的 leaderzk 集群 的 机制 是 只要 超过 半数 的 节点 正常 集群 就能 正常 提供 服务 只有 在 zk 节点 挂得 太 多只 剩 一半 或 不到 一半 节点 能 工作 集群 才 失效 所以 个 节点 的 cluster 可以 挂 掉个 节点 leader 可以 得到 票 gt 个 节点 的 cluster 就不能 挂掉 任何 个 节 点了 leader 可以 得到 票 lt zookeeper 负载 均衡 和 nginx 负载 均衡 区别 zk 的 负载 均衡 是 可以 调控 nginx 只是 能 调 权重 其他 需要 可控 的 都 需要 自己 写 插件 但是 nginx 的 吞吐量 比 zk 大 很多 应该说 按 业务 选择 用 哪种 方式 zookeeperwatch 机制 watch 机制 官方 声明 一个 watch 事件 是 一个 一次性 的 触发器 当 被 设置 了 watch 的 数据 发 生了 改变 的 时候 则 服务器 将 这个 改变 发送给 设置 了 watch 的 客户端 以便 通知 它们 zookeeper 机制 的 特点 一次性 触发 数据 发生 改变 时 一个 watcherevent 会被 发送到 client 但是 client 只会 收到 一次 这样 的 信息 watcherevent 异步 发送 watcher 的 通知 事件 从 server 发送到 client 是 异步 的 这就 存在 一个 问题 不同 的 客户端 和 服务器 之间 通过 socket 进行 通信 由于 网络 延迟 或 其他 因素 导致 客户端 在 不通 的 时刻 监 听到 事件 由于 zookeeper 本身 提供 了 即 客户端 监听 事件 后 才会 感知 它所 监视 znode 发 生了 变化 所以 我们 使用 zookeeper 不能 期望 能够 监控 到 节点 每次 的 变化 zookeeper 只能 保证 最终 的 一致性 而 无法 保证 强 一致性 数据 监视 zookeeper 有 数据 监视 和 子 数据 监视 getdata andexists 设置 数据 监视 getchildren 设置 了 子 节点 监视 注册 触发 会 触发 znode 上 设置 的 datawatch 如果 set 成功 的话 一个 成功 的 create 操作 会 触发 被 创建 的 znode 上 的 数据 watch 以及 其父 节点 上 的 childwatch 而 一个 成功 的 delete 操作 将会 同时 触发 一个 znode 的 datawatch 和 childwatch 因为 这样 就 没有 子 节 点了 同时 也 会 触发 其父 节点 的 childwatch 当 一个 客户端 连 接到 一个 新 的 服务器 上 时 watch 将 会被 以 任意 会话 事件 触发 当 与 一个 服务器 失去 连接 的 时候 是 无法 接 收到 watch 的 而 当 client 重新 连接 时 如果 需要的话 所有 先前 注册 过 的 watch 都 会被 重新 注册 通常 这是 完全 透明 的 只有 在 一个 特殊 情况下 watch 可能会 丢失 对于 一个 未 创建 的 znode 的 existwatch 如果在 客户端 断开 连接 期间 被 创 建了 并且 随后 在 客户端 连 接上 之前 又 删 除了 这种 情况下 这个 watch 事件 可能 会被 丢失 watch 是 轻量级 的 其实 就是 本地 jvm 的 callback 服务器端 只是 存 了 是否 有 设置 了 watcher 的 布尔 类型 分布式 负载 均衡 nginx 篇 请 解释一下 什么 是 nginxnginx 是 一个 web 服务器 和 反向 代理服务器 用于 和 imap 协 议请 列举 nginx 的 一些 特性 nginx 服务器 的 特性 包括 反向 代理 l 负载 均衡器 嵌入式 perl 解释 器 动态 二进制 升级 可 用于 重新 编写 url 具有 非常好 的 pcre 支持 请 解释 nginx 如何 处理 http 请求 nginx 使用 反应器 模式 主 事件 循环 等待 操作系统 发出 准备 事件 的 信号 这样 数据 就可以 从 套接 字 读取 在 该 实例 中 读 取到 缓冲区 并 进行 处理 单个 线程 可以 提供 数万 个 并发 连 接在 nginx 中 如何 使用 未定义 的 服务器 名称 来 阻止 处理 请求 只 需将 请求 删除 的 服务器 就可以 定义 为 这里 服务器 名 被 保留 为 一个 空 字符串 它 将在 没有 主 机头 字段 的 情况下 匹配 请求 而 一个 特殊 的 nginx 的 非标准 代码 被 返回 从而 终止 连接 使用 反向 代理服务器 的 优点 是什么 反向 代理服务器 可以 隐藏 源 服务器 的 存在 和 特征 它 充当 互联网 云和 web 服务器 之间 的 中间层 这 对于 安全 方面 来 说是 很好 的 特别是 当 您 使用 web 托管 服务 时 请 列举 nginx 服务器 的 最佳 用途 nginx 服务器 的 最佳 用法 是 在 网络 上 部署 动态 http 内容 使用 scgiwsgi 应用程序 服务器 用于 脚本 的 fastcgi 处理 程序 它还 可以 作为 负载 均衡器 请 解释 nginx 服务器 上 的 master 和 worker 进程 分别 是什么 master 进程 读取 及 评估 配置 和 维持 worker 进程 处理 请求 请 解释 你 如何 通过 不同于 的 端口 开启 nginx 为了 通过 一个 不同 的 端口 开启 nginx 你 必须 进入 如果 这是 默认 文件 那么 你 必须 打开 名为 default 的 文件 编辑 文件 并 放置 在你 想要 的 端口 请 解释 是否 有 可 能将 nginx 的 错误 替 换为 错误 错误 网关 服务器 超载 有 可能 但是 可以 确保 被 设置 为 on 并 使用 错误 页面 指令 在 nginx 中 解释 如 何在 url 中 保留 双 斜线 要在 url 中 保留 双 斜线 就必须 使用 mergeslashesoff 语法 默认值 mergeslasheson 环境 httpserver 请 解释 的 作用 是什么 用于 定义 可通过 fastcgi 传递 proxy 传递 uwsgi 传递 memcached 传递 和 scgi 传递 指令 来 引用 的 服务器 组 请 解释 什么 是 ck 问题 ck 问题是 指 无法 同时 处理 大量 客户端 的 网络 套接 字 请 陈述 stubstatus 和 subfilter 指令 的 作用 是什么 stubstatus 指令 该 指令 用于 了解 nginx 当前 状态 的 当前 状态 如 当前 的 活动 连接 接受 和 处理 当前 读写 等待 连接 的 总数 subfilter 指令 它 用于 搜索 和 替换 响应 中 的 内容 并 快速 修复 陈旧 的 数据 解释 nginx 是否 支持 将 请求 压缩 到 上游 您可 以 使用 nginx 模块 gunzip 将 请求 压缩 到 上游 gunzip 模块 是 一个 过滤器 它可 以对 不支持 gzip 编码方法 的 客户机 或 服务器 使用 内容 编码 gzip 来 解压缩 响应 解释 如 何在 nginx 中 获得 当前 的 时间 要 获得 nginx 的 当前 时间 必须 使用 ssi 模块 dategmt 和 datelocal 的 变量 用 nginx 服务器 解释 s 的 目的 是什么 用于 运行 nginxs 参数 的 可执行文件 解释 如 何在 nginx 服务器 上 添加 模块 在 编译 过程中 必须 选择 nginx 模块 因为 nginx 不支持 模块 的 运行 时间 选择 分布式 消息 通讯 rabbitmq 篇 rabbitmq 中 的 broker 是 指 什么 cluster 又是 指 什么 broker 是 指 一个 或 多个 erlangnode 的 逻辑 分组 且 node 上 运行 着 rabbitmq 应用程序 cluster 是 在 broker 的 基础 之上 增加了 node 之间 共享 元 数据 的 约束 什么 是 元 数据 元 数据 分为 哪些 类型 包括 哪些 内容 与 cluster 相关 的 元 数据 据有 哪些 元 数据 是 如何 保存 的 元 数据 在 cluster 中 是 如何 分布 的 在 非 cluster 模式 下元 数据 主要 分为 queue 元 数据 queue 名字 和 属性 等 exchange 元 数据 exchange 名字 类型 和 属性 等 binding 元 数据 存放 路由 关系 的 查找 表 vhost 元 数据 vhost 范围内 针对 前 三者 的 名字 空间 约束 和 安全 属性 设置 在 cluster 模式 下 还 包括 cluster 中 node 位置 信息 和 node 关系 信息 元 数据 按照 erlangnode 的 类型 确 定是 仅 保存 于 ram 中 还是 同时 保 存在 ram 和 disk 上元 数据 在 cluster 中 是 全 node 分布 的 ramnode 和 disknode 的 区别 ramnode 仅 将 fabric 即 queueexchange 和 binding 等 rabbitmq 基础 构件 相 关元 数据 保 存到 内存 中 但 disknode 会在 内存 和 磁盘 中 均 进行 存储 ramnode 上 唯一 会 存储 到 磁 盘上 的 元 数据 是 cluster 中 使用 的 disknode 的 地址 要求 在 rabbitmqcluster 中 至少 存在 一个 上 的 一个 queue 中 存放 的 message 是否 有 数量 限制 可以 认为是 无限制 因为 限制 取决于 机器 的 内存 但是 消息 过 多会 导致 处理 效率 的 下降 vhost 是什么 起 什么 作用 vhost 可以 理解为 虚拟 broker 即 其 内部 均 含有 独立 的 queueexchange 和 binding 等 但 最最 重要 的 是 其 拥有 独立 的 权限 系统 可以 做到 vhost 范围 的 用户 控制 当然 从 rabbitmq 的 全局 角度 vhost 可以 作为 不同 权限 隔离 的 手段 一个 典型 的 例子 就是 不同 的 应用 可以 跑 在 不同 的 vhost 中 在 单 node 系统 和 多 node 构成 的 cluster 系统 中 声明 queueexchange 以及 进行 binding 会有 什么 不同 当你 在 单 node 上 声明 queue 时 只要 该 node 上相 关元 数据 进行了 变更 你 就会 得到 queuedeclareok 回应 而在 cluster 上 声明 queue 则要求 cluster 上 的 全部 node 都要 进行 元 数据 成功 更新 才会 得到 queuedeclareok 回应 另外 若 node 类型 为 ramnode 则 变更 的 数据 仅 保存 在 内存 中 若 类型 为 disknode 则 还要 变更 保 存在 磁 盘上 的 数据 客户端 连 接到 cluster 中 的 任意 node 上 是否 都能 正常 工作 是的 客户端 感觉 不到 有 何 不同 若 cluster 中 拥有 某个 queue 的 ownernode 失效 了 且 该 queue 被 声明 具有 durable 属性 是否 能够 成功 从 其他 node 上 重新 声明 该 queue 不能 在 这种 情况下 将 得到 notfound 错误 只能 等 queue 所属 的 node 恢复 后 才能 使用 该 queue 但 若 该 queue 本身 不具有 durable 属性 则可 在其 他 node 上 重新 声明 cluster 中 node 的 失效 会对 consumer 产生 什么 影响 若是 在 cluster 中 创 建了 mirroredqueue 这时 node 失效 会对 consumer 产生 什么 影响 若是 consumer 所 连接 的 那个 node 失效 无论 该 node 是否 为 consumer 所 订阅 queue 的 ownernode 则 consumer 会在 发现 tcp 连接 断开 时 按 标准 行为 执行 重 连 逻辑 并 根据 assumenothing 原则 重建 相应 的 fabric 即可 若是 失效 的 node 为 consumer 订阅 queue 的 ownernode 则 consumer 只能 通过 机制 来 检测 与 该 queue 订阅 关系 的 终止 否则 会 出现 傻等 却没有 任何 消息 来到 的 问题 能够 在 地 理上 分开 的 不同 数据中心 使用 rabbitmqcluster 么 不能 第一 你 无法控制 所 创建 的 queue 实际 分布 在 cluster 里 的 哪个 node 上 一般 使用 haproxycluster 模型 时 都是 这样 这 可能会 导致 各种 跨 地域 访问 时 的 常见问题 第二 erlang 的 otp 通信 框架 对 延迟 的 容忍度 有限 这 可能会 触发 各种 超时 导致 业务 疲于 处理 第三 在 广域 网上 的 连接 失效 问题 将 导致 经典 的 脑 裂 问题 而 rabbitmq 目前 无法 处理 该 问题 主 要是 说 mnesia 为什么 heavyrpc 的 使用 场景 下不 建议 采用 是 指在 业务 逻辑 中 高频 调用 rabbitmq 提供 的 rpc 机制 导致 不断 创建 销毁 replyqueue 进而 造成 disknode 的 性能 问题 因为 会 针对 元 数据 不断 写盘 所以在 使用 rpc 机制 时 需要 考虑 自身 的 业务 场景 向 不存在 的 exchange 发 publish 消息 会 发生 什么 向 不存在 的 queue 执行 consume 动作 会 发生 什么 都会 收到 channelclose 信 令 告 之 不存在 内含 原因 notfound routingkey 和 bindingkey 的 最大 长度 是多少 字节 rabbitmq 允许 发送 的 message 最大 可达 多大 根据 amqp 协议 规定 消息 体 的 大小 由 bit 的 值 来 指定 所以 你 就可以 知道 到底 能 发 多大 的 数据 了 什么 情况下 producer 不 主动 创建 queue 是 安全 的 message 是 允许 丢失 的 实现 了 针对 未处理 消息 的 republish 功能 例如 采用 机制 deadletterqueue 的 用途 当 消息 被 rabbitmqserver 投递 到 consumer 后 但 consumer 却 通过 basicreject 进行了 拒绝 时 同时 设置 requeuefalse 那么 该 消息 会被 放入 deadletterqueue 中 该 queue 可 用于 排查 message 被 reject 或 undeliver 的 原因 为什么 说 保证 message 被 可靠 持久 化 的 条件 是 queue 和 exchange 具有 durable 属性 同时 message 具有 persistent 属性 才 行 binding 关系 可以 表示 为 从 文档 中 我们 知道 若 要求 投递 的 message 能够 不 丢失 要求 message 本身 设置 persistent 属性 要求 exchange 和 queue 都 设置 durable 属性 其实 这 问题 可以 这么 想 若 exchange 或 queue 未 设置 durable 属性 则 在其 crash 之后 就会 无法 恢复 那么 即使 message 设置 了 persistent 属性 仍然 存在 message 虽然能 恢复 但却 无处 容身 的 问题 同理 若 message 本身 未 设置 persistent 属性 则 message 的 持久 化 更 无从谈起 什么 情况下 会 出现 blackholed 问题 blackholed 问题是 指向 exchange 投 递了 message 而 由于 各种 原因 导致 该 message 丢失 但 发送者 却不 知道 可 导致 blackholed 的 情况 向 未 绑定 queue 的 exchange 发送 messageexchange 以 bindingkeykeya 绑定 了 queuequeuea 但 向 该 exchange 发送 message 使用 的 routingkey 却是 keyb 如何 防止 出现 blackholed 问题 没有 特别 好 的 办法 只 能在 具体 实践中 通过 各种方式 保证 相关 fabric 的 存在 另外 如果在 执行 basicpublish 时 设置 mandatorytrue 则在 遇到 可能 出现 blackholed 情况 时 服务器 会 通过 返回 basicreturn 告 之 当前 message 无法 被 正确 投递 内含 原因 noroute 机制 用于 什么 场景 用于 保证 当 镜像 queue 中 master 挂掉 时 连 接到 slave 上 的 consumer 可以 收到 自身 consume 被 取消 的 通知 进而 可以 重新 执行 consume 动作 从新 选出 的 master 出 获得 消息 若不 采用 该 机制 连 接到 slave 上 的 consumer 将 不会 感知 master 挂掉 这个 事情 导致 后续 无法 再 收到 新 master 广播 出来 的 message 另外 因为 在 镜像 queue 模式 下 存在 将 message 进行 requeue 的 可能 所以 实现 consumer 的 逻辑 时 需要 能够 正确处理 出现 重复 message 的 情况 basicreject 的 用法 是什么 该 信 令 可 用于 consumer 对 收到 的 message 进行 reject 若在 该 信 令 中 设置 requeuetrue 则 当 rabbitmqserver 收到 该 拒绝 信 令 后会 将该 message 重新 发送到 下一个 处于 consume 状态 的 consumer 处 理论上 仍可 能 将该 消息 发送给 当前 consumer 若 设置 requeuefalse 则 rabbitmqserver 在 收到 拒绝 信 令 后 将 直接 将该 message 从 queue 中 移除 另外 一种 移除 queue 中 message 的 小 技巧 是 consumer 回复 basicack 但 不对 获 取到 的 message 做 任何 处理 而 basicnack 是 对 basicreject 的 扩展 以 支持 一次 拒绝 多条 message 的 能力 为什么 不应该 对 所有 的 message 都 使用 持久 化 机制 首先 必然 导致 性能 的 下降 因为 写 磁盘 比 写 ram 慢 的 多 message 的 吞吐量 可能有 倍 的 差距 其次 message 的 持久 化 机制 用在 rabbitmq 的 内置 cluster 方案 时会 出现 坑 爹 问题 矛盾 点 在于 若 message 设置 了 persistent 属性 但 queue 未 设置 durable 属性 那么 当 该 queue 的 ownernode 出现异常 后 在 未 重建 该 queue 前 发往 该 queue 的 message 将被 blackholed 若 message 设置 了 persistent 属性 同时 queue 也 设置 了 durable 属性 那么 当 queue 的 ownernode 异常 且 无法 重启 的 情况下 则 该 queue 无法 在其 他 node 上 重建 只能 等待 其 ownernode 重启 后 才能 恢复 该 queue 的 使用 而在 这段 时间内 发送给 该 queue 的 message 将被 blackholed 所以 是否 要对 message 进行 持久 化 需要 综合 考虑 性能 需要 以及 可能 遇到 的 问题 若想 达到 条 秒 以上 的 消息 吞吐量 单 rabbitmq 服务器 则 要么 使用 其他 的 方式 来 确保 message 的 可靠 delivery 要么 使用 非常 快速 的 存储系统 以 支持 全 持久 化 例如 使用 ssd 另外 一种 处理 原 则是 仅对 关键 消息 作 持久 化 处理 根据 业务 重要 程度 且 应该 保证 关键 消息 的 量 不会 导致 性能 瓶颈 rabbitmq 中 的 以及 warrens 机制 分别 用于 解决 什么问题 存在 哪些 问题 cluster 是为了 解决 当 cluster 中 的 任意 node 失效 后 producer 和 consumer 均 可以 通过 其他 node 继续 工作 即 提高了 可用性 另外 可以 通过 增加 node 数量 增加 cluster 的 消息 吞吐量 的 目的 cluster 本身 不 负责 message 的 可靠 性问题 该 问题 由 producer 通过 各种 机制 自行解决 cluster 无法 解决 跨 数据中心 的 问题 即 脑 裂 问题 另 外在 cluster 前 使用 haproxy 可以 解决 node 的 选择 问题 即 业务 无需 知道 cluster 中 多个 node 的 ip 地址 可以 利用 haproxy 进行 失效 node 的 探测 可 以作 负载 均衡 mirroredqueue 是为了 解决 使用 cluster 时 所 创建 的 queue 的 完整 信息 仅存 在于 单一 node 上 的 问题 从 另一个 角度 增加 可用性 若想 正确 使用 该 功能 需要 保证 consumer 需要 支持 机制 consumer 必须 能够 正确处理 重复 messagewarrens 是为了 解决 cluster 中 message 可能 被 blackholed 的 问题 即 不能 接受 producer 不停 但 rabbitmqserver 无 回应 的 情况 warrens 有 两种 构成 方式 一种 模型 是 两台 独立 的 其中 两个 server 的 状态 分别为 active 和 hotstandby 该 模型 的 特点 为 两台 server 之间 无任何 数据 共享 和 协议 交互 两台 server 可以 基于 不同 的 rabbitmq 版本 另一种 模型 为 两台 共享 存储 的 其中 两个 server 的 状态 分别为 active 和 coldstandby 该 模型 的 特点 为 两台 server 基于 共享 存储 可以 做到 完全 恢复 要求 必须 基于 完全相同 的 rabbitmq 版本 warrens 模型 存在 的 问题 对于 第一种 模型 虽然 理论上 讲 不会 丢失 消息 但 若在 该 模型 上 使用 持久 化 机制 就会 出现 这样 一种 情况 即若 作为 active 的 server 异常 后 持久 化 在 该 server 上 的 消息 将 暂时 无法 被 consume 因为 此时 该 queue 将 无法 在 作为 hotstandby 的 server 上 被 重建 所以 只能 等到 异常 的 activeserver 恢复 后 才 能从 其 上 的 queue 中 获取 相应 的 message 进行 处理 而 对于 业务 来说 需要 具有 a 感知 amqp 连接 断开 后 重建 各种 fabric 的 能力 b 感知 activeserver 恢复 的 能力 c 切 换回 activeserver 的 时机 控制 以及 切 回 后 针对 message 先后顺序 产生 的 变化 进行 处理 的 能力 对于 第二种 模型 因为 是 基于 共享 存储 的 模式 所以 导致 activeserver 异常 的 条件 可能 同样会 导致 异常 另 外在 该 模型 下 要求 active 和 coldstandby 的 server 必须 具有 相同 的 node 名 和 uid 否 则将 产生 访问 权限 问题 最后 由于 该 模型 是 冷 备 方案 故 无法 保证 能在 你 要求 的 时限 内 成功 启动 分布式 消息 通讯 kafka 篇 kafka 的 设计 是 什么样 的 呢 kafka 将 消息 以 topic 为 单位 进行 归纳 将 向 kafkatopic 发布 消息 的 程序 成为 producers 将 预订 topics 并 消费 消息 的 程序 成为 consumerkafka 以 集群 的 方式 运行 可以 由 一个 或 多个 服务 组成 每个 服务 叫做 一个 brokerproducers 通过 网络 将 消息 发送到 kafka 集群 集群 向 消费者 提供 消息 数据传输 的 事物 定义 有 哪 三种 数据传输 的 事务 定义 通常 有 以下 三种 级别 最多 一次 消息 不 会被 重复 发送 最多 被 传输 一次 但也 有 可能 一次 不 传输 最少 一次 消息 不 会被 漏 发送 最 少被 传输 一次 但也 有 可能 被 重复 传输 精确 的 一次 exactlyonce 不会 漏 传输 也 不会 重复 传输 每个 消息 都 传输 被 一次 而且 仅仅 被 传输 一次 这是 大家 所 期望 的 kafka 判断 一个 节点 是否 还 活着 有 那 两个 条件 节点 必须 可以 维护 和 zookeeper 的 连接 zookeeper 通过 心跳 机制 检查 每个 节点 的 连接 如果 节点 是 个 follower 他 必须 能 及时 的 同步 leader 的 写 操作 延时 不能 太久 producer 是否 直接 将 数据 发送到 broker 的 leader 主 节点 producer 直接 将 数据 发送到 broker 的 leader 主 节点 不需 要在 多个 节点 进行 分发 为了 帮助 producer 做到 这点 所有 的 kafka 节点 都可以 及时 的 告知 哪些 节点 是 活动 的 目标 topic 目标 分区 的 leader 在哪 这样 producer 就可以 直接 将 消息 发送到 目的地 了 kafaconsumer 是否 可以 消费 指定 分区 消息 kafaconsumer 消费 消息 时 向 broker 发出 fetch 请 求去 消费 特定 分区 的 消息 consumer 指定 消息 在 日志 中 的 偏移量 offset 就可以 消费 从这 个 位置 开始 的 消息 customer 拥有 了 offset 的 控制权 可以 向后 回 滚去 重新 消费 之前 的 消息 这是 很有 意义 的 kafka 消息 是 采用 pull 模式 还是 push 模式 kafka 最初 考虑 的 问题是 customer 应该 从 brokes 拉 取 消息 还是 brokers 将 消息 推 送到 consumer 也 就是 pull 还 push 在这 方面 kafka 遵循 了 一种 大部分 消息 系统 共同 的 传统 的 设计 producer 将 消息 推 送到 brokerconsumer 从 broker 拉 取 消息 一些 消息 系统 比如 scribe 和 apacheflume 采 用了 push 模式 将 消息 推 送到 下游 的 consumer 这样 做 有 好处 也有 坏处 由 broker 决定 消息 推送 的 速率 对于 不同 消费 速率 的 consumer 就不 太好 处 理了 消息 系统 都 致力于 让 consumer 以 最大 的 速率 最 快速 的 消费 消息 但 不幸 的 是 push 模式 下 当 broker 推送 的 速率 远大于 consumer 消费 的 速率 时 consumer 恐怕 就要 崩溃 了 最终 kafka 还是 选 取了 传统 的 pull 模式 pull 模式 的 另外 一个 好处 是 consumer 可以 自主 决定 是否 批量 的 从 broker 拉 取 数据 push 模式 必 须在 不知道 下游 consumer 消费 能力 和 消费 策略 的 情况下 决 定是 立即 推送 每条 消息 还是 缓存 之后 批量 推送 如果 为了 避免 consumer 崩溃 而 采用 较低 的 推送 速率 将 可能 导致 一次 只 推送 较少 的 消息 而 造成 浪费 pull 模式 下 consumer 就可以 根据 自己 的 消费 能力 去 决定 这些 策略 pull 有 个 缺点 是 如果 broker 没有 可供 消费 的 消息 将 导致 consumer 不断 在 循 环中 轮询 直到 新消息 到 t 达 为了 避免 这点 kafka 有 个 参数 可以 让 consumer 阻塞 知道 新消息 到达 当然 也 可以 阻塞 知道 消息 的 数量 达到 某个 特定 的 量 这样 就可以 批量 发 kafka 存储 在 硬 盘上 的 消息 格式 是什么 消息 由 一个 固定 长度 的 头部 和 可变 长度 的 字节 数组 组成 头部 包 含了 一个 版本号 和 crc 校验码 消息 长度 bytes valuen 版本号 bytecrc 校验码 bytes 具体 的 消息 nbyteskafka 高效 文件 存储 设计 特点 kafka 把 topic 中一 个 parition 大文件 分成 多个 小文件 段 通过 多个 小文件 段 就 容易 定期 清除 或 删除 已经 消费 完 文件 减少 磁盘 占用 通过 索引 信息 可以 快速 定位 message 和 确定 response 的 最大 大小 通过 index 元 数据 全部 映 射到 memory 可以 避免 segmentfile 的 io 磁盘操作 通过 索引 文件 稀疏 存储 可以 大幅 降低 index 文件 元 数据 占用 空间 大小 kafka 与 传统 消息 系统 之间 有 三个 关键 区别 kafka 持久 化 日志 这些 日志 可以 被 重复 读取 和 无限期 保留 kafka 是 一个 分布式 系统 它以 集群 的 方式 运行 可以 灵活 伸缩 在内部 通过 复制 数据 提升 容错 能力 和 高 可用性 kafka 支持 实时 的 流式 处理 kafka 创建 topic 时 如何将 分区 放置 到 不同 的 broker 中副 本 因子 不能 大于 broker 的 个数 第一个 分区 编 号为 的 第一个 副本 放置 位置 是 随机 从 brokerlist 选择 的 其他 分区 的 第一个 副本 放置 位置 相对于 第 个 分区 依次 往 后移 也 就是 如果 我们 有 个 broker 个 分区 假设 第一个 分区 放在 第四个 broker 上 那么 第二个 分区 将会 放在 第五个 broker 上第 三个 分区 将会 放在 第一个 broker 上第 四个 分区 将会 放在 第二个 broker 上 依次 类推 剩余 的 副本 相对于 第一个 副本 放置 位置 其实是 由 决定 的 而这 个数 也是 随机 产生 的 kafka 新建 的 分区 会在 哪个 目 录下 创 建在 启动 kafka 集群 之前 我们 需要 配置 好 logdirs 参数 其 值 是 kafka 数据 的 存放 目录 这个 参数 可以 配置 多个 目录 目录 之间 使用 逗号 分隔 通常 这些 目录 是 分布 在 不同 的 磁 盘上 用于 提高 读写 性能 当然 我们 也 可以 配置 logdir 参数 含义 一样 只需要 设置 其中 一个 即可 如果 logdirs 参数 只 配置 了 一个 目录 那么 分 配到 各个 broker 上 的 分区 肯定 只能 在 这个 目 录下 创建 文件 要 用于 存放 数据 但是 如果 logdirs 参数 配置 了 多个 目录 那么 kafka 会在 哪个 文件 央 中 创建 分区 目录 呢 答案 是 kafka 会在 含有 分区 目录 最少 的 文件 央 中 创建 新 的 分区 目录 分区 目录 名为 topic 名 分区 id 注意 是 分区 文件 要 总数 最少 的 目录 而 不是 磁盘 使用量 最少 的 目录 也就是说 如果 你 给 logdirs 参数 新增 了 一个 新 的 磁盘 新 的 分区 目录 肯定是 先在 这个 新 的 磁 盘上 创建 直到 这个 新 的 磁盘 目录 拥有 的 分区 目录 不是 最少 为止 partition 的 数据 如何 保 存到 硬盘 topic 中 的 多个 partition 以 文件 央 的 形式 保 存到 broker 每个 分区 序号 从 递增 且 消息 有序 partition 文件 下有 多个 segment xxxindexxxxlog segment 文件 里 的 大小 和 配置文件 大小 一致 可以 根据 要求 修改 默 认为 g 如果 大小 大于 g 时会 滚动 一个 新 的 segment 并且 以上 一个 segment 最后 一条 消息 的 偏移量 命名 kafka 的 ack 机制 有 三个 值 生产者 不会 等待 broker 的 ack 这个 延迟 迟 最低 但是 存储 的 保证 最弱 当 server 挂掉 的 时候 就会 丢 数据 服务端 会 等待 ack 值 leader 副本 确认 接 收到 消息 后 发送 ack 但是 如果 leader 挂掉 后 他 不 确保 是否 复制 完成 新 leader 也 会 导致 数据 丢失 同样在 的 基础上 服务端 会 等 所有 的 follower 的 副本 受到 数据 后 才会 受到 leader 发出 的 ack 这样 数据 不会 丢失 kafka 的 消费者 如何 消费 数据 消费者 每次 消费 数据 的 时候 消费者 都会 记录 消费 的 物理 偏移量 offset 的 位置 等到 下次 消 费时 他 会 接着 上次 位置 继续 消费 消费者 负载 均衡 策略 一个 消费者 组 中 的 一个 分片 对应 一个 消费者 成员 他 能 保证 每个 消费者 成员 都能 访问 如果 组 中 成员 太多 会有 空闲 的 成员 数据 有序 一个 消费者 组里 它 的 内部 是 有序 的 消费者 组 与 消费者 组 之间 是 无序 的 kafaka 生产 数据 时 数据 的 分组 策略 生产者 决定 数据 产生 到 集群 的 哪个 partition 中 每 一条 消息 都 是以 keyvalue 格式 key 是 由 生产者 发送 数据 传入 所以 生产者 key 决定 了 数据 产生 到 集群 的 哪个 partition 分布式 消息 通讯 activemq 篇 什么 是 是 一种 开源 的 实现 了 jms 规范 的 面向 消息 mom 的 中间件 为 应用程序 提供 高效 的 可 扩展 的 稳定 的 和 安全 的 企业级 消息 通信 activemq 服务器 宕机 怎么办 这得 从 activemq 的 储存 机制 说起 在 通常 的 情况下 非 持久 化 消息 是 存储 在 内存 中 的 持久 化 消息 是 存储 在 文件 中 的 它们 的 最大 限制 在 配置文件 的 ltsystemusagegt 节 点中 配置 但是在 非 持久 化 消息 堆 积到 一定 程度 内存 告急 的 时候 activemq 会将 内存 中 的 非 持久 化 消息 写入 临时文件 中 以 腾出 内存 虽然 都 保存 到了 文件 里 但它 和 持久 化 消息 的 区 别是 重启 后 持久 化 消息 会 从 文件 中 恢复 非 持久 化 的 临时文件 会 直接 删除 那 如果 文件 增大 到达 了 配置 中 的 最大 限制 的 时候 会 发生 什么 我 做了 以下 实验 设置 g 左右 的 持久 化 文件 限制 大量生产 持久 化 消息 直到 文件 达到 最大 限制 此时 生产者 阻塞 但 消费者 可 正常 连接 并 消费 消息 等 消息 消费 掉 一部分 文件 删除 又 腾出 空间 之后 生产者 又可 继续 发送 消息 服务 自动 恢复 正常 设置 g 左右 的 临时文件 限制 大量生产 非 持久 化 消息 并 写入 临时文件 在 达到 最大 限制 时 生产者 阻塞 消费者 可 正常 连接 但 不能 消费 消息 或者 原本 慢速 消费 的 消费者 消费 突然 停止 整个 系统 可 连接 但是 无法 提供 服务 就这样 挂了 具体 原因 不详 解决方案 尽量 不 要用 非 持久 化 消息 非 要用 的话 将 临时文件 限制 尽可能 的 调 大 丢 消息 怎么办 这得 从 java 的 异常 说起 简 单点 说 就是 当 网络 发送 方 发送 一堆 数据 然后 调用 close 关闭 连接 之后 这些 发送 的 数据 都在 接收者 的 缓存 里 接收者 如果 调用 read 方法 仍旧 能从 缓存 中 读取 这些 数据 尽管 对方 已经 关闭 了 连接 但是 当 接收者 尝试 发送 数据 时 由于 此时 连接 已 关闭 所以会 发生 异常 这个 很好 理解 不过 需要 注意 的 是 当 发生 socketexception 后 原本 缓存 区 中 数据 也 作 废了 此时 接收者 再次 调用 read 方法 去 读取 缓存 中 的 数据 就 会报 错误 通过 抓 包 得知 activemq 会 每隔 秒 发送 一个 心跳 包 这个 心跳 包 是 服务器 发送给 客户端 的 用来 判断 客户端 死 没死 如果 你 看过 上面 第一条 就会 知道 非 持久 化 消息 堆 积到 一定 程度 会 写到 文件 里 这个 写 的 过程 会 阻塞 所有 动作 而且 会 持续 到 秒 并且 随着 内存 的 增大 而 增 大当 客户端 发完 消息 调用 connectionclose 时会 期待 服务器 对于 关闭 连接 的 回答 如果 超过 秒 没 回答 就 直接 调用 socket 层 的 close 关闭 tcp 连 接了 这时 客户端 发出 的 消息 其实 还在 服务器 的 缓存 里 等待 处理 不过 由于 服务器 心跳 包 的 设置 导致 发 生了 异常 把 缓存 里 的 数据 作 废了 没 处理 的 消息 全部 丢失 解决方案 用 持久 化 消息 或者 非 持久 化 消息 及时处理 不要 堆积 或者 启动 事务 启动 事务 后 commit 方 法会 负责任 的 等待 服务器 的 返回 也就 不会 关闭 连接 导致 消息 丢失 了 持久 化 消息 非常 慢 如何 处理 默认 的 情况下 非 持久 化 的 消息 是 异步 发送 的 持久 化 的 消息 是 同步 发送 的 遇到 慢 一点 的 硬盘 发送 消息 的 速度 是 无法忍受 的 但是在 开启 事务 的 情况下 消息 都是 异步 发送 的 效率 会有 个数 量级 的 提升 所以在 发送 持久 化 消息 时 请 务必 开启 事务 模式 其实 发送 非 持久 化 消息 时 也 建议 开启 事务 因为 根本 不会 影响 性能 消息 的 不均匀 消费 有时 在 发送 一些 消息 之后 开启 个 消费者 去 处理 消息 会 发现 一个 消费者 处 理了 所有 的 消息 另一个 消费者 根本 没 收到 消息 原因 在于 activemq 的 prefetch 机制 当 消费者 去 获取 消息 时 不会 一条 一条 去 获取 而是 一次性 获取 一批 默认 是 条 这些 预 获取 的 消息 在 还没 确认 消费 之前 在 管理 控制台 还是 可以 看见 这些 消息 的 但是 不会 再分 配给 其他 消费者 此时 这些 消息 的 状态 应该 算作 已 分配 未 消费 如果 消息 最后 被 消费 则 会在 服务器端 被 删除 如果 消费者 崩溃 则 这些 消息 会被 重新 分配给 新 的 消费者 但是 如果 消费者 既不 消费 确认 又不 崩溃 那 这些 消息 就 永远 躺在 消费者 的 缓存 区里 无法 处理 更 通常 的 情况 是 消费 这些 消息 非常 耗时 你 开了个 消费者 去 处理结果 发现 只有 一台 机器 吭哧 吭哧 处理 另外 台 啥事 不干 解决方案 将 prefetch 设为 每次 处理 条 消息 处 理完 再 去取 这样 也 慢 不 了 多少 死信 队列 如果 你 想在 消息 处理 失败 后 不被 服务器 删除 还能 被 其他 消费者 处理 或 重试 可以 关闭 autoacknowledge 将 ack 交由 程序 自己 处理 那 如果 使 用了 autoacknowledge 消息 是什么 时候 被 确认 的 还有 没有 阻止 消息 确认 的 方法 有 两种 一种 是 调用 consumerreceive 方法 该 方法 将 阻塞 直到 获得 并 返回 一条 消息 这种 情况下 消息 返回 给 方法 调用者 之后 就 自动 被 确 认了 另一 种方法 是 采用 listener 回 调 函数 在有 消息 到达 时会 调用 listener 接口 的 onmessage 方法 在 这种 情况 下在 onmessage 方法 执行 完毕 后 消息 才 会被 确认 此时 只 要在 方法 中 抛出 异常 该 消息 就不 会被 确认 那么 问题 来了 如果 一条 消息 不能 被 处理 会被 退回 服务器 重新分配 如果 只有 一个 消费者 该 消息 又会 重新 被 获取 重新 抛 异常 就算 有 多个 消费者 往往 在 一个 服务器 上 不能 处理 的 消息 在 另外 的 服务器 上 依然 不能 被 处理 难道 就这么 退回 获取 报错 死循环 了吗 在 重试 次 后 activemq 认为 这条 消息 是 有毒 的 将 会把 消息 丢到 死信 队列 里 如果 你 的 消息 不见了 去 activemqdlq 里 找找 说不定 就 躺在 那里 activemq 中 的 消息 重发 时间 间隔 和 重发 次数 吗 activemq 是 apache 出品 最 流行 的 能力 强劲 的 开源 消息 总线 是 一个 完全 支持 jms 和 jee 规范 的 jmsprovider 实现 jms java 消息 服务 是 一个 java 平 台中 关于 面向 消息 中间件 mom 的 api 用于 在 两个 应用程序 之 间或 分布式 系统 中 发送 消息 进行 异步 通信 首先 我们 得 大概 了解 下在 哪些 情况下 activemq 服务器 会将 消息 重 发给 消费者 这里 为 简单 起见 假定 采用 的 消息 发送 模式 为 队列 即 消息 发送者 和 消息 接收者 如果 消息 接收者 在 处 理完 一条 消息 的 处理 过程 后 没有 对 mom 进行 应答 则 该 消息 将由 mom 重发 如果 我们 对 某个 队列 设置 了 预 读 参数 如果 消息 接收者 在 处理 第一条 消息 时 没向 mom 发送 消息 接收 确认 就 宕机 了 则 预 读 数量 的 所有 消息 都 将被 重发 如果 session 是 事务 的 则 只要 消息 接收者 有 一条 消息 没有 确认 或 发送 消息 期间 mom 或 客户端 某一 方 突然 宕机 了 则 该 事务 范围 中 的 所有 消息 mom 都将 重发 说到 这里 大家 可能会 有疑问 activemq 消息 服务器 怎么 知道 消费者 客户端 到底是 消息 正在 处理 中 还没 来得 急 对 消息 进行 应答 还是 已经 处理 完 成了 没有 应答 或是 宕机 了 根本 没 机会 应答 呢 其实 在所 有的 客户端 机器 上 内存 中都 运行 着 一套 客户端 的 activemq 环境 该 环境 负责 缓存 发来 的 消息 负责 维持着 和 activemq 服务器 的 消息 通讯 负责 失效 转移 failover 等 所有 的 判断 和 处理 都是 由 这套 客户端 环境 来 完成 的 我们 可 以来 对 activemq 的 重发 策略 来 进行 自定义 配置 其中 的 配置 参数 主要有 以下 几个 可用 的 属性 默认值 说明 默认值 设置 防止 冲突 范围 的 正负 百分比 只有 启用 参数 时 才 生效 默认值 最大 重传 次数 达到 最大 重 连 次数 后 抛出 异常 为时 不 限制 次数 为时 表示 不 进行 重传 默认值 最大 传送 延迟 只 在 为 true 时 有效 v 假设 首次 重 连 间隔 为 ms 倍数 为 那么 第二次 重 连 时间 间隔 为 ms 第三次 重 连 时间 间隔 为 ms 当 重 连 时间 间隔 大 的 最大 重 连 时间 间隔 时 以后 每次 重 连 时间 间隔 都为 最大 重 连 时间 间隔 默认值 l 初始 重发 延迟时间 默认值 l 重发 延迟时间 当 时 生效 v 默认值 false 启用 防止 冲突 功能 因为 消息 接收 时 是 可以 使用 多线程 并发 处理 的 应该 是为了 重发 的 安全性 避开 所有 并发 线程 都在 同一个 时间 点 进行 消息 接收 处理 所有 线程 在 同一个 时间 点 处理 时会 发生 什么问题 呢 应该 没有问题 只是 为了 平衡 broker 处理 性能 不会 有时 很忙 有时 很 空闲 默认值 false 启用 指数 倍数 递增 的 方式 增加 延迟时间 默认值 重 连 时间 间隔 递增 倍数 只有 值 大于 和 启用 参数 时 才 生效 分布式数据库 reids 篇 redis 和 memcached 什么区别 为什么 高 并发 下 有时 单线程 的 redis 比多 线程 的 memcached 效率 要高 区别 mc 可 缓存 图片 和 视频 rd 支持 除 kv 更多 的 数据结构 rd 可以 使用 虚拟内存 rd 可 持久 化 和 aof 灾难 恢复 rd 通过 主从 支持 数据 备份 rd 可以 做 消息 队列 原因 mc 多线程 模型 引 入了 缓存 一致性 和 锁 加锁 带 来了 性能 损耗 redis 主从复制 如何 实现 的 redis 的 集群 模式 如何 实现 redis 的 key 是 如何 寻址 址 的 主从复制 实现 主 节点 将 自己 内存 中 的 数据 做 一份 快照 将 快照 发给 从 节点 从 节 点将 数据 恢复 到 内存 中 之后 再 每次 增加 新 数据 的 时候 主 节点 以 类似于 mysql 的 二进制 日志 方式 将 语句 发送给 从 节点 从 节点 拿到 主 节点 发送 过来 的 语句 进行 重放 分片 方式 客户端 分片 基于 代理 的 分片 twemproxycodis 路由 查询 分片 rediscluster 本身 提供 了 自动 将 数据 分散 到 rediscluster 不同 节点 的 能力 整个 数据 集合 的 某个 数据 子集 存储 在 哪个 节点 对于 用户 来 说是 透明 的 rediscluster 分片 原理 cluster 中有 一个 长度 的 槽 虚拟 槽 编号 分别为 每个 master 节点 都会 负责 一部分 的 槽 当 有 某个 key 被 映 射到 某个 master 负责 的 槽 那么 这个 master 负责 为 这个 key 提供 服务 至于 哪个 master 节点 负责 哪个 槽 可以 由 用户 指定 也 可以 在 初始化 的 时候 自动 生成 只有 master 才 拥有 槽 的 所有权 master 节点 维 护着 一个 字节 的 位 序列 master 节点 用 bit 来 标识 对于 某个 槽 自己 是否 拥有 比如 对于 编 号为 的 槽 master 只要 判断 序列 的 第二位 索引 从 开始 是不是 为 即可 这种 结构 很 容易 添加 或者 删除 节点 比如 如果 我 想 新添 加个 节点 d 我 需 要从 节点 abc 中 的 部分 槽 到 d 上 使用 redis 如何 设计 分布式 锁 说 一下 实现 思路 使用 zk 可以吗 如何 实现 这两种 有 什么区别 redis 线程 asetnx 上锁 的 对象 超 时时 的 时间 戳 t 如果 返回 true 获得 锁 线程 b 用 get 获取 t 与 当前 时间 戳 比较 判断 是 是否 超时 没 超时 false 若 超时 执行 第 步 计算 新 的 超时 时间 t 使用 getset 命令 返回 t 该 值 可能 其他 线程 已经 修 改过 如果 tt 获得 锁 如果 tt 说明 锁 被 其他 线程 获 取了 获取 锁 后处理 完 业务 逻辑 再去 判断 锁 是否 超时 如果 没 超时 删除 锁 如果 已 超时 不用 处理 防止 删除 其他 线程 的 锁 zk 客户端 对 某个 方法 加锁 时 在 zk 上 的 与 该 方法 对应 的 指定 节点 的 目录 下 生成 一个 唯一 的 瞬时 有序 节点 node 客户端 获取 该 路径 下 所有 已经 创建 的 子 节点 如果 发现 自己 创建 的 node 的 序号 是 最小 的 就 认为 这个 客户端 获得了 锁 如果 发现 node 不是 最小 的 则 监听 比 自己 创建 节点 序号 小 的 最大 的 节点 进入 等待 获取 锁 后处理 完 逻辑 删除 自己 创建 的 node 即可 区别 zk 性能 差 一些 开销 大 实现 简单 知道 redis 的 持久 化 吗 底层 如何 实现 的 有 什么 优点 缺点 rdb redisdatabase 在 不同 的 时间 点将 redis 的 数据 生成 的 快照 同步 到 磁盘 等 介质 上 内 存到 硬盘 的 快照 定期 更新 缺点 耗时 耗 性能 forkio 操作 易 丢失 数据 aof appendonlyfile 将 redis 所 执行 过 的 所有 指令 都 记录下来 在 下次 redis 重启 时 只需要 执行 指令 就可以 了 写 日志 缺点 体积 大 恢复 速度慢 bgsave 做 镜像 全 量 持久 化 aof 做 增量 持久 化 因为 bgsave 会 消耗 比 较长 的 时间 不够 实时 在 停机 的 时候 会 导致 大量 的 数据 丢失 需要 aof 来 配 合在 redis 实例 重启 时 优先 使用 aof 来 恢复 内存 的 状态 如果 没有 aof 日志 就会 使用 rdb 文件 来 恢复 redis 会 定期 做 aof 重写 压缩 aof 文件 日志 大小 redis 之后 有 了 混合 持久 化 的 功 能将 bgsave 的 全 量 和 aof 的 增量 做了 融合 处理 这样 既 保证 了 恢复 的 效率 又 兼顾 了 数据 的 安全性 bgsave 的 原理 fork 和 cowfork 是 指 redis 通过 创建 子 进程 来 进行 bgsave 操作 cow 指的是 copyonwrite 子 进程 创建 后 父子 进程 共享 数据 段 父 进程 继续 提供 读写 服务 写 脏 的 页面 数据 会 逐渐 和 子 进程 分离 开来 redis 过期 策略 都有 哪些 lru 算法 知道吗 写 一下 java 代码 实现 过期 策略 定时 过期 一 key 一 定时器 惰性 过期 只有 使用 key 时 才 判断 key 是否 已过期 过期 则 清除 定期 过期 前 两者 折中 第三个 参数 置 为 true 代表 linkedlist 按 访问 顺序 排序 可 作为 lru 缓存 设为 false 代表 按 插入 顺序 排序 可 作为 fifo 缓存 lru 算法 实现 通过 双向 链表 来 实现 新 数据 插入 到 链表 头部 每当 缓存 命中 即 缓存 数据 被 访问 则将 数据 移到 链表 头部 当 链表 满 的 时候 将 链表 尾部 的 数据 丢弃 和 双向 链表 合二为一 即是 是 无序 的 linkedhashmap 通过 维护 一个 额外 的 双向 链表 保证 了 迭代 顺序 该 迭代 顺序 可 以是 插入 顺序 默认 也 可 以是 访问 顺序 缓存 穿透 缓存 击穿 缓存 雪崩 解决方案 缓存 穿透 指 查询 一个 一定 不存在 的 数据 如果 从 存储 层 查不到 数据 则不 写入 缓存 这将 导致 这个 不存在 的 数据 每次 请求 都 要到 db 去 查询 可能 导致 db 挂掉 解决方案 查询 返回 的 数据 为 空 仍 把 这个 空 结果 进行 缓存 但 过期 时间 会比 较短 布 隆 过滤器 将 所有 可能 存在 的 数据 哈希 到 一个 足 够大 的 bitmap 中一 个 一定 不存在 的 数据 会被 这个 bitmap 拦 截掉 从而 避免了 对 db 的 查询 缓存 击穿 对于 设置 了 过期 时间 的 key 缓 存在 某个 时间 点 过期 的 时候 恰好 这 时间 点 对 这个 key 有 大量 的 并发 请求 过来 这些 请求 发现 缓存 过期 一般 都会 从 后端 db 加载 数据 并回 设到 缓存 这个 时候 大 并发 的 请求 可能会 瞬间 把 db 压垮 解决方案 使用 互斥 锁 当 缓存 失效 时 不 立即 去 loaddb 先 使用 如 redis 的 setnx 去 设置 一个 互斥 锁 当 操作 成功 返回 时 再 进行 loaddb 的 操作 并回 设 缓存 否则 重试 get 缓存 的 方法 永远 不 过期 物理 不 过期 但 逻辑 过期 后台 异步 线程 去 刷新 缓存 雪崩 设置 缓存 时 采 用了 相同 的 过期 时间 导致 缓 存在 某一 时刻 同时 失效 请求 全部 转 发到 dbdb 瞬时 压力 过重 雪崩 与 缓存 击穿 的 区别 雪崩 是 很多 key 击穿 是 某一个 key 缓存 解决方案 将 缓存 失效 时间 分 散开 比如 可以 在 原有 的 失效 时间 基础上 增加 一个 随机 值 比如 分钟 随机 这样 每一个 缓存 的 过期 时间 的 重复 率 就会 降低 就 很难 引发 集体 失效 的 事件 在 选择 缓存 时 什么时候 选择 redis 什么时候 选择 memcached 选择 redis 的 情况复杂 数据结构 value 的 数据 是 哈希 列表 集合 有序 集合 等 这种 情况下 会 选择 redis 因为 memcache 无法 满足 这些 数据结构 最 典型 的 的 使用 场景 是 用户 订单 列表 用户 消息 帖子 评论 等 需要 进行 数据 的 持久 化 功能 但是 注意 不 要把 redis 当成 数据库 使用 如果 redis 挂了 内存 能够 快速 恢复 热 数据 不 会将 压力 瞬间 压在 数据库 上 没有 cache 预热 的 过程 对于 只读 和 数据一致性 要求 不高 的 场景 可以 采用 持久 化 存储 高 可用 redis 支持 集群 可以 实现 主动 复制 读写 分离 而 对于 memcache 如果 想要 实现 高 可用 需要 进行 二次开发 存储 的 内容 比 较大 memcache 存储 的 value 最 大为 m 选择 memcache 的 场景 纯 kv 数据量 非常大 的 业务 使用 memcache 更 合适 原因是 amemcache 的 内存 分配 采用 的 是 预 分配 内存 池 的 管理方式 能够 省去 内存 分配 的 时间 redis 是 临时 申请 空间 可能 导致 碎片 化 b 虚拟内存 使用 memcache 将 所有 的 数据 存储 在 物理 内存 里 redis 有 自己 的 vm 机制 理论上 能够 存储 比 物理 内存 更多 的 数据 当 数据 超量 时 引发 swap 把 冷 数据 刷 新到 磁 盘上 从 这点 上 数据 量大 时 memcache 更快 c 网络 模型 memcache 使用 非 阻塞 的 io 复用 模型 redis 也是 使用 非 阻塞 的 io 复用 模型 但是 redis 还 提供 了 一些 非 kv 存储 之外 的 排序 聚合 功能 复杂 的 cpu 计算 会 阻塞 整个 io 调度 从 这点 上 由于 redis 提供 的 功能 较多 memcache 更 快些 d 线程 模型 memcache 使用 多线程 主 线程 监听 worker 子 线程 接受 请求 执行 读写 这个 过程 可能 存在 锁 冲突 redis 使用 的 单线程 虽然 无 锁 冲突 但是 难以 利用 多核 的 特性 提升 吞吐量 缓存 与 数据库 不一致 怎么办 假设 采用 的 储存 分离 读写 分离 的 数据库 如果 一个 线程 a 先 删除 缓存 数据 然后 将 数据 写入 到 主库 当中 这个 时候 主库 和 从 库 同步 没有 完成 线程 b 从 缓存 当中 读取 数据 失败 从 从 库 当中 读 取到 旧 数据 然后 更新 至 缓存 这个 时候 缓存 当中 的 就是 旧 的 数据 发生 上述 不一致 的 原因 在于 主从 库 数据 不一致 问题 加 入了 缓存 之后 主从 不一致 的 时间 被 拉 长了 处理 思路 在从 库 有 数据 更新 之后 将 缓存 当中 的 数据 也 同时 进行 更新 即 当 从 库 发 生了 数据 更新 之 后向 缓存 发出 删除 淘汰 这段 时间 写入 的 旧 数据 主从 数据库 不一致 如何 解决 场景 描述 对于 主从 库 读写 分离 如果 主从 库 更新 同步 有 时差 就会 导致 主从 库 数据 的 不一致 忽略 这个 数据 不一致 在 数据一致性 要求 不高 的 业务 下 未必 需要 时时 一致性 强制 读 主库 使用 一个 高 可用 的 主库 数据库 读写 都在 主库 添加 一个 缓存 提升 数据 读取 的 性能 选择性 读 主库 添加 一个 缓存 用来 记录 必须 读 主库 的 数据 将 哪个 库 哪个 表 哪个 主键 作为 缓存 的 key 设置 缓存 失效 的 时间 为 主从 库 同步 的 时间 如果 缓存 当中 有 这个 数据 直接 读取 主库 如果 缓存 当中 没有 这个 主键 就到 对应 的 从 库 中 读取 redis 常见 的 性能 问题 和 解决方案 master 最好 不 要做 持久 化 工作 如 rdb 内存 快照 和 aof 日志 文件 如果 数据 比较 重要 某个 slave 开启 aof 备份 策略 设置成 每秒 同步 一次 为了 主从复制 的 速度 和 连接 的 稳定性 master 和 slave 最 好在 一个 局域 网内 尽量 避免 在 压力大 的 主库 上 增加 从 库 主从复制 不要 采用 网状结构 尽量 是 线性 结构 的 数据 淘汰 策略 有 哪些 voltilelru 从 已经 设置 过期 时间 的 数据 集中 挑选 最近 最少 使用 的 数据 淘汰 voltilettl 从 已经 设置 过期 时间 的 数据库 集 当中 挑选 将要 过期 的 数据 voltilerandom 从 已经 设置 过期 时间 的 数据 集 任意 选择 淘汰 数据 allkeyslru 从 数据 集中 挑选 最近 最少 使用 的 数据 淘汰 allkeysrandom 从 数据 集中 任意 选择 淘汰 的 数据 noeviction 禁止 驱逐 数据 redis 当中 有 哪些 数据结构 字符串 string 字典 hash 列表 list 集合 set 有序 集合 sortedset 如果是 高级 用户 那么 还会 有 如果 你 是 redis 中高级 用户 还需要 加上 下面 几种 数据结构 假如 redis 里面 有 亿个 key 其中有 w 个 key 是以 某个 固定 的 已知 的 前缀 开头 的 如果 将 它们 们 全部 找出来 使用 keys 指令 可以 扫出 指定 模式 的 key 列表 对方 接着 追问 如果 这个 redis 正 在给 线上 的 业务 提供 服务 那 使用 keys 指令 会有 什么问题 这个 时候 你 要回答 redis 关键 的 一个 特性 redis 的 单线程 的 keys 指令 会 导致 线程 阻塞 一段时间 线上 服务 会 停顿 直到 指令 执行 完毕 服务 才能 恢复 这个 时候 可以 使用 scan 指令 scan 指令 可以 无 阻塞 的 提 取出 指定 模式 的 key 列表 但是 会有 一定 的 重复 概率 在 客户端 做 一次 去 重 就可以 了 但是 整体 所 花费 的 时间 会比 直接 用 keys 指令 长 使用 redis 做过 异步 队列 吗 是 如何 实现 的 使用 list 类型 保存 数据 信息 rpush 生产 消息 lpop 消费 消息 当 lpop 没有 消息 时 可以 sleep 一段时间 然后再 检查 有没有 信息 如果 不想 sleep 的话 可以 使用 blpop 在 没有 信息 的 时候 会 一直 阻塞 直到 信息 的 到来 redis 可以 通过 pubsub 主题 订阅 模式 实现 一个 生产者 多个 消费者 当然 也 存在 一定 的 缺点 当 消费者 下线 时 生产 的 消息 会 丢失 redis 如何 实现 延时 队列 使用 sortedset 使用时间 戳 做 score 消息 内容 作为 key 调用 zadd 来 生产 消息 消费者 使用 zrangbyscore 获取 n 秒 之前 的 数据 做 轮询 处理 什么 是 redis 简述 它 的 优缺点 redis 本质上 是 一个 keyvalue 类型 的 内存 数据库 很像 memcached 整个 数据库 统统 加载 在 内存 当中 进行 操作 定期 通过 异步 操作 把 数据库 数据 flush 到 硬盘 上 进行 保存 因为 是 纯 内存 操作 redis 的 性能 非常 出色 每秒 可以 处理 超过 万次 读写 操作 是 已知 性能 最快 的 keyvaluedbredis 的 出色 之处 不仅仅是 性能 redis 最大 的 魅力 是 支持 保存 多种 数据结构 此外 单个 value 的 最大 限制 是 gb 不像 memcached 只能 保存 mb 的 数据 因此 redis 可以 用来 实现 很多 有用 的 功能 比方说 用他 的 list 来 做 fifo 双向 链表 实现 一个 轻量级 的 高性能 消息 队列 服务 用他 的 set 可以 做 高性能 的 tag 系统 等等 另外 redis 也 可 以对 存入 的 keyvalue 设置 expire 时间 因此 也 可以 被 当作 一个 功能 加强版 的 memcached 来用 redis 的 主要 缺点 是 数据库 容量 受到 物理 内存 的 限制 不能 用作 海量 数据 的 高性能 读写 因此 redis 适合 的 场景 主要 局限 在 较小 数据量 的 高性能 操 作和 运 算上 redis 相比 memcached 有 哪些 优势 memcached 所有 的 值 均是 简单 的 字符串 redis 作为 其 替代者 支持 更为 丰富 的 数据类型 redis 的 速度 比 memcached 快 很多 redis 可以 持久 化 其 数据 redis 支持 哪几种 数据类型 主要 消耗 什么 物理 资源 内存 redis 的 全称 是什么 有 哪几种 数据 淘汰 策略 noeviction 返回 错误 当 内存 限制 达到 并且 客户端 尝试 执 行会 让 更多 内存 被 使用 的 命令 大部分 的 写入 指令 但 del 和 几个 例外 allkeyslru 尝试 回收 最少 使用 的 键 lru 使得 新 添加 的 数据 有 空间 存放 volatilelru 尝试 回收 最少 使用 的 键 lru 但 仅限于 在 过期 集合 的 键 使得 新 添加 的 数据 有 空间 存放 allkeysrandom 回收 随机 的 键 使得 新 添加 的 数据 有 空间 存放 volatilerandom 回收 随机 的 键 使得 新 添加 的 数据 有 空间 存放 但 仅限于 在 过期 集合 的 键 volatilettl 回收 在 过期 集合 的 键 并且 优先 回收 存活 时间 ttl 较短 的 键 使得 新 添加 的 数据 有 空间 存放 redis 官方 为什么 不 提供 windows 版本 因为 目前 linux 版本 已经 相当 稳定 而且 用户量 很大 无需 开发 windows 版本 反而会 带来 兼容性 等 问题 一个 字符串 类型 的 值 能 存储 最大 容量 是多少 m 为什么 redis 需 要把 所有 数据 放到 内存 中 redis 为了 达到 最快 的 读写 速度 将 数据 都 读到 内存 中 并 通过 异步 的 方式 将 数据 写入 磁盘 所以 redis 具有 快速 和 数据 持久 化 的 特征 如果 不将 数据 放在 内存 中 磁盘 io 速度 会 严重影响 redis 的 性能 在 内存 越来越 便宜 的 今天 redis 将会 越来越 受欢迎 如果 设置 了 最大 使用 的 内存 则 数据 已有 记录 数 达到 内存 限值 后 不能 继续 插入 新 值 redis 集群 方案 应该 怎么做 都有 哪些 方案 codis 目前 用 的 最多 的 集群 方案 基本 和 twemproxy 一致 的 效果 但它 支持 在 节点 数量 改变 情况下 旧 节点 数据 可恢复 到 新 hash 节点 rediscluster 自带 的 集群 特点 在于 他 的 分布式 算法 不是 一致性 hash 而是 hash 槽 的 概念 以及 自身 支持 节点 设置 从 节点 具体 看 官方 文档 介绍 在 业务 代码 层 实现 起 几个 毫无 关联 的 redis 实例 在 代码 层 对 key 进行 hash 计算 然 后去 对应 的 redis 实例 操作 数据 这种 方式 对 hash 层 代码 要求 比较 高 考虑 部分 包括 节点 失效 后 的 替代 算法 方案 数据 震荡 后 的 自动 脚本 恢复 实例 的 监控 等等 redis 集群 方案 什么 情况下 会 导致 整个 集群 不可用 有 abc 三个 节点 的 集群 在 没有 复制 模型 的 情况下 如果 节点 b 失败 了 那么 整个 集群 就会 以为 缺少 这个 范围 的 槽 而 不可用 mysql 里 有 w 数据 redis 中 只 存 w 的 数据 如何 保证 redis 中 的 数据 都是 热点 数据 redis 内存 数据 集 大小 上 升到 一定 大小 的 时候 就会 施行 数据 淘汰 策略 redis 有 哪些 适合 的 场景 会话 缓存 sessioncache 最 常用 的 一种 使用 redis 的 情景 是 会话 缓存 sessioncache 用 redis 缓存 会话 比 其他 存储 如 memcached 的 优势 在于 redis 提供 持久 化 当 维护 一个 不是 严格要求 一致性 的 缓存 时 如果 用户 的 购物车 信息 全部 丢失 大部分 人 都会 不高兴 的 现在 他们 还会 这样 吗 幸运 的 是 随着 redis 这些年 的 改进 很 容易 找到 怎么 恰当 的 使用 redis 来 缓存 会话 的 文档 甚至 广 为人 知 的 商业 平台 magento 也 提供 redis 的 插件 全 页 缓存 fpc 除 基本 的 会话 token 之外 redis 还 提供 很 简便 的 fpc 平台 回到 一致 性问题 即使 重启 了 redis 实例 因为 有 磁盘 的 持久 化 用户 也 不会 看到 页面 加载 速度 的 下降 这是 一个 极大 改进 类似 php 本地 fpc 再次 以 magento 为 例 magento 提供 一个 插件 来 使用 redis 作为 全 页 缓存 后端 此外 对 wordpress 的 用户 来说 pantheon 有 一个 非常好 的 插件 wpredis 这个 插件 能 帮助 你 以 最快 速度 加载 你 曾 浏览 过 的 页面 队列 reids 在 内存 存储 引擎 领域 的 一大 优点 是 提供 list 和 set 操作 这 使得 redis 能 作为 一个 很好 的 消息 队列 平台 来 使用 redis 作为 队列 使用 的 操作 就 类似于 本地 程序语言 如 python 对 list 的 pushpop 操作 如果 你 快速 的 在 google 中 搜索 redisqueues 你 马上 就能 找到 大量 的 开源 项目 这些 项目 的 目的 就是 利用 redis 创建 非常好 的 后端 工具 以 满足 各种 队列 需求 例如 celery 有 一个 后台 就是 使用 redis 作为 broker 你 可以 从 这里 去 查看 排行榜 计数器 redis 在 内存 中 对 数字 进行 递增 或 递减 的 操作 实现 的 非常好 集合 set 和 有序 集合 sortedset 也 使得 我们 在 执行 这些 操作 的 时候 变 的 非常 简单 redis 只是 正好 提供 了 这两种 数据结构 所以 我们 要从 排序 集合 中 获 取到 排名 最 靠前 的 个 用户 我们 称之为 userscores 我们 只需要 像 下面 一样 执行 即可 当然 这是 假定 你 是 根据 你 用户 的 分数 做 递增 的 排序 如果 你想 返回 用户 及 用户 的 分数 你 需要 这样 执行 就是 一个 很好 的 例子 用 ruby 实现 的 它 的 排行榜 就是 使用 redis 来 存储 数据 的 你 可以 在这里 看到 发布 订阅 最后 但 肯定 不是 最不 重要 的 是 redis 的 发布 订阅 功能 发布 订阅 的 使用 场景 确实 非常 多 我 已 看见 人们 在 社交 网络连接 中 使用 还可 作为 基于 发布 订阅 的 脚本 触发器 甚至 用 redis 的 发布 订阅 功 能来 建立 聊天 系统 redis 支持 的 java 客户端 都有 哪些 官方 推荐 用 哪个 等等 官方 推荐 使用 redissonredis 和 redisson 有 什么关系 redisson 是 一个 高级 的 分布式 协调 redis 客服 端 能 帮助 用户 在 分布式 环境 中 轻松 实现 一些 java 的 对象 jedis 与 redisson 对比 有 什么 优缺点 jedis 是 redis 的 java 实现 的 客户端 其 api 提供 了 比较 全面 的 redis 命令 的 支持 redisson 实现 了 分布式 和 可 扩展 的 java 数据结构 和 jedis 相比 功能 较为 简单 不支持 字符串 操作 不支持 排序 事务 管道 分区 等 redis 特性 redisson 的 宗旨 是 促进 使用者 对 redis 的 关注 分离 从而 让 使用者 能够 将 精力 更 集中地 放在 处理 业务 逻辑 上 redis 如何 设置 密码 及 验证 密码 设置 密码 授权 密码 auth 说说 redis 哈希 槽 的 概念 redis 集群 没有 使用 一致性 hash 而是 引 入了 哈希 槽 的 概念 redis 集群 有 个 哈希 槽 每个 key 通过 crc 校验 后 对 取 模 来 决定 放置 哪个 槽 集群 的 每个 节点 负责 一部分 hash 槽 redis 集群 的 主从复制 模型 是 怎样 的 为了 使 在 部分 节点 失败 或者 大部分 节点 无法 通信 的 情况下 集群 仍然 可用 所以 集群 使 用了 主从复制 模型 每个 节点 都会 有 n 个 复制品 redis 集群 会有 写 操作 丢失 吗 为什么 redis 并不能 保证 数据 的 强 一致性 这 意味 在 实际 中 集群 在 特定 的 条件下 可能会 丢 失写 操作 redis 集群 之间 是 如何 复制 的 异步 复制 redis 集群 最大 节点 个数 是 多少个 redis 集群 如何 选择 数据库 redis 集群 目前 无法 做 数据库 选择 默认 在 数据库 怎么 测试 redis 的 连通性 pingredis 中 的 管道 有 什么用 一次 请求 响应 服务器 能 实现 处理 新 的 请求 即使 旧 的 请求 还 未被 响应 这样 就可以 将 多个 命令 发送到 服务器 而 不用 等待 回复 最后 在 一个 步骤 中 读取 该 答复 这 就是 管道 pipelining 是 一种 几十年来 广泛 使用 的 技术 例如 许多 pop 协议 已经 实现 支持 这个 功能 大大 加 快了 从 服务器 下载 新邮件 的 过程 怎么 理解 redis 事务 事务 是 一个 单独 的 隔离 操作 事务 中 的 所有 命令 都会 序列化 按 顺序 地 执行 事务 在 执行 的 过程中 不 会被 其他 客户端 发 送来 的 命令 请求 所 打断 事务 是 一个 原子 操作 事务 中 的 命令 要么 全部 被执行 要么 全部 都不 执行 redis 事务 相关 的 命令 有 哪几个 的 过期 时间 和 永久 有效 分别 怎么 设置 expire 和 persist 命令 redis 如何做 内存 优化 尽可能 使用 散 列表 hashes 散 列表 是 说 散 列表 里面 存储 的 数 少 使用 的 内存 非常 小 所以 你 应该 尽可能 的 将你 的 数据模型 抽象 到 一个 散 列表 里面 比如 你 的 web 系统 中有 一个 用户 对象 不 要为 这个 用户 的 名称 姓氏 邮箱 密码 设置 单独 的 key 而是 应该 把 这个 用户 的 所有 信息 存储 到 一张 散 列表 里面 redis 回收 进程 如何 工作 的 一个 客户端 运 行了 新 的 命令 添 加了 新 的 数据 redis 检查 内存 使用情况 如果 大于 maxmemory 的 限制 则 根据 设 定好 的 策略 进行 回收 一个 新 的 命令 被执行 等等 所以 我们 不断地 穿越 内存 限制 的 边界 通过 不断 达到 边界 然后 不断地 回收 回到 边界 以下 如果 一个 命令 的 结果 导致 大量 内存 被 使用 例如 很大 的 集合 的 交集 保 存到 一个 新 的 键 不用 多久 内存 限制 就会 被 这个 内存 使用量 超越 分布式数据库 mongodb 篇 你 说的 nosql 数据库 是什么 意思 nosql 与 rdbms 直接 有 什么区别 为什么 要 使用 和 不 使用 nosql 数据库 说一说 nosql 数据库 的 几个 优点 nosql 是非 关系 型 数据库 nosqlnotonlysql 关系 型 数据库 采用 的 结构化 的 数据 nosql 采用 的 是 键值 对 的 方式 存储 数据 在 处理 非 结构化 半 结构化 的 大 数据 时 在 水平 方向 上 进行 扩展 时 随时 应对 动态 增加 的 数据项 时 可以 优先 考虑 使用 nosql 数据库 在 考虑 数据库 的 成熟度 支持 分析 和 商业 智能 管理 及 专业性 等 问题 时 应 优先 考虑 关系 型 数据库 nosql 数据库 有 哪些 类型 例如 与 mongodb 之间 最基本 的 差别 是什么 mysql 和 mongodb 两者 都是 免费 开源 的 数据库 mysql 和 mongodb 有 许多 基本 差别 包括 数据 的 表示 查询 关系 事务 schema 的 设计 和 定义 标准化 normalization 速度 和 性能 通过 比较 mysql 和 mongodb 实际上 我们 是 在 比较 关系 型 和 非 关系 型 数据库 即 数据 存储 结构 不同 你 怎么 比较 mongodbcouchdb 及 和 couchdb 都是 面向 文档 的 数据库 mongodb 和 couchdb 都是 开源 nosql 数据库 的 最 典型 代表 除了 都以 文档 形式 存储 外 它们 没有 其他 的 共同点 mongodb 和 couchdb 在 数据模型 实现 接口 对象 存储 以及 复制 方法 等方面 有 很多 不同 mongodb 成为 最好 nosql 数据库 的 原因 是什么 以下 特点 使得 mongodb 成为 最好 的 nosql 数据库 面向 文件 的 高性能 高 可用性 易 扩展性 丰富 的 查询 语言 位 系统 上有 什么 细微差别 journaling 会 激活 额外 的 内存 映射 文件 这将 进一步 抑制 位 版本 上 的 数据库 大小 因此 现在 journaling 在位 系统 上 默认 是 禁用 的 journal 回 放在 条目 entry 不完整 时 比如 恰巧 有 一个 中途 故障 了 会 遇到问题 吗 每个 journal group 的 写 操作 都是 一致 的 除非 它是 完整 的 否 则在 恢复 过程中 它 不会 回放 分析器 在 mongodb 中 的 作用 是什么 mongodb 中 包括 了 一个 可以 显示 数据库 中 每个 操作 性能 特点 的 数据库 分析器 通过 这个 分析器 你 可以 找到 比 预期 慢 的 查询 或 写 操作 利用 这一 信息 比如 可以 确定 是否 需要 添加 索引 名字 空间 namespace 是什么 mongodb 存储 bson 对象 在 丛集 collection 中 数据库 名字 和 丛集 名字 以 句点 连接起来 叫做 名字 空间 namespace 如果 用户 移除 对象 的 属性 该 属性 是否 从 存储 层 中 删除 是的 用户 移除 属性 然后 对象 会 重新 保存 resave 能否 使用 日志 特征 进行 安全 备份 是的 允许 空 值 null 吗 对于 对象 成员 而言 是的 然而 用户 不能够 添加 空 值 null 到 数据库 丛集 collection 因为 空 值 不是 对象 然而 用户 能够 添加 空 对象 更新 操作 立刻 fsync 到 磁盘 不会 磁盘 写 操作 默认 是 延迟 执行 的 写 操作 可能在 两 三秒 默认 在 秒内 后 到达 磁盘 例如 如果 一 秒内 数据库 收到 一千个 对 一个 对象 递增 的 操作 仅 刷新 磁盘 一次 注意 尽管 fsync 选项 在 命令行 和 经过 getlasterrorold 是 有效 的 译者 也 许是 坑人 的 面试题 如何 执行 事务 加锁 mongodb 没有 使用 传统 的 锁 或者 复杂 的 带回 滚 的 事务 因为 它 设计 的 宗旨 是 轻 量 快速 以及 可 预计 的 高性能 可以 把 它 类比 成 mysqlmylsam 的 自动 提交 模式 通过 精简 对 事务 的 支持 性能 得 到了 提升 特别是在 一个 可能会 穿过 多个 服务器 的 系统 里 为什么 我 的 数据文件 如此 庞大 mongodb 会 积极 的 预 分配 预留 空间 来 防止 文件 系统 碎片 启用 备份 故障 恢复 需要 多久 从 备份 数据库 声 明主 数据库 宕机 到 选出 一个 备份 数据库 作为 新 的 主 数据库 将 花费 到 秒 时间 这 期间 在 主 数据库 上 的 操作 将会 失败 包括 写入 和 强 一致性 读取 操作 然而 你 还 能在 第二 数据库 上 执行 最终 一致性 查询 在 slaveok 模式 下 即使 在 这段 时 间里 什么 是 master 或 primary 它是 当前 备份 集群 replicaset 中 负责处理 所有 写入 操作 的 主要 节点 成员 在 一个 备份 集群 中 当 失效 备 援 failover 事件 发生 时 一个 另外 的 成员 会 变成 primary 什么 是 secondary 或 slaveseconday 从 当前 的 primary 上 复制 相应 的 操作 它是 通过 跟踪 复制 oplog localoplogrs 做到 的 我 必须 调用 getlasterror 来 确保 写 操作 生效 了 么 不用 不管 你 有没有 调用 getlasterror 又叫 safemode 服务器 做的 操作 都 一样 调用 getlasterror 只是 为了 确认 写 操作 成功 提交 了 当然 你 经常 想得到 确认 但是 写 操作 的 安全性 和 是否 生效 不是 由 这个 决定 的 我 应该 启动 一个 集群 分片 sharded 还是 一个 非 集群 分片 的 mongodb 环境 为 开发 便捷 起见 我们 建议 以 非 集群 分片 unsharded 方式 开始 一个 mongodb 环境 除非 一台 服务器 不足以 存放 你 的 初始 数据 集 从 非 集群 分片 升级到 集群 分片 sharding 是 无缝 的 所以 在你 的 数据 集 还 不是 很大 的 时候 没必要 考虑 集群 分片 sharding 分片 sharding 和 复制 replication 是 怎样 工作 的 每一个 分片 shard 是 一个 分区 数据 的 逻辑 集合 分片 可能 由 单一 服务器 或者 集群 组成 我们 推荐 为 每一个 分片 shard 使用 集群 数据 在 什么时候 才会 扩展到 多个 分片 shard 里 mongodb 分片 是 基于 区域 range 的 所以 一个 集合 collection 中 的 所有 的 对象 都被 存 放到 一个 块 chunk 中 只 有当 存在 多余 一个 块 的 时候 才会 有 多个 分片 获取 数据 的 选项 现在 每个 默认 块 的 大小 是 mb 所以 你 需要 至少 mb 空间 才 可以 实施 一个 迁移 当我 试图 更新 一个 正 在被 迁移 的 块 chunk 上 的 文档 时会 发生 什么 更新 操作 会 立即 发 生在 旧 的 分片 shard 上 然后 更改 才会 在所 有权 转移 前 复制到 新 的 分片 上 如果在 一个 分片 shard 停止 或者 很慢 的 时候 我 发起 一个 查询 会 怎样 如果 一个 分片 shard 停止 了 除非 查询 设置 了 partial 选项 否则 查询 会 返回 一个 错误 如果 一个 分片 shard 响应 很慢 mongodb 则会 等待 它 的 响应 我 可以 把 movechunk 目录 里 的 旧 文件 删除 吗 没问题 这些 文件 是 在 分片 shard 进行 均衡 操作 balancing 的 时候 产生 的 临时文件 一旦 这些 操作 已经 完成 相关 的 临时文件 也 应该 被删 除掉 但 目前 清理 工作 是 需要 手动 的 所以 请 小 心地 考虑 再 释放 这些 文件 的 空间 怎么 查看 mongo 正在 使用 的 链接 dbadmincommand connpoolstats 如果 块 移动 操作 movechunk 失败 了 我 需要 手动 清除 部分 转移 的 文档 吗 不需要 移动 操作 是 一致 consistent 并且是 确定性 的 deterministic 一次 失败 后 移动 操作 会 不断 重试 当 完成后 数据 只会 出现在 新 的 分片 里 shard 如果 我 在 使用 复制 技术 replication 可以 一部分 使用 日志 journaling 而其 他 部分 则不 使用 吗 可以 当 更新 一个 正 在被 迁移 的 块 chunk 上 的 文档 时会 发生 什么 更新 操作 会 立即 发 生在 旧 的 块 chunk 上 然后 更改 才会 在所 有权 转移 前 复制到 新 的 分片 上 mongodb 在 abc 上 建立 索引 查询 abc 和 acb 都会 使用 索引 吗 不会 只 会在 abc 上 使用 索引 如果 一个 分片 shard 停止 或 很慢 的 时候 发起 一个 查询 会 怎样 如果 一个 分片 停止 了 除非 查询 设置 了 partial 选项 否则 查询 会 返回 一个 错误 如果 一个 分片 响应 很慢 mongodb 会 等待 它 的 响应 mongodb 支持 存储 过程 吗 如果 支持 的话 怎么 用 mongodb 支持 存储 过程 它是 javascript 写 的 保 存在 dbsystemjs 表 中 如何 理解 mongodb 中 的 gridfs 机制 mongodb 为何 使用 gridfs 来 存储 文件 gridfs 是 一种 将 大型 文件 存储 在 mongodb 中 的 文件 规范 使用 gridfs 可以 将 大文件 分 隔成 多个 小 文档 存放 这样 我们 能够 有效 的 保存 大 文档 而且 解决 了 bson 对象 有 限制 的 问题 分布式数据库 是 怎么 工作 的 memcached 的 神奇 来自 两 阶段 哈希 twostagehash memcached 就像 一个 巨大 的 存储 了 很多 ltkeyvaluegt 对 的 哈希 表 通过 key 可以 存储 或 查询 任意 的 数据 客户端 可以 把 数据 存储 在 多台 memcached 上当 查询 数据 时 客户端 首先 参考 节点 列表 计算出 key 的 哈希 值 阶段 一 哈希 进而 选中 一个 节点 客户端 将 请求 发送给 选中 的 节点 然后 memcached 节点 通过 一个 内部 的 哈希 算法 阶段 二 哈希 查找 真正 的 数据 item 举个 列子 假设有 个 客服 端 台 想把 数据 barbaz 以 keyfoo 存储 client 首先 参考 节点 列表 abc 计算 keyfoo 的 哈希 值 假设 memcachedb 被 选中 接着 client 直接 connect 到 memcachedb 通过 keyfoo 把 数据 barbaz 存储 进去 client 使用 与 client 相同 的 客户端 库 意味着 阶段 一 的 哈希 算法 相同 也 拥有 同样 的 memcached 列表 abc 于是 经过 相同 的 哈希 计算 阶段 一 client 计算出 keyfoo 在 memcachedb 上 然后 它 直接 请求 memcachedb 得到 数据 barbaz 各种 客户端 在 memcached 中 数据 的 存储 形式 是 不同 的 等 一些 客户端 实现 的 哈希 算法 也 不一样 但是 memcached 服务器端 的 行为 总是 一致 的 最后 从 实现 的 角度 看 memcached 是 一个 非 阻塞 的 基于 事件 的 服务器 程序 这种 架构 可以 很好 地 解决 ckproblem 并 具有 极佳 的 可 扩展性 可以 参考 astoryofcaching 这篇 文章 简单 解释 了 客户端 与 memcached 是 如何 交互 的 memcached 最大 的 优势 是什么 请 仔细阅读 上面 的 问题 即 memcached 是 如何 工作 的 memcached 最大 的 好处 就是 它 带 来了 极佳 的 水平 可 扩展性 特别是在 一个 巨大 的 系统 中 由于 客户端 自己 做了 一次 哈希 那么 我们 很 容易 增加 大量 memcached 到 集群 中 memcached 之间 没有 相互 通信 因此 不会 增加 memcached 的 负载 没有 多 播 协议 不会 网络 通信量 爆炸 implode memcached 的 集群 很 好用 内存 不 够了 增加 几台 memcached 吧 cpu 不够 用了 再 增加 几台 吧 有 多余 的 内 存在 增加 几台 吧 不要 浪 费了 基于 memcached 的 基本原则 可以 相当 轻松 地 构 建出 不同 类型 的 缓存 架构 除了 这篇 faq 在其 他 地方 很 容易 找到 详细资料 的 memcached 和 mysql 的 querycache 相比 有 什么 优缺点 把 memcached 引入 应用 中 还是 需要 不少 工作量 的 mysql 有 个 使用方便 的 querycache 可以 自 动地 缓存 sql 查询 的 结果 被 缓存 的 sql 查询 可以 被 反复 地 快速 执行 memcached 与 之 相比 怎么样 呢 mysql 的 querycache 是 集中式 的 连 接到 该 querycache 的 mysql 服务器 都会 受益 当 您 修改 表 时 mysql 的 querycache 会 立刻 被 刷新 flush 存储 一个 memcacheditem 只需要 很少 的 时间 但是 当 写 操作 很 频繁 时 mysql 的 querycache 会 经常 让 所有 缓存 数据 都 失效 在 多核 cpu 上 mysql 的 querycache 会 遇到 扩展 问题 在 多核 cpu 上 querycache 会 增加 一个 全局 锁 globallock 由于 需要 刷新 更多 的 缓存 数据 速度 会 变得 更慢 在 mysql 的 querycache 中 我们 是 不能 存储 任意 的 数据 的 只能 是 sql 查询 结果 而 利用 memcached 我们 可以 搭 建出 各种 高效 的 缓存 比如 可以 执行 多个 独立 的 查询 构 建出 一个 用户 对象 userobject 然后 将 用户 对象 缓 存到 memcached 中 而 querycache 是 sql 语句 级别 的 不可能 做到 这一 点在 小 的 网站 中 querycache 会 有所 帮助 但随着 网站 规模 的 增加 querycache 的 弊 将 大于利 querycache 能够 利用 的 内存容量 受到 mysql 服务器 空闲 内存空间 的 限制 给 数据库 服务器 增加 更多 的 内存 来 缓存 数据 固然是 很好 的 但是有 了 memcached 只要 您有 空闲 的 内存 都可以 用来 增加 memcached 集群 的 规模 然后 您就 可以 缓存 更多 的 数据 memcached 和 服务器 的 localcache 比如 php 的 apcmmap 文件 等 相比 有 什么 优缺点 首先 localcache 有 许 多与 上面 querycache 相同 的 问题 localcache 能够 利用 的 内存容量 受到 单 台 服务器 空闲 内存空间 的 限制 不过 localcache 有 一点 比 memcached 和 querycache 都 要好 那就是 它不 但可以 存储 任意 的 数据 而且 没有 网络 存取 的 延迟 localcache 的 数据 查询 更快 考虑 把 highlycommon 的 数据 放在 localcache 中 吧 如果 每个 页面 都 需要 加载 一些 数量 较少 的 数据 考虑 把 它们 放在 localcache 吧 localcache 缺少 集体 失效 的 特性 在 memcached 集群 中 删除 或 更新 一个 key 会 让 所有 的 观察者 觉察到 但是在 localcache 中 我们 只能 通知 所有 的 服务器 刷新 cache 很慢 不具 扩展性 或者 仅仅 依赖 缓存 超时 失效 机制 localcache 面临着 严重 的 内存 限制 这一点 上面 已经 提到 memcached 的 cache 机制 是 怎样 的 memcached 主要 的 cache 机制 是 lru 最近 最 少用 算法 超时 失效 当 存 数据 到 memcached 中 可以 指定 该 数据 在 缓存 中 可以 呆 多久 如果 memcached 的 内存 不够 用了 过期 的 slabs 会 优先 被 替换 接着 就 轮到 最 老 的 未被 使用 的 slabsmemcached 如何 实现 冗余 机制 不 实现 我们 对 这个 问题 感到很 惊讶 memcached 应该是 应用 的 缓存 层 它 的 设计 本身 就不 带有 任何 冗余 机制 如果 一个 memcached 节点 失去了 所有 数据 您 应该 可以 从 数据源 比如 数据库 再次 获 取到 数据 您 应该 特别注意 您 的 应用 应该 可以 容忍 节点 的 失效 不 要写 一些 糟糕 的 查询 代码 寄希望于 memcached 来 保证 一切 如果您 担心 节点 失效 会 大大 加重 数据库 的 负担 那么 您 可以 采取 一些 办法 比如 您 可以 增加 更多 的 节点 来 减少 丢失 一个 节点 的 影响 热 备 节点 在其 他 节点 down 了 的 时候 接管 ip 等等 memcached 如何 处理 容错 的 不 处理 在 memcached 节点 失效 的 情况下 集群 没有必要 做 任何 容错 处理 如果 发 生了 节点 失效 应对 的 措施 完全 取决于 用户 节点 失效 时 下面 列出 几种 方案 供 您 选择 忽略 它 失效节点 被 恢复 或 替换 之前 还有 很多 其他 节点 可以 应对 节点 失效 带来 的 影响 把 失效 的 节点 从 节点 列表 中 移除 做 这个 操作 千万 要 小心 在 默认 情况下 余数 式 哈希 算法 客户端 添加 或 移除 节点 会 导致 所有 的 缓存 数据 不可用 因为 哈希 参照 的 节点 列表 变 化了 大部分 key 会 因为 哈希 值 的 改变 而 被 映 射到 与 原来 不同 的 节点 上 启动 热 节点 接管 失效节点 所 占用 的 ip 这样 可以 防止 哈希 紊乱 hashingchaos 如果 希望 添加 和 移除 节点 而 不影响 原先 的 哈希 结果 可以 使用 一致性 哈希 算法 您 可以 百度 一下 一致性 哈希 算法 支持 一致性 哈希 的 客户端 已经 很 成熟 而且 被 广泛 使 用去 尝试 一下 吧 两次 哈希 reshing 当 客户端 存取 数据 时 如果 发现 一个 节点 down 了 就 再做 一次 哈希 哈希 算法 与 前 一次 不同 重新 选择 另一个 节点 需要 注意 的 时 客户端 并没有 把 down 的 节点 从 节点 列表 中 移除 下次 还是 有 可能 先 哈希 到 它 如果 某个 节点 时好时坏 两次 哈希 的 方法 就有 风险 了 好 的 节点 和 坏 的 节点 上 都 可能 存在 脏 数据 staledata 如何将 memcached 中 item 批量 导入 导出 您不 应该 这样 做 memcached 是 一个 非 阻塞 的 服务器 任何 可能 导致 memcached 暂停 或 瞬时 拒绝服务 的 操作 都应该 值得 深思熟虑 向 memcached 中 批量 导入 数据 往往 不是 您 真正 想要 的 想象 看 如果 缓存 数据 在 导出 导入 之间 发 生了 变化 您就 需要 处理 脏 数据 了 如果 缓存 数据 在 导出 导入 之间 过期 了 您 又 怎么 处理 这些 数据 呢 因此 批量 导出 导入 数据 并不 像您 想象 中 的 那么 有用 不过 在 一个 场景 倒是 很 有用 如果 您有 大量 的 从不 变化 的 数据 并且 希望 缓存 很快 热 warm 起来 批量 导入 缓存 数据 是 很有 帮助 的 虽然 这个 场景 并不 典型 但却 经常 发生 因此 我们 会 考虑 在 将来 实现 批量 导出 导入 的 功能 我 需 要把 memcached 中 的 item 批量 导出 导入 怎么办 如果 需要 批量 导出 导入 最 可能 的 原因 一般 是 重新 生成 缓存 数据 需要 消耗 很长 的 时间 或者 数据库 坏了 让 您 饱受 痛苦 如果 一个 memcached 节点 down 了 让 您 很 痛苦 那么 您 还会 陷入 其他 很多 麻烦 您 的 系统 太 脆弱 了 您 需 要做 一些 优化 工作 比如 处理 集群 问题 比如 memcached 节点 都 失效 了 反复 的 查询 让 您 的 数据库 不堪重负 这个 问 题在 faq 的 其他 提 到过 或者 优化 不好 的 查询 记住 memcached 并不是 您 逃避 优化 查询 的 借口 如果您 的 麻烦 仅仅是 重新 生成 缓存 数据 需要 消耗 很长 时间 秒 到 超过 分钟 您 可以 考虑 重新 使用 数据库 这里 给出 一些 提示 使用 mogilefs 或者 couchdb 等 类似 的 软件 在 存储 item 把 item 计算出来 并 dump 磁 盘上 mogilefs 可以 很 方便地 覆 写 item 并 提供 快速 地 访问 您 甚至 可以 把 mogilefs 中 的 item 缓 存在 memcached 中 这样 可以 加快 读取 速度 的 组合 可以 加快 缓存 不 命中 时 的 响应速度 提高 网站 的 可用性 重新 使用 mysqlmysql 的 innodb 主键 查询 的 速度 非常快 如果 大部分 缓存 数据 都可以 放到 varchar 字段 中 那么 主键 查询 的 性 能将 更好 从 memcached 中 按 key 查询 几乎 等价 于 mysql 的 主键 查询 将 key 哈希 到 bit 的 整数 然后 将 数据 存储 到 mysql 中 您 可以 把 原始 不做 哈希 的 key 存储 都 普通 的 字段 中 然后 建立 二级 索 引来 加快 查询 key 被 动地 失效 批量 删除 失效 的 key 等等 上面 的 方法 都可以 引入 memcached 在 重启 memcached 的 时候 仍然 提供 很好 的 性能 由于 不需要 当心 hot 的 item 被 memcachedlru 算法 突然 淘汰 用户 再也 不用 花 几分钟 来 等待 重新 生成 缓存 数据 当 缓存 数据 突然 从 内存 中 消 失时 因此 上面 的 方法 可以 全面提高 性能 memcached 是 如何做 身份验证 的 没有 身份 认证 机制 memcached 是 运 行在 应用 下层 的 软件 身份验证 应该是 应用 上层 的 职责 memcached 的 客户端 和 服务器端 之 所以是 轻量级 的 部分 原因 就是 完全 没有 实现 身份验证 机制 这样 memcached 可以 很 快地 创建 新 连接 服务器端 也 无需 任何 配置 如果您 希望 限制 访问 您可 以 使用 防火墙 或者 让 memcached 监听 的 多线程 是什么 如何 使用 它们 线程 就是 定律 threadsrule 在 stevengrimm 和 facebook 的 努力 下 memcached 及 更高 版本 拥有 了 多线程 模式 多线程 模式 允许 memcached 能够 充分利用 多个 cpu 并在 cpu 之间 共享 所有 的 缓存 数据 memcached 使用 一种 简单 的 锁 机制 来 保证 数据 更新 操作 的 互斥 相比 在 同一个 物理 机器 上 运行 多个 memcached 实例 这种 方式 能够 更 有效地 处理 multigets 如果您 的 系统 负载 并 不重 也许 您不 需要 启用 多线程 工作 模式 如果 您在 运行 一个 拥有 大规模 硬件 的 庞大 的 网站 您将 会 看到 多线程 的 好处 简单 地 总结 一下 命令 解析 memcached 在这里 花了 大部分 时间 可以 运 行在 多线程 模式 下 memcached 内部 对 数据 的 操作 是 基于 很多 全局 锁 的 因此 这部 分 工作 不是 多线程 的 未来 对 多线程 模式 的 改进 将 移除 大量 的 全局 锁 提高 memcached 在 负载 极高 的 场景 下 的 性能 memcached 能 接受 的 key 的 最大 长度 是多少 key 的 最大 长度 是 个字符 需要 注意 的 是 是 memcached 服务器端 内部 的 限制 如果您 使用 的 客户端 支持 key 的 前缀 或 类似 特性 那么 key 前缀 原始 key 的 最大 长度 是 可以 超过 个字符 的 我们 推荐 使用 使用 较短 的 key 因为 可以 节省 内存 和 带宽 memcached 对 item 的 过期 时间 有 什么 限制 过期 时间 最大 可以 达到 天 memcached 把 传入 的 过期 时间 时间段 解释 成 时间 点 后 一旦 到了 这个 时间 点 memcached 就把 item 置 为 失效 状态 这是 一个 简单 但 obscure 的 机制 memcached 最大 能 存储 多大 的 单个 itemmb 如果 你 的 数据 大于 mb 可以 考虑 在 客户端 压缩 或 拆 分到 多个 key 分布式 中间件 面试 合 辑 word 文档 下载 地址 链接 提 取码 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 性能 调 优 合集 jvm 性能 优化 面试 篇 描述 下 java 类 加载 过程 java 类 加载 需要 经历 以 下个 过程 加载 加载 是 类 加载 的 第一个 过程 在 这个 阶段 将 完成 以下 三件 事情 通过 一个 类 的 全 限 定名 获取 该类 的 二进制 流 将该 二进制 流 中 的 静态 存储 结构 转 化为 方法 去 运行时 数据结构 在 内存 中 生成 该类 的 class 对象 作为 该类 的 数据 访问 入口 验证 验证 的 目的 是为了 确保 class 文件 的 字 节流 中 的 信息 不回 危害到 虚拟机 在 该 阶段 主要 完成 以下 四钟 验证 文件 格式 验证 验证 字 节流 是否 符合 class 文件 的 规范 如 主次 版本号 是否 在 当前 虚拟机 范围内 常量 池中 的 常量 是否 有 不被 支持 的 类型 元 数据 验证 对 字节 码 描述 的 信息 进行 语义 分析 如 这个 类 是否 有 父 类 是否 集 成了 不被 继承 的 类 等 字节 码 验证 是 整个 验证 过程 中最 复杂 的 一个 阶段 通过 验证 数据流 和 控制 流 的 分析 确定 程序 语义 是否 正确 主要 针对 方 法体 的 验证 如 方法 中 的 类型 转换 是否 正确 跳转 指令 是否 正确 等 符号 引用 验证 这个 动作 在后 面的 解析 过程中 发生 主要 是为了 确保 解析 动作 能 正确 执行 准备 准备 阶段 是 为 类 的 静态 变量 分配 内存 并 将其 初始 化为 默认值 这些 内存 都 将在 方法 区 中 进行 分配 准备 阶段 不 分配 类 中 的 实例 变量 的 内存 实例 变量 将会 在 对象 实例 化时 随着 对象 一起 分 配在 java 堆 中 在 准备 阶段 value 初始值 为 在 初始化 阶段 才会 变为 解析 该 阶段 主要 完成 符号 引 用到 直接 引用 的 转换 动作 解析 动作 并不一定 在 初始化 动作 完成 之前 也有 可能在 初始化 之后 初始化 初始化 是 类 加载 的 最后 一步 前面 的 类 加载 过程 除了 在 加载 阶段 用户 应用程序 可以 通过 自定义 类 加载 器 参与 之外 其余 动作 完 全由 虚拟机 主导 和 控制 到了 初始化 阶段 才 真正 开始 执行 类 中 的 定义 的 iava 程序代码 使用 卸载 java 内存 分配 寄存器 我们 无法控制 静态 域 static 定义 的 静态 成员 常量 池 编译 时 被 确定 并 保 存在 class 文件 中 的 finau 常 量值 和 一些 文本 修饰 的 符号 引用 类 和 接口 的 全 限定 名 字段 的 名称 和 描述符 方法 和 名称 和 描述符 非 ram 存储 硬盘 等 永久 存储空间 堆 内存 new 创建 的 对象 和 数组 由 java 虚拟机 自动 垃圾 回收 器 管理 存取 速度慢 栈 内存 基本 类型 的 变量 和 对象 的 引用 变量 堆 内存空间 的 访问 地址 速度快 可以 共享 但是 大小 与 生存期 必须 确定 缺乏 灵活性 java 堆 的 结构 是什么 样子 的 什么 是 堆 中 的 永久 代 permgenspace jvm 的 堆 是 运行时 数据 区 所有 类 的 实例 和 数组 都是 在 堆上 分配 内存 它在 jvm 启动 的 时候 被 创建 对象 所占 的 堆 内存 是 由 自动 内存 管理 系统 也 就是 垃圾 收集器 回收 堆 内存 是 由 存活 和 死亡 的 对象 组成 的 存活 的 对 象是 应用 可以 访问 的 不 会被 垃圾 回收 死亡 的 对 象是 应用 不可 访问 尚且 还没有 被 垃圾 收集器 回 收掉 的 对象 一 直到 垃圾 收集器 把 这些 对象 回 收掉 之前 他们 会 一直 占据 堆 内存空间 描述 一下 jvm 加载 class 文件 的 原理 机制 java 语言 是 一种 具有 动态 性 的 解释 型 语言 类 class 只有 被 加 载到 jvm 后 才能 运 行当 运行 指定 程 序时 jvm 会将 编译 生成 的 class 文件 按照 需 求和 一定 的 规则 加 载到 内存 中 并 组织 成为 个 完整 的 java 应用程序 这个 加载 过程 是 由 类 加载 器 完成 具体来说 就是 由 classloader 和它 的 子类 来 实现 的 类 加载 器 本身 也是 一个 类 其实质 是 把 类 文件 从 硬盘 读 取到 内存 中 类 的 加载 方式 分为 隐 式 加载 和 显示 加载 隐 式 加载 指的是 程序 在 使用 new 等 方式 创建 对象 时会 隐 式 地 调用 类 的 加载 器 把 对应 的 类 加 载到 jvm 中 显示 加载 指的是 通过 直接 调用 classforname 方法来 把 所需 的 类 加 载到 jvm 中 任何 一个 工程项目 都是 由 许多 类 组成 的当 程序 启动时 只 把 需要 的 类 加 载到 jvm 中 其他 类 只有 被 使 用到 的 时候 才 会被 加载 采用 这种 方法 一方面 可以 加快 加载 速度 另一方面 可以 节约 程序 运行时 对 内存 的 开销 此 外在 java 语 言中 每个 类 或 接口 都 对应 一个 class 文件 这些 文件 可以 被 看成是 一个个 可以 被 动态 加载 的 单元 因此 当 只有 部 分类 被 修 改时 只需要 重新 编译 变化 的 类 即可 而 不需要 重新 编译 所有 文件 因此 加 快了 编译 速度 在 java 语 言中 类 的 加载 是 动态 的 它 并不会 一次性 将 所有 类 全部 加载 后 再运行 而是 保证 程序 运行 的 基础 类 例如 基 类 完全 加 载到 jvm 中 至于 其他 类 则在 需要 的 时候 才 加载 类 加载 的 主要 步骤 装载 根据 查找 路径 找到 相应 的 class 文件 然后 导入 链接 链接 又可 分为 个 小步 检查 检查 待 加载 的 class 文件 的 正确性 准备 给 类 中 的 静态 变量 分配 存储空间 解析 将 符号 引用 转 换为 直接 引用 这一步 可选 初始化 对 静态 变量 和 静态 代码 块 执行 初始化 工作 gc 是什么 为什么 会有 gc 要有 gcgc 是 垃圾 收集 的 意思 内存 处理 是 编程 人员 容易 出现问题 的 地方 忘记 或者 错误 的 内存 回收 会 导致 程序 或 系统 的 不稳定 甚至 崩溃 java 提供 的 gc 功能 可以 自动 监测 对象 是否 超过 作用 域 从而 达到 自动 回收 内存 的 目的 java 语言 没有 提供 释放 已 分配 内存 的 显示 操作方法 简述 java 垃圾 回收 机制 在 java 中 程序员 是 不需要 显示 的 去 释放 一个 对象 的 内存 的 而是 由 虚拟机 自行 执 行在 jvm 中有 一个 垃圾 回收 线程 它是 低 优先级 的 在 正常 情况下 是 不会 执行 的 只有 在 虚拟机 空闲 或者 当前 堆 内存不足 时 才会 触发 执行 扫 面 那些 没有 被 任何 引用 的 对象 并将 它们 添加到 要 回收 的 集合 中 进行 回收 如何 判断 一个 对象 是否 存活 或者 gc 对象 的 判定 方法 判断 一个 对象 是否 存活 有 两种 方法 引用 计数 法 所谓 引用 计数 法 就是 给 每一个 对象 设置 一个 引用 计数器 每当 有 个 地方 引用 这个 对象 时 就将 计数器 加 一 引用 失效 时 计数器 就 减 一当 一个 对象 的 引用 计数器 为 零时 说明 此 对象 没有 被 引用 也 就是 死 对象 将 会被 垃圾 回收 引用 计数 法 有 一个 缺陷 就是 无法 解决 循环 引用 问题 也就是说 当 对象 a 引用 对象 b 对象 b 又 引用 者 对象 a 那么 此时 ab 对象 的 引用 计数器 都 不为 零 也就 造成 无法 完成 垃圾 回收 所以 主流 的 虚拟机 都没有 采用 这种 算法 可达性 算法 引用 链 法 该 算法 的 思想 是 从一 个 被称为 gcroots 的 对象 开始 向下 搜索 如果 一个 对象 到 gcroots 没有 任何 引用 链 相连 时 则 说明 此 对象 不可 用在 java 中 可以 作为 gcroots 的 对象 有 以下 几种 虚拟机 栈 中 引用 的 对象 方法 区 类 静态 属性 引用 的 对象 方法 区 常量 池 引用 的 对象 本地 方法 栈 jnl 引用 的 对象 虽然 这些 算法 可以 判定 一个 对象 是否能 被 回收 但是 当 满足 上述 条件 时 一个 对象 并不一定 会被 回收 当 一个 对象 不 可达 gcroot 时 这个 对象 并不会 立马 被 回收 而是 处于 一个 死缓 的 阶段 若 要被 真正 的 回收 需要 经历 两次 标记 如果 对象 在 可达性 分析 中 没有 与 gcroot 的 引用 链 那么 此时 就 会被 第一次 标记 并且 进行 一次 筛选 筛选 的 条件 是 是否 有 必要 执行 finalize 方法 当 对象 没有 覆盖 finalize 方法 或者 已被 虚拟机 调 用过 那么 就 认为是 没必要 的 如果 该 对象 有 必要 执行 finalize 方法 那么 这个 对象 将会 放在 一个 称为 fqueue 的 对 队列 中 虚拟 机会 触发 一个 finalize 线程 去 执行 此 线程 是 低 优先级 的 并且 虚拟机 不会 承诺 一直 等待 它 运行 完 这是 因为 如果 finalize 执行 缓慢 或者 发 生了 死锁 那么 就会 造成 fqueue 队列 一直 等待 造成了 内存 回收 系统 的 崩溃 gc 对 处于 fqueue 中 的 对象 进行 第二次 被 标记 这时 该 对象 将被 移除 即将 回收 集合 等待 回收 垃圾 回收 的 优点 和 原理 并 考虑 种 回收 机制 java 语言 中一 个 显著 的 特点 就是 引 入了 垃圾 回收 机制 使 c 程序员 最 头疼 的 内存 管理 的 问题 迎刃而解 它 使得 java 程序员 在 编写程序 的 时候 不再 需要 考虑 内存 管理 由于 有 个 垃圾 回收 机制 java 中 的 对象 不再 有 作用 域 的 概念 只有 对象 的 引用 才有 作用 域 垃圾 回收 可以 有效 的 防止 内存 泄露 有效 的 使用 可以 使用 的 内存 垃圾 回收 器 通常是 作为 个 单独 的 低级 别的 线程 运行 不可 预知 的 情况下 对 内存 堆 中 已经 死亡 的 或者 长时间 没有 使用 的 对象 进行 清楚和 回收 程序员 不能 实时 的 调用 垃圾 回收 器 对 某个 对象 或 所有 对象 进行 垃圾 回收 回收 机制 有 分 代 复制 垃圾 回收 和 标记 垃圾 回收 增量 垃圾 回收 垃圾 回收 器 的 基本原理 是什么 垃圾 回收 器 器 可以 马上 回收 内存 吗 有 什么 办法 主动 通知 虚拟机 进行 垃圾 回收 对于 gc 来说 当 程序员 创建 对象 时 gc 就 开始 监控 这个 对象 的 地 t 大小 以及 使用情况 通常 gc 采用 有 向 图 的 方式 记录 和 管理 堆 heap 中 的 所有 对象 通过 这种 方式 确定 哪些 对 象是 可达 的 哪些 对 象是 不 可达 的当 gc 确定 一些 对象 为 不 可达 时 gc 就有 责任 回收 这些 内存空间 可以 程序员 可以 手动 执行 systemgc 通知 gc 运行 但是 java 语言 规范 并不 保证 gc 一 定会 执行 java 中会 存在 内存 泄漏 吗 请 简单 描述 所谓 内存 泄露 就是指 一个 不 再被 程序 使用 的 对象 或 变量 一直 被 占据 在 内存 中 java 中有 垃圾 回收 机制 它 可以 保证 一 对象 不 再被 引用 的 时候 即 对象 变 成了 孤儿 的 时候 对象 将 自动 被 垃圾 回收 器 从 内存 中 清 除掉 由于 java 使用 有 向 图 的 方式 进行 垃圾 回收 管理 可以 消除 引用 循环 的 问题 例如 有 两个 对象 相互 引用 只要 它们 和 根 进程 不 可达 的 那么 gc 也是 可以 回收 它们 的 例如 下面 的 代码 可以 看到 这种 情况 的 内存 回收 stringargs catch ioexceptione hasexitedgctest systeminread systeminread outbegingc for intiilti systemgc systeminread systeminread systeminread systeminread systeminread psetmate p psetmate p systeminread systeminread systemgc exitgctest personother mateotherjava 中 的 内存 泄露 的 情况 长 生命周期 的 对象 持有 短 生命周期 对象 的 引用 就很 可能发生 内存 泄露 尽管 短 生命周期 对象 已经 不再 需要 但是 因为 长 生命周期 对象 持有 它 的 引用 而 导致 不能 被 回收 这 就是 java 中 内存 泄露 的 发生 场景 通俗 地 说 就是 程序员 可能 创 建了 一个 对象 以后 一直 不再 使用 这个 对象 这个 对象 却 一直 被 引用 即 这个 对象 无用 但是 却 无法 被 垃圾 回收 器 回收 的 这 就是 java 中 可能 出现 内存 泄露 的 情况 例如 缓存 系统 我们 加载 了 一个 对象 放在 缓存 中 例如 放在 一个 全局 map 对象 中 然后 一直 不再 使 用它 这个 对象 一直 被 缓存 引用 但却 不 再被 使用 检查 java 中 的 内存 泄露 一定 要让 程序 将 各种 分支 情况 都 完整 执行 到 程序 结束 然后 看 某个 对象 是否 被 使 用过 如果 没有 则 才能 判定 这个 对象 属于 内存 泄露 如果 一个 外 部类 的 实例 对象 的 方法 返 回了 一个 内 部类 的 实例 对象 这个 内 部类 对象 被 长期 引 用了 即使 那个 外 部类 实例 对象 不 再被 使用 但由于 内 部类 持久 外 部类 的 实例 对象 这个 外 部类 对象 将不 会被 垃圾 回收 这也 会 造成 内存 泄露 下面 内容 来自于 网上 主要特点 就是 清空 堆栈 中 的 某个 元素 并不是 彻底 把 它从 数组 中 拿掉 而是 把 存储 的 总数 减少 本人 写得 可以 比 这个 好在 拿掉 某个 元素 时 顺便 也 让 它从 数组 中 消失 将 那个 元素 所在 的 位置 的 值 设置 为 null 即可 我 实在 想不到 比 那个 堆栈 更 经典 的 例子 了 以致 于我 还要 引用 别人 的 例子 下面 的 例子 不是 我 想到 的 是 书上 看到 的 当然 如果 没有 在 书上 看到 可能 过一段时间 我 自己 也 想 的 到 可是 那时 我 说是 我 自己 想到 的 也 没有人 相信 的 objecte ensurecapacity if size if 上面 的 原理 应该 很简单 假如 堆栈 加了 个 元素 然后 全部 弹出来 虽然 堆栈 是 空 的 没有 我们 要 的 东西 但是 这是 个 对 象是 无法 回收 的 这个 才 符合 了 内存 泄露 的 两个 条件 无用 无法 回收 但是 就是 存在 这样 的 东西 也 不一 定会 导致 什么样 的 后果 如果 这个 堆栈 用 的 比 较少 也就 浪 费了 几个 k 内存 而已 反正 我们 的 内存 都上 g 了 哪里 会有 什么 影响 再说 这个 东西 很快 就 会被 回收 的 有 什么关系 staticspush newobject spop 这里有 个 对象 发生 内存 泄露 spush newobject 上面 的 对象 可以 被 回 收了 等于是 自愈 了 下面 看 两个 例子 因为 是 static 就 一直 存 在到 程序 退出 但是 我们 也 可以 看到 它有 自愈 功能 就是说 如果 你 stack 最多 有 个 对象 那么 最多 也就 只有 个 对象 无法 被 回收 其实 这个 应该 很 容易 理解 stack 内部 持有 个 引用 最坏 的 情况 就是 他们 都是 无用 的 因为 我们 一旦 放 新 的 进取 以前 的 引用 自然 消失 内存 泄露 的 另外 一种 情况 当 一个 对象 被 存储 进 hashset 集合 中 以后 就不能 修改 这个 对象 中 的 那些 参与 计算 哈希 值 的 字段 了 否则 对象 修改后 的 哈希 值 与 最初 存储 进 hashset 集合 中 时 的 哈希 值 就 不同 了 在 这种 情况下 即使 在 contains 方法 使用 该 对象 的 当前 引用 作为 的 参 数去 hashset 集合 中 检索 对象 也 将 返回 找不到 对象 的 结果 这也 会 导致 无法 合 中 检索 对象 也 将 返回 找不到 对象 的 结果 这也 会 导致 无法 从 hashset 集合 中 单独 删除 当前 对象 造成 内存 泄露 什么 是 深 拷贝 什么 是 浅 拷贝 简单 来讲 就是 复制 克隆 张三 浅 拷贝 就是 对 对象 中 的 数据 成员 进行 简单 赋值 如果 存在 动态 成员 或者 指针 就会 报错 深 拷贝 就是 对 对象 中 存在 的 动态 成员 或 指针 重新 开辟 内存空间 systemgc 和 runtimegc 会做 什么事情 这两个 方法 用来 提示 jvm 要 进行 垃圾 回收 但是 立即 开始 还是 延迟 进行 垃圾 回收 是 取决于 jvm 的 finalize 方法 什么时候 被 调用 析 构 函数 finalization 的 目的 是什么 垃圾 回收 器 garbagecolector 决定 回收 某 对象 时 就会 运行 该 对象 的 finalize 方法 但是在 java 中 很 不幸 如果 内存 总是 充足 的 那么 垃圾 回收 可能 永远 不会 进行 也就是说 filalize 可能 永远 不被 执行 显然 指望 它 做 收尾 工作 是 靠不住 的 那么 finalize 究竟是 做什么 的 呢 它最 主要 的 用途 是 回收 特殊 渠道 申请 的 内存 java 程序 有 垃圾 回收 器 所以 一般 情况下 内存 问题 不用 程序员 操心 但有 一种 jni 调用 nonjava 程序 c 或 c finalize 的 工作 就是 回收 这 部分 的 内存 如果 对象 的 引用 被 置 为 null 垃圾 收集器 是否 会 立即 释放 对象 占用 的 内存 不会在 下一个 垃圾 回收 周 期中 这个 对象 将是 可被 回收 的 什么 是 分布式 垃圾 回收 dgc 它是 如何 工作 的 dgc 叫做 分布式 垃圾 回收 rmi 使用 dgc 来 做 自动 垃圾 回收 因为 rmi 包 含了 跨 虚拟机 的 远程 对象 的 引用 垃圾 回收 是 很 困难 的 dgc 使用 引用 计数 算法 来给 远程 对象 提供 自动 内存 管理 串行 serial 收集器 和 吞吐量 throughput 收集器 的 区别 是什么 吞吐量 收集器 使用 并行 版本 的 新生代 垃圾 收集器 它 用于 中等 规模 和 大规模 数据 的 应用程序 而 串行 收集器 对 大多数 的 小 应用 在 现代 处理器 上 需要 大概 m 左右 的 内存 就 足 够了 在 java 中 对象 什么时候 可以 被 垃圾 回收 当 对象 对 当前 使用 这个 对象 的 应用程序 变得 不可 触及 的 时候 这个 对象 就可以 被 回 收了 简述 java 内存 分配 与 回收 策 率 以及 minorgc 和 majorgc 对象 优 先在 堆 的 eden 区 分配 大 对象 直接 进入 老 年代 长期 存活 的 对象 将 直接 进入 老 年代 当 eden 区 没有 足够 的 空间 进行 分配 时 虚拟 机会 执行 一次 minorgcminorgc 通常 发 生在 新生代 的 eden 区 在 这个 区 的 对象 生存期 短 往往 发生 gc 的 频率 较高 回收 速度 比 较快 fullgcmajorgc 发 生在 老 年代 一般 情况下 触发 老 年代 gc 的 时候 不会 触发 minorgc 但是 通过 配置 可以 在 fullgc 之前 进行 一次 minorgc 这样 可以 加快 老 年代 的 回收 速度 jvm 的 永久 代 中会 发生 垃圾 回收 么 垃圾 回收 不会 发 生在 永久 代 如果 永久 代 满了 或者是 超 过了 临界值 会 触发 完全 垃圾 回收 fullgc 注 java 中 已经 移 除了 永久 代 新 加了 一个 叫做 元 数据 区 的 native 内存 区 java 中 垃圾 收集 的 方法 有 哪些 标记 清除 这是 垃圾 收集 算法 中最 基础 的 根据 名字 就可以 知道 它 的 思想 就是 标记 哪些 要被 回收 的 对象 然后 统一 回收 这种 方法 很简单 但是 会有 两个 主要 问题 效率 不高 标记 和 清除 的 效率 都 很低 会 产生 大量 不 连续 的 内存 碎片 导致 以后 程序 在 分配 较大 的 对象 时 由于 没有 充足 的 连续 内存 而 提前 触发 一次 gc 动作 复制 算法 为了 解决 效率 问题 复制 算法 将 可用内存 按 容量 划 分为 相等 的 两部分 然后 每次 只 使用 其中 的 一块 当 一块 内存 用完 时 就将 还 存活 的 对象 复制到 第二 块 内存 上 然后 一次性 清楚 完 第一 块 内存 再将 第二 块 上 的 对象 复制到 第一 块 但是 这种 方式 内存 的 代价 太高 每次 基本上 都要 浪费 一般 的 内存 于是 将该 算法 进行了 改进 内存 区域 不再是 按照 去 划分 而是 将 内存 划 分为 三 部分 较大 那份 内存 交 eden 区 其余 是 两块 较小 的 内存 区 叫 survior 区 每次 都会 优 优先 使用 eden 区 若 eden 区 满 就将 对象 复制到 第二 块 内存 区 上 然后 清除 eden 区 如果 此时 存活 的 对象 太多 以至于 survivor 不够 时 会将 这些 对象 通过 分配 担保 机制 复制 到老 年代 中 java 堆 又 分为 新生代 和 老 年代 标记 整理 该 算法 主要 是为了 解决 标记 清除 产生 大量 内存 碎片 的 问题 当 对象 存活率 较高 时 也 解决 了 复制 算法 的 效率 问题 它 的 不同之处 就是在 清除 对象 的 时候 现将 可回收 对象 移 动到 一端 然后 清 除掉 端 边界 以外 的 对象 这样 就不会 产生 内存 碎片 了 分 代 收集 现在 的 虚拟机 垃圾 收集 大多 采用 这种 方式 它 根据 对象 的 生存 周期 将 堆 分为 新生代 和 老 年代 在 新生代 中 由于 对象 生存期 短 每次 回收 都会 有 大量 对象 死去 那么 这时 就 采用 复制 算法 老 年代 里 的 对象 存活率 较高 没有 额外 的 空间 进行 分配 担保 什么 是 类 加载 器 类 加载 器 有 哪些 实现 通过 类 的 权限 定名 获取 该类 的 二进制 字 节流 的 代码 块 叫做 类 加载 器 主要有 一下 四 种类 加载 器 启动 类 加载 器 用来 加载 java 核心 类 库 无法 被 java 程序 直接 引用 扩展 类 加载 器 它 用来 加载 java 的 扩展 库 java 虚拟机 的 实现 会 提供 一个 扩展 库 目录 该类 加载 器 在此 目录 里面 查找 并 加载 java 类 系统 类 加载 器 它 根据 java 应用 的 类 路径 classpath 来 加载 java 类 一般来说 java 应用 的 类 都是 由 它 来 完成 加载 的 可以 通过 来 获取 它 用户 自定义 类 加载 器 通过 继承 类 的 方式 实现 类 加载 器 双亲 委派 模型 机制 当 一个 类 收 到了 类 加载 请求 时 不会 自己 先去 加载 这个 类 而是 将其 委 派给 父 类 由 父 类 去 加载 如果 此时 父 类 不能 加载 反 馈给 子类 由 子类 去 完成 类 的 加载 一个 新系统 开发 完毕 之后 如何 设置 jvm 参数 首先 应该 估算 一下 自己 负责 的 系统 每个 核心 接口 每秒 多少次 请求 每次 请求 会 创建 多少个 对象 每个 对象 大概 多大 每秒钟 会 使用 多少 内存空间 这样 接着 就可以 估算 出来 eden 区 大概 多长时间 会 占满 然后 就可以 估算 出来 多长时间 会 发生 一次 younggc 而且 可以 估算 一下 发生 younggc 的 时候 会有 多少 对象 存活 下来 会有 多少 对象 升入 老 年代 里 老 年代 对象 增长 的 速率 大概 是多少 多久 之 后会 触发 一次 fullgc 通过 一连串 的 估算 就可以 合理 的 分配 年轻 代 和 老 年代 的 空间 还有 eden 和 survivor 的 空间 原则 就是 尽可 能让 每次 younggc 后 存活 对象 远远 小于 survivor 区域 避免 对象 频繁 进入 老 年代 触发 fullgc 最理想 的 状态下 就是 系统 几乎 不发生 fullgc 老 年代 应该 就是 稳定 占用 一定 的 空间 就是 那些 长期 存活 的 对象 在 躲过 次 younggc 后 升入 老 年代 自然 占用 的 然后 平时 主要 就是 几分钟 发生 一次 younggc 耗时 几 毫秒 在 压 测 之后 合理 调整 jvm 参数 任何 一个 新系统 上线 都得 进行 压 测 此时 在 模拟 线上 压力 的 场景 下 可以用 jstat 等 工具 去 观察 jvm 的 运行 内存 模型 eden 区 的 对象 增长 速率 多 块 younggc 频率 多高 一次 younggc 多长 耗时 younggc 过后 多少 对象 存活 老 年代 的 对象 增长 速率 多高 fullgc 频率 多高 一次 fullgc 耗时 压 测时 可以 完全 精准 的 通过 jstat 观察出来 上述 jvm 运行 指标 让我们 对 jvm 运行时 的 情况 了如指掌 然后 就可以 尽可能 的 优化 jvm 的 内存 分配 尽量 避免 对象 频繁 进入 老 年代 尽量 让 系统 仅仅有 younggc 线上 系统 的 监控 和 优化 系统 上线 之后 务必 进行 一定 的 监控 高大 上 的 做法 就是 通过 之类 的 工具 来 监控 机器 和 jvm 的 运行 频繁 fullgc 就要 报警 比较 差一点 的 做法 就是在 机器 上 运行 jstat 让 其 把 监控 信息 写入 一个 文件 每天 定时 检查一下 看一看 一旦 发现 频繁 fullgc 的 情况 就要 进行 优化 优化 的 核心 思路 是 类似 的 通过 jstat 分析出来 系统 的 jvm 运行 指标 找到 fullgc 的 核心问题 然后 优化 一下 jvm 的 参数 尽量 让 对象 别 进入 老 年代 减少 fullgc 的 频率 线上 频繁 fullgc 的 几种 表现 其实 通过 之前 的 各种 案例 大家 可以 总结 出来 一旦 系统 发生 频繁 fullgc 大概 看到 的 一些 表象 如下 机器 cpu 负载 过高 频繁 fullgc 报警 系统 无法 处理 请求 或者 处理 过慢 所以 一旦 发生 上述 几个 情况 大家 第一时间 得 想到 是不是 发 生了 频繁 fullgc 频繁 fullgc 的 几种 常见 原因 频繁 fullgc 的 原因 系统 承载 高 并发 请求 或者 处理 数据 量过大 导致 younggc 很 频繁 而且 每次 younggc 过后 存活 对象 太多 内存 分配 不合理 survivor 区域 过小 导致 对象 频繁 进入 老 年代 频繁 触发 fullgc 系统 一次性 加载 过多 数据 进 内存 搞出来 很 多大 对象 导致 频繁 有 大 对象 进入 老 年代 必然 频繁 触发 fullgc 系统 发 生了 内存 泄漏 莫名其妙 创建 大量 的 对象 始终 无法 回收 一直 占 用在 老 年代 里 必然 频繁 触发 fullgcmetaspace 永久 代 因为 加载 类 过多 触发 fullgc 误 调用 systemgc 触发 fullgc 其实 常见 的 频繁 fullgc 原因 无非 就 上述 那 几种 所以 大家 在 线上 处理 fullgc 的 时候 就从 这 几个 角度 入手 去 分析 即可 核心 利器 就是 jstat 如果 jstat 分析 发现 fullgc 原因是 第一种 那么 就 合理 分配 内存 调 大 survivor 区域 即可 如果 jstat 分析 发 现是 第二种 或 第三种 原因 也 就是 老 年代 一直 有 大量 对象 无法 回 收掉 年轻 代 升入 老 年代 的 对象 病 不多 那么 就 dump 出来 内存 快照 然 后用 mat 工具 进行 分析 即可 通过 分析 找出来 什么 对象 占用 内存 过多 然后 通过 一些 对象 的 引用 和 线程 执行 堆栈 的 分析 找到 哪 块 代码 弄出来 那么多 的 对象 的 接着 优化 代码 即可 如果 jstat 分析 发现 内存 使用 不多 还 频繁 触发 fullgc 必然 是 第四种 和 第五 种 此时 对应 的 进行 优化 即可 发生 fullgcyounggc 之前 空间 担保 机制 老 年代 的 连续 空间 小于 新生代 所有 对象 总 大小 和 历次 晋升 的 平均 大小 younggc 之后 新生代 幸存 的 对象 大小 老 年代 放不下 了 大 对象 放不下 老 年代 老 年代 的 大小 达到 阈 值了 元 空间 满了 你 调 用了 systemgc 可能发生 oom 的 地方 元 空间 class 太 多了 第一种 原因 很多 工程师 他 不懂 jvm 的 运行 原理 在 上线 系统 的 时候 对 metaspace 区域 直接 用 默认 的 参数 即 根 本不 设置 其 大小 这会 导致 默认 的 metaspace 区域 可能 才 几十 mb 而已 此时 对于 一个 稍微 大型 一点 的 系统 因为 他 自己 有 很多 类 还 依赖 了 很多 外部 的 jar 包 有 有 很多 的 类 几十 mb 的 metaspace 很 容易 就不 够了 第二种 原因 就是 很多人 写 系统 的 时候 会用 cglib 之类 的 技术 动态 生成 一些 类 一旦 代码 中 没有 控制 好 导致 你 生成 的 类 过于 多 的 时候 就很 容易 把 metaspace 给 塞满 进而 引发 内存 溢出 栈 内存 出现 了 死循环 调用 或者是 无限制 的 递归 调用 堆 内存 对象 太多 且 都是 存活 的 即使 gc 过后 还是 没有 空间 了 此时 放不下 新 的 对象 如何 定位 oomjvm 需要 加上 打印 gclog 配置 内存 溢出 参数 内存 溢出 的 时候 导出来 一份 内存 快照 到 我们 指定 的 位置 发生 oom 会 推送 通知 然后 看 日志 看看 到底是 堆 内存 溢出 还是 栈 内存 溢出 或者是 metaspace 内存 溢出 首 先得 确定 一下 具体 的 溢出 类型 看 看是 哪个 线程 运行 代码 的 时候 内存 溢 出了 因为 tomcat 运行 的 时候 不光 有 自己 的 工作 线程 我们 写 的 代码 也 可能会 创建 一些 线程 出来 接着 通过 mat 分析 dump 是什么 对象 导致 的 找到 对应 的 代码 行使 用 工具 jstat 查看 fgcygc 次数 时长 每个 空间 的 使用 大小 jmapdump 文件 mat 查看 堆 的 分配 大小 jstack 查看 死锁 生成 环境 如何 设置 堆 内存大小 qps 对象 的 大小 对象 数量 算出 每秒 产生 的 大小 比如 每秒 m 每个 事件 大概 可以 处理 的 时间 比如 秒 那么 可以 算出 大概 每秒 产生 m 的 垃圾 比如 核 g 的 机器 分配 gjvmg 堆 可以 设置 兆 年轻 代 其中 设置 比例 为 每个 survivor 区 为 meden 区 兆兆 老 年代 兆元 空间 元 空间 设置 防止 我们 用了 反射 默认 几 十兆 不够用 jvm 内存 分为 哪 几块 java 虚拟机 栈 本地 方法 栈 堆 程序 计数器 方法 区 说说 jvm 的 垃圾 回收 算法 复制 标记 清除 标记 整理 分 代 算法 收集器 流程 初始 标记 会 发生 stw 主要 标记 gcroot 并发 标记 比较 费时间 主 要是 从 gcroot 追踪 那些 引用 的 对象 也 就是 标记 那些 存活 的 对象 和 不 存活 的 对象 重新 标记 会 发生 stw 重新 标记 下在 第二阶段 里 新创建 的 一些 对象 还有 一些 已有 对象 可能 失去 引用 变成 垃圾 的 情况 并发 清除 g 是什么 他 最大 的 一个 特点 就是 把 java 堆 内存 拆 分为 多个 大小 相等 的 region 每个 region 为 的 倍数 比如 mm 然后 g 也 会有 新生代 和 老 年代 的 概念 但是 只 不过是 逻辑 上 的 概念 最 开始 默认 新生代 g 还有 一个 特点 就是 可以 让我们 设置 一个 垃圾 回收 的 预期 停顿 时间 在 一个 时间内 垃圾 回收 导致 的 系统 停顿 时间 不能超过 多久 g 全权 给你 负责 保证 达到 这个 目标 他 会 追踪 每个 region 里 的 回收 价值 也 就是 计算 每个 region 需要 耗费 多长时间 可以 回 收掉 多少 垃圾 新生代 的 eden 区 和 survivor 区 也是 可以 设置 比例 的 大小 随着 空间 变化 新生代 达 到了 就会 发生 ygc 老 年代 达 到了 会 发生 mixedgc 新生代 和 老 年代 一起 gcg 流程 初始 标记 并发 标记 最终 标记 混合 回收 回收 老 年代 新生代 可以 设置 分 几次 回收 默认 次 当 回 收到 可 配置 就不 回 收了 对象 什么时候 转移 到老 年代 大 对象 ygc 之后 年轻 代 放不下 动态 年龄 机制 ygc 之后 对象 的 生命 从小到大 排序 当 超过 survivor 区 的 一半 就将 年龄 大 的 对象 放到 老 年代 连续 次 ygc 之后 对象 放到 老 年代 常量 存储 在 哪里 运行时 常量 存在 方法 区 字符串 常量 存在 堆 区 自定义 加载 器 创建 一个 类 继承 classloader 抽象类 重写 findclass 方法 在 findclass 方法 中 调用 defineclass tomcat 调 优 面试 篇 你 会 怎样 给 tomcat 进行 调 优 jvm 参数 调 优 xmsltsizegt 表示 jvm 初始化 堆 的 大小 xmxltsizegt 表示 jvm 堆 的 最大值 这两个 值 的 大小 一般 根据需要 进行 设置 当 应用程序 需要 的 内存 超出 堆 的 最大值 时 虚拟机 就会 提示 内存 溢出 并且 导致 应用服务 崩溃 因此 一般 建议 堆 的 最大值 设置 为 可用内存 的 最大值 的 在 catalinabat 中 设置 表示 初始化 内 存为 mb 可以 使用 的 最大 内 存为 mb 禁用 dns 查询 当 web 应用程序 想要 记录 客户端 的 信息 时 它也 也 会 记录 客户端 的 ip 地址 或者 通过 域名 服务器 查找 机器 名 转 换为 ip 地址 dns 查询 需要 占用 网络 并且 包括 可 能从 很多 很远 的 服务器 或者 不起作用 的 服务器 上去 获取 对应 的 ip 的 过程 这样 会 消耗 一定 的 时间 为了 消除 dns 查询 对 性能 的 影响 我们 可以 关闭 dns 查询 方式 是 修改 serverxml 文件 中 的 lenablelookups 参 数值 调整 线程 数 通过 应用程序 的 连接器 connector 进行 性能 控制 的 的 参数 是 创建 的 处理 请求 的 线程 数 tomcat 使用 线程 池 加速 响应速度 来 处理 请求 在 java 中 线程 是 程序 运行时 的 路径 是 在 一个 程序 中 与 其它 控制 线程 无关 的 能够 独立 运行 的 代码 段 它们 共享 相同 的 地址 空间 多线程 帮助 程序员 写出 cpu 最大 利用率 的 高效 程序 使 空闲 时间 保持 最低 从而 接 更多 的 请求 tomcat 中 可以 通过 修改 minprocessors 和 maxprocessors 的 值 来 控制 线程 数 这些 值 在 安装 后 就 已经 设 定为 默认值 并且是 足够 使用 的 但是 随着 站点 的 扩容 而 改大 这些 值 minprocessors 服务器 启动时 创建 的 处理 请求 的 线程 数 应该 足够 处理 一个 小量 的 负载 也就是说 如果 一 天内 每秒 仅 发生 次 单击 事件 并且 每个 请求 任务 处理 需要 秒钟 那么 预先 设置 线程 数 为 就 足 够了 但在 你 的 站点 访问量 较大 时 就需要 设置 更大 的 线程 数 指 定为 参数 maxprocessors 的 值 maxprocessors 的 值 也是 有 上限 的 应 防止 流量 不可 控制 或者 恶意 的 服务 攻击 从而 导致 超 出了 虚拟机 使用 内存 的 大小 如果 要 加大 并发 连接数 应 同时 加大 这两个 参数 webserver 允许 的 最大 连接数 还 受制 于 操作系统 的 内核 参数设置 通常 windows 是 个 左右 linux 是 个 左右 在 tomcat 对 这些 参数 进行了 调整 请看 下面 属性 使用 线程 来 处理 接收 的 每个 请求 这个 值 表示 tomcat 可 创建 的 最大 的 线程 数 acceptcount 指 定当 所有 可以 使用 的 处理 请求 的 线程 数 都被 使 用时 可以 放到 处理 队列 中 的 请 求数 超过 这 个数 的 请求 将 不予 处理 网络连接 超时 单位 毫秒 设置 为 表示 永不 超时 这样 设置 有 隐患 的 通常 可 设置 为 毫秒 初始 化时 创建 的 线程 数 maxsparethreads 一旦 创建 的 线程 超过 这个 值 tomcat 就会 关闭 不再 需要 的 socket 线程 最好 的 方式 是 多 设置 几次 并且 进行 测试 观察 响应 时间 和 内存 使用情况 在 不同 的 机器 操作系统 或 虚拟机 组合 的 情况下 可能会 不同 而且 并不是 所有人 的 web 站点 的 流量 都是 一样 的 因此 没有 一刀 切的 方案 来 确定 线程 数 的 值 如何 加大 tomcat 连接数 在 tomcat 配置文件 serverxml 中 的 ltconnectorgt 配置 中和 连接数 相关 的 参数 有 minprocessors 最小 空闲 连接 线程 数 用于 提高 系统 处理 性能 默认值 为 maxprocessors 最大 连接 线程 数 即 并发 处理 的 最大 请 求数 默认值 为 acceptcount 允许 的 最大 连接数 应 大于 等于 maxprocessors 默认值 为 enablelookups 是否 反查 域名 取值 为 true 或 false 为了 提高 处理 能力 应 设置 为 网络连接 超时 单位 毫秒 设置 为 表示 永不 超时 这样 设置 有 隐患 的 通常 可 设置 为 webserver 允许 的 最大 连接数 还 受制 于 操作系统 的 内核 参数设置 通常 windows 是 个 左右 linux 是 个 左右 tomcat 的 配置 参数 对于 其他 端口 的 侦听 配置 以此类推 怎样 加大 tomcat 的 内存 首先 检查程序 有没有 陷入 死循环 这个 问题 主要 还是 由 这个 问题 引起 的 第一次 出现 这样 的 的 问题 以后 引 发了 其他 的 问题 在 网上 一查 可能是 java 的 堆栈 设置 太小 的 原因 根据 网上 的 答案 大致 有这 两种 解决方法 设置 环境变量 解决方法 手动 设置 heapsize 修改 可以 根据 自己 机器 的 内存 进行 更改 在 执行 java 类 文件 时 加上 这个 参数 其中 classname 是 需要 执行 的 全 类 路径名 这个 解决问题 了 而且 执行 的 速度 比 没有 设置 的 时候 快 很多 如果在 测试 的 时候 可能 会用 eclispe 这时候 就需要 在 中 的 wmarguments 中 输入 xmsmxmxm 这个 参数 就可以 了 后来 在 ecilpse 中 修 改了 启动 参数 在 vmarguments 加 入了 xmsmxmxm 问题解决 一 的 全 称是 是 指 内存 的 永久 保存 区域 这块 内存 主 要是 被 jvm 存放 class 和 meta 信息 的 class 在被 loader 时 就 会被 放到 permgenspace 中 它 和 存放 类 实例 nstance 的 heap 区域 不同 不会在 主程序 运 行期 对 permgenspace 进行 清理 所以 如果 你 的 应用 中有 很多 class 的话 就很 可能 出现 permgenspace 错误 这种 错误 常见 在 web 服务器 对 jsp 进行 precompile 的 时候 如果 你 的 webapp 下 都 用了 大量 的 第三方 jar 其 大小 超 过了 jvm 默认 的 大小 m 那么 就会 产生 此 错误信息 了 解决方法 手动 设置 maxpermsize 大小 修改 在 上面 加入 以 下行 建议 将 相同 的 第三方 jar 文件 移置 到 tomcatsharedlib 目 录下 这样 可以 达到 减少 jar 文档 重复 占用 内存 的 目的 二 设置 jvm 堆 的 设置 是 指 java 程序 运行 过程中 jvm 可以 调配 使用 的 内存空间 的 设置 jvm 在 启动 的 时候 会 自动 设置 heapsizel 的 值 其 初始 空间 即 xms 是 物理 内存 的 最大 空间 xmx 是 物理 内存 的 可以 利用 jvm 提供 的 一 xmnxmsxmx 等 选项 可 进行 设置 heapsize 的 大小 是 younggeneration 和 之和 提示 在 jvm 中 如果 的 时间 是 用于 gc 且 可用 的 heapsize 不足 的 时候 将 抛 出此 异常 信息 提示 heapsize 最大 不要 超过 可用 物理 内存 的 一般 的 要将 xms 和 xmx 选项 设置 为 相同 而 xmn 为 的 xmx 值 解决方法 手动 设置 heapsize 修改 在 上面 加入 以 下行 三 实例 给出 以下 g 内存 环境 下 javajvml 的 参数设置 参考 很大 的 web 工程 用 tomcat 默认 分配 的 内存空间 无法 启动 如果 不是 在 myeclipse 中 启动 tomcat 可 以对 tomcat 这样 设置 中 添加 这样 一句话 或者 如果 要在 myeclipse 中 启动 上述 的 修改 就不 起作用 了 可 如下 设置 面板 中 的 中 添加 以上 是 转贴 但 本人 遇见 的 问题是 在 myeclipse 中 启动 tomcat 时 提示 解决办法 就是 面板 中 的 中 添加 中 如何 禁止 列 目 录下 的 文件 在 中 把 listings 参数 设置成 false 即可 如下 有 几种 部署 方式 tomcat 中 四种 部署 项目 方法 第一 种方法 在 tomcat 中 的 conf 目录 中 在 serverxml 中 的 lthost 节 点中 添加 至于 context 节点 属性 可 详细 见 相关 文档 第二 种方法 将 web 项目 文件 件 拷贝到 webapps 目录 中 第三 种方法 在 conf 目录 中 新建 目 录在 该 目录 中 新建 一个 xml 文件 名字 可以 随意 取 只 要和 当前 文件 中 的 文件名 不 重复 就行了 该 xml 文件 的 内容 为 第 个 方法 有 个 优点 可以 定义 别名 服务器端 运行 的 项目名称 为 path 外部 访问 的 url 则 使用 xml 的 文件名 这个 方法 很 方便 的 隐藏 了 项目 的 名称 对 一些 项目名称 被 固定 不能 更换 但 外部 访问 时 又想 换个 路径 非常 有效 第 还有 优点 可以 定义 一些 个性 配置 如 数据源 的 配置 等第 四种 方法 可以用 tomcat 在线 后台 管理器 一般 tomcat 都 打 开了 直接 上传 warl 就可以 tomcat 的 优化 经验 tomcat 作为 web 服务器 它 的 处理 性能 直接 关系到 用户 体验 下面 是 种 常见 的 优化 措施 去掉 对 webxml 的 监视 把 jsp 提前 编辑 成 servlet 存 的 情况 加大 tomcat 使用 的 jvm 的 内存 服务器 资源 服务器 所能 提供 cpu 内存 硬盘 的 性 能对 处理 能力 有 决定性 影响 对于 高 并发 情况下 会有 大量 的 运算 那么 cpu 的 速度 会 直接 影响到 处理 速度 内 存在 大量 数据处理 的 情况下 将会 有 较大 的 内存容量 需求 可以用 等 参数 对 内存 不同 功能块 进行 划分 我们 之前 就 遇到过 内存 分配 不足 导致 虚拟机 一直 处于 fullgc 从而 导致 处理 能力 严重 下降 硬盘 主要 问题 就是 读写 性能 当 大量 文件 进行 读写 时 磁盘 极 容易 成为 性能 瓶颈 最好 的 办法 还是 利用 下面 提到 的 缓存 利用 缓存 和 压缩 对于 静态 页面 最好 是 能够 缓存 起来 这样 就 不必 每次 从 磁 盘上 读 这里 我们 采 用了 nginx 作为 缓存 服务器 将 图片 cssjs 文件 都 进行了 缓存 有效 的 减 少了 后端 tomcat 的 访问 另外 为了 能 加快 网络 传输 速度 开启 gzip 压缩 也是 必不可少 的 但 考虑到 tomcat 已经 需要 处理 很多 东西 了 所以 把 这个 压缩 的 工作 就 交给 前端 的 nginx 来 完成 除了 文本 可以用 gzip 压缩 其实 很多 图片 也 可以用 图像 处理 工具 预先 进行 压缩 找到 一个 平衡点 可以 让 画质 损失 很小 而 文件 可以 减小 很多 曾经 我 就 见过 一个 图片 从 多 kb 压 缩到 几十 kb 自己 几乎 看不出来 区别 采用 集群 单个 服务器 性能 总是 有限 的 最好 的 办法 自然是 实现 横向 扩展 那么 组建 tomcat 集群 是 有效 提升 性能 的 手段 我们 还是 采 用了 nginx 来 作为 请求 分流 的 服务器 后端 多个 tomcat 共享 session 来 协同 工作 可以 参考 之前 写 的 利用 组建 web 服务器 负载 均衡 优化 tomcat 参数 这里 以 tomcat 的 参数 配置 为 例 需要 修改 confserverxml 文件 主 要是 优化 连接 配置 关闭 客户端 dns 查询 调 优 面试 篇 为什么 要 分库 分 表 设计 高 并发 系统 的 时候 数据库 层面 该 如何 设 计分表 比如 你 单 表 都 几 千万 数据 了 你 确定 你 能 扛 住 么 绝对 不行 单 表 数据量 太 大会 极大 影响 你 的 sql 执行 的 性能 到了 后面 你 的 sql 可能 就跑 的 很 慢了 一般来说 就以 我 的 经验 来看 单 表 到 几百万 的 时候 性能 就会 相对 差 一些 了 你 就 得分 表 了 分 表 是 啥意思 就是 把 一个 表 的 数据 放到 多个 表 中 然后 查询 的 时候 你 就 查 一个 表 比如 按照 用户 id 来 分 表 将 一个 用户 的 数据 就 放在 一个 表 中 然后 操作 的 时候 你 对 一个 用户 就 操作 那个 表 就 好了 这样 可以 控制 每个 表 的 数据量 在 可控 的 范围内 比如 每个 表 就 固 定在 万 以内 分库 分库 是 啥意思 就是 你 一个 库 一般 我们 经验 而言 最多 支 撑到 并发 一 定要 扩容 了 而且 一个 健康 的 单 库 并发 值 你 最好 保持在 每秒 左右 不要 太大 那么 你 可以 将 一个 库 的 数据 拆 分到 多个 库 中 访问 的 时候 就 访问 一个 库 好了 分库 分 表 前 分库 分 表 后 并发 支撑 情况 mysql 单机 部署 扛不住 高 并发 mysql 从 单机 到 多 机能 承受 的 并发 增加了 多倍 磁盘 使用情况 mysql 单机 磁盘 容量 几乎 撑满 拆 分为 多个 库 数据库 服务器 磁盘 使用率 大大 降低 sql 执行 性能 单 表 数据量 太大 sql 越 跑 越慢 单 表 数据量 减少 sql 执行 效率 明显 提升 这 就是 所谓 的 分库 分 表 用过 哪些 分库 分 表 中间件 不同 的 分库 分 表 中间件 都有 什么 优点 和 缺点 shardingjdbc 当当 开源 的 属于 client 层 项目 直接 依赖 jar 方案 目前 已经 更 名为 shardingsphere 后文 所 提到 的 shardingjdbc 等同于 shardingsphere 确实 之前 用 的 还 比 较多 一些 因为 sql 语法 支持 也 比 较多 没有 太多 限制 支持 分库 分 表 读写 分离 分布式 id 生成 柔性 事务 最大 努力 送达 型 事务 tcc 事务 而且 确实 之前 使用 的 公司 会比 较多 一些 这个 在 官 网 有 登记 使用 的 公司 可以 看到 从 年 一直 到 现在是 有 不少 公司 在用 的 目前 社区 也 还 一直在 开发 和 维护 还 算是 比较 活跃 个人认为 算是 一个 现在 也 可以 选择 的 方案 mycat 属于 proxy 层 类似于 中间件 方案 支持 的 功能 非常 完善 而且 目前 应该是 非常 火 的 而且 不断 流行 的 数据库 中间件 社区 很 活跃 也有 一些 公司 开始 在 用了 但是 确实 相比 于 shardingjdbc 来说 年轻 一些 经历 的 锤炼 少 一些 总结 shardingjdbc 这种 client 层 方案 的 优点 在于 不用 部署 运 维 成本低 不需要 代理 层 的 二次 转发 请求 性能 很高 缺点 但是 如果 遇到 升级 啥 的 需要 各个系统 都 重新 升级 版本 再 发布 各个系统 都 需要 耦合 shardingjdbc 的 依赖 mycat 这种 proxy 层 方案 的 缺点 在于 需要 部署 自己 运 维 一套 中间件 运 维 成本 高 但是 好处 在于 对于 各个 项目 是 透明 的 如果 遇到 升级 之类 的 都是 自己 中间件 那里 搞 就行了 通常 来说 这两个 方案 其实 都可以 选用 但是 我 个人 建议 中小型 公司 选用 层 方案 轻便 而且 维护 成本低 不需要 额外 增派 人手 而且 中小型 公司 系统 复杂度 会 低 一些 项目 也 没 那么多 但是 中大型 公司 最好 还是 选用 mycat 这类 proxy 层 方案 因为 可能 大公司 系统 和 项目 非常 多 团队 很大 人员 充足 那么 最好 是 专门 弄 个人 来 研究 和 维护 mycat 然后 大量 项目 直接 透明 使用 即可 你们 具体 是 如何 对 数据库 如何 进行 垂直 拆分 或 水平 拆分 的 水平 拆分 的 意思 就是 把 一个 表 的 数据 给 弄到 多个 库 的 多个 表里 去 但是 每个 库 的 表 结构 都 一样 只不过 每个 库 表 放 的 数据 是 不同 的 所有 库 表 的 数据 加起来 就是 全部 数据 水平 拆分 的 意义 就是 将 数据 均匀 放 更多 的 库里 然 后用 多个 库 来 扛 更高 的 并发 还有 就是 用 多个 库 的 存储容量 来 进行 扩容 垂直 拆分 的 意思 就是 把 一个 有 很多 字段 的 表 给 拆 分成 多个 表 或者是 多个 库 上去 每个 库 表 的 结构 都不 一样 每个 库 表 都 包含 部分 字段 一般来说 会将 较少 的 访问 频率 很高 的 字段 放到 一个 表里 去 然后 将 较多 的 访问 频率 很低 的 字段 放到 另外 一个 表里 去 因为 数据库 是 有 缓存 的 你 访问 频率 高 的 行 字段 越少 就可以 在 缓存 里 缓存 更多 的 行 性能 就 越好 这个 一般 在 表 层面 做的 较多 一些 好了 无论 分库 还是 分 表 上面 说的 那些 数据库 中间件 都是 可以 支持 的 就是 基本上 那些 中间件 可以 做到 你 分库 分 表 之后 中间件 可以 根据 你 指定 的 某个 字段 值 比如说 userid 自动 路由 到 对应 的 库 上去 然后再 自动 路由 到 对应 的 表里 去 你 的 项目 里 该 如何 分库 分 表 一般来说 垂直 拆分 你 可以 在 表 层面 来 做对 一些 字段 特别 多 的 表 做 一下 拆分 水平 拆分 你 可以说是 并发 承载 不 了 或者是 数据量 太大 容量 承载 不 了 你 给 拆 了 按 什么 字段 来 拆 你 自己 想好 分 表 你 考虑一下 你 如果 哪怕是 拆到 每个 库里 去 并发 和 容量 都 ok 了 但是 每个 库 的 表 还是 太大 了 那么 你 就 分 表 将 这个 表 分开 保证 每个 表 的 数据量 并不是 很大 分库 分 表 的 方式 水平 拆分 一种 是 按照 range 来 分 就是 每个 库 一段 连续 的 数据 这个 一般 是 按 比如 时间 范围 来 的 但是 这种 一般 较 少用 因为 很 容易 产生 热点问题 大量 的 流量 都 打在 最新 的 数据 上了 或者是 按照 某个 字段 hash 一下 均匀 分散 这个 较为 常用 range 来 分好 处 在于 说 扩容 的 时候 很简单 因为 你 只要 预 备好 给 每个月 都 准备 一个 库 就可以 了 到了 一个 新 的 月份 的 时候 自然而然 就 会写 新 的 库 了 缺点 但是 大部分 的 请求 都是 访问 最新 的 数据 实际 生产 用 range 要看 场景 hash 分发 好处 在于 说 可以 平均分配 每个 库 的 数据量 和 请求 压力 坏处 在于 说 扩容 起来 比较 麻烦 会有 一个 数据 迁移 的 过程 之前 的 数据 需要 重新 计算 hash 值 重新分配 到 不同 的 库 或 表现 在有 一个 未 分库 分 表 的 系统 未来 要 分库 分 表 如何 设计 才 可以 让 系统 从未 分库 分 表 动态 切 换到 分库 分 表 上 停机 迁移 方案 网站 或者 app 挂个 公告 点 进 行运 维 无法访问 接着 到点 停机 系统 停掉 没有 有 流量 写 入了 此时 老 的 单 库 单 表 数据库 静止 了 然后 通过 写好 一个 导数 的 一次性 工具 系统 然后 直接 启动 连 接到 新 的 分库 分 表 上去 开 多台 机器 执行 修改 服务 的 新 的 数据库 地址 配置 信息 重新 发布 系统 然后 验证 一下 就 完事 了如 果有 问题 没 到点 重试 否则 直 接回 滚到 单 表 第二天 凌晨 重试 万 数据 可以 通过 开台 机器 每个 机器 每小时 大概 可以 迁移 万 的 数据量 每台 机器 多线程 开个 线程 跑 不 停机 双 写 迁移 方案 简单 来说 就是在 线上 系统 里面 之前 所有 写 库 的 地方 增 删改 操作 除了 对 老 库 增 删改 都 加上 对 新 库 的 增 删改 这 就是 所谓 的 双 写 同时 写 俩 库 老 库 和 新 库 然后 系统 部署 之后 新 库 数据 差 太远 用 之前 说的 导数 工具 跑起来 读 老 库 数据 写 新 库 写 的 时候 要根据 gmtmodified 这类 字段 判断 这条 数据 最后 修改 的 时间 除非是 读出来 的 数据 在 新 库里 没有 或者是 比 新 库 的 数据 新 才 会写 简单 来说 就是 不允许 用 老 数据 覆盖 新 数据 导 完 一轮 之后 有 可能 数据 还是 是 存在 不一致 那么 就 程序 自动 做 一轮 校验 比对 新老 库 每个 表 的 每条 数据 接着 如果有 不一样 的 就 针对 那些 不一样 的 从 老 库 读 数据 再次 写 反复 循环 直到 两个 库 每个 表 的 数据 都 完全一致 为止 接着 当 数据 完全一致 了 就 ok 了 基于 仅仅 使用 分库 分 表 的 最新 代码 重新部署 一次 不就 仅仅 基于 分库 分 表 在 操 作了 么 还没有 几个 小时 的 停机 时间 很 稳 所以 现在 基本 玩儿 数据 迁移 之类 的 都是 这么 干 的 如何 设计 可以 动态 扩容 缩 容 的 分库 分 表 方案 一开始 上来 就是 个 库 每个 库 个 表 那么 总共是 张 表 我 可以 告诉 各位 这个 分法 第一 基本上 国内 的 互联网 肯定 都是 够 用了 第二 第二 无论是 并发 支撑 还是 数据量 支撑 都没 问题 每个 库 正常 承载 的 写入 并发 量 是 那么 个 库 就可以 承载 的 写 并发 如果 每个 库 承载 的 写 并发 的 写 并发 接近 万 每秒 的 写入 并发 前面 再加 一个 mq 削 峰 每秒 写入 mq 万条 数据 每秒 消费 万条 数据 有些 除非是 国内 排名 非常 靠前 的 这些 公司 他们 的 最 核心 的 系统 的 数据库 可能会 出现 几百 台 数据库 的 这么 一个 规模 个 库 个 库 个 库 张 表 假设 每个 表 放 万 数据 在 mysql 里 可以 放 亿条 数据 每秒 万 的 写 并发 总共 亿条 数据 对于 国内 大部分 的 互联网 公司 来说 其实 一般来说 都 够了 刚开始 的 时候 这个 库 可能 就是 逻辑 库 建在 一个 数据库 上 的 就是 一个 mysql 服务器 可能 建了 n 个 库 比如 个 库 后面 如果 要 拆分 就是 不断 在库 和 mysql 服务器 之间 做 迁移 就可以 了 然后 系统 配合 改 一下 配置 即可 比如说 最多 可以 扩展到 个 数据库 服务器 每个 数据库 服务器 是 一个 库 如果 还是 不够 最多 可以 扩展到 个 数据库 服务器 每个 数据库 服务器 上面 一个 库 一个 表 因为 最 多是 个 表 这么 搞 是 不用 自己 写 代码 做 数据 迁移 的 都 交给 dba 来搞 好了 但是 dba 确 实是 需 要做 一些 库 表 迁移 的 工作 但是 总比 你 自己 写 代码 然后 抽 数据 导 数据 来 的 效率高 得多 吧 哪怕是 要 减少 库 的 数量 也 很简单 其实 说白了 就是 按 倍数 缩 容 就可以 了 然后 修改 一下 路由 规则 这里 对 步骤 做一个 总结 设定 好几 台 数据库 服务器 每台 服务器 上 几个 库 每个 库 多少个 表 推荐 是 库 表 对于 大部 分公司 来说 可能 几年 都 够了 路由 的 规则 orderid 模 库 orderid 模 表 扩容 的 时候 申请 增加 更多 的 数据库 服务器 装好 mysql 呈 倍数 扩容 台 服务器 扩到 台 服务器 再到 台 服务器 由 dba 负责 将 原先 数据库 服务器 的 库 迁 移到 新 的 数据库 服务器 上去 库 迁移 是 有 一些 便捷 的 工具 的 我们 这边 就是 修改 一下 配置 调整 迁移 的 库 所在 数据库 服务器 的 地址 重新 发布 系统 上线 原先 的 路由 规则 变 都 不用 变 直接 可以 基于 n 倍 的 数据库 服务器 的 资源 继续进行 线上 系统 的 提供 服务 分库 分 表 之后 id 主键 如何 处理 数据库 自 增 idl 通过 单独 的 获取 id 服务器 获取 id 优点 可以 确保 每个 id 是 唯一 的 缺点 高 并发 的话 就会 有 瓶颈 适合 的 场景 这种 适合 数据 量大 但是 并发 量 比 较低 的 场景 l 设置 数据库 sequence 或者 表 自 增 字段 步长 比如说 现在 有 个 服务 节点 每个 服务 节点 使用 一个 sequence 功 能来 产生 id 每个 sequence 的 起始 id 不同 并且 依次 递增 步长 都是 适合 的 场景 可以 防止 产生 的 id 重复 时 这种 方案 实现 起来 比较简单 也 能 到达 性能 目标 但是 服务 节点 固定 步长 也 固定 将来 还要 增加 服务 节点 就 不好 搞了 uuid 好处 就是 本地 生成 不要 基于 数据库 来了 不好 之处 就是 uuid 太 长了 占用 空间 大作 为 主键 性能 太差 了 更 重要 的 是 uuid 不具有 有序性 会 导致 b 树 索引 在 写 的 时候 有 过多 的 随机 写 操作 连续 的 id 可以 产生 部分 顺序 写 还有 由于 在 写 的 时候 不能 产生 有 顺序 的 append 操作 而 需要 进行 insert 操作 将会 读取 整个 b 树节 点到 内 存在 插入 这条 记录 后 会将 整个 节点 写回 磁盘 这种 操作 在 记录 占用 空间 比 较大 的 情况下 性能 下降 明显 适合 的 场景 如果 你 是 要 随机 生成 个 什么 文件名 编号 之类 的 你 可以用 uuid 但是 作为 主键 是 不 能用 uuid 的 获取 系统 当前 时间 这个 就是 获取 当前 时间 即可 但是 问题是 并发 很高 的 时候 比如 一秒 并发 几千 会有 重复 的 情况 这个 是 肯定 不合适 的 基本 就 不用 考虑 了 适合 的 场景 一般 如果 用 这个 方案 是 将 当前 时间 跟 很多 其他 的 业务 字段 拼接 起来 作为 一个 id 如果 业务 上 你 觉得 可以 接受 那么 也是 可以 的 你 可以 将 别的 业务 字段 值 跟 当前 时间 拼接 起来 组成 一个 全局 唯一 的 编号 snowflake 算法 snowflake 算法 是 twitter 开源 的 分布式 id 生成 算法 采用 scala 语言 实现 id 是 位 long 型 的 lbit 不用 代表 是 正数 lbits 代表 的 是 时间 戳 单位 是 毫秒 换算 成年 大概是 年 lbits 记录 工作 机器 id 最多 可以 不是 机器 其中 bits 代表 机房 id 个 机房 bits 代表 机器 id 台 机器 lbits 这里 用来 记录 同一个 毫 秒内 产生 的 不同 idbits 可以 代表 的 最大 正整数 是 也就是说 可以用 这个 bits 代表 的 数字 来 区分 同一个 毫 秒内 的 个 不同 的 id 获取 id 流程 首先 自己 搞 一个 服务 然后 对 每个 机房 的 每个 机器 都 初始化 这么 一个 id 刚开始 这个 机房 的 这个 机器 的 序号 就是 然后 每次 接 收到 一个 请求 说 这个 机房 的 这个 机器 要 生成 一个 id 你 就 找到 对应 的 worker 生成 通过 synchronized 保证 线程 安全 获取 idbit 是 当前 毫秒 单位 的 一个时间 戳 然 后传 进来 的 以内 的 机房 id 和 以内 的 机器 id 如果 跟上 次 生成 id 的 时间 还在 一个 毫 秒内 毫秒 内存 序列 毫 秒内 序列 溢出 超过 序列 重置 为 阻 塞到 下一个 毫秒 重新 获取 时间 戳 如果 发 生了 系统 时间 回 调 也 就是 当前 时间 戳 大于 上 一次 的 时间 戳 l 方案 一是 发现 时钟 回 拨 后 算出 来回 拨 多少 保存为 时间 偏移量 然后 后面 每次 获取 时间 戳 都 加上 偏移量 每回 拨 一次 更新 一次 偏移量 l 方案 二是 只 在 第一次 生成 id 或 启动时 获取 时间 戳 并 保存 下来 每 生成 一个 id 就 计 下 数 每个 毫 秒数 能 生成 的 id 数 是 固定 的 到 生成 满了 再把 时间 戳 加 一 这样 就不 依赖于 系统 时间 了 每个 毫 秒数 的 使用率 也 最高 优点 高性能 高 可用 不依赖 数据库 完全 纯 内存容量 大 每秒 中 能 生成 数百万 的 自 增 idid 自 增 存入 数据库 中 索引 效率高 缺点 严重 依赖 系统 时间 系统 时间 被 回 调 或者 改变 可能会 造成 id 冲突 或者 重复 如何 实现 mysql 的 读写 分离 就是 基于 主从复制 架构 简单 来说 就是 搞 一个 主库 挂 多个 从 库 然后 我们 就 单单 只是 写 主库 然后 主库 会 自动 把 数据 给 同步 到 从 库 上去 mysql 主从复制 原理 的 是 啥 主要 原理 主库 将 变更 写入 binlog 日志 然后 从 库 连 接到 主库 之后 从 库 有 一个 io 线程 将 主库 的 binlog 日志 拷贝到 自己 本地 写入 一个 relay 日志 中 接着 从 库 中有 一个 sql 线程 从 relay 日志 读取 binlog 然后 执行 binlog 日志 中 的 内容 也 就是在 自己 本地 再次 执行 一遍 sql 这样 就可以 保证 自己 跟 主库 的 数据 是 一样 的 延时 问题 这里 有过 一个 非常重要 的 一点 就是 从 库 同步 主库 数据 的 过程 是 串行化 的 也就是说 主库 上 并行 的 操作 在从 库 上会 串行 执行 所以 这 就是 一个 非常重要 的 点了 由于 从 库 从 主库 拷贝 日志 以及 串行 执行 sql 的 特 点在 高 并发 场景 下 从 库 的 数据 一定 会比 主库 慢 一些 是 有 延时 的 压 测 过 大概 主库 并发 量 s 延时 几 毫秒 s 延时 几十 毫秒 当 达到 s 主库 都 快死了 此时 从 库 延 时会 达到 几秒钟 大概在 mysql 版本 之后 从 库 io 线程 读取 主库 的 binlog 日志 的 时候 也 可以 支持 多线程 读取 宕机 问题 对应 的 半 同步 复制 和 并行复制 场景 当 主库 突然 宕机 然后 恰好 数据 还没有 同步 到 从 库 那么 有些 数据 可 能从 库 上 是 还没 有的 有些 数据 可能 就 丢失 了 所以 mysql 实际上 在这 一块 有 两个 机制 一个是 半 同步 复制 用来 解决 主库 数据 丢失 问题 一个是 并行复制 用来 解决 主从 同步 延时 问题 半 同步 复制 也 就是 semisync 复制 指的是 主库 写入 bingo 日志 之后 吗 就 会将 强制 此时 立 即将 数据 同步 到 从 库 从 库 将 日志 写入 自己 本地 的 relaylog 之后 接着 会 返回 一个 ack 主库 主库 接 收到 至少 一个 从 库 的 ack 之后 才会 认为 操作 完 成了 并行复制 指的是 从 库 开启 多个 sql 线程 并行 读取 relaylog 中 不同 库 的 日志 然后 并发 重放 不同 库 的 日志 这是 库 级别 的 并行 mysql 主从 同步 延时 问题 精华 场景 先 插入 一条 数据 再把 它 查出来 然后 更新 这个 条 数据 在 生产 环境 达到 s 这个 时候 主从复制 延迟 大概是 小 几十 毫秒 那么 一些 数据 在 高峰期 时候 没有 更新 因为 延时 导致 查询 从 库 不能 立刻 查到 查询 时候 没有 数据 为 null 更新 通过 idnull 导致 更新 失败 l 重写 代码 写 代码 的 时候 插入 之后 直接 更新 不要 查询 再 更新 l 如果 必 须要 查询 插入 之后 设置 直连 主库 查询 再 更新 不 推荐 这种 方法 这种 读写 分离 的 意义 就 丧失了 l 分库 将 一个 主库 分为 多个 主库 每个 主库 的 写 并发 就 减 少了 几倍 此时 主从 延时 可以 忽略不计 l 打开 mysql 支持 的 并发 复制 多个 库 并行复制 但是 这种 在 高 并发 某个 库 单 库 并发 达到 s 并发 复制 还是 没有意义 的 事务 特性 l 原子 性 l 一致性 l 隔离 性 l 持久性 事务 的 隔离 级别 隔离 性 存在 的 问题 l 脏 写 两个 事务 都 更新 一个 数据 结果 有 个 一人 回 滚了 把 另外 一个人 更新 的 数据 也 回 滚 没了 l 脏 读 一个 事务 读 到了 另外 一个 事务 没有 提交 的 时候 修改 数据 结果 另外 一个 事务 回 滚了 下次 读 就读 不 到了 l 不可重复读 就是 多次 读 一条 数据 别的 事务 老是 修改 数据 值 还提 交了 多次 读到 的 值 不同 l 幻 读 就是 范围 查询 每次 查到 的 数据 不同 有时候 别的 事务 插 入了 新 的 值 就会 读到 更多 的 数据 几种 隔离 级别 lru 可以 读到 别人 没有 提交 的 事务 修改 的 数据 只能 避免 脏 写 lrc 可以 读到 人家 提交 的 事务 修 改过 的 数据 避免 的 脏 读 脏 写 lrr 不会 读到 别的 已经 提交 事务 修改 的 数据 避免了 脏 读 脏 写 不可重复读 l 串行 让 事务 都 串行 执行 可以 避免 所有 问题 mysql 实现 mvcc 机制 是 基于 undolog 多 版本 链条 readview 机制 来 做的 默认 rr 隔离 级别 就可以 避免 以上 所有 问题 undolog 每次 开启 事务 增 删改 操作 都会 记录 一下 当前 事务 的 id 修改 的 值 同时 会指 向 上个 事务 的 当前 所有 未 提交 的 事务 idmintrxid 当前 未 提交 的 最小 的 事务 idmaxtrxid 当前 未 提交 的 下一次 的 事务 idcreatorid 当前 事务 的 idmysql 在 rc 情况下 避免了 脏 读 脏 写 但是 没有 避免 不可 重复 读在 一个 事务 里 每次 查询 都会 重新 开启 readview 当 readview 有 其他 事务 提交 之后 下次 再 开启 readview 那么 未 提交 的 事务 ids 中就 没有 刚刚 提交 的 事务 id 那么 顺着 undolog 版本 链 读取 的 时候 会 读 刚刚 已经 提交 的 事务 rr 情况 避免了 脏 写 脏 读 不可重复读 幻 读在 一个 事务 里 只会 开启 一个 readview 每次 查询 都会 按照 相同 的 readview 这样 读取 undolog 版本 链 得到 的 结果 都 一样 避免 脏 写 通过 锁 机制 来 避免 的 脏 写 当 多个 事务 同时 想 对 一条 数据 写 的 时候 第一个 事务 会 创建 一个 锁 里面 包含着 着 自己 的 事务 id 和 等待 状态 fasle 然后 把 锁 跟 这行 事务 关联 在一起 另一个 事务 过 来想 的 时候 发现 这条 记录 被 加锁 那么 他 就会 排队 等待 同时 他 也 生成 一个 锁 里面 包含 自己 的 事务 id 和 等待 状态 为 true 当 第一个 事务 提 交了 释放 锁 他 会 唤醒 排在 他 后面 的 锁 改为 fasle 那么 后面 的 事务 就 获 取到 锁 了 mysql 存储 引擎 myisam 不支持 事务 不支持 外 键 约束 二级 复制 索引 索引 文件 和 数据文件 分开 的 适用于 那种 少量 的 插入 大量 的 查询 的 场景 innodb 支持 事务 走 聚 簇 索引 支持 高 并发 高 可用 等 成熟 的 数据库 架构 比如 分库 分 表 读写 分离 主 备 架构 聚 簇 索引 和 二级 索引 l 聚 簇 索引 叶子 节点 存 的 是 完整 的 数据 像 innodb 的 主键 索 用 的 就是 聚 簇 索引 l 二级 索引 叶子 节点 存 的 是 索引 如果是 myisam 存储 引擎 他 最终 叶子 节点 存 的 还有 地址 值 他 还 要回 表 到 一个 hash 表 中找到 具体 的 数据 innodb 他 存 的 是 索引 数据 和 主键 id 他 要回 表 到 主键 索引 找到 完整 的 数据 mysql 索引 结构 b 树 l 根 节点 至少 包含 个 孩子 l 每个 节点 最多 含有 m 个 孩子 mgtm 代表 几 阶 也 就是 每个 节点 最多 可以 存储 几个 关键字 l 除了 根 节点 和 叶 节点 外 其他 节点 至少有 ceilm 个 孩子 l 所有 的 叶子 结点 都在 同一 层 l 非 叶子 结点 存储 数据 关键字 的 个数 指向 儿子 的 指针 个数 l 数据 关键字 集合 分布 在 整棵树 中 任何 一个 数据 关键字 出现 且 只 出现在 一个 节 点中 数据 分散 对 磁盘 读写 更加 随机 代价 比 较高 l 搜索 可能在 非 叶子 节点 结束 搜索 不稳定 b 树 l 非 叶子 结点 的 子树 指针 和 节点 存储 的 索引 个数 相同 同时 指针 pi 的 区间 在 pi 到 pi 前 闭 后 开 b 树 是 前 开 后 开 l 相比 b 树 所有 叶子 结点 增加 一个 指针 指向 下个 一个 叶子 结点 这样 有利于 对 数据库 的 扫描 可以 支持 范围 搜索 l 所有 关键字 都在 叶子 结点 稳定 的 查找 效率 每次 都是 从 根 节点 找到 叶子 结点 这样 都 同 一在 同一个 板块 存 数据 这样 磁盘 读写 代价 更低 b 树 好处 l 每次 从 根 节点 查找 查找 效率 稳定 l 叶子 结点 顺序 相连 有利于 数据库 的 扫描 l 数据 都 存储 在 叶子 结点 有利于 磁盘 的 读写 索引 优化 排查 慢 sqll 慢 查询 的 开启 并 捕获 或 开启 全局 日志 lexplain 慢 sql 分析 合理 使用 索引 l 主键 自动 建立 唯一 索引 l 频繁 作为 查询 条件 的 字段 应该 创建 索引 l 频繁 更新 的 字段 不适合 创建 索引 因为 每次 更新 不单单是 更新 了 记录 还会 更新 索引 l 单键 组合 索引 的 选择 问题 who 在 高 并发 下 倾向 创建 组合 索引 l 组合 索引 遵守 最左 匹配 原则 l 查询 中 排序 的 字段 排序 字段 若 通过 索 引去 访问 将 大大提高 排序 速度 l 利用 索引 字符串 值 的 前缀 如果是 字符串 使用 字符串 前缀 l 尽量 使用 覆盖 索引 进行 查询 避免 回 表 带来 的 性能 损耗 l 联合 索引 like 范围 查 存在 函数 无效 索引 优缺点 索引 优势 io 成本 优势 类似 大学图书馆 建 书目 索引 提高 数据检索 的 效率 降低 数据库 的 io 成本 cpu 消耗 低 通过 索引 列 对 数据 进行 排序 降低 数据 排序 的 成本 降 低了 cpu 的 消耗 索引 缺点 空间 上 的 代价 一个 索引 都为 对应 一棵 b 树 树 中 每一个 节点 都是 一个 数据 页 一个 页 默认 会 占用 kb 的 存储空间 所以 一个 索引 也是 会 占用 磁盘空间 的 时间 上 的 代价 索引 是 对 数据 的 排序 那么 当 对表 中 的 数据 进行 增 删改 操作 时 都 需 要去 维护 修改 内容 涉及到 的 b 树 索引 所以在 进行 增 删改 操作 时 可能 需要 额外 的 时间 进行 一些 记录 移动 页面 分裂 页面 回收 等 操作 来 维护 好 排序 锁 机制 读 锁 与 写 锁 l 读 锁 共享 锁 sharedlockss 锁 l 写 锁 排他 锁 exclusivelocksx 锁 读 操作 显示 锁 将 查 找到 的 数据 加上 一个 s 锁 允许 其他 事务 继续 获取 这些 记录 的 s 锁 不能 获取 这些 记录 的 x 锁 会 阻塞 selectforupdate 显示 锁 将 查 找到 的 数据 加上 一个 x 锁 不允许 其他 事务 获取 这些 记录 的 s 锁 和 x 锁 写 操作 ldelete 删除 一条 数据 时 先 对 记录 加 x 锁 再 执行 删除 操作 linsert 插入 一条 记录 时会 先 加 隐 式 锁 来 保护 这条 新 插入 的 记 录在 本 事务 提交 前 不被 别的 事务 访 问到 lupdate 如果 被 更新 的 列 修改 前后 没有 导致 存储空间 变化 那么 会 先给 记录 加 x 锁 再 直接 对 记录 进行 修改 如果 被 更新 的 列 修改 前后 导致 存储空间 发 生了 变化 那么 会 先给 记录 加 x 锁 然后 将 记录 删掉 再 insert 一条 新 记录 隐 式 锁 一个 事务 插入 一条 记录 后 还未 提交 这条 记录 会 保存 本次 事务 id 而其 他 事务 如果 想来 读取 这个 记录 会 发现 事务 id 不 对应 所以 相当于 在 插入 一条 记录 时 隐 式 的 给 这条 记录 加了 一把 隐 式 锁 什么 是 悲观 锁 乐观 锁 l 悲观 锁 用 的 就是 数据库 的 行 锁 认为 数据库 会 发生 并发 冲突 直接 上来 就把 数据 锁住 其他 事务 不能 修改 直至 提交 了当 前 事务 l 乐观 锁 其实是 一种 思想 认为 不会 锁定 的 情况 下去 更新 数据 如果 发现 不对劲 才 不 更新 回 滚 在 数据库 中 往往 添加 一个 version 字段 来 实 现行 锁 范围 分类 llockrecnotgap 单个 行 记 录上 的 锁 行 锁 llockgap 间隙 锁 锁定 一个 范围 但不 包括 记录 本身 gap 锁 的 目的 是为了 防止 同一 事务 的 两次 当前 读 出现 幻 读 的 情况 间隙 锁 会 锁 从 你 查 的 id 到 最近 小 的 id 之间 会 锁住 llockordinary nextkey 锁定 一个 范围 并且 锁定 记录 本身 对于 行 的 查询 都是 采用 该 方法 主要 目的 是 解决 幻 读 的 问题 如何 做到 避免 死锁 l 尽量 控制 事务 大小 减少 锁定 资源量 和 时间 长度 l 合理 设计 索引 尽量 缩小 锁 的 范围 l 在 同一个 事务 中 尽可能 做到 一次 锁定 所 需要 的 所有 资源 减少 死锁 概率 降 l 尽可能 低 级别 事务 隔离 性能 优化 面试 合 辑 word 文档 下载 地址 链接 提 取码 爆 肝 一周 不眠不休 就为 点 赞 好评 收藏 三连 