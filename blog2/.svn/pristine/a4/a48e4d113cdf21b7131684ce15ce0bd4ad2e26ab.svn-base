mysql 面试题 mysql 面试题 mysql 涉及 的 内容 非常 非常 非常 多 所以 面试题 也 容易 写 的 杂乱 当年 我们 记着 几个 一 定要 掌握 的 重心 重点 的 题目 添 加了 重点 前缀 索引 锁 事务 和 隔离 级别 因为 mysql 还会 有 部分内容 和 运 维 相关 度 比 较高 所以 本文 我们 分成 两部 分开 发运 维 两部分 对于 开发 部分 我们 需要 掌握 对于 运 维 部分 更多 考验 开发 的 知识 储备 情况 当然 能 回答出来 是 比较好 的 特别是 对于 高级 开发 工程师 架构师 等 开发 为什么 互联网 公司 一般 选择 mysql 而 不是 oracle 免费 流行 够用 当然 这个 回答 要 稍微 润色 下 不过 一般 很少 问 这个 问 题了 数据库 的 三 范式 是什么 什么 是 反 模式 艿 艿 重点 在于 反 模式 的 回答 实际 开发 中 不会 严格遵守 三 范式 胖 友 直接 看 服务端 指南 数据 存储 篇 mysql 范式 与 反 模式 mysql 有 哪些 数据类型 mysql 支持 多种 类型 大致 可以 分为 三类 数值 日期 时间 和 字符串 字符 类型 具体 可以 看看 mysql 数据类型 文档 正确 的 使用 数据类型 对 数据库 的 优化 是 非常重要 的 mysql 中 varchar 与 char 的 区别 varchar 中 的 代表 的 涵义 varchar 与 char 的 区别 char 是 一种 固定 长度 的 类型 varchar 则是 一种 可变 长度 的 类型 varchar 中 的 涵义 最多 存放 个字符 varchar 和 存储 hello 所占 空间 一样 但 后者 在 排序 时会 消耗 更多 内存 因为 orderbycol 采用 fixedlength 计算 col 长度 memory 引擎 也 一样 所以 实际 场景 下 选择 合适 的 varchar 长度 还是 有 必要 的 int 中 的 代表 什么 涵义 int 中 的 不影响 字段 存储 的 范围 只 影响 展示 效果 具体 可以 看看 mysql 中 int 长度 的 意义 文章 金额 金钱 相关 的 数据 选择 什么 数据类型 方式 一 使用 int 或者 bigint 类型 如果 需要 存储 到 分 的 维度 需要 进行 放大 方式 二 使用 decimal 类型 避免 精度 丢失 如果 使用 java 语言 时 需要 使用 bigdecimal 进行 对应 一张 表里 面有 id 自 增 主键 当 insert 了 条 记录 之后 删 除了 第 条 记录 再把 mysql 重启 再 insert 一条 记录 这条 记录 的 id 是 还是 一般 情况下 我们 创建 的 表 的 类型 是 innodb 如果 新增 一条 记录 不 重启 mysql 的 情况下 这条 记录 的 id 是 但是 如果 重启 mysql 的话 这条 记录 的 id 是因为 innodb 表 只 把 自 增 主键 的 最大 id 记 录到 内存 中 所以 重启 数据库 或者 对表 optimize 操作 都 会使 最大 id 丢失 但是 如果 我们 使用 表 的 类型 是 myisam 那么 这条 记录 的 id 就是 因为 myisam 表 会把 自 增 主键 的 最大 id 记 录到 数据文件 里面 重启 mysql 后 自 增 主键 的 最大 id 也 不会 丢失 最后 还 可以 跟 面试官 装 个 x 生产 数据 不 建议 进行 物理 删除 记录 表 中有 大 字段 x 例如 text 类型 且 字段 x 不会 经常 更新 以 读 为 为主 请问 您是 选择 拆成 子表 还是 继续 放 一起 写出 您 这样 选择 的 理由 拆 带来 的 问题 连接 消耗 存储 拆分 空间 如果能 容忍 拆分 带来 的 空间 问题 拆 的话 最好 和 经常 要 查询 的 表 的 主键 在 物理 结构 上 放置 在一起 分区 顺序 io 减少 连接 消耗 最后 这是 一个 文本 列 再加 上一个 全文索引 来 尽量 抵消 连接 消耗 不 拆 可能 带来 的 问题 查询 性能 如果能 容忍 不 拆分 带来 的 查询 性能 损失 的话 上面 的 方案 在 某个 极致 条件下 肯定会 出现问题 那么 不 拆 就是 最好 的 选择 实际 场景 下 例如说 商品 表 数据量 比 较大 的 情况下 会将 商品 描述 单独 存储 到 一个 表 中 即 使用 拆 的 方案 mysql 有 哪些 存储 引擎 mysql 提供 了 多种 的 存储 引擎 具体 每种 存储 引擎 的 介绍 可以 看看 数据库 存储 引擎 如何 选择 合适 的 存储 引擎 提供 几个 选择 标准 然后 按照 标准 选择 对应 的 存储 引擎 即 可也 可以 根据 常用 引擎 对 比来 选择 你 使用 的 存储 引擎 使用 哪种 引擎 需要 根据 需求 灵活 选择 一个 数据库 中 多个 表 可以 使用 不同 的 引擎 以 满足 各种 性能 和 实际 需求 使用 合适 的 存储 引擎 将会 提高 整个 数据库 的 性能 是否 需要 支持 事务 对 索引 和 缓存 的 支持 是否 需要 使用 热 备 崩溃 恢复 能否 接受 崩溃 存储 的 限制 是否 需要 外 键 支持 艿 艿 目前 开发 已经 不 考虑 外 键 主要 原因是 性能 具体 可以 看看 从 mysql 物理 外 键 开始 的 思考 文章 目前 mysql 默认 的 存储 引擎 是 innodb 并且 也是 最 主流 的 选择 主要原因 如下 最 重要 支持 事务 支持 行 级 锁 和 表 级 锁 能 支持 更多 的 并发 量 查询 不 加锁 完全 不影响 查询 支持 崩溃 后 恢复 在 mysql 以及 之前 的 版本 默认 的 存储 引擎 是 myisam 但是 目前 已经 不再 更新 且 它有 几个 比较 关键 的 缺点 不支持 事务 使用 表 级 锁 如果 数据 量大 一个 插入 操作 锁定 表 后 其他 请求 都将 阻塞 艿 艿 也就是说 我们 不需 要花 太多 力 气在 myisam 的 学习上 请 说明 innodb 和 myisam 的 区别 innodbmyisam 事务 支持 不支持 存储 限制 tb 无 锁 粒度 行 锁 表 锁 崩溃 后 的 恢复 支持 不支持 外 键 支持 不支持 全文 检索 版本 后 支持 支持 更 完整 的 对比 可以 看看 数据库 存储 引擎 的 常用 引擎 对比 小节 请 说说 innodb 的 大 特性 艿 艿 貌似 我 面试 没被 问过 反正 我 是 没 弄懂 过 插入 缓冲 insertbuffer 二次 写 doublewrite 自适应 哈希 索引 ahi 预 读 readahead 为什么 selectcount fromtable 在 innodb 比 myisam 慢 对于 selectcount fromtable 语句 在 没有 where 条件 的 情况下 innodb 比 myisam 可能会 慢 很多 尤其在 大 表 的 情况下 因为 innodb 是 去 实时 统计 结果 会 全 表 扫描 而 myisam 内部 维持 了 一个 计数器 预存 了 结果 所以 直接 返回 即可 详细 的 原因 胖 友 可以 看看 高性能 mysql 之 count 统计 查询 博客 各种 不同 mysql 版本 的 innodb 的 改进 艿 艿 这是 一个 选择 了解 的 问题 mysql 下 innodb 引擎 的 主要 改进 接口 正常 关闭 时 可以 dump 出 bufferpool 的 spacepageno 重启 时 reload 加快 预热 速度 索引 和 表 的 统计 信息 持久 化 到 和 可提供 稳定 的 执行计划 支持 压缩 表 mysql 下 innodb 引擎 的 主要 改进 修改 varchar 字段 长度 有时 可以 使用 这里 的 有时 指的是 也 有些 限制 可见 mysqlonlineddl 的 一些 改进 bufferpool 支持 在线 改变 大小 bufferpool 支持 导出 部分 比例 支持 新建 并可以 在 其中 创建 多张 表 磁盘 临时 表 采用 innodb 存储 并且 存储 在 里面 以前 是 myisam 存储 透明 表 空间 压缩 功能 重点 什么 是 索引 索引 类似于 书籍 的 目录 想 找到 一本书 的 某个 特定 的 主题 需要 先 找到 书 的 目录 定位 对应 的 页码 mysql 中 存储 引擎 使用 类似 的 方式 进行 查询 先去 索引 中 查找 对应 的 值 然后 根据 匹配 的 索引 找到 对应 的 数据 行 索引 有 什么 好处 提高 数据 的 检索 速度 降低 数据库 io 成本 使用 索引 的 意义 就是 通过 缩小 表 中 需要 查询 的 记录 的 数目 从而 加快 搜索 的 速度 降低 数据 排序 的 成本 降低 cpu 消耗 索引 之所以 查 的 快 是因为 先将 数据 排好 序 若 该 字段 正好 需要 排序 则 正好 降 低了 排序 的 成本 索引 有 什么 坏处 占用 存储空间 索引 实际上 也是 一张 表记 录了 主键 与 索引 字段 一般 以 索引 文件 的 形式 存储 在 磁 盘上 降低 更新 表 的 速度表 的 数据 发 生了 变化 对应 的 索引 也 需要 一起 变更 从而 减低 的 更新 速度 否则 索引 指向 的 物理 数据 可能 不对 这 也是 索引 失效 的 原因 之一 索引 的 使用 场景 对 非常 小 的 表 大部分 情况下 全 表 扫描 效率 更高 对 中大型 表 索引 非常 有效 特大型 的 表 建立 和 使用 索引 的 代价 随着 增长 可以 使用 分区 技术 来 解决 实际 场景 下 mysql 分区表 很少 使用 原因 可以 看看 互联网 公司 为啥 不 使用 mysql 分区表 文章 对于 特大型 的 表 更 常用 的 是 分库 分 表 目前 解决方案 有 等等 索引 的 类型 索引 都是 实 现在 存储 引擎 层 的 主要有 六种 类型 普通 索引 最基本 的 索引 没有 任何 约束 唯一 索引 与 普通 索引 类似 但 具有 唯一性 约束 主键 索引 特殊 的 唯一 索引 不允许 有空 值 复合 索引 将 多个 列 组合 在一起 创建 索引 可以 覆盖 多个 列 外 键 索引 只有 innodb 类型 的 表 才 可以 使用 外 键 索引 保证 数据 的 一致性 完整性 和 实现 级联 操作 全文索引 mysql 自带 的 全文索引 只能 用于 innodbmyisam 并且 只 能对 英文 进行 全文 检索 一般 使用 全文索引 引擎 常用 的 全文索引 引擎 的 解决方案 有 等等 最为 常用 的 是 elasticsearch 具体 的 使用 可以 看看 服务端 指南 数据 存储 篇 mysql 如何 设计 索引 mysql 索引 的 创建 原则 注意 是 创建 噢 最适合 索引 的 列 是 出现在 where 子 句中 的 列 或 连接子 句中 的 列 而 不是 出现在 select 关键 字后 的 列 索引 列 的 基数 越大 索引 效果 越好 具体 为什么 可以 看看 如下 两篇 文章 mysql 索引 基数 理解 相对 简单 低 基数 索引 为什么 会对 性能 产生 负面影响 写 的 更 原理 所以 较为 难懂 根据 情况 创建 复合 索引 复合 索引 可以 提高 查询 效率 因为 复合 索引 的 基数 会 更大 避免 创建 过多 的 索引 索引 会 额外 占用 磁盘空间 降低 写 操作 效率 主键 尽可能 选择 较短 的 数据类型 可以 有效 减少 索引 的 磁盘 占用 提高 查询 效率 对 字符串 进行 索引 应该 定制 一个 前缀 长度 可以 节省 大量 的 索引 空间 mysql 索引 的 使用 注意事项 注意 是 使用 噢 应 尽量 避免 在 where 子句 中 使用 或 ltgt 操作符 否 则将 引擎 放弃 使用 索引 而 进行 全 表 扫描 优化 器 将 无法 通过 索 引来 确定 将要 命中 的 行数 因此 需要 搜索 该 表 的 所有 行 注意 columnisnull 也是 不可以 使用 索引 的 应 尽量 避免 在 where 子句 中 使用 or 来 连接 条件 否 则将 导致 引擎 放弃 使用 索引 而 进行 全 表 扫描 如 应 尽量 避免 在 where 子 句中 对 字段 进行 表达式 操作 这将 导致 引擎 放弃 使用 索引 而 进行 全 表 扫描 应 尽量 避免 在 where 子 句中 对 字段 进行 函数 操作 这将 导致 引擎 放弃 使用 索引 而 进行 全 表 扫描 不 要在 where 子 句中 的 左边 进行 函数 算术 运算 或 其他 表达式 运算 否则 系统 将 可能 无法 正确 使用 索引 复合 索引 遵循 前缀 原则 如果 mysql 评估 使用 索引 比 全 表 扫描 描 更慢 会 放弃 使用 索引 如果 此时 想要 索引 可以 在 语 句中 添加 强制 索引 列 类型 是 字符串 类型 查询 时 一定 要给 值 加 引号 否则 索引 失效 like 查询 不能 在前 因为 无法 使用 索引 如果 需要 模糊 匹配 可以 使用 全文索引 关于 这块 可以 看看 服务端 指南 数据 存储 篇 mysql 索引 使用 的 注意事项 文章 写 的 更加 细致 以下 三条 sql 如何 建 索引 只 建 一条 怎么 建 以 顺序 batime 建立 复合 索引 batime 对于 第一条 sql 因为 最新 mysql 版 本会 优化 where 子句 后面 的 列 顺序 以 匹配 复合 索引 顺序 想知道 一个 查询 用 到了 哪个 索引 如何 查看 explain 显示 了 mysql 如何 使用 索引 来 处理 select 语句 以及 连接 表 可以 帮助 选择 更好 的 索引 和 写出 更 优化 的 查询 语句 使用方法 在 select 语句 前 加上 explain 就可以 了 mysqlexplain 执行计划 详细 解释 重点 mysql 索引 的 原理 解释 mysql 索引 的 原理 篇幅 会比 较长 并且 网络 上 已经有 靠 谱 的 资料 可以 看 所以 艿 艿 这里 整 理了 几篇 胖 友 可以 对 照着 看 mysql 索引 背后 的 数据结构 及 算法 原理 写 的 一点 都不好 艿 艿 在 地铁 反复 看了 遍 强烈推荐 mysql 索引 原理 深入 理解 mysql 索引 原理 和 实现 为什么 索引 可以 加速 查询 下面 艿 艿 对 关键 知识 做 下 整理 方便 胖 友 回顾 几篇 好 一点 的 文章 mysql 索引 背后 的 数据结构 及 算法 原理 mysql 索引 原理 深入 理解 mysql 索引 原理 和 实现 为什么 索引 可以 加速 查询 mysql 有 哪些 索引 方法 在 mysql 中 我们 可以 看到 两种 索引 方式 btree 索引 hash 索引 mysqlbtree 索引 和 hash 索引 的 区别 什么 是 btree 索引 btree 是 为 磁盘 等外 存储 设备设计 的 一种 平衡 查找 树 因此在 讲 btree 之前 先了 解下 磁盘 的 相关 知识 系统 从 磁盘 读取 数据 到 内存 时 是以 磁盘 块 block 为 基本单位 的 位于 同一个 磁盘 块 中 的 数据 会被 一次性 读取 出来 而 不是 需要 什么 取 什么 innodb 存储 引擎 中有 页 page 的 概念 页 是 其 磁盘 管理 的 最小 单位 innodb 存储 引擎 中 默认 每个 页 的 大小 为 kb 可通过 参数 innodbpagesize 将 页 的 大小 设置 为 kkk 在 mysql 中 可通过 如下 命令 查看 页 的 大小 而 系统 一个 磁盘 块 的 存储空间 往往 没有 这么 大 因此 innodb 每次 申请 磁盘空间 时 都 会是 若干 地址 连续 磁盘 块 来 达到 页 的 大小 kbinnodb 在 把 磁盘 数据 读入 到 磁盘 时会 以 页 为 基本单位 在 查询 数据 时 如果 一个 页 中 的 每条 数据 都能 有助于 定位 数据 记录 的 位置 这 将会 减少 磁盘 io 次数 提高 查询 效率 btree 结构 的 数据 可以 让 系统 高效 的 找到 数据 所在 的 磁盘 块 为了 描述 btree 首先 定义 一条 记录 为 一个 二 元组 keydatakey 为 记录 的 键值 对应 表 中 的 主 键值 data 为 一行 记录 中 除 主键 外 的 数据 对于 不同 的 记录 key 值 互不 相同 一棵 m 阶 的 btree 有 如下 特性 每个 节点 最多 有 m 个 孩子 除了 根 节点 和 叶子 节点 外 其它 每个 节点 至少有 ceil m 个 孩子 若 根 节点 不是 叶子 节点 则 至少有 个 孩子 所有 叶子 节点 都在 同一 层 且不 包含 其它 关键字 信息 每个 非 叶子 节点 包含 n 个 关键字 信息 pppnkkn 关键字 的 个数 n 满足 ceil m ltnltmki in 为 关键字 且 关键字 升序 排序 pi in 为 指向 子 树根 节点 的 指针 p i 指向 的 子树 的 所有 节点 关键字 均 小于 ki 但 都 大于 k i btree 中 的 每个 节点 根据 实际情况 可以 包含 大量 的 关键字 信息 和 分支 如 下图 所示 为 一个 阶 的 btree 每个 节点 占用 一个 盘 块 的 磁盘空间 一个 节点 上有 两个 升序 排序 的 key 和 三个 指向 子 树根 节点 的 pointpoint 存储 的 是 子 节点 所在 磁盘 块 的 地址 两个 key 划 分成 的 三个 范围 域 对应 三个 point 指向 的 子树 的 数据 的 范围 域 以 根 节点 为 例 key 为 和 p 指针 指向 的 子树 的 数据 范围 为 小于 p 指针 指向 的 子树 的 数据 范围 为 p 指针 指向 的 子树 的 数据 范围 为 大于 模拟 查找 key 为 的 过程 根据 根 节点 找到 磁盘 块 读入 内存 磁盘 io 操作 第 次 比较 key 在 区间 找到 磁盘 块 的 指针 p 根据 p 指针 找到 磁盘 块 读入 内存 磁盘 io 操作 第 次 比较 key 在 区间 找到 磁盘 块 的 指针 p 根据 p 指针 找到 磁盘 块 读入 内存 磁盘 io 操作 第 次 在 磁盘 块 中 的 key 列表 中找到 eky 分析 上面 过程 发现 需要 次 磁盘 io 操 作和 次 内存 查找 操作 由于 内存 中 的 key 是 一个 有序 表 结构 可以 利用 二分法 查找 提高 效率 而 次 磁盘 io 操作 是 影响 整个 btree 查找 效率 的 决定因素 btree 相对于 avltree 缩 减了 节点 个数 使 每次 磁盘 io 取到 内存 的 数据 都发 挥了 作用 从而 提高了 查询 效率 什么 是 btree 索引 btree 是 在 btree 基础上 的 一种 优化 使其 更适合 实现 外 存储 索引 结构 innodb 存储 引擎 就是 用 btree 实现 其 索引 结构 从上 一节 中 的 btree 结构 图中 可以 看到 每个 节 点中 不仅 包含 数据 的 key 值 还有 data 值 而 每一个 页 的 存储空间 是 有限 的 如果 data 数据 较大 时 将会 导致 每个 节点 即 一个 页 能 存储 的 key 的 数量 很小 当 存储 的 数据量 很大 时 同样会 导致 btree 的 深度 较大 增大 查询 时 的 磁盘 io 次数 进而 影响 查询 效率 在 btree 中所 有 数据 记录 节点 都是 按照 键值 大小 顺序 存放在 同一 层 的 叶子 节点 上 而非 叶子 节点 上 只 存储 key 值 信息 这样 可以 大大 加大 每个 节点 存储 的 key 值 数量 降低 btree 的 高度 btree 相对于 btree 有 几点 不同 非 叶子 节点 只 存储 键值 信息 所有 叶子 节点 之间 都有 一个 链 指针 数据 记录 都 存放在 叶子 节点 中 将上 一节 中 的 btree 优化 由于 btree 的 非 叶子 节点 只 存储 键值 信息 假设 每个 磁盘 块 能 存储 个 键值 及 指针 信息 则 变成 btree 后 其 结构 如 下图 所示 通常在 btree 上有 两 个头 指针 一个 指向 根 节点 另一个 指向 关键字 最小 的 叶子 节点 而且 所有 叶子 节点 即 数据 节点 之间 是 一种 链式 环 结构 因此 可 以对 btree 进行 两种 查找 运算 一种 是 对于 主键 的 范围 查找 和 分页 查找 另一种 是 从 根 节点 开始 进行 随机 查找 可能 上面 例子 中 只有 条 数据 记录 看不出 btree 的 优点 下面 做一个 推算 innodb 存储 引擎 中 页 的 大小 为 kb 一般 表 的 主键 类型 为 int 占用 个 字节 或 bigint 占用 个 字节 指针 类型 也 一般 为 或 个 字节 也就是说 一个 页 btree 中 的 一个 节点 中 大概 存储 kb bb k 个 键值 因为 是 估 值 为 方便 计算 这里 的 k 取值 为 也就是说 一个 深度 为 的 btree 索引 可以 维护 亿条 记录 实际情况 中 每个 节点 可能 不能 填 充满 因此在 数据库 中 btree 的 高度 一般 都在 层 mysql 的 innodb 存储 引擎 在 设 计时 是 将 根 节点 常驻 内存 的 也就是说 查找 某一 键值 的 行 记录 时 最多 只需要 次 磁盘 io 操作 btree 有 哪些 索引 类型 在 btree 中 根据 叶子 节点 的 内容 索引 类型 分为 主键 索引 和 非 主键 索引 主键 索引 的 叶子 节点 存 的 数据 是 整行 数据 即 具体 数据 在 innodb 里 主键 索引 也 被称为 聚集 索引 clusteredindex 非 主键 索引 的 叶子 节点 存 的 数据 是 整行 数据 的 主键 键值 是 索引 在 innodb 里 非 主键 索引 也 被称为 辅助 索引 secondaryindex 辅助 索引 与 聚集 索引 的 区别 在于 辅助 索引 的 叶子 节点 并不 包含 行 记录 的 全部 数据 而是 存储 相应 行 数据 的 聚集 索引 键 即 主键 当 通过 辅助 索 引来 查询 数据 时 需要 进过 两步 首先 innodb 存储 引擎 会 遍历 辅助 索引 找到 主键 然后再 通过 主键 在 聚集 索引 中找到 完整 的 行 记录 数据 另外 innodb 通过 主键 聚 簇 数据 如果 没有 定义 主键 会 选择 一个 唯一 的 非 空 索引 代替 如果 没有 这样 的 索引 会 隐 式 定义 个 主键 作为 聚 簇 索引 再 另外 可能有 胖 友 有 和 艿 艿 的 一样 疑惑 在 辅助 索引 如果 相同 的 索引 怎么 存储 最终 存储 到 btree 非子 节 点中 时 它们 对应 的 主键 id 是 不同 的 所以 妥 妥 的如 下图 所示 聚 簇 索引 的 注意 点 有 哪些 聚 簇 索引 表 最大 限度 地 提高了 io 密集型 应用 的 性能 但它 也有 以下 几个 限制 插入 速度 严重 依赖于 插入 顺序 按照 主键 的 顺序 插入 是 最快 的 方式 否则 将会 出现 页 分裂 严重影响 性能 因此 对于 innodb 表 我们 一般 都会 定义 一个 自 增 的 id 列为 主键 关于 这一点 可能 面试官 会 换一个 问 法 例如 为什么 主键 需 要是 自 增 id 又 或者 为什么 主键 需要 带有 时间性 关联 更新 主键 的 代价 很高 因为 将会 导致 被 更新 的 行 移动 因此 对于 innodb 表 我们 一般 定义 主键 为 不可 更新 mysql 默认 情况下 主键 是 允许 更新 的 对于 mongodb 其 主键 是 不允许 更新 的 二级 索引 访问 需要 两次 索引 查找 第一次 找到 主 键值 第二次 根据 主 键值 找到 行 数据 当然有 一种 情况 可以 无需 二次 查找 基于 非 主键 索引 查询 但是 查询 字段 只有 主键 id 那么 在 二级 索引 中就 可以 查 找到 主键 id 建议 使用 整型 因为 每个 主键 索引 的 btree 节点 的 键值 可以 存储 更多 主键 id 每个 非 主键 索引 的 btree 节点 的 数据 可以 存储 更多 主键 id 什么 是 索引 的 最左 匹配 特性 当 btree 的 数据项 是 复合 的 数据结构 比如 索引 nameagesex 的 时候 btree 是 按照 从左到右 的 顺序 来 建立 搜索 树 的 比如 当 张三 f 这样 的 数据 来 检索 的 时候 btree 会 优先 比较 name 来 确定 下一步 的 所 搜 方向 如果 name 相同 再依 次 比较 age 和 sex 最后 得到 检索 的 数据 但 当 f 这样 的 没有 name 的 数据 来 的 时候 btree 就不 知道 下一步 该 查 哪个 节点 因为 建立 搜索 树 的 时候 name 就是 第一个 比较 因子 必 须要 先 根据 name 来 搜索 才能 知道 下一步 去 哪里 查询 比如 当 张三 f 这样 的 数据 来 检索 时 btree 可以用 name 来 指定 搜索 方向 但 下一个 字段 age 的 缺失 所以 只 能把 名字 等于 张三 的 数据 都 找到 然后再 匹配 性 别是 f 的 数据 了 这个 是 非常重要 的 性质 即 索引 的 最左 匹配 特性 myisam 索引 实现 myisam 索引 的 实现 和 innodb 索引 的 实 现是 一样 使用 btree 差别 在于 myisam 索引 文件 和 数据文件 是 分离 的 索引 文件 仅 保存 数据 记录 的 地址 myisam 索引 与 innodb 索引 的 区别 innodb 索引 是 聚 簇 索引 myisam 索引 是非 聚 簇 索引 innodb 的 主键 索引 的 叶子 节点 存储 着 行 数据 因此 主键 索引 非常 高效 myisam 索引 的 叶子 节点 存储 的 是 行 数据 地址 需要 再 寻址 一次 才能 得到 数据 innodb 非 主键 索引 的 叶子 节点 存储 的 是 主键 和 其他 带 索引 的 列 数据 因此 查询 时 做到 覆盖 索引 会 非常 高效 重点 请 说说 mysql 的 四种 事务 隔离 级别 插入 速度 严重 依赖于 插入 顺序 按照 主键 的 顺序 插入 是 最快 的 方式 否则 将会 出现 页 分裂 裂 严重影响 性能 因此 对于 innodb 表 我们 一般 都会 定义 一个 自 增 的 id 列为 主键 关于 这一点 可能 面试官 会 换一个 问 法 例如 为什么 主键 需 要是 自 增 id 又 或者 为什么 主键 需要 带有 时间性 关联 更新 主键 的 代价 很高 因为 将会 导致 被 更新 的 行 移动 因此 对于 innodb 表 我们 一般 定义 主键 为 不可 更新 mysql 默认 情况下 主键 是 允许 更新 的 对于 mongodb 其 主键 是 不允许 更新 的 二级 索引 访问 需要 两次 索引 查找 第一次 找到 主 键值 第二次 根据 主 键值 找到 行 数据 当然有 一种 情况 可以 无需 二次 查找 基于 非 主键 索引 查询 但是 查询 字段 只有 主键 id 那么 在 二级 索引 中就 可以 查 找到 主键 id 建议 使用 整型 因为 每个 主键 索引 的 btree 节点 的 键值 可以 存储 更多 主键 id 每个 非 主键 索引 的 btree 节点 的 数据 可以 存储 更多 主键 id 插入 速度 严重 依赖于 插入 顺序 按照 主键 的 顺序 插入 是 最快 的 方式 否则 将会 出现 页 分裂 严重影响 性能 因此 对于 innodb 表 我们 一般 都会 定义 一个 自 增 的 id 列为 主键 关于 这一点 可能 面试官 会 换一个 问 法 例如 为什么 主键 需 要是 自 增 id 又 或者 为什么 主键 需要 带有 时间性 关联 更新 主键 的 代价 很高 因为 将会 导致 被 更新 的 行 移动 因此 对于 innodb 表 我们 一般 定义 主键 为 不可 更新 mysql 默认 情况下 主键 是 允许 更新 的 对于 mongodb 其 主键 是 不允许 更新 的 二级 索引 访问 需要 两次 索引 查找 第一次 找到 主 键值 第二次 根据 主 键值 找到 行 数据 当然有 一种 情况 可以 无需 二次 查找 基于 非 主键 索引 查询 但是 查询 字段 只有 主键 id 那么 在 二级 索引 中就 可以 查 找到 主键 id 建议 使用 整型 因为 每个 主键 索引 的 btree 节点 的 键值 可以 存储 更多 主键 id 每个 非 主键 索引 的 btree 节点 的 数据 可以 存储 更多 主键 id 插入 速度 严重 依赖于 插入 顺序 按照 主键 的 顺序 插入 是 最快 的 方式 否则 将会 出现 页 分裂 严重影响 性能 因此 对于 innodb 表 我们 一般 都会 定义 一个 自 增 的 id 列为 主键 关于 这一点 可能 面试官 会 换一个 问 法 例如 为什么 主键 需 要是 自 增 id 又 或者 为什么 主键 需要 带有 时间性 关联 更新 主键 的 代价 很高 因为 将会 导致 被 更新 的 行 移动 因此 对于 innodb 表 我们 一般 定义 主键 为 不可 更新 mysql 默认 情况下 主键 是 允许 更新 的 对于 mongodb 其 主键 是 不允许 更新 的 二级 索引 访问 需要 两次 索引 查找 第一次 找到 主 键值 第二次 根据 主 键值 找到 行 数据 当然有 一种 情况 可以 无需 二次 查找 基于 非 主键 索引 查询 但是 查询 字段 只有 主键 id 那么 在 二级 索引 中就 可以 查 找到 主键 id 建议 使用 整型 因为 每个 主键 索引 的 btree 节点 的 键值 可以 存储 更多 主键 id 每个 非 主键 索引 的 btree 节点 的 数据 可以 存储 更多 主键 id 事务 就是 对 一系列 的 数据库 操作 比如 插入 多条 数据 进行 统一 的 提交 或 回 滚 操作 如果 插入 成功 那么 一起 成功 如果 中间 有 一条 出现异常 那么 回 滚 之前 的 所有 操作 这样 可以 防止 出现 脏 数据 防止 数据库 数据 出现问题 事务 的 特性 指的是 指的是 acid 如 下图 所示 原子 性 atomicity 一个 事务 transaction 中 的 所有 操作 或者 全部 完成 或者 全部 不 完成 不会 结束 在 中间 某个 环节 事务 在 执行 过程中 发生 错误 会被 恢复 rollback 到 事务 开始 前 的 状态 就像 这个 事务 从来没有 执行 过 一样 即 事务 不可分割 不可 约简 一致性 consistency 在 事务 开始 之前 和 事务 结束 以后 数据库 的 完整性 没有 被 破坏 这 表示 写入 的 资料 必须 完全符合 所有 的 预设 约束 触发器 级联 回 滚 等 隔离 性 isolation 数据库 允许 多个 并发 事务 同时 对 其 数据 进行 读写 和 修改 的 能力 隔离 性 可以 防止 多个 事务 并发 执 行时 由于 交叉 执行 而 导致 数据 的 不一致 事务 隔离 分为 不同 级别 包括 读 未 提交 readuncommitted 读 提交 readcommitted 可 重 复读 repeatableread 和 串行化 serializable 持久性 durability 事务处理 结束 后 对 数据 的 修改 就是 永久 的 即便 系统故障 也 不会 丢失 事务 的 并发 问题 实际 场景 下 事务 并不是 串行 的 所以会 带来 如下 三个 问题 脏 读 事务 a 读取 了 事务 b 更新 的 数据 然后 b 回 滚 操作 那么 a 读 取到 的 数据 是 脏 数据 不可重复读 事务 a 多次 读取 同一 数据 事务 b 在 事务 a 多次 读取 的 过程中 对 数据 作了 更新 并 提交 导致 事务 a 多次 读取 同一 数据 时 结果 不一致 幻 读 系统管理员 a 将 数据库 中所 有 学生 的 成绩 从 具体 分数 改为 abcde 等级 但是 系统管理员 b 就在 这个 时候 插 入了 一条 具体 分数 的 记录 当 系统管理员 a 改 结束 后 发现 还有 一条 记录 没有 改过来 就好像 发 生了 幻觉 一样 这 就叫 幻 读 小结 不可重复读 的 和 幻 读 很 容易 混淆 不可重复读 侧重于 修改 幻 读 侧重于 新增 或 删除 解决 不可重复读 的 问题 只需 锁住 满足 条件 的 行 解决 幻 读 需要 锁 表 mysql 事务 隔离 级别 会 产生 的 并发 问题 readuncommitted 未 提交 读 事务 中 的 修改 即使 没有 提 交对 其他 事务 也 都是 可见 的 会 导致 脏 读 readcommitted 提交 读 事务 从 开始 直到 提交 之前 所做 的 任何 修 改对 其他 事务 都是 不可 见 的 会 导致 不可重复读 这个 隔离 级别 也 可以 叫做 不可重复读 repeatableread 可 重 复读 一个 事务 按 相同 的 查询 条件 读取 以前 检索 过 的 数据 其他 事务 插 入了 满足 其 查询 条件 的 新 数据 产生 幻 行会 导致 幻 读 serializable 可 串行化 强制 事务 串行 执行 事务 隔离 级别 脏 读 不可重复读 幻 读读 未 提交 readuncommitted 是 是 是 读 已 提交 readcommitted 否 是 是 可 重 复读 repeatableread 否 否 是 x 串行化 serializable 否 否 否 mysql 默认 的 事务 隔离 级 别为 可 重 复读 repeatableread 上图 的 ltxgt 处 mysql 因为 其 间隙 锁 的 特性 导致 其 在 可 重 复读 repeatableread 的 隔离 级别 下不 存在 幻 读 问题 也就是说 上图 ltxgt 处 需要 改成 否 记住 这个 表 的 方式 我们 会 发现 它是 自 左上 向 右下 是 一个 对角线 当然 最好 是 去 理解 具体 的 实验 胖 友 可以 看看 mysql 的 四种 事务 隔离 级别 重点 请 说说 mysql 的 锁 机 制表 锁 是 日常 开发 中 的 常见问题 因此 也是 面试 当中 最常 见 的 考察 点 当 多个 查询 同一 时刻 进行 数据 修 改时 就会 产生 并发 控制 的 问题 mysql 的 共享 锁 和 排他 锁 就是 读 锁 和 写 锁 共享 锁 不 堵塞 多个 用户 可以 同时 读 一个 资源 互不 干扰 排他 锁 一个 写 锁 会 阻塞 其他 的 读 锁 和 写 锁 这样 可以 只允许 一个 用户 进行 写入 防止 其他用户 读取 正在 写入 的 资源 锁 的 粒度 表 锁 系统 开销 最 小会 锁定 整 张 表 myisam 使用 表 锁 行 锁 最大 程度 的 支持 并发 处理 但是 也 带 来了 最大 的 锁 开销 innodb 使用 行 锁 什么 是 悲观 锁 什么 是 乐观 锁 悲观 锁 它 指的是 对 数据 被 外界 包括 本系统 当前 的 其他 事务 以及 来自 外部 系统 的 事务处理 修改 持 保守 态度 因此在 整个 数据处理 过程中将 数据 处于 锁定 状态 悲观 锁 的 实现 往往 依靠 数据库 提供 的 锁 机制 也 只有 数据库 层 提供 的 锁 机制 才能 真正 保证 数据 访问 的 排他性 否则 即使 在 本系统 中 实现 了 加锁 机制 也 无法 保证 外部 系统 不会 修改 数据 在 悲观 锁 的 情况下 为了 保证 事务 的 隔离 性 就需要 一致性 锁定 读 读取 数据 时 给 加锁 其它 事务 无法 修改 这些 数据 修改 删除 数据 时 也要 加锁 其它 事务 无法 读取 这些 数据 乐观 锁 相对 悲观 锁 而言 乐观 锁 机制 采 取了 更加 宽松 的 加锁 机制 悲观 锁 大多数 情况下 依靠 数据库 的 锁 机制 实 现以 保证 操作 最大 程度 的 独占性 但 随之而来 的 就是 数据库 性能 的 大量 开销 特别是 对 长 事务 而言 这样 的 开销 往往 无法 承受 而 乐观 锁 机制 在 一定 程度 上 解决 了 这个 问题 乐观 锁 大多是 基于 数据 版本 version 记录 机制 实现 何谓 数据 版本 即为 数据 增加 一个 版本 标识 在 基于 数据库 表 的 版本 解决方案 中 一般 是 通 过为 数据库 表 增加 一个 version 字段 来 实现 读 取出 数据 时 将此 版本号 一同 读出 之后 更新 时 对此 版本号 加 一 此时 将 提交 数据 的 版本 数据 与 数据库 表 对应 记录 的 当前 版本 信息 进行 比对 如果 提交 的 数据 版本号 大于 数据库 表 当前 版本号 则 予以 更新 否则 认为是 过期数据 什么 是 死锁 多数 情况下 可以 认为 如果 一个 资源 被 锁定 它 总 会在 以后 某个 时间 被 释放 而 死锁 发生 在当 多个 进程 访问 同一 数据库 时 其中 每个 进程 拥有 的 锁 都是 其他 进程 所需 的 由此 造成 每个 进程 都 无法 继续下去 简单 的 说 进程 a 等待 进程 b 释放 他 的 资源 b 又 等待 a 释放 他 的 资源 这样 就 互相 等待 就 形成 死锁 虽然 进程 在 运行 过程中 可能发生 死锁 但 死锁 的 发生 也 必须 具备 一定 的 条件 死锁 的 发生 必须 具备 以下 四个 必要条件 互斥 条件 指 进程 对 所分 配到 的 资源 进行 排 它 性 使用 即在 一段 时间内 某 资源 只 由 一个 进程 占用 如果 此时 还有 其它 进程 请求 资源 则 请求者 只能 等待 直至 占有 资源 的 进程 用毕 释放 请 求和 保持 条件 指 进程 已经 保持 至少 一个 资源 但又 提 出了 新 的 资源 请求 而 该 资源 已被 其它 进程 占有 此时 请求 进程 阻塞 但 又对 自己 已 获得 的 其它 资源 保持 不放 不 剥夺 条件 指 进程 已 获得 的 资源 在 未 使 用完 之前 不能 被 剥夺 只 能在 使 用完 时 由 自己 释放 环路 等待 条件 指在 发生 死锁 时 必然 存在 一个 进程 资源 的 环形 链 即 进程 集合 ppppn 中 的 p 正在 等待 一个 p 占用 的 资源 p 正在 等待 p 占用 的 资源 pn 正在 等待 已被 p 占用 的 资源 下列 方法 有助于 最大 限度 地 降低 死锁 设置 获得 锁 的 超时 时间 通过 超时 至少 保证 最差 最差 最差 情况下 可以 有 退出 的 口子 按 同一 顺序 访问 对象 这个 是 最 重要 的 方式 避免 事务 中 的 用户 交互 保持 事务 简短 并在 一个 批处理 中 使用 低 隔离 级别 使用 绑定 连接 mysql 中 innodb 引擎 的 行 锁 是 通过 加在 什么 上 完成 或 称 实现 的 为什么 是 这 样子 的 innodb 是 基于 索 引来 完 成行 锁 例如 可以 根据 条件 来 完 成行 锁 锁定 并且 id 是 有 索引 键 的 列 如果 id 不是 索引 键 那么 innodb 将 完成 表 锁 并发 将 无从谈起 重要 mysql 查询 执行 顺序 mysql 查询 执行 的 顺序 是 select 具体 的 可以 看看 sql 查询 之 执行 顺序 解析 文章 重要 聊聊 mysqlsql 优化 可以 看看 如下 几篇 文章 php 面试 之 mysql 查询 优化 面试 mysql 常见问题 总结 第 题 另外 除了 从 sql 层面 进行 优化 也 可以 从 服务 务 器 硬件 层面 进一步 优化 mysql 具体 可以 看看 mysql 数据库 性能 优化 之 硬件 优化 编写 sql 查询 语句 的 考题 合集 道 mysql 查询 语句 面试题 mysql 开发 面试题 企业 面试题 最常 问 的 mysql 面试题 集合 二 mysql 数据库 cpu 飙 升到 的话 怎么 处 理当 cpu 飙升 到时 先用 操作系统 命令 top 命令 观察 是不是 mysqld 占用 导致 的 如果 不是 找出 占用 高 的 进程 并进 行 相关 处理 如果 此时 是 io 压力 比较 大可以 使用 iostat 命令 定位 是 哪个 进程 占 用了 磁盘 io 如果是 mysqld 造成 的 使用 showprocesslist 命令 看看 里面 跑 的 session 情况 是不是 有 消耗 资源 的 sql 在 运行 找出 消耗 高 的 sql 看看 执行计划 是否 准确 index 是否 缺失 或者 实在是 数据量 太大 造成 一般来说 肯 定要 kill 掉 这些 线程 同时 观察 cpu 使用率 是否 下降 等 进行 相应 的 调整 比如说 加 索引 改 sql 改 内存 参数 之后 再 重新 跑 这些 sql 也 可以 查看 mysql 慢 查询 日志 看 是否 有 慢 sql 也有 可能是 每个 sql 消耗 资源 并不多 但是 突然之间 有 大量 的 session 连 进来 导致 cpu 飙升 这种 情况 就需要 跟 应用 一 起来 分析 为何 连接数 会 激增 再 做出 相应 的 调整 比如说 限制 连接数 等 在 mysql 服务器 运行 缓慢 的 情况下 输入 什么 命令 能 缓解 服务器 压力 检查 系统 的 状态 通过 操作系统 的 一些 工具 检查 系统 的 状态 比如 cpu 内存 交换 磁盘 的 利用率 根据 经验 或与 系统 正常 时 的 状态 相 比对 有时 系统 表面上 看起 来看 空闲 这也 可能 不是 一个 正常 的 状态 因为 cpu 可能 正等待 io 的 完成 除此之外 还应 观 注 那些 占用 系统资源 cpu 内存 的 进程 使用 sar 来 检查 操作系统 是否 存在 io 问题 使用 vmstat 监控 内存 cpu 资源 磁盘 io 问题 处理方式 做 raid 提高 性能 网络 问题 telnet 一下 mysql 对外开放 的 端口 如果 不通 的话 看看 防火墙 是否 正确 设置 了 另外 看看 mysql 是不是 开启 了 skipnetworking 的 选项 如果 开启 请 关闭 检查 mysql 参数 检查 mysql 相关 状态值 关注 连接数 关注 下 系统 锁 情况 关注 慢 查询 slowquery 日志 innodb 的 事务 与 日志 的 实现 方式 有 多少 种 日志 redo 日志 undo 日志 日志 的 存放 形式 redo 在 页 修改 的 时候 先 写到 redologbuffer 里面 然后 写到 redolog 的 文件 系统 缓存 里面 fwrite 然后再 同步 到 磁盘 文件 fsyncundo 在 mysql 之前 undo 只能 存放在 ibdata 文件 里面 之后 可以 通过 设置 参数 把 undolog 存放在 ibdata 之外 事务 是 如何 通过 日志 来 实现 的 说得 越 深入 越好 艿 艿 这个 流程 的 理解 还是 比较简单 的 实际 思考 实现 感觉 还是 蛮 复杂 的 基本 流程 如下 因为 事务 在 修改 页 时 要 先记 undo 在记 undo 之前 要 记 undo 的 redo 然后 修改 数据 页 再记 数据 页 修改 的 redoredo 里面 包括 undo 的 修改 一定 要比 数据 页 先 持久 化 到 磁盘 当 事务 需 要回 滚 时 因为 有 undo 可以 把 数据 页 回 滚到 前 镜像 的 状态 崩溃 恢复 时 如果 redolog 中 事务 没有 对应 的 commit 记录 那么 需要用 undo 把 该 事务 的 修 改回 滚到 事务 开始 之前 如果有 commit 记录 就用 redo 前 滚到 该 事务 完成 时 并 提交 掉 mysqlbinlog 的 几种 日志 录入 格式 以及 区别 各种 日志 格式 的 涵义 binlog 有 三种 格式 类型 分别 如下 statement 每 一条 会 修改 数据 的 sql 都会 记 录在 binlog 中 优点 不需要 记录 每 一行 的 变化 减 少了 binlog 日志 量 节约 了 io 提高 性能 相比 row 能 节约 多少 性能 与 日志 量 这个 取决于 应用 的 sql 情况 正常 同一 条 记录 修改 或者 插入 row 格式 所 产生 的 日志 量 还 小于 statement 产生 的 日志 量 但是 考虑到 如果 带 条件 的 update 操作 以及 整 表 删除 alter 表 等 操作 row 格式 会 产生 大量 日志 因此在 考虑 是否 使用 row 格式 日志 时 应该 跟 据 应用 的 实际情况 其所 产生 的 日志 量 会 增加 多少 以及 带来 的 io 性能 问题 缺点 由于 记录 的 只是 执行 语句 为了 这些 语句 能在 slave 上 正确 运行 因此 还必须 记录 每条 语句 在 执行 的 时候 的 一些 相关 信息 以 保证 所有 语句 能在 slave 得到 和在 master 端 执行 时候 相同 的 结果 另外 mysql 的 复制 像 一些 特定 函数 功能 slave 可 与 master 上 要 保持一致 会有 很多 相关 问题 如 sleep 函数 lastinsertid 以及 udf 会 出现问题 使用 以下 函数 的 语句 也 无法 被 复制 loadfile uuid user foundrows sysdate 除非 启动时 启 用了 sysdateisnow 选项 同时 在 insertselect 会 产生 比 rbr 更多 的 行 级 锁 row 不 记录 sql 语句 上下文 相关 信息 仅 保存 哪条 记录 被 修改 优点 binlog 中 可以 不 记录 执行 的 sql 语句 的 上下文 相关 的 信息 仅 需要 记录 那一 条 记录 被 修 改成 什么 了 所以 rowlevel 的 日志 内容 会 非常 清楚 的 记 录下 每 一行 数据 修改 的 细节 而且 不会 出现 某些 特定 情况下 的 存储 过程 或 function 以及 trigger 的 调用 和 触发 无法 被 正确 复制 的 问题 缺点 所有 的 执行 的 语句 当 记 录到 日志 中 的 时候 都 将以 每行 记录 的 修 改来 记录 这样 可能会 产生 大量 的 日志 内容 比如 一条 update 语句 修改 多条 记录 则 binlog 中 每 一条 修改 都会 有 记录 这样 造成 binlog 日志 量 会 很大 特别是 当 执行 altertable 之类 的 语句 的 时候 由于 表 结构 修改 每条 记录 都 发生 改变 那么 该 表 每 一条 记录 都会 记 录到 日志 中 mixedlevel 是 以上 两种 level 的 混合 使用 一般 的 语句 修改 使用 statement 格式 保存 binlog 如 一些 函数 statement 无法 完成 主从复制 的 操作 则 采用 row 格式 保存 binlogmysql 会 根据 执行 的 每 一条 具体 的 sql 语句 来 区分 对待 记录 的 日志 形式 也 就是在 statement 和 row 之间 选择 一种 新版本 的 mysql 中 对 rowlevel 模式 也 被 做了 优化 并不是 所有 的 修改 都会 以 rowlevel 来 记 录像 遇到 表 结构 变更 的 时候 就会 以 statement 模式 来 记录 至于 update 或者 delete 等 修改 数据 的 语句 还是 会 记录 所有 行 的 变更 即 使用 row 模式 适用 场景 在 一条 sql 操 作了 多行 数据 时 statement 更 节省 空间 row 更 占用 空间 但是 row 模式 更 可靠 因为 互联网 公司 使用 mysql 的 功能 相对 少 基本 不 使用 存储 过程 触发器 函数 的 功能 选择 默认 的 语句 模式 statementlevel 默认 即可 结合 第一个 问题 每一种 日志 格式 在 复制 中 的 优劣 statement 可能 占用 空间 会 相对 小 一些 传 送到 slave 的 时间 可能 也 短 但是 没有 row 模式 的 可靠 row 模式 在 操作 多行 数据 时 更 占用 空间 但是 可靠 所以 这是 在 占用 空间 和 可靠 之间 的 选择 如何 在线 正确 清理 中 的 binlog 日志 记 录了 数据 中 的 数据 变动 便于 对 数据 的 基于 时间 点 和 基于 位置 的 恢复 但 日志 文件 的 大 小会 越来越大 占用 大量 的 磁盘空间 因此 需要 定时 清理 一部分 日志 信息 首先 查看 主从 库 正在 使用 的 binlog 文件名称 showmaster slave status 删除 之前 一 定要 备份 删除 指定 时间 前 的 日志 删除 指定 的 日志 文件 自动 删除 通过 设置 binlog 的 过期 时间 让 系统 自动 删除 日志 查看 过期 时间 设置 过期 时间 mysql 主从复制 的 流程 是 怎么样 的 mysql 的 主从复制 是 基于 如 下个 线程 的 交互 多线程 复制 里面 应该是 类 线程 master 上面 的 binlogdump 线程 该 线程 负责 将 master 的 binlogevent 传到 slaveslave 上面 的 io 线程 该 线程 负责 接收 master 传过来 的 binlog 并 写入 relaylogslave 上面 的 sql 线程 该 线程 负责 读取 relaylog 并 执行 如果是 多线程 复制 无论是 库 级别 的 假 多线程 还是 mariadb 或者 的 真正 的 多线程 复制 sql 线程 只 做 coordinator 只 负责 把 relaylog 中 的 binlog 读出来 然后 交给 worker 线程 woker 线程 负责 具体 binlogevent 的 执行 mysql 如何 保证 复制 过程中 数据一致性 在 mysql 以及 之前 slave 的 sql 线程 执行 的 relaylog 的 位置 只能 保 存在 文件 relayloginfo 里面 并且 该 文件 默认 每 执行 次 事务 做 一次 同步 到 磁盘 这 意味着 slave 意外 crash 重启 时 sql 线程 执行 到 的 位置 和 数据库 的 数据 是 不一致 的 将 导致 复制 报错 如果 不重 搭 复制 则有 可能会 导致 数据 不一致 mysql 引入 参数 将该 参数设置 为 table 时 mysql 将 sql 线程 执行 到 的 位置 存到 表 这样 更新 该 表 的 位置 和 sql 线程 执行 的 用户 事务 绑定 成 一个 事务 这样 slave 意外 宕机 后 slave 通过 innodb 的 崩溃 恢复 可以 把 sql 线程 执行 到 的 位置 和 用户 事务 恢复 到 一致性 的 状态 mysql 引入 gtid 复制 每个 gtid 对应 的 事务 在 每个 实例 上面 最多 执行 一次 这 极 大地 提高了 复制 的 数据一致性 mysql 引入 半 同步 复制 用户 安装 半 同步 复制 插件 并且 开启 参数 后 设置 超时 时间 可 保证 在 超时 时间内 如果 binlog 不 传到 slave 上面 那么 用户 提交 事务 时 不会 返回 直到 超时 后 切成 异步 复制 但是 如果 切成 异步 之前 用户 线程 提交 时 在 master 上面 等待 的 时候 事务 已经 提交 该 事务 对 master 上面 的 其他 session 是 可见 的 如果 这时 master 宕机 那么 到 slave 上面 该 事务 又不 可 见了 该 问题 直到 才 解决 mysql 引入 无损 半 同步 复制 引入 参 该 参数 默 认为 aftersync 指的是 在 切成 半 同步 之前 事务 不 提交 而是 接 收到 slave 的 ack 确认 之后 才 提交 该 事务 从此 复制 真正 可以 做到 无损 的 了 可以 再说 一下 的 无损 复制 情况下 master 意外 宕机 重启 后 发现有 bi inlog 没 传到 slave 上面 这 部分 binlog 怎么办 分种 情况 讨论 宕 机时 已经 切成 异步 了 是 宕 机时 还没 切成 异步 这个 怎么 判断 宕机 时有 没有 切成 异步 呢 分别 怎么 处理 mysql 如何 解决 主从复制 的 延时 性 是 单线程 复制 是 多 库 复制 对于 单 库 或者 单 表 的 并发 操作 是 没用 的 是 真正 意义 的 多线程 复制 它 的 原理 是 基于 groupcommit 只要 master 上面 的 事务 是 groupcommit 的 那 slave 上面 也 可以 通过 多个 worker 线程 去 并发 执行 和 mairadb 引入 多线程 复制 的 原理 基本 一样 工作 遇到 的 复制 bug 的 解决方法 的 多 库 复制 有时候 自己 会 停止 我们 写了 一个 脚本 重新 startslave 你 是否 做过 主从 一致性 校验 如果有 怎么 做的 如果 没有 你 打算 怎么做 主从 一致性 校验 有 多种 工具 例如 等 聊聊 mysql 备份 方式 备份 策略 是 怎么样 的 具体 的 胖 友 可以 看看 mysql 高级 备份 策略 主要有 几个 知识点 数据 的 备份 类型 常用 完全 备份 这是 大多数人 常用 的 方式 它可 以 备份 整个 数据库 包含 用户 表 系统 表 索引 视图 和 存储 过程 等 所有 数据库 对象 但它 需要 花费 更多 的 时间 和 空间 所以 一般 推荐 一周 做 一次 完全 备份 增量 备份 它是 只 备份 数据库 一部分 的 另一 种方法 它不 使用 事务 日志 相反 它 使用 整个 数据库 的 一种 新 映象 它比 最初 的 完全 备份 小 因为 它 只 包含 自 上次 完全 备份 以来 所 改变 的 数据库 它 的 优点 是 存储 和 恢复 速度快 推荐 每天 做 一次 差异 备份 常用 事务 日志 备份 事务 日志 是 一个 单独 的 文件 它 记录 数据库 的 改变 备份 的 时候 只需要 复制 自 上次 备份 以来 对 数据库 所做 的 改变 所以 只需要 很少 的 时间 为了 使 数据库 具有 鲁 棒 性 推荐 每小时 甚至 更 频繁 的 备份 事务 日志 文件 备份 数据库 可以 由 硬 盘上 的 许多 文件 构成 如果 这个 数据库 非常大 并且 一个 晚上 也 不能 将它 备份 完 那么 可以 使用 文件 备份 每晚 备份 数据库 的 一部分 由于 一般 情况下 数据库 不会 大 到 必须 使用 多个 文件 存储 所以 这种 备份 不是 很 常用 备份 数据 的 类型 热 备份 温 备份 冷 备份 备份 工具 快照 mysql 几种 备份 方式 mysql 一般 有种 备份 方式 逻辑 备份 使用 mysql 自带 的 mysqldump 工具 进行 备份 备份 成 sql 文件 形式 优点 最大 好处 是 能够 与 正在 运行 的 mysql 自动 协同 工作 在运 行 期间 可以 确保 备份 是 当时 的 点 它会 自动 将 对应 操作 的 表 锁定 不允许 其他用户 修改 只能 访问 可能会 阻止 修改 操作 sql 文件 通用 方便 移植 缺点 备份 的 速度 比较慢 如果是 数据量 很多 的 时候 就很 耗时间 如果 数据库 服务器 处在 提供给 用户服务 状态 在这 段长 时间 操作 过程中 意味着 要 锁定 表 一般 是 读 锁定 只 能读 不能 写入 数据 那么 服务 就会 影响 的 物理 备份 艿 艿 因为 现在 主流 是 innodb 所以 基本 不再 考虑 这种 方式 直接 拷贝 只 适用于 myisam 类型 的 表 这种 类型 的 表 是 与 机器 独立 的 但 实际情况 是 你 设计 数据库 的 时候 不可能 全部 使用 myisam 类型 表 你 也 不可能 因为 myisam 类型 表 与 机器 独立 方便 移植 于是就 选择 这种 表 这 并不是 选择 它 的 理由 缺点 你 不 能去 操作 正在 运行 的 mysql 服务器 在 拷贝 的 过程 中有 用户 通过 应用程序 访问 更新 数据 这样 就 无法 备份 当时 的 数据 可能 无法 移植 到 其他 机器 上去 双机 热 备份 当 数据量 太大 的 时候 备份 是 一个 很大 的 问题 mysql 数据库 提供 了 一种 主从 备份 的 机制 也 就是 双机 热 备 优点 适合 数据 量大 的 时候 现在 明白 了 大 的 互联网 公司 对于 mysql 数据 备份 都是 采用 热机 备份 搭建 多台 数据库 服务器 进行 主从复制 数据库 不能 停机 请问 如何 备份 如何 进行 全 备份 和 增量 备份 可以 使用 逻辑 备份 和 双机 热 备份 完全 备份 完整 备份 一般 一段时间 进行 一次 且 在 网站 访问量 最小 的 时候 这样 常 借助 批处理文件 定时 备份 主 要是 写 一个 批处理文件 在里面 写上 处理 程序 的 绝对路径 然后 把 要 处理 的 东西 写在 后面 即 完全 备份 数据库 增量 备份 对 ddl 和 dml 语句 进行 二进制 备份 且 无法 增量 备份 后 可以 如果 要 实现 增量 备份 需 要在 myini 文件 中 配置 备份 路径 即可 重启 mysql 服务器 增量 备份 就 启 动了 你 的 备份 工具 的 选择 备份 计划 是 怎么样 的 视 库 的 大小 来 定 一般来说 g 内 的 库 可以 考虑 使用 mysqldump 来 做 因为 mysqldump 更加 轻巧 灵活 备份 时间 选 在 业务 低峰 期 可以 每天 进 行都 进行 全 量 备份 mysqldump 备份 出来 的 文件 比 较小 压缩 之后 更小 g 以上 的 库 可以 考虑 用 xtrabackup 来 做 备份 速度 明显 要比 mysqldump 要快 一般 是 选择 一周 一个 全 备 其余 每天 进行 增量 备份 备份 时间 为 业务 低峰 期 备份 恢复时间 是 多长 物理 备份 恢复 快 逻辑 备份 恢复 慢 这里 跟 机器 尤其是 硬盘 的 速率 有 关系 以下 列举 几个 仅供参考 g 的 分钟 mysqldumpg 的 分钟 mysqldump g 的 分钟 mysqldump g 的 小时 xtrabackup t 的 小时 xtrabackup 逻辑 导入 时间 一般 是 备份 时间 的 倍 以上 备份 恢复 失败 如何 处理 首先在 恢复 之前 就应 该做 足 准备工作 避免 恢复 的 时候 出错 比如说 备份 之后 的 有效性 检查 权限 检查 空间 检查 等 如果 万一 报错 再 根据 报错 的 提示 来 进行 相应 的 调整 mysqldump 和 xtrabackup 实现 原理 是 最 简单 的 逻辑 备份 方式 在 备份 myisam 表 的 时候 如果 要 得到 一致 的 数据 就需要 锁 表 简单 而 粗暴 在 备份 innodb 表 的 时候 加上 选项 在 事务 开始 时刻 记 录下 binlogpos 点 然后 利用 mvcc 来 获取 一致 的 数据 由 于是 一个 长 事务 在 写入 和 更新 量 很大 的 数据库 上将 产生 非常 多 的 undo 显著 影响 性能 所以 要 慎用 优点 简单 可 针对 单 表 备份 在 全 量 导出 表 结构 的 时候 尤其 有用 缺点 简单 粗暴 单线程 备份 慢 而且 恢复 慢 跨 idc 有 可能 遇到 时区 问题 实际上 是 物理 备份 逻辑 备份 的 组 合在 备份 innodb 表 的 时候 它 拷贝 ibd 文件 并 一刻 不停 的 监视 redolog 的 变化 append 到 自己 的 事务 日志 文件 在 拷贝 ibd 文件 过程中 ibd 文件 本身 可能 被 写 花 这都 不是 问题 因为 在 拷贝 完成后 的 第一个 prepare 阶段 xtrabackup 采用 类似于 innodb 崩溃 恢复 的 方法 把 数据文件 恢复 到 与 日志 文件 一致 的 状态 并把 未 提交 的 事务 回 滚 如果 同时 需要 备份 myisam 表 以及 innodb 表 结构 等 文件 那么 就 需要用 来 获得 全局 锁 开始 拷贝 这些 不再 变化 的 文件 同时 获得 binlog 位置 拷贝 结束 后 释放 锁 也 停止 对 redolog 的 监视 如何 从 mysqldump 产生 的 全 库 备份 中 只 恢复 某一个 库 某一 张 表 具体 可见 mysql 全 库 备份 中 恢复 某个 库 和 某 张 表 以及 mysqldump 参数 ignoretable 介绍 文章 聊聊 mysql 集群 艿 艿 这块 艿 艿 懂 的 少 主要 找了 一些 网络 上 的 资料 五大 常见 的 mysql 高 可用 方案 高性能 高 可用 可 扩展 的 mysql 集群 如何 组建 对于 简历 中 写有 熟悉 mysql 高 可用 方案 我 一般 先 问他 现在 管理 的 数据库 架构 是什么 如果 他 只 说 出了 主 从而 没有 说 任何 ha 的 方案 那么 我 就可以 判断 出 他 没有 实际 的 ha 经验 不过 这时候 也 不能 就是 断定 他 不懂 mysql 高 可用 也 许是 没有 实际 机 会去 使用 那么 我 就 要问 mmm 以及 mha 以及 mmkeepalived 等 的 原理 实现 方式 以及 它们 之间 的 优势 和 不足 了 一般 这种 情况下 能说 出 这个 的 基本 没有 mmm 那 东西 好像 不靠 谱 据说 不稳定 但是 有人 在用 的 和 mysqlrouter 比较 像 都是 指定 可写 的 机器 和 只读 机器 mha 的话 一句话 说不完 可以 搜索 下 相关 博客 聊聊 mysql 安全 感兴趣 的 胖 友 可以 看看 保障 mysql 安全 的 个 最佳 方法 详解 mysql 安全 配置 mysql 有 哪些 日志 错误 日志 记录 了当 mysqld 启动 和 停止 时 以及 服务器 在 运行 过程中 发生 任何 严重错误 时 的 相关 信息 二进制 文件 记 录了 所有 的 ddl 数据 定义 语言 语句 和 dml 数据 操纵 语言 语句 不包括 数据 查询 语句 语句 以 事件 的 形式 保存 它 描述 了 数据 的 更改 过程 定期 删除 日志 默认 关闭 就是 我们 上面 看到 的 mysqlbinlog 日志 查询 日志 记 录了 客户端 的 所有 语句 格式 为 纯 文本格式 可以 直接进行 读取 log 日志 中 记 录了 所有 数据库 的 操作 对于 访问 频繁 的 系统 此 日志 对 系统 性能 的 影响 较大 建议 关闭 默认 关闭 慢 查询 日志 慢 查询 日志 记 录了 包含 所有 执行时间 超过 参数 longquerytime 单位 秒 所 设置 值 的 sql 语句 的 日志 纯 文本格式 重要 一 定要 开启 另外 错误 日志 和 慢 查询 日志 的 详细 解释 可以 看看 mysql 日志 文件 之 错误 日志 和 慢 查询 日志 详解 文章 聊聊 mysql 监控 你 是 如何 监控 你们 的 数据库 的 监控 的 工具 有 很多 例如 zabbixlepus 我 这里 用 的 是 lepus 对 一个 大 表 做 在线 ddl 怎么 进行 实施 的 才能 尽可能 降低 影响 使用 具体 可以 看看 mysql 大 表 在线 dml 神器 文章 另外 还有 一些 其它 的 工具 胖 友 可以 搜索 下 