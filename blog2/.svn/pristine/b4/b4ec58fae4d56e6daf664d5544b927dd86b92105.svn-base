浅析 innodb 索引 结构 导读 innodb 表 的 索引 有 哪些 特性 以及 索引 组织 结构 是 怎样 的 innodb 聚集 索引 特点 我们 知道 innodb 引擎 的 聚集 索引 组织 表 必然 会有 一个 聚集 索引 行 数据 rowdata 存储 在 聚集 索引 的 叶子 节点 除了 发生 overflow 的 列 参见 后面 简称 前置 文 并且 其 存储 的 相对 顺序 取决于 聚集 索引 的 顺序 这里 说 相对 顺序 而 不是 物理 顺序 是因为 叶子 节点 数据 页 中行 数据 的 物理 顺序 和 相对 顺序 可能 并不是 一致 的 放在 后面 会讲 innodb 聚集 索引 的 选择 先后顺序 是 这样 的如 果有 显 式 定义 的 主键 primarykey 则会 选择 该 主键 作为 聚集 索引 否则 选择 第一个 所有 列 都不 允许 为 null 的 唯一 索引 若 前 两者 都没有 则 innodb 会 选择 内置 的 dbrowid 作为 聚集 索引 命名为 genclustindex 特别 提醒 dbrowid 占用 个 字节 每次 自 增 且 是 整个 实例 内 全局 分配 也就是说 当前 实例 如果有 多个 表 都 采 用了 内置 的 dbrowid 作为 聚集 索引 则在 这些 表 插入 新 数据 时 他们 的 内置 dbrowid 值 并不是 连续 的 而是 跳跃 的 像 下面 这样 t 表 的 rowidt 表 的 rowidinnodb 索引 结构 innodb 默认 的 索引 数据结构 采用 b 树 空间 索引 采用 r 树 索引 数据 存储 在 叶子 节点 innodb 的 基本 io 存储 单位 是 数据 页 page 一个 page 默认 是 kb 我们 在 前置 文说 过 每个 page 默认 会 预留 空闲 空间 用于 后续 数据 变长 更新 所需 因此在 最理想 的 顺序 插入 状态下 其 产生 的 碎片 也 最少 这时候 差不多 能 填满 的 page 空间 如果是 随机 写入 的话 则 page 空间 利用率 大概是 当 时 索引 最多 长度 为 字节 当 时 索引 最大 长度 为 字节 当 pagesize 不是 默认 的 kb 时 最大 索引 长度 限制 也 会 跟着 发生变化 我们 接下来 分别 验证 关于 innodb 索引 的 基本 结构 特点 首先 创建 如下 测 试表 idint notnullcvarchar id keyc c 用 下面 的 方法 写入 条 测试数据 setuuiduuid setuuiduuid rand uuidconcat uuiduuid 看下 t 表 的 整体 结构 用 innodbruby 工具 查看 用 innblock 工具 查看 blocknolevel 可以 看到 索引 id 索引 类型 根 节点 pageno 索引 层高 主键 索引 聚集 索引 辅助 索引 innodb 索引 特点 验证 特点 聚集 索引 叶子 节点 存储 整行 数据 先 扫描 第 个 page 截取 其中 第一条 物理 记录 的 内容 第一条 物理 记录 很明显 的 确是 存储 了 整条 数据 的 内容 聚集 索引 树 的 键值 key 是 主键 索引 值 i 聚集 索引 节点 值 value 是 其他 非 聚集 索引 列 ccc 以及 隐含 列 优化 建议 尽量 不要 存储 大 对象 数据 使得 每个 叶子 节点 都能 存储 更多 数据 降低 碎片 率 提高 bufferpool 利用率 此外 也 能 尽量 避免 发生 overflow 特点 聚集 索引 非 叶子 节点 存储 指向 子 节点 的 指针 对上 面的 测 试表 继续 写入 新 数据 直到 聚集 索引 树 从一 层 分 裂成 两层 我们 根据 旧 文 innodb 表 聚集 索引 层高 什么时候 发生变化 里 的 计算 方式 推算出来 预计 一个 叶子 节点 最多 可 存储 条 记录 因此在 插入 第 条 记录 时 就会 从一 层 高度 分 裂成 两层 高度 经过 实测 也 的 确是 如此 fromtcount 此时 可以 看到 根 节点 依旧是 pageno 而 叶子 节点 变 成了 两个 page 由此可知 根 节点 上 应该 只有 两条 物理 记录 存储 着 分别 指向 pageno 这两个 page 的 指针 我们 解析 下 号 page 看看 它 的 具体 结构 第一条 记录 是 第一条 记录 只 存储 key 值 值 是 指向 的 叶子 节点 pagenolengthgt 整条 记录 消耗 字节 除去 key 值 字节 外 指针 也 需要 字节 第二条 记录 只 存储 key 值 值 是 指向 的 叶子 节点 pagenolengthgt 优化 建议 索引 列 数据 长度 越小 越好 这样 索引 树 存储 效率 越高 在 非 叶子 节点 能 存储 越多 数据 延缓 索引 树 层高 分裂 的 速度 平均 搜索 效率 更高 特点 辅助 索引 同时 会 存储 主键 索引 列 值 在 辅助 索引 中 总是 同时 会 存储 主键 索引 或者说 聚集 索引 的 列 值 其 作用 就是 在对 辅助 索引 扫描 时 可以 从 叶子 节点 直接 得到 对应 的 聚集 索引 值 并可 根据 该 值 回 表 查询 获取 行 数据 如果 需 要回 表 查询 的话 这个 特性 也 被称为 indexextensions 版本 之后 的 优化 器 新 特性 详见 此 外在 辅助 索引 的 非 叶子 节 点中 索引 记录 的 key 值 是 索引 定义 的 列 值 而 对应 的 value 值 则是 聚集 索引 列 值 简称 pkv 如果 辅助 索引 定义 时 已经 包 含了 部分 聚集 索引 列 则 索引 记录 的 value 值 是 未被 包含 的 余下 的 聚集 索引 列 值 创建 如下 测 试表 createtablet aint ab keyk cb 随机 插入 一些 测试数据 调用 shell 脚本 写入 条 数据 rand left md uuid left uuid left uuid 实际 写入 条 数据 其中 有条 主键 冲突 失败 fromtcount 解析 数据结构 主键 此处 给 解析 成 b 列 的 值了 实际上 是 指向 叶子 节点 的 指针 即 列 真实 值 是 此处 解析 不准 确 实际上 是 下一 条 记录 的 recordheader 共 个 字节 同上 其实是 childpagenumber 而非 b 列 的 值 数据 长度 字节 顺便 说下 辅助 索 引上 没 存储 trxidrollptr 这些 他们 只 存储 在 聚集 索 引上 上面 用 innodbruby 工具 解析 的 非 叶子 节点 部分内容 不够 准确 所以 我们 用 二进制 方式 打开 数据文件 二次 求证 确认 此处 也 可以用 hexdump 工具 找到 辅助 索引 所在 的 那部 分 数据 参考 page 物理 结构 方式 进行 解析 得到 下面 的 结果 第一条 记录 recordheader 字节 现在 反过 来看 上面 用 innodbruby 工具 解析 出来 的 pagedump 结果 应该是 这样 的 才 对 我 只 选取 一条 记录 请 自行 对比 和 之前 的 不同之处 可以 看到 的确 如 前面 所说 辅助 索引 的 非 叶子 节点 的 value 值 存储 的 是 聚集 索引 列 值 优化 建议 辅助 索引 列 定义 的 长度 越小 越好 定义 辅助 索引 时 没必要 显 式 的 加上 聚集 索引 列 版本 之后 特点 没有 可用 的 聚集 索引 列 时会 使用 内置 的 rowid 作为 聚集 索引 创建 几个 像 下面 这样 的 表 使其 选择 内置 的 rowid 作为 聚集 索引 cint engineinnodb 循环 对 几个 表 写 数据 查看 tntn 表里 的 数据 这里 由于 innodbruby 工具 解析 的 结果 不 准确 所以 我 改用 hexdump 来 分析 其中 表示 dbrowid 的 值 分 别是 tngt gt tngt gt tngt gt 很明显 内置 的 dbrowid 的 确是 在 整个 实例 级别 共享 自 增 分配 的 而 不是 每个 表 独享 一个 dbrowid 序列 我们 可以 想象 下 如果 一个 实例 中有 多个 表 都 用到 这个 dbrowid 的话 势必会 造成 并发 请求 的 竞争 等待 此外 也 可能会 造成 主从复制 环境 下 从 库 上 relaylog 回放 时 可能会 因为 数据 扫描 机制 的 问题 造成 严重 的 复制 延迟 问题 详情 参考 从 库 数据 的 查找 和 参数 优化 建议 自行 显示 定义 可用 的 聚集 索引 主键 索引 不 要让 innodb 选择 内置 的 dbrowid 作为 聚集 索引 避免 潜在 的 性能 损失 篇幅 已经 有点 大 了 本次 的 浅析 工作 就 先到 这里 吧 以后 再 继续 几点 总结 最后 针对 innodb 引擎 表 总结 几条 建议 吧 每个 表 都要 有 显 式 主键 最好 是 自 增 整型 且 没有 业务 用途 无论是 主键 索引 还是 辅助 索引 都 尽可能 选择 数据类型 较小 的 列 定义 辅助 索引 时 没必要 显 式 加上 主键 索引 列 针对 mysql 之后 行 数据 越短 越好 如果 每个 列 都是 固 定长 的 则 更好 不是 像 varchar 这样 的 可变 长度 类型 上述 测试 环境 基于 的 版 本是 perconaserver 我 自己 下载 源码 编译 的 延伸 阅读 最后 欢迎 扫 码 订阅 乱弹 mysql 专栏 快人 一步 获取 我 最新 的 mysql 技术 分享 