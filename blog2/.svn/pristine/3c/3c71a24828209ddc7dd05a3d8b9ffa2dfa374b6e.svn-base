session 详解 什么 是 session 对 tomcat 而言 session 是 一块 在 服务器 开辟 的 内存空间 其 存储 结构 为 的 目的 http 协议 是 一种 无 状态 协议 即 每次 服务 端接 收到 客户端 的 请求 时 都是 一个 全新 的 请求 服务器 并不知道 客户端 的 历史 请求 记录 session 的 主要 目的 就是 为了 弥补 http 的 无 状态 特性 简单 的 说 就是 服务器 可以 利用 session 存储 客户端 在 同一个 会话 期间 的 一些 操作 记录 实现 机制 先看 两个 问题 如下 服务器 如何 判断 客户端 发送 过来 的 请 求是 属于 同一个 会话 答 用 sessionid 区分 sessionid 相同 的 即 认为是 同一个 会话 在 tomcat 中 sessionid 用 jsessionid 表示 服务器 客户端 如何 获取 在其 之间 是 如何 传输 的 呢 答 服务器 第一次 接 收到 请求 时 开辟 了 一块 session 空间 创 建了 session 对象 同时 生成 一个 sessionid 并 通过 响应 头 的 命令 向 客户端 发送 要求 设置 cookie 的 响应 客户端 收到 响应 后 在 本机 客户端 设置 了 一个 的 cookie 信息 该 cookie 的 过期 时间 为 浏览器 会话 结束 接下来 客户端 每次 向 同一个 网站 发送 请求 时 请求 头 都会 带上 该 cookie 信息 包含 sessionid 然后 服务器 通过 读取 请求 头中 的 cookie 信息 获取 名 称为 jsessionid 的 值得 到 此次 请求 的 sessionidps 服务器 只 会在 客户端 第一次 请求 响应 的 时候 在 响应 头上 添加 信息 接下来 在 同一个 会话 的 第二 第三次 响应 头里 是 不会 添加 信息 的 而 客户端 是 会在 每次 请求 头 的 cookie 中 带上 jsessionid 信息 举个 例子 以 chrome 浏览器 为 例 访问 一个 基于 tomcat 服务器 的 网站 的 时候 浏览器 第一次 访问 服务器 服务器 会在 响应 头 添加 信息 要求 客户端 设置 cookie 如 下图 同时 我们 也 可以 在 浏览器 中找到 其 存储 的 sessionid 信息 如 下图 接下来 浏览器 第二次 第三次 访问 服务器 观察 其 请求 头 的 cookie 信息 可以 看到 jsessionid 信息 存储 在 cookie 里 发送给 服务器 且 响应 头里 没有 setcookie 信息 如 下图 只要 浏览器 未 关闭 在 访问 同一个 站点 的 时候 其 请求 头 cookie 中 的 jsessionid 都是 同一个 值 被 服务器 认为是 同一个 会话 再 举个 简单 的 例子 加深 印象 新建 个 web 工程 并 写 一个 servlet 在 doget 中 添加 如下 代码 主 要做 如下 工作 首 先从 session 中 获取 key 为 count 的 值 累加 存入 session 并 打印 然后 每次 从 请求 中 获取 打印 cookie 信息 从 响应 中 获取 打印 header 的 setcookie 信息 getattribute count null setattribute count write getattribute count tostring setattribute counta write a if cookiesnull for sbappend cookiegetname cookiegetvalue sbdeletecharat sblength 第 index 次 访问 第 index 次 访问 setcookie 部署 到 tomcat 后 连续 访问 该 servlet 观察 控制台 输出 如下 客户端 第一次 访问 服务器 的 时候 在 服务端 的 响应 头里 添 加了 jsessionid 信息 且 接下来 客户端 的 每次 访问 都会 带上 该 jsessionid 其实 这里有 一个 问题 session 劫持 只要 用户 知道 jsessionid 该 用户 就可以 获 取到 jsessionid 对应 的 session 内容 还是 以 上面 这个 例子 为 例 我 先用 ie 浏览器 访问 该 站点 比如 连续 访 问了 次 此时 session 中 的 count 值 为 查看 该 会话 的 sessionid 为 aabbcedcfe 接下来 打开 chrome 控制台 将 ie 浏览器 获取 过来 的 jsessionid 信息 aabbcedcfe 写入 到 cookie 中 如下 接着 删除 其中 的 一个 只留下 jsessionid 为 aabbcedcfe 的 cookie 刷新 页面 发现 我们 从 session 获取 的 count 值 已经 变 成了 说明 此次 chrome 浏览器 的 请求 劫持 了 ie 浏览器 会话 中 的 sessiontomcat 中 的 session 实现 tomcat 中一 个 会话 对应 一个 session 其 实现 类 是 standardsession 查看 源码 可以 找到 一个 attributes 成员 属性 即 存储 session 的 数据结构 为 支持 高 并发 的 hashmap 实现 那么 tomcat 中 多个 会话 对应 的 session 是 由谁来 维护 的 呢 managerbase 类 查看 其 代码 可以 发现 其 有 一个 sessions 成员 属性 存储 着 各个 会话 的 session 信息 接下来 看一下 几个 重要 的 方法 服务器 查找 session 对象 的 方法 客户端 每次 的 请求 tomcat 都 会在 hashmap 中 查找 对应 的 key 为 jsessionid 的 session 对象 是否 存在 可以 查看 request 的 dogetsession 方法 源码 如下 源码 viewcode 先看 dogetsession 方法 中 的 如下 代码 这个 一般 是 第一次 访问 的 情况 即 创建 session 对象 session 的 创建 是 调 用了 managerbase 的 createsession 方法来 实现 的 另外 注意 方法 该 方法 的 功能 就是 上面 提到 的 往 响应 头 写入 setcookie 信息 最后 还要 调用 sessionaccess 方法 记 录下 该 session 的 最后 访问 时间 因为 session 是 可以 设置 过期 时间 的 sessionid sessionnull ampamp getcontext null contains issecure cookie if sessionnull returnsession 再看 dogetsession 方法 中 的 如下 代码 这个 一般 是 第二次 以后 访问 的 情况 通过 managerbase 的 findsession 方法 查找 session 其实 就是 利用 map 的 key 从 中 拿取 对应 的 value 这里 的 key 即 也 即 jsessionid 同时 还要 调用 sessionaccess 方法 记 录下 该 session 的 最后 访问 时间 if catch ioexceptione sessionnullif sessionnull sessionnullif sessionnull sessionaccess return session 在 session 对象 中 查找 和 设置 keyvalue 的 方法 这个 我们 一般 调用 方法 getattribute 方法 很简单 就是 根据 key 从 map 中 获取 方法 稍微 复 杂点 除了 设置 key yvalue 外 如果 添 加了 一些 事件 监听 的话 还要 通知 执行 如 存在 的 问题 安全性 session 劫持 这个 前面 已经 举过 例子 了 增加 服务器 压力 因为 session 是 直接 存储 在 服务器 的 内存 中 的 如果 存在 多台 服务器 的话 还 存在 session 同步 问题 当然 如果 只有 一台 tomcat 服务器 的话 也就 没有 session 同步 的 事情 了 然而 现在 一般 的 应用 都会 用到 多台 tomcat 服务器 通过 负载 均衡 同一个 会话 有 可能 会被 分 配到 不同 的 tomcat 服务器 因此 很可能 出现 session 不一致 问题解决 session 同步 问题 实际上 主 要是 保证 能够 抽 离 出 一块 共享 空间 存放 session 信息 且 这块 空间 不同 的 tomcat 服务器 都可以 访 问到 一般 这块 共享 的 空间 可 以是 数据库 或者 某 台 服务器 的 内存空间 甚至 硬盘空间 或者 客户端 的 cookie 也是 可以 的 author 风 一样 的 码 农 转 载于 