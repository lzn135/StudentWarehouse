mybatis 学习 二 mybatis 入门教程 和 简单 应用 mybatis 学习 二 mybatis 入门教程 和 简单 应用 前言 一 mybatis 简介 orm 简介 mybatis 简介 二 基本 应用 demo 入门 应用 mybatis 官方 地址 环境 搭建 引入 相关 maven 依赖 本地 数据库 新建 user 用户 表 新建 user 实体类 新建 usermapper 映射 配置文件 usermapperxml 新增 mybatis 核心 配置文件 sqlmapconfigxml 测试 简单 的 crud 栗子 查询 新增 修改 删除 dao 层 实现 的 方式 传统 的 实现 方式 实现 类 调用 sqlsession 代理 的 实现 方式 配置文件 属性 说明 xml 配置文件 属性 如何 设置 属性 mybatis 属性 加载 顺序 占位 符 指定 一个 默认值 settings 设置 typealiases 类型 别名 typehandlers 类型 处理器 objectfactory 对象 工厂 plugins 插件 environments 环境 配置 事务 管理器 datasource 数据源 数据库 厂商 标识 mappers 映射器 xml 映射 文件 mapperxmlselect 标签 insertupdate 和 delete 标签 sql 标签 参数 字符串 替换 结果 映射 自动 映射 缓存 设置 缓存 使用 自定义 缓存 cacheref 动态 sqlif 标签 标签 trimwhereset 标签 foreach 标签 bind 标签 多 数据库 支持 动态 sql 中 的 插入 脚本语言 三 彩蛋 前言 接上 一篇 mybatis 学习 一 基础 概念 和 简单 自定义 持久 层 框架 demo 一 mybatis 简介 orm 简介 对象 关系 映射 的 缩写 orm 完成 面向对象 的 编程 语言 到 数据库 的 映射 orm 把关 系 数据库 包 装成 面向对象 的 模型 采用 orm 框架 后 应用程序 不再 直接 访问 数据库 而是 用 面向对象 的 方式 操作 持久 化 对象 orm 框架 本身 把 这些 操作 转变成 数据库 底层 sql 操作 mybatis 简介 mybatis 是 一款 优秀 的 基于 orm 的 半自动化 轻量级 持久 层 框架 它 支持 定制 化 sql 存储 过程 和 高级 映射 mybatis 可以用 简单 的 xml 或者 注解 来 配置 和 映射 原生 类型 接口 和 实体类 二 基本 应用 demo 入门 应用 mybatis 官方 地址 mybatis 官方 地址 环境 搭建 新建 一个 maven 项目 引入 相关 maven 依赖 ltmybatis 依赖 驱动 依赖 本地 数据库 新建 user 用户 表 新建 user 实体类 intid stringname stringpassword 新建 usermapper 映射 配置文件 名称 空间 与 id 组成 sql 的 唯一 标识 resulttype 表明 返回值 类型 gtlt 查询 用户 新增 mybatis 核心 配置文件 运行 环境 当前 事务 交由 jdbc 进行 管理 当前 使用 mybatis 提供 的 连接池 引入 映射 配置文件 注意 驱动 class 注意 mysql 版本 的 区别 以上 是 测试 工具 类 配置文件 的 加载 把 配置文件 加载 成 字节 输 入流 sqlmapconfigxml 解析 了 配置文件 并 创 建了 工厂 build 生产 默认 开启 一个 事务 但是 该 事务 不会 自动 提交 在 进行 增 删改 操作 时 要 手动 提交 事务 sqlsession 调用 方法 查询 所有 selectlist 查询 单个 selectone 添加 insert 修改 update 删除 for useruserusers user sqlsessionclose 测试 结果 简单 的 crud 栗子 查询 前边 的 例子 已经 展示 过 查询 了 新增 映射 文件 usermapperxml 中 新增 插入 方法 idnamepassword ltinsertgt 编写 测试 方法 工具 类 配置文件 的 加载 把 配置文件 加载 成 字节 输 入流 sqlmapconfigxml 解析 了 配置文件 并 创 建了 工厂 build 生产 默认 开启 一个 事务 但是 该 事务 不会 自动 提交 sqlsession 调用 方法 查询 所有 selectlist 查询 单个 selectone 添加 insert 修改 update 删除 usersetid usersetname lisi usersetpassword insert 手动 提交 事务 sqlsessionclose 测试 结果 注 意在 映射 文件 中 插入 使用 的 是 insert 标 签在 映射 文件 中 要 使用 parametertype 属性 指定 插入 的 数据类型 在 映射 文件 的 具体 插入 sql 语 句中 实体类 的 属性 名称 的 方式 引用 入 参 使用 sqlsession 操作 时 新增 需要 注意 手动 提交 事务 修改 映射 文件 usermapperxml 中新 增 修改 方法 编写 测试 方法 工具 类 配置文件 的 加载 把 配置文件 加载 成 字节 输 入流 sqlmapconfigxml 解析 了 配置文件 并 创 建了 工厂 build 生产 默认 开启 一个 事务 但是 该 事务 不会 自动 提交 sqlsession 调用 方法 查询 所有 selectlist 查询 单个 selectone 添加 insert 修改 update 删除 usersetid usersetname lisi usersetpassword 手动 提交 事务 sqlsessionclose update 测试 结果 删除 映射 文件 usermapperxml 中新 增 删除 方法 编写 测试 方法 工具 类 配置文件 的 加载 把 配置文件 加载 成 字节 输 入流 sqlmapconfigxml 解析 了 配置文件 并 创 建了 工厂 build 生产 默认 开启 一个 事务 但是 该 事务 不会 自动 提交 sqlsession 调用 方法 查询 所有 selectlist 查询 单个 selectone 添加 insert 修改 update 删除 手动 提交 事务 sqlsessionclose delete 测试 结果 dao 层 实现 的 方式 传统 的 实现 方式 实现 类 调用 sqlsession 新建 userdao 接口 类 新建 userdaoimpl 接口 实现 类 工具 类 配置文件 的 加载 把 配置文件 加载 成 字节 输 入流 sqlmapconfigxml 解析 了 配置文件 并 创 建了 工厂 build 生产 默认 开启 一个 事务 但是 该 事务 不会 自动 提交 在 进行 增 删改 操作 时 要 手动 提交 事务 sqlsession 调用 方法 查询 所有 selectlist 查询 单个 selectone 添加 insert 修改 update 删除 sqlsessionclose returnusers 测试 userlist 测试 结果 代理 的 实现 方式 新建 usermapper 接口 类 修改 usermapperxml 文件 名称 空间 与 id 组成 sql 的 唯一 标识 resulttype 表明 返回值 类型 gtlt 查询 用户 idnamepassword 测试 工具 类 配置文件 的 加载 把 配置文件 加载 成 字节 输 入流 sqlmapconfigxml 解析 了 配置文件 并 创 建了 工厂 build 生产 默认 开启 一个 事务 但是 该 事务 不会 自动 提交 usermapperclass sqlsessionclose users 测试 结果 注意 mapperxml 映射 文件 里 的 namespace 必须 与 mappe 接口 的 全 限 定名 保持一致 mapper 接口 的 每个 方 法名 必须 和 mapperxml 映射 文件 里 的 每个 statement 的 id 属性 的 值 保持一致 mapper 接 口里 方法 的 入 参 必须 和 mapperxml 映射 文件 里 每个 sql 的 parametertype 类型 保持一致 mapper 接 口里 方法 的 返回值 必须 和 mapperxml 映射 文件 里 每个 sql 的 resulttype 类型 保持一致 配置文件 属性 说明 xml 配置文件 的 配置文件 包 含了 会 深深 影响 mybatis 行为 的 设置 和 属性 信息 配置 文档 的 顶层 结构 如下 configuration 配置 properties 属性 settings 设置 typealiases 类型 别名 typehandlers 类型 处理器 objectfactory 对象 工厂 plugins 插件 environments 环境 配置 environment 环境变量 事务 管理器 datasource 数据源 数据库 厂商 标识 mappers 映射器 properties 属性 如何 设置 属性 在 典型 的 java 属性 文件 中 配置 这些 属性 在 properties 元素 的 子 元素 中 设置 例子 运行 环境 当前 事务 交由 jdbc 进行 管理 当前 使用 mybatis 提供 的 连接池 说明 在 外部 配置文件 中 配置 的 属性 或者 在 properties 元素 的 子 元素 中 设置 的 属性 在 整个 配置文件 中 我们 可以 用来 替换 需要 动态 配置 的 属性 值 java 中 类 提供 了 对应 的 api 方法 可以 在 java 代码 中 配置 属性 mybatis 属性 加载 顺序 注意 如果 一个 属性 在 不只 一个 地方 进行了 配置 那么 mybatis 将 按照 下面 的 顺序 来 加载 首先 读取 在 properties 元素 体内 指定 的 属性 然后 根据 properties 元素 中 的 resource 属性 读取 类 路径 下 属性 文件 或 根据 url 属性 指定 的 路径 读取 属性 文件 并 覆盖 之前 读取 过 的 同名 属性 最后 读取 作为 方法 参数 传递 的 属性 并 覆盖 之前 读取 过 的 同名 属性 占位 符 指定 一个 默认值 从 mybatis 开始 你 可 以为 占位 符 指定 一个 默认值 例如 如果 属性 username 没有 被 配置 username 属性 的 值 将为 utuser 这个 特性 默认 是 关闭 的 要 启用 这个 特性 需要 添加 一个 特定 的 属性 来 开启 这个 特性 启用 默认值 特性 如果在 属性 名 中使 用了 字符 如 dbusername 或者 在 sql 映射 中使 用了 ognl 表达式 的 三元 运算符 如 就需要 设置 特定 的 属性 来 修改 分隔 属性 名 和 默认值 的 字符 修改 默认值 的 分隔符 设置 一个 配置 完整 的 settings 元素 的 示例 如下 具体 说明 参考 mybatis 官方 文档 typealiases 类型 别名 类型 别名 可为 java 类型 设置 一个 缩写 名字 它 仅 用于 xml 配置 意在 降低 冗余 的 全 限定 类 名 书写 举个 栗子 也 可以 指定 一个 包下 所有 的 bean 类 包下 所有 的 bean 类 如果 没有 注解 那么 默认 使用 首字母 小写 的 非 限定 类 名 来 作为 它 的 别名 有 注解 则 别 名为 其 注解 值 alias user 类型 处理器 mybatis 在 设置 预处理 语句 中 的 参数 或 从 结果 集中 取出 一个 值 时 都 会用 类型 处理器 将 获 取到 的 值 以 合适 的 方式 转换成 java 类 mybatis 中有 很多 默认 支持 的 类型 处理器 具体 参考 官方 文档 我们 可以 重写 已有 的 类型 处理器 或 创建 自己 的 类型 处理器 来 处理 不支持 的 或 非标准 的 类型 具体做法 为 实现 接口 或 继承 一个 很 便利 的 类 并且 可以 可选 地 将它 映 射到 一个 jdbc 类型 创建 自定义 的 类型 处理器 jdbctypevarchar iparameter columnname columnindex columnindex 在 的 配置文件 中 增加 配置 注 意在 类型 处理器 的 配置 元素 typehandler 元素 上 增加 一个 javatype 属性 比如 可以 得知 该 类型 处理器 处理 的 java 类型 在 类型 处理器 的 配置 元素 上 增加 一个 jdbctype 属性 比如 jdbctypevarchar 指定 与其 关联 的 jdbc 类型 列表 在 类型 处理器 的 类 上 增加 一个 mappedtypes 注解 指定 与其 关联 的 java 类型 列表 在 类型 处理器 的 类 上 增加 一个 mappedjdbctypes 注解 指定 与其 关联 的 jdbc 类型 列表 上述 的 两种 配置 方式 的 优先级 高于 我们 可以 通过 指定 包 名 的 方式 让 mybatis 帮 我们 查找 类型 处理器 ltmybatisconfig 注 意在 使用 自动 发现 功能 的 时候 只能 通过 注解 方式 来 指定 jdbc 的 类型 objectfactory 对象 工厂 每次 mybatis 创建 结果 对象 的 新 实例 时 它 都会 使用 一个 对象 工厂 objectfactory 实例 来 完成 实例 化 工作 默认 的 对象 工厂 需要 做的 仅仅是 实例 化 目标 类 要么 通过 默认 无 参 构造 方法 要么 通过 存在 的 参数 映 射来 调用 带有 参数 的 构造 方法 如果 想 覆盖 对象 工厂 的 默认 行为 可以 通过 创建 自己 的 对象 工厂 来 实现 classtype type properties classlttgttype type 在 mybatis 的 配置文件 中 增加 对应 配置 元素 体 中 定义 的 属性 会被 传 递给 setproperties 方法 plugins 插件 mybatis 允许 你 在 映射 语句 执行 过程中 的 某一 点 进行 拦截 调用 默认 情况下 mybatis 允许 使用 插件 来 拦截 的 方法 调用 包括 executor 通过 mybatis 提供 的 强大 机制 使用 插件 是 非常 简单 的 只需 实现 interceptor 接口 并 指定 想要 拦截 的 方法 签名 即可 intercepts signature objecttarget targetthis 在 mybatis 配置文件 中新 增 配置 环境 配置 示例 注意 一些 关键 点 默认 使用 的 环境 id 比如 每个 environment 元素 定义 的 环境 id 比如 iddevelopment 事务 管理器 的 配置 比如 typejdbc 数据源 的 配置 比如 typepooled 默认 环境 和 环境 id 顾名思义 环境 可以 随意 命名 但 务必 保证 默认 的 环境 id 要 匹配 其中 一个 环境 事务 管理器 在 mybatis 中有 两种 类型 的 事务 管理器 也 就是 这个 配置 直接 使 用了 jdbc 的 提交 和 回 滚 设施 它 依赖 从 数据源 获得 的 连 接来 管理 事务 作用 域 managed 这个 配置 几乎 没做 什么 它从 不 提交 或 回 滚 一个 连接 而是 让 容器 来 管理 事务 的 整个 生命周期 比如 jee 应用服务器 的 上下文 默认 情况下 它会 关闭 连接 然而 一些 容器 并不 希望 连接 被 关闭 因此 需 要将 closeconnection 属性 设置 为 false 来 阻止 默认 的 关闭 行为 例如 数据源 datasource 元素 使用 标准 的 jdbc 数据源 接口 来 配置 jdbc 连接 对象 的 资源 有 三种 内建 的 数据源 类型 也 就是 这个 数据源 的 实现 会 每次 请求 时 打开 和 关闭 连接 虽然 有点 慢 但对 那些 数据库 连接 可用 性要求 不高 的 简单 应用程序 来 说是 一个 很好 的 选择 性能 表现 则 依赖于 使用 的 数据库 对 某些 数据库 来说 使用 连接池 并不 重要 这个 配置 就很 适合 这种 情形 unpooled 类型 的 数据源 仅仅 需要 配置 以 下种 属性 driver 这是 jdbc 驱动 的 java 类 全 限 定名 并不是 jdbc 驱动 中 可能 包含 的 数据源 类 url 这是 数据库 的 jdbcurl 地址 username 登录 数据库 的 用户名 password 登录 数据库 的 密码 默认 的 连接 事务 隔离 级别 等待 数据库 操作 完成 的 默认 网络 超时 时间 单位 毫秒 作为 可选项 你 也 可以 传递 属性 给 数据库 驱动 只需 在 属性 名 加上 driver 前缀 即可 例如 这将 通过 方法 传递 值 为 utf 的 encoding 属性 给 数据库 驱动 pooled 这种 数据源 的 实现 利用 池 的 概念 将 jdbc 连接 对象 组织起来 避免了 创建 新 的 连接 实例 时 所 必需 的 初始化 和 认证 时间 这种 处理方式 很 流行 能使 并发 web 应用 快速 响应 请求 除了 上述 提到 unpooled 下 的 属性 外 还有 更多 属性 用来 配置 pooled 的 数据源 在 任意 时间 可 存在 的 活动 正在 使用 连接 数量 默认值 任意 时间 可能 存在 的 空闲 连接数 在被 强制 返回 之前 池中 连接 被 检出 checkedout 时间 默认值 毫秒 即 秒 pooltimetowait 这是 一个 底层 设置 如果 获取 连接 花 费了 相当 长 的 时间 连接池 会 打印 状态 日志 并 重新 尝试 获取 一个 连接 避免 在 误 配置 的 情况下 一直 失败 且不 打印 日志 默认值 毫秒 即 秒 这是 一个 关于 坏 连接 容忍度 的 底层 设置 作用于 每一个 尝试 从 缓存 池 获取 连接 的 线程 如果 这个 线程 获 取到 的 是 一个 坏 的 连接 那么 这个 数据源 允许 这个 线程 尝试 重新 获取 一个 新 的 连接 但是 这个 重新 尝试 的 次数 不应该 超过 与 之和 默认值 新增 于 poolpingquery 发送到 数据库 的 侦测 查询 用来 检验 连接 是否 正常 工作 并 准备 接受 请求 默认 是 nopingqueryset 这会 导致 多数 数据库 驱动 出错 时 返回 恰当 的 错误 消息 poolpingenabled 是否 启用 侦测 查询 若 开启 需要 设置 poolpingquery 属性 为 一个 可执行 的 sql 语句 最好 是 一个 速度 非常快 的 sql 语句 默认值 配置 poolpingquery 的 频率 可以 被 设置 为 和 数据库 连接 超时 时间 一样 来 避免 不必要 的 侦测 默认值 即 所有 连接 每 一 时刻 都被 侦测 当然 仅 当 poolpingenabled 为 true 时 时 适用 jndi 这个 数据源 实现 是为了 能在 如 ejb 或 应用服务器 这类 容器 中 使用 容器 可以 集中 或在 外部 配置 数据源 然后 放置 一个 jndi 上下文 的 数据源 引用 这种 数据源 配置 只需要 两个 属性 initialcontext 这个 属性 用来 在 initialcontext 中 寻找 上下文 即 initialcontext 这是 个 可选 属性 如果 忽略 那么 将会 直接 从 initialcontext 中 寻找 datasource 属性 datasource 这是 引用 数据源 实例 位置 的 上下文 路径 提供 了 initialcontext 配置 时会 在其 返回 的 上下 文中 进行 查找 没有 提供 时 则 直 接在 initialcontext 中 查找 和 其他 数据源 配置 类似 可以 通过 添加 前缀 env 直接 把 属性 传 递给 initialcontext 比如 envencodingutf 这就 会在 initialcontext 实例 化时 往 它 的 构造 方法 传递 值 为 utf 的 encoding 属性 数据库 厂商 标识 mybatis 可以 根据 不同 的 数据库 厂商 执行 不同 的 语句 这种 多 厂商 的 支持 是 基于 映射 语 句中 的 databaseid 属性 mybatis 会 加载 带有 匹配 当前 数据库 databaseid 属性 和 所有 不带 databaseid 属性 的 语句 如果 同时 找到 带有 databaseid 和 不带 databaseid 的 相同 语句 则 后者 会被 舍弃 为 支持 多 厂商 特性 只要 像 下面 这样 在 文件 中 加入 即可 对应 的 dbvendor 实现 会将 databaseid 设置 为 返回 的 字符串 由于 通常情况下 这些 字符串 都 非常 长 而且 相同 产品 的 不同 版 本会 返回 不同 的 值 你 可能 想 通过 设置 属性 别名 来 使其 变短 在 提供 了 属性 别名 时 的 dbvendor 实现 会将 databaseid 设置 为 数据库 产品名 与 属性 中 的 名称 第一个 相匹配 的 值 如果 没有 匹配 的 属性 将会 设置 为 null 在这 个 例子 中 如果 返回 oracle datadirect databaseid 将被 设置 为 oracle 我们 可以 通过 实现 接口 并在 中 注册 来 构建 自己 的 propertiesp 从 开始 该 方法 为 默认 方法 空 实现 映射器 告诉 mybatis 到哪里 去找 映射 文件 你 可以 使用 相对于 类 路径 的 资源 引用 或 完全 限定 资源 定位 符 包括 file 形式 的 url 或 类 名 和 包 名 等 例如 使用 相对于 类 路径 的 资源 引用 使用 完全 限定 资源 定位 符 使用 映射器 接口 实现 类 的 完全 限定 类 名 将 包 内 的 映射器 接口 实现 全部 注册 为 映射器 映射 文件 mapperxmlsql 映射 文件 只有 很少 的 几个 顶级 元素 按 照应 被 定义 的 顺序 列出 cache 该 命名 空间 的 缓存 配置 cacheref 引用 其它 命名 空间 的 缓存 配置 resultmap 描述 如何 从 数据库 结果 集中 加载 对 象是 最 复杂 也是 最 强大 的 元素 sql 可被 其它 语句 引用 的 可 重用 语句 块 insert 映射 插入 语句 update 映射 更新 语句 delete 映射 删除 语句 select 映射 查询 语句 select 标签 select 元素 的 属性 属性 描述 id 在 命名 空 间中 唯一 的 标识符 可以 被 用来 引用 这条 语句 parametertype 将会 传入 这条 语句 的 参数 的 类 全 限 定名 或 别名 这个 属性 是 可选 的 因为 mybatis 可以 通过 类型 处理器 typehandler 推断出 具体 传入 语句 的 参数 默认值 为 未 设置 unsetresulttype 期望 从 这条 语 句中 返回 结果 的 类 全 限 定名 或 别名 注意 如果 返回 的 是 集合 那 应该 设置 为 集合 包含 的 类型 而 不是 集合 本身 的 类型 resulttype 和 resultmap 之间 只能 同时 使用 一个 resultmap 对 外部 resultmap 的 命名 引用 flushcache 将其 设置 为 true 后 只要 语句 被 调用 都会 导致 本地 缓存 和 二级缓存 被 清空 默认值 falseusecache 将其 设置 为 true 后 将会 导致 本条 语句 的 结果 被 二级缓存 缓存 起来 默认值 对 select 元素 为 truetimeout 这个 设置 是 在 抛出 异常 之前 驱动程序 等待 数据库 返回 请求 结果 的 秒数 默认值 为 未 设置 unset 依赖 数据库 驱动 fetchsize 这是 一个 给 驱动 的 建议 值 尝试 让 驱动程序 每次 批量 返回 的 结果 行数 等于 这个 设置 值 默认值 为 未 设置 unset 依赖 驱动 statementtype 可选 或 callable 这会 让 mybatis 分别 使用 或 默认值 或 default 等价 于 unset 中 的 一个 默认值 为 unset 依赖 数据库 驱动 databaseid 如果 配置 了 数据库 厂商 标识 会 加载 所有 不带 databaseid 或 匹配 当前 databaseid 的 语句 如果 带 和 不带 的 语句 都有 则 不带 的 会被 忽略 resultordered 这个 设置 仅 针对 嵌套 结果 select 语句 如果 为 true 将会 假设 包 含了 嵌套 结果 集 或是 分组 当 返回 一个 主 结果 行时 就不会 产生 对 前面 结果 集 的 引用 这就 使得 在 获取 嵌套 结果 集 的 时候 不至于 内存 不够用 默认值 falseresultsets 这个 设置 仅 适用于 多 结果 集 的 情况 它将 列出 语句 执行 后 返回 的 结果 集 并 赋予 每个 结果 集 一个 名称 多个 名称 之间 以 逗号 分隔 insertupdate 和 delete 标签 数据 变更 语句 insertupdate 和 delete 的 实现 非常 接近 元素 的 属性 属性 描述 id 在 命名 空 间中 唯一 的 标识符 可以 被 用来 引用 这条 语句 parametertype 将会 传入 这条 语句 的 参数 的 类 全 限 定名 或 别名 这个 属性 是 可选 的 因为 mybatis 可以 通过 类型 处理器 typehandler 推断出 具体 传入 语句 的 参数 默认值 为 未 设置 unsetflushcache 将其 设置 为 true 后 只要 语句 被 调用 都会 导致 本地 缓存 和 二级缓存 被 清空 默认值 对 insertupdate 和 delete 语句 truetimeout 这个 设置 是 在 抛出 异常 之前 驱动程序 等待 数据库 返回 请求 结果 的 秒数 默认值 为 未 设置 unset 依赖 数据库 驱动 statementtype 可选 或 callable 这会 让 mybatis 分别 使用 或 默认值 仅 适用于 insert 和 update 这会 令 mybatis 使用 jdbc 的 方法来 取出 由 数据库 内部 生成 的 主键 比 如像 mysql 和 sqlserver 这样 的 关系 型 数据库 管理 系统 的 自动 递增 字段 默认值 仅 适用于 insert 和 update 指定 能够 唯一 识别 对象 的 属性 mybatis 会 使用 的 返回值 或 insert 语句 的 selectkey 子 元素 设置 它 的 值 默认值 未 设置 unset 如果 生成 列 不止 一个 可以用 逗号 分隔 多个 属性 名称 keycolumn 仅 适用于 insert 和 update 设置 生成 键值 在 表 中 的 列名 在 某些 数据库 像 postgresql 中 当 主键 列 不是 表 中 的 第一 列 的 时候 是 必须 设置 的 如果 生成 列 不止 一个 可以用 逗号 分隔 多个 属性 名称 databaseid 如果 配置 了 数据库 厂商 标识 会 加载 所有 不带 databaseid 或 匹配 当前 databa aseid 的 语句 如果 带 和 不带 的 语句 都有 则 不带 的 会被 忽略 注意 如果 你 的 数据库 支持 自动 生成 主键 的 字段 比如 mysql 和 sqlserver 那么 你 可以 设置 然后 再把 keyproperty 设置 为 目标 属性 就 ok 了 对于 不支持 自动 生成 主键 列 的 数据库 和 可能 不支持 自动 生成 主键 的 jdbc 驱动 mybatis 有 另外 一种 方法来 生成 主键 random asinteger values 元素 的 属性 属性 描述 语句 结果 应 该被 设置 到 的 目标 属性 如果 生成 列 不止 一个 可以用 逗号 分隔 多个 属性 名称 keycolumn 返回 结果 集中 生成 列 属性 的 列名 如果 生成 列 不止 一个 可以用 逗号 分隔 多个 属性 名称 resulttype 结果 的 类型 通常 mybatis 可以 推断 出来 但是 为了 更加 准确 写上 也 不会有 什么问题 mybatis 允许 将 任何 简单 类型 用作 主键 的 类型 包括 字符串 如果 生成 列 不止 一个 则可 以 使用 包含 期望 属性 的 object 或 maporder 可以 设置 为 before 或 after 如果 设置 为 before 那么 它 首先 会 生成 主键 设置 keyproperty 再 执行 插入 语句 如果 设置 为 after 那么 先 执行 插入 语句 然后 是 selectkey 中 的 语句 这 和 oracle 数据库 的 行为 相似 在 插入 语句 内部 可能有 嵌入 索引 调用 statementtype 和 前面 一样 mybatis 支持 和 callable 类型 的 映射 语句 分别 代表 和 类型 sql 标签 这个 元素 可以 用来 定义 可 重用 的 sql 代码 片段 以便 在 其它 语句 中 使用 也 可以 在 include 元素 的 refid 属性 或 内部 语句 中 使用 属性 值 例如 参数 字符串 替换 默认 情况下 使用 参数 语法 时 mybatis 会 创建 参数 占位 符 并 通过 占位 符 安全地 设置 参数 就像 使用 一样 这样 做 更 安全 更 迅速 通常 也是 首选 做法 不过 有时 你 就是 想 直 接在 sql 语句 中 直接插入 一个 不 转义 的 字符串 比如 orderby 子句 这时候 你 可以 提示 用 这种 方式 接受 用户 的 输入 并 用作 语句 参数 是 不安全 的 会 导致 潜在 的 sql 注入 攻击 结果 映 射在 没有 显 式 的 指定 resultmap 时 可以 使用 resulttype 属性 指 定将 所有 的 列 映 射到 hashmap 的 键 上当 resulttype 属性 指定 到 javabean 时 mybatis 会在 幕后 自动 创建 一个 resultmap 再 根据 属性 名 来 映射 列到 javabean 的 属性 上 如果 列名 和 属性 名 不能 匹 配上 可以 在 select 语 句中 设置 列 别名 这是 一个 基本 的 sql 特性 来 完成 匹配 我们 也 可以 显 式 使用 外部 的 resultmap 然后 在 引 用它 的 语 句中 设置 resultmap 属性 就行了 注意 高级 结果 映射 请 跳转 官方 文档 结果 映射 自动 映 射在 简单 的 场景 下 mybatis 可 以为 你 自动 映射 查询 结果 但 如果 遇到 复杂 的 场景 你 需要 构建 一个 结果 映射 我们 可以 混合 使用 这两种 策略 例如 例子 中 id 和 username 列 将被 自动 映射 hashedpassword 列 将 根据 配置 进行 映射 有 三种 自动 映射 等级 none 禁用 自动 映射 仅对 手动 映射 的 属性 进行 映射 partial 对 除 在内部 定义 了 嵌套 结果 映射 也 就是 连接 的 属性 以外 的 属性 进行 映射 full 自动 映射 所有 属性 默认值 是 partial 这是 有 原因 的当 对 连接 查询 的 结果 使用 full 时 连接 查询 会在 同一 行 中 获取 多个 不同 实体 的 数据 因此 可能 导致 非 预期 的 映射 无论 设置 的 自动 映射 等级 是 哪种 你 都可以 通过 在 结果 映 射上 设置 automapping 属性 来 为 指定 的 结果 映射 设置 启用 禁用 自动 映射 缓存 设置 缓存 默认 情况下 只 启 用了 本地 的 会话 缓存 它 仅 仅对 一个 会话 中 的 数据 进行 缓存 要 启用 全局 的 二级缓存 只需要 在你 的 sql 映射 文件 中 添加 一行 ltcachegt 这个 简单 语句 的 效果 如下 映射 语句 文件 中 的 所有 select 语句 的 结果 将 会被 缓存 映射 语句 文件 中 的 所有 insertupdate 和 delete 语句 会 刷新 缓存 缓存 会 使用 最近 最少 使用 算法 算法 来 清除 不需要 的 缓存 缓存 不会 定时 进行 刷新 也就是说 没有 刷新 间隔 缓存 会 保存 列表 或 对象 无论 查询方法 返回 哪种 的 个 引用 缓存 会被 视为 读写 缓存 这 意味着 获 取到 的 对象 并不是 共享 的 可以 安全地 被 调用者 修改 而 不 干扰 其他 调用者 或 线程 所做 的 潜在 修改 提示 缓存 只作 用于 cache 标签 所在 的 映射 文件 中 的 语句 如果 你 混合 使用 javaapi 和 xml 映射 文件 在 共用 接 口中 的 语句 将不 会被 默认 缓存 你 需要 使用 注解 指定 缓存 作用 域 这个 更 高级 的 配置 创 建了 一个 fifo 缓存 每隔 秒 刷新 最多 可以 存储 结果 对象 或 列表 的 个 引用 而且 返回 的 对象 被 认为是 只读 的 因此 对 它们 进行 修改 可能 会在 不同 线程 中 的 调用者 产生 冲突 可用 的 清除 策略 有 默认 的 清除 策略 是 lrulru 最近 最少 使用 移除 最长 时间 不被 使用 的 对象 fifo 先进先出 按 对象 进入 缓存 的 顺序 来 移除 它们 soft 软 引用 基于 垃圾 回收 器 状态 和 软 引用 规则 移除 对象 weak 弱 引用 更 积极地 基于 垃圾 收集器 状态 和 弱 引用 规则 移除 对象 flushinterval 刷新 间隔 属性 可以 被 设置 为 任意 的 正整数 设置 的 值 应该是 一个 以 毫秒 为 单位 的 合理 时 间量 默认 情况 是 不 设置 也 就是 没有 刷新 间隔 缓存 仅仅 会在 调用 语句 时 刷新 size 引用 数目 属性 可以 被 设置 为 任意 正整数 要注意 欲 缓存 对象 的 大小 和 运行 环境 中 可用 的 内存 资源 默认值 是 readonly 只读 属性 可以 被 设置 为 true 或 false 只读 的 缓存 会给 所有 调用者 返回 缓存 对象 的 相同 实例 因此 这些 对象 不能 被 修改 这就 提供 了 可观 的 性能 提升 而 可 读写 的 缓存 会 通过 序列化 返回 缓存 对象 的 拷贝 速度 上会 慢 一些 但是 更 安全 因此 默认值 是 false 使用 自定义 缓存 属性 指定 的 类 必须 实现 接口 且 提供 一个 接受 string 参数 作为 id 的 构造 器 为了 对 自定义 的 缓存 进行 配置 只需要 简单 地 自定义 的 缓存 实现 中 添加 公有 的 javabean 属性 然后 通过 cache 元素 传递 属性 值 例如 上边 的 例子 将在 自定义 的 缓存 实现 上 调用 一个 名为 setcachefile stringfile 的 方法 也 可以 使用 占位 符 如 cachefile 以便 替换成 在 配置文件 属性 中 定义 的 值 提示 上 一节 中 对 缓存 的 配置 如 清除 策略 可读 或可 读写 等 不能 应用于 自定义 缓存 缓存 的 配置 和 缓存 实例 会被 绑定 到 sql 映射 文件 的 命名 空 间中 因此 同一 命名 空 间中 的 所有 语句 和 缓存 将 通过 命名 空间 绑定 在一起 每条 语句 可以 自定义 与 缓存 交互 的 方式 或 将 它们 完全 排除 于 缓存 之外 这 可以 通过 在 每条 语句 上 使用 两个 简单 属性 来 达成 默认 情况下 语句 会 这样 来 配置 对 某一 命名 空间 的 语句 只会 使用 该 命名 空间 的 缓存 进行 缓存 或 刷新 但 你 可能 会想 要在 多个 命名 空间 中 共享 相同 的 缓存 配置 和 实例 要 实现 这种 需求 你 可以 使用 cacheref 元 素来 引用 另一个 缓存 动态 sql 动态 sql 是 mybatis 的 强大 特性 之一 如果 你 使 用过 jdbc 或 其它 类似 的 框架 你 应该能 理解 根据 不同 条件 拼接 sql 语句 有 多 痛苦 例如 拼接 时 要 确保 不能 忘记 添加 必要 的 空格 还要 注意 去掉 列表 最后 一个 列名 的 逗号 利用 动态 sql 可以 彻底 摆脱 这种 痛苦 if 标签 在 where 后 的 条件 语 句中 根据 多个 参数 动态 判断 时 使用 多个 if 标签 完成 标签 有时候 我们 不想 使用 所有 的 条件 而 只是 想从 多个 条件 中 选择 一个 使用 针对 这种 情况 mybatis 提供 了 choose 元素 它 有点像 java 中 的 switch 语句 在上 面的 例子 中 传 入了 title 就按 title 查找 传 入了 author 就按 author 查找 的 情形 若 两者 都没有 传入 就 使用 featured 的 条件 trimwhereset 标签 where 元素 只 会在 子 元素 返回 任何 内容 的 情况下 才 插入 where 子句 而且 若 子句 的 开头 为 and 或 orwhere 元素 也 会将 它们 去除 如果 where 元素 与 你 期望 的 不太 一样 你 也 可以 通过 自定义 trim 元 素来 定制 where 元素 的 功能 比如 和 where 元素 等价 的 自定义 trim 元素 为 用于 动态 更新 语句 的 类似 解决方案 叫做 setset 元素 可以 用于 动态 包含 需要 更新 的 列 忽略 其 它不 更新 的 列 比如 下边 两种 等价 的 语句 标签 动态 sql 的 另一个 常见 使用 场景 是 对 集合 进行 遍历 尤其是 在 构建 in 条件 语句 的 时候 比如 separatorclose 元素 的 功能 非常 强大 它 允许 你 指定 一个 集合 声明 可以 在 元素 体内 使用 的 集合 项 item 和 索引 index 变量 它也 允许 你 指定 开头 与 结尾 的 字符串 以及 集合 项 迭代 之间 的 分隔符 提示 你 可以 将 任何 可 迭代 对象 如 listset 等 map 对象 或者 数组 对象 作为 集合 参数 传 递给 foreach 当 使用 可 迭代 对象 或者 数组 时 index 是 当前 迭代 的 序号 item 的 值 是 本次 迭代 获 取到 的 元素 当 使用 map 对象 或者 mapentry 对象 的 集 合时 index 是 键 item 是 值 bind 标签 bind 元素 允许 你 在 ognl 表达式 以外 创建 一个 变量 并 将其 绑定 到 当前 的 上下文 比如 多 数据库 支持 如果 配置 了 你 就可以 在 动态 代码 中 使用 名为 databaseid 的 变量 来 为 不同 的 数据库 构建 特定 的 语句 比如 下面 的 例子 idname ltinsertgt 动态 sql 中 的 插入 脚本语言 mybatis 从 版本 开始 支持 插入 脚本语言 这 允许 你 插入 一种 语言 驱动 并 基于 这种 语言 来 编写 动态 sql 查询 语句 可以 通过 实现 以下 接口 来 插入 一种 语言 实现 自定义 语言 驱动 后 你 就可以 在 文件 中 将它 设置 为 默认 语言 或者 也 可以 使用 lang 属性 为 特定 的 语句 指定 语言 或者 在 mapper 接 口上 添加 lang 注解 select selectfromblog 提示 前面 看到 的 所有 xml 标签 都由 默认 mybatis 语言 提供 而 它 由 语言 驱动 别 名为 xml 所 提供 三 彩蛋 本篇 笔者 描述 了 一下 mybatis 的 demo 入门 应用 配置文件 属性 说明 及 动态 sql 下一 篇 笔者 将 讲解 传统 xml 配置 开发 注解 开发 mybatis 缓存 mybatis 插件 