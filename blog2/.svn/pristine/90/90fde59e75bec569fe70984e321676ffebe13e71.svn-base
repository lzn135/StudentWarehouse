aaai 2021 在手 机上 实现 19fps 实时 的 yolobile 目标 检测 作者 机器 之心 编辑部 来源 机器 之心 本文 提 出了 一套 模型 压缩 和 编译 结合 的 目标 检测 加速 框架 根据 编译器 的 硬件 特性 而 设计 的 剪枝 策略 能够 在 维持 高 map 的 同时 大大提高 运行 速度 压缩 了 倍 的 yolov 能够 在手 机上 达到 fps 的 运行 速度 并且 依旧 维持 mapcocodataset 的 高 准确率 相比 yolov 完整版 该 框架 快出 倍 并且 没有 牺牲 准确率 该 框架 由 美国 东北大学 王 言 治 研究 组 和 威廉 玛丽 学院 任 彬 研究 组 共同 提出 随着 近年来 cnn 在 目标 检测 领域 的 发展 和 创新 目标 检测 有 了 更加 广泛 的 应用 考虑到 在 实际 场景 中 的 落地 需求 目标 检测 网络 往往 需 要在 保持 高 准确率 的 同时 拥有 较低 的 计算 延迟 而 现有 的 目标 检测 网络 在 资源 有限 的 平 台上 尤其是 手机 和 嵌入式 设备 上 部署 这类 应 用时 很难 同时 实现 高 准确率 与 实时 检测 在 过去 的 几年 中有 很多 优秀 的 目标 检测 网络 被 相继 提出 其中 的 twostage 检测 网络 包括 rcnn 系列 和 sppnet 等 还有 onestage 检测 网络 如 yolo 系列 ssd 和 retinanet 等 相较 于 twostage 网络 onestage 网络 在 牺牲 一定 准确率 的 情况下 换 来了 更快 的 执行 速度 即便如此 这些 网络 依然 需要 较大 的 计算 量 来 达到 可接受 的 准确率 这 成 为了 这些 网络 难以 在 移动 设备 上 实现 实时 推理 的 主要 阻碍 为此 一些 轻量级 lightweight 目标 检测 网络 模型 被 提出 如 等 以 实现 移动 设备 上 的 快速 目标 检测 但是 这些 轻量级 网络 的 解决方案 效果 依然 不理 想 为了 更好 地 满足 目标 检测 框架 的 落地 需求 cocopie 团队 美国 东北大学 王 言 治 研究 组 和 威廉 玛丽 学院 任 彬 研究 组 共同 提出 了 名为 yolobile 的 手机 端 目标 检测 加速 框架 yolobile 框架 通过 压缩 编译 协同 设计 在 手机 端 实现 了 高 准确率 实时 目标 检测 该 框架 使用 一种 新 提出 的 名为 blockpunched 的 权重 剪枝 方案 对 模型 进行 有效 的 压缩 在 编译器 优化 技术 的 协助 下在 手机 端 实现 高 准确率 的 实时 目标 检测 该 研究 还提 出了 一种 高效 的 手机 gpu 手机 cpu 协同 计算 优化 方案 进一步 提高了 计算 资源 的 利用率 和 执行 速度 相比 yolov 的 原版 加速 后 的 yolobile 的 运行 速度 提高了 倍 并且 维持 了 map 的 准确率 相比 yolov 完整版 该 框架 快 倍 在手 机上 实现 了 fps 的 实时 高 准确率 目标 检测 同时 准确率 高于 yolov 并没 有用 牺牲 准确率 来 提高 计算速度 论文 标题 论文 链接 代码 链接 链接 研究 方法 替换 硬件 支持 性 不好 的 操作符 在 原版 的 yolov 中有 一些 操作符 不能够 最大化 地 利用 硬件 设备 的 执行 效率 比如 带有 指数 运算 的 激活 函数 可能会 造成 运行 的 延迟 增加 成为 降低 延时 提高 效率 的 瓶颈 该 研究 把 这些 操作符 相应 地 替换 成对 硬件 更加 友好 的 版本 还有 一些 操作符 是 onnx 还未 支持 的 yolobile 用 onnx 作为 模型 的 存储 方式 研究者 把 它 替换成 onnx 支持 的 运算符 比 如在 yolov 引入 的 新 模块 中 用了 sigmoid 作为 分支 的 激活 函数 该 研究 在 尝试 把 它 换成 hardsigmoid 后 发现 准确率 和 直接 删除 相比 几乎 一致 增加 的 模块 又会 增加 计算 量 所以 研究者 将其 删 除了 mish 激活 函数 也 涉及 了 指数 运算 同时 在 pytorch 上 的 支持 不太 友好 会在 训练 时 占用 很多 缓存 同时 它在 pytorch 上 也 不能够 像 c 版本 的 yolov 一样 带来 很大 的 准确率 提升 而且 onnx 尚未 支持 研究者 将其 换 成了 yolov 的 权重 剪枝 方案 在 yolobile 优化 框架 中 作者 使 用了 新 提出 的 名为 blockpunched 的 权重 剪枝 weightpruning 方案 这种 剪枝 方案 旨 在在 获得 较高 剪枝 结构 自由度 的 同时 还 能使 剪枝 后 的 模型 结构 较好 地 利用 硬件 并行计算 这样 就从 两方面 分别 保证 了 剪枝 后 模型 的 准确率 和 较高 的 运算 速度 在 这种 剪枝 方案 中 每层 的 权重 矩阵 将被 划 分为 大小 相等 的 多个 块 block 因此 每个 块 中将 包含 来自 m 个 filter 的 n 个 channel 的 权 重在 每个 块 中被 剪枝 的 位置 需要 做出 如下 限定 需要 修剪 所有 filter 相同 位置 的 一个 或 多个 权重 同时 也 修剪 所有 通道 相同 位置 的 一个 或 多个 权重 从 另一个 角度 来看 这种 剪枝 方案 将 权重 的 剪枝 位置 贯穿 了 整个 块 中所 有的 卷积 核 kernel 对于 不同 的 block 剪枝 的 位置 和 剪掉 的 weight 数量 都是 灵活 可变 的 另外 这种 剪枝 策略 可以 应用在 卷积 核 大小 xxx 等 的 卷积 层 上 也 适用于 fc 层 通过 划 分为 固定 大小 的 块 来 进行 剪枝 能够 提高 编译器 的 并行 度 进而 提高 在手 机上 运行 的 速率 在 准确率 方面 通过 划分 多个 小 区块 这种 剪枝 方法 实现 了 更加 细粒度 的 剪枝 相较 于 传统 的 结构化 剪枝 剪除 整个 filter 或 channel 这种 方式 具有 更高 的 剪枝 结构 自由度 从而 更好 地 保持 了 模型 的 准确率 在 硬件 表现 方面 因为 在 同一 小 区块 中所 有 filter 修剪 被 修剪 的 位置 相同 所以在 并行计算 时 所有 filter 将 统一 跳过 读取 相同 的 输入 数据 从而 减轻 处理 这些 filter 的 线程 之间 的 内存 压力 而 限制 修剪 小 区块 内 各 channel 的 相同 位置 确保 了 所有 channel 共享 相同 的 计算 模式 从而 消除 处理 每个 channel 的 线程 之间 的 计算 差异 因此 这种 剪枝 方案 可以 大幅度 降低 在 计算 过程中 处理 稀疏 结构 的 额外 开销 从而 达到 更好 的 加速 效果 reweighted 算法 作者 采 用了 算法 来 筛 选出 剪枝 掉 的 weight 的 位置 reweight 算法 依据 weight 的 绝对值 大小 筛 选出 相对 重要 的 位置 整个 剪枝 的 过程 从 依据 预先 训 练好 的 网络 模型 开始 然后 将 reweighted 算法 融 合在 训练 的 过程中 在 训练 每到 个 epochs 后 就 能够 得到 一组 可选 的 剪枝 位置 通过 重复 训练 来 调整 剪枝 位置 最终 得到 精确 的 剪枝 模型 结果 编译器 的 优化 为了 支持 blockpunched 剪枝 方案 编译器 也 需要 作出 相应 的 调整 和 优化 为了 更好 地 存储 和 调用 经过 blockpunched 剪枝 后 的 weightindex 研究者 引 入了 新 的 存储 方案 将 index 的 存储空间 进一步 压缩 同时 通过 对 所有 的 块 进行 重新 排序 编译器 能够 在 更少 的 内存 访问 次数 下 运行 进而 获得 更快 的 运算 速度 手机 gpu 和 手机 cpu 协同 计算 的 优化 方案 yolobile 中 还 使 用了 手机 gpu 和 手机 cpu 协同 计算 的 方式 来 进一步 降低 整个 网络 的 运算 时间 现在 主流 的 移动 端 dnn 推理 加速 框架 如 和 tvm 都 只能 支持 手机 cpu 或 gpu 单独 运算 因此会 导致 潜在 的 计算 资源 浪费 yolobile 提出 针对 网络 中 的 分支 结构 比如 yolov 中 大量 使用 的 csp 结构 使用 cpu 来 辅助 gpu 同时 进行 一些 相 互无 依赖 关系 的 分支 运算 从而 更好 地利 用 计算 资源 减少 网络 的 运算 时间 yolobile 框架 将 待 优化 的 网络 分支 分为 有 卷积 运算 分支 和 无 卷积 运算 分支 并 对 这两种 情况 分别 给 出了 优化 方案 如 下图 所示 csp 是 一个 跨越 很多 残 差 block 的 长 分支 在 手机 的 执行 过程中 单一 的 gpu 计算 往往是 顺序 地 执行 完 上面 堆叠 残 差 block 的 分支 后 再 执行 下面 的 csp 分支 然后 拼接 在一起 作为 下一层 的 输入 研究者 将 卷积 层数 更少 的 branch 挪 到 cpu 上去 cpu 执行时间 少于 上面 branch 在 gpu 上 的 总 运算 时间 这个 并行 操作 能够 有效 减少 运算 延迟 当然 决定 能否 将 branch 转移到 cpu 的 因素 在于 branch 的 卷积 层数 多少 通常 cspblock 会 跨越 个 残 差 block 也有 的 时候 出现 只 跨越 个 残 差 block 的 情况 还有 在前 几层 只 跨 一个 残 差 block 的 情况 对于 只 跨 个 残 差 block 的 情况 明显 还是 gpu 顺序 执行 更 高效 对于 跨越 多个 的 就 需要用 实际 测出 的 延 迟来 做 判断 值得注意 的 是 转移 数据 到 不同 处理 设备 的 时候 需要 加入 数据传输 拷贝 的 时间 在 yolov 最后 输出 的 位置 个 yolohead 输出 部分 有 很多 诸如 转 置 变形 之类 的 非 卷积 运算 这些 非 卷积 运 算在 cpu 和 gpu 上 的 运行 效率 相当 作者 同样 基于 运行 时间 考虑 将 部分 运算符 转移到 cpu 上 去做 选择 最 高效 的 执行 方式 实验 结果 整个 训练 过程 采用 块 rtxti 训练 时间 为 天 使用 配备 高 通 骁 龙 cpu 和 adrenogpu 的 三星 galaxys 作为 测试 平台 训练 的 数据 集 是 mscoco 和 yolov 原版 保持一致 实验 结果表明 当 使用 yolov 为 基础 模型 进行 优 化时 该 研究 的 优化 框架 可以 成功 将 原 模型 大小 压缩 至 在 未 使用 gpucpu 协同 计算 优 化时 将 每秒 检测 帧数 fps 提 升至 且 达到 map 的 准确率 从下 图中 可以 看到 与 众多 具有 代表性 的 目标 检测 网络 相比 该 研究 的 优化 模型 在 准确率 与 速度 两方面 同时 具有 优异 的 表现 而 不再是 简单 的 牺牲 大幅 准确率 来 获取 一定 程度 的 速度 提升 下表 展示 了 yolobile 与其 他 具有 代表性 的 目标 检测 网络 在 准确率 与 速度 方面 的 具体 比较 值得注意 的 是 作者 的 gpucpu 协同 计算 优化 方案 可以 进一步 将 执行 速度 提高 至 fps 相比 于 其他 onestage 目标 检测 模型 和 lightweight 模型 经过 剪枝 后 的 yolobile 更快 且 更 精确 在 准确率 和 速 度上 实现 了 帕 累 托 最优 消融 实验 不同 剪枝 策略 比较 表格 中 列 出了 在 相同 压缩 倍率 的 情况下 和文 中 提出 的 这三种 剪枝 策略 的 准确率 和 运行 效率 的 比较 可以 看到 在 压缩 倍 的 状态下 能够 维持 较高 的 准确率 但是 和 前文 描述 的 一样 它 的 运行 效率 较低 即使 在 压缩 倍 的 情况下 运行 时间 只 提高了 不到 倍 后 模型 能够 高效率 地 在 硬件 设备 上 执行 但是 准确率 相比 有 大幅度 的 下降 而 根据 编译器 设计 的 blockpunched 剪枝 策略 能够 维持 较高 的 准确率 并且 达到 和 相当 的 执行 效率 和 patt 的 比较 只能 用在 x 的 层 为了 达到 较高 的 压缩 倍率 就需要 对 x 的 卷积 层 压缩 掉 更多 的 weight 下图 是 一个 关于 不同 倍率 下 和 的 比较 可以 看出 在 较低 倍率 压缩 的 情况下 能够 拥有 较高 的 准确率 和 执行 效率 但是 受限制 于 只 适用于 x 卷积 层 即使 将 所有 的 x 层 全部 压缩 也 只能 达到 倍 多 的 压缩率 但是 准确率 就 非常 低了 由于 可以 将 所有 的 层 都 进行 压 缩在 高倍率 的 情况下 依然 能够 维持 较高 的 准确率 blockpunched 剪枝 中 分块 大小 的 比较 该 研究 对 四种 不同 的 块 大小 进行 实验 为了 实现 较高 的 硬件 并行 度 每个 模块 中 的 channel 数 固 定为 这与 gpu 和 cpu 矢量 寄存器 的 长度 相 同在 每个 块 中使 用 不同 数量 的 filter 来 评估 准确性 和 速度 如图所示 与 较小 的 块 相比 较大 的 块 可以 更好 地 利用 硬件 并行性 并可以 实现 更高 的 推理 速度 但是 其 粗略 的 修剪 粒度 导致 准确性 下降 较小 的 块 可以获得 较高 的 精度 但会 牺牲 推理 速度 根据 结果 研究者 将 个 连续 filter 的 个 连续 channel 视为 移动 设备 上 的 所需 块 大小 这在 精度 和 速度 之间 取得了 良好 的 平衡 各层 的 剪枝 比例 yolov 在 卷积 层 中 仅 包含 和 的 kernel 该 研究 提出 这两种 类型 的 卷积 层 在 修剪 过程中 具有 不同 的 敏感度 并进 行了 两组 实验 在 相同 数量 的 flops 下 将 一组 中 的 所有 层 平均 修剪 另一组 中 卷积 层 的 压缩率 比 卷积 层 高倍 如 上表 所示 均匀 修剪 的 模型 和 不均匀 修剪 的 模型 相比 准确性 和 速度 都 较低 现 在在 知 乎 也 能 找到 我们 了 进入 知 乎 首页 搜索 paperweekly 点击 关注 订阅 我们 的 专栏 吧 关于 是 一个 推荐 解读 讨论 报道 人工智能 前沿 论文 成果 的 学术 平台 如果 你 研究 或 从事 ai 领域 欢迎 在 公众 号 后台 点击 交流 群小 助手 将把 你 带入 paperweekly 的 交流 群 里 