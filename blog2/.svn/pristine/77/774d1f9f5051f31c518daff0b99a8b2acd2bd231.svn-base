上来 就问 mysql 事务 瑟瑟发抖 mysql 事务 系列 文章 一 什么 是 事务 二 事务 四大 特征 原子 性 一致性 隔离 性 持久性 三 事务 并发 会 出现 的 问题 脏 读 不可重复读 幻 读 区别 四 事务 日志 以及 事务 异常 如何 应对 重做 日志 redolog 持久性 实现 原理 服务器 异常 停止 对 事务 如何 应对 事务 写入 过程 回 滚 日志 undolog 原子 性 实现 原理 五 锁 机制 行 锁 表 锁 如何 加锁 六 总结 关于 学习 这件 事情 宁可 花点 时间 系统 学习 也 不要 东 一 榔头 西 一 棒槌 都说 学习 最好 的 方式 就是 系统 的 学习 希望 看完 本文 会 让 你 对 事务 有 一定 的 理解 数据库 版本 为 系列 文章 揭开 mysql 索引 神秘 面纱 mysql 查询 优化 必备 上来 就问 mysql 事务 瑟瑟发抖 一 什么 是 事务 事务 是 独立 的 工作 单元 在 这个 独立 工作 单元 中所 有 操作 要么 全部 成功 要么 全部 失败 也就是说 如果有 任何 一条 语句 因为 崩溃 或者 其它 原因 导致 执行 失败 那么 未 执行 的 语句 都不会 再 执行 已经 执行 的 语句 会 进行 回 滚 操作 这个 过程 被 称之为 事务 例 最 近在 写 一个 论坛 系统 当 发布 的 主题 被 其它 用户 举报 后 后台 会对 举报 内容 进行 审核 一经 审核 为 违规 主题 则 进行 删除 主题 的 操作 但不 仅仅 要 删除 主题 还要 删除 主 题下 的 帖子 浏览量 关于 这个 主题 的 一切 信息 都 需要 进行 清理 删除 流程 如下 用 上边 概念 来说 以下 执行 的 四个 流程 每个 流程 都必须 成功 否则 事务 回 滚 返回 删除 失败 假设 执行 到了 第三步 后 sql 执行 失败 了 那么 第一 二步 都会 进行 回 滚 第四步 则不 会在 执行 二 事务 四大 特征 事务 的 四大 特征 原子 性 一致性 隔离 性 持久性 原子 性 事务 中所 有 操作 要么 全部 成功 要么 全部 失败 不会 存在 一部分 成功 一部分 失败 这个 概念 也是 事务 最 核心 的 特性 事务 概念 本身 就是 使用 原子 性 进行 定义 的 原子 性 的 实 现是 基于 回 滚 日志 实现 undolog 当 事务 需 要回 滚 时 就会 调 用回 滚 日志 进行 sql 语句 回 滚 操作 实现 数据 还原 一致性 一致性 字面 意思 就是 前后一致 呗 在 数据库 中 不管 进行 任何 操作 都是 从一 个 一致性 转移到 另一个 一致性 当 事务 结束 后 数据库 的 完整性 约束 不被 破坏 当你 了解 完 事务 的 四大 特征 之后 就会 发现 都是 保证 数据一致性 为 最终目标 存在 的 在 学习 事务 的 过程中 大家 看到 最多 的 案例 就是 转账 假设 用户 a 与 用户 b 余额 共计 那么 不管怎么 转 俩人 的 余额 自始至终 也就 只有 隔离 性 保证 事务 执行 尽可能 的 不受 其它 事务 影响 这个 是 隔离 级别 可以 自行 设置 在 innodb 中 默认 的 隔离 级 别为 可 重 复读 repeatableread 这种 隔离 级别 有 可能 造成 的 问题 就是 出现 幻 读 但是 使用 间隙 锁 可以 解决 幻 读 问题 学习 了 隔离 性 你 需要 知道 原子 性 和 持久性 是 针对 单个 事务 而 隔离 性 是 针对 事务 与 事务 之间 的 关系 持久性 持久性 是 指 当 事务 提交 之后 数据 的 状态 就是 永久 的 不会 因为 系统 崩溃 而 丢失 事务 持久性 是 基于 重做 日志 redolog 实现 的 三 事务 并发 会 出现 的 问题 脏 读读 取了 另一个 事务 没有 提交 的 数据 事务 a 事务 b 执行 事务 执行 事务 主题 访问量 从 修 改到 查询 主题 访问量 为 提交 事务 以 上表 为 例 事务 a 读取 主题 访问量 时 读取 到了 事务 b 没有 提交 的 数据 如果 事务 b 失败 进行 回 滚 那么 修改后 的 值 还是 会 回到 然而 事务 a 获取 的 数据 是 修改后 的 数据 这就 有 问 题了 不可重复读 事务 读取 同一个 数据 返回 结果 先后 不一致 问题 事务 a 事务 b 执行 事务 执行 事务 查询 主题 访问量 为 修改 主题 访问量 为 提交 事务 查询 主题 访问量 为 上 表格 中 事务 a 在 先后 获取 主题 访问量 时 返回 的 数据 不一致 也就是说 在 事务 a 执行 的 过程中 访问量 被 其它 事务 修改 那么 事务 a 查询 到 的 结果 就是 不可靠 的 脏 读 与 不可重复读 的 区别 脏 读 读取 的 是 另一个 事务 没有 提交 的 数据 而 不可重复读 读取 的 是 另一个 事务 已经 提交 的 数据 幻 读 事务 按照 范围 查询 俩 次 返回 结果 不同 事务 a 事务 b 开始 事务 开始 事务 查询 访问量 的 主题 个数 为此 时有 一篇 新 的 文章 访问量 达 到了 提交 事务 再次 查询 访问量 的 主题 个数 为 以 上表 为 例 当 对 访问量 的 主题 做 统 计时 第一次 找 到了 个 第二次 找 到了 个 区别 脏 读 读取 的 是 另一个 事务 没有 提交 的 数据 而 不可重复读 读取 的 是 另一个 事务 已经 提交 的 数据 幻 读 和 不可重复读 都是 读 取了 另一 条 已经 提交 的 事务 这点 与 脏 读 不同 所 不同 的 是 不可重复读 查询 的 都是 同一个 数据项 而 幻 读 针对 的 是 一批 数据 整体 比如 数据 的 个数 针对 以上 的 三个 问题 产 生了 四种 隔离 级 别在 第二节 中 对 隔离 性 进行了 简单 的 概念 解释 实际上 的 隔离 性 是 很 复杂 的 在 mysql 中 定义 了 四种 隔离 级别 分别为 未 提交 读 readuncommitted 提交 读 readcommitted 可 重复 读取 repeatableread 可 串行化 serializable 未 提交 读 readuncommitted 俩 个 事务 同时 运行 有 一个 事务 修 改了 数据 但未 提交 另一个 事务 是 可以 读 取到 没有 提交 的 数据 这种 情况 被 称之为 脏 读 提交 读 readcommitted 一个 事务 在 未 提交 之前 所做 的 任何 操作 其它 事务 不可 见 这种 隔离 级别 也 被 称之为 不可重复读 因为 会 存在 俩 次 同样 的 查询 返回 的 数据 可能会 得到 不一样 的 结果 可 重 复读 repeatableread 这种 隔离 级别 解决 了 脏 读 问题 但是 还是 存在 幻 读 问题 这种 隔离 界 别在 mysql 的 innodb 引擎 中 是 默认 级别 mysql 在 解决 幻 读 问题 使用 间隙 锁 来 解决 幻 读 问题 可 串行化 serializable 这种 级 别是 最高 的 强制 事务 进行 串行 执行 解决 了 可 重 复读 的 幻 读 问题 隔离 级别 脏 读 不可 重 读读 幻 读 未 提交 读 readuncommitted 可能发生 可能发生 可能发生 提交 读 readcommitted 不可能 发生 可能发生 可能发生 可 重 复读 repeatableread 不可能 发生 不可能 发生 可能发生 可 串行化 serializable 不可能 发生 不可能 发生 不可能 发生 对于 隔离 级别 级别 越高 并发 就越 低 而 级别 越 低 会 引发 脏 读 不可重复读 幻 读 的 问题 因此在 mysql 中 使用 可 重 复读 repeatableread 作为 默认 级别 作为 默认 级 别是 如何 解决 并 处理 相应 问题 的 呢 那么 针对 这一 问题是 一个 难 啃 的 骨头 咔 咔 将在 下一 期 mvcc 文章 专门 来 介绍 这块 四 事务 日志 以及 事务 异常 如何 应对 mysql 的 版本 号为 在 innodb 中 事务 的 日志 分为 俩 种 回 滚 日志 重做 日志 先来 看一下 俩 个 日志 的 存放 位置 吧 在 linux 下 的 mysql 事务 日志 存放在 varlibmysql 这个 位置 中 从上 图中 可以 看到 分别为 iblogfileundo 俩 个 文件 iblogfile 文件 为 重做 日志 undo 文件 为 回 滚 日志 在这里 估计 有点 小伙伴 会 有点 迷糊 这个 回 滚 日志 那是 因为 在 mysql 默认 回 滚 日志 没有 进行 独立 表 空间 存储 而是 存放 到了 ibdata 文件 中 独立 表 空间 存储 从 mysql 后 就 已经 支持 了 但是 需要 自行 配置 在 mysql 是 由 这个 参 数来 设置 回 滚 日志 独立 空间 个数 这个 参数 的 范围 为 默认值 为 表示 不 开启 独立 的 回 滚 日志 且 回 滚 日志 存储 在 ibdata 文件 中 这个 参数 是 在 初始化 数据库 时 指定 的 实例 一旦 创建 这个 参数 是 不能 改动 的 如果 设置 的 值 大于 实例 创建 时 的 个数 则会 启动 失败 重做 日志 redolog 持久性 实现 原理 事务 的 持久性 就是 通过 重做 日志 来 实现 的当 提交 事务 之后 并不是 直接 修改 数据库 的 数据 的 而是 先 保证 将 相关 的 操作 记 录到 redo 日志 中 数据库 会 根据 相应 的 机制 将 内存 的 中 的 脏 页 数据 刷 新到 磁盘 中 上图 是 一个 简单 的 重做 日志 写入 流程 在上 图中 提到 俩 个 陌生 概念 这个 俩 个 都是 innodb 存储 引擎 的 内存 区域 的 一部分 而 redologfile 是 位于 磁盘 位置 也 就说 当 有 操作 时 数据 会 先 写入 bufferpool 然后 在 写到 重做 日志 缓冲区 重做 日志 缓冲区 会 根据 刷 盘 机制 来 进行 写入 重做 日志 中 这个 机制 的 设置 参数 为 参数 分别为 上图 即为 重做 日志 的 写入 策略 当 这个 参数 的 值 为 的 时 提交 事务 之后 会把 数据 存 放到 redologbuffer 中 然后 每秒 将 数据 写进 磁盘 文件 当 这个 参数 的 值 为 的 时 提交 事务 之后 就必须 把 redologbuffer 从 内存 刷 入 到 磁盘 文件 里 去 只要 事务 提交 成功 那么 redolog 就 必然 在 磁 盘里 了当 这个 参数 的 值 为 的 情况 提交 事务 之后 把 redologbuffer 日志 写入 磁盘 文件 对应 的 oscache 缓存 里 去 而 不是 直接 进入 磁盘 文件 秒 后 才 会把 oscache 里 的 数据 写入 到 磁盘 文件 里 去 服务器 异常 停止 对 事务 如何 应对 事务 写入 过程 当 参数 为时 前 一秒 的 日志 都 保 存在 日志 缓冲区 也 就是 内存 上 如果 机器 宕 掉 可能 丢失 秒 的 事务 数据 当 参数 为时 数据库 对 io 的 要求 就 非常 高了 如果 底层 的 硬件 提供 的 iops 比 较差 那么 mysql 数据库 的 并发 很快 就会 由于 硬件 io 的 问题 而 无法 提升 当 参数 为时 数据 是 直接 写 进了 oscache 缓存 这部 分 属于 操作系统 部分 如果 操作系统 部分 损坏 或者 断电 的 情况 会 丢失 秒内 的 事务 数据 这种 策略 相对于 第一种 就 安全 了 很多 并且 对 io 要求 也没有 那么 高 小结 关于 性能 gtgt 关于 安全 gtgt 根据 以上 结论 所以说 在 mysql 数据库 中 刷 盘 策略 默认值 为 保证 事务 提交 之后 数据 绝对 不会 丢失 回 滚 日志 undolog 原子 性 实现 原理 回 滚 日志 保证 了 事务 的 原子 性 回 滚 日志 相对 重做 日志 来说 没有 那么 复杂 的 流程 当 事务 对 数据库 进行 修 改时 innodb 引擎 不仅 会 记录 redolog 日志 还会 记录 undolog 日志 如果 事务 失败 或者 执 行了 rollback 为了 保证 事务 的 原子 性 就必须 利用 undolog 日志 来 进行 回 滚 操作 回 滚 日志 的 存储 形式 如 下在 undolog 日志 文件 事务 中 使用 的 每条 insert 都 对应 了 一条 delete 每条 update 也 都 对应 一条 相反 的 update 语句 注意 系统 发生 宕机 或者 数据库 进程 直接 被杀 死当 用户 再次 启动 数据库 进程 时 还 能够 立刻 通过 查询 回 滚 日志 将 之前 未完成 的 事务 进程 回 滚 这也 就需要 回 滚 日志 必须 先于 数据 持久 化 到 磁 盘上 是 需要 先写 日志 后 写 数据库 的 主要原因 回 滚 日志 不仅仅 可以 保证 事务 的 原子 性 还是 实现 mvcc 的 重要因素 以上 就是 关于 事务 的 俩 大 日志 重做 日志 回 滚 日志 的 理解 五 锁 机制 锁在 mysql 中 是 是 非常重要 的 一部分 锁 对 mysql 数据 访问 并发 有着 举足轻重 的 作用 所以说 锁 的 内容 以及 细节 是 十分 繁琐 的 本节 只是 对 innodb 锁 的 一个 大概 整理 mysql 中有 三类 锁 分别为 行 锁 表 锁 页 锁 首先 需要 明确 的 是 这三类 锁 是 是 归属于 那种 存储 引擎 的 行 锁 innodb 存储 引擎 表 锁 myisammemory 存储 引擎 页 锁 bdb 存储 引擎 行 锁 行 锁 又 分为 共享 锁 排 它 锁 也 被 称之为 读 锁 写 锁 i innodb 存储 引擎 的 默认 锁 共享 锁 s 假设 一个 事务 对 数据 a 加了 共享 锁 s 则 这个 事务 只 能读 a 的 数据 其它 事务 只能 再 对 数据 a 添加 共享 锁 s 而 不能 添 加排 它 锁 x 直到 这个 事务 释 放了 数据 a 的 共享 锁 s 这就 保证 了 其它 事务 也 可以 读取 a 的 数据 但是在 这个 事务 没有 释 放在 a 数据 上 的 共享 锁 s 之前 不 能对 a 做 任何 修改 排 它 锁 x 假设 一个 事务 对 数据 a 添 加了 排 它 锁 x 则 只允许 这个 事务 读取 和 修改 数据 a 其它 任何 事务 都不能 在对 数据 a 添加 任何 类型 的 锁 直至 这个 事务 释 放了 数据 a 上 的 锁 排 它 锁 阻止 其它 事务 获取 相同 数据 的 共享 锁 s 排 它 锁 x 直至 释放 排 它 锁 x 特点 只 针对 单一 数据 进行 加锁 开销 大 加锁 慢 会 出现 死锁 锁 粒度 最小 发生 锁 冲突 的 概率 越 低 并发 越高 还记得 在上 文中 提到 的 事务 并发 带来 的 问题 脏 读 不可 重 读读 幻 读 学习 到了 这里 应该 就 明白 可 重 复读 repeatableread 如何 解决 脏 读 不可 重读 读了 脏 读 和 不可重复读 的 解决方案 很简单 写 前 加排 它 锁 x 事务 结束 才 释放 读 前 加 共享 锁 s 事务 结束 就 释放 表 锁 表 锁 又 分为 表 共享 读 锁 表 独占 写 锁 也 被 称之为 读 锁 写 锁 myisa 存储 引擎 的 默认 锁 表 共享 读 锁 针对 同一个 份 数据 可以 同时 读取 互不 影响 但不 允许 写 操作 表 独占 写 锁 当 写 操作 没有结束 时会 阻塞 所有 读 和 写 特点 对 整 张 表 加锁 开销 小 加锁 快 无 死锁 锁 粒度 最大 发生 锁 冲突 的 概率 越大 并发 越小 本文 主要 说明 innodb 和 myisam 的 锁 页 锁 不就 不做 详细 说明 了 如何 加锁 表 锁 隐 式 加锁 默认 自动 加锁 释放 锁 select 加 读 锁 加写 锁 手动 加锁 添加 读 锁 添 加写 锁 手动 解锁 释放 单 表 unlocktable 释放 所有 表 行 锁 隐 式 加锁 默认 自动 加锁 释放 锁 只有 select 不会 加锁 加排 它 锁 手动 加 共享 锁 手动 加排 它 锁 解锁 正常 提交 事务 commit 事务 回 滚 rollbackkill 进程 六 总结 本文 主要 对 事务 的 重点 知识点 进行 解读 内容 总结 事务 四大 特征 实现 原理 原子 性 使用 事务 日志 的 回 滚 日志 undolog 实现 隔离 性 使用 mvcc 实现 幻 读 问题 除外 持久性 使用 事务 日志 的 重做 日志 redolog 实现 一致性 是 事务 追求 的 最终目标 原子 性 隔离 性 持久性 都是 为了 保证 数据库 一致性 而 存在 事务 并发 出现问题 的 区别 脏 读 与 不可重复读 的 区别 脏 读 是 读取 没有 提交 事务 的 数据 不可重复读 读取 的 是 已 提交 事务 的 数据 幻 读 与 不可重复读 的 区别 都是 读取 的 已 提交 事务 的 数据 与 脏 读 不同 幻 读 针对 的 是 一批 数据 例如 个数 不可重复读 针对 的 是 单一 数据 事务 日志 重做 日志 redolog 实现 了 事务 的 持久性 提交 事务 后 不是 直接 修改 数据库 而是 保证 每次 事务 操作 读 写入 redolog 中 并且 落 盘 会有 三种 策略 详 细看 四节 回 滚 日志 undolog 实现 了 事务 的 原子 性 针对 dml 的 操作 都会 有 记录 相反 的 dml 操作 坚持 学习 坚持 写 博 坚持 分享 是 咔 咔 从业 以来 一直 所 秉持 的 信念 希望 在 偌大 互联网 中 咔 咔 的 文章 能带 给你 一丝丝 帮助 我 是 咔 咔 下期 见 