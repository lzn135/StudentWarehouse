腾讯 来 做客 了 我 除了 说 牛 啤 还能 说什么 cocos 和 native 交互 好 复杂 能不能 简单 一些 我们 尝 试着 使用 注解 来 解决 这个 问题 背景 abcbinding 的 结构设计 具体 实现 通过 tag 找到 native 方法 约束 native 方法 优雅 的 回 调 其他 feature 抹 平 系统 差异 无需 关心 线程 切换 支持 超时 彩蛋 在 热 更新 当中 的 应用 让 热 更 包 兼容 所有 版本 的 app 元素 绑定 致谢 背景 我们 在 使用 cocos 和 native 进行 交互 的 时候 发现 体验 并不是 特别 的 友好 如下 所示 为 我们 项目 当中 的 一段 代码 代码 已 脱敏 当 检 测到 发 生了 js 异常 我们 需要 通知 native 端 去做 一些 处理 scencemsgstack if vscencemsgstack elseif 从 代码 当中 我们 可以 看出 有 以下 问题 方法 调用 非常 麻烦 特别是 android 端 需要 明确 的 指出 方法 的 路径 方 法名 参数 类型 特别 容易 出错 一旦 native 端 的 方法 发生变化 cocos 层 必须 要 同步 修改 否则 就会 出现异常 甚至有 可能 crash 不方便 回 调 我们 尝 试着 用 注解 的 思路 来 解决 这些 问题 从而 设计 并 实现 了 能够 极大 的 简化 cocos 和 native 的 交互 方便 维护 abcbinding 的 结构设计 abcbinding 的 结构 如 下图 所示 abcbinding 包含 native 和 ts 两个 部分 native 负责 约束 本地 的 方法 ts 负责 对 cocos 层 提供 调用 native 方法 的 接口 我们 重新 定义 了 一套 cocos 和 native 的 交互 模式 提供 cocos 访问 的 native 方法 必须 为 publicstatic 且 参数 必须 为 为 sdk 提供 的 接口 能够 在 cocos 层 和 native 层 传递 数据 方法 必须 使用 abcbinder 注解 修饰 并在 注解 内 传入 约 定好 的 tag 此 tag 用于 唯一 标识 这个 方法 使用 sdk 提供 的 方法 传入 约 定好 的 tag 调用 native 方法 例子 如下 所示 为 调用 native 方法 去 下载 我们 只需要 传入 约 定好 的 tagdownloadfile 并 传入 参数 便 可以 进行 下载 了 ts 层 then result 下载 成功 pathresultpath catch error native 层 abcbinder downloadfile newthread newrunnable url try 下载 中 下载 成功 dataput pathxxxxxxjpg data catch exceptione 失败 e start 通过 例子 可以 看到 使用 abcbinding 能够 让 cocos 和 native 的 交互 简单 很多 我们 再也 不用 再 传入 复杂 的 路径 和 参 数了 而且 回 调 也 变 得很 优雅 接下来 我们 来 看看 abcbinding 是 如何 实现 的 具体 实现 从上 面的 例子 我们 可以 看出 abcbinding 是 通过 tag 来 实现 cocos 和 native 进行 交互 的 那 sdk 是 如何 通过 tag 来 找到 对应 的 方法 呢 通过 tag 找到 native 方法 我们 定义 了 编译 时 注解 编译 时 生效 target 描述 方法 在 编译 期间 会 生成 一个 类 abcbindingproxy 成员 变量 executors 包 含了 所有 对应 的 tag 和 方法 其中 真正 可执行 的 方法 被 包 装在 了 接口 当中 以 下为 自动 生成 的 代码 executorsput transfert t executorsput transfert t transfert 因此 我们 只需要 通过 executors 和 tag 就可以 找 到了 对应 的 方法 了 接着 我们 看看 ts 是 如何 与 native 进行 交互 的 以下 是 sdk 里面 ts 层 的 部分 代码 sdk 屏蔽 了 调用 的 具体 细节 将 请求 的 参数 转变 成为 json 字符串 并将 相关 的 参数 传 递给 sdk 内部 的 方法 execute 由 execute 将 请求 转发给 真正 的 方法 args cbname elseif args cbname msg 这样 我们 就 解决 了 通过 tag 找到 对应 方法 的 问题 但 还有 两个 问题 需要 解决 如何 约束 native 方法 以及 如何 保证 tag 的 唯一性 约束 native 方法 abcbinding 规定 提供 cocos 访问 的 native 方法 必须 为 publicstatic 参数 必须 为 transfer 且 tag 必 须要 保持 唯一性 那 怎么 来 约束 呢 在 代码 的 编译 期间 我们 会去 检查 所有 被 abcbinder 修饰 的 方法 若 发现 这个 方法 并不 符合 我们 的 规范 则会 直接 报错 如下 所示 参数 错误 abcbinder test logi 测试 test 方法 非 staticabcbinder test publicvoidtest logi 测试 test 方法 非 publicabcbinder test logi 测试 test tag 重复 abcbinder helloworld logi 测试 test abcbinder helloworld logi 测试 test 优雅 的 回 调 sdk 会在 编译 期间 自动 生成 calljs 方法 所有 的 回 调 都是 通过 calljs 方法 实现 native 方法 只需要 调用 transfer 所 提供 的 回 调 接口 便 可以 轻松 的 将 结果 回 调给 cocos 由于 calljs 代码 是 自动 生成 所以 sdk 不需要 直接 依赖 cocos 库 只需要 业务 方 依赖 即可以 下为 自动 生成 的 代码 newrunnable s command abcbinding 提供 了 和 onfailed 回 调 方法 以 下为 downloadfile 接口 的 的 回 调 示例 ts 层 回 调 progress then result gt 回 调 下载 成功 pathresultpath catch error gt 回 调 onfailedif error native 层 abcbinder downloadfile newthread newrunnable url try 模拟 下载 过程 for intiilti currenti 下载 成功 dataput pathxxxxxxjpg data catch exceptione 失败 e start 其他 feature 抹 平 系统 差异 使用 abcbinding 无须再 判断 当前 系统 是 android 还是 ios 只需 对应 native 方法 的 tag 保持一致 即可 islowdevice then islowdevice gtconsolelog islowdevice 无需 关心 线程 切换 native 方法 使用 transfer 回 调 时 abcbinding 会 自动 切 换到 cocos 线程 执行 无需 业务 方 关心 abcbinding gethardwareinfo dataput brandbuildbrand dataput modelbuildmodel dataput dataput data 支持 超时 abcbinding 支持 设置 超时 其中 超时 的 时间 单位 为 秒 如下 所示 超 时会 回 调到 catch 方法 当中 progress then result 下载 成功 pathresultpath catch error gtif consolelog 超时 彩蛋 在 热 更新 当中 的 应用 我们 在 使用 cocos 热 更新 服务 的 过程中 发现 怎么 确定 cocos 热 更新包 能够 发布 到 哪个 app 版 本是 个 难题 cocos 热 更新包 能不 能在 这个 app 版本 上 正确 运行 跟 两个 因素 有关 cocos 版本 和 native 接口 cocos 版本 如果 app 和 热 更 包 的 cocos 版本 不一致 那么 很有 可能 这个 热 更 包 无法 在 app 上 运行 除非 官方 做了 一些 兼容 处理 不过 这个 因素 可控 cocos 的 版本 不会 频繁 的 升级 而且 我们 知道 cocos 版本 和 app 版本 的 对应 关系 native 接口 如果 热 更 包 调 用了 某个 native 的 接口 但是 这个 接口 在 有些 版本 上 不存 在那 该 热 更 包 就 无法 在 这个 版本 的 app 上 运 行在 腾讯 开心 鼠 的 业务 场景 当中 cocos 版本 不会 频繁 变更 但是 每个 版本 的 native 代码 可能会 相差 较大 人工 来 核对 每个 版本 的 native 接口 变 更是 一件 极为 费时 费力 的 事情 那么 abcbinding 能 帮助 我们 做什么 呢 让 热 更 包 兼容 所有 版本 的 app 首先 我们 去除 cocos 版本 的 因素 因为 这个 因素 可控 且 业务 方 无法 解决 abcbinding 知道 本地 有 哪些 接口 可用 所以 当 cocos 调 用了 一个 不存在 的 接口 时 我们 会 返回 一个 特殊 的 code 这样 热 更 包 只需要 在内部 做 兼容 处理 就可以 了 如下 所示 then result gt 处理 逻辑 catch error gtif consolelog 未找到 该 方法 元素 绑定 既然 热 更新 跟 这两个 元素 有关 我们 就可以 通过 这两个 元素 让 app 和 热 更 包 进行 匹配 如果 能够 匹配 那么 这个 热 更 包 就可 以下 发到 这个 版本 的 app 上 cocos 版本 我们 在 打包 的 时候 就可以 确定 native 接口 在 打包 的 过程中 abcbinding 可以 将 当 前所 支持 的 接口 按照 约定 的 方式 生成 一个 元素 例如 本地 的 接口 有 testtesttest 我们 可以 将 接口 按照 指定 的 方式 排序 拼 接取 md 值 生成 第二个 元素 这样 当 app 和 热 更新包 的 两个 元素 能够 匹配 时 就 能够 下 发了 致谢 一起 开发 的 小伙伴 官方 旗舰店 庆 五一 全场 五 折起 最近 几 者 会 新品 上 架 限量 促销 手慢 无期 错过 估计 要 等到 双 了 阅读 原文 直达 creator 全 平台 游戏 开发 教程 pdf 免费 下载页 大龄 个人 开发者 我 是 如何 活 下来 的 又将 怎样 活下去 小游戏 sdk 整合 框架 最新 支持 原生 穿山甲 隔壁 老王 带你 入 坑 腾讯 联机 对战 引擎 更新 creator 最佳 文字 书写 解决方案 