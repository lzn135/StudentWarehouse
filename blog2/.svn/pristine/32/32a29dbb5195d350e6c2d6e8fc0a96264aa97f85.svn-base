漏洞 挖掘 的 艺术 面向 二进制 的 静态 漏洞 挖掘 x 本文 是 本 系列 的 第二篇 将对 面向 二进制 程序 的 静态 漏洞 挖掘 技术 进行 介绍 与 分析 面向 二进制 程序 的 静态 漏洞 的 挖掘 技术 由于 缺少 源代码 中 的 结构化 信息 面临着 值 集 分析 与 控制 流 恢复 不精确 的 问题 但是 二进制 程序 相对于 源码 而言 更 容易 获得 所以 这方 面的 研究工作 一直 都有 新 的 研究 动态 并且 会在 x 部分 介绍 目前 流程 的 两种 技术 在 进一步 分析 之前 我们 首 先来 具体 解释 前文 提出 的 两个 问题 x 值 集 分析 是 一种 结合 数值 分析 和 指针 分析 的 静态 分析 算法 vsa 是 一种 基于 抽象 解释 的 流 敏感 上下文 敏感 支持 过程 间 分析 的 方法 vsa 首先 建立 抽象 内存 模型 恢复 可执行 程序 中 的 变量 并用 抽象 地址 表示 然后 对 每条 指令 静态 计算 抽象 地址 可能 包含 的 值 的 集合 典型 的 值 集 分析 算法 的 伪 码 表示 如下 上图 的 集合 w 被称为 wordlist 其 操作 包括 addremovenext 分别 用于 添加 和 移除 项 wordlist 按照 拓扑 顺序 进行 排序 初始 化时 包含着 基本块 的 入口 点 用于 指示 从 此处 开始 正向 分析 while 循环 的 每次 迭代 里 analysis 函数 都 会在 第 行 被 调 用来 分析 选中 的 基本块 analysis 会 基于 输入 状态 产生 大量 的 输出 状态 那些 变化 的 输出 状态 会被 添加到 wordlist 中 当在 同一 基本块 上有 两个 输入 状态 时 vsa 将在 第 行将 两个 输入 状态 合 并为 新 的 输入 状态 合并 操作 将 合并 抽象 状态 中 每个 变量 的 值 集 变量 的 合并 运算 方程式 如下 所示 当 程序 读写 内存 时 根据 目的 地址 的 值 集 和 将要 读写 的 内存地址 的 长度 我们 可以 检 测出 它 是否 超 过了 对应 变量 的 空间 大小 如果 超过 则可 以 作为 一个 潜在 的 漏洞 上报 然而 由于 vsa 获得 的 值 集 是 近似 的 并不 精确 所以 可能会 导致 较高 的 误报率 这里 有篇 年 的 硕士论文 二进制 程序 useafterfree 漏洞 挖掘 技术研究 里面 介绍 了 基于 值 集 分析 来 挖掘 uaf 感兴趣 的 可以 看看 另外 这篇 论文 发表于 usenixsecurity 信息 安全 领域 四 大顶 会 之一 介绍 通过 深度 学习 来 辅助 值 集 分析 的 研究 控制 流 恢复 不精确 指的是 静态 分析 不需要 执行 程序 只 通过 对 二进制 文件 的 结构 和 指令 操作码 进行 分析 静态 分析 重视 全局 程序 分析 因而有 很高 的 代码 覆盖率 但由于 无法 解决 间接 跳转 的 问题 导致 无法 获取 完整 的 控制 流 信息 我们 来 看看 控制 流 图 的 静态 恢复 对 二进制 代码 进行 控制 流 分析 首先要 完 成对 二进制 代码 的 静态 反汇编 根据 区分 代码 和 数据 方式 的 不同 可以 将 静态 反汇编 策略 分为 线性 扫描 反汇编 递归 反汇编 和 启发式 反汇编 三种 目前 应用 最广 的 静态 反汇编 策略 是 基于 程序 静态 控制 流程 的 递归 策略 ida 使用 的 就是 递归 下降 的 算法 由于 这不是 本文 重点 就不 展 开了 接下来 就是 基本块 的 划分 基本块 是 程序 中一 组 顺序 执行 的 语句 序列 其中 只有 一个 入口 语句 和 一个 出口 语句 基本块 是 具有 原子 性 的 一组 连续 语句 序列 控制 从 第一条 语句 流入 从 最后 一条 语句 流出 中途 没有 停止 或 分支 意味着 当 程序 跳 转至 某 基本块 时 该 基本块 中 的 所有 指令 都将 被执行 到 因此 覆盖 执 行了 该 基本块 就等 同于 覆 盖了 基本块 所有 指令 以 基本块 为 单位 对 反汇编 效果 进行 分析 相比 于 指令 级 粒度 的 分析 更加 高效 基本块 入口 定义 a 代码 片段 标签 start 和 main 等 是 出现在 代码 段 前 的 标志 的 下一 条 指令 b call 指令 在 指令 顺序 流 的 下一 条 指令 c 跳转 语句 在 指令 顺序 流 的 下一 条 指令 基本块 出口 定义 a 代码 片段 的 最后 一条 指令 b call 指令 c 跳转 指令 d 返回 指令 一般 采用 线性 扫描 指令 的 方法 实现 基本块 的 划分 如下 所示 完成 基本块 划分 之后 需要 构建 基本块 之间 的 控制 流 关系 最后 一步 就是 cfg 控制 流 分析 如果在 一个 有序 代码 中 基本块 b 跟在 b 后 那么 产生 一个 由 b 指向 b 的 有 向 边 在对 目标 二进制 程序 完成 基本块 划分 后 需 要对 基本块 间 的 控制 流 转向 进行 分析 完成 控制 流 的 绘制 伪 码 如下 input 基本块 列表 建立 一条 由 blocki 到 x 跳转 的 target 所在 的 blockj 的 有 向 边 建立 由 blocki 到 blocki 的 边 当前 二进制 静态 漏洞 挖掘 技术 主要 包括 基于 模式 匹配 和 基于 补丁 比对 的 技术 什么 是 模式 匹 配在 计算机 科学 中 模式 匹配 是 检查 给定 的 标记 序列 是否 存在 某些 模式 的 组成部分 的 行为 与 模式识别 相反 匹配 通常 必须 精确 匹配 或 不 匹配 图案 通常 具有 序列 或 树形 结构 的 形式 模式 匹配 的 用途 包括 输出 令牌 序列 中 模式 的 位置 输出 匹配 模式 的 某些 组成部分 以及 将 匹配 模式 替 换为 其他 某些 令牌 序列 针对 二进制 程序 分析 时 一般 不会 单独 应用 模式 匹配 技术 比如 会 和 vsa 相结合 以 gueb 为 例 其 提 出了 二进制 程序 中 uaf 漏洞 模式 并 基 于此 模式 挖掘 出了 proftpd 程序 中 的 漏洞 具体 而言 首先 抽象 出 二进制 函数 中 的 内存 模型 然后 采用 vsa 分析 技术 追踪 堆 分配 和 释放 指令 相关 的 操作 变量 并 基 于此 建立 uaf 模式 全文 是以 一个 例子 进行 驱动 的 源码 如下 这里 注意 这里 虽然 给 出了 代码 但是 文中 的 工作 都是 从 二进制 层面 展开 的 给出 源码 是为了 方便 说明 首先 抽象 出 内存 模型 我们 假设 堆栈 中 的 地址 表示 为 相对于 基址 寄存器 ebp 的 偏移量 由于 过程 间 分析 是 通过 过程 内联 实现 的 因此 每个 堆栈 元素 都由 ebp 偏移量 表示 其中 ebp 是 ebp 的 初始值 例如 pindex 由 ebp 表示 pglobalsave 由 ebp 表示 全局变量 具有 由 标识符 表示 的 常量 地址 此处 为 变量名 例如 pglobal 对于 堆 我们 将 he 定义 为 所有 可能 的 堆 元素 的 集合 he 的 元素 是 基址 大小 其中 base 是 分配 识别 符 size 是 分配 大小 这样 的 一对 也 称为 一个 chunkpc 是 所有 程序 指针 的 集合 我们 定义 了 ha 和 hf 这两个 函数 分别 关联 每个 点 上 所有 当前 分配 或者 未 分配 的 集合 是 s 的 幂 集 我们 使 用在 静态 指针 验证 中 的 经典 的 假设 认为 每个 分配 都 提供 了 一个 新 的 内存 块 尽管 这种 方法 对于 研究 可利用 性 是 不现实 的 但 足以 检测 漏洞 接着 进行 vsa 结果 如下 gueb 的 最后 一步 即从 二进制 层面 提 取出 uaf 漏洞 模式 的 子 图 如下 所示 此 子 图 对于 研究 uaf 是否 可利用 以及 如何 利用 非常 有用 例 如在 我们 的 示例 中 在 第 行 释放 和 取消 引 用时 是否 发 生了 新 的 malloc 补丁 指的是 软件 开发商 为了 修补 软件 系统 的 各种 漏洞 或 缺陷 所 提供 的 修补 程序 对于 开源 软件 补丁 本身 就是 程序 源代码 打补丁 的 过程 就是 用 补丁 中 的 源代码 替换 原有 的 代码 而 对于 闭 源 软件厂商 只提供 修改后 的 二进制 代码 例如 微软 的 windows 系统 补丁 这时 就需要 使用 二进制 代码 比对 技术 定位 补丁 所 修补 的 软件 漏洞 基于 补丁 对比 的 漏洞 挖掘 是 指 通过 比较 分析 原始 程序 与 漏洞 修复 后 的 更新 程序 的 差异 依据 已知 漏洞 对应 的 软件缺陷 位置 寻找 新 漏洞 的 一种 漏洞 挖掘 方法 补丁 发布 与 部署 之间 存在 较长 的 时间 窗口 因此 通过 补丁 漏洞 挖掘 迅速 提取 漏洞 特征 对于 软件 运行 安全 检测 和 防护 具有 重要意义 目前 软件 自身 的 复杂性 导致 简单 地 进行 指令 对比 难以 快速 逆向 恢复 漏洞 细节 并 理解 漏洞 机理 与 漏洞 不相关 的 补丁 修改 造成 相当程度 的 干扰 补丁 漏洞 挖掘 仍然 需要 软件 基础理论 的 支撑 为此 研究人员 提 出了 多种 基于 图 比较 算法 发现 程序 差异 的 基础 分析 工具 如 等 补丁 漏洞 挖掘 的 代表性 工作 是 brumley 团队 提出 的 apeg 方案 年 的 ieeesampp 会议 上 的 论文 apeg 核心 思路 是 基于 以下 的 假设 条件 即 补丁 程序 中 增加了 对 触发 原程序 崩溃 的 过滤 条件 因此 只要 能够 找到 补丁 程序 中 添加 过滤 条件 的 位置 同时 构造 不满足 过滤 条件 的 违规 输入 即可 认为是 原始 程序 的 一个 可利用 的 输入 候 选项 该 工作 主要 分为 三个 步骤 首先 利用 二进制 差异 比较 工具 例如 bindiff 与 ebds 等 找到 补丁 存在 的 位置 即 补丁 程序 的 检测 点 其次 找出 不满足 补丁 程序 检测 点 的 输入 数据 作为 原始 程序 的 利用 候 选项 最后 利用 污点 传播 等 监控 方法 筛选 所有 能够 对 原始 程序 造成 溢出 或者 控制 流 劫持 等 崩溃 发生 的 有效 利用 根据 对 微软 所 发布 的 多个 补丁 程序 的 实验 结果表明 该 方法 具有 较强 的 可靠性 和 实用性 apeg 是 对 漏洞 利用 自动化 构建 的 首次 尝试 虽然 核心 思想 较为 简单 但由于 其 具有 很强 的 可操作性 因此 也 得 到了 其他 研究人员 的 普遍 认可 x 参考 软件 漏洞 自动 利用 研究进展 从 自动化 到 智能化 软件 漏洞 挖掘 技术 进展 