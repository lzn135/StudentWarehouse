系统安全 十七 windows pe 病毒 概念 分类 及 感染 方式 详解 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 作者 前文 介绍 了 pe 文件 格式 熟悉 各种 pe 编辑 查看 工具 针对 目标 exe 程序 新增 对话框 等 这篇 文章 将 介绍 windowspe 病毒 包括 pe 病毒 原理 分类 及 感染 方式 详解 并 通过 案例 进行 介绍 这些 基础 性知识 不仅 和 系统安全 相关 同样 与 我们 身边 的 app 常用软件 及 操作系统 紧密联系 希望 这些 知识 对 您 有所 帮助 更 希望 大家 提高 安全意识 安全 保障 任重道远 本文 参考 了 软件 安全 视频 安全 网站 和 参考文献 中 的 文章 并 结合 自己 的 经验 和 实践 进行 撰写 也 推荐 大家 阅读 参考文献 文章 目录 一 pe 病毒 概念 二 pe 病毒 的 分类 三 传统 文件 感染 型 感染 思路 pe 病毒 典型 案例 关键技术 重 定位 api 函数 自 获取 目标 程序 遍历 搜索 文件 感染 四 捆绑 释放 型 五 系统 感染 型 控制权 再次 获取 病毒 的 传播 方式 六 总结 从 年月 开始 我 来 到了 一个 陌生 的 专业 网络空间 安全 初 入 安全 领域 是 非常 痛苦 和 难受 的 要 学 的 东西 太多 涉及面 太 广 但 好在 自己 通过 分享 篇 网络安全 自学 系列 文章 艰难 前行 着 感恩 这一 年 相识 相知 相 趣 的 安全 大佬 和 朋友们 如果 写得 不好 或 不足之处 还请 大家 海涵 接下来 我 将 开启 新 的 安全 系列 叫 系统安全 也是 免费 的 篇文章 作者 将 更加 深入 的 去 研究 恶意 样本 分析 逆向 分析 内网 渗透 网络 攻防 实战 等 也 将 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 加油 推荐 前文 网络安全 自学 篇 系列 篇 作者 的 github 资源 逆向 分析 网络安全 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 系统安全 八 windows 漏洞 利 用之 cve 复现 及 蓝屏 攻击 系统安全 九 windows 漏洞 利 用之 ms 远程 代码 执行 漏洞 复现 及 深度 提 权 系统安全 十 windows 漏洞 利 用之 smbv 服务 远程 代码 执行 漏洞 cve 复现 系统安全 十一 那些 年 的 熊猫 烧香 及 pe 病毒 行为 机理 分析 系统安全 十二 熊猫 烧香 病毒 ida 和 od 逆向 分析 上 病毒 初始化 系统安全 十三 熊猫 烧香 病毒 ida 和 od 逆向 分析 中 病毒 释放 机理 系统安全 十四 熊猫 烧香 病毒 ida 和 od 逆向 分析 病毒 释放 过程 下 系统安全 十五 chrome 浏览器 保留 密码 功能 渗透 解析 蓝屏 漏洞 及 某 音乐 软件 漏洞 复现 系统安全 十六 pe 文件 逆向 基础知识 pe 解析 pe 编辑 工具 和 pe 修改 系统安全 十七 windowspe 病毒 概念 分类 及 感染 方式 详解 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 该 样本 不会 分享 给 大家 分析 工具 会 分享 参考文献 见 后 一 pe 病毒 概念 什么 是 pe 病毒 pe 病毒 又 称为 winpe 病毒 或 称为 win 病毒 它 指 所有 感染 windows 下 pe 文件 格式文件 的 病毒 因为 它 通常 采用 win 汇编 编写 而且 格式 为 pe 文件 因此而 得名 pe 病毒 是以 windowspe 程序 为 载 体能 寄 生于 pe 文件 或 windows 系统 的 病毒 程序 真正 的 病毒 技术 在 pe 病毒 中 才会 得到 真正 的 体现 所以 对于 一个 黑客 骇客 或者是 热衷于 病毒 分析 技术 的 程序员 是非 常有 必要 进行 学习 pe 病毒 的 编写 的 pe 病毒 数量 非常 之多 下面 介绍 三种 经典 的 病毒 cih 病毒 早期 病毒 全球 第一个 可以 破坏 计算机硬件 的 病毒 它会 破坏 主板 的 bios 对 其 数据 进行 擦写 修改 cih 病毒 是 一种 能够 破坏 计算机 系统 硬件 的 恶性 病毒 这个 病毒 是 tw 陈 盈 豪 在 念书 期间 制作 后 通过 网络 传 播到 全世界 各个 角落 cih 的 载体 是 一个 名为 icq 中文 chat 模块 的 工具 并以 热门 盗版 光盘 游戏 如 古墓 奇兵 或 windows 为 媒介 经 互联网 各 网站 互相 转载 使其 迅速 传播 传播 的 主要 途径 主要 通过 internet 和 电子邮件 当然 随着 时间 的 推移 其 传播 主要 仍将 通过 软盘 或 光盘 途径 cih 病毒 曾 入 榜 全球 十大 计算机病毒 之首 该 病毒 引 起了 许多 重要 部门 的 严密 关注 熊猫 烧香 熊猫 烧香 wormwhboy 是 一款 拥有 自动 传播 自动 感染 硬盘 能力 和 强大 的 破坏 能力 的 病毒 它不 但能 感染 系统 中 等 文件 它 还能 中止 大量 的 反病毒软件 进程 并且会 删除 扩展 名为 gho 的 文件 该 文件 是 一 系统 备份 工具 ghost 的 备份文件 使 用户 的 系统 备份文件 丢失 被 感染 的 用户 系统 中所 有 exe 可执行文件 全部 被 改成 熊猫 举着 三根 香 的 模样 年月日 由 岁 的 湖北武汉 李 俊 编写 年 月初 肆虐 网络 它 主要 通过 下载 的 文件 传染 传播 wannacry 蠕虫 年月日 wannacry 蠕虫 通过 永恒 之 蓝 ms 漏洞 在 全球 范围 大 爆发 感染 大量 的 计算机 wannacry 勒索 病毒 全球 大 爆发 至少 个 国家 万名 用户 中招 造成 损失 达 亿 美元 已 影响 金融 能源 医疗 教育 等 众多 行业 造成 严重 的 危害 wannacry 是 一种 蠕虫 式 勒索 病毒软件 由 不法分子 利用 nsa 泄露 方程式 工具包 的 危险 漏洞 eternalblue 永恒 之 蓝 进行 传播 该 蠕虫 感染 计算机 后会 向 计算机中 植入 敲诈者 病毒 导致 电脑 大量 文件 被 加密 wannacry 利用 windows 系统 的 smb 漏洞 获取 系统 的 最高 权限 该 工具 通过 恶意代码 扫描 开放 端口 的 windows 系统 被 扫 描到 的 windows 系统 只要 开机 上线 不需要 用户 进行 任何 操作 即可 通过 共享 漏洞 上传 wannacry 勒索 病毒 等 恶意程序 什么 叫 感染 说到 病毒 不得 不提 感染 感染 是 指在 尽量 不影响 目标 程序 系统 正常 功能 的 前提下 而 使其 具有 病毒 自身 的 功能 什么 叫 病毒 自身 的 功能 呢 一个 病毒 通常 包括 如下 模块 感染 模块 被 感人 程序 同样 具备 感染 能力 触发 模块 在 特定 条件下 实施 相应 的 病毒 功能 比如 日期 键盘输入 等 破坏 模块 网络 攻击行为 推荐 攻击 链 或 attampck 其他 模块 如果 我们 要 编写 pe 病毒 则 需要 掌握 以下 的 关键 病毒 的 重 定位 获取 api 函数 地址 文件 搜索 内存 映射 文件 病毒 如何 感染 其他 文件 病毒 如何 返 回到 host 程序 二 pe 病毒 的 分类 以 感染 目标 进行 分类 包括 文件 感染 将 代码 寄 生在 pe 文件 病毒 本身 只是 pe 文件 的 一部分 依赖于 感染 目标 通常 也 叫 host 文件 控制权 获得 也 是以 目标 程序 运行 来 获得 的 分为 传统 感染 型 以 win 汇编程序 编写 为主 捆绑 释放 型 编写 难度 较低 通过 高级 语言 均可 编写 将 目标 程序 和 病毒 程序 捆在 一起 和 捆绑 器 有 相似之处 系统 感染 将 代码 或 程序 寄 生在 windows 操作系统 该类 病毒 越来越多 它不 感染 具体 文件 但是 它 会在 操作系统 中 保存 自己 的 实体 同时 也 可以 通过 系统启动 的 方法来 获取 控制权 传播 途径 包括 即时 通信 软件 如 qq 尾巴 u盘 光盘 电子邮件 网络共享 其他 途径 三 传统 文件 感染 型 感染 思路 作者 前面 详细分析 了 pe 文件 格式 参考 文章 系统安全 十六 pe 文件 逆向 基础知识 pe 解析 pe 编辑 工具 和 pe 修改 当 我们 了解 pe 文件 格式 之后 要 了解 pe 文件 感染 型 病毒 就 非常 容易 了如 下图 所示 左边 是 一个 正常 的 pe 文件 右边 是 pe 病毒感染 该 程 序时 的 修改 可以 看到 病毒 代码 在 最后面 通常 它是 一种 新 节 的 形式 我们 知道 pe 文件 是 由 多个 节 组成 的 病毒 代码 为了 融入 目标 程序 会 以 节 的 形式 同时 修改 pe 文 件头 对 感染 来 说它 一方面 需要 使得 对方 具备 自己 的 功能 另一方面 也 不 破坏 对方 程序 的 功能 所以 病毒 代码 执行 完毕 之后 它 必须 要将 控制权 交给 原始 程序 从而 防止 病毒 被 发现 优点 被 感染 后 的 程序 主题 依然是 目标 程序 不影响 目标 程序 图标 隐蔽性 稍好 缺点 对 病毒 代码 的 编写 要求 较高 通常是 汇编语言 编写 难以 成功 感染 自 校验 程序 pe 病毒 典型 案例 下面 是 演示 案例 感染 本 目 录下 的 testexe 文件 它 没有 破坏性 tsetexe 被 感染 后 首先 执行 病毒 代码 然后 执行 自身 代码 如 下图 所示 存在 四个 文件 其中 mainexe 是 pe 病毒 程序 它会 感染 当前 目 录下 名为 testexe 的 文件 这里 仅是 测试 pe 病毒感染 代码 没有 破坏 功能 calcexe 计算器 notepadexe 记事本 testexe 测试 pe 文件 mainexepe 病毒 程序 第一步 我们 尝试 打开 testexe 文件 它是 一个 正常 的 pe 文件 前面 的 文章 也 分析 过 它 包括 两个 弹窗 如 下图 所示 第二步 使用 od 打开 testexe 如 下图 所示 发现 起始 地址 为 x 该 exe 程序 大小 为 kb 第三步 运行 mainexe 程序 它是 pe 病毒 注意 它会 弹出 如 下图 所示 对话框 这是 为了 方便 演示 而 真实 的 pe 病毒 不会 提示 你 信息 程序 是 两位 大佬 所写 其中 一位 是 hume 前辈 另一位 同时 如果会 查杀 该 病毒 添加 信任 即可 但 当 我们 在 真实 恶意 样本 分析 时 一定 要在 虚拟机 等 有 保护环境 下 进行 ida 分析 mianexe 如 下图 所示 第四步 此时 testexe 文件 大小 已经 增 加为 kb 说明 其 已经 被 恶意 感染 双击 testexe 显示 如 下图 所示 它会 先 弹出 一个 感染 测试 对话框 然后 才是 接下来 的 正常 程序 对话框 用 od 动态 分析 发现 程序 入口 地址 是 xdc 说明 该 程序 先 执行 pe 病毒 之后 才 执行 正常 的 程序 而 真实 的 pe 病毒 不会 只 简单 的 弹出 提示 窗口 而会 隐蔽 的 进行 一些 破坏 或 收集 信息 第五步 将被 感染 的 testexe 重 命名为 testokexe 然后 将 记事本 修 改为 testexe 因为 我们 的 代码 只 感染 当前 目 录下 test 命名 的 文件 接着 运行 testokexe 程序 发现 打开 记事本 也 会 弹出 如 下图 所示 的 对话框 接着 才是 记事本 说明 该 程序 也 被 感染 第六步 通过 同样 的 方法 感染 计算器 程序 如 下图 所示 写到 这里 该 案例 就 演示 完毕 这是 一个 传统 典型 的 pe 病毒感染 示例 关键技术 重 定位 重 定位 在前面 讲 pe 文件 格式 化时 介绍 过 尤其 dll 文件 常见 重 定位 因为 dll 文件 会加 载到 不同 的 位置 如果 再 按照 va 地址 定位 会 出现 差错 所以会 出现 重 定位 对于 病毒 程序 也是 一样 的 它有 相应 的 代码 去 感染 目标 程序 而 目标 程序 有 很多 病毒 程序 写在 目标 程序 什么 位置 呢 这就 需要 病毒 代码 去 定位 目标 程序 的 位置 就要 利用 重 定位 技术 关键 点 病毒 代码 目标 寄生 位置 不 固定 shellcode 类似 通常 需要 注入 远程 系统 但 这段 代码 在 远程 系统 什么 位置 有时 并不能 确定 另外 远程 系统 的 环境 有时 也 不能 准确 感知 故 需要 使用 重 定位 和 api 函数 自 获取 技术 为什么 需要 重 定位 呢 下面 是 一段 源代码 pe 最小 文件 案例 通过 mas 编译 生成 的 目标 程序 源代码 非常 简单 就是 调用 invoke 通过 invoke 调用 messagebox 函数 包括 四个 参数 程序 第二个 语句 是 invoke 调用 退出 这里 弹出 对话框 涉及 两个 字符串 szcap 和 当 该 程序 编译 之后 反汇编 结构 显示 如 下图 所示 比如 start 位置 messagebox 函数 包括 四个 参数 我们 采用 push 压 入 堆栈 再 call 调用 该 函数 图中 红色 圆圈 显示 的 是 pe 文件 代码 的 二进制 部分 它是 一个 va 的 地址 即 rvaimagebase 程序 在 编译 后 某些 va 地址 如 变量 varxxh 就 已经 以 二进制 代码 的 形式 固定 这 就是 需要 重 定位 的 原因 下图 展示 正常 情况 的 imagebase 值 为 h 比如 hex 数据 为 由于 高位 在后面 所以 对应 的 地址 是 如果 imagebase 为 h 则 代码 不做 重 定位 push 压 入 堆栈 的 值 为 和 而 此时 的 值 什么 也 不是 通过 数据 窗口 定位 地址 发现 不存在 左下角 可以 看到 位置 才是 存放 的 数据 所以 重 定位 需 要将 这里 的 修 改为 总之 如果 病毒 代码 插入 位置 不 固定 也 会 遇到 类似 的 问题 病毒 代码 必须 通 过重 定位 解决 类似 的 问题 下面 看看 病毒 代码 植入 host 文件 后 的 位置 差异 左边 是 病毒 在 感染 前 的 var 位置 其 地址 为 xx 当 这段 代码 插入 到 另一个 host 文件 后 如右 图 所示 变量 的 实际 位置 和 预期 位置 出现 了 差异 而 重 定位 的 关键是 知道 这个 差异 是多少 后续 遇到 的 各种 变量 或 地址 都可以 通过 这种 差异 方式 校正 重 定位 本质 修正 实际 地址 与 预期 地址 的 差异 但是 根据 host 特征 逐一 硬 编码 这种 方式 不太 可 取其 繁琐 且 未必 准确 所以 采用 另一 种方法 病毒 代码 运行 过程中 自我 重 定位 下图 展示 了 病毒 代码 自我 重 定位 的 过程 第一步 计算 差异 值 第二步 调用 calldelta 将 下一 条 语句 开始 位置 压 入 堆栈 此时 堆栈 顶端 存放 的 是 popebp 语句 它在 内存 中 是 真实 的 地址 第三步 做 sub 减法 操作 ebp 减去 offsetdelta 第四步 当 需要 重 定位 时 比如 使用 varl 变量 重 定位 通过 ebpoffset 来 消除 差异 此时 eax 中 存放 varl 在 内存 中 的 真实 地址 call 语句 功 能将 下一 条 语句 开始 位置 压 入 堆栈 jmp 到 目标 地址 执行 api 函数 自 获取 首先 介绍 下 pe 文件 函 数节 的 功能 当 调用 外部 dll 中 的 api 函数 时 通过 引入 函 数节 将 这种 关系 定义 出来 系统 加载 时 就能 加载 对应 的 dll 文件 并 找到 相应 的 api 函数 再将 地址 写入 到 pe 文件 的 引入 函 数表 中 程序 运行时 就 直接 从 引入 函 数表 中 取 地址 进行 调用 这是 正常 的 pe 文件 运行 过程 通常 函 数节 是 由 目标 程序 作者 编写 但 对于 病毒 程序 来说 它是 一段 代码 当 它 感染 另外 一个 程 序时 它 是否能 修改 目标 程序 的 引入 函 数节 而 使得 其 可以 服务 病毒 代码 呢 从 原理 上 来说 这是 可以 实现 的 但 非常复杂 因为 要在 引用 函 数节 添加 东西 一 定会 导致 其他 结构 的 变化 需 要做 很多 的 修正 工作 这也 可能 破坏 原有 功能 所以 对于 病毒 来 说它 需要 自己 去 获取 api 函数 地址 并且 没有 引入 函 数节 的 支撑 但 它又 必须 要 使用 很多 api 函 数来 实现 病毒 功能 关键 点 需要 使用 的 api 函数 但无 引入 函数 节 支撑 shellcode 类似 需要 使用 api 函数 自 获取 技术 来 确定 注入 远程 系统 的 位置 如何 获取 api 函数 地址 呢 dll 文件 的 引出 函 数节 kerneldll 核心 api 函数 为 getprocaddress 和 函数 包括 两个 参数 模块 基 地址 和 想要 获取 api 函数 名称 它将 动态 获得 dll 函数 的 入口 地址 loadlibrarya 函数 将 制定 的 dll 动态 链接库 加 载到 内存 中 返回值 为 dll 文件 加 载到 内存 中 的 基 地址 当 我们 获得 getprocaddress 和 loadlibrarya 地址 后 想 获取 任何 一个 api 函数 地址 都可以 那么 怎么 获取 这两个 函数 的 地址 呢 首先 获得 kerneldll 的 模块 加载 基 地址 一种 方法 是 采用 硬 编码 兼容性 差 另一 种方法 通过 kernel 模块 中 的 相应 结构 和 特征 定位 其次 通过 kerneldll 的 引出 目录 表 结构 定位 具体 函数 的 函数 地址 接着 我们 看看 获取 kernel 模块 基 地址 的 典型 方法 定位 kernel 模块 中 任何 一个 地址 然后 按照 模块 首 地址 特征 对齐 于 hpe 文件 开始 标识 mz 向 低 地址 遍历 定位 pe 文 件头 kernel 模块 内 的 地址 从 何处 获得 程序 入口 代码 执 行时 stack 顶端 存储 的 地址 seh 链 末端 peb 相关 数据结构 指向 了 各 模块 地址 stack 特定 高端 地址 的 数据 注意 不同 操作系统 存在 差别 目标 程序 遍历 搜索通 常以 pe 文件 格式 的 文件 如 exescrdll 等 作为 感染 目标 其 关键 点 为 全盘 查找 或者 部分 盘符 查找 遍历 算法 包括 递归 或 非 递归 在对 目标 进行 搜索 时 通常 调用 两个 api 函数 搜索 目标 进行 感染 算法 如下 文件 感染 感染 的 关键是 病毒 代码 能够 得到 运行 常用 方法 包括 选择 合适 的 位置 放入 病毒 代码 已有 节 新增 节 将 控制权 交给 病毒 代码 如 修改 程序 入口 点 或者 在 原 目标 代码 执行 过程中 运行 病毒 代码 epo 技术 同时 病毒 代码 执 行时 程序 的 正常 功能 不能 被 破坏 即 控制权 的 交换 感染 时 记录 原始 程序 控制点 位置 病毒 代码 执行 完毕 之后 返回 控制权 避免 重复 感染 感染 标记 感染 文件 的 基本 步骤 为 判断 目标 文件 开始 的 两个 字节 是否 为 mz 判断 pe 文件 标记 pe 判断 感染 标记 如果 已被 感染 过 则 跳出 继续 执行 host 程序 否则 继续 获得 directory 数据 目录 的 个数 每个 数据 目录 信息 占个 字节 得到 节 表 起始 位置 directory 的 偏移 地址 数据 目录 占用 的 字节 数节 表 起始 位置 得到 目前 最 后节 表 的 末尾 偏移 紧接 其后 用于 写入 一个 新 的 病毒 节节 表 起始 位置 节 的 个数 每个 节 表 占用 的 字节数 h 目前 最 后节 表 的 末尾 偏移 开始 写入 节 表 和 病毒 节 修正 文 件头 信息 四 捆绑 释放 型 捆绑 释放 型 感染 实现 起来 比较简单 目前 很大 一部 分病毒 程序 都 采用 这种 方法 捆绑 释放 型 感染 时 将 目标 host 程序 作为 数据 存储 在 病毒 体内 当 执行 病毒 程 序时 它 先 执行 病毒 程序 然后 还原 并 执行 host 文件 从而 保证 被 感染 的 程序 本身 能 正常 运行 不会 引起 一些 异样 熊猫 烧香 病毒 左边 是 一个 正常 程序 qq 感染 之后 会将 病毒 放在 前面 正常 程序 放在 后面 程序 运行 之后 病毒 会 拿到 控制权 但是 程序 图 标会 显示 前面 的 病毒 程序 显示 熊猫 烧香 这 也是 一个 明显 的 被 感染 特征 优点 编写 简单 效率高 可 感染 自 校验 程序 缺点 被 感染 后 的 程序 主体 是 病毒 程序 易 被 发现 程序 叠加 释放 执行 程序 图标 问题 五 系统 感染 型 系统 感染 型 本身 不对 pe 文件 做 任何 感染 操作 但它 感染 的 目标 是 操作系统 也是 一种 寄生 类 的 方式 只是 寄生 目标 有所不同 这类 病毒 通常 为 独立 个体 不 感染 系统 内 的 其他 文件 两个 关键问题 如何 再次 获得 控制权 自启动 由于 该 程序 不 感染 pe 文件 它 没有 host 文件 所以 如何 再次 获得 控制权 是 一个 关键 性问题 也是 目标 很多 病毒 程序设计 时 不得不 考虑 的 问题 此时 和 操作系统 自启动 相关 病毒 必须 依赖于 该 机制 再次 获得 控制权 如何 传播 可 移动 存储 介质 u盘 移动硬盘 刻录 光盘 等 网络共享 电子邮件 或 其他 应用 控制权 再次 获取 下面 简单 讲解 控制权 再次 获取 的 自启动 方式 首先 看看 操作 系统启动 流程 biosgt 硬盘 mbrgt 活动 分区 dbrgt 系统 内部 整个 启动 流程 也是 控制权 传递 的 过程 包括 现在 提出 的 可信计算 也是 对 控制权 一步 一步 的 校验 控制 流程 的 数据 完整性 或 行为 的 校验 对于 操作系统 本身 它 的 启动 方式 很多 系统 内部 包括 注册表 中 的 键值 系统 中 的 特定 位置 配置文件 特定 路径 的 特定 文件 如 explorerexe 显示桌面 下图 展示 了 autoruns 软件 看到 windows 操作系统 进行 自启动 的 选项 如果 病毒 本身 能 很好 地 结合 这套 机制 它 可以 做的 事情 非常 多 并且 具有 很好 的 隐蔽性 其他 启动 方式 利用 系统 自动播放 机制 autoruninf 比如 u盘 病毒 或 光盘 病毒 就是 利用 u盘 或 光盘 的 自动播放 功能 目前 也有 一些 u盘 插入 之后 不需 要你 去 双击 这个 u 盘里 面的 程序 就会 自启动 在其 他 可执行文件 嵌入 少量 触发 代码 修改 引入 函 数节 启动 dll 病毒 文件 添加 相应 结构 初始化 代码 触 发在 特定 pe 文件 代码 段 插入 触发 代码 等 只需 定位 可执行 程序 并 运行 dll 劫持 替换 已有 dll 文件 很多 应用程序 或 操作系统 执 行时 都 会去 执行 dll 文件 如果 病毒 将 自身 做成 一个 dll 文件 同时 将 系统 dll 文件 替换 可想而知 系统 启动时 它是 根据 文件名 启动 的 此时 病毒 dll 文件 就会 拿到 控制权 如果 拿到 控制权 之后 再进 一步 装载 原始 dll 文件 这样 系统 的 本身 机制 也 不会 受到影响 隐蔽性 更强 该 方法 非常 常见 甚至有 一些 病毒 程序 将 反病毒软件 可 依赖 的 dll 文件 替换 病毒 的 传播 方式 一切 可对 外 交互 的 渠道 都可 传播 包括 各类 存储 设备 软盘 光盘 u盘 移动硬盘 智能 设备 各类 网络通信 方式 qqmsnemail 淘宝 旺旺 微 信 微 博 等 各类 网络连接 方式 有线 wifi 蓝牙 等 各类 网络 应用 迅雷 bt 等 邮件 蠕虫 越来越 常见 其中 以 邮件附件 的 形式 进行 传播 较多 附件 中 可能 包含 病毒 包括 exe 文件 rar 文件 pdf 文件 doc 文件 xls 文件 jpg 文件 chm 文件 等 下图 是 一个 包含 病毒 的 邮件附件 显示 为 一个 word 文档 后缀名 doc 图标 显示 也是 word 但它 的 真实 后缀 是 scr 屏保 它 其实是 利 用了 一种 技术 在 文件名 里 插入 翻转 字符 然后 将 翻转 字符 之后 的 其他 字符 进行了 翻转 它 的 完整 文件名 应该是 月 tw 行 lmcodscr 这 也是 一种 欺骗性 很强 的 攻击 手法 再 补充 一个 通过 可 移动 存储 设备 传播 的 非 感染 式 病毒 即 autoruninf 右 图 显示 了 autoruninf 文件 如果 文件 存在 u盘 根目录 当 我们 双击 这个 u盘 时 它 就会 触发 对应 的 病毒 如果 选择 u盘 盘符 右键 打开 或 打开 资源管理器 这 这是 进入 的 也是 病毒 程序 当然 下面 的 演示 是 计算器 程序 打开 ampo 资源管理器 ampx 还有 一类 是 伪装 的 文件夹 如 下图 所示 photoexe 文件 当 windows 操作系统 默认 不 显示 exe 时 它 就能 伪装成 文件夹 当 我们 双击 之后 就会 运行 病毒 同时 可以 打开 某个 文件夹 进行 隐蔽 最后 补充 摆渡 知识点 这种 攻击行为 经常 发 生在 一些 具有 特殊 目的 病毒 程序 身上 期望 通过 可 移动 的 媒介 来 渗透 一些 平时 不 联网 的 电 脑中 并 从中 获取 数据 利用 摆渡 的 方式 植入 病毒 或 木马 到 内网 比较 典型 的 案例 就是 stuxnet 下图 展示 了 stuxnet 震 网 事件 的 漏洞 利用 过程 和 启动 方式 传统 的 autorun 方式 很 容易 被 禁止 掉 而 stuxnet 利用 的 是 lnk 漏洞 ms 它 会在 目标 u盘 下 放入 lnk 快捷方式 及 病毒 程序 如 dll 文件 不管 通过 什么 方式 进入 u盘 lnk 文件 会被 解析 从而 触发 漏洞 导致 u盘 中 的 病毒 程序 被执行 六 总结 写到 这里 这篇 文章 就 介绍 完毕 通过 这些 pe 病毒 原理 分类 及 感染 方式 的 讲解 有利于 大家 去做 一些 拓展 和 思考 也 体现出 当下 的 网络 形式 存在 很多 安全隐患 安全 防御 是 非常 必要 的 pe 病毒 概念 pe 病毒 的 分类 传统 文件 感染 型 感染 思路 pe 病毒 典型 案例 关键技术 捆绑 释放 型 系统 感染 型 控制权 再次 获取 病毒 的 传播 方式 学 安全 一年 认识了 很多 安全 大佬 和 朋友 希望 大家 一起 进步 这篇 文章 中 如果 存在 一些 不足 还请 海涵 作者 作为 网络安全 和 系统安全 初学者 的 慢慢 成长 路 吧 希望 未来 能 更 透彻 撰写 相关 文章 同时 非常感谢 参考文献 中 的 安全 大佬 们 的 文章 分享 感谢 师傅 实验室 小伙伴 的 教导 深知 自己 很菜 得 努力 前行 编程 没有 捷径 逆向 也没有 捷径 它们 都是 搬 砖 活 少 琢磨 技 巧干 就 对了 什么时候 你 把 攻击 对手 按在 地上 摩擦 你 就 赢了 也 会 慢慢 形 成了 自己 的 安全 经验 和 技巧 加油 吧 少年 希望 这个 路线 对 你 有所 帮助 共勉 欢迎 大家 讨论 是否 觉得 这 系列 文章 帮助 到 您 如果 存在 不足之处 还请 海涵 任何 建议 都可以 评论 告知 读者 共勉 逆向 分析 网络安全 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 星期 一夜 于 贵阳 参考文献 武大 软件 安全 课程 mooc 软件 安全 之 恶意代码 机理 与 防护 pe 文件 格式 分析 erio 第二章 pe 文件 结构 解析 百度 文库 