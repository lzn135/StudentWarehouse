面试 必 问 的 分布式 锁 你 懂 了吗 微 信 搜索 程序员 囧 辉 关注 这个 坚持 分享 技术 干货 的 程序员 我 的 最新 文章 全网 最 硬核 redis 大厂 面试题 解析 年 最新版 前言 分布式 锁 无论是 在 实际 应用 还是 面试 中 都是 经 常会 遇到 的 因此 很有 必要 掌握 这个 知识点 今天 跟 大家 一起 探讨 下 当前 主流 的 几种 实现 方案 及其 优缺点 正文 为什么 需要 锁 原因 其实 很简单 因为 我们 想 让 同一 时刻 只有 一个 线程 在 执行 某 段 代码 因为 如果 同时 出现 多个 线程 去 执行 可能会 带来 我们 不 想要 的 结果 可能是 数据 错误 也 可能是 服务 宕机 等等 以 淘宝 双 为 例 在 点 这一刻 如果有 几 十万 甚至 上 百万 的人 同时 去 查看 某个 商品 的 详情 这时候 会 触发 商品 的 查询 如果 我们 不做 控制 全部 走到 数据库 去 那是 有 可能 直接 将 数据库 打垮 的 这个 时候 一个 比较 常用 的 做法 就是 进行 加锁 只 让 个 线程 去 查询 其他 线程 待 等待 这个 线程 的 查询 结果 后 直接 拿 结果 在这 个 例子 中 锁 用于 控制 访问 数据库 的 流量 最终 起 到了 保护 系统 的 作用 再 举个 例子 某 平台 做 活动 秒杀 茅台 假如 活动 只 秒杀 瓶 但是 同时 有 万 人在 同一 时刻 去 抢 如果 底层 不做 控制 有 个人 抢 到了 额外 的 瓶 平台 就要 自己 想办法 解决 了 此时 我们 可以 在 底层 通过 加锁 或者 隐 式 加锁 的 方式 来 解决 这个 问题 此外 锁 也 经常 用来 解决 并 发下 的 数据 安全 方面 的 问题 这里 就不 一一 举例 了 为什么 需要 分布式 锁 分布式 锁 是 锁 的 一种 通常 用来 跟 jvm 锁 做 区别 jvm 锁 就是 我们 常说 的 锁 只能 作用于 单个 jvm 可以 简单 理解为 就是 单 台 服务器 容器 而 对于 多台 服务器 之间 jvm 锁 则 没法 解决 这时候 就需要 引入 分布式 锁 实现 分布式 锁 的 方式 实现 分布式 锁 的 方式 其实 很多 只 要能 保证 对于 抢夺 锁 的 系统 来说 这个 东西 是 唯一 的 那么 就能 用于 实现 分布式 锁 举个 简单 的 例子 有 一个 mysql 数据库 orderorder 库里 有 个 lock 表 只有 一条 记录 该 记录 有 个 状态 字段 lockstatus 默 认为 表示 空闲 状态 可以 修 改为 表示 成功 获取 锁 我们 的 订单 系统 部署 在台 服务器 上 这台 服务器 可以 在 同一 时刻 对 上述 的 这条 记录 执行 修改 修改 内容 都是 从 修 改为 但是 mysql 会 保证 最终 只会 有 个 线程 修改 成功 因此 这条 记录 其实 就可以 用于 做 分布式 锁 常见 实现 分布式 锁 的 方式 有 数据库 rediszookeeper 这 其中 又以 redis 最为 常见 redis 实现 分布式 锁 加锁 加锁 通常 使用 set 命令 来 实现 伪 代码 如下 几个 参数 的 意义 如下 keyvalue 键值 对 pxmilliseconds 设置 键 的 过期 时间 为 milliseconds 毫秒 nx 只 在 键 不存在 时 才 对 键 进行 设置 操作 setkeyvaluenx 效果 等同于 参数 则是 用于 解决 没有 解锁 导致 的 死锁 问题 因为 如果 没有 过期 时间 万一 程序员 写 的 代码 有 bug 导致 没有 解锁 操作 则 就 出现 了 死锁 因此 该 参数 起 到了 一个 兜底 的 作用 nx 参数 用于 保证 在 多个 线程 并发 set 下 只会 有 个 线程 成功 起 到了 锁 的 唯一性 解锁 解锁 需要 两步 操作 查询 当前 锁 是否 还是 我们 持有 因为 存在 过期 时间 所以 可能 等 你想 解锁 的 时候 锁 已经 到期 然后 被 其他 线程 获 取了 所以 我们 在 解锁 前 需要 先 判断 自己 是否 还 持有 锁 如果 锁 还是 我们 持有 则 执行 解锁 操作 也 就是 删除 该 键值 对 并 返回 成功 否则 直接 返回 失败 由于 当前 redis 还没有 原子 命令 直接 支持 这 两步 操作 所以 当前 通常是 使用 lua 脚 本来 执行 解锁 操作 redis 会 保证 脚 本里 的 内容 执行 是 一个 原子 操作 脚本 代码 如下 逻辑 比较简单 ifrediscall getkeys delkeys elsereturnend 两个 参数 的 意义 如下 keys 我们 要 解锁 的 keyargv 我们 加锁 时 的 value 用于 判断 当 锁 是否 还是 我们 持有 如果 被 其他 线程 持有 了 value 就会 发生变化 上述 方法 是 redis 当前 实现 分布式 锁 的 主流 方法 可能 会有 一 些小 优 区别 但是 核心 都是 这个 思路 看着 好像 没啥 毛病 但是 真的 是 这个 样子 吗 让我们 继续 往下 看 redis 分布式 锁 过期 了 还没 处 理完 怎么办 为了 防止 死锁 我们 会给 分布式 锁 加 一个 过期 时间 但是 万一 这个 时间 到了 我们 业务 逻辑 还没 处 理完 怎么办 首先 我们 在 设置 过期 时间 时 要 结合 业务 场景 去 考虑 尽量 设置 一个 比较 合理 的 值 就是 理论上 正常 处理 的话 在 这个 过期 时间内 是 一 定能 处理完毕 的 之后 我们 再来 考虑 对 这个 问题 进行 兜底 设计 关于 这个 问题 目前 常见 的 解决方法 有 两种 守护 线程 续 命 额外 起 一个 线程 定期 检查 线程 是否 还 持有 锁 如果有 则 延长 过期 时间 redisson 里面 就 实现 了 这个 方案 使用 看门狗 定期 检查 每 的 锁 时间 检查 次 如果 线程 还 持有 锁 则 刷新 过期 时间 超时 回 滚 当 我们 解锁 时 发现 锁 已经 被 其他 线程 获 取了 说明 此时 我们 执行 的 操作 已经是 不安全 的 了 此时 需要 进行 回 滚 并 返回 失败 同时 需要 进行 告警 人为 介入 验证 数据 的 正确性 然后 找出 超时 原因 是否 需 要对 超时 时间 进行 优化 等等 守护 线程 续 命 的 方案 有 什么问题 吗 redisson 使用 看门狗 守护 线程 续 命 的 方案 在 大多数 场景 下 是 挺不错 的 也 被 广泛 应用于 生产 环境 但是在 极端 情况下 还是 会 存在 问题 问题 例子 如下 线程 首先 获取 锁 成功 将 键值 对 写入 redis 的 master 节 点在 redis 将该 键值 对 同步 到 slave 节点 之前 master 发 生了 故障 redis 触发 故障 转移 其中 一个 slave 升级 为 新 的 master 此 时新 的 master 并不 包含 线程 写入 的 键值 对 因此 线程 尝试 获取 锁 也 可以 成功 拿到 锁 此时 相当于 有 两个 线程 获取 到了 锁 可能会 导致 各种 预期 之外 的 情况 发生 例如 最常 见 的 脏 数据 解决方法 上述问题 的 根本原因 主 要是 由于 redis 异步 复制 带来 的 数据 不一致 问题 导致 的 因此 解决 的 方向 就是 保证 数据 的 一致 当前 比较 主流 的 解法 和 思路 有 两种 redis 作者 提出 的 实现 的 分布式 锁 接下来 介绍 下 这两种 方案 redlock 首先 该 方案 也是 基于 文章 开头 的 那个 方案 set 加锁 lua 脚本 解锁 进行 改良 的 所以 antirez 只 描述 了 差异 的 地方 大致 方案 如下 假设 我们 有 n 个 redis 主 节点 例如 n 这些 节点 是 完全 独立 的 我们 不 使用 复制 或 任何 其他 隐 式 协调系统 为了 取到 锁 客户端 应该 执行 以下 操作 获取 当前 时间 以 毫秒 为 单位 依次 尝试 从 个 实例 使用 相同 的 key 和 随机 值 例如 uuid 获取 锁 当 向 redis 请求 获取 锁 时 客户端 应该 设置 一个 超时 时间 这个 超时 时间 应该 小于 锁 的 失效 时间 例如 你 的 锁 自动 失效 时间 为 秒 则 超时 时间 应该在 毫秒 之间 这样 可以 防止 客户端 在 试图 与 一个 宕机 的 redis 节点 对话 时长 时间 处于 阻塞状态 如果 一个 实例 不可用 客户端 应该 尽快 尝试 去 另外 一个 redis 实例 请求 获取 锁 客户端 通过 当前 时间 减去 步骤 记录 的 时间 来 计算 获取 锁 使用 的 时间 当 且 仅 当 从 大多数 n 这里是 个 节点 的 redis 节点 都 取到 锁 并且 获取 锁 使用 的 时间 小于 锁 失效 时间 时 锁 才 算 获取 成功 如果 取 到了 锁 其 真正 有效 时间 等于 初始 有效 时间 减去 获取 锁 所 使用 的 时间 步骤 计算 的 结果 如果 由于 某些 原因 未能 获得 锁 无法 在 至少 n 个 redis 实例 获取 锁 或 获取 锁 的 时间 超 过了 有效 时间 客户端 应该 在所 有的 redis 实例 上 进行 解锁 即便 某些 redis 实例 根 本就 没有 加锁 成功 防止 某些 节点 获 取到 锁 但是 客户端 没有 得到 响应 而 导致 接下来 的 一段时间 不能 被 重新 获取 锁 可以 看出 该 方案 为了 解决 数据 不一致 的 问题 直接 舍弃 了 异步 复制 只 使用 master 节点 同时 由于 舍弃 了 slave 为了 保证 可用性 引 入了 n 个 节点 官方 建议 是 该 方案 看着 挺 美好 的 但是 实际上 我 所 了解 到 的 在 实际 生产上 应用 的 不多 主要有 两个 原因 该 方案 的 成本 似乎 有点 高 需要 使用 个 实例 该 方案 一样 存在 问题 该 方案 主要 存 以下 问题 严重 依赖 系统 时钟 如果 线程 从 个 实例 获取 到了 锁 但是 这个 实例 中 的 某个 实例 的 系统 时间 走 的 稍微 快一点 则 它 持有 的 锁 会 提前 过期 被 释放 当 他 释放 后 此时 又有 个 实例 是 空闲 的 则 线程 也 可以 获 取到 锁 则 可能 出现 两个 线程 同时 持有 锁 了 如果 线程 从 个 实例 获取 到了 锁 但是 万一 其中有 台 重启 了 则 此时 又有 个 实例 是 空闲 的 则 线程 也 可以 获 取到 锁 此时 又 出现 两个 线程 同时 持有 锁 了 针对 以上 问题 其实 后续 也 有人 给出 一些 相应 的 解法 但是 整体 上 来看 还是 不够 完美 所以 目前 实际 应用 得 不是 那么多 zookeeper 实现 分布式 锁 zookeeper 的 分布式 锁 实现 方案 如下 创建 一个 锁 目录 locks 该 节点 为 持久 节点 想要 获取 锁 的 线程 都在 锁 目 录下 创建 一个 临时 顺序 节点 获取 锁 目 录下 所有 子 节点 对子 节 点按 节点 自 增 序号 从小到大 排序 判断 本 节点 是不是 第一 个子 节点 如果是 则 成功 获取 锁 开始 执行 业务 逻辑 操作 如果 不是 则 监听 自己 的 上一个 节点 的 删除 事件 持有 锁 的 线程 释放 锁 只需 删除 当前 节点 即 可当 自己 监听 的 节点 被 删除 时 监听 事件 触发 则 回到 第 步 重新 进行 判断 直到 获 取到 锁 由于 zookeeper 保证 了 数据 的 强 一致性 因此 不会 存在 之前 redis 方案 中 的 问题 整体 上 来看 还是 比较 不错 的 zookeeper 方案 的 主要 问题在于 性能 不如 redis 那么 好当 申请 锁 和 释放 锁 的 频率 较高 时 会对 集群 造成 压力 此时 集群 的 稳定性 可用 性能 可能 又会 遭受 挑战 分布式 锁 的 选型 当前 主流 的 方案 有 两种 redis 的 set 加锁 lua 脚本 解锁 方案 至于 是不是 用 守护 线程 续 命 可以 结合 自己 的 场景 去 决定 个人 建议 还是 可以 使用 的 zookeeper 方案 通常情况下 对于 数据 的 安全 性要求 没 那么 高 的 可以 采用 redis 的 方案 对 数据 安全 性要求 比 较高 的 可以 采用 zookeeper 的 方案 最后 当你 的 才华 还 撑 不 起 你 的 野心 的 时候 你 就应该 静下心来 学习 愿 你 在 我 这里能 有所 收获 原创 不易 如果 你 觉得 本文 写 的 还 不错 对 你 有 帮助 请 通过 点 赞 让 我 知道 支持 我 写出 更好 的 文章 推荐 阅读 两年 java 开发 工作经验 面试 总结 年 java 经验 阿里 网易 拼 多多 面试 总结 心得体会 年 java 经验 字节 美 团 快手 核心 部门 面试 总结 真 题 解析 天 咸鱼 到 阿里 的 修仙 之路 复习 个月 拿下 美 团 offer 我 都 做了 些 啥 如何写 一份 让 hr 眼前一亮 的 简历 附 模板 面试 阿里 hashmap 这一 篇 就 够了 面试 必 问 的 mysql 你 懂 了吗 面试 必 问 的 线程 池 你 懂 了吗 跳槽 如何 选择 一家 公司 如何 准备好 一场 大厂 面试 mysqlmvcc 核心 原理 解析 核心 源码 