python 黑 帽 一 获取 windows 主机 信息 注册表 u盘 历史 痕迹 和 回收站 文件 最近 开始 学习 网络安全 和 系统安全 接触 到了 很多 新 术语 新方法 和 新 工具 作为 一名 初学者 感觉 安全 领域 涉及 的 知识 好 广 好 杂 但 同时 也 非常 有意思 这 系列 文章 是 作者 学习 安全 过程中 的 总结 和 探索 我们 一起 去 躺过 那些 坑 跨过 那些 洞 守住 那些 站 真心 希望 文章 对 您 有所 帮助 感谢您 的 阅读 和 关注 python 黑 帽 第一 篇文章 将 分享 获取 windows 主机 信息 利用 注册表 获取 主机名 及 usb 历史 痕迹 回收站 文件 等 这些 知识 广泛 应用于 电子 取证 web 渗透 和 攻击 溯源 领域 其中 usb 获取 是 亮点 希望 这篇 基础 文章 对 您 有所 帮助 更 希望 大家 提高 安全意识 学会 相关 防范 也 欢迎 大家 讨论 娜 璋 ai 安全 之家 于 年月日 开通 将 专注 于 python 和 安全 技术 主要 分享 web 渗透 系统安全 cve 复现 威胁 情报分析 人工智能 大数 据分析 恶意代码 检测 等 文章 真心 想把 自己 近十年 的 所学 所做 所 感 分享 出来 与 大家 一起 进步 声明 本人 坚决 反对 利用 教学方法 进行 恶意 攻击 的 行为 一切 错误 的 行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 技术 背后 的 原理 更好 地 进行 安全 防护 虽然 作者 是 一名 安全 小白 但会 保证 每 一篇 文章 都会 很 用 心地 撰写 希望 这些 基础性 文章 对 你 有所 帮助 在 安全 路上 一起 前行 文章 目录 一 获取 windows 主机 信息 二 获取 windows 注册表 信息 注册表 基本 结构 注册表 基本 操作 获取 用户 账户 信息 三 获取 回收站 内容 四 获取 u盘 痕迹 五 总结 一 获取 windows 主机 信息 wmi 是 一项 核心 的 windows 管理 技术 wmi 模块 可 用于 获取 windows 内部 信息 wmi 作为 一种 规范 和 基础 结构 通过 它 可以 访问 配置管理 和 监视 几乎 所有 的 windows 资源 比如 用户 可以 在 远程 计算 机器 上 启动 一个 进程 设定 一个 在 特定 日期 和 时间 运行 的 进程 远程 启动 计算机 获得 本地 或 远程 计算机 的 已 安装 程序 列表 查询 本地 或 远程 计算机 的 windows 事件 日志 等等 本文 使用 python 获取 windows 系统 上 相关 的 信息 可以 使用 wmi 接口 安装 调用 pip 工具 即可 下面 的 代码 是 获取 windows 主机 相关 信息 获取 电脑 使用者 信息 print cs print 电脑 名称 scscaption print 使用者 scsusername print 制造商 scsmanufacturer print 系统 信息 scssystemfamily print 工作组 scsworkgroup print 机器 型号 scsmodel print 获取 操作系统 信息 print os print 操作系统 soscaption print 语言 版本 sosmuilanguages print 系统 位数 print 注册 人 print 系统 驱动 sossystemdevice print 系统 目录 print 获取 电脑 ip 和 mac 信息 print address print ip 地址 print mac 地址 print 网络 描述 print 获取 电脑 cpu 信息 print processor print cpu 型号 print cpu 核 数 print 获取 bios 信息 print bios print 使用 日期 print 主板 型号 print 当前 语言 print 获取 内存 信息 totalmemsizeint print 内存 厂商 print 内存 型号 print 内存大小 fgb totalmemsize print 获取 磁盘 信息 disksizeint disksize print 磁盘 名称 sdiskcaption print 硬盘 型号 sdiskmodel print 磁盘 大小 fgb disksize 获取 显卡 信息 print 显卡 名称 sxkname print 获取 计算机 名称 和 hostname print 计算机 名称 shostname print ip 地址 sip 输出 结果 如 下图 所示 二 获取 windows 注册表 信息 注册表 基本 结构 注册表 registry 是 windows 系统 中一 个 重要 的 数据库 它 用于 存储 有关 应用程序 用户 和 系统 信息 注册表 的 结构 就像 一颗 树 树 的 顶级 节点 hive 不能 添加 修改 和 删除 如 下图 所示 是 windows 注册表 的 顶级 节 点在 c 中 对 注册表 进行 操作 需要 引用 命名 空间 类 表示 注册表 中 的 顶级 结点 此类 是 注册表 的 封装 registry 类 提供 表示 windows 注册表 中 的 根 项 registrykey 对象 并 提供 访问 项 值 的 static 方法 常用 的 registry 对象 的 顶级 节点 蜂窝 hive 的 属性 如 下表 所示 注册表 中 常用 的 数据类型 有 regsz 字符串 数据 的 主要 类型 用于 存储 固定 长度 的 字符串 或 其他 短 文本 值 我们 在 实际 程序 中 常用 这种 数据类型 如果 要 保存 布尔值 时 将它 表示 成 或 regbinary 用于 存储 二进制 数据 regexpandsz 可 扩展 的 字符串 值 可以 保存 在运 行时 才 解析 的 系统 变量 regmultisz 以 数组 的 格式 保存 多个 文本 字符串 每个 字符串 元素 都以 null 字符 结束 注册表 基本 操作 python 注册表 操作 主要 调用 winreg 扩展 包 官方 文档 如下 基本 操作 函数 如下 创建 操作 computernamekey 与 计算机 的 预 定义 注册表 句柄 建立 连接 winregcreatekey keysubkey 创建 或 打开 指定 的 键 例 如在 hkeycurrentuser 下 创建 键 eastmount 其中 我们 最 常用 的 是 在 software 这个 键 下 创建 程序 产品 键 保存 一些 程序 的 配置 在 注册表 中 如果 software 中 没有 eastmount 键 则会 先 创建 这个 键 及其 子键 如果 存在 就不会 重写 创建 键 wgcreatekey wgclosekey keytest 运行 结果 如下 检索 键值 操作 key 以 元组 形式 返回 键 的 信息 keysubkey 以 字符串 形式 检索 键 的 未命名 值 keyvaluename 检索 与 打开 注册 表项 关联 的 指定 值 名称 的 类型 和 数据 在 eastmount 下面 新建 一个 值 yxz 内容 为 hellona 然后 编写 代码 读取 相关 的 内容 获取 键值 数据项 值 keytestyxz print value print type 输出 结果 如 下图 所示 创建 键值 操作 winregsetvalue 将 值 与 指定 的 键 关联 将 数据 存储 在 打开 的 注册 表项 value 字段 中 创建 键值 代码 如下 但会 提示 拒绝 访问 错误 创建 键值 数据项 print keytest 拒绝 访问 wgsetvalueex wgclosekey keytest 删除 键值 操作 winregdeletekey keysubkey 删除 指定 的 键 keyvalue 从 注册 表项 中 删除 值 删除 键值 数据项 wgdeletevalue keytestyxz wgclosekey keytest 成功 删除 键值 如 下图 所示 其他 操作 winregenumkey keyindex 枚举 打开 注册表 的 键 winregenumvalue keyindex 枚举 打开 注册 表项 的 值 winregopenkey 打开 指定 键 winregflushkey key 刷新 注册表 winregloadkey 在 指定 键 下 创建 一个 子键 并将 注册 信息 从 指定 文件 存储 到 该 子键 中 获取 用户 账户 信息 获取 用户 名称 的 代码 如下 连接 注册表 根键 以 为 例 获取 指定 目 录下 所有 键 的 控制 regrootsubdir 获取 该 目 录下 所有 键 的 个数 下属 键 个数 当前 键值 个数 keyhandle foriinrange count 穷举 键 获取 键名 keyhandlei subdirrss 根据 获取 的 键名 拼接 之前 的 路径 作为 参数 获取 当前 键 下 所属 键 的 控制 regrootsubdir numqueryinfokey keyhandle forjinrange num keyhandlej if print value 读写 操作 结束 后 关闭 键 closekey keyhandle closekey keyhandle closekey regroot 执行 结果 如下 我们 可以 通过 读取 含有 users 字段 的 数据 从而 间接 获取 用户 账户 信息 cusersxiuzhang 三 获取 回收站 内容 为什么 我们 要去 获取 回收站 文件 呢 因为 很多 情况下 调查取证 需要 获取 远程目标 的 历史 痕迹 回收站 是 重要 的 一个 目标 在 windows 操作系统 中 回收站 是 一个 专门 用来 存放 被 删除 文件 的 特色 文件 夹在 使用 fat 文件 系统 的 windows 系统 中 回收站 目录 通常是 crecycled 在 在内 支持 的 ntfs 操作系统 中 crecycler 在 windowsvista 和 windows 中 回收站 目录 是 crecyclebin 如 下图 所示 回收站 中 包含 两个 文件 分别 位于 桌面 和 d 盘 目录 第一步 检测 回收站 目录 是否 存在 定义 回收站 目录 recycledir 调用 函数 resreturndir print res 操作系统 输出 结果 如 下图 所示 第二步 找到 回收站 之后 检测 其中 的 内容 如 下图 所示 字符串 sid 与 用户 账 户名 是 对应 的 比如 结尾 的 sid 第三步 编写 代码 获取 回收站 文件夹 所在 目录 importos 判断 回收站 目录 是否 存在 defreturndir recycledir 获取 回收站 内容 deffindrecycle recycledir recycledir sid filesoslistdir recycledirsid print filesn 主 函数 defmain resreturndir print res res ifnamemainmain 输出 结果 如 下图 所示 第四步 用 python 将 用户 的 sid 关联 起来 使用 windows 注册表 将 sid 转 化为 一个 准确 的 用户名 通过 检查 windows 注册表 键值 编写 一个 函 数来 将 每一个 sid 转 化为 用户名 这个 函数 将 打开 注册 便 检查 键值 找到 其 值 并从 中找到 用户名 如 下图 所示 用户 名为 xiuzhang 第五步 获取 回收站 所有 内容 完整 代码 判断 回收站 目录 是否 存在 defreturndir recycledir 通过 sid 获取 用户名 信息 defsiduser sid 获取 该 目 录下 所有 键 的 个数 下属 键 个数 当前 键值 个数 key forjinrange count 系统 找不到 指定 的 文件 valuetype keyj if uservaluesplit print user 获取 回收站 内容 deffindrecycle recycledir recycledir sid filesoslistdir recycledirsid print files usersiduser sid print user foundfilestr file print 主 函数 defmain resreturndir print res res ifnamemainmain 输出 结果 如 下图 所示 对应 的 回收站 内容 如下 但 非常 可惜 获取 的 值 无法 对应 why 后续 作者 会 继续 深入 挖掘 如果 我们 想把 文件 删除 到 回收站 又 怎么 解决 呢 python 删除 文件 一般 使用 osremove 但 这样 是 直接 删除 文件 不删 到 回收站 的 那么 想 删除 文件 到 回收站 怎么办 安装 pypiwin 扩展 包含 winapi 调用 shfileoperation 函数 实现 删除 文件 至 回收 站在 windows 的 shellapi 文件 中 定义 了 一个 名为 shfileoperation 的 外壳 函数 用它 可以 实现 各种 文件 操作 如 文件 的 拷贝 删除 移动 等 该 函数 使用 起来 非常 简单 它 只有 一个 指向 shfileopstruct 结构 的 参数 filename 直接 删除 文件 不 经过 回收站 osremove filename ifnotdebug 删除 文件 到 回收站 print res delfilename filename 最终 效果 如 下图 所示 可以 看到 requirerb 文件 被 成功 删除 可能会 遇到 拒绝 访问 问题 我们 需要 设置 pythonexe 用户名 完全 控制 并且 用 管理员 方式 打开 即可 解决 四 获取 u盘 痕迹 在 windows 系统 中 当 一个 usb 移动 存储 设备 插 入时 就 会在 注册表 中 留下 痕迹 当 移动 设备 插入 计算 机时 即插即用 管理器 pnp plugandplay 接受 该 事件 并且在 usb 设备 的 固件 中 查询 有关 该 设备 的 描述 信息 厂商 型号 序列号 等 当 设备 被 识 别后 在 注册表 中 创建 一个 新 的 键值 在 这个 键值 下 会 看到 类似 下面 的 结构 子键 该 子键 代表 设备 类 标示 符 用来 标识 设备 的 一个 特定 类 其中 子键 中 代表 区域 由 pnp 管理器 依据 在 usb 设备 描述符 中 获取 的 数据 填写 如 下图 所示 是 是 uid 注意 需要 判断 service 值 为 disk 即为 磁盘 的 子项 光盘 为 cdrom 如果 使用 uvcview 工具 可以 看见 usb 设备描述 内容 其中 的 信息 都是 相互 对应 的 设备 类 id 一旦 建立 就需要 建立 一个 特定 唯一 的 uid 它 可以 把 具有 同一 设备 类 标识 的 多个 存储 设备 区分 完整 实现 代码 如下 连接 注册表 根键 以 为 例 检索 子项 获取 指定 目 录下 所有 键 的 控制 regrootsubdir 获取 该 目 录下 所有 键 的 个数 下属 键 个数 当前 键值 个数 keyhandle print count 穷举 usbstor 键 获取 键名 foriinrange count keyhandlei subdirrss print subdir 根据 获取 的 键名 拼接 之前 的 路径 作为 参数 获取 当前 键 下 所属 键 的 控制 regrootsubdir numqueryinfokey keyhandle 遍历 子键 内容 forjinrange num keyhandlej print subkeyname resultpathrss 获取 具体 键值 内容 并 判断 service 为 keyhandle forkinrange numkey 获取 usb 名称 keyhandlek if serviceinname and diskinvalue usb print uid print path print 关闭 键值 closekey keyhandle closekey regroot 输出 的 usb 记录 键名 如 下图 所示 其中 对应 的 注册表 信息 如 下图 所示 friendlyname 即是 输出 的 usb 名称 序 号为 cfeeafamp 搜索 的 service 服务 为 disk 磁盘 的 选项 简单 总结 个人感觉 这方 面的 资料 真心 很少 文章 博客 也 少 所以 看起来 操作 似乎 很简单 但 真正 实现 起来 还是 令人深思 的 然后 就是 其实 存储 usb 记录 的 还有 很多 键值 如 该 键值 中 能 看到 厂 商号 vid 厂商 产品 号 pid 还有 端口号 porthub 等 该 键值 下有 两个 设备 类 可以 通过 他们 获取 usb 最后 接入 系统 时间 接下来 我 想要 完成 的 就是 如何 把 这些 键值 联系起来 似乎 要 通过 同时 怎样 获取 时间 怎样 正确 删除 这些 信息 都 值得 深究 五 总结 这篇 文章 真的 花 费了 一些 精力 希望 您 喜欢 同时 感觉 自己 要 学习 的 知识 好多 也有 好多 大神 卧虎藏龙 开源 分享 作为 初学者 我们 可能有 差距 不论 你 之前 是什么 方向 是什么 工作 是什么 学历 是 大学 大专 中专 亦 或是 高中 初中 只要 你 喜欢 安全 喜欢 渗透 就 朝着 这个 目标 去 努力 吧 有 差距 不 可怕 我们 需要 的 是 去 缩小差距 去 战斗 况且 这个 学习 的 历程 真的 很美 安全 真的 有意思 但 切勿 去做 坏事 我们 需要 的 是 白 帽子 是 维护 我们 的 网络安全 路上 共勉 最后 真诚地 感谢您 关注 娜 璋 之家 公众 号 也 希望 我 的 文章 能 陪伴 你 成长 希望 在 技术 路上 不断 前行 文章 如果 对 你 有 帮助 有 感悟 就是 对 我 最好 的 回报 且看 且 珍惜 再次 感谢您 的 关注 也 请 帮忙 宣 传下 娜 璋 之家 哈哈 初来乍到 还请 多多指教 独 在 异乡 为 异客 每逢佳节倍思亲 byeastmount 夜 于 武汉 参考文献 python 绝技 运用 python 成为 顶级 黑客 模块 获取 windows 内部 信息 的 用法 系统 应 用之 注册表 使用 详解 计算机 信息 获取 系统 的 研究 与 实现 论文 