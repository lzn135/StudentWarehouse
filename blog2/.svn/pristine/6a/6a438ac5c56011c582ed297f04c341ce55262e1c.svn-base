系统安全 九 windows 漏洞 利 用之 ms08-067 远程 代码 执行 漏洞 复现 及 深度 提 权 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 系统安全 系列 作者 将 深入研究 恶意 样本 分析 逆向 分析 攻防 实 战和 windows 漏洞 利用 等 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 前文 介绍 了 windows 远程桌面 服务 漏洞 cve 该 高危 漏洞 利用 方式 是 通过 远程桌面 端口 rdp 协议 进行 攻击 这篇 文章 将 详细 讲解 ms 远程 代码 执行 漏洞 cve 它是 windowsserver 服务 rpc 请求 缓冲区 溢出 漏洞 利用 端口 并 通过 metasploit 工具 获取 shell 及 进行 深入 的 操作 希望 对 入门 的 同学 有 帮助 话 不 多说 让我们 开始 新 的 征程 吧 您 的 点 赞 评论 收藏 将是 对 我 最大 的 支持 感恩 安全 路上 一路 前行 如果有 写得 不好 的 地方 可以 联系 我 修改 基础性 文章 希望 对 您 有所 帮助 作者 的 目的 是 与 安 全人 共同进步 加油 也 强烈推荐 大家 去 看看 参考文献 的 视频 和 书籍 文章 目录 一 漏洞 描述 二 环境 搭建 环境 准备 端口 详解 三 利用 metasploit 复现 漏洞 四 常见 错误 及 漏洞 原因 分析 常见 错误 漏洞 成因 五 总结 作者 的 github 资源 系统安全 网络安全 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 破解 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 系统安全 八 windows 漏洞 利 用之 cve 复现 及 蓝屏 攻击 系统安全 九 windows 漏洞 利 用之 ms 远程 代码 执行 漏洞 复现 及 深度 提 权 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 一 漏洞 描述 ms 漏洞 全 称是 windowsserver 服务 rpc 请求 缓冲区 溢出 漏洞 攻击者 利用 受害者 主机 默认 开放 的 smb 服务 端口 发送 特殊 远程过程调用 请求 造成 栈 缓冲区 内存 错误 从而 被 利用 实施 远程 代码 执行 当 用户 在 受影响 的 系统 上 收到 rpc 请求 时 该 漏洞 会 允许 远程 执行 代码 攻击者 可以 在 未经 身份验证 情况下 利用 此 漏洞 运行 任意 代码 同时 该 漏洞 可以 用于 蠕虫 攻击 它 影 响了 某些 旧版本 的 windows 系统 包括 漏洞 原理 ms 漏洞 是 通过 msrpcoversmb 通道 调用 server 程序 中 的 函数 时 触发 的 函数 在 远程 访问 其他 主机 时会 调用 函数 对 远程 访问 的 路径 进行 规范化 而在 函数 中发 生了 栈 缓冲区 内存 错误 溢出 造成 可被 利用 实施 远程 代码 执行 后续 部分 我 将 分析 该 漏洞 的 cfg 流程图 及 漏洞 成因 本文 参考 了 很多 大佬 的 文章 再次 感谢 他们 实验 部分 是 结合 自己 的 实践 和 经验 讲解 如果 存在 错误 或 不足之处 也 请 批评 和 指正 二 环境 搭建 环境 准备 受害 机 windowsxpsp 镜像 攻击机 kali 系统 第一步 在 虚拟机 中 安装 windowsxpsp 系统 和 kali 系统 第二步 虚拟机 两个 系统 之间 能够 相互 通信 kaliwinxp 第三步 打开 windowsxp 系统 确定 端口 开启 如 下图 所示 在 winxp 的 cmd 中 输入 netstatsn 查看 端口 是否 打开 第四步 关闭 windowsxp 系统 的 防火墙 做完 这些 初始 准备 之后 我们 开始 利用 kali 系统 进行 漏洞 复现 端口 详解 这里 作者 补充 一些 端口 的 基础知识 更有 利于 我们 进行 web 渗透 实验 端口 作用 我们 知道 一台 拥有 ip 地址 的 主机 可以 提供 许多 服务 比如 web 服务 ftp 服务 smtp 服务 等 这些 服务 完全可以 通过 个 ip 地址 来 实现 那么 主机 是 怎么 区分 不同 的 网络服务 呢 显然 不能 只 靠 ip 地址 因为 ip 地址 与 网络服务 的 关系 是 一对 多 的 关系 实际上 是 通过 ip 地址 端口号 来 区分 不同 的 服务 的 需要 注意 的 是 端口 并不是 一一对应 的 比如 你 的 电脑 作为 客户机 访问 一台 www 服务器 时 www 服务器 使用 端口 与 你 的 电脑 通信 但 你 的 电脑 则可 能 使用 这样 的 端口 如 下图 所示 端口 的 分类 端口 共 号 知名 端口 范围 从到 这些 端口号 一般 固定 分配给 一些 服务 大家 尽量 不要 使用 比如 端口 分配给 ftp 服务端 号 分配给 smtp 邮件 传输 协议 服务 端口 分配给 http 服务 端口 分配给 rpc 远程过程调用 服务 等等 动态 端口 的 范围 从到 这些 端口号 一般 不 固定 分配给 某个 服务 也就是说 许多 服务 都可以 使用 这些 端口 只要 运行 的 程序 向 系统 提出 访问 网络 的 申请 那么 系统 就可以 从 这些 端口号 中 分配 一个 供 该 程序 使用 比如 端口 就是 分配给 第一个 向 系统 发出 申请 的 程序 在 关闭程序 进程 后 就会 释放 所 占用 的 端口号 注意 端口 冲突 就不能 正常 工作 同时 动态 端口号 也 常 常被 病毒 木马程序 所 利用 如 冰河 默认 连接 端口号 是 way 连接 端口号 是 netspy 连接 端口号 是 yai 病毒 连接 端口号 是 等等 常见 的 端口 端口号 含义 ftp 文件 传输 协议 代理服务器 常用 端口号 ssh 安全 登录 scp 文件 传输 端口 重定向 端口号 telnet 远程 登录 协议 代理服务器 常用 端口号 email 端口号 木马 antigenwinpc 等 开放 该 端口 dns 域名解析 服务 端口号 http 协议 代理服务器 常用 端口号 pop 邮局 协议 版本 使用 的 端口号 https 加密 的 超文本 传输 服务 端口号 通过 smb 服务器 信息 块 协议 访问 各种 共享 文件夹 或 共享 打印机 socks 代理 协议 服务器 常用 端口号 mssqlserver 数据库 默认 端口号 oracle 数据库 服务 端口号 msnmessenger 的 文件 传输 功能 所 使用 的 端口号 mysql 默认 端口号 microsoftrdp 微软 远程桌面 使用 的 端口号 远程 控制 数据传输 时 使用 的 端口号 主控 端 扫描 被控 端 时 使用 的 端口号 腾讯 qq 端口号 黑客 通过 端口 可以 干什么 信息 收集 目标 探测 服务 判断 系统 判断 角色 分析 端口 谢 公子 大佬 在 和 端口 文章 中 介绍 过 这些 端口 它们 都是 与 文件 共享 和 打印机 共享 有关 的 端口 而且 在这 几个 端 口上 经常 爆发 很严重 的 漏洞 比如 年 危害 全球 的 永恒 之 蓝 就是 利用 的 端口 本篇 文章 的 端口 就是 利用 协议 族 用于 文件 共享 打印 共享 的 服务 端口 是 一个 毁誉参半 的 端口 有 了 它 我们 可以 在 局域网 中 轻松 访问 各种 共享 文件夹 或 共享 打印机 但也 正是 因为 有 了 它 黑客 们 才有 了 可乘之机 他们 能 通过 该 端口 偷偷 共享 你 的 硬盘 甚至 会在 悄无声息 中将 你 的 硬盘 格式化 掉 总之 公开 服务器 打开 和 端口 是 一件 非常 危险 的 事情 如果有 guest 帐号 而且 没有 设置 任何 密码 时 就 能够 被人 通过 因特网 轻松 地 盗 看 文件 如果 给 该 帐号 设置 了 写入 权限 甚至 可以 轻松 地 篡改 文件 也就是说 在对 外部 公开 的 服务器 中 不应该 打开 这些 端口 通过 因特网 使用 文件 服务器 就 等同 自杀 行为 因此 一 定要 关闭 和 端口 对于 利用 adsl 永久性 接入 因特网 的 客户端 机器 可以说 也是 如此 三 利用 metasploit 复现 漏洞 攻击机 kali 受害 机 winxp 第一步 利用 nmap 工具 扫描 端口 及 确认 该 漏洞 是否 存在 漏 扫 脚本 目录 为 如 下图 所示 扫描 结果 为 vulnerable 表示 ms 漏洞 存在 且 可以 利用 或者 使用 nmapsvpn 查看 目标 主机 开放 的 端口 目标 机 开 放了 端口 且 目标 机 系统 为 windowsxp 作为 黑客 一看到 xp 或 系统 的 端口 开放 我们 就能 想到 轰动一时 的 msnmapsvpn 第二步 进入 msfconsole 并 利用 search 语句 查找 漏洞 利用 模块 终端 内 输入 msfconsole 打开 metasploite 命令行 客户端 使用 search 命令 查找 ms 的 漏洞 利用 模块 第三步 进入 漏洞 模块 并 查看 相关 的 使用说明 使用 use 命令 选择 我们 要 使用 的 利用 模块 target 设置 为 系统 默认 是 自动 定位 如果 需要 精确 定位 可以 showtargets 查看 所有 然后 进行 选择 第四步 设置 攻击机 受害 机 信息 目标 机 ipsetrhost 端口号 setrport 设置 攻击机 ipsetlhost 设置 自动 类型 settarget 显示 配置 信息 showoptions 第五步 运行 exploit 反弹 shell 此时 我们 成功 获 取了 windowsxp 系统 的 shell 我们 调用 ipconfig 查看 的 ip 地址 也是 目标 的 注意 windowsxpsp 系统 是 中文 而 不是 英文 的 需 要对 msnetapiserzhrb 处理 参考 ms 远程 执行 代码 漏洞 复现 feizianquan 第六步 在 目标 主 机上 创建 文件夹 及 文件 cd 创建 文件夹 mkdirhacker 访问 目录 dircdhacker 创建 文件 并 写入 内容 查看 目标 系统 的 基本信息 sysinfo 显示 结果 下图 所示 第七步 对 目标 xp 主机 进行 深度 提 权 增加 普通用户 提升 管理员 员 权限 用户 常用命令 如下 netuserabcdadd 新建 一个 用户 名为 abcd 密码 为 的 帐户 默 认为 user 组成员 netuserabcddel 将用 户 名为 abcd 的 用户 删除 将用 户 名为 abcd 的 用户 禁用 激活 用户 名为 abcd 的 用户 netuserabcd 查看 用户 名为 abcd 的 用户 的 情况 将 abcd 账户 给予 管理员 权限 此时 被 攻击 的 主机 新增 hacker 管理员 如 下图 所示 第八 步 开启 远程 连接 端口 并 进行 远程 操作 开启 远程 连接 查看 网络 端口 netstatan 远程 连接 rdesktop 首先 查看 端口 发现 目标 主机 windowsxp 并未 开启 端口 输入 命令 开启 远程 连接 端口 接着 输入 rdesktop 连接 远程 ip 地址 并 输入 我们 创 建好 的 hacker 用户名 及 密码 输入 创建 的 用户名 hacker 和 密码 回车 弹出 提示框 点击 ok 稍等 就会 成功 远程 登录 xp 系统 哇塞 是不是 很 惊讶 这 也是 本文 的 深度 提 权 知识 最后 我们 还需 要将 新建 的 用户名 hacker 删除 写到 这里 整个 实验 就 讲解 完毕 四 常见 错误 及 漏洞 原因 分析 常见 错误 我们 在 运行 exploit 执行 漏洞 利用 模块 时有 时会 有 相关 错误 比如 一直 提示 或 需要 注意 windowsxp 系统 关闭 防火墙 漏洞 不稳定 多 尝试 几次 有时 xp 系统 会 提示 错误 这是 svchostexe 错误 内存 溢出 造成 最终 作者 解决 了 xp 系统 无法 提 权 的 问 题在 调用 showpayloads 设置 攻击 载荷 时 当我 采用 就会 报错 最后 我 将 payload 修 改为 反弹 shell 失败 反弹 shell 成功 如果 仍然 失败 可能 需要 换 其他 xp 或 系统 进行 尝试 祝 好运 漏洞 成因 如果 想 了解 该 漏洞 的 原理 知识 推荐 以下 三 篇文章 后续 作者 也 需要 深入 去 分析 各种 漏洞 的 原代码 漏洞 是 通过 msrpcoversmb 通道 调用 server 服务 程序 中 的 函数 时 触发 的 而 函数 在 远程 访问 其他 主机 时会 调用 函数 对 远程 访问 的 路径 进行 规范化 而在 函数 中发 生了 栈 缓冲区 内存 错误 造成 可被 利用 实施 远程 代码 执行 所谓 路径 规范化 就是 将 路径 字符串 中 的 转 换为 同时 去除 相对路径 和 如 gtgt 在 路径 规范化 的 操作 中 服务 程序 对 路径 字符串 的 地址 空间 检查 存在 逻辑 漏洞 攻击者 通过 精心设计 输入 路径 可以 在 函数 去除 字符串 时 把 路径 字符串 中 内容 复制到 路径 串 之前 的 地址 空间 中低 地址 达到 覆盖 函数 返回 地址 执行 任意 代码 的 目的 这里 通过 idapro 打开 找到 漏洞 所在 的 函数 并 双击 通过 观察 其 流程图 cfg 可知 此 函数 并没有 直接进行 输入 路径 和 规范化 而是 调 用了 下级 函数 来 进行 路径 整理 将 待 整理 的 路径 字符串 进行 规范化 然后再 保 存到 预先 分配 的 输出 路径 缓冲区 buffer 中 最终 造成 缓冲区 溢出 漏洞 五 总结 写到 这里 这篇 文章 就 介绍 结束 了 通过 本次 实验 我们 复现 了 ms 远程 代码 执行 漏洞 涉及 漏洞 发现 验证 漏洞 利用 漏洞 的 完整 过程 并 利用 metasploit 工具 进行 shell 反弹 及 深入 理解 希望 对 您 有所 帮助 如何 进行 防御 呢 一方面 关闭 相关 端口 安装 杀毒软件 和 补丁 另一方面 在 防火墙 中 进行 流量 监测 主 要是 针对 数据包 中 存在 的 形如 这样 的 恶意 路径名 进行 检测 最为 保险 的 方法 是 使用 pcre 正则 去 匹配 本次 实验 的 完整 命令 端口 查询 查找 漏洞 利用 模块 漏洞 利用 设置 相关 配置 信息 反弹 目标 主机 文件 操作 深度 提 权 及 远程 连接 操作 真的 感觉 自己 技术 好菜 要 学 的 知识 好多 作为 初学者 我们 可能有 差距 不论 你 之前 是什么 方向 是什么 工作 是什么 学历 是 大学 大专 中专 亦 或是 高中 初中 只要 你 喜欢 安全 喜欢 渗透 就 朝着 这个 目标 去 努力 吧 有 差距 不 可怕 我们 需要 的 是 去 缩小差距 去 战斗 况且 这个 学习 的 历程 真的 很美 安全 真的 有意思 但 切勿 去做 坏事 我们 需要 的 是 白 帽子 是 维护 我们 的 网络安全 路上 共勉 最后 真诚地 感谢您 关注 娜 璋 之家 公众 号 也 希望 我 的 文章 能 陪伴 你 成长 希望 在 技术 路上 不断 前行 文章 如果 对 你 有 帮助 有 感悟 就是 对 我 最好 的 回报 且看 且 珍惜 再次 感谢您 的 关注 也 请 帮忙 宣 传下 娜 璋 之家 哈哈 初来乍到 还请 多多指教 顺便 说 一句 今天 csdn 账号 的 粉丝 破 十万 了 还 挺 开心 的 byeastmount 夜 于 武汉 参考文献 利用 smorms 远程 执行 代码 漏洞 复现 feizianquanms 远程 溢出 漏洞 cvewaldocuitms 复现 与 简单 分析 看 雪 论坛 有毒 ms 漏洞 复现 与 利用 张 德 亮 cvemsms 漏洞 复现 入门 到 精通 i 春秋 视频 metasploitable 渗透 测试 实战 windows 漏洞 ms 复现 hsintsaoms 漏洞 学习 研究 justforfunms 漏洞 原理 及 详尽 分析 过程 freebufdhakkan 和 端口 谢 公子 大佬 