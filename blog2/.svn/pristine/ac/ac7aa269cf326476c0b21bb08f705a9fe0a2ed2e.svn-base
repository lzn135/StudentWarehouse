揭开 mysql 索引 神秘 面纱 文章 目录 一 mysql 索引 到底 是什么 二 为什么 要 使用 索引 三 innodb 为什么 使用 btree 而 不 使用 btreebtree 解析 btree 解析 hash 索引 btree 跟 btree 区别 btree 适合做 索引 的 原因 四 聚 簇 索引 非 聚 簇 索引 区别 五 表 中 存在 多个 索引 数据 是 如何 存储 的 六 索引 的 几个 技术 名词 回 表 覆盖 索引 最左 匹配 索引 下推 七 索引 存储 在 什么地方 八 总结 你 是不是 对于 mysql 索引 的 知识点 一直 都像 大杂烩 好像 什么 都 知道 如果 进行 深究 的话 可能 一个 也 答 不上来 假如 你 去 面试 面试官 让 你 聊 一下 对 索引 的 理解 然而 你 对 索引 的 理解 仅限于 检索 数据 就是 快 是 一种 数据结构 这个 层面 那你 就 只能 回家 等 通 知了 为了 避免 这种 尴尬 的 事情 发生 咔 咔 用时 两天 将 索引 的 内容 在 自己 理解 的 范围内 进行 整理 如 整理 的 不 全面 可以 在 评论 区 进行 补充 和 提 建议 一 mysql 索引 到底 是什么 相信 大多数 伙伴 都 买过 技术 类 的 书籍 看完 没 看完 不知道 但是 目录 肯定 看 的 次数 最 多看 目录 有没有 自己 目前 的 痛 点 如果有 就会 根据 目录 对应 的 页码 用 最快 的 速度 翻阅 到 相应 内容 位置 那么 在 mysql 中 同样 也是 这样 的 一个 道理 mysql 的 索引 就是 存储 引擎 为了 快速 找到 数据 的 一种 数据结构 同样在 mysql 索引 中 又 分了 几种 类型 分别为 btree 索引 哈希 索引 空间 索引 全文索引 下文 所有 内容 均在 innodb 的 基础上 讨论 二 为什么 要 使用 索引 索引 可以 加快 数据检索 速度 这 也是 使用 的 索引 的 最主要 原因 索引 本身 具有 顺序 性 在 进行 范围 查询 时 获取 的 数据 已经 排 好了 序 从而 避免 服务器 再次 排序 和 建立 临时 表 的 问题 索引 的 底层 实现 本身 具有 顺序 性 通过 磁盘 预 读 使得 在 磁 盘上 对 数据 的 访问 大致 呈 顺序 的 寻址 也 就是 将 随机 的 io 变为 顺序 io 这 几点 不理解 就 暂时 先 放着 继续 看 下文 即可 会给 你 一个 满意 的 解释 任何事物 都 存在 双面 性 既然 能 提供 性能 的 提升 自然 在其 它 方面 也 会 付出 额外 的 代价 索引 是 跟 数据 共存 因此会 占用 额外 的 存储空间 索引 创 建和 维护 需要 时间 成本 这个 成本 随着 数据量 的 增大 而 增大 索引 创建 会 降低 数据 的 增 删改 的 性能 因为 在 修改 数据 的 同时 还需要 修改 索引 数据 三 innodb 为什么 使用 btree 而 不 使用 btree 聊到 这个 问题 那就 必须 得分 清楚 btreebtree 的 区别 首先 来看 一下 btreebtree 解析 先来 看一下 btree 的 数据结构 是 怎么样 的 这里 咔 咔 给 提供 一个 网站 地址 可以 看到 关于 数据结构 的 一些 实现 过程 先 来看 btree 的 数据结构 下图 是 咔 咔 已经 将 数据 填充 进去 的 这里有 一个 陌生 区 关于 maxdegree 这个 你 可以 理解为 阶 也 可以 理解为 度 例如 现在 这个 值 设置 的 是 那么 在 一个 节点 中最 多就 可以 存储 三条 数据 设置 为 那就 可以 最 多放 条 记录 现在 可以 看到 目前 只 插 入了 三条 数据 那么 再加 一条 数据 节点 就会 进行 分裂 这个 也就 验证 了当 阶 设置 为 n 时 一个 节点 可 存 n 条 数据 那 接着 再来 插入 几条 数据 看看 想要 达到 快速 检索 数据 那就 需要 满足 俩 个 特性 一个是 有序 另一个 就是 平衡 从下 图中 可以 看到 btree 是 有 一定 的 顺序 性 的 平衡性 更 满足 可以 看上 文中 生成 的 第一张 图 那么 在 btree 中 找 一个 值 是 怎么 找 呢 例如 现 在要 找 一个 值 看一下 寻找 过程 首先 看到 的 数据 是 是 大于 的 所以会 往 的 右 节点 寻找 继续 找到 范围 在到 的 节点 又 大于 所以 还需要 往右 节点 寻找 最有 一步 就 找 到了 数据 这个 过程 就是 btree 数据结构 查找 数据 的 执行 过程 了解 到了 btree 的 数据结构 后 我们 在 来看 看在 mysql 中 关于 btree 是 如何 存储 的 在下 图中 p 代表 的 是 指针 指向 的 是 下一个 磁盘 块 在 第一个 节 点中 的 就是 代表 我们 的 key 值 是什么 date 就是 这个 key 值 对应 的 这一 行 记录 是什么 那么 此时 想要 寻找 key 为 的 这条 记录 应该 怎么 找 在 和 中间 所以 会去 磁盘 进行 寻找 在 磁盘 中 进行 判断 指针 指向 磁 盘在 磁盘 中 即可 获 取到 数据 然后 将 data 返回 那么 在 这个 过程中 到底 读 取了 多少 条 数据 呢 在 计算 之前 需要 先 了解 一些 知识点 从 mysql 开始 存储 引擎 默 认为 innodb 并且 innodb 存储 引擎 用于 管理 数据 的 最小 磁盘 单位 就是 页 这个 页 的 类型 也 分为 好几种 分别为 数据 页 undo 页 系统 页 事物 数据 页 一般 说到 的 页 都是 数据 页 默认 的 页面 大小 为 kb 每个 页 中 至少 存储 条 或 以上 的 行 记录 那么 根据 btree 数据 查找 的 过程中 可以 得知 一共 读 取了 三个 磁盘 那么 每个 磁盘 的 大小 就是 kb 而 目前 的 给 的 案例 寻 找了 三层 那么 三层 存储 的 数据 就是 kbkbkbkb 如果 按照 一条 记录 所需 内存 kb 那么 这 三层 的 btree 就可以 存储 条 记录 各位 数据库 的 数据 少则 几百万 多则 几 千万 数据 那么 btree 的 层级 就会 越来 越深 相对 的 查询 效率 也 会 越来 越慢 这个 时候 是不是 应该 思考 一个 问题 那就是 为什么 在 btree 中 kb 的 内存 怎么 就 只能 存储 多条 记录 问题 就出 现在 data 上 要知道 在 计算 数据 大 小时 指针 地址 和 key 的 内存 都是 没有 计算 在内 的 单 单就 计 算了 data 的 内存 因为 在 btree 结构 中 节 点中 不仅 存储 的 有 key 指针 地址 还有 对应 的 数据 所以 就会 造成 单个 磁盘 存储 的 数据 相对 很少 的 原因 为了 解决 单个 节点 存储 数据量 小 的 问题 于是就 演 变出 另一种 结构 也 就是 下文 提 到了 btreebtree 解析 依然 如初 看一下 btree 的 数据结构 为了 方便 对比 将 btree 和 btree 的 数据结构 放 到了 一起 那么 可以 看到 在 btree 中 叶子 节点 是 存 放了 全 量 的 数据 而非 叶子 节点 只 存储 了 key 值 咦 这不是 就 很好 的 解决 了 btree 带来 的 问题 吗 可以 让 每个 节点 存储 更多 的 数据 每个 节点 存储 的 数据 越多 那么 相对 的 就是 树 的 深度 就不会 过深 了解 到了 btree 的 数据结构 后 我们 在 来看 看在 mysql 中 关于 btree 是 如何 存储 的 从 上图 很明显 就可以 看到 俩 点 不同 第一点 btree 所有 的 数据 都 存储 在 叶子 节点 上第 二点 btree 所有 的 叶子 节点 之间 是 一种 链式 环 结构 那么 在 这个 过程中 到底 读 取了 多少 条 数据 呢 如果说 btree 读取 数据 的 深度 跟 btree 的 深度 一样 都是 三层 那么 同样 的 道理 每个 磁盘 的 大小 为 kb 那 在 btree 中非 叶子 节点 可以 存储 多少 数据 呢 一般来说 我们 每个 表 都会 存在 一个 主键 根据 三层 来 计算 第一层 跟 第二层 存储 的 是 key 值 也 就是 主 键值 都 知道 int 类型 所占 的 内存 时 byte 字节 指针 的 存储 就 给 个 byte 一共 就是 tybe 那么 第一层 节点 就可以 存储 同理 第二层 每个 节点 也是 可以 存储 个 key 第三层 是 叶子 节点 每个 磁盘 存储 大小 同样 安装 btree 的 计算 一样 每条 数据 占 kb 那么 在 btree 中三 层 可以 存储 的 数据 就是 从这 点 来看 btree 存储 的 数据 跟 btree 存储 的 数据 根本 就不是 一个 级别 所以 可以 得出结论 btree 能 保证 检索 的 数据量 相对 btree 是 最多 的 而且 存储 的 数据量 也是 最多 的 btree 选择 索引 时 尽量 选择 所占 内存空间 小 的 类型 比如 int 类型 key 所占 内存 越小 在 节 点中 存储 的 范围 就 越多 hash 索引 先来 创建 一个 hash 索引 gender 存储 引擎 使用 的 是 innodb 会 发现 name 的 索引 类型 还是 为 btree 在 innodb 上 创建 哈希 索引 被 称之为 伪 哈希 索引 和 真正 的 哈希 索引 不是 一回事 的 这点 一 定要 明白 在 innodb 存储 引擎 中有 一个 特殊 的 功能 叫做 自适应 哈希 索引 当 索引 值 被 使用 的 非常 频繁 时 它会 在 内存 中 基于 btree 索引 之上 再 创建 一个 哈希 索引 那么 就 拥有 了 哈希 索引 的 一些 特点 比如 快速 查找 哈希 索引 就是 基于 哈希 表 实现 的 假设 对 name 建 立了 哈希 索引 则 查找 过程 如 下图 所示 哈希 表 是 根据 键值 对 进行 访问 的 数据结构 它 让 检索 的 数据 经过 哈希 函数 映 射到 散 列表 的 对应 位置 查找 效率 非常 高 哈希 索引 存储 的 是 哈希 值 和 行 指针 没有 存储 key 值 字段 值 但 哈希 索引 多数是 在 内存 完成 的 检索 数据 是 非常快 的 所 以对 性能 影响 不大 哈希 索引 不是 按照 索引 值 排序 的 所以 也就 无法 排序 哈希 索引 只 支持 等值 操作 不支持 范围 查找 在 mysql 中 只能 只用 inltgt 哈希 索引 在 任何时候 都不能 避免 表 扫描 哈希 索引 在 遇到 大量 哈希 冲突 时 存储 引擎 必须 遍历 链表 的 所有 行 指针 逐行 比较 btree 跟 btree 区别 经 过了 特别 漫长 的 计算 画图 现在 基本 对 俩 者 的 区别 有 一定 认识 了吧 咔 咔 在这里 进行 总结 一下 btree 叶子 节点 上 存储 的 是 全 量 数据 keydata 而非 叶子 节点 只 存储 keybtree 在 同样 的 深度 下 存储 的 数据 是 远远 大于 btree 的 btree 每个 叶子 节点 都有 指向 下一个 叶子 节点 的 链接 这样 的 好处 在于 我们 可以 从 任意 一个 叶子 节点 开始 遍历 获取 接下来 所有 的 数据 btree 适合做 索引 的 原因 btree 树 非 叶子 节点 只 存储 key 值 因此 相对于 btree 节点 可以 存储 更多 的 数据 每次 读入 内存 的 key 值 就 更多 相对来说 io 就 降低 btree 树 查询 效率 稳定 任何 数据 的 查找 都是 必须 从 叶子 节 点到 非 叶子 节点 所以说 每个 数据 查找 的 效率 几乎 都是 相同 的 btree 树 的 叶子 节点 存储 的 是 全 量 数据 并且是 有序 的 所以说 只需要 遍历 叶子 节点 就可 以对 所有 的 key 进行 扫描 在 范围 查找 时 效率 更高 以上 就是 关于 innodb 存储 引擎 为什么 使用 btree 作为 索引 的 解析 四 聚 簇 索引 非 聚 簇 索引 区别 聚 簇 索引 非 聚 簇 索引 也 被 称之 为主 索引 二级 索引 那么 如何 区分 聚 簇 索引 和 非 聚 簇 索引 呢 首先 看一下 innodb 引擎 下 创建 表 生成 的 文件 可以 看到 有 俩 个 ibd 文件 看到 这里 不知道 大家 有没有 疑问 为什么 看有 的 文章 中 也 会有 frm 文件 呢 但是 在这里 怎么 没有 呢 原因是 在 mysql 之后 将 源 数据 都 存储 到了 表 空间 中 所以 也就 不存在 frm 文件 喽 都 知道 这个 idb 文件 会 存储 数据 信息 和 索引 信息 那 再来 看一下 myisam 存储 引擎 创建 表 生产 的 文件 从 图中 可以 看到 创建 一个 表 会 生成 三个 文件 扩展名 分别为 mydmyisdimyd 是 表 数据文件 保存 数据 的 文件 myi 是 表 索引 文件 保存 索引 的 文件 那么 就可以 得出 一个 结论 只要 数据 跟 索引 存储 在 一个 文件 里 那就是 聚 簇 索引 否则 就 是非 聚 簇 索引 这个 时候 就会 有人 问了 表 中有 主键 的 时候 idb 文件 中 存储 的 是 主键 数据 那么 当 没有 设置 主键 时 怎么办 呢 记住 这一 句话 在 innodb 中 数据 插 入时 必须 跟 一个 索引 值 进行 绑定 如果 没有 主键 那就 选择 唯一 索引 如果 没有 唯一 索引 就会 选择 一个 byte 的 rowid 五 表 中 存在 多个 索引 数据 是 如何 存储 的 看了 上文 的 解释 有没有 产 生过 一丝 疑问 在 innodb 存储 引擎 下 如果 存在 多个 索引 是不是 会 产生 多个 idb 文件 在 innod db 中 数据 只会 保存 一份 如果有 多个 索引 会 维护 多个 btree 例如 表 字段 idnameagesexid 设置 为 主键 索引 聚 簇 索引 name 设置 为 普通 索引 那么 数据 到底会 存储 几份 呢 不管 一个 表 中 设置 多少个 索引 数据 只会 存储 一份 但是 这张 表 会 维护 多个 btree 按照 这个 案例 中 id 为 主键 索引 name 为 普通 索引 那么 在 这张 表 中 就会 维护 俩 颗 btreeid 主键 索引 跟 数据 存储 在一起 name 索引 所在 的 btree 中 叶子 节点 存储 的 是 主键 id 的 值 对应 的 图 就是 以下 俩 幅 图 可以 好好 的 看一下 最后 给 大家 总结 一个 点在 innodb 中一 定有 聚 簇 索引 其它 索引 都 是非 聚 簇 索引 这里 简单 提 一下 myisam 中 只有 非 聚 簇 索引 六 索引 的 几个 技术 名词 在 面试 中 往往会 问这 几个 关键词 分别为 回 表 覆盖 索引 最 左侧 原则 索引 下推 一定 要知道 哈 回 表 网上 对 回 表 的 解释 各种各样 咔 咔 给你 说 种 简单 易懂 的 但 前提 是 你 需 要把 聚 簇 索引 非 聚 簇 索引 区分 清楚 还是 用 上边 的 案例 id 为 主键 索引 name 为 普通 索引 此时 查询 语句 为 那么 这条 语句 会 先在 name 的 这颗 btree 中 寻 找到 主键 id 然后 在 根据 主键 id 的 索引 获 取到 数据 并且 返回 其实 这个 过程 就是 从 非 聚 簇 索引 跳 转到 聚 簇 索引 中 查找 数据 被称为 回 表 也就是说 当你 查询 的 字段 为 非 聚 簇 索引 但 是非 聚 簇 索引 中 没有 将 需要 查询 的 字段 全部 包含 就是 回 表 在这 个 案例 中非 聚 簇 索引 name 的 叶子 节点 只有 id 并没有 age 所以会 跳 转到 聚 簇 索引 中 根据 id 在 查询 整条 记录 返回 需要 的 字段 数据 覆盖 索引 覆盖 索引 根据 名字 都能 理解 的 差不多 就是 查询 的 所有 字段 都 创 建了 索引 此时 查询 语句 为 那么 这条 语句 就是 使 用了 覆盖 索引 因为 id 和 name 都为 索引 字段 查询 的 字段 也是 这俩 个 字段 所以 被称为 索引 覆盖 也就是说 当 非 聚 簇 索引 的 叶子 节 点中 包 含了 需要 查询 的 字段 时 就被 称为 覆盖 索引 最左 匹配 最左 匹配 原 则是 在 组合 索引 中 存在 的 还是 用 之前 表 信息 表 字段 idnameagesex 此时 给 nameage 设置成 组合 索引 以下 语 句中 那个 不符合 最 左侧 原则 可以 自行 做 一下 测验 哈 是 只有 第三条 语句 不会 用到 索引 其它 的 三条 语句 都会 符合 最 左侧 原则 关于 这个 最 左侧 原则 远远 不止 这么 简单 的 一试 就是 一个 坑 关于 这 部分内容 咔 咔 后期 会在 优化 文章 中 提到 索引 下推 还是 使用 这条 sql 语句 索引 下推 是 在 mysql 及 以后 的 版本 出现 的 之前 的 查询 过程 是 先 根据 name 在 存储 引擎 中 获取 数据 然后 在 根据 age 在 server 层 进行 过滤 在有 了 索引 下推 之后 查询 过程 是 根据 nameage 在 存储 引擎 获取 数据 返回 对应 的 数据 不 再到 server 层 进行 过滤 当你 使用 explain 分析 sql 语句 时 如果 出现 了 那就是 使 用了 索引 下推 索引 下推 是 在 组合 索引 的 情况 出现 几率 最大 的 七 索引 存储 在 什么地方 索引 的 数据文件 是 存储 在 磁盘 中 的 也是 需要 进行 持久 化 操作 但是 当 使用 索引 时 会把 数据 从 磁盘 读 取到 内存 中 读取 方式 为 分块 读取 这时 就要 涉及到 操作系统 的 概念 操作系统 在 磁盘 中 获取 数据 假设 现 在要 取 的 数据 大小 是 kb 但 操作系统 并不会 只 取出 你 需要 的 这 kb 而是 会 取出 kb 的 数据 为什么 会是 kb 因为 在 操作系统 中一 页 的 数据 就是 kb 那又 为什么 只需要 kb 而 取出 整页 的 数据 呢 那就 又会 涉及到 另一个 概念 那就是 局部性 原理 数据 和 程序 都有 聚集 成群 的 倾向 在 访 问了 一条 数据 之后 在 之后 有 极大 的 可能 再次 访问 这条 数据 和 这条 数据 的 相邻 数据 所以说 mysql 的 innodb 存储 引擎 在 读取 数据 时 也 会 采取 这种 局部性 原理 每次 读取 的 数据 是 kb 在 innodb 存储 引擎 下 每页 的 大小 默 认为 kb 这个 参数 也 可以 进行 调整 参数 为 innodbpagesize 最后 一点 既然 标题 问 的 是 索引 数据 存储 在 什么地方 在 第一 句 就 直接 回答 了 索引 是 存储 在 磁盘 中 并且 以 页 为 单位 进行 从 磁盘 往 内存 读取 那 为什么 不 直接 存储 在 内存 中 呢 你 有没有 这个 疑问 呢 如果 索引 数据 只 存储 在 内存 中 那么 当 电脑 关机 服务器 宕机 之后 就需要 重新 生成 索引 这种 的 效率 是 十分 低 的 八 总结 以上 就是 咔 咔 对 索引 的 理解 在 尽 最大 的 可 能将 知识点 说 全面 如果 还有 遗漏 或者 文章 中有 错误 的 地方 还请 各位 能 给出 提议 