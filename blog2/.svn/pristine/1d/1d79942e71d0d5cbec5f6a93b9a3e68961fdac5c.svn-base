万字 长文 书写 rabbitmq 最全 见解 以后 再也 不用 到处 去 搜索 了呀 典型 应用 场景 跨 系统 的 异步 通信 人民银行 二代 支付 系统 使用 重量级 消息 队列 ibmmq 异步 解 耦 削 峰 都有 体现 应用 内 的 同步 变成 异步 秒杀 自己 发送给 自己 基于 pubsub 模型 实现 的 事件 驱动 放款 失败 通知 提货 通知 购买 碎 屏保 系统 间 同步 数据 摒弃 elt 比如 全 量 同步 商户 数据 摒弃 api 比如 定时 增量 获取 用户 获取 产品 变成 增量 广播 利用 rabbitmq 实现 事务 的 最终 一致性 基本 介绍 amqp 协议 amqp 即 一个 提供 统一 消息 服务 的 应用层 标准 高级 消息 队列 协议 是 应用层 协议 的 一个 开放 标准 为 面向 消息 的 中间件 设计 基 于此 协议 的 客户端 与 消息 中间件 可 传递 消息 并 不受 客户端 中间件 同 产品 不同 的 开发 语言 等 条件 的 限制 amqp 的 实现 有 等 rabbitmq 的 特性 rabbitmq 使用 erlang 语言 编写 使用 mnesia 数据库 存储 消息 可靠性 使用 一些 机制 来 保证 可靠性 如 持久 化 传输 确认 发布 确认 灵活 的 路由 flexiblerouting 在 消息 进入 队列 之前 通过 exchange 来 路由 消息 的 对于 典型 的 路由 功能 rabbitmq 已经 提供 了 一些 内置 的 exchange 来 实现 针对 更 复杂 的 路由 功能 可以 将 多个 exchange 绑定 在一起 也 通过 插件 机制 实现 自己 的 exchange 消息 集群 clustering 多个 rabbitmq 服务器 可以 组成 一个 集群 形成 一个 逻辑 broker 高 可用 队列 可以 在 集群 中 的 机器 上 进行 镜像 使得 在 部分 节点 出问题 的 情况下 队列 仍然 可用 多种 协议 支持 多种 消息 队列 协议 比如 amqpstompmqtt 等等 多语言 客户端 几乎 支持 所有 常用 语言 比如 等等 管理 界面 提供 了 一个 易用 的 用户 界面 使得 用户 可以 监控 和 管理 消息 集群 中 的 节点 插件 机制 提供 了 许多 插件 以 实 现从 多方面 扩展 当然 也 可以 编写 自己 的 插件 工作 模型 概念 解释 broker 即 rabbitmq 的 实体 服务器 提供 一种 传输 服务 维护 一条 从 生产者 到 消费者 的 传输 线路 保证 消息 数据 能 按照 指定 的 方式 传输 exchange 消息 交换机 指定 消息 按照 什么 规则 路由 到 哪个 队列 queuequeue 消息 队列 消息 的 载体 每条 消息 都 会被 投 送到 一个 或 多个 队列 中 binding 绑定 作用 就是 将 exchange 和 queue 按照 某种 路由 规则 绑定 起来 routingkey 绑定 作用 就是 将 exchange 和 queue 按照 某种 路由 规则 绑定 起来 vhost 虚拟主机 一个 broker 可以 有 多个 虚拟主机 用作 不同 用户 的 权限 分离 一个 虚拟主机 持有 一组 exchangequeue 和 bindingproducer 消息 生产者 主 要将 消息 投递 到 对应 的 exchange 上面 一般 是 独立 的 程序 consumer 消息 消费者 消息 的 接收者 一般 是 独立 的 程序 和 consumer 与 broker 之间 的 tcp 长 连接 channel 消息 通道 也 称 信道 在 客户端 的 每个 连接 里 可以 建立 多个 channel 每个 channel 代表 一个 会话 任务 在 中 channel 上 定义 了 大量 的 编程 接口 三种 主要 的 交换机 directexchange 直连 交换机 定义 直连 类型 的 交换机 与 一个 队列 绑 定时 需要 指定 一个 明确 的 bindingkey 路由 规则 发送 消息 到 直连 类型 的 交换 机时 只有 routingkey 跟 bindingkey 完全 匹配 时 绑定 的 队列 才能 收到 消息 例如 只有 队列 能 收到 消息 topicexchange 主题 交换机 定义 主题 类型 的 交换机 与 一个 队列 绑 定时 可以 指定 按 模式 匹配 的 routingkey 通配符 有 两个 代表 匹配 一个 单词 代表 匹配 零个 或者 多个 单词 单词 与 单词 之间 用 隔开 路由 规则 发送 消息 到 主题 类型 的 交换 机时 routingkey 符合 bindingkey 的 模式 时 绑定 的 队列 才能 收到 消息 例如 只有 队列 能 收到 消息 队列 和 队列 能 收到 消息 只有 队列 能 收到 消息 fanoutexchange 广播 交换机 定义 广播 类型 的 交换机 与 一个 队列 绑 定时 不需要 指定 bindingkey 路由 规则 当 消息 发送到 广播 类型 的 交换 机时 不需要 指定 routingkey 所有 与 之 绑定 的 队列 都能 收到 消息 例如 个 队列 都会 收到 消息 javaapi 编程 创建 maven 工程 pomxml 引入 依赖 生产者 stringargs 连接 连接 端口 factorysetport 虚拟机 用户 guest guest 建立 连接 创建 消息 通道 声明 队列 发送 消息 发送到 默认 交换机 如果有 一个 队列 名称 跟 routingkey 相等 那么 消息 会 路由 到 这个 队列 channelclose connclose 消费者 stringargs 连接 默认 监听 端口 factorysetport 虚拟机 设置 访问 的 用户 guest guest 建立 连接 创建 消息 通道 声明 队列 创建 消费者 channel bodyutf 开始 获取 消息 参数 说明 声明 交换机 的 参数 stringtype 交换机 的 类型 中 的 一种 booleandurable 是否 持久 化 代表 交换机 在 服务器 重启 后 是否 还 存在 声明 队列 的 参数 booleandurable 是否 持久 化 代表 队列 在 服务器 重启 后 是否 还 存在 是否 排他性 队列 排他性 队列 只 能在 声明 它 的 connection 中 使用 连接 断开 时 自动 删除 是否 自动 删除 如果 为 true 至少有 一个 消费者 连 接到 这个 队列 之后 所有 与 这个 队列 连接 的 消费者 都 断开 时 队列 会 自动 删除 maparguments 队列 的 其他 属性 例如 消息 属性 basicproperties 消息 的 全部 属性 有 个 以下 列 举了 一些 主要 的 参数 参数 释义 消息 的 其他 自定义 参数 持久 化 其他 瞬态 integerpriority 消息 的 优先级 关联 id 方便 rpc 相 应与 请求 关联 stringreplyto 回 调 队列 消息 过期 时间 单位 毫秒 ttltimetolivea 消息 的 过期 时间 有 两种 设置 方式 通过 队列 属性 设置 消息 过期 时间 argssput xmessagettl 设置 单 条 消息 的 过期 时间 deliverymode 持久 化 消息 contentencoding utf expiration ttlbuild b 队列 的 过期 时间 argssput xmessagettl 死信 队列 有 三种 情况 消息 会 进入 死信 交换机 nackreject 消息 过期 队列 达到 最大 长度 先 入队 的 消息 会被 发送到 dlx 可以 设置 一个 死信 队列 deadletterqueue 与 dlx 绑定 即可以 存储 deadletter 消费者 可以 监听 这个 队列 取走 消息 argumentsput 指定 了 这个 队列 的 死信 交换机 声明 死信 交换机 声明 死信 队列 绑定 优先级 队列 设置 一个 队列 的 最大 优先级 argssput xmaxpriority 队列 最大 优先级 发送 消息 时 指定 消息 当前 的 优先级 priority 消息 优先级 build 优先级 高 的 消息 可以 优先 被 消费 但是 只有 消息 堆积 消息 的 发送 速度 大于 消费者 的 消费 速度 的 情况下 优先级 才有 意义 延迟 队列 rabbitmq 本身 不支持 延迟 队列 可以 使用 ttl 结合 dlx 的 方式 来 实现 消息 的 延迟 投递 即把 dlx 跟 某个 队列 绑定 到了 指定 时间 消息 过期 后 就会 从 dlx 路由 到 这个 队列 消费者 可以 从 这个 队列 取走 消息 另一种 方式 是 使用 插件 当然 将 需要 发送 的 信息 保存 在 数据库 使用 任务 调度 系统 扫描 然后 发送 也是 可以 实现 的 rpcrabbitmq 实现 rpc 的 原理 服务端 处理 消息 后 把 响应 消息 发送到 一个 响应 队列 客户端 再从 响应 队列 取到 结果 其中 的 问题 client 收到 消息 后 怎么 知道 应答 消息 是 回复 哪一条 消息 的 所以 必须有 一个 唯一 id 来 关联 就是 correlationid 服务端 流 控 会在 启动时 检测 机器 的 物理 内存 数值 默认 当 mq 占用 以上 内存 时 mq 会 主动 抛出 一个 内存 警告 并 阻塞 所有 连接 connections 可以 通过 修改 rabbitmqconfig 文件 来 调整 内存 阈值 默认值 是 如下 所示 默认 情况 如果 剩余 磁盘空间 在 gb 以下 rabbitmq 主动 阻塞 所有 的 生产者 这个 阈值 也是 可调 的 注意 队列 长度 只 在 消息 堆积 的 情况下 有意义 而且 会 删除 先 入队 的 消息 不能实现 服务端 限流 消费 端 限 流在 autoack 为 false 的 情况下 如果 一 定数 目的 消息 通过 基于 consumer 或者 channel 设置 qos 的 值 未被 确认 前 不 进行 消费 新 的 消息 channelbasicqos 如果 超过 条 消息 没有 发送 ack 当前 消费者 不再 接受 队列 消息 ui 管理 界面 的 使用 管理 插件 提供 了 更 简单 的 管理方式 启用 管理 插件 windows 启用 管理 插件 启用 管理 插件 管理 界面 访问 端口 默认 端口 是 默认 用户 guest 密码 guestguest 用户 默认 只 能在 本机 访问 linux 创建 rabbitmq 用户 例如 创建 用户 admin 密码 admin 授权 访问 所有 的 配置 方式 集成 rabbitmq 步骤 创建 maven 工程 pomxml 引入 依赖 srcmainresouces 目录 创建 rabbitmqxml 配置 目录 logjproperties 编写 生产者 编 写个 消费者 编写 单元测试 类 rabbitmq 可靠性 投递 rabbitmq 可靠性 投递 与 高 可用 架构 在 rabbitmq 里面 提供 了 很多 保证 消息 可靠 投递 的 机制 这个 也是 rabbitmq 的 一个 特性 我们 在 讲 可靠性 投递 的 时候 必 须要 明确 一个 问题 因为 效率 与 可靠性 是 无法 兼得 的 如果 要 保证 每一个 环节 都 成功 势必 会对 消息 的 收发 效率 造成 影响 所以 如果是 一些 业务 实时 一致 性要求 不是 特别高 的 场合 可以 牺牲 一些 可靠性 来 换取 效率 比如 发送 通知 或者 记录 日志 的 这种 场景 如果 用户 没有 收到 通知 不会 造成 业务 影响 只要 再次 发送 就可以 了 在 我们 使用 rabbitmq 收发 消息 的 时候 有 几个 主要 环节 代表 消息 从 生产者 发送到 broker 生产者 把 消息 发到 broker 之后 怎么 知道 自己 的 消息 有没有 被 broker 成功 接收 代表 消息 从 exchange 路由 到 queueexchange 是 一个 绑定 列表 如果 消息 没有办法 路由 到 正确 的 队列 会 发生 什么事情 应该 怎么 处理 代表 消息 在 queue 中 存储 队列 是 一个 独立 运行 的 服务 有 自己 的 数据库 mnesia 它是 真正 用来 存储 消息 的 如果 还没有 消费者 来 消费 那么 消息 要 一直 存储 在 队列 里面 如果 队列 出了 问题 消息 肯定会 丢失 怎么 保证 消息 在 队列 稳定地 存储 呢 代表 消费者 订阅 queue 并 消费 消息 队列 的 特性 是什么 fifo 队列 里面 的 消息 是 一条 一条 的 投递 的 也就是说 只有 上 一条 消息 被 消费者 接收 以后 才 能把 这一 条 消息 从 数据库 删掉 继续 投递 下一 条 消息 那么 问题 来了 broker 怎么 知道 消费者 已经 接 收了 消息 呢 消息 发送到 rabbitmq 服务器 第一个 环节 是 生产者 发送 消息 到 broker 可能 因为 网络 或者 broker 的 问题 导致 消息 发送 失败 生产者 不能 确定 broker 有没有 正确 的 接收 rabbitmq 里面 提供 了 两种 机制 服务端 确认 机制 也 就是在 生产者 发送 消息 给 rabbitmq 的 服务端 的 时候 服务端 会 通过 某种 方式 返回 一个 应答 只要 生产者 收 到了 这个 应答 就 知道 消息 发送 成功 了 第一种 是 transaction 事务 模式 第二种 confirm 确认 模式 transaction 事务 模式 我们 通过 一个 channeltxselect 的 方法 把 信道 设置成 事务 模式 然后 就可以 发布 消息 给 rabbitmq 了 如果 channeltxcommit 的 方法 调用 成功 就 说明 事务 提交 成功 则 消息 一定 到达 了 rabbitmq 中 如果在 事务 提交 执行 之前 由于 rabbitmq 异常 崩溃 或者 其他 原因 抛出 异常 这个 时候 我们 便 可以 将其 捕获 进而 通过 执行 方法来 实现 事务 回 滚在 事务 模式 里面 只有 收 到了 服务端 的 commitok 的 指令 才能 提交 成功 所以 可以 解决 生产者 和 服务端 确认 的 问题 但是 事务 模式 有 一个 缺点 它是 阻塞 的 一条 消息 没有 发送 完毕 不能 发送 下一 条 消息 它会 榨 干 rabbitmq 服务器 的 性能 所以 不 建议 大家 在 生产 环境 使用 springboot 中 的 设置 true 那么 有没有 其他 可以 保证 消息 被 broker 接收 但是 又不 大量 消耗 性能 的 方式 呢 这个 就是 第二种 模式 叫做 确认 confirm 模式 confirm 确认 模式 confirm 确认 模式 确认 模式 有 三种 一种 是 普通 确认 模式 在 生产者 这边 通过 调用 方法 将 信道 设置 为 confirm 模式 然后 发送 消息 一旦 消息 被 投递 到 所有 匹配 的 队列 之后 rabbitmq 就会 发送 一个 确认 basicack 给 生产者 也 就是 调用 返回 true 这样 生产者 就 知道 消息 被服 务 端接 收了 这种 发送 条 确认 条 的 方式 消息 还 不是 太高 所以 我们 还有 一种 批量 确认 的 方式 批量 确认 就是在 开启 confirm 模式 后 先 发送 一批 消息 只要 方法 没有 抛出 异常 就 代表 消息 都被 服务 端接 收了 批量 确认 的 方式 比 单 条 确认 的 方式 效率 要高 但是 也有 两个 问题 第一个 就是 批量 的 数量 的 确定 对于 不同 的 业务 到底 发送 多少 条 消息 确认 一次 数量 太少 效率 提升 不上去 数量 多 的话 又会 带来 另一个 问题 比如 我们 发条 消息 才 确认 一次 如果 前 面条 消息 都被 服务 端接 收了 如果 第 条 消息 被 拒 绝了 那么 前面 所有 的 消息 都要 重发 有没有 一种 方式 可以 一边 发送 一边 确认 的 呢 这个 就是 异步 确认 模式 异步 确认 模式 需要 添加 一个 confirmlistener 并且 用 一个 sortedset 来 维护 没有 被 确认 的 消息 confirm 模式 是 在 channel 上 开启 的 因为 rabbittemplate 对 channel 进行了 封装 叫做 if ack 发送 消息 失败 cause 发送 异常 cause 消息 从 交换机 路由 到 队列 第二个 环节 就是 消息 从 交换机 路由 到 队列 在 什么 情况下 消息 会 无法 路由 到 正确 的 队列 可能 因为 路由 键 错误 或者 队列 不存在 我们 有 两种 方式 处理 无法 路由 的 消息 一种 就是 让 服务端 重 发给 生产者 一种 是 让 交换机 路由 到 另一个 备份 的 交换机 消息 回 发 的 方式 使用 mandatory 参数 和 returnlistener 在 springamqp 中 是 true 回 发 的 消息 消息 路由 到 备份 交换机 的 方式 在 创建 交换机 的 时候 从属性 中 指定 备份 交换机 argumentsput 指定 交换机 的 备份 交换机 注意 区别 队列 可以 指定 死信 交换机 交换机 可以 指定 备份 交换机 消息 在 队列 存储 第三个 环节 是 消息 在 队列 存储 如果 没有 消费者 的话 队列 一直 存在 在 数据库 中 如果 rabbitmq 的 服务 或者 硬件 发生 故障 比如 系统 宕机 重启 关闭 等等 可能会 导致 内存 中 的 消息 丢失 所以 我们 要把 消息 本身 和 元 数据 队列 交换机 绑 定都 保 存到 磁盘 解决方案 队列 持久 化 gpqueue 交换机 持久 化 bean gpexchange 消息 持久 化 持久 化 消息 getbytes 集群 如果 只有 一个 rabbitmq 的 节点 即使 交换机 队列 消息 做了 持久 化 如果 服务 崩溃 或者 硬件 发生 故障 rabbitmq 的 服务 一样 是 不可用 的 所以 为了 提高 mq 服务 的 可用性 保障 消息 的 传输 我们 需要 有 多个 rabbitmq 的 节点 消息 投递 到 消费者 如果 消费者 收到 消息 后 没 来得及 处理 即 发生 异常 或者 处理 过程中 发生 异 常会 导致 失败 服务端 应 该以 某种 方式 得知 消费者 对 消息 的 接收 情况 并 决定 是否 重新 投递 这条 消息 给 其他 消费者 rabbitmq 提供 了 消费者 的 消息 确认 机制 消费者 可以 自动 或者 手 动地 发送 ack 给 服务端 没有 收到 ack 的 消息 消费者 断开 连接 后 rabbitmq 会把 这条 消息 发送给 其他 消费者 如果 没有 其他 消费者 消费者 重启 后会 重新 消费 这条 消息 重复 执行 业务 逻辑 消费者 在 订阅 队列 时 可以 指定 autoack 参数 当 autoack 等于 false 时 rabbitmq 会 等待 消费者 显 式 地 回复 确认 信号 后 才 从 队列 中 移去 消息 如何 设置 手动 或者 注意 这三个 值 的 区别 none 自动 ackmanual 手动 ackauto 如果 方法 未 抛出 异常 则 发送 ack 当 抛出 异常 的 时候 则 消息 会被 拒绝 且不 重新 入队 当 抛出 异常 则 消费者 会 发送 ack 其他 的 异常 则 消息 会被 拒绝 且 requeuetrue 会 重新 入队 在 springboot 中 消费者 又 怎么 调用 ack 或者说 怎么 获得 channel 参数 呢 引入 channelbasicack getdeliverytag false 如果 消息 无法 处理 或者 消费 失败 也有 两种 拒绝 的 方式 basicreject 拒绝 单 条 basicnack 批量 拒绝 如果 requeue 参数设置 为 true 可以 把 这条 消息 重新 存入 队列 以便 发给 下一个 消费者 当然 只有 一个 消费者 的 时候 这种 方式 可能会 出现 无限 循环 重复 消费 的 情况 可以 投递 到 新 的 队列 中 或者 只 打印 异常 日志 思考 服务端 收 到了 ack 或者 nack 生产者 会 知道吗 即使 消费者 没有 接 收到 消息 或者 消 费时 出现异常 生产者 也是 完全 不知情 的 例如 我们 寄出去 一个 快递 是 怎么 知道 收件人 有没有 收到 的 因为 有 物流 跟踪 和 签收 反馈 所以 寄件人 可以 知道 在 没有 用上 电话 的 年代 我们 寄出去 一封信 是 怎么 知道 收信人 有没有 收到 信件 只有 收到 回信 才 知道 寄出 的 信 被 收 到了 所以 这个 是 生产者 最终 确定 消费者 有没有 消费 成功 的 两种 方式 消费者 收到 消息 处理 理 完毕 后 调用 生产者 的 api 思考 是否 破坏 解 耦 消费者 收到 消息 处理完毕 后 发送 一条 响应 消息 给 生产者 消费 者回 调 调用 生产者 api 例如 提单 系统 给 其他 系统 发 送了 碎 屏保 消息 后 其他 系统 必 须在 处 理完 消息 后 调用 提单 系统 提供 的 api 来 修改 提单 系统 中 数据 的 状态 只要 api 没有 被 调用 数据 状态 没有 被 修改 提单 系统 就 认为 下游 系统 没有 收到 这条 消息 发送 响应 消息 给 生产者 例如 商业银行 与 人民银行 二代 支付 通信 无论是 人行 收 到了 商业银行 的 消息 还是 商业银行 收 到了 人行 的 消息 都必须 发送 一条 响应 消息 叫做 回执 报文 补偿 机制 如果 生产者 的 api 就是 没有 被 调用 也没有 收到 消费者 的 响应 消息 怎么办 不要 着急 可能是 消费者 处理 时间 太长 或者 网络 超时 生产者 与 消费者 之间 应该 约定 一个 超时 时间 比如 分钟 对于 超出 这个 时间 没有 得到 响应 的 消息 可以 设置 一个 定时 重发 的 机制 但要 发送 间隔 和 控制 次数 比如 每隔 分钟 发送 一次 最多 重发 次 否 则会 造成 消息 堆积 重发 可以 通过 消息 落 库 定时 任务 来 实现 重发 是否 发送 一模一样 的 消息 参考 atm 机上 运行 的 系统 叫 c 端 atmc 前置 系统 叫 p 端 atmc 它 接收 atmc 的 消息 再 转发给 卡 系统 或者 核心 系统 如果 客户 存款 没有 收到 核心 系统 的 应答 消息 幂 等 性 不知道 有没有 记账 成功 最多 发送 次 存款 确认 报文 因为 已经 吞 钞 了 所以 要 保证 成功 如果 客户 取款 atmc 未 得到 应答 时 最多 发送 次 存款 冲 正 报文 因为 没有 吐 钞 所以 要 保证 失败 消息 幂 等 性 如果 消费者 每一次 接收 生产者 的 消息 都 成功 了 只是在 响应 或者 调用 api 的 时候 出了 问题 会不会 出现 消息 的 重复 处理 例如 存款 元 atm 重 发了 次 核心 系统 一 共处 理了 次 余额 增加了 元 所以 为了 避免 相同 消息 的 重复 处理 必 须要 采取 一定 的 措施 rabbitmq 服务端 是 没有 这种 控制 的 同一 批 的 消息 有 个 递增 的 deliverytag 它不 知道 你 是不是 就 要把 一条 消息 发送 两次 只 能在 消费 端 控制 如何 避免 消息 的 重复 消费 消息 出现 重复 可能 会有 两个 原因 生产者 的 问题 环节 重复 发送 消息 比 如在 开启 了 confirm 模式 但未 收到 确认 消费者 重复 投递 环节 出了 问题 由于 消费者 未 发送 ack 或者 其他 原因 消息 重复 投递 生产者 代码 或者 网络 问题 对于 重复 发送 的 消息 可 以对 每 一条 消息 生成 一个 唯一 的 业务 id 通过 日志 或者 消息 落 库 来 做 重复 控制 参考 银行 的 重 账 控制 环节 最终 一致 如果 确 实是 消费者 宕机 了 或者 代码 出现 了 bug 导致 无法 正常 消费 在 我们 尝试 多次 重发 以后 消息 最终 也没有 得到 处理 怎么办 例如 存款 的 场景 客户 的 钱 已经 被 吞了 但是 余额 没有 增加 这个 时候 银行 出现 了 长 款 应该 怎么 处理 如果 客户 没有 主动 通知 银行 这个 问题是 怎么 发现 的 银行 最终 怎么 把 这个 账务 做 平 在 我们 的 金融系统 中都 会有 双方 对账 或者 多方 对账 的 操作 通常是 在 一天 的 业务 结束 之后 第二天 营业 之前 我们 会 约定 一个 标准 比如 atm 跟 核心 系统 对账 肯定 是以 核心 系统 为准 atmc 获 取到 核心 的 对账 文件 然后 解析 登记 成 数据 然 后跟 自己 记录 的 流水 比较 找出 核心 有 atm 没有 或者 atm 有 核心 没有 或者 两边 都有 但是 金额 不一致 的 数据 对账 之后 我们 再 手工 平 账 比如 取款 记 了账 但是 没 吐 钞 的 做 一笔 冲 正 存款 吞了 钞 没 记账 的 要么 把 钱 退给 客户 要么 补 一笔 账 消息 的 顺序 性 消息 的 顺序 性 指的是 消费者 消费 消息 的 顺序 跟 生产者 生产 消息 的 顺序 是 一致 的 例如 商户 信息 同步 到 其他 系统 有 三个 业务 操作 新增 门店 绑定 产品 激活 门店 这种 情况下 消息 消费 顺序 不能 颠倒 门店 不存在 时 无法 绑定 产品 和 激活 又 比如 发表 微 博 发表 评论 删除 微 博 顺序 不能 颠 倒在 rabbitmq 中一 个 队列 有 多个 消费者 时 由于 不同 的 消费者 消费 消息 的 速度 是 不一样 的 顺序 无法 保证 只有 一个 队列 仅有 一个 消费者 的 情况 才能 保证 顺序 消费 不同 的 业务 消息 发送到 不同 的 专用 的 队列 除非 负载 的 场景 不 要用 多个 消费者 消费 消息 集群 与 高 可用 为什么 要做 集群 集群 主要 用于 实现 高 可用 与 负载 均衡 高 可用 如果 集群 中 的 某些 mq 服务器 不可用 客户端 还 可以 连 接到 其他 mq 服务器 负载 均衡 在 高 并发 的 场景 下单 台 mq 服务器 能 处理 的 消息 有限 可以 分 发给 多台 mq 服务器 rabbitmq 有 两种 集群 模式 普通 集群 模式 和 镜像 队列 模式 rabbitmq 如何 支持 集群 应 用做 集群 需要 面对 数据 同步 和 通信 的 问题 因为 erlang 天生 具备 分布式 的 特性 所以 rabbitmq 天然 支持 集群 不需要 通过 引入 zk 或者 数据库 来 实现 数据 同步 rabbitmq 通过 来 验证 身份 需要 在所 有 节点 上 保持一致 rabbitmq 的 节点 类型 集群 有 两种 节点 类型 一种 是 磁盘 节点 discnode 一种 是 内存 节点 ramnode 磁盘 节 点将 元 数据 包括 队列 名字 属性 交换机 的 类型 名字 属性 绑定 vhost 放在 磁盘 中 内存 节 点将 元 数据 放在 内存 中 ps 内存 节点 会将 磁盘 节点 的 地址 存放在 磁盘 不然 重启 后 就 没有办法 同步 数据 了 如果是 持久 化 的 消息 会 同时 存放在 内存 和 磁盘 集群 中 至少 需要 一个 磁盘 节点 用来 持久 化 元 数据 否则 全部 内存 节点 崩溃 时 就 无从 同步 元 数据 未指定 类型 的 情况下 默 认为 磁盘 节点 我们 一般 把 应用 连 接到 内存 节点 读写 快 磁盘 节点 用来 备份 集群 通过 端口 两两 通信 需要 开放 防火墙 的 端口 需要 注意 的 是 rabbitmq 集群 无法 搭 建在 广域 网上 除非 使用 federation 或者 shovel 等 插件 没 这个 必 要在 同一个 机房 做 集群 集群 的 配置 步骤 配置 hosts 同步 erlangcookie 加入 集群 joincluster 普通 集群 普通 集群 模式 下 不同 的 节点 之间 只会 相互 同步 元 数据 疑问 为什么 不 直接 把 队列 的 内容 消息 在所 有 节点 上 复制 一份 主 要是 出于 存储 和 同步 数据 的 网络 开销 的 考虑 如果 所有 节点 都 存储 相同 的 数据 就 无法 达到 线 性地 增加 性能 和 存储容量 的 目的 堆 机器 假如 生产者 连接 的 是 节点 要将 消息 通过 交换机 a 路由 到 队列 最终 消息 还是 会 转 发到 节点 上 存储 因为 队列 的 内容 只 在 节点 上 同理 如果 消费者 连接 是 节点 要从 队 列上 拉 取 消息 消息 会 从 节点 转 发到 节点 其它 节点 起到 一个 路由 的 作用 类似于 指针 普通 集群 模式 不能 保证 队列 的 高 可用性 因为 队列 内容 不会 复制 如果 节点 失效 将 导致 相关 队列 不可用 因此 我们 需要 第二种 集群 模式 镜像 集群 第二种 集群 模式 叫做 镜像 队列 镜像 队列 模式 下 消息 内容 会在 镜像 节点 间 同步 可用性 更高 不过 也有 一定 的 副作用 系统 性能 会 降低 节点 过多 的 情况下 同步 的 代价 比 较大 操作 方式 命令 或 步骤 rabbitmqctl windows 输入 输入 代表 匹配 所有 definition 点击 hamode 右边 输入 alladdpolicy 高 可用 集群 搭建 成功 后 如果有 多个 内存 节点 那么 生产者 和 消费者 应该 连 接到 哪个 内存 节点 如果在 我们 的 代码 中 根据 一定 的 策略 来 选择 要 使用 的 服务器 那 每个 地方 都要 修改 客户端 的 代码 就会 出现 很多 的 重复 修改 起来 也 比较 麻烦 所以 需要 一个 负载 均衡 的 组件 例如 haproxylvsnignx 由 负载 的 组件 来 做 路由 这个 时候 只需要 连 接到 负载 组件 的 ip 地址 就可以 了 负载 分为 四层 负载 和 七层 负载 四层 负载 工作 在 osi 模型 的 第四层 即 传输 层 tcp 位于 第四层 它是 根据 ip 端口 进行 转发 lvs 支持 四层 负载 rabbitmq 是 tcp 的 端口 七层 负载 工作 在 第七 层 应用层 http 位于 第七 层 可以 根据 请求 资源类型 分 配到 后端 服务器 nginx 支持 七层 负载 haproxy 支持 四层 和 七层 负载 但是 如果 这个 负载 的 组件 也 挂了 呢 客户端 就 无法 连接 到 任意 一台 mq 的 服务器 了 所以 负载 软件 本身 也 需要 做一个 集群 新 的 问题 又来 了如 果有 两台 负载 的 软件 客户端 应该 连 哪个 负载 之上 再 负载 陷入 死循环 了 这个 时候 我们 就要 换个 思路 了 我们 应该 需要 这样 一个 组件 它本身 有 路由 负载 功能 可以 监控 集群 中 节点 的 状态 比如 监控 haproxy 如果 某个 节点 出现异常 或者 发生 故障 就把 它 剔 除掉 为了 提高 可用性 它也 可以 部署 多个 服务 但是 只有 一个 自动 选举 出来 的 master 服务器 叫做 主 路由器 通过 广播 心跳 消息 实现 master 服务器 对外 提供 一个 虚拟 ip 提供 各种 网络 功能 也 就是 谁 抢 占到 vip 就由 谁 对外 提供 网络服务 应用 端 只需要 连 接到 这一个 ip 就行了 这个 协议 叫做 vrrp 协议 虚拟 路由 冗余 协议 这个 组件 就是 keepalived 它 具有 loadbalance 和 的 功能 下面 我们 看下 用 haproxy 和 keepalived 如何 实现 rabbitmq 的 高 可用 mysqlmycatredis 类似 基于 docker 安装 haproxy 负载 keepalived 高 可用 规划 内存 节点 内存 节点 磁盘 节点 vip 我们 规 划了 两个 内存 节点 一个 磁盘 节点 所有 的 节点 之间 通过 镜像 队列 的 方式 同步 数据 内存 节点 用 来给 应用 访问 磁盘 节点 用来 持久 化 数据 为了 实现 对 两个 内存 节点 的 负载 我们 安 装了 两个 haproxy 监听 两个 和 的 端口 安装 两个 keepalived 一 主 一 备 两个 keepalived 抢占 一个 vip 谁 抢 占到 这个 vip 应用 就连 接到 谁来 执行 对 mq 的 负载 这种 情况下 我们 的 keepalived 挂了 一个 节点 没有 影响 因为 backup 会 变成 master 抢占 viphaproxy 挂了 一个 节点 没有 影响 我们 的 vip 会 自动 路由 的 可用 的 haproxy 服务 rabbitmq 挂了 一个 节点 没有 影响 因为 haproxy 会 自动 负 载到 可用 的 节点 实践 经验总结 资源管理 到底在 消费者 创建 还是 在 生产者 创建 如果 a 项目 和 b 项目 有 相互 发送 和 接收 消息 应该 创建 几个 vhost 几个 exchange 交换机 和 队列 实际上 是 作为 资 源由 运 维 管理员 创建 的 为什么 仍然 需 要在 代码 中 定义 重复 创建 不 报错 吗 配置文件 与 命名 规范 元 数据 的 命名 集中 放在 properties 文件 中 不 要用 硬 编码 如果有 多个 系统 可以 配置 多个 xxxmqproperties 命名 体现 元 数据 的 类型 虚拟机 命名 xxxvhost 交换机 命名 xxxexchange 队列 命名 queue 命名 体现 数据 来源 和 去向 例如 销售 系统 发往 产品 系统 的 交换机 做到 见 名 知 义 不 用去 查 文档 当然 注释 是 必不可少 的 调用 封 装在 项 目中 可 以对 template 做 进一步 封装 简化 消息 的 发送 例如 如果 交换机 路由 键 是 固 固定 的 封装 之后 就只 需要 一个 参数 消息 内容 另外 如果 想要 平滑 地 迁移 不同 的 mq 如果有 这种 需求 的话 也 可以 再做 一层 简单 的 封装 yktsendmsg jmstemplatesend destinationmsg 这时 如果 要把 activemq 替 换为 rabbitmq 只需要 修改 gpsendmsg 信息 落 库 定时 任务 将 需要 发送 的 消息 保存 在 数据库 中 可以 实现 消息 的 可追溯 和 重复 控制 需要 配合 定时 任务 来 实 现将 需要 发送 的 消息 登 记在 消息 表 中 定时 任务 一分钟 或 半分钟 扫描 一次 将 未 发送 的 消息 发送到 mq 服务器 并且 修改 状态 为 已 发送 如果 需要 重发 消息 将 指定 消息 的 状态 修 改为 未 发送 即可 副作用 降低 效率 浪费 存储空间 生产 环境 运 维 监控 虽然 rabbitmq 提供 了 一个 简单 的 管理 界面 但是 如果 对于 系统 性能 高 可用 和 其他 参数 有 一些 定制 化 的 监控 需求 的话 我们 就需要 通过 其他 方式 来 实现 监控 了 主要 关注 磁盘 内存 连接数 日志 追踪 rabbitmq 可以 通过 firehose 功 能来 记录 消息 流入 流出 的 情况 用于 调试 排错 它是 通过 创建 一个 topic 类型 的 交换机 把 生产者 发送给 broker 的 消息 或者 broker 发送给 消费者 的 消息 发到 这个 默认 的 交换机 上面 来 实现 的 另外 rabbitmq 也 提供 了 一个 firehose 的 gui 版本 就是 tracing 插件 启用 tracing 插件 后 管理 界面 右侧 选项卡 会 多 一个 tracing 可以 添加 相应 的 策略 rabbitmq 还 提供 了 其他 的 插件 来 增强 功能 如何 减少 连接数 在 发送 大批量 消息 的 情况下 创 建和 释放 连接 依然 有 不小 的 开销 我们 可以 跟 接 收方 约定 批量 消息 的 格式 比如 支持 json 数组 的 格式 通过 合并 消息 内容 可以 减少 生产者 消费者 与 broker 的 连接 比如 活动 过后 要 全 范围 下线 产品 通过 excel 导入 模板 通常 有 几万 到 几十 万条 解 绑 数据 合并 发送 的 效率 更高 建议 单 条 消息 不要 超过 mkb 一次 发送 的 消息 数 需要 合理地 控制 黄金 手机店 address 黄金 路 号 merchname 银 星 手机店 address 银 星 路 号 merchname 青铜 手机店 address 青铜 路 号 rabbitmq 高频 面试题 总汇 消息 队列 的 作用 与 使用 场景 异步 批量 数据 异步 处理 例 批量 上传 文件 比如 代发 代 扣 文件 削 峰高 负载 任务 负载 均衡 例 电 商 秒杀 抢购 解 耦 串行 任务 并行 化 例 退货 流程 解 耦 广播 基于 pubsub 实现 一对 多 通信 channel 和 vhost 的 作用 是什么 channel 减少 tcp 资源 的 消耗 也是 最 重要 的 编程 接口 vhost 提高 硬件 资源 利用率 实现 资源 隔离 rabbitmq 的 消息 有 哪些 路由 方式 适 合在 什么 业务 场景 使用 交换机 与 队列 队列 与 消费者 的 绑定 关系 是 什么样 的 多个 消费者 监听 一个 队列 时 比如 一个 服务 部署 多个 实例 消息 会 重复 消费 吗 多 对 多 轮询 平均 分发 无法 被 路由 的 消息 去了 哪里 直接 丢弃 可用 备份 交换机 接收 如果 没有 任何 设置 无法 路由 的 消息 会被 直接 丢弃 无法 路由 的 情况 routingkey 不正确 解决方案 使用 mandatorytrue 配合 returnlistener 实现 消息 回 发声明 交换 机时 指定 备份 交换机 消息 在 什么时候 会 变成 deadletter 死信 消息 被 拒绝 并且 没有 设置 重新 入队 nackreject 消息 过期 消息 或者 队列 的 ttl 设置 消息 堆积 并且 队列 达到 最大 长度 先 入队 的 消息 会 变成 dl 可以 在 声明 队列 时 指定 一个 来 实现 deadletter 的 转发 如果 一个 项目 要从 多个 服务器 接收 消息 怎么做 如果 一个 项目 要 发送 消息 到 多个 服务器 怎么做 定义 多个 注入 到 消费者 监听 类 如何 实现 延迟 队列 利用 ttl 队列 的 消息 存活 时 间或 消息 存活 时间 加上 死信 交换机 当然 还有 一种 方式 就是 先 保存 消息 到 数据库 用 调度 器 扫描 发送 时间 不够 精准 哪些 情况 会 导致 消息 丢失 怎么 解决 哪些 情况 会 导致 消息 重复 怎么 解决 从 消息 发送 的 整个 流程 来 分析 一个 队列 最多 可以 存放 多少 条 消息 由 硬件 决定 可以用 队列 的 xmaxlength 最大 消息 数来 实现 限流 吗 例如 秒杀 场景 不能 因为 会 删除 先 入队 的 消息 不公平 如何 提高 消息 的 消费 速率 创建 多个 消费者 amqptemplate 和 rabbittemplate 的 区别 springamqp 是 spring 整合 amqp 的 一个 抽象 springrabbit 是 一个 实现 如何 保证 消息 的 可靠性 投递 确保 投递 到 服务端 broker 保证 正确地 路由 消息 的 持久 化 存储 消费者 应答 ack 消费 者回 调 补偿 机制 springamqp 中 消息 怎么 封装 用 什么 转换 如何 保证 消息 的 顺序 性 一个 队列 只有 一个 消费者 rabbitmq 的 集群 节点 类型 磁盘 节点 和 内存 节点 如何 保证 rabbitmq 的 高 可用 大量 消息 堆积 怎么办 重启 不是 开玩笑 的 多 创建 几个 消费者 同时 消 直接 清空 队列 重发 消 rabbitmq 的 集群 模式 和 集群 节点 类型 集群 模式 有 两种 普通 模式 默认 模式 以 两个 节点 rabbitrabbit 为 例 来 进行 说明 对于 queue 来说 消息 实体 只 存在于 其中 一个 节点 rabbit 或者 rabbitrabbit 和 rabbit 两个 节点 仅有 相同 的 元 数据 即 队列 的 结构 当 消息 进入 rabbit 节点 的 queue 后 consumer 从 rabbit 节点 消 费时 rabbitmq 会 临时 在 rabbitrabbit 间 进行 消息 传输 把 a 中 的 消息 实体 取出 并 经过 b 发送给 consumer 所以 consumer 应 尽量 连接 每一个 节点 从中 取 消息 即 对于 同一个 逻辑 队列 要在 多个 节点 建立 物理 queue 否则 无论 consumer 连 rabbit 或 rabbit 出口 总在 rabbit 会 产生 瓶颈 当 rabbit 节点 故障 后 rabbit 节点 无法 取到 rabbit 节 点中 还未 消费 的 消息 实体 如果 做了 消息 持久 化 那么 得 等 rabbit 节点 恢复 然后 才 可被 消费 如果 没有 持久 化 的话 就会 产生 消息 丢失 的 现象 镜像 模式 把 需要 的 队列 做成 镜像 队列 存在 与 多个 节点 属于 rabbitmq 的 ha 方案 该 模式 解决 了 普通 模式 中 的 问题 其实质 和 普通 模式 不同之处 在于 消息 实 体会 主动 在 镜像 节点 间 同步 而 不是 在 客户端 取 数据 时 临时 拉 取 该 模式 带来 的 副作用 也 很明显 除了 降低 系统 性能 外 如果 镜像 队列 数量 过多 加之 大量 的 消息 进入 集群 内部 的 网络带宽 将会 被 这种 同步 通讯 大大 消耗掉 所以 在对 可靠 性要求 较高 的 场合 中 适用 节点 分为 两种 内存 ram 保存 状态 到 内存 但 持久 化 的 队列 和 消息 还是 会 保 存到 磁盘 磁盘 节点 保存 状态 到 内存 和 磁盘 一个 集群 中 至少 需要 需要 一个 磁盘 节点 多个 消费者 监听 一个 队列 时 消息 如何 分发 roundrobin 轮询 默认 的 策略 消费者 轮流 平均 地 收到 消息 fairdispatch 公平 分发 如果 要 实现 根据 消费者 的 处理 能力 来 分发 消息 给 空闲 的 消费者 发送 更多 消息 可以用 basicqos 来 设置 prefetchcount 的 含义 当 消费者 有 多少 条 消息 没有响应 ack 时 不再 给 这个 消费者 发送 消息 如 何在 服务端 和 消费 端 做 限流 网关 接入 层 其他 限流 方式 服务端 broker 配置文件 中 内存 和 磁盘 的 控制 队列 长度 无法 实现 限流 消费 端 prefetchcount 如何 保证 消息 的 顺序 性 比如 新增 门店 绑定 产品 激活 门店 这种 对 消息 顺序 要求 严格 的 场景 一个 队列 只有 一个 消费者 的 情况下 才能 保证 顺序 否则 只能 通过 全局 id 来 实现 每条 消息 有 一个 msgid 关联 的 消息 拥有 同一个 parentmsgid 可以 在 消费 端 实现 前 一条 消息 未 消费 不 处理 下一 条 消息 也 可以 在 生产 端 实现 前 一条 消息 未处理 完毕 不发 布下 一条 消息 消息 幂 等 性 首先 broker 本身 没有 消息 重复 过滤 的 机制 生产者 方面 可 以对 每条 消息 生成 一个 msgid 以此 控制 消息 重复 投递 消息 属性 messageid stringvalueof uuidrandomuuid build 发送 消息 消费者 方面 消息 体 比如 json 报 文中 必须 携带 一个 业务 id 比如 银行 的 交易 流水号 消费者 可以 根据 业务 id 去 重 避免 重复 消费 多个 消费者 监听 一个 队列 时 消息 如何 分发 roundrobin 轮询 默认 的 策略 消费者 轮流 平均 地 收到 消息 fairdispatch 公平 分发 如果 要 实现 根据 消费者 的 处理 能力 来 分发 消息 给 空闲 的 消费者 发送 更多 消息 可以用 basicqos 来 设置 prefetchcount 的 含义 当 消费者 有 多少 条 消息 没有响应 ack 时 不再 给 这个 消费者 发送 消息 