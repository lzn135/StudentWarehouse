彻底 弄懂 jvm 常量 池 文章 目录 一 绪论 class 文件 常量 池 字符串 常量 池 为什么 产生 字符串 常量 池 与 字符串 驻留 stringintern 字符串 常量 池 位置 字符串 常量 池内 存储 的 是什么 运行时 常量 池 class 文件 常量 池 和 运行时 常量 池 一 绪论 注 本文 提到 的 jvm 都是 hotspotclass 文件 常量 池 java 源代码 经过 编译 后 生成 class 文件 class 文件 中 除了 包含 类 的 版本 字段 方法 接口 等 描述 信息 外 还有 一项 信息 就是 常量 池 用于 存放 编译器 生成 的 各种 字面 量 literal 和 符号 引用 字面 量 就是 我们 所说 的 常量 概念 如 文本 字符串 被 声 明为 final 的 常 量值 等 符号 引 用是 一组 符号 来 描述 所 引用 的 目标 符号 可 以是 任何 形式 的 字面 量 只要 使 用时 能 无 歧义 地 定位 到 目标 即可 它与 直接 引用 区分 一下 直接 引用 一般 是 指向 方法 区 的 本地 指针 相对 偏移量 或是 一个 能 间接 定位 到 目标 的 句柄 图片 引用 自 理解 归纳 方法 区 和 常量 池 字符串 常量 池 为什么 产生 字符串 常量 池 与 字符串 驻留 字符串 驻留 stringinterning 是 字符串 常量 池 产生 的 根本原因 大意 如下 所谓 字符串 驻留 是 指在 系统 中 对 每个 字面 量 唯一 的 字符串 都 只 保留 唯一 的 一份 副本 称作 驻留 量 intern 并且 它们 都是 不 可变 的 这些 彼此 不同 的 字符串 被 存储 在 字符串 常量 池中 各 编程 语言 有 各自 的 方法来 取得 字符串 常量 池中 的 驻留 量 或者 将 一个 字符串 驻留 比如 java 中 的 stringintern 在 java 中所 有 编译 期 能 确定 的 字符串 也 都会 自动 驻留 不仅 字符串 可以 驻留 例 如在 java 中区 间内 的 integer 被 缓存 在内 部类 integercache 中 这个 类 就 相当于 整形 常量 池 在 该区 间内 两个 数值 相同 的 整形 值 在 自动 装箱 后 实际上 指向 堆 内 的 同一个 integer 对象 也 就是 驻留 量 可以 参考 integervalueof 方法 的 源码 字符串 驻留 是 设计 模式 中 的 享 元 模式 的 典型 实现 这里 就不 展开 描述 了 换句话说 存在 字符串 常量 池 主要 是为了 减少 内存 使用 并 提高 内存 中 现有 实例 的 重用 当 为 字符串 对象 分配 不同 的 值 时新 值 将 作为 单独 的 实例 注册 在 字符串 常量 池中 stringintern 在 jdk 中 stringintern 方法 是 一个 native 方法 这个 方法 是 干什么 的 呢 在 java 语言 中有 中 基本 类型 和 一种 比较 特殊 的 类型 string 这些 类型 为了 使 他们 在 运行 过程中 速度 更快 更 节省 内存 都 提供 了 一种 常量 池 的 概念 常量 池 就 类似 一个 java 系统 级别 提供 的 缓存 种 基本 类型 的 常量 池 都是 系统 协调 的 string 类型 的 常量 池 比较 特殊 它 的 主要 使用方法 有 两种 直接 使用 双引号 声明 出来 的 string 对象 会 直接 存储 在 常量 池中 如果 不是 用 双引号 声明 的 string 对象 可以 使用 string 提供 的 intern 方法 intern 方 法会 从 字符串 常量 池中 查询 当前 字符串 是否 存在 若不 存在 就 会将 当前 字符串 放入 常量 池中 字符串 常量 池 位置 在 jdk 中 驻留 字符串 不 再在 永久 代 上 分配 而是 在 java 堆 的 主要 部分 新生代 和 老 年代 分配 由此 可得 jdk 的 字符串 常量 池 位于 永久 代 它是 hotspot 的 方法 区 实现 到了 jdk 字符串 常量 池 就 直接 放在 堆 里 下面 用 深入 理解 java 虚拟机 第二 版 的 经典 例 子来 证明 它 产生 一个 无限 递增 的 数字 字符串 序列 并 依次 放进 字符串 常量 池 stringargs 使用 list 保持 引用 避免 常量 池 被 intiwhile true listadd stringvalueof i intern jvm 参数 统一 为 然后 分 别在 jdk 的 环境 下 运行 观察 输出 结果 k kgtk k k kgtk k k kgtk k k psoldgenkgtk k kgtk k pspermgenkgtk k k kgtk k k psoldgenkgtk k kgtk k pspermgenkgtk k nativemethod oomexamplejava k kgtk k k kgtk k k kgtk k k paroldgenkgtk k kgtk k pspermgenkgtk k k paroldgenkgtk k kgtk k pspermgenkgtk k k paroldgenkgtk k kgtk k pspermgenkgtk k k paroldgenkgtk k kgtk k pspermgenkgtk k k paroldgenkgtk k kgtk k pspermgenkgtk k integerjava stringjava oomexamplejava jdkjavahotspot tm tm psyounggenkgtk k kgtk k psyounggenkgtk k kgtk k psyounggenkgtk k kgtk k psyounggenkgtk k kgtk k ergonomics psyounggenkgtk k paroldgenkgtk k kgtk k metaspacekgtk k ergonomics psyounggenkgtk k paroldgenkgtk k kgtk k metaspacekgtk k ergonomics psyounggenkgtk k paroldgenkgtk k kgtk k metaspacekgtk k ergonomics psyounggenkgtk k paroldgenkgtk k kgtk k metaspacekgtk k ergonomics psyounggenkgtk k paroldgenkgtk k kgtk k metaspacekgtk k integerjava stringjava oomexamplejava 从 以上 输出 结果 可以 看出 jdk 报 永久 代 oom 证明 字符串 常量 池 确 实在 永久 代 jdk 和 均 报 超出 gc 临界 限制 在 hotspot 中 一旦 jvm 检 查到 用 以上 的 时间 来 gc 而回 收了 少于 的 堆 空间 就 会报 这个 错误 如果 使用 参数 来 关闭 检查 那么 一段时间 后 就会 抛出 常见 的 javalangout 这 证明 字符串 常量 池 确实 移动 到了 堆 中 jdk 还 会报 设置 永久 代 的 参数 无效 这是 因为 jdk 已经 完全 移 除了 永久 代 改用 元 空间 metaspace 来 实现 方法 区 了 在 gc 日志 中 也 可以 看到 metaspacegc 的 情况 问 为什么 字符串 常量 池 要从 永久 代 移 动到 堆 并且 后来 永久 代 还被 元 空间 替代 了 答 永久 代 作为 hotspot 方法 区 的 实现 很不 好用 并且 其他 jvm 实现 都没有 永久 代 字符串 常量 池 在 堆 中 可以获得 更大 的 内存空间 根据 java 虚拟机 规范 的 规定 方法 区 存储 了 每一个 类 的 结构 信息 例如 运行时 常量 池 字段 和 方法 数据 构造 函数 和 普通 方法 的 字节 码 内容 等等 虽然 方法 区 是 堆 的 逻辑 组成部分 但是 简单 的 虚拟机 实现 可以 选择 在 这个 区域 不做 gc 与 压 缩在 hotspot 中 方法 区 是 存在 gc 的 就是 堆 空间 的 分 代 gc 直接 扩展 过来 由于 方法 区内 的 数据 相对于 新生代 和 老 年代 来讲 更 静态 一些 为了 保持 命名 一致性 才 把 这里 叫做 永久 代 永久 代 的 不好用 主要 体现在 它 难以 调控 它 的 内存大小 是 由 xxpermsize 和 xxmaxpermsize 两个 参数 定死 的 如果 设定 得 太小 当 常量 池 过大 或者 动态 加载 类 的 元 数据 过 多时 就会 直接 oom 如果 设定 得 太 大会 挤占 原本 可 用于 堆 的 空间 也 会 增大 gc 的 压力 另 外在 jdk 时代 就 开始 推动 hotspot 与 jrockit 两套 虚拟机 的 融合 而 jrockit 是 不存在 永久 代 的 因此 hotspot 最后 也 取 消了 它 新 加入 的 元 空间 则 位于 本地 内存 nativememory 中 消 除了 原来 的 大小 限制 变得 更加 灵活 关于 元 空间 的 更多 细节 就不 展开 请 参见 这里 metaspaceinjava 字符串 常量 池内 存储 的 是什么 这个 问题 因为 不容易 验证 经常 引起 争吵 来看 下面 一段 代码 stringargs a sintern ss ss 这段 代码 在 jdk 执行 输出 falsefalse 但在 jdk 执行 输出 falsetrue 根据 结果 的 不同 可以 推测 出 字符串 常量 池内 的 存储 也 发 生了 变化 借助 processon 画图 详细分析 一下 jdk 在 语 句中 创 建了 多少个 对象 这是 面试 中极 常见 的 问题 答案 是 个 堆 中 及 字符串 常量 池中 各 一个 由于 a 是 字面 量 因此 它会 自动 驻留 语句 调用 intern 时 字符串 常量 池 中就 已经 存在 它 了 语句 会 直接 找到 常量 池中 的 a 故 s 与 s 的 引用 地址 是 不同 的 语 句中 s 引用 的 字符串 的 值 不能 在 编译 期 确定 因此 生 成了 一个 新 的 string 对象 使用 语句 调用 intern 时 常量 池里 还不 存在 aa 将它 加入 进去 语句 也 会 直接 找到 常量 池中 的 aa 故 s 与 s 的 引用 地址 也是 不同 的 jdk 语句 的 执行 结 果与 上面 相同 不再 赘述 而 执行 完 后为 什么 会 返回 true 既然 运算符 比较 的 是 引用 类型 的 地址 那么 只能 说明 s 和 s 的 引用 地址 是 一样 的 因此 上面 的 图 应该 做一个 改动 语句 在 执 行时 堆 中 存在 string 对象 aa 但 常量 池中 没有 这时 不 再像 jdk 一样 将 对象 加入 常量 池 而是 将对 aa 的 引用 加入 该 引用 与 s 引用 的 对象 都是 堆 中 的 同一个 string 对象 这样 语句 在 常量 池中 找到 aa 时 实际上 是 找 到了 与 s 相同 的 引用 所以 ss 是 成立 的 结论 在 jdk 中 字符串 常量 池里 保存 的 都是 string 对象 在 jdk 中 对于 字符串 字面 量 当然 也 包括 常量 表达式 常量 池里 会 直接 保存 string 对象 如果是 编译 期 不能 确定 的 字符串 调用 intern 方法 会 使得 常量 池中 保存 对 堆 内 string 对象 的 引用 而 不会在 常量 池内 再 生成 一个 对象 之所以 做 这种 改动 可能是 考虑到 字符串 常量 池 已经 移动 到了 堆 中 因此 没有必要 在 池内 和 池 外 各 保留 一个 对象 这样 节省 空间 引用 深入 解析 stringinternjvm 字符串 常量 池 及 相关 知识 的 再 探究 运行时 常量 池 当 java 文件 被 编译成 class 文件 之后 也 就是 会 生成 我 上面 所说 的 class 常量 池 那么 运行时 常量 池 又是 什么时候 产生 的 呢 jvm 在 执行 某个 类 的 时候 必须 经过 加载 连接 初始化 而 连接 又 包括 验证 准备 解析 三个 阶段 而 当 类 加 载到 内存 中 后 jvm 就 会将 class 常量 池中 的 内容 存 放到 运行时 常量 池中 由此可知 运行时 常量 池 也是 每个 类 都有 一个 在上面 我 也 说了 class 常量 池中 存 的 是 字面 量 和 符号 引用 也就是说 他们 存 的 并不是 对象 的 实例 而是 对象 的 符号 引用 值 而 经过 解析 resolve 之后 也 就是 把 符号 引用 替 换为 直接 引用 解析 的 过程 会去 查询 全局 字符串 池 也 就是 我们 上面 所说 的 stringtable 以 保证 运行时 常量 池 所 引用 的 字符串 与 全局 字符串 池 中所 引用 的 是 一致 的 如图所示 虚拟机 栈 每一个 栈 帧 都有 一个 指向 运行时 常量 池 的 引用 该 引用 指向 针对 该 帧 正在 执行 的 方法 的 类 的 常量 池 引用 自 文件 常量 池 和 运行时 常量 池 class 文件 常量 池 存储 的 是 当 class 文件 被 java 虚拟机 加载 进来 后 存放在 方法 区 的 一些 字面 量 和 符号 引用 字面 量 包括 字符串 基本 类型 的 常量 引用 自 字符串 常量 池 class 常量 池 和 运行时 常量 池 