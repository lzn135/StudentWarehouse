译 apt 分析 报告 09. 伊朗 apt34 更新 武器库 sidetwist 变体 这是 作者 新开 的 一个 专栏 主要 翻译 国外 知名 安全 厂商 的 apt 报告 了解 它们 的 安全 技术 学习 它们 溯源 apt 组织 和 恶意代码 分析 的 方法 希望 对 您 有所 帮助 当然 由于 作者 英语 有限 会 借助 机 翻 进行 校验 还请 包涵 前文 分享 了 checkpoint 公司 提出 的 一个 新技术 即 漏洞 利用 图谱 通过 查找 作者 的 指纹 来 寻找 利用 漏洞 这篇 文章 将 详细 讲解 伊朗 威胁 组织 apt 又名 oilrig 发起 的 一项 新 攻击 行动 该 行动 似乎是 针对 lebanese 的 一个 目标 使 用了 一种 新 的 后门 变体 我们 称之为 sidetwist 原文 标题 原文 链接 文章 作者 checkpoint 发布 时间 年月日 文章 来源 文章 目录 一 前言 二 初次 感染 三 带有 dns 隧道 的 恶意 宏 四 第二阶段 有效载荷 sidetwist 持久 化 persistence 初始化 五 cc 通信 命令 请求 通讯 命令 结果 通讯 加密 通讯 六 溯源 归因 文件 相似 度 cc 通信 相似 度 额外 apt 的 目标 七 结论 附录 aiocs 一 前言 checkpoint 研究院 发现了 伊朗 威胁 组织 aptoilrig 针对 黎巴嫩 目标 的 新 攻击 证据 该 攻击 采 用了 我们 称为 sidetwist 的 后门 新 变体 自从 年 apt 组织 泄漏 一个 名为 labdookhtegan 的 工具 以来 该 威胁 组织 一直在 积极地 改造 和 更新 其 有效载荷 库 从而 避免 被 检测 并 创 建了 几种 不同 的 恶意 软件 变体 其 最终 目的 仍然是 在 目标 设备 上 获得 初始 立足 寄生 目标 设备 从 年 的 dnspionage 活动 开始 就 已经 观察到 apt 通过 使用 诱骗性 寻找 工作 的 钓鱼 文件 作为 目标 该 文档 通过 linkedin 消息 直接 传 递给 选定 的 目标 个人 这项 攻击 活动 通过 hardpass 操作 一直 持续 到 年 并且 同样 使 用了 linkedin 平台 在年 月份 的 最新 活动 中 lebaneseapt 的 共同 目标 向 virustotal 提 交了 一份 文件 其中 也 描述 了 这样 一份 工作 钓鱼 文件 尽管 在 这种 情况下 我们 无法 确认 目标 的 最初 交付 机制 在下 面的 文章 中 我们 将 分析 攻击者 使用 的 最新 感染 链 并 深入研究 新 的 恶意 软件 变体 补充 dnspionage 攻击 活动 该 攻击 组织 使 用了 两个 虚假 的 恶意 网站 其中 托 管了 伪装成 招聘 文书 的 microsoftoffice 恶意 文档 文档 中 嵌入 用来 入侵 目标 用户 的 恶意 宏 我们 将 攻击者 所 使用 的 恶意 软件 标识 为 dnspionage 该 恶意 软件 能够 以 http 和 dns 协议 与 攻击者 通信 并且 通过 社交 平台 如 linkedin 来 传播 恶意 链接 使 这种 求职 攻击 更加 真实 恶意 样本 中 包含 的 宏 主要 执行 如下 两个 步骤 第一步 当 文档 打开 时 使用 base 解码 经过 编码 的 一个 pe 文件 然后 将其 释 放到 当前 系统 中 具体 路径 为 第二步 当 文档 关闭 时 将 svchostservdoc 重 命名为 svchostservexe 然后 创建 名为 的 计划任务 以便 执行 该 程序 计划任务 会 立即 执行 并且 每分钟 都会 重复 执行 同时 恶意 样本 通过 两个 步骤 来 规避 沙 盒 检测 一方面 只 有当 microsoftoffice 被 关闭 时 才会 执行 攻击 载荷 意味着 载荷 部署 过程中 需要 用户 交互 样本 中 包含 的 宏 同样 使用 密码保护 避免 用户 通过 microsoftoffice 查看 宏代码 另一方面 宏 还用 到了 经典 的 字符串 混淆 技术 来 规避 基于 字符串 的 检测 机制 宏 使用 拼接 方式 生成 scheduleservice 字符串 最终 攻击 载荷 是 一款 远程 管理工具 我们 将其 标识 为 会在 当前 运行 目录 中 生成 相关 数据 并 使用 http 及 dns 协议 来 与 c 服务器 通信 二 初次 感染 我们 的 分析 始于 一个 名为 jobdetailsdoc 的 恶意 microsoftword 文档 mdcbdede 图 带有 恶意 宏 的 钓鱼 文档 显然 这份 钓鱼 文档 试图 表现 得 像 一份 真实 的 求职 文档 提供 了 总部 位于 美国 弗吉尼亚州 的 ntivait 咨询 公司 的 各种 职位 但是 一旦 用户 激 活了 嵌入式 恶意 宏 就会 触发 恶意 行为 完整 的 感染 流程 如 下图 所示 图 感染 流程 三 带有 dns 隧道 的 恶意 宏 apt 在 钓鱼 求职 攻击 中 使用 的 宏 经 过了 多年 的 演变 并且 一直 设法 保持 自己 独特 的 风格 和 目的 包括 重点 知识 验证 是否 有 鼠标 连 接到 pc 防沙 盒 技术 对 目标 设备 进行 初始 指纹识别 并将 信息 发送到 c 服务器 将 扩展 名为 doc 的 嵌入式 可执行文件 放置 到 磁 盘上 稍后 将 更 名为 exe 注册 windows 计划任务 该 任务 将 每隔 x 分钟 启动 一次 可执行文件 图 由 vbagraph 生成 的 vba 函数 调用 图 注意 vbagraph 是 一款 通过 vba 代码 分析 恶意 软件 的 强大 工具 推荐 文章 在上 面的 宏 函数 调用 图中 我们 可以 从 documentopen 和 documentclose 函数 中 看到 对 dnsquery 外部 函数 的 多次 调用 apt 因其 在 许多 不同 的 工具 中 大量 使用 dns 隧道 而 臭名昭著 这一次 该 功能 也 被 放进 入了 最初 的 宏 阶段 一旦 宏 被执行 dns 请求 就被 用来 指向 攻击者 并 告知 他们 当前 的 执行 阶段 以及 传递 一些 受害者 可 识别 的 信息 图 来自 恶意 宏 的 代码 段 负责 发送 dns 查询 在此 步骤 中 攻击者 正在 使用 公开 可用 的 隧道 服务 以 获取 有关 宏 感染 进度 的 更新 这样 攻击者 拥有 的 基础设施 就不会 暴露 出来 以防 沙箱 无法 完全 引爆 文档 以下 是 攻击者 在 requestbinnet 网 站上 看到 的 信息 演示 其中 受害者 在 以下 环境 下 的 系统 中 执行 恶意 宏 用户名 john 主机名 johnpc 图 在 requestbinnet 上 显示 的 宏 请求 源 ip 地址 和 时间 戳 已 编辑 编码 后 的 数据 是 通过 以下 方式 从 pc 信息 导出来 的 图 编码 的 dns 数据 四 第二阶段 有效载荷 sidetwist 这个 阶段 的 后门 是 我们 在 以前 的 apt 操作 中 从未见过 的 变体 但 提供 了 类似于 和 tonedeaf 等 其他 基于 c 语言 的 后门 的 简单 功能 后门 的 功能 包括 下载 上传 执行 shell 命令 持久 化 persistence 在 这个 感染 链 中 持久性 实际上 是 由 第一阶段 的 宏 建立 的 而 第二阶段 的 有效载荷 payload 没有 任何 自己 的 持久性 机制 持久 化 是 在 注册 调度 任务 时 的 第一阶段 实现 的 名为 的 计划任务 将 每分钟 执行 第 阶段 有效载荷 图 受 感染 机器 上 的 计划任务 后门 非常 依赖于 这种 持久性 机制 因为 每次 启动 后门 时 它 只会 执行 从 cc 服务器 提供 的 单个 命令 并 立即 关闭 直到 由 计划任务 再次 启动 为止 初始化 该 后门 首先 收集 有关 受害者 计算机 的 基本信息 然后 根据 目标 环境 的 用户名 计算 机名 和 域名 计算 一个 字节 长 的 受害者 标识符 此 标识符 将在 后续 cc 通信 中 使用 图 收集 可 识别 信息 的 代码 接下来 恶意 软件 将 验证 本 应在 感染 第一阶段 创建 的 updatexml 文件 确实 存在 如果 不存在 它将 自己 终止 使用 函数 将以 下 文本 打 印到 调试 输出 图 用于 验证 是否 已 执行 第一阶段 的 代码 因 为此 功能 的 目的 是 打印 调试 信息 所以 仅在 应用程序 的 调试 过程中 普通用户 是 看不到 该 文本 的 五 cc 通信 后门 与 cc 服务器 sarmsoftwarecom 的 通信 是 基于 端口 的 http 协议 回退 端口 是 后门 使用 两种 不同 的 技术 来 与 campc 服务器 进行 传出 和 传入 通信 尽管 在这 两种 情况下 使 用了 相同 的 加密算法 请参阅 下面 有关 加密 的 更多 内容 命令 请求 通讯 后门 使用 get 请求 通过 以下 url 与 cc 服务器 联系 这个 请求 的 响应 隐藏 在下 面的 flickr 页面 的 源代码 中 图 用作 cc 的 fakeflickr 相似 页面 这个 响应 以下 面的 格式 返 回到 html 代码 后门 中 图 代码 中 嵌入 的 cc 命令 在对 该 base 字符串 进行 解码 和 解密 之后 明文 内容 采用 以下 管道 分隔 格式 图 加密 的 数据格式 命令 数字 commandnumber 一个 运行 索 引号 用来 跟踪 执行命令 如果 设置 为 以外 的 任何 数字 后门 应该 根据 命令 id 继续 执行 该 命令 否则 忽略 并 终止 命令 idcommandid 可以 是 以下 命令 之一 shell 命令 执行 附 加在 arg 参数 中 的 shell 命令 下载 文件 下载 一个 文件 该 文件 可以 arg 在 服务器 的 路径 上 找到 并 使用 arg 名称 保 存在 磁 盘上 上传 文件 上传 本地 文件 arg 到 服务器 shell 命令 副本 执行 附 加在 arg 参数 中 的 shell 命令 命令 结果 通讯 后门 在 受害人 的 机器 上 执 行了 任意 命令 后 会将 执行 后 的 命令 的 结果 返 回到 cc 服务器 并 返 回到 与 以前 相同 的 url 但是在 post 请求 中 而 不是 get 中 当 后门 在 受害者 的 机器 上 执 行了 任意 命令 后 它将 执行命令 的 结果 返回 给 campc 服务器 返 回到 之前 相同 的 url 但 使用 的 是 post 请求 而 不是 正文 的 格式 是 一个 简单 的 json 基于 campc 服务器 提供 的 命令 编号 和 命令 执行 的 加密 结果 图 结果 数据格式 加密 通讯 攻击者 利用 mersennetwister 伪 随机数 生成器 作为 加密 通信 的 基础 每个 加密 消息 的 第一 个个 字节 是 mersennetwister 的 种子 用于 解密 消息 的 其余部分 可以 使用 以下 python 代码 段 对 加密 的 base 通信 进行 解密 defdecode msg bsbasebdecode msg bsbyteorderbig rngmersennerng seed keyinttobytes decjoin chr bsikey i foriinrange len bs returndec 六 溯源 归因 无论是 恶意 宏 后门 目标 攻击 还是 在这次 操作 中 使用 的 技术 都与 之前 报告 的 归因于 apt 的 活动 一致 文件 相似 度 除了 像 以前 的 apt 操作 一样 我们 再次 看到 求职 文件 被 用来 鼓励 受害者 启用 宏 并且在 技术上 也有 相似之处 在 之前 的 dnspionage 战役 中 出现 了 相同 的 变量 beacher 图 在 旧版本 宏代码 中 存在 类似 的 变量名 宏 的 主要功能 与 以前 的 apt 活动 一样 恶意 宏 使用 mouseavailable 函 数来 逃避 检测 并 创建 一个 计划任务 来 执行 嵌入 在 文档 中 的 有效 负载 cc 通信 相似 度 众所周知 apt 的 后门 dnspionage 和 tonedeaf 会 通过 搜索 隐 藏在 合法 网站 html 内容 中 的 特定 模式 来接 收 服务器 发出 的 命令 在 我们 的 案例 中 攻击者 使 用了 一个 类似 flickr 的 页面 而在 之前 的 活动 中 使用 的 是 githubwikipedia 和 额外 apt 的 目标 在 分析 上述 活动 时 恶意 软件 研究人员 将 这些 文件 和 其他 与 apt 相关 的 文件 上 传到 virustotal 并在 twitter 上 注明 这些 文档 在 初始 宏 中使 用了 相同 的 隧道 服务 并 交 付了 该 组织 的 另一个 签名 工具 基于 net 的 名为 karkoff 的 后门 的 变种 它 利用 internet 面向 exchange 服务器 作为 与 攻击者 的 通信 方法 这些 新发现 的 安全 人员 强 调了 apt 正 在对 中东 特别是 lebanon 的 目标 发动 进攻 的 程度 karkoff 植入物 mdabcdfeccfbe 包括 一个 属于 的 交换 服务器 的 凭证 可能 表明 其 网络 长期 处于 受损 状态 七 结论 伊朗 支持 的 apt 没有 任何 放缓 的 迹象 并 持续 关注 lebanon 发起 网络 攻击 行动 如 上文 所述 在 维持 惯常 的 操作 方式 并重 用旧 技术 的 同时 该 小组 继续 创 建和 更新 工具 以 最大 程度 地 减少 安全 供应商 对 其 工具 的 可能 检测 在这 篇文章 中 我们 分析 了 该 组织 正在进行 的 求职 钓鱼 攻击 行动 部署 的 最新 后门 变种 其中 包括 带有 工作 机会 的 恶意 文档 这是 他们 至少 自 年 以来 成功 采用 的 一种 技术 可以 抵御 这种 apt 攻击 并从 一开始 就 阻止 它 一 前言 二 初次 感染 三 带有 dns 隧道 的 恶意 宏 四 第二阶段 有效载荷 sidetwist 持久 化 persistence 初始化 五 cc 通信 命令 请求 通讯 命令 结果 通讯 加密 通讯 六 溯源 归因 文件 相似 度 cc 通信 相似 度 额外 apt 的 目标 附录 aiocs 恶意 文档 后门 服务器 sarmsoftwarecom 前文 分享 译 apt 分析 报告 linux 系统 下 针对性 的 apt 攻击 概述 译 apt 分析 报告 钓鱼 邮件 网址 混淆 url 逃避 检测 译 apt 分析 报告 opblueraven 揭露 apt 组织 fincarbanak 上 tirion 恶意 软件 译 apt 分析 报告 kraken 新型 无 文件 apt 攻击 利用 windows 错误报告 服务 逃避 检测 译 apt 分析 报告 turla 新型 水坑 攻击 后门 netflash 和 pyflash 译 apt 分析 报告 猖獗 的 小猫 针对 伊朗 的 apt 攻击 活动 详 解译 apt 分析 报告 拉 撒 路 lazarus 使用 的 两款 恶意 软件 分析 译 apt 分析 报告 漏洞 利用 图谱 通过 查找 作者 的 指纹 来 寻找 漏洞 译 apt 分析 报告 伊朗 apt 更新 武器库 sidetwist 变体 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 逆向 分析 apt 分析 报告 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 星期 二晚 上点 写 于 武汉 参考文献 针对 中东 的 攻击 活动 