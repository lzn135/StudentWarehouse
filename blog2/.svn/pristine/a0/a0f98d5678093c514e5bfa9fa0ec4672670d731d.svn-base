系统安全 二十六 wannacry 勒索 病毒 分析 2 ms17-010 漏洞 利用 及 蠕虫 解析 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 作者 前文 采用 github 资源 实现 永恒 之 蓝 漏洞 加载 wannacry 勒索 病毒 并 实现 对 win 文件 加密 的 过程 但 过程 较为 复杂 为什么 不 直接 利用 永恒 之 蓝 呢 所以 这篇 文章 将 直接 分享 msf 利用 ms 漏洞 进行 反弹 shell 再 上传 勒索 病毒 进行 实验 复现 并 详细 讲解 wannacry 勒索 病毒 的 原理 基础性 文章 希望 对 您 有所 帮助 作者 作为 网络安全 的 小白 分享 一些 自学 基础教程 给 大家 主 要是 关于 安全 工具 和 实践 操作 的 在线 笔记 希望 您们 喜欢 同时 更 希望 您能 与我 一起 操 作和 进步 后续 将 深入 学习 网络安全 和 系统安全 知识 并 分享 相关 实验 总之 希望 该 系列 文章 对 博 友 有所 帮助 写 文 不易 大神 们 不 喜 勿 喷 谢谢 如果 文章 对 您有 帮助 将是 我 创作 的 最大 动 力点 赞 评论 私聊 均可 一起 加油 喔 文章 目录 一 wannacry 背景 二 wannacry 实验 复现 实验 环境 搭建 kali 利用 ms 反弹 shell 三 防御 措施 四 wannacry 病毒 分析 母体 程序 mssecsvcexe 行为 分析 taskscheexe 行为 分析 程序 分析 五 wannacry 病毒 检测 六 总结 作者 的 github 资源 逆向 分析 网络安全 从 年月 开始 我 来 到了 一个 陌生 的 专业 网络空间 安全 初 入 安全 领域 是 非常 痛苦 和 难受 的 要 学 的 东西 太多 涉及面 太 广 但 好在 自己 通过 分享 篇 网络安全 自学 系列 文章 艰难 前行 着 感恩 这一 年 相识 相知 相 趣 的 安全 大佬 和 朋友们 如果 写得 不好 或 不足之处 还请 大家 海涵 接下来 我 将 开启 新 的 安全 系列 叫 系统安全 也是 免费 的 篇文章 作者 将 更加 深入 的 去 研究 恶意 样本 分析 逆向 分析 内网 渗透 网络 攻防 实战 等 也 将 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 加油 推荐 前文 网络安全 自学 篇 系列 篇 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 系统安全 八 windows 漏洞 利 用之 cve 复现 及 蓝屏 攻击 系统安全 九 windows 漏洞 利 用之 ms 远程 代码 执行 漏洞 复现 及 深度 提 权 系统安全 十 windows 漏洞 利 用之 smbv 服务 远程 代码 执行 漏洞 cve 复现 系统安全 十一 那些 年 的 熊猫 烧香 及 pe 病毒 行为 机理 分析 系统安全 十二 熊猫 烧香 病毒 ida 和 od 逆向 分析 上 病毒 初始化 系统安全 十三 熊猫 烧香 病毒 ida 和 od 逆向 分析 中 病毒 释放 机理 系统安全 十四 熊猫 烧香 病毒 ida 和 od 逆向 分析 病毒 释放 过程 下 系统安全 十五 chrome 浏览器 保留 密码 功能 渗透 解析 蓝屏 漏洞 及 某 音乐 软件 漏洞 复现 系统安全 十六 pe 文件 逆向 基础知识 pe 解析 pe 编辑 工具 和 pe 修改 系统安全 十七 windowspe 病毒 概念 分类 及 感染 方式 详解 系统安全 十八 病毒 攻防 机理 及 winrar 恶意 劫持 漏洞 脚本 病毒 自启动 定时 关机 蓝屏 攻击 系统安全 十九 宏病毒 之 入门 基础 防御 措施 自发 邮件 及 apt 宏 样本 分析 系统安全 二十 pe 数字签名 之 上 什么 是 数字签名 及 signtool 签名 工具 详解 系统安全 二十一 pe 数字签名 之 中 工具 用法 系统安全 二十二 pe 数字签名 之 下 微软 证书 漏洞 cve 复现 及 windows 验证 机制 分析 系统安全 二十三 逆向 分析 之 ollydbg 动态 调试 复习 及 traceme 案例 分析 系统安全 二十四 逆向 分析 之 ollydbg 调试 int 断点 反 调试 硬件 断点 与 内存 断点 系统安全 二十五 wannacry 勒索 病毒 分析 python 复现 永恒 之 蓝 漏洞 实现 勒索 加密 系统安全 二十六 wannacry 勒索 病毒 分析 ms 漏洞 利用 及 病毒 解析 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 该 样本 不会 分享 给 大家 分析 工具 会 分享 参考文献 见 后 一 wannacry 背景 年月日 wannacry 蠕虫 通过 永恒 之 蓝 ms 漏洞 在 全球 范围 大 爆发 感染 大量 的 计算机 wannacry 勒索 病毒 全球 大 爆发 至少 个 国家 万名 用户 中招 造成 损失 达 亿 美元 已 影响 金融 能源 医疗 教育 等 众多 行业 造成 严重 的 危害 wannacry 是 一种 蠕虫 式 勒索 病毒软件 由 不法分子 利用 nsa 泄露 方程式 工具包 的 危险 漏洞 eternalblue 永恒 之 蓝 进行 传播 该 蠕虫 感染 计算机 后会 向 计算机中 植入 敲诈者 病毒 导致 电脑 大量 文件 被 加密 wannacry 利用 windows 系统 的 smb 漏洞 获取 系统 的 最高 权限 该 工具 通过 恶意代码 扫描 开放 端口 的 windows 系统 被 扫 描到 的 windows 系统 只要 开机 上线 不需要 用户 进行 任何 操作 即可 通过 共享 漏洞 上传 wannacry 勒索 病毒 等 恶意程序 wannacry 利用 永恒 之 蓝 漏洞 进行 网络 端口扫描 攻击 目标 机器 被 成功 攻陷 后会 从 攻击机 下载 wannacry 木马 进行 感染 并 作为 攻击机 再次 扫描 互联网 和 局域网 的 其他 机器 行 成 蠕虫 感染 大范围 超 快速 扩散 木马 母体 为 mssecsvcexe 运行 后会 扫描 随机 ip 的 互联网 机器 尝试 感染 也 会 扫描 局域网 相同 网段 的 机器 进行 感染 传播 此外 会 释放 敲诈者 程序 taskscheexe 对 磁盘 文件 进行 加密 勒索 木马 加密 使用 aes 加密 文件 并 使用 非对称 加密算法 rsa 加密 随机 密钥 每个 文件 使用 一个 随机 密钥 理论上 不可 攻破 同时 显示 勒索 界面 其 核心 流程 如 下图 所示 wannacry 勒索 病毒 主要 行为 是 传播 和 勒索 传播 利用 基于 端口 的 smb 漏洞 ms 永恒 之 蓝 进行 传播 勒索 释放 文件 包括 加密器 解密器 说明 文件 语言 文件 等 内存 加载 加密器 模块 加密 执行 类型 文件 全部 加密 后 启动 解密器 解密器 启动 后 设置 桌面背景 显示 勒索 信息 弹出 窗口 显示 付款 账号 和 勒索 信息 二 wannacry 实验 复现 实验 环境 搭建 实验 环境 攻击机 kalilinuxip 受害 主机 win 位 ip 实验 工具 实验 步骤 配置 实验 环境 kali 检测 受害 主机 端口 smb 协议 是否 开启 运行 eternalblue 永恒 之 蓝 漏洞 ms 反弹 shell 上传 勒索 病毒 wcryexe 并 运行 实现 勒索 和 文件 加密 切记 切记 切记 实验 复现 过程中 必 须在 虚拟机 中 完成 运行 之前 关闭 虚拟机 win 文件 共享 真 机上 一旦 被 感染 你 就 真的 只能 想 哭了 wannacry 同时 该 实验 比上 一篇 文章 精简 很多 更 推荐 该 方法 仅 作 逆向 分析 使用 切勿 攻击 他人 否则 后果自负 第一步 创建 虚拟机 并 安装 windowsx 位 操作系统 win 设置 开启 端口 同时 关闭 防火墙 注意 关闭 虚拟机 文件 共享 功能 第二步 保证 攻击机 和 受害 机 相互 通讯 均在 同一个 局域网 中 kali 利用 ms 反弹 shell 第一步 扫描 靶机 是否 开启 端口 nmapss 第二步 打开 msfconsole 并 查询 ms 漏洞 模块 这里有 各种 ms 漏洞 版本 我们 根据 目标 系统 选择 编 号为 的 版本 推荐 读者 看看 nsa 泄露 的 方程式 工具包 其中 永恒 之 蓝 eternalblue 就是 著名 的 漏洞 第三步 利用 永恒 之 蓝 漏洞 并 设置 参数 利用 永恒 之 蓝 漏洞 设置 payloadsetlhost 设置 本机 ip 地址 setrhosts 设置 受害 主机 ipsetrport 设置 端口 注意 该 端口 共享 功能 是 高危 漏洞 端口 包括 之前 分享 的 等 exploit 利用 漏洞 第四步 成功 获取 win 系统管理员 权限 getuid 返回 系统管理员 权限 pwdls 查看 当前 路径 及 目录 第五步 上传 勒索 病毒 至 win 系统 再次 强调 虚拟机 中 运行 该 实验 并且 关闭 文件 共享 功能 第六步 运行 勒索 病毒 实验 复现 成功 运 行前 的 受害 主机 界面 如 下图 所示 运行 病毒 程序 后 的 界面 如 下图 所示 已经 成功 被 勒索 再次 强调 所有 代码 必 须在 虚拟机 中 执行 并且 关闭 文件 共享 加密 系统 中 的 文件 被 加密 的 文件 后缀名 统一 修 改为 wncrybwnry 中招 敲诈者 后 桌面壁纸 cwnry 配置文件 包含 洋葱 域名 比特 币 地址 tor 下载 地址 等 fwnry 可免 支付 解密 的 文件 列表 rwnry 提示 文件 包含 中招 提示 信息 swnryzip 文件 包含 tor 客户端 twnry 测试 文件 uwnry 解密 程序 三 防御 措施 勒索 软件 防御 常见 的 措施 如下 开启 系统 防火墙 关闭 等 端口 连接 开启 系统 自动更新 下载 并 更新 补丁 及时 修复 漏洞 安装 安全 软件 开启 主动 防御 进行 拦截 查杀 如 非 服务 需要 建议 把 高危 漏洞 的 端口 都 关闭 比如 等 由于 wannacry 勒索 病毒 主要 通过 端口 入侵 计算机 关闭 的 方法 如下 控制面板 gtwindows 防火墙 gt 高级 选项 gt 入 站 规则 新建 规则 gt 选择 端口 gt 指定 端口号 选择 阻止 连接 gt 配置文件 全选 gt 规则 名称 gt 成功 关闭 实验 在 虚拟机 中 进行 也 需要 关闭 共享 文件夹 功能 如 下图 所示 四 wannacry 病毒 分析 分析 方法 主要有 两种 静态 分析 和 动态 分析 静态 分析 以 反汇编 为主 通过 分析 勒索 软件 的 代码 了解 其 行为 和 各 功能 实现 细节 动态 分析 主要有 动态 调试 行为 分析 沙 盒 分析 动态 调试 主要 配合 静态 分析 进行 对 静态 分析 进行 行 辅助 行为 分析 主要 通过 系统 日志 来 观察 勒索 软件 的 行为 从而 了解 勒索 软件 行为 沙 盒 分析 作为 目前 自动化 分析 的 主要 手段 主要 用来 辅助 手动 分析 通过 在 沙 盒中 运行 勒索 软件 能够 得到 勒索 软件 的 api 调用 文件 行为 网络 行为 等 行为 首先 我们 来 看看 安 天 分享 的 wannacry 流程图 其 运行 流程 包括 主程序 文件 利用 漏洞 传播 自身 运行 wannacry 勒索 程序 wannacry 勒索 程序 释放 taskscheexe 对 磁盘 文件 进行 加密 勒索 显示 勒索 信息 解密 示例 文件 接下来 我们 利用 ida 进行 逆向 分析 母体 程序 mssecsvcexe 行为 分析 主 函数 逆向 如下 包括 创建 工作 目录 设置 注册表 导入 密钥 对 twncy 解密 等功能 主程序 运行 后会 先 连接 该 域名 如果 该 域名 可以 访问 则 退出 不 触发 任何 恶意 行为 如果 该 域名 无法访问 则 触发 传播 和 勒索 行为 目前 该 域名 已被 英国 安全 公司 接管 注意 目前 网上 的 wrcyexe 我 都 只 发现了 勒索 功能 前面 网络 部分 及 传播 功能 代码 未找到 如果有 该 部分 样本 的 读者 希望能 告知 作者 非常感谢 创建 开机 自启动 mssecsvc 服务 并 启动 该 服务 从 木马 自身 读取 ms 漏洞 利用 代码 playload 分为 x 和 x 两个 版本 接着 母体 程序 创建 两个 线程 分别 扫描 内网 和 外网 ip 开始 进行 蠕虫 传播 感染 公网 随机 ip 地址 端口 进行 扫描 感染 内网 直接 扫描 当前 计算机 所在 的 网段 进行 感染 感染 过程 尝试 连接 端口 如果 连接 成功 则 对 该 地址 尝试 漏洞 攻击 感染 母体 程序 mssecsvcexe 利用 ms 漏洞 进行 网络 传播 获取 目标 主机 权限 后 但 其 并不会 直接 发送 自身 exe 程序 到 目标 而是 发送 一段 经过 异 或 加密 后 的 payload 到 目标 机器 中 执行 payload 由 shellcode 包含 样本 自身 的 dll 组成 dll 具有 一个 导出 函数 playgame 将 资源 文件 释放 保存为 mssecsvcexe 并 执行 加载 资源 到 新建 目 录下 并 命名为 taskcheexe 接着 运行 该 程序 starttaskcheexe 先尝 试以 服务 的 形式 启动 cmdexecmdexe 通过 参数 启动 taskcheexe 如果 以 服务 的 方式 启动 失败 就以 普通 进程 的 方式 启动 taskcheexe 释放 taskscheexe 路径 为 行为 分析 解压 释放 大量 敲诈者 模块 及 配置文件 解压密码 为 wncryol 注意 如果 我们 将 wcryexe 修 改为 wcryzip 可以 发现 其 是 个 压缩文件 包括 以下内容 其 解压密码 也 正是 wncryol 设置 工作 目录 设置 注册表 解压 文件 获取 比特 币 钱包 等 释放 资源 bwnry 中招 敲诈者 后 桌面壁纸 cwnry 配置文件 包含 洋葱 域名 比特 币 地址 tor 下载 地址 等 fwnry 可免 支付 解密 的 文件 列表 rwnry 提示 文件 包含 中招 提示 信息 swnryzip 文件 包含 tor 客户端 twnry 测试 文件 uwnry 解密 程序 twnry 文件 包含 一个 加密 的 dll 文件 wannacry 勒索 程序 会 解密 并 动态 加载 调用 taskstart 导出 函数 文件 加密 等 恶意 行为 在 该 dll 中 实现 加密 勒索 过程 会 创建 互斥 体 和 初始化 全局变量 检查 互斥 体 是否 存在 检查 dky 和 pky 是否 存在 是否 配对 如果 加密 则 创建 线程 更新 cwncy 启动 设置 启动项 程序 内置 rsa 公 钥 用于 加密 完成 所有 文件 加密 后 释放 说明 文档 弹出 勒索 界面 需 支付 比特 币 到 指定 的 比特 币 钱包 地址 三个 比特 币 钱包 地址 编码 于 程序 中 程序 分析 程序 会将 复制到 被 加密 文件 的 文件 夹下 衍生 大量 语言 配置文件 具有 加密 功能 的 文件 窗体 文件 等 该 程序 没有 传播 加密 等 恶意 功能 ida 逆向 如 下图 所示 是 样本 加密 完 用户 数据 显示 的 勒索 界面 程序 负责 显示 比特 币 钱包 地址 演示 部分 解密 文件 详细 流程 如 下图 所示 会 创建 res 内容 为 加密 的 文件 数量 大小 等 信息 随后 样本 将该 文件 内容 回 传到 攻击者 的 暗 网 服务器 服务器 收到 用户 上传 的 res 内容 后会 返回 一个 比特 币 钱包 地址 然后 样本 更新 cwnry 配置文件 中 的 比特 币 钱包 地址 当 用户 根据 新 的 钱包 地址 付款 并 点击 checkpayment 后 会将 本地 res 和 eky 回 传到 服务器 如果 攻击者 确认 这个 res 文件 对应 的 比特 币 钱包 收到 付款 则将 eky 文件 解密 后 返回 给 目标 主机 受害 主机 收到 服务器 解密 eky 内容 保存为 dky 随后 样本 遍历 磁盘 文件 排除 设置 好 的 自身 文件 和 系统 目录 文件 使用 收到 的 dky 密钥 解密 后缀 为 wncyr 或 wncry 的 文件 五 wannacry 病毒 检测 写到 这里 整个 实验 复现 及 分析 过程 介绍 完毕 接下来 作者 简单 介绍 学术界 三种 检测 wannacry 病毒 的 方法 更 推荐 读者 阅读 论文 anddropit icdcs 在 内核 层 中 捕获 从 用户 层 发来 的 io 请求 并 将其 发送到 应用层 进行 判定 分类 应用层 将 allowdisallow 消息 发送到 内核 层 后 内核 层 执行 passblock 操作 核心 思想 是 使用 文件 过滤 驱动 拦截 应用层 的 io 请求 然后 进行 行为 判定 如果 判断 为 恶意 io 则 拒绝 该 io 请求 主要 指标 a 文件 类型 变化 作者 通过 监控 这些 头部 的 转 变来 检测 文件 类型 是否 变化 如果 文件 类型 变化 则 写入 操作 是 可疑 的 b 相似 度 衡量 作者 选 用了 sdhash 来 衡量 原文件 内容 与 写入 内容 的 相似 度 如果 写入 数据 与 原 数据 相似 度 很低 则 该 写入 操作 很 可疑 c 香农 熵 信息 熵 作者 使用 信息 熵 来 衡量 写入 数据 的 无序 程度 熵 值 取值 从 越高 则 认为 写入 的 数据 越 可疑 次要 指标 删除 操作 作者 认为 一类 勒索 病毒 通过 将 加密 信息 写入 其它 文件 后 删除 原文件 来 加密 用户 文件 当 一个 进程 删 除了 很多 用户 文件 时 就 认为 这个 进程 很 可疑 漏斗 式 文件 类型 作者 认为 正常 的 进程 如 word 可能会 读取 很多 类型 的 文件 但是 一般 只会 写入 一种 类型 的 文件 当 一个 进程 读取 很多种 类型 的 文件 同时 又 写 入了 很多种 类型 的 文件 时 该 进程 就很 可疑 作者 使 用了 上面 几种 指标 联合 判决 的 方式 来 判断 一个 进程 是否 为 恶意 进程 cryptolock 流程 如下 所示 是 在 cryptolock 的 基础上 进行 的 研究 shieldfs 同样 使用 文件 过滤 驱动 捕获 应用层 的 io 请求 来 进行 恶意 软件 检测 与 cryptolock 不同 的 是 cryptolock 在 判别 方式 上进 行了 改进 以及 增加了 勒索 软件 检出 后 的 被 加密 文件 恢复 机制 shieldfs 流程 如 如下 所示 其主要 模块 有 两个 检测 模块 和 恢复 模块 恢复 模块 用 某种 机制 对 文件 进行 备份 在 检测 模块 检 测出 某 进程 为 恶意 进程 后 恢复 被 恶意 进程 加密 的 文件 redemption 与 shieldfs 相似 的 redemption 也 分为 恶意 行为 检测 部分和 备份 部分 它与 shieldfs 不同 的 地方 就在于 判别 使用 的 指标 和 备份 恢复 文件 的 方式 同时 redemption 使 用了 基于 内容 的 指标 和 基于 行为 的 指标 最后 对 各种 指标 进行 计分 通过 得分 是否 超过 阈值 来 判断 进程 是否 为 恶意 进程 redemption 流程 如 如下 所示 六 总结 写到 这里 这篇 wannacry 勒索 病毒 复现 和 分析 的 文章 就 介绍 结束 了 希望 对 您 有所 帮助 接着 作者 还会 继续 深入 地 逆向 分析 该 勒索 病毒 的 原理 及 调用 关系 也 推荐 大家 阅读 参考文献 大佬 们 的 文章 继续 加油 这篇 文章 中 如果 存在 一些 不足 还请 海涵 作者 作为 网络安全 初学者 的 慢慢 成长 路 吧 希望 未来 能 更 透彻 撰写 相关 文章 同时 非常感谢 参考文献 中 的 安全 大佬 们 的 文章 分享 感谢 师傅 师兄 师弟 师姐 师妹 们 的 教导 深知 自己 很菜 得 努力 前行 欢迎 大家 讨论 是否 觉得 这 系列 文章 帮助 到 您 如果 存在 不足之处 还请 海涵 任何 建议 都可以 评论 告知 读者 共勉 逆向 分析 网络安全 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 晚 上点 夜 于 武汉 参考文献 勒索 病毒 wannacry 之 复现 过程 永恒 之 蓝 weixinwindows 再 曝 wannacry 级 漏洞 cve 专治 xpwinfb 客户 对 wannacry 的 深度 分析 鬼 手 安 天 针对 勒索 蠕虫 魔窟 wannacry 的 深度 分析 报告 原创 勒索 病毒 wannacry 深度 技术 分析 详解 传播 感染 和 危害 细节 火绒 实验室 wannacry 蠕虫 详细分析 freebuf 腾讯 病毒 分析 wannacry 病毒 分析 永恒 之 蓝 小 彩虹 威胁 预警 蠕虫 级 漏洞 bluekeep cve exp 被 公布 斗 象 智能 安全 平台 反病毒 病毒 分析 实战篇 远 控 病毒 分析 i 春秋 老师 等 病毒 样本 csdn 下载 针对 wannaren 勒索 软件 的 梳理 与 分析 安 天 