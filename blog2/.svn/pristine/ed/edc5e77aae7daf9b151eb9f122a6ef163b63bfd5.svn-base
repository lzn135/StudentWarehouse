论文 阅读 03 清华 张超 老师 greyone discover vulnerabilities with data flow sensitive fuzzing 数据流 敏感 的 漏洞 挖掘 方法 清华大学 秀 璋 带你 读 论文 系列 主 要是 督促 自己 阅读 优秀论文 及 听取 学术 讲座 并 分享 给 大家 希望 您 喜欢 由于 作者 的 英文 水 平和 学术 能力 不高 需要 不断 提升 所以 还请 大家 批评指正 非常 欢迎 大家 给我 留言 评论 学术 路上 期待 与 您 前行 加油 张超 老师 是 我 非常 佩服 的 一位 青年教师 清华大学 副教授 博导 蓝莲花 战队 教练 我 也 听了 好几次 他 的 讲座 受益匪浅 他 主要 研究 软件 和 系统安全 尤其是 智能 攻防 方向 在 国际 四大 安全 会议 发表 论文 十 余 篇 在 自动 攻防 研究 方面 提出 的 漏洞 挖掘 方案 发现 多个 未知 漏洞 多次 参加 darpacgc 微软 防 夺 旗 赛 等 比赛 并 获奖 作者 主要 分享 他 的 两次 报告 第一篇 是 学术论文 相关 的 数据流 敏感 的 漏洞 挖掘 方法 第二篇 是 安全 攻防 实战 相关 的 智能 软件 漏洞 攻防 这些 大佬 是 真的 值得 我们 去 学习 献上 小弟 的 膝盖 fightingps 顺便 问 一句 你们 喜欢 这种 方式 的 分享 吗 担心 效果 不好 如果 不好 我 就不 分享 和 总结 类似 的 会议 知识 了 欢迎 评论 给我 留言 文章 目录 一 传统 的 漏洞 挖掘 方法 漏洞 挖掘 fuzzing 和 afl 二 三 超 神 的 方法 greyone 背景 知识 污点 属性 和 分支 匹配 度 实验 结果 四 总结 前文 推荐 秀 璋 带你 读 论文 拿什么 来 拯救 我 的 拖延 症 初学者 如何 提升 编程 兴趣 及 latex 入门 详解 娜 璋 带你 读 论文 网络安全 自学 篇 八十八 基于 机器 学习 的 恶意代码 检测 技术 详解 安全 论文 翻译 一 传统 的 漏洞 挖掘 方法 演讲 题目 数据流 敏感 的 漏洞 挖掘 方法 内容摘要 模糊 测试 近年来 成为 安全 研究人员 的 必备 的 漏洞 挖掘 工具 是 近年来 漏洞 披露 数量 爆发 的 重要 推手 然而 模糊 测试 工具 在 种子 生成 选择 变异 测试 评估 反馈 等 多个 环节 都 存在 一定 的 盲目性 和 随机性 其 漏洞 挖掘 效率 存在 较大 提升 空间 我们 通过 分析 经典 模糊 测试 工具 afl 的 实现 原理 找 到了 若干个 制约 其 效率 的 瓶颈 所在 包括 数据流 不 敏感 等 并 针对 性地 提 出了 改进 方案 本次 报告 将与 大家 探讨 这一 方案 漏洞 挖掘 漏洞 大家 都很 熟悉 了 是 各大 安全问题 的 根源 如 下图 所示 的 stuxnet 震 网 wannacry 心脏 滴血 等等 我们 在 漏洞 挖掘 和 攻防 方面 做了 大量 的 研究 有人 打的 ctf 也有 机器 全自动 的 漏洞 挖掘 攻击 防御 二进制 程序 分析 cgc 比赛 等 下图 是 bluelotus 清华 蓝莲花 战队 这些年 的 成绩 我 的 研究 主题 是 漏洞 挖掘 和 攻击 防御 今天 的 分享 主 要是 我们 在 漏洞 挖掘 方面 最近 的 工作 它是 关于 fuzzing 的 一个 工作 fuzzing 目前 可能是 漏洞 挖掘 最 主流 的 方法 漏洞 挖掘 发展 几十 年前 面有 很多 技术 被 提出来 大家 最 熟悉 的 应该是 代码 审计 逆向 工程 无 源码 它们 仍然是 企业 发现 漏洞 的 常用 渠道 学术界 提出 的 包括 静态 分析 动态 分析 污点 分析 符号执行 等 方法 这些 技术 或多或少 都 局限 没有 最近 流行 的 fuzzing 技术 有效 和 aflfuzzing 也 不是 新技术 它是 在年 的 时候 被 提出来 已经 有年 历史 但它 真 正大 的 发展 是 年 以后 最近 几年 有 个 大 的 发展 它 的 基本思路 如 下图 所示 它是 一个 动态 测试 的 过程 需要 想办法 生成 一大堆 输入 扔给 程序 测试 如果 测试 过程中 出现问题 就可 能有 bug 如果 没有问题 就 接着 测试 和 软件工程 中 的 测试 流程 类似 整个 过程 的 核心 是 怎样 有效地 生成 输入 去 触发 bugs 因为 对于 程序 来 说它 输入 空间 是 个 无限 的 空间 能够 触发 漏洞 是 非常 少 的 那么 怎样 在 无限 空间 中 有效 找到 少 量能 触发 漏洞 的 输入 这是 它 的 核心问题 年 左右 提出 fuzzing 的 问题 基 本是 偏 随机 输入 的 后面 又 提出 方法 告诉 输入 的 格式 然后 基于 格式 去 生成 但 相对来说 它 挖 漏洞 的 效率 仍然 很低 让 人去 写 这个 输入 格式 工程量 也 比较 大年 以后 有 一个 叫 afl 的 重要 方案 被 提出 这个 方案 有 一个 很 重要 的 算法 就是 遗传算法 它把 遗传算法 放进 来了 我们 刚才 说到 fuzzing 的 核心 是 在 无穷 多个 输入 空间 中 去找 有限 的 输入 去 触发 漏洞 那 怎么 在 无穷 空间 中去 有限 探索 呢 它用 到了 遗传算法 下图 中间 的 核心 循环 通过 一轮 一轮 的 迭代 测试 测试 过程中 它 会把 上 一轮 测试 比较好 的 测 试用 例 留下来 作为 种子 进入 下一 轮下 一轮 是 在上 一轮 比较好 的 种子 基础上 进一步 变异 测试 它在 无穷 空 间中 探索 时 不是 盲目 的 去 探索 而是 在上 一轮 探索 基础上 去找 比较好 的 方向 接着 再 这个 方 向上 往下 探索 该 方法 还是 比较 有效 的 具体分析 每 轮 测试 保 留好 的 测试 例 那么 什么 是 好 的 测试 例 呢 这里有 一个 进化 指标 这个 进化 指标 也 非常重要 我们 目标 是 挖 漏洞 很 自然 就有 一个 指标 是 漏洞 数量 但是 用 漏洞 数量 作为 指标 来 进化 的 效果 很差 因为 漏洞 是 个 非常 稀疏 的 你 可能 挖 了 几个 小时 都没 挖到 一个 漏洞 这 意味着 没有 进化 的 信号 整个 算法 效果 就 很差 漏洞 数量 年 afl 工作 使用 的 指标 是 代码 覆盖率 测试 工程 中去 监控 程序 的 代码 覆盖率 情况 如果 一个 新 的 测试 例 提 升了 代码 覆盖率 就 认为 它是 好 的 种子 就 保留 下来 通过 这种 方式 就能 不断 提升 代码 覆盖率 代码 覆盖率 与 漏洞 有 一定 相关性 我们 知道 要 触发 漏洞 的话 肯定 要走 存在 漏洞 的 那条 路径 去 触发 代码 如果 没 走过 那段 代码 那个 漏洞 肯定 不会 触发 它们 之间 是 有 个 关联性 的 我们 通过 这种 遗传算法 不断提高 代码 覆盖率 它就 有 一定 概率 去 发现 代码 中 隐藏 的 漏洞 整体 效果 也 不错 为了 支持 做 覆盖率 跟踪 以及 在 测试 过程中 发现 代码 漏洞 是否 被 触发 通常 会对 程序 进行 插 桩 做 代码 覆盖率 收集 和 安全 检测工具 插 桩 完成 之后 在 测试 过程中 程序 会 自动 收集 coverage 信息 以及 检测 是否 触发 安全问题 apioneerafl 下图 是 真正 afl 的 框架 真正 的 afl 会在 过程中 每 一步 都有 一些 策略 比如 怎么 选 种子 selectseed 怎么 变异 mutateseed 变异 后 怎么 测试 test 测试 过程中 怎么 跟踪 覆盖率 覆盖率 怎么 过滤 保留 新 的 种子 filterseeds 等等 该 算法 提出来 之后 非常 有效 改 变了 大家 在 这块 的 研究 afl 的 重要 特点 如下 遗传算法 是 个 进化 的 特征 方案 是 可 量化 的 不需 要知道 目标软件 太多 的 知识 给它 一个 软件 就能 测 测试 过程 非常快 一秒钟 平 均能 测 上千 个 测 试用 例 捕获 漏洞 能力 比 较强 可以 支持 不同 的 sanitizers 也 可以 扩展 比较 有名 的 是 谷歌 写 的 常用 安全 防护 和 漏洞 挖掘 这个 非常重要 有时候 在 测试 过程中 触发 漏洞 但 程序 并不一定 会 让 崩溃 一个 好 的 sanitizers 能够 在 程序 未 崩溃 的 情况下 发现 漏洞 推荐 资料 是 由 安全 研究员 开发 的 一款 基于 覆盖 引导 coverageguided 的 模糊 测试 工具 它 通过 记录 输入 样本 的 代码 覆盖率 从而 调整 输入 样 本以 提高 覆盖率 增加 发现 漏洞 的 概率 其 工作 流程 大致 如下 从 源码 编译程序 时 进行 插 桩 以 记录 代码 覆盖率 codecoverage 选择 一些 输入 文件 作为 初始 测试 集 加入 输入 队列 queue 将 队列 中 的 文件 按 一定 的 策略 进行 突变 如果 经过 变异 文件 更新 了 覆盖 范围 则 将其 保留 添加到 队列 中 上述 过程 会 一直 循环 进行 期间 触 发了 crash 的 文件 会被 记录下来 参考 alphalab 文章 afl 漏洞 挖掘 技术 漫谈 一用 afl 开始 你 的 第一次 fuzzing 二 所以在 整个 流程 中 这些 环节 都可以 去 改进 这些年 四大 安全 会议 关于 fuzzing 的 论文 大概 有篇 数量 非常大 我们 简单 介绍 下 安全 四 大顶 会 网址 网址 网址 网址 neration 第一 块 是 初始 种子 它对 fuzzing 的 效率 还是 有 很大 影响 的 如果 你 不给 初始 种子 它也 会去 测试 但是 其 效率 比 较低 很多 学者 去 研究 如何 给 一个 好 的 初始 种子 让 fuzzing 更 快地 进入状态 更好 地 找到 漏洞 实践中 怎么 找到 初始 种子 呢 可以 从 网 上去 爬 取 一些 pdf 文件 作为 初始 种子 或者 从 网上 找 一些 历史上 的 poc 而 学术界 的 方法 如下 第一种 是 借用 ai 的 方法 基本思路 是 从 程序 的 合法 输入 网上 爬 取 样本 中学 出 一个 模型 再用 这个 模型 生成 新 的 测试 例 这样 构造 的 初始 种子 相对来说 更好 典型 论文 方法 包括 等第 二种 是 通过 符号执行 来 辅助 这种 辅助 手段 一般 称为 混合 fuzzing 其 基本思路 的 核心 还是 fuzzing 来 做 但 fuzzing 有些 代码 过不去 比如 一个 复杂 的 数组 检查 fuzzing 很难 通过 对于 这些 过不去 的 分支 drillers 就 提出 用 符号执行 来 辅助 遇到 分支 过不去 的 情况 用 符号执行 来 求解 并 生成 新 的 种子 再 丢给 fuzzing 去 通过 分支 这是 当时 他们 做 cgc 比赛 的 方案 符号执行 和 fuzzing 混合 确实 能 提升 过不去 的 分支 最近 几年 有 进一步 改进 符号执行 和 fuzzing 的 经典 方法 比如 qsymdigfuzzhfl 等第 三种 是 基于 静态 分析 和 动态 分析 的 还有 一些 是 基于 静态 分析 动态 分析 以及 去 学习 输入 的 规范 通过 程序 分析 的 技术手段 去 分析 程序 接受 什么样 的 输入 再去 指导 测试 例 的 生成 今年 张老师 他们 有 一篇 针对 android 服务 的 工作 也是 这个 思路 即 上面 介绍 的 是 采用 不同 角度 有 ai 符号执行 传统 静态 分析 动态 分析 来 辅助 识别 或者 生成 初始 种子 的 还有 一部分 是 针对 不同 测试 目标 的 工作 包括 针对 二进制 程序 的 针对 内核 程序 的 针对 javaiotsdn 的 还有 虚拟机 手机 驱动 文件 系统 数据库 智能 音响 等等 针对 不同 的 目标 做 fuzzing 它 其实 会 存在 很大 的 差异 一个 重要 原因是 这些 目标 很难 有 个 较好 的 动态 测试 环境 测试 环境 有 个 要 求是 尽量 在 测试 过程中 做 一些 跟踪 而 很多 目标 可能 不适 合做 跟踪 所以 需要 解决 这个 问题 针对 不同 测试 目标 也是 有 很多 工作 的 在 遗传算法 每 轮 的 迭代 中 它 首先 需 要从 现有 的 种子 池 seedpool 中 选择 种子 该 步骤 也是 有 一些 策略 的 因为 一个 种子 池中 可能 积 累了 很多 种子 通过 历史上 不断 测试 留下来 的 但 每 一轮 可能 只 选择 一个 种子 而 先 选择 哪一个 的 效率 也是 不一样 的 虽然 大家 都是 种子 但可 能 有些 种子 效率 更好 年 发表 在 ccs 上 的 aflfast 的 策略 是 如果 这个 种子 在 之前 测试 中 很少 被选 出 来就 称为 cold 这样 的 种子 后面 优先 被选 出来 或者 这个 种子 搜索 的 路径 在 之前 的 测试 中 很 少被 测到 也 会 优先选择 这个 种子 还有 其他 的 一些 策略 比如 vuzzeraflgoqtep 等等 包括 张老师 他们 年 oakland 提出 的 collafl 这些 策略 其实 没有 哪 一个是 绝对 的 最好 各有千秋 选好 种子 之后 接下来 是 做 变异 在 这个 种子 基础上 变异 生成 一堆 测 试用 例 afl 的 做法 是 随机 选择 一些 字节 对 其 进行 增删 改做 一些 操作 但 这个 随机 没法 保证质量 这块 就有 一些 工作 尝试 改进 第一种 是 偏 ai 的 方法 比如 年有 尝 试用 ai 来 指导 lstm 强化 学习 去年 张老师 他们 在 usenixsec 上有 一篇 mopt 通过 粒 子群 优化 算法 来 选择 最优 的 变异 策略 同时 ccs 上有 一篇 ilf 也是 通过 ai 方法 先用 符号执行 去 生成 数据 并 作为 训练 数据 再 通过 ai 模型 来 指导 它 变异 该 工作 适合于 智能 合约 和 区块 链 上第 二种 偏 程序 分析 的 方法 这些 方法 是 通过 程序 分析 的 方法 经典 的 是 年 发表 在 ndss 的 vuzzer 它 通过 污点 分析 来 判断 应该 对 哪些 字节 进行 变异 以及 怎么 变异 后面 还有 一些 通过 符号执行 梯度 下降 年 oakland 人大 一位 老师 的 做法 也 非常 有意思 它 通过 测试 去 观测 测试 的 表现 来 推断 输入 字段 的 划分 及 类型 基于 字段 类型 来 指导 怎么 变异 我们 今天 要 分享 的 是 usenixsec 的 greyone 也是 关于 变异 的 工作 编译 好 之后 就是 测试 工作 optimizations 测试 过程中 第一个 很 重要 的 问题是 性能 测得 非常快 漏洞 挖掘 工具 也 会 很强 这里有 一些 并行 化 硬件 辅助 的 工作 下面 一类 工作 是 测试 过程中 需要 跟踪 代码 覆盖率 安 全等 属性 代码 覆盖率 相对来说 工作 比 较少 我们 年 关注 的 是 代码 覆盖率 中 的 碰撞 问题 让 它 更 精确 今年 有 很多 团队 尝 试用 别的 不同 的 coverage 来 做 指标 这个 代表性 工作 是 年 oakland 的 ijon 工作 非常 有意思 包括 我们 团队 也 在 尝试 各种 想法 它 实际上 自定义 了 很多 不同 的 coverage 指标 比方说 在 走 迷宫 程 序时 迷宫 所在 的 位置 作为 指标 如果 大家 搞 fuzzing 建议 大家 去 看看 还有 一些 做 定向 fuzzing 的 不是 探索 所有 代码 而是 优先 探索 我们 想 探索 的 比如 某个 点 可能有 漏洞 这类 也是 有 个 coverage 的 通常是 距离 比如 离 目标 有 多远 还有 一块 是 sanitizer 刚才 提到 谷歌 公司 的 是 一个 经典 的 工作 这 部分和 防护 比较 接近 去年 也有 razar 方法 引导 它 往 race 去 发现 特定 的 漏洞 写到 这里 我们 就把 这些年 fuzzing 的 一些 方法 介绍 完毕 了 可能 不是 很 全 但 大部分 的 方法 都 囊括 了 三 超 神 的 方法 greyone 注意 这 部分内容 是 结合 张老师 的 分享 以及 作者 的 理解 来 叙述 所以 和 原文 的 框架 有所 差异 这里 强烈推荐 大家 从下 面的 链 接去 下载 原文 进行 学习 看看 大佬 们 的 前沿 工作 背景 知识 下面 开始 讲解 我们 的 工作 第一个 工作 是 usenixsecurity 的 一篇 文章 叫做 是 一个 数据流 敏感 工作 简单 介绍 下 背景 知识 我们 先看 下图 所示 的 一个 例子 这是 经典 的 magicnumber 检查 第 个 if 前面 八个 字节 等于 magichdr 第 个 if 后面 八个 字节 必须 等于 算出来 的 校验 和 第 个 if 判断 长度 第 个 if 输入 数据 做个 变形 第 个 if 包含 一些 更 复杂 的 是 隐 式 依赖 比如 第 行 var 变量 它是 跟 第 行 的 控制 相关 第 个 ifbug 隐性 依赖于 input 的 到 个 字节 我们 人去 看 这些 知识 很 容易 理解 但是 fuzzing 过程中 如果 想 触发 bug 我们 在 变异 时 其实是 有 一些 知识 可以 获取 的 输入 前个 字节 与 magichdr 进行 比较 变异 时 是 要对 前个 字节 进行 变异 而 不是 随机 变异 变异 取 什么 值 呢 我们 应该 取 magichdr 接着 校验 和 checksum 也 类似 它 会把 输入 中 的 个 字节 与 算出来 的 值 某个 校验 和 进行 对比 我们 就 要对 input 进行 变异 变异 所取 的 值 是 计算出来 的 值 还有 一点 比如 magichdr 例子 只有 全 匹 配上 才能 出发 bug 全部 匹 配上 的 概率 还是 比 较低 的 个 bit 的 次方 现在 假设 我们 有 两个 用 例 它们 分别 与 magichdr 有 个 byte 和 个 byte 匹配 但从 代码 覆盖率 上来 说 它们 都是 一样 的 都不 满足 这个 检查 都会 走 这个 flase 的 分支 但 它们 的 测试 效果 或者 对 fuzzing 的 作用 一样 吗 显然 不是 明显 个 byte 匹配 的 测试 例 效果 更好 因为 下一次 在 个 byte 基础上 可能再 变异 一个 byte 就 匹配 上了 magichdr 所以说 这两个 测试 例 得 代码 覆盖率 是 一样 的 但是 它 的 测试 效果 不一样 这个 例子 说明 因此 张老师 他们 提 出了 一种 新 的 数据流 敏感 模糊 解 greyone 污点 属性 和 分支 匹配 度 首先 的 类型 是什么 呢 taintattributes 污点 属性 输入 和 变量 之间 的 依赖性 分支 匹配 度 转移 条件 操作数 间 的 距离 提 出了 一个 分支 匹配 度 的 计算公式 一致性 越高 距离 越 近 我们 就 认为 它 的 匹配 度 越好 基于 上述 观测 我们 提出 了如 下图 所示 的 模型 关注 的 是 taint 部分 我们 需 要做 数据流 跟踪 来 识别 刚才 提出 的 两个 特性 此时 遇到 个 问题 怎么 去 获取 数据流 特性 呢 如何 利用 数据流 特性 来 指导 变异 怎么 去 进一步 调整 fuzzing 进化 的 方向 接着 我们 先来 回答 这 部分 的 问题 是 非常 经典 的 技术 很多 地方 都有 比如 libdftdfsan 等 基本思路 是 逐条 解释 指令 因为 指令 是 有 语义 的 比如 mov 移动 eax 到 edx 中去 它就 会把 eax 的 污点 属性 转义 到 edx 污点 属性 中去 所以 当 它 逐条 解释 语义 它就 可以 分析 这个 输入 的 污点 是 怎么 传 播到 程序 中 的 各个 变量 上去 的 一条条 指令 来 解释 但是 这种 做法 很 笨重 需要 人去 逐条 写 这个 语义 非常 麻烦 这些 工具 一般 都 需 要人 来写 这个 规则 很 容易 写错 写 漏 那么 去年 ndss 有 一篇 做 自动 的 去 推演 taintinst 的 工作 自动 推演 taint 的 规则 但 所有这些 工作 都有 一个 问题 存在 严重 的 undertaint 和 overtaint 的 问题 这 两类 问题 都很 多 就会 漏掉 一些 taint 信息 或者 造成 错误 地 把 一些 不应 该是 taint 而 识 别为 taint 时间 关系 不 展开 讲解 不论是 人工 或 机器 来 做 都会 遇到 的 问题 而且 还 比较严重 我们 提 出了 一个 新 的 方案 叫 fuzzing 驱动 污点 推断 基本 想法 很简单 我们 要 关注 的 不是 一条条 指令 的 传播 我们 关注 的 是 宏观 的 效果 比如 输入 的 哪几 个字 节会 影响 我 的 某一个 分支 分支 这边 涉及到 变量 我 想 关心 的 就是 变量 与 输入 的 哪个 字节 相关 通过 做一个 变化 观察 变量 var 的 值 是否 保持 不变 如果 它 的 值 发 生了 变化 我们 就 知道 这个 var 和 变量 si 第 i 个 字节 是 相关 的 换句话说 如果 变量 的 值 在 输入 字节 发生变化 时 发生变化 我们 可以 推断 前者 受到了 污染 并 依赖于 后者 所以 我们 只需 要对 fuzzing 做 动态 测试 调整 输入 的 某些 字节 然后 看 程序 中 哪些 变量 发 生了 变化 发生变化 的 值 就 认为 它与 输入 字节 有关 vars v varsi 逐个 字节 变异 监控 变量 是否 发生变化 由于 afl 是 可以 逐个 字节 变异 的 我们 只需 要在 fuzzing 过程中 增 加个 变量 监控 即可 它 的 优点 包括 速度 非常快 不需要 人工 写 传播 规则 没有 overtaint 问题 可能有 少量 的 undertaint 问题 出现 没 测试 到 的 情况 下图 发现 我们 的 漏报 其实 很少 左边 这张 图 蓝色 最 左边 是 我们 发现 的 污点 深蓝色 中间 是 两者都 发现 的 污点 浅蓝色 最 右边 是 ibm 提供 的 污点 我们 是 没有 误报 的 它们 可能 会有 overtaint 的 问题 所以 我们 的 识别 效果 更 准确 速度 影响 也 非常 小只 有的 会 overhead 对 整体 fuzzing 速度 没有 影响 第二个 是 识别 数据流 特征 分支 匹配 度 分支 的 地方 两个 变量 有 多少个 匹配 通过 程序 插 桩 就看 分支 在哪 有 多少个 bit 相等 我们 除了 定义 分支 匹配 度外 还 进一步 扩展 了 基本块 的 匹配 度 扩展到 路径 的 匹配 度 识别 完 taint 信息 和 分支 匹配 度 信息 之后 怎么 去 进一步 指导 我们 的 mutation 怎么做 变异 呢 前面 其实 已经 提 到了 怎么做 编译 比如 这些 直接 拷贝 这种 该 编译 很简单 通过 taint 信息 就 知道 要对 哪里 进行 变异 然后 获取 的 值 是 填 进去 就 好了 还有 一些 是 间接 拷贝 输入 的 字节 是 通过 一些 运算 之 后来 做 检测 这种 在 变异 的 时候 不能 确定 它 准确 的 值 采用 偏 随机 的 方法 通过 变量 相关 的 字节 进行 随机 的 变异 然后 taint 有 个 问题 可能 会有 少量 的 undertaint 问题 所以在 变异 过程中 也 不完全 依赖于 指导 可能 也 对 那些 我们 认为 不相关 的 字节 也 做 一定 小 概率 的 编译 接着 我们 需要 确定 对 哪些 字节 变异 我们 有 一个 排序 目标 是 探索 更多 的 代码 首先 对 没有 探索 的 分支 做一个 排序 然后 这些 分支 与 某些 输入 字节 相关 再 对 输入 字节 做一个 排序 然后 优先 选 某个 字节 这些 排序 怎么 计算 呢 我们 有 公式 来 计算 其实 就是 看 输入 字节 与 这个 分支 之间 的 依赖 关系 输入 字 节会 影响 某些 变量 有些 变量 会 应用到 不同 分支 中去 有些 分支 被 探索 过 explored 有些 分支 没有 unexplored 所以 先 定义 字节 的 权重 看 这个 直接 会 影响 多少个 没有 测试 的 分支 图中 所示 数量 越高 它 的 权重 越大 那么 分支 怎么做 排序 呢 都是 没有 探索 过 的 分支 也是 从 这个 图 上说 反过来 一个 分支 branch 会 依赖 若干个 字节 这 若干个 字节 权重 加起来 越高 这个 branch 的 权重 也就 越高 最后 一部分 是 去 调整 进化 方向 通过 分支 匹配 度 一个 字节 匹配 和 七个 字节 匹配 的 效果 是 完全 不一样 的 那么 怎么 把 这个 增加 进 去呢 我们 在 原来 代码 覆盖率 基础上 增加了 一个 新 的 指标 即 分支 匹配 度 原来 大家 是 把 这个 分支 有 好 的 代码 覆盖率 就把 它 放到 种子 池 中去 种子 池 是 一个 线性 列表 现在 把 种子 池 修改 它 还是 个 列表 但是 每个 节点 不再是 一个 种子 了 它 每个 节点 可能是 多个 种子 怎么 做的 呢 如果有 新 的 代码 覆盖率 newcoverage 即有 新 的 测试 例 每个 小圆圈 就是 测试 例 就会 在 种子 池中 新建 一组 节点 里面 就是 新 的 测试 例如 下图 右边 黄色 部分 种子 编号 如果 没有 新 的 代码 覆盖率 它 的 代码 覆盖率 与 之前 某 组 测试 例 是 一样 的 但是 它 的 路径 匹配 度 更好 那我 就 取代 了 刚才 的 两个 测试 例如 下图 左下角 部分 种子 编号 如果 没有 新 的 代码 覆盖率 或 更高 的 路径 匹配 度 路径 匹配 度 是 由 基本块 匹配 度 构成 的 但是 基本块 匹配 度 或 分支 匹配 度 组合 不太 一样 我们 就 往里面 添加 一个 如 下图 所示 的 右下角 部分 种子 编号 最后 我们 的 种子 池 就 修 改成 如 下图 所示 变 成了 二维 的 后面 取 种子 变异 就从 这个 种子 池中 完成 该 方法 有 很多 好处 这里 不 详细 讲解 具体 如 下图 所示 实验 结果 接着 我们 看看 实验 结果 我们 和 进行了 对比 我们 比 它们 中 最好 的 代码 覆盖率 也 提 升了 左右 下图 是 进化 曲线 代码 覆盖率 增长 的 曲线 在 挖 漏洞 这边 我们 评价 有 两个 指标 crashes 和 漏洞 crashes 和 之前 三 个中 最好 的 相比 提 升了 倍 增长 曲线 也 非常快 挖 漏洞 方面 vulnerabilities 我们 比 之前 的 方案 都要 多 多倍 的 效果 最后 申 请了 个 cve 这次 分享 基 本把 greyone 介绍 了 一遍 其实 我们 在 fuzzing 方面 还有 以下 这 几个 方面 的 工作 前面 也 提 到过 推荐 大家 去 阅读 这些 文章 四 总结 简单 做个 总结 fuzzing 目前 是 最 流行 的 漏洞 挖掘 方法 有 很多 的 工作 在 研究 我们 讲解 的 greyone 方法 是 根据 数据流 敏感 的 思路 来 做的 在 fuzzing 中 更 精确地 通过 很多 的 数据 检查 该 方法 的 亮点 在于 用了 一个 清亮 的 污点 跟踪 机制 用 污点 信息 来 指导 进化 同时 用 分支 匹配 度 来 调整 进化 方向 当然 fuzzing 这块 还有 很多 工作 可以 去做 的 问题 这里 主要 针对 有 源码 的 挖掘 吗 这套 方案 和 源码 有 什么 关联 呢 回答 有 源码 的 时候 效果 会 更好 因为 需 要做 污点 分析 监控 变量 的 取值 然 后来 做 程序 插 桩 当然 这些 工作 在 二进制 中 也 可以 做 其实 反汇编 都 很难 做种 更何况 需 要做 插 桩 或 其他 的 可以 做 但是 效果 会 差 一些 准确性 包括 提取 的 分 支会 少 一些 我们 的 方案 可以 移植 过去 但是 目前 没有 数据 会说 移植 过去 的 效果 会 怎样 相比 其他 二进制 方案 会有 提升 但 效果 不会 很高 问题 漏洞 挖掘 方案 它 挖掘 的 漏洞 类型 会不会 偏向 哪一 类 呢 比如 哪一 类 较多 或 哪一 类 没有 效果 回答 现在 fuzzing 方案 基本 挖 的 内存 破坏 漏洞 比 较多 还有 一些 定制 的 适用于 算法 复杂度 的 漏洞 有 一小部分 是 其他 漏洞 它能 挖 什么 类型 漏洞 主要 能力 在于 sanitizer 这 部分 写 什么样 的 检测工具 如果 不 写 检测工具 只 能看 程序 是否 崩溃 很多 时候 漏洞 触发 后 它也 不一定 崩溃 所以 大家 会 定制 sanitizer 比如 bufferflow 监控 定义 规则 出来 比如 谷歌 的 它 的 漏洞 类型 和 我们 检测器 有关 问题 您 挖出来 的 这些 未知 漏洞 怎么 去 验证 它是 不是 真实 的 漏洞 呢 是 通过 手动 的 方式 呢 还是 自动化 方式 呢 回答 这是 个 很好 的 问题 目前 我们 paper 中 基 本是 人工 来 做 afl 提供 了 一些 过滤 功 能把 显然是 重复 的 这些 crashes 去 重 了 剩下 的 还有 一定 数量 几十个 上百 个 通常会 人工 写 一些 脚本 工具 来 判断 和 验证 学术界 现在 也是 有 paper 在 研究 这些 怎么做 自动 的 crashes 分析 和 归类 问题 论文 假设 分支 匹配 度 越高 输入 的 种子 越 优 这个 假设 怎么 处理 函数 变化 如 hash 变化 再 input 呢 一个 好 的 hash 函数 它 的 输出 应该是 均匀 的 这时 的 假设 感觉 就 不太 需 要了 请 问下 这是 怎么 处理 的 回答 我们 现在 没有 处 处理 这种 特殊情况 其实 遇到 这种 情况 现在 的 方案 可能 大家 都做 得 不好 这是 一个 很 经典 的 例子 比如 前面 说的 间接 数据 拷贝 做了 一个 变换 再来 判断 我们 的 方案 效果 也 不好 我们 的 方法 识别 出来 它 和 到 字节 相关 重点 变异 这几 个 字节 此时 分支 匹配 度 策略 可能 就不是 很 有效 比如 foo 可能是 hash 变换 函数 后 均匀分布 了 确 实是 存在 问题 的 作者 感受 学术 或许是 需要 天赋 的 这些 大佬 真 值得 我们 学习 同时 自己 会 继续 努力 的 争取 靠 后天 努力 来 弥补 这些 鸿沟 更 重要 的 是 享受 这种 奋斗 的 过程 加油 最近 又 认识了 很多 朋友 和 博 友 非常 荣幸 有 问问题 的 有 考研 交流 的 有 一起 读 博 鼓励 的 也有 想 考 博 去 大学 教书 的 还有 技术交流 以及 交朋友 的 虽未 谋面 共同 前行 尽管 自己 非常 忙碌 但 还是 很 愿意 去 解答 博 友 的 问题 去 帮助 更多 的 陌生人 有时候 你 的 一句 鼓励 一个 回答 可能 就是 别人 前行 的 动力 何乐而不为 虽然 自己 的 技术 和 科研 都 很菜 安全 也 非常 难 但 还是 得 苦 心智 劳 筋骨 饿 体肤 感恩 亲人 的 支持 也 享受 这个 奋斗 的 过程 月 是 故乡 圆 佳节 倍 思亲 加油 晚 安娜 byeastmount 晚 上点 