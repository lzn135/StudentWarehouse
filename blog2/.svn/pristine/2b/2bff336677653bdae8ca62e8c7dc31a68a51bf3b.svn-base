webapp 安全 风险 与 防护 课堂 第二 讲 开课 了 本文 由 葡萄 城 技术 团队 于 原创 并 首发 转载 请 注明 出处 葡萄 城 官 网 葡萄 城 为 开发者 提供 专业 的 开发工具 解决方案 和 服务 赋 能 开发者 在 昨天 的 公开课 中 由于 参与 的 小伙伴 们 积极性 和 热情 非常 高 我们 的 讲师 carl 陈 庆 把 原定 第二 讲 的 大部分 也 一并 献 出了 所以 原定 三场 的 公开课 也 变 为了 两场 本 系列 的 公开课 生动有趣 干货 满满 受众 广泛 所以 没有 参与 上次 课程 的 小伙伴 们 这次 请 不要 忘 记了 本期 公开课 我们 将 着重 介绍 owasptop 项 最 严重 的 web 应用程序 安全 风险 预警 及其 应对 策略 公开课 地址 应用 安全 风险 详解 owasptop 的 目的 在于 为 广大 企业 确定 一组 最 严重 的 风险 项目 对于 其中 的 每一项 风险 我们 将 使用 基于 owasp 风险 等级 排序 的 评级 方案 为 您 提供 关于 漏洞 普遍性 可 检测 性 业务 技术 影响 等 信息 一 注入 将 不受 信任 的 数据 作为 命令 或 查询 的 一部分 发送到 解析器 时会 产生 诸如 sql 注入 nosql 注入 os 注入 和 ldap 注入 等 注入 缺陷 攻击者 的 恶意 数据 可以 诱使 解析器 在 没有 适当 授权 的 情况下 执行 非 预期 命令 或 访问 数据 可利用 性 容易 几乎 任何 数据源 都能 成为 注入 载体 包括 环境变量 所有 类型 的 用户 参数 外部 和 内部 web 服 务当 攻击者 可以 向 解释 器 发送 恶意 数据 时 注入 漏洞 便可 产生 普遍性 常见 注入 漏洞 十分 普遍 尤其是 在 遗留 代码 中 注入 漏洞 通常 能在 sqlldapxpath 或是 nosql 查询 语句 os 命令 xml 解析器 smtp 包头 表达式 语句 及 orm 查询 语句 中找到 可 检测 性 易 注入 漏洞 很 容易 通过 代码 审查 发现 扫描器 和 模糊 测试 工具 可以 帮助 攻击者 找到 这些 漏洞 技术 影响 严重 注入 能 导致 数据 丢失 破坏 或 泄露 给 无 授权 方 缺乏 可 审计 性 或是 拒绝服务 注入 有时 甚至能 导致 主机 被 完全 接管 业务 影响 未知 您 的 应用 和 数据 需要 受到 保护 以 避免 对 业务 造成 影响 自查 您 的 应用程序 脆弱 吗 当 您 的 应用 有 如下 情况 时 是 脆弱 且 易 受到 攻击 的 用户 提供 的 数据 没有 经过 应用程序 的 验证 过滤 或 净化 动态 查询 语句 或 非 参数 化 的 调 用在 没有 上下文 感知 转义 的 情况下 被 用于 解释 器 在 orm 搜索 参数 中使 用了 恶意 数据 这样 搜索 就 获得 包含 敏感 或 未 授权 的 数据 恶意 数据 直接 被 使用 或 连接 诸如 sql 语句 或 命令 在 动态 查询 语句 命令 或 存储 过程中 包含 结构 和 恶意 数据 一些 常见 的 注入 包括 sqlos 命令 ormldap 和 表达式 语言 el 或 ognl 注入 所有 编译器 的 原理 都是 相似 的 因此 codereview 是 目前为止 最 有效 的 检测 应用程序 注入 风险 的 办法 之一 当然 您也 可 以对 代码 中所 有 参数 字段 头 cookiejson 和 xml 数据 输入 进行 dast 扫描 并将 sast 和 dast 工具 添加到 cicd 进程 中 以 便在 项目 部署 前 对 现有 代码 或 新 代码 进行 注入 检测 如何 防止 注入 防止 注入 漏洞 需 要将 数据 与 命令 语句 查询 语句 分隔 开来 最佳 选择 是 使用 安全 的 api 完全避免 使用 解释 器 或 提供 参数 化 界面 的 api 或 迁 移到 orm 或 实体 框架 中 注意 当 参数 化时 如果 plsql 或 tsql 将 查询 和 数据 连接 在一起 或者 执行 带有 立即 执行 或 exec 的 恶意 数据 存储 过程 仍然 可以 引入 sql 注入 漏洞 使用 正确 或 符合 白名单 规范 的 输入 验证 方法 同样 有助于 防止 注入 攻击 但 这 很可能 引起 用户 的 吐 槽 因为 许多 应用程序 在 输入 中 需要 特殊 字符 如 文本 区域 或 移动 应用程序 的 api 对于 所有 动态 查询 可以 使用 该 解释 器 的 特定 转义 语法 转义 特殊 字符 owasp 的 javaencoder 和 类似 的 库 提供 了 这样 的 转义 例程 注 意在 sql 结构 中表 名 列名 等 无法 转义 因此 用户 提供 的 结构 往往是 非常 危险 的 在 查询 中 使用 limit 和 其他 sql 控件 防止 在 sql 注 入时 引发 大量 数据 泄露 攻击 案例 场景 场景 应用程序 在 脆弱 的 sql 语句 结构 中使 用不 可信 数据 id 场景 框架 应用 的 盲目 信任 也 可能 导致 查询 语句 的 漏洞 例如 hibernate 查询 语言 id 在这 两个 案例 中 攻击者 在 浏览器 中将 id 参数 的 值 修 改成 or 例如 这样 查询 语句 的 意义 就 变 成了 从 accounts 表 中 返回 所有 记录 sql 盲 注 sql 盲 注 就是在 sql 语句 注入 后 且 成功 执 行时 执行 的 结果 不能 回 显 到 前端 页面 此时 我们 需要 利用 一些 方法 进行 判断 或者 尝试 这个 过程 称之为 盲 注 盲 注 一般 分为 三类 一 基于 布尔 的 盲 注 基于 布尔 的 盲 注 通常 使用 逻辑 判断 推测 获取 的 数据 通过 给定 条件 服务器 返回 真 或 假 使用 二分法 或者 正则表达式 等 方法 即可 缩小 判断 的 范围 二 基于 时间 的 盲 注 主 要是 利用 延时 或者 执行 的 时间 来 判断 if ascii substr database gtsleep if 判断 语句 条件 为 假执行 sleep 因为 延时 会 受到 网络 环境 的 影响 因此 这种 方法 不是 很 可靠 三 基于 报错 的 盲 注 构造 payload 让 信息 通过 错误 提示 显示 count 和 rand 和 groupby 报错 rand 是 伪 随机 数列 产生 报错 的 原因 是因为 rand 并不是 一个 定 值 相当于 一个 变量 使用 groupby 时会 建立 一张 虚拟 表 字段 为 key 和 count 执行 插入 操作 第一次 返回 但 虚拟 表 中 没有 这个 项 数据库 会 认为 需要 插入 这个 项 但 数据库 并没有 记录下来 因此会 再次 执行 rand 试图 获取 但 此时 获取 的 是 第二 个数 依次 类推 当 数据库 查询 发现 这个 项 不存在 执行 插入 操作 时 rand 返回值 为 但是 已经 存在 这时 插入 已经 存在 的 项 就会 报错 waf 绕过 之所以 要 谈到 waf 的 常见 特征 是为了 更好 的 了解 waf 的 运行机制 以便 增加 绕过 waf 的 机会 总体 来说 waf 具有 以下 四个 方面 的 功能 审计 设备 用来 截获 所有 http 数据 或者 仅仅 满足 某些 规则 的 会话 访问 控制 设备 用来 控制 对 web 应用 的 访问 既 包括 主动 安全 模式 也 包括 被动 安全 模式 架构 网络 设计 工具 当 运 行在 反向 代理 模式 他们 被 用来 分配 职能 集中控制 虚拟 基础 结构 等 web 应用 加固 工具 这些 功能 增强 被 保护 web 应用 的 安全性 它不 仅 能够 屏蔽 web 应用 固有 弱点 而且 能够 保护 web 应用 编程 错误 导致 的 安全隐患 waf 过滤 机制 异常 检测 协议 拒绝 不符合 http 标准 的 请求 增强 的 输入 验证 代理 和 服务端 的 验证 而 不只是 限于 客户端 验证 白名单 amp 黑名单 白名单 适用于 稳定 的 web 应用 黑名单 适合 处理 已知 问题 基于 规则 和 基于 异常 的 保护 基于 规则 更多 的 依赖 黑名单 机制 基于 异常 更为 灵活 状态 管理 重点 进行 会话 保护 其他 cookies 保护 抗 入侵 规避 技术 响应 监视 和 信息 泄露 保护 等 绕过 waf 的 方法 从 目前 能 找到 的 资料 来看 绕过 waf 的 技术 主要 分为 类 包含 大小写 混合 最 简单 的 绕过 技术 用于 只 针对 小写 或 大写 的 关键字 匹配 技术 替换 关键字 这种 方式 大小写 转化 无法 绕过 而且 正则表达式 会 替换 或 删除 selectunion 这些 关键字 如果 只 匹配 一次 就很 容易 绕过 使用 编码 url 编码 unicode 编码 使用 注释 普通 注释 内联 注释 等价 函数 与 命令 有些 函数 或 命令 因其 关键字 被 检测 出来 而 无法 使用 但是在 很多 情况下 可以 使用 与 之 等价 或 类似 的 代码 替代 其 使用 特殊符号 特殊符号 有 特殊 的 含义 和 用法 涉及 信息量 比 前面 提到 的 几种 都要 多 http 参数 控制 这里 http 参数 控制 除了 对 查询 语句 的 参数 进行 篡改 还 包括 http 方法 http 头 的 控制 缓冲区 溢出 缓冲区 溢出 用于 对付 waf 有 不少 waf 是 c 语言 写 的 而 c 语言 自身 没有 缓冲区 保护 机制 因此 如果 waf 在 处理 测试 向量 时 超 出了 其 缓冲区 长度 就会 引发 bug 从而 实现 绕过 整合 绕过 整合 的 意思 是 结合 使用 前面 谈到 的 各种 绕过 技术 单一 的 技术 可能 无法 绕过 过滤 机制 但是 多种 技术 的 配合 使用 成功 的 可能性 就会 增加 不少 除非 每一种 技术 单独 都 无法 使用 否则 它们 能 产生 比 自身 大得多 的 能量 二 身份 认证 失效 通过 错误 地 使用 web 应用程序 的 身份 认证 和 会话 管理 功能 攻击者 能够 破译 密码 密钥 和 会话 令牌 或者 利用 其它 开发 缺陷 来 暂时性 或 永久 性地 冒充 管理员 的 身份 可利用 性 容易 攻击者 可以 轻松 获取 数百 万条 有效 用户名 和 密码 组合 包括 证书 默认 的 账户 管理 列表 自动 的 暴力破解 和 字典 攻击 工具 以及 高级 的 gpu 破解 工具 会话 管理 可以 很 容 易地 被 利用 尤其是 没有 过期 的 会话 密 匙 普遍性 常见 大多数 管理 系统 的 设计 和 实现 都 存在 身份 认证 失效 的 问题 会话 管理 是 身份验证 和 访问 控制 的 基础 并且 存在于 整个 应用程序 的 进程 中 可 检测 性 一般 攻击者 通常 使用指南 手册 来 检测 失效 的 身份验证 除此之外 也 会 关注 密码 转 储 字典 攻击 或者 在 类似 钓鱼 社会 工程 攻击 后 发现 失效 的 身份 认证 技术 影响 严重 攻击者 只需 访问 几个 账户 或者 一个 管理员 账户 就可以 破坏 我们 的 系统 根据 应用程序 业务 场景 的 不同 可能会 导致 洗钱 欺诈 用户 身份 盗窃 泄露 法律保护 的 敏感 信息 等 严重 违法行为 自查 您 的 应用程序 脆弱 吗 确认 用户 身份 身份验证 和 会话 管理 非常重要 这些 措施 可 用于 将 恶意 的 未经 身份验证 的 攻击者 与 授权 用户 进行 分离 如果您 的 应用程序 存在 如下 问题 那么 可能 存在 身份验证 失效 漏洞 允许 凭证 填充 攻击者 可利用 此 获得 有效 的 用户名 和 密码 允许 暴力破解 或 其他 自动 攻击 使用 默认 弱 安全性 的 密码 例如 password 或 adminadmin 使用 弱 安全性 或 失效 的 验证 凭证 使用 明文 加密 或 弱 散 列 密码 缺少 或 失效 的 多 因素 身份验证 暴露 url 中 的 会话 id 例如 url 重 写在 成功 登录 后 不会 更新 会话 id 不 正确地 使 会话 id 失效 当 用户 不 活跃 的 时候 用户 会话 或 认证 令牌 特别是 单点 登录 sso 令牌 没有 正确 注销 或 失效 在 尽可能 的 情况下 使用 多 因素 身份验证 以 防止 凭证 填充 暴力破解 和 被盗 凭据 再利用 攻击 不要 使用 已 发送 或 部署 默认 的 凭证 特别是 管理员 用户 定期 执行 弱 密码 检查 将 密码 长度 复杂性 和 循环 策略 与 nistb 的 指导方针 或 其他 现代 的 密码 策略 保持一致 确认 注册 凭据 恢复 和 api 路径 确保 对 所有 输出 结果 使用 相同 的 消息 用以 抵御 账户 枚举 攻击 限制 或 逐渐 延迟 失败 的 登录 尝试 记录 所有 失败 信息 并在 凭据 填充 暴力破解 或 其他 攻击 被 检 测时 提醒 系统管理员 使用 服务器端 内置 的 会话 管理器 在 登录 后 生成 高度 复杂 且不 存在于 url 的 随机 会话 id 这样 当 用户 登出 闲置 绝对 超时 后 使其 失效 如何 防止 攻击 案例 场景 场景 最常 见 的 攻击方式 凭证 填充 使用 已知 密码 的 列表 如果 应用程序 不 限制 身份验证 证 尝试 次数 则 可以 将 应用程序 用作 密码 oracle 以 确定 凭证 是否 有效 场景 大多数 身份验证 攻击 都是 由于 密码 作为 唯一 的 认证 因素 场景 应用 会话 超时 设置 不正确 用户 使用 公共 计算机 访问 应用程序 时 直接 关闭 浏览器 选项卡 就 离开 而 不是 选择 注销 凭据 填充 撞 库 撞 库 是 黑客 通过 收集 互联网 已 泄露 的 用户 和 密码 信息 生成 对应 的 字典 表 尝试 批量 登陆 其他 网站 后 得到 一系列 可以 登录 的 用户 很多 用户 在 不同 网站 使用 的 是 相同 的 账号 和 密码 因此 黑客 可以 通过 获取 用户 在 a 网站 的 账户 从而 尝试 登录 b 网站 这 就是 撞 库 攻 击撞 库 可以 通过 数据库 安全 防护 技术 解决 数据库 安全 技术 包括 数据库 漏 扫 数据库 加密 数据库 防火墙 数据 脱敏 数据库 安全 审计 系统 撞 库 并不 神秘 事实上 它 正被 广泛 的 使用 举例 而言 根据 shapesecurity 的 报告 攻击者 们 一旦 锁定 了 一个 财 富强 的 bc 企业 对 消费者 网站 就 会在 一个 星 期内 使用 遍布 世界各地 的 代理服务器 对 其 进行 超过 五百万 次 登录 尝试 雪上加霜 的 是 被 窃取 的 凭证 也 并不 难找 黑客 们 会 为了 找 乐子 或 寻求 扬名立万 的 机 会把 凭证 散 播到 网 上当 黑客 们 在 凭证 黑市 比如 以及 做生意 时 这些 名声 会 派上 大用场 多 因素 验证 多 因素 验证 缩写 为 mfa 又 译 多因子 认证 多 因素 认证 是 一种 计算机 访问 控制 的 方法 用户 要 通过 两种 以上 的 认证 机制 之后 才能 得到 授权 使用 计算机 资源 例如 用户 要 输入 pin 码 插入 银行卡 最后 再经 指纹 比对 通过 这三种 认证 方式 才能 获得 授权 这种 认证 方式 可以 提高 安全性 三 敏感数据 泄露 许多 web 应用程序 和 api 都 无法 正确 保护 敏感数据 例如 财务数据 医疗 数据 和 pii 数据 攻击者 可以 通过 窃取 或 修改 未 加密 的 数据 来 实施 信用卡 诈骗 身份 盗窃 或 其他 犯罪行为 未 加密 的 敏感数据 容易 受到破坏 因此 我们 需 要对 敏感数据 加密 这些 数据 包括 传输 过程中 的 数据 存储 的 数据 以及 浏览器 的 交互 数据 可利用 性 一般 攻击者 并非 直接 攻击 而是 在 传输 过程中 从 客户端 例如 浏览器 窃取 密钥 发起 中间人 攻击 或 从 服务器端 直接 窃取 明文 数据 普遍性 广泛 这是 最常 见 也是 最具 影响力 的 攻击 手段 在 数据 加密 的 过程中 由于 不安全 的 密钥 生成 管理 以及 使用 弱 加密算法 弱 协 议和 弱 密码 未 加盐 的 哈希 算法 或 弱 哈希 算法 导致 数据 泄露 事件 频 发 可 检测 性 一般 在 服务器端 检测 传输 过程中 的 数据 弱点 很 容易 但 检测 存储 数据 的 弱点 却 异常 困难 技术 影响 严重 敏感数据 泄露 事件 造成 的 影响 是 非常 严重 的 因为 这些 数据 通常 包 含了 很多 个人信息 pii 例如 医疗 记录 认证 凭证 个人隐私 信用卡 信息 等 这些 信息 受到 相关 法律 和 条例 的 保护 例如 欧盟 通用 数据 保护 条例 gdpr 和 地方 隐私 保护 法律 自查 您 的 应用程序 脆弱 吗 首先 你 需要 确认 哪些 数据 包含 传输 过程中 的 数据 存储 数据 是 敏感数据 例如 密码 信用卡 卡号 医疗 记录 个人信息 等 这些 数据 应 该被 加密 请 review 在 数据传输 过程中 是否 使用 明文 传输 这 和 传输 协议 相关 如 httpsmtp 和 ftp 注意 外网 流量 十分 危险 请 验证 所有 的 内部 通信 如 负载 平衡器 web 服务器 或 后端 系统 之间 的 通信 当 数据 被 长期 存储 时 无论 存储 在 哪里 它们 是否 都被 加密 或 备份 无论 默认 条件 还是 源代码 中 是否 还在 使用 任何 旧 的 脆弱 的 加密算法 是否 使用 默认 加密 密钥 生成 或 重复使用 脆弱 的 加密 密钥 或者 缺少 恰当 的 密钥 管理 或 密钥 回转 是否 强制 加密 敏感数据 例如 用户 代理 如 浏览器 指令 传输 协议 是否 被 加密 用户 代理 如 应用程序 邮件 客户端 是否 未 验证 服务器端 证书 的 有效性 如何 防止 对 一些 需要 加密 的 敏感数据 应该 做到 以下几点 对 系统 处理 存储 或 传输 的 数据 分类 并 根据 分类 分别 进行 访问 控制 熟悉 与 敏感数据 保护 相关 的 法律 和 条例 并 根据 每项 法规 的 要求 保护 敏感数据 对于 没必要 存放 但 重要 的 敏感数据 应当 尽快 清除 或者 通过 pcidss 标记 或 拦截 只有 未 存储 的 数据 才 不会 被 窃取 确保 已 存储 的 所有 敏感数据 都被 加密 确保 使 用了 最新 强大 的 标准 算法 或 密码 参数 协 议和 密钥 并且 密钥 管理 到位 确保 传输 过程中 的 数据 被 加密 如 使用 tls 确保 数据 加密 被 强制执行 如 使用 http 严格 安全 传输 协议 hsts 禁止 缓存 对 包含 敏感数据 的 响应 确保 使用 密码 专用 算法 存储 密码 如 或 pbkdf 将 工作 因素 延迟 因素 设置 在 可接受 的 范围 单独 验证 每个 安全 配置 项 的 有效性 攻击 案例 场景 场景 假设 一个 应用程序 使用 自动化 的 数据 加密 系统 加密 了 信用卡 信息 并 存储 在 数据库 中 当 数据 被 检索 时 自动 解密 这会 导致 sql 注入 漏洞 能够 以 明文 形式 获得 所有 信用卡 卡号 场景 一个 网 站上 没有 使用 或 强制 使用 tls 或者 仅 使用 弱 加密算法 攻击者 通过 监测 网络流量 如不 安全 的 无线网络 将 网络连接 从 https 降级 到 http 就可以 截取 请求 并 窃取 用户 会话 cookie 然后 攻击者 可以 复制 用户 cookie 并 成功 劫持 经过 认证 的 用户 会话 访问 或 修改 用户 个人信息 除此之外 攻击者 还 可以 更改 所有 传输 过程中 的 数据 如 转款 的 接收者 场景 密码 数据库 使用 未 加盐 的 哈希 算法 或 弱 哈希 算法 去 存储 密码 此时 一个 文件 上传 漏洞 可使 黑客 能够 获取 密码文件 而 这些 未 加盐 的 哈希 密码 通过 彩虹 表 暴力破解 方式 即可 快速 破解 各国 应对 措施 日本 个人信息 保护法 近年来 因 信息 通信 技术 的 发展 企业 需要 收集 大量 个人信息 用以 提供 准确 且 迅速 的 服务 个人信息 的 利用 无论是 对 现今 的 商业活动 还是 对 国民 生活 都 变得 不可或缺 但是 另一方面 由于 处理 个人信息 状况 不当 导致 个人 权利 和 利益 受到 损害 的 可能性 也 在 增大 在 日本 包含 企业 和 政府 等 团体 的 组织 内部 泄露 的 个人信息 数量 累积 超 过了 万件 于是 鉴于 规范 处理 个人信息 明确 国家 及 地方 公共 团体 的 职责 确保 个人信息 有效 利用 等 目的 日本 于 年月日 起 颁布 个人信息 保护法 欧盟 通用 数据 保护 条例 gdpr 欧盟 通用 数据 保护 条例 简称 gdpr 其 前身 是 欧盟 在年 制定 的 计算机 数据 保护法 该 法 明确规定 对 违法 企业 的 罚金 最高 可达 万 欧元 约 合 亿元 人民币 或 其 全球 营业额 的 以 高 者 为准 网站 经营者 必须 事 先向 客户 说明 会 自动记录 客户 的 搜索 和 购物 记录 并 获得 用户 的 同意 否 则按 未 告知 记录 用户 行为 作 违法 处理 企业 不能 再 使用 模糊 难以 理解 的 语言 或 冗长 的 隐私 政策 来 从 用户 处 获取 数据 使用 许可 明文规定 了 用户 的 被 遗忘 权 即 用户 个人 可以 要求 责任 方 删除 关于 自己 的 数据 记录 设计 安全 账号 系统 的 正确 姿势 数据 安全 防范 的 方法 简单 来说 当 数据 从 用户 键盘 敲出 的 那一 刻到 服务器 后台 存储 过程 中都 需 保持 正确 的 姿势 如用 正确 的 姿势 保存 密码 a 低级 错误 明文 保存 密码 b 低级 错误 可逆 加密 密码 c 错误方法 md 加密 密码 d 正确 方法 加盐 hash 保存 密码 用 正确 的 姿势 传输 数据 a 验证 服务端 的 合法性 b 确保 通信 的 安全 用 正确 的 姿势 加密 敏感 信息 用 正确 的 姿势 对 数据 进行 备份 和 监控 四 xml 外部 实体 xxe 许多 较早 的 或 配置 错误 的 xml 处理器 评估 了 xml 文件 中 的 外部 实体 引用 攻击者 可以 利用 外部 实体 窃取 使用 uri 文件 处理器 的 内部 文件 和 共享 文件 监听 内部 扫描 端口 执行 远程 代码 和 实施 拒绝服务 攻击 可利用 性 一般 如果 攻击者 可以 上传 xml 文档 或在 xml 文档 中 添加 恶意 内容 如 易受攻击 的 代码 依赖 项 或 集成 他们 就 能够 攻击 含有 缺陷 的 xml 处理器 普遍性 常见 一般来说 许 多旧 的 xml 处理器 能够 对 外部 实体 xml 进程 中被 引用 和 评估 的 uri 进行 规范 sast 工具 可以 通过 检查 依赖 项 和 安全 配置 来 发现 xxe 缺陷 dast 工具 需要 额外 的 手动 步骤 来 检测 和 利用 xxe 缺陷 技术 影响 严重 xxe 缺陷 可 用于 提取 数据 执行 远程 服务器 请求 扫描 内部 系统 执行 拒绝服务 攻击 和 其他 攻击 自查 您 的 应用程序 脆弱 吗 应用程序 特别是 基于 xml 的 web 服务 可能在 以下 方面 容易 受到 攻击 您 的 应用程序 直接 接受 xml 文件 或者 接受 xml 文件 上传 特别是 来自 不受 信任 源 的 文件 或者 将 不受 信任 的 数据 插入 xml 文件 并提 交给 xml 处理器 解析 在 应用程序 或 基于 web 服务 的 soap 中所 有 xml 处理器 都 启 用了 文档 类型 定义 dtds 为了 实现 安全性 或 单点 登录 sso 您 的 应用程序 应该 使 用了 saml 进行 身份 认证 而 假设 saml 使 用了 xml 进行 身份 确认 那么 您 的 应用程序 就 容易 受到 xxe 攻击 如果您 的 应用程序 使用 第 版 之前 的 soap 并将 xml 实体 传递 到 soap 框架 那么 它 可能 受到 xxe 攻击 存在 xxe 缺陷 的 应用程序 更 容易 受到 拒绝服务 攻击 如 billionlaughs 攻击 如何 防止 培训 开发人员 的 安全意识 是 识别 和 减少 xxe 的 关键 除此之外 还需要 尽可能 地 使用 简单 的 数据格式 如 json 避免 对 敏感数据 进行 序列化 及时 修复 或 更新 应用程序 或 底层 操作系统 使用 的 xml 处理器 和 库 同时 通过 依赖 项 检测 将 soap 更 新到 版本 或 更高 版本 参考 在 应用程序 的 所有 xml 解析器 中 禁用 xml 外部 实体 和 dtd 进程 在 服务器端 实施 白名单 输入 验证 过滤 和 清理 以 防止 在 xml 文档 标题 或 节点 中 出现 恶意 数据 验证 xml 或 xsl 文件 上传 功能 是否 使 用了 xsd 验证 或 其他 类似 的 验证 尽管 在 许多 集成 环境 中 手动 代码 审查 是 大型 复杂 应用程序 的 最佳 选择 但是 sast 工具 可以 检测 源代码 中 的 xxe 漏洞 如果 无法 实现 这些 控制 请 考虑 使用 虚拟 修复 程序 api 安全 网关 或 web 应用程序 防火墙 waf 来 检测 监控 和 防止 xxe 攻击 攻击 案例 场景 目前 已经有 大量 xxe 缺陷 被 发现 并 公开 这些 缺陷 包括 上传 可被 接受 的 恶意 xml 文件 嵌入式 设备 的 xxe 缺陷 及 深 嵌套 的 依赖 项 等 场景 攻击者 尝试 从 服务端 提取 数据 场景 攻击者 通过 将上 面的 实体 行 更 改为 以下内容 来 探测 服务器 的 专用 网络 场景 攻击者 通过 恶意 文件 执行 拒绝服务 攻击 基本 定义 xml 是 用于 标记 电子 文件 使其 具有 结构性 的 标记 语言 可以 用来 标记 数据 定义 数据类型 是 一种 允许 用户 对 自己 的 标记 语言 进行 定义 的 源语言 xml 文档 结构 包括 xml 声明 dtd 文档 类型 定义 可选 文档 元素 图片 来自 网络 xml 由 个 部分 构成 分 别是 文档 类型 定义 documenttyp pedefinitiondtd 即 xml 的 布局 语言 可 扩展 的 样式 语言 即 xml 的 样式表 语言 以及 可 扩展 链接 语言 中 的 实体 分为 以下 五种 字符 实体 命名 实体 外部 实体 参数 实体 内部 实体 普通 实体 和 参数 实体 都 分为 内部 实体 和 外部 实体 两种 外部 实体 定义 需要 加上 system 关键字 其 内容 是 url 所 指向 的 外部 文件 实际 的 内容 如果 不加 system 关键字 则为 内部 实体 表示 实体 指代 内容 为 字符串 xml 外部 实体 xml 外部 实体 表示 外部 文件 的 内容 用 system 关键词 表示 有些 xml 文档 包含 system 标识符 定义 的 实体 这些 文档 会在 doctype 头部 标签 中 呈现 这些 定义 的 实体 能够 访问 本地 或者 远程 的 内容 比如 下面 的 xml 文档 示例 就 包 含了 xml 实体 在上 面的 代码 中 xml 外部 实体 entityex 被 赋予 的 值 为 fileetcpasswd 在 解析 xml 文档 的 过程中 实体 entityex 的 值 会被 替 换为 uri fileetcpasswd 内容 值 也 就是 passwd 文件 的 内容 关键字 system 会 告诉 xml 解析器 entityex 实体 的 值 将从 其后 的 uri 中 读取 并把 读取 的 内容 替换 entityex 出现 的 地方 假如 system 后面 的 内容 可以 被 用户 控制 那么 用户 就可以 随意 替 换为 其他 内容 从而 读取 服务器 本地 文件 fileetcpasswd 或者 远程 文件 注入 定义 xxe 注入 即 外部 实体 注入 通过 xml 实体 system 关键词 导致 xml 解析器 可以 从 本地 文件 或者 远程 uri 中 读取 数据 攻击者 可以 通过 xml 实体 传递 自己 构造 的 恶意 值 从而 引导 处理 程序 解析 它 当 引用 外部 实体 时 攻击者 通过 构造 恶意 内容 可 读取 任意 文件 执行 系统 命令 探测 内网 端口 攻击 内网 网站 等 行为 xxe 漏洞 原理 最常 见 的 xxe 漏洞 类型 分为 以下 三种 基础 的 xxe 注入 外部 实体 注入 本地 dtd 基于 盲 注 的 xxe 注入 xml 解析器 在 响应 中 不 显示 任何 错误 基于 错误 的 xxe 注入 成功 解析 之后 xml 解析器 始终 显示 same 响 应即 您 的 消息 已被 接收 因此 我们 可能 希望 解析器 将 文件 的 内容 打 印到 错误 响应 中 既然 xml 可以 从 外部 读取 dtd 文件 那 我们 就 自然地 想到 了 如果 将 路径 换成 另一个 文件 的 路径 那么 服务器 在 解析 这个 xml 的 时候 就 会把 那个 文件 的 内容 赋值 给 system 前面 的 根 元素 中 只要 我们 在 xml 中 让 前面 的 根 元素 的 内容 显示出来 就可以 读取 那个 文件 的 内容 了 这就 造成了 一个 任意 文件 读取 的 漏洞 假设 我们 指向 的 是 一个 内网 主机 的 端口 呢 是否 会给 出 错误信息 我们 是不是 可以 从 错误信息 上来 判断 内网 主机 这个 端口 是否 开放 这就 造成了 一个 内部 端口 被 探测 的 问题 一般来说 服务器 解析 xml 有 两种 方式 一种 是 一次性 将 整个 xml 加载 进 内存 中 进行 解析 另一种 是 一部分 的 流式 地 加载 解析 如果 我们 递归 地 调用 xml 定义 一次性 调用 巨量 的 定义 那么 服务器 的 内存 就 会被 消耗 完 造成了 拒绝服务 攻击 五 失效 的 访问 控制 未 对 通过 身份验证 的 用户 实施 恰当 的 访问 控制 攻击者 可以 利用 这些 缺陷 访问 未经 授权 的 功能 或 数据 例如 访问 其他用户 的 账户 查看 敏感 文件 修改 其他用户 的 数据 更改 访问 权限 等 六 安全 配置 错误 安全 配置 错误 是 最常 见 的 安全问题 这 通常是 由于 不安全 的 默认 配置 不完整 的 临时 配置 开源 云 存储 错误 的 http 标 头 配置 以及 包含 敏感 信息 的 详细 错误信息 所 造成 的 因此 我们 不仅 需 要对 所有 的 操作系统 框架 库 和 应用程序 进行 安全 配置 而且 必须 及时 修补 和 升级 它们 七 跨 站 脚本 xss 当 应用程序 的 新 网页 中 包含 不受 信任 的 未经 验证 或 转义 的 数据 时 或者 使用 可以 创建 html 或 javascript 的 浏览器 api 更新 现有 网页时 就会 出现 xss 缺陷 xss 让 攻击者 能够 在 受害者 的 浏览器 中 执行 脚本 并 劫持 用户 会话 破坏 网站 或 将 用户 重定向 到 恶意 站点 可利用 性 容易 自动化 工具 能够 检测 并 利用 所有 的 三种 xss 形式 并且 存放在 便于 攻击者 利用 的 漏洞 中 普遍性 广泛 xss 是 owasptop 中 第二 普遍 的 安全问题 存在于 近 三分之二 的 应用程序 中 可 检测 性 容易 自动化 工具 能 发现 xss 问题 尤其是 一些 成熟 的 技术 框架 中 如 phpjee 或 jspaspnet 等 技术 影响 中等 xss 对于 反射 和 dom 的 影响 是 中等 的 而 对于 存储 的 xssxss 的 影响 更为严重 譬 如在 受到 攻击 的 浏览器 上 执行 远程 代码 如 窃取 凭证 和 会话 或 传递 恶意 软件 等 自查 您 的 应用程序 脆弱 吗 针对 用户 的 浏览器 存在 三种 xss 类型 反射式 xss 应用程序 或 api 包含 未经 验证 和 未经 转义 的 用户 输入 并 作为 html 输出 的 一部分 受到 此类 攻击 可以 让 攻击者 在 受害者 的 浏览器 中 执行 任意 的 html 和 javascript 存储 式 xss 你 的 应用 或者 api 将 未 净化 的 用户 输入 进行 存储 并在 其他用户 或者 管理员 的 页面 展示 出来 存储 型 xss 一般 被 认为是 高危 或 严重 的 风险 基于 dom 的 xss 会 动态 的 将 攻击者 操控 的 内容 加入到 页面 的 javascript 框架 单 页面 程序 或 api 中 为 避免 此类 攻击 你 应该 禁止 将 攻击者 可控 的 数据 发送给 不安全 的 javascriptapi 典型 的 xss 攻击 造成 的 结果 包含 盗取 session 账户 绕过 mfadiv 替 换对 用户 浏览器 的 攻击 例如 恶意 软件 下载 键盘记录 以及 其他用户 侧 的 攻击 如何 防止 防止 xss 需要 将不 可信 的 数据 与 动态 的 浏览器 内容 区 分开 使用 已 解决 xss 问题 的 框架 如 ruby 或 reactjs 了解 每个 框架 对 xss 保护 的 局限性 并 适当地 处理 未 覆盖 的 用 例 为了 避免 反射式 或 存储 式 的 xss 漏洞 最好 的 办法 是 根据 html 输出 的 上下文 包括 主体 属性 javascriptcss 或 url 对 所有 不 可信 的 http 请求 数据 进行 恰当 的 转义 在 客户端 修改 浏览器 文档 时 为了 避免 domxss 攻击 最好 的 选择 是 实施 上下文 敏感 数据编码 如果 这种 情况 不能 避免 可以 采用 一 文中 描述 的 类似于 上下文 敏感 的 转义 技术 并 应用于 浏览器 api 使用 内容 安全策略 csp 是 对抗 xss 的 最终 防御 策略 如果 不存在 可以 通过 本地 文件 存放 恶意代码 的 漏洞 例如 路径 遍历 覆盖 和 允许 在 网络 中 传输 的 易受攻击 的 库 则 该 策略 是 有效 的 攻击 案例 场景 场景 应用程序 在下 面的 html 代码 段 构造 中使 用了 未经 验证 或 转义 的 不 可信 的 数据源 string cc gt 攻击者 在 浏览器 中 修改 cc 参数 为 如下 值 这个 攻击 会 导致 受害者 的 会话 id 被发 送到 攻击者 的 网站 使得 攻击者 能够 劫持 用户 当前 会话 内容 安全策略 csp 内容 安全策略 csp 是 一个 额外 的 安全 层 用于 检测 并 削弱 某些 特定 类型 的 攻击 包括 跨 站 脚本 xss 和 数据 注入 攻击 等 无论是 数据 盗取 网站 内容 污染 还是 恶意 软件 这些 攻击 都是 主要 的 手段 csp 被 设计 成 完全 向后 兼容 除 csp 在 向后 兼容 有 明确 提及 的 不一致 外 不支持 csp 的 浏览器 也 能与 实现 了 csp 的 服务器 正常 合作 反之亦然 不支持 csp 的 浏览器 只会 忽略 它 如常 运行 默 认为 网页 内容 使用 标准 的 同源 策略 如果 网站 不 提供 cspheader 浏览器 将 使用 标准 的 同源 策 略为 使 csp 可用 你 需要 配置 你 的 网络服务器 返回 有时 你 会 看到 一些 关于 的 提法 那是 旧版本 你 无须再 如此 指定 它 除此之外 ltmetagt 元素 也 可以 被 用来 配置 该 策略 例如 上下文 敏感 数据编码 xss 编码 与 绕过 对于 了解 web 安全 的 朋友 来说 都 知道 xss 这种 漏洞 其 危害性 不用 强调 一般 对于 该 漏洞 的 防护 有 两个 思路 一是 过滤 敏感 字符 诸如 ltgtscript 等 另一种 是 对 敏感 字符 进行 html 编码 诸如 php 中 的 函数 一般 情况 正确 实施 这两种 方案 之一 就可以 有效 防御 xss 漏洞 了 但 其实 也 会有 一些 场景 即使 实施 了 这两种 方案 攻击者 也 可以 绕过 防护 导致 xss 漏洞 被 利用 场景 一 xss 注入 点在 某个 html 标签 属性 中 代码 片段 如下 可以 看到 这里 防护 措施 采用 的 是 方案 一 过滤 敏感 字符 这里 如果 输入 javascriptalert 是 会被 过滤掉 的 输出 的 内容 会是 场景 二 xss 注入 点在 js 标签 中 代码 片段 如下 这里 采用 的 防护 措施 是 第二种 即 使用 php 内置 函数 对 敏感 字符 进行 编码 如果 输入 正常 的 payload 如 gt 是 不会有 弹窗 的 此时 浏览器 的 输出 如 下图 这里 的 敏感 字符 ltgt 已经 被 html 编码 了 最后 在 ltdivgt 标签 里面 输出 的 时候 浏览器 再 使用 html 解码 将其 原文 显示出来 但是 并不会 触发 js 引擎 所以 也就 没有 弹窗 下图 是 js 编码 后 的 payload 八 不安全 的 反 序列化 不安全 的 反 序列化 会 导致 远程 代码 执行 即使 反 序列化 缺陷 不会 导致 远程 代码 执行 攻击者 也 可以 利用 它们 来 执行 攻击 包括 重播 攻击 注入 攻击 和 特权 升级 攻击 可利用 性 难 对 反 序列化 的 利用 非常 困难 因为 在 不 更改 或 调整 底层 可被 利用 代码 的 情况下 现成 的 反 序列化 漏洞 很 难被 使用 可 检测 性 一般 有些 工具 可以 被 用于 发现 反 序列化 缺陷 但 经常 需要 人工 帮助 来 验证 发现 的 问题 希望 有 关反 序列化 缺陷 的 普遍性 数据 将 随着 工具 的 开发 而 被 更多 的 识别 和 解决 技术 影响 严重 反 序列化 缺陷 的 影响 不能 被 低估 它们 们 可能 导致 远程 代码 执行 攻击 这是 可能发生 的 最 严重 的 攻击 之一 自查 您 的 应用程序 脆弱 吗 如果 反 序列化 进攻者 提供 恶意代码 或者 被 篡 改过 的 对象 将 会使 整个 应用程序 和 api 变 的 脆弱 这 可能会 导致 以下 两种 主要 类型 的 攻击 如果 应用 中 存在 可以 在 反 序列化 过程中 或者 之后 被 改变 行为 的 类 则 攻击者 可以 通过 改变 应用逻辑 或者 实现 远程 代码 执行 攻击 这种 攻击方式 被称为 对象 和 数据结构 攻击 典型 的 数据 篡改 攻击 如 访问 控制 相关 的 攻击 其中 使 用了 现有 的 数据结构 但 内容 发 生了 变化 在 应用程序 中 序列化 可能 被 用于 远程 和 进程 间 通信 rpcipc 连线 协议 web 服务 消息 代理 缓存 持久性 数据库 缓存 服务器 文件 系统 httpcookiehtml 表单 参数 api 身份验证 令牌 如何 防止 唯一 安全 的 架构 模式 是 不接受 来自 不受 信源 的 序列化 对象 或 使用 只允许 原始 数据类型 的 序列化 媒体 如果 上述 均 无法 实现 请 考虑 使用 下面 的 方法 执行 完整性 检查 如 任何 序列化 对象 的 数字签名 以 防止 恶意 对象 创建 或 数据 篡 改在 创建 对象 之前 强制执行 严格 的 类型 约束 因为 代码 通 常被 期望 成 一组 可定义 的 类 绕过 这种 技术 的 方法 已经 被 证明 所以 完全 依赖于 它是 不 可取 的 如果 可能 隔离 运行 那些 在 低 特权 环境 中 的 反 序列化 代码 记录 反 序列化 的 例外情况 和 失败 信息 如 传入 的 类型 不是 预期 的 类型 或者 反 序列 处理 引发 的 例外情况 限制 或 监视 来自于 容器 或 服务器 传入 和 传出 的 反 序列化 网络连接 监控 反 序列化 当 用户 持续 进行 反序 列 化时 对 用户 进行 警告 攻击 案例 场景 场景 一个 react 应用程序 调 用了 一组 springboot 微 服务 为了 确保 原有 的 代码 不变 解决方法 是 序列化 用户 状态 并在 每次 请求 时 来回 传递 这时 攻击者 可利用 rjava 对象 签名 并 使用 工具 在 应用服务器 上 获得 远程 代码 执行 场景 一个 php 论坛 使用 php 对象 序列化 来 保存 一个 超级 cookie 该 cookie 包 含了 用户 的 id 角色 密码 哈希 和 其他 状态 攻击者 可以 更改 序列化 对象 以 授予 自己 为 admin 权限 九 使用 含有 已知 漏洞 的 组件 组件 例如 库 框架 和 其他软件 模块 拥有 和 应用程序 相同 的 权限 如果 应用程序 中含有 已知 漏洞 的 组件 被 攻击者 利用 可能会 造成 严重 的 数据 丢失 或 服务器 接管 同时 使用 含有 已知 漏洞 的 组件 和 api 会 破坏 应用程序 的 防御 手段 造成 各种 攻击 并 产生 严重影响 十 不足 的 日志 记录 和 监控 不足 的 日志 记录 和 监控 以及 事件 响应 缺失 或 无效 的 集成 使 攻击者 能够 进一步 攻击 系统 并 篡改 提取 或 销毁 数据 大多数 缺陷 研究 显示 缺陷 被 检 测出 的 时间 超 过天 且 通常 通过 外部 检测 方 检测 而 不是 通过 内部 流程 或 监控 检测 未雨绸缪 项 目中 如何 应对 开发人员 需要 做些 什么 提高 风险意识 codereview 建立 可 重复使用 的 安全 流程 和 标准 安全 控制 安全 检测工具 a zaptoolsb 静态 代码 分析 建立 持续性 的 应用 安全 测试 管理 完整 的 应用程序 生命周期 以上 便是 从 本次 公开课 分享 webapp 安全 风险 与 防护 系列 二中 截取 的 部分内容 相信 一定 能对 您 的 webapp 应用程序 安全 防护 有所 帮助 下面 奉上 上期 完整 的 回放 转 载于 