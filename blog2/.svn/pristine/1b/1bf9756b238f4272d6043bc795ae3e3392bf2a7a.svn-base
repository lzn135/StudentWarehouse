构建 复杂 游戏 的 又一 神器 前言 事件 机制 相信 很多人 都 知道 了解 也 经常 用到 在 设计 模式 中 它 叫 观察者 模式 又叫 发布 订阅 模式 它 无处不在 在 java 中 它是 java 的 核心 库 在 c 中 为 它 提供 了 语法 糖 支持 event 关键字 在 web 浏览器 的 javascript 中有 内置 的 事件 机制 在 nodejs 中 也有 内置 库 events 在 游戏 引擎 中 也 都是 内置 的 存在 cocoscreator 的 的 其他 引擎 都有 使用 这种 模式 可以 让我们 更好 地 解 耦 游戏 业务 逻辑 但是 这些 事件 机制 的 在 js 和 ts 中 的 实现 没 能让 我 觉得 满意 我 都是 使 用过 总觉得 缺 了点 什么 携带 数据 没 类型 提示 消息 发送者 没法 获 得要 发送 消息 携带 的 数据类型 提示 消息 接收者 没法 获得 发送 过来 的 数据类型 提示 面对 复杂 的 通信 情况 没 内置 支持 想在 消息 发送 点 接 收到 消息 接收器 返回 的 数据 如果 自己 实现 将回 调包 在 数据 中 传给 消息 接收者 让 它 执行 这个 回 调 事件 发出 去了 但 消息 接收者 还没 注册 错 过了 不 内置 支持 状态 管理 很多 地方 需要 监听 角色 等级 变化 事件 然后 去 角色 信息 接口 取 角色 等级 状态 做 业务 处理 也 就是 我们 需 要在 多个 地方 监听 同一个 状态 变化 然 后去 某个 接口 取出 当前 状态 做 业务 处理 很多 时候 我们 会 遇到 类似 这种 需求 这样 的 处理 重复 而 不 优雅 突然 有 一天 逛 掘金 看到 这么 一个 文章 分享 构建 复杂 应用 的 神器 fbroadcast 演示 demo 测试 展示 看完 后 脑子里 只有 一个字 这 就是 我 想要 的 神器 虽然 它是 用 dart 写给 flutter 但 没关系 借鉴 一下 用 typescript 重写 一下 ps 部分 说明 也是 复制 过来 的 我 喜欢 逛 掘金 虽然 他们 大多是 分享 web 前端 相关 的 知识 但也 有 很多 可以 借鉴 用到 游戏 前端 的 地方 受益匪浅 介绍 一个 基于 typescript 的 一套 高效 灵活 的 广播 系统 可以 帮助 开发者 轻松 有序 的 构建 具有 极具 复杂性 的 关联 交互 和 状态 变化 的 游戏 和 应用 特性 基础 事件 机制 的 支持 消息 支持 携带 任意 类型 的 数据 并有 类型 提示 支持 函数 this 绑定 或 任意 类型 作为 环境 一行 代码 就可以 移除 环 境内 所有 的 接收者 易于 构建 局部 全局 的 状态 管理 支持 双向通信 支持 不可思议 的 粘性 广播 基于 typescript 并 提供 极度 舒适 的 类型 提示 安装 获取 源码 获取 文件 路径 安装 注意 则需 要到 dist 文件 夹下 取出 可以 使用 的 模块 规范 类型 的 文件 比如 cocoscreatord 支持 systemjs 规范 则 可以 拿 systemjs 文件 夹下 的 文件 复制到 项 目中 设置 为 插件 就可以 引入 使用 了 如果 所在 项目 不支持 直接 使用 npm 包 使用 通过 broadcast 来 注册 发送 广播 非常 简便 注册 接收器 thisbroadcaston testa str gtdosomething 发送 消息 testastring broadcast 允许 在 注册 发送 消息 时 携带 任意 类型 数据 并 支持 类型 提示 broadcast 允许 在 注册 消息 时 给 自己 透 传 数据 而非 通过 闭 包 取 闭 包 外 数据 的 方式 灵感 来自 laya 的 eventdispatcher 闭 包 使用不当 容易 出问题 开发者 可以 选择 将 特定 类型 的 消息 进行 持久 化 这样 就能 轻易 实现 广播 式 的 全局 状态 管理 注意 一个 消息 类型 一旦 持久 化 就 只能 通过 brocastoffall key 来 从 广播 系统 中 移除 该 类型 的 消息 消息 类型 keyobjtypetest 数据 abcfalse 回 调 undefined 持久 化 true 粘性 广播 消息 类型 数据 当 广播 系统 中 没有 对应 类型 的 接收器 时 粘性 广播 将会 暂时 滞 留在 系统 中 直到 有 该 类型 的 接收器 被 注册 则会 立即 发出 广播 当 广播 系统 中有 对应 类型 的 接收器 时 就和 普通 广播 具有 相同 的 表现 双向通信 双向 沟通 双倍 效率 broadcast 支持 在 广播 发送 点 接收 接收器 返回 的 消息 发送 消息 消息 类型 数据 接收器 返回 的 消息 data gtdosomething 注册 接收器 broadcaston numbertypetest datacallback 返回 消息 callback result 支持 函数 this 绑定 或 任意 类型 作为 环境 绑 定在 cocoscreator 中 注册 事件 可以 这样 thisnodeon 这个 this 可以 用来 调用 showanimview 这个 方法 不至于 调用 的 方法 里 使用 this 时 丢失 this 而在 broadcast 中 也 支持 还 支持 在 环境 解构 时 开发者 可以 方便 的 一次性 移除 所有 在 该 环境 中 注册 的 接收器 this 支持 批量 注册 接收者 broadcaston 消息 类型 接收器 环境 contextthis 消息 类型 接收器 环境 contextthis 基本 的 使用 就 这些 了 具体 的 使用 例子 可以 克隆 仓库 看 基于 cocoscreator 的 打开 这个 场景 看 demo 之前 需要 安装 环境 哦 安装 npm 然 后到 egfcccfull 根目录 npminstall 极度 舒适 的 类型 提示 演示 需要 消息 定义 者 定义 时 添加 如下 类型 声明 消息 类型 key 提示 对应 消息 类型 的 发消息 和 收 消息 的 类型 声明 双向通信 返回 数据类型 声明 然后 在 实例 化 broadcast 时 注入 类型 最后 关注 作者 公众 号 更多 实用 干货 等着 你 qq 群 博客 主页 掘金 构建 复杂 应用 的 神器 