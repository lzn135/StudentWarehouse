移动 安全 47--mobsf-v3.0 源代码 分析 长文 巨 献 一 项目 说明 源码 地址 关于 如何 搭建 源码 分析 环境 请 阅读 我 的 另一 篇 博客 移动 安全 mobsf 框架 安装 与 开发 环境 搭建 基于 移动 安全 框架 mobsf 是 一种 自动化 的 移动 应用程序 测试 框架 能够 执行 静态 动态 和 恶意 软件 分析 它可 用于 androidios 和 windows 移动 应用程序 的 有效 和 快速 安全 分析 并 支持 二进制 文件 apkipa 和 appx 和 压缩 源代码 mobsf 可以 在运 行时 为 android 应用程序 进行 动态 应用程序 测试 并 具有 由 capfuzz 一种 特 定于 webapi 的 安全 扫描 程序 提供 支持 的 webapi 模糊 测试 mobsf 旨在 使 您 的 cicd 或 devsecops 管道 集成 无缝 二 项目 入口 项目 结构 如下 我们 首先 浏览 项目 源码 找到 项目 入口 然后 从 入口 开始 分析 这在 分析 任何 源码 都是 一样 的 由于 mobsf 使用 django 框架 开发 的 我们 浏览 源码 后 可以 看到 入口 在 mobsfurlspy 中 通过 浏览器 访问 相应 的 url 地址 功能 映 射到 对应 的 代码 逻辑 代码 如下 所示 为了 便于 阅读 我 将 备注 重写 为 中文 备注 urlpatterns 一般 功能 urlurl url url url url url url url url url url url 静态 分析 urlandroid 应用 静态 分析 urlurl url url rsmalismalirun url rjavajavarun url rfindfindrun url url ios 应用 静态 分析 urlurl url windows 应用 静态 分析 urlurl pdf 报告 url 应用 比较 url rcompare plthashgtaf plthashgtaf 动态 分析 urlurl url url url rlogcatdzlogcat android 设备 操作 url url url url url url url 动态 测试 url url url frida 框架 url url url url url 动态 扫描 报告 url url restapiurl url url url url url url testurl 可以 很明显 的 看到 mobsf 的 功能 分为 四大块 分 别是 一般 功能 包括 上传 app 下载 报告 关于 说明 搜索 删除 扫描 等 常规 功能 静态 扫描 android 应用 ios 应用 windows 应用 的 静态 扫描 app 比较 等 动态 分析 只 支持 android 应用 的 动态 分析 包括 android 设备 操作 frida 框架 等 报告 生成 等 restapi 封 装好 的 可以 调用 的 api 接口 使得 mobsf 的 功能 可以 接入 到 其他 任何 系统 中三 一般 功能分析 由于 一般 功能 并非 核心 功能 核心 功能 是 静态 扫描 和 动态 分析 那 我们 只 分析 上传 功能 即可 用来 热 热身 对应 代码 如下 generalurl url 这个 是 我们 要 分析 的 url url url url url url url url url url 编译器 中 双击 asview 选中 按 下 commandb 跟踪 苹果 系统 快捷键 我们 来到 中 随后 跟 进到 uploadhtml 函数 首先 看到 的 是 上传 只 支持 post 方法 其他 方法 不支持 代码 如下 responsedata 之后 是 对 上传 的 无效 文件 和 不支持 文件 的 错误处理 会给 出 错误 提示 对于 使用 windows 平 台下 上传 的 ipa 包 也 会给 出 错误 提示 要求 操作系统 必须 是 mac 或者 linux 接下来 是 uploadapi 函数 这个 是 restapi 的 上传 功能 我们 这里 不做 分析 随后 对 上传 的 文件 做 分类 对 不同 类型 的 应用 包 做 对应 的 扫描 代码 如下 defupload self request 就是 这里 对 上传 的 文件 做 扫描 稍后 跟进 判断 上传 的 应用 包 的 类型 对 不同 类型 的 包 做 对应 的 扫描 loggerinfo 扫描 apk 包 扫描 zip 包 扫描 ipa 包 扫描 appx 包 至此 文件 中 的 上传 代码 就 分析 完了 其他 代码 是 其他 功能 包括 apidocs 关于 说明 错误 最近 扫描 等 一大堆 功 能从 其他 url 可以 进入 分析 我们 此处 不做 分析 我们 来看 看 上传 之后 是 如何 进行 扫描 的 跟进 scanning request 来到 的 scanning 类 中 可以 看到 这里 的 扫描 分了 类 分 别是 对 apk 包 的 扫描 对 zip 包 的 扫描 对 ipa 包 的 扫描 对 appx 包 的 扫描 我们 来 看看 对 apk 包 的 扫描 先是 通过 文件名 和 文件 类型 apk k 算出 一个 md 值 这 也是 我们 使用 的 时候 看到 的 那个 md 值 以及 首页 查询 框 中 要 输入 的 md 值 代码 如下 selffileapk 随后 将 扫描 任务 添加到 最近 的 扫描 列表 这 也是 我们 在 使 用时 可以 从 最近 的 扫描 列表 找到 之前 扫描 过 的 任务 不用 再 重 新做 扫描 我们 看 扫描 apk 的 代码 defscanapk self selffileapk 注意 此处 使 到了 loggerinfo returndata 可以 看到 url 参数 中使 用了 staticanalyzer 的 url 此时 回到 最 开始 的 mobsfurlspy 中找到 staticanalyzer 跟 入 至此 上传 的 文件 正式 进入到 静态 扫描 请看 截 图中 的 url 哦 四 静态 扫描 分析 先 捋 一下 代码 在 做完 静态 扫描 的 源码 分析 后 我 觉得 这一 小节 的 内容 应当 加在 最前面 于是 我 就 将它 写在 了 最前面 静态 分析 的 核心 部 分在 目 录下 另外 我们 这次 只 分析 android 的 apk 因此 所 分析 的 代码 集中 在 目 录下 常见 的 api 规则 库 文件 规则 库 文件 要 检测 的 api 列表 文件 二进制 分析 文件 证书 分析 文件 代码 分析 文件 反编译 javasmali 代码 文件 数据库 交互 文件 权限 规则 库 文件 androidfindpy 查找 源代码 文件 生成 下载 文件 图标 分析 文件 代码 展示 文件 分析 文件 视图 文件 应用 商店 分析 文件 代码 展示 文件 静态 分析 流程 文件 主 文件 常量 字符串 获取 文件 文件 源 查看 环境 下 会 使用 comparerpy 静态 分析 结果 比较 文件 sharedfuncpy 静态 分析 文件 我们 接下来 的 分析 中 我们 会 按照 流程 一步 一步 走完 静态 分析 出了 非必要 的如 规则 库 代码 windows 环境 使用 代码 外 其他 代码 都会 涉及到 捋 完 代码 我们 再 继续 通过 刚才 的 分析 我们 得知 我们 先 通过 uploadurl 上传 了 我们 的 apk 文件 经过 系统 的 一 梭罗 处理 后 系统 自动 使用 开始 对 我们 的 apk 文件 进行 静态 分析 我们 回到 最 开始 的 定义 url 的 地方 mobsfurlspy 文件 中找到 静态 分析 的 地方 代码 如下 androidurl url url rsmalismalirun url rjavajavarun url rfindfindrun url url 跟 入 staticanalyzer 函数 即 来到 静态 分析 主流程 文件 文件 中 分析 这里 的 代码 非常 伤 因为 代码 很长 又是 缩进 语法 的 python 因此 你 要 盯 好 缩进 不然 就 蒙 圈 了 静态 分析 一上来 提取 参数 包括 包 类型 hash 值 文件名 rescan 等 之后 判断 上传 的 文件 是 apk 包 还是 zip 包 还是 其他 包 对 不同 的 包 做 对应 的 静态 分析 此处 我们 分析 对 apk 包 的 静态 分析 如果 这个 app 是 之前 扫描 过 的 则 直接 从 数据库 拉 取 数据 如果是 第一次 扫描 则从 零 开始 做 扫描 代码 如下 ifdbentryexists dbentry else 这样 的话 if 下 的 代码 我们 就不 跟进去 看了 因为 没啥 可看 的 只 看 else 下 的 代码 开始 静态 分析 后首 先 提取 apk 文件名 和 apk 路径 之后 解压 apk 包 如果 apk 包 解压 失败 则 报错 代码 如下 requestmsgtrue requestmsgfalse appdicfiles 在 成功 解压 apk 包 之后 正式 进入 静态 分析阶段 安全 分析 首先 分析 文件 代码 如下 我们 跟进去 来 到了 文件 中 这个 文件 近 行 代码 看得 我 快 睡着了 其实 并 没啥 高深 的 东西 首先 解压 apk 代码 如下 manifestnoneif len ifisfileexists manifest args returnmanifest 不用 多说 一目了然 使用 apktool 对 apk 进行 解压 其 使用 的 参数 也是 很明显 的 之后 读取 文件 这里 分为 从 解压 的 后 目录 中 读取 和 从 源码 目录 中 读取 如果 上传 的 是 zip 包 的话 读 取到 文件 后 开始 解析 该 xml 文件 提取 该 xml 文件 中 的 数据 包括 等 所有 参数 这里 还穿 插着 对 可 浏览 的 activity 做了 一个 单独 的 读取 分析 因为 可 浏览 的 activity 参数 是 比较 特殊 的 代码 如下 androidname data fordataindatas 之后 根据 参数 的 特性 对 权限 进行了 分析判断 将 权限 的 安全 分级 为 对 其他 配置 也 做了 安全 分析 如 等 参数 对 四大 组件 的 配置 也 做了 安全 分析 将 配置 的 安全 分级 为 整个 分析 是 基于 和 的 注意 这里是 不等于 flase 也就是说 要么 明确 写明 导出 为 true 要么 没有 声明 因为 这两种 方式 对应 的 分析 方法 不同 所以 这里是 分开 处理 的 如果 的话 那 自然是 安全 的 就 没啥 可说 的 了 在 分析 的 过程中 还 分了 小于 android 和 大于 等于 android 版本 的 情况 综述 整个 代码 是 对 做了 一个 全面 的 安全 分析 继续前进 上 小节 我们 从 getmanifest 跟 入 后 看到了 系统 对 做了 一个 全面 的 安全 分析 现在 我们 回来 继续 向后 前进 代 代码 如下 上 小节 我们 是 从 这里 跟 入 的 现在 我们 退回来 继续 向 后跟 入 这里 跟 入 getappname 我们 发现 这是 一个 获取 app 名字 的 其 分为 种 要么 读取 文件 的 ltapplicationgt 标 签下 的 androidlabel 属性 值 要么 读取 文件 中 的 appname 属性 值 代码 如下 读取 文件 的 ltapplicationgt 标 签下 的 androidlabel 属性 值 ifisapkaapkapk apppath returnrealname 读取 文件 中 的 appname 属性 值 ifospathexists stringspath eclipsepath stringsfile loggerwarning returnwithopen asfdatafread ltstringgtdata 为 空 则 返 回空 iflen 之后 干了 啥 没了 我们 只能 返回 继续 向后 接下来 开始 获取 app 的 图标 icon 跟 入 到 中 这 里面 其实 没啥 可看 的 设置 manifest 连接 我们 回到 起点 继续 向 下走 接下来 是 设置 的 连接 这里 的 量 就 比 较大 了 我 在 代码 中 写了 备注 请 阅读 代码 如下 设置 manifest 连接 appdicmani manifestdata 是 对 文件 的 处理 节 已 介绍 appdicparsedxml getappdetails 获取 app 详细 数据 稍后 介绍 是 对 文件 的 处理 节 已 介绍 是 二进制 分析 稍后 介绍 appdicappdir resanalysis 是 二进制 分析 稍后 介绍 appdicappdir certinfo 是 对 证书 的 分析 稍后 介绍 certdiccertinfo apkidanalysis 是 对 apkid 的 分析 稍后 介绍 trackers 追踪 检测 稍后 介绍 apkjava 反编译 为 java 代码 稍后 介绍 apkjava dexsmali 反编译 为 smali 代码 稍后 介绍 dexsmali codeanalysis 代码 分析 稍后 介绍 好啦 看完 我 写 的 备注 应该 已经 一目了然 了 接下来 我们 逐个 跟 入 看看 到底是 咋 实现 的 跟 入 跟 入 后 包括 对 的 解析 这 就又 回到 文件 中了 该 文件 的 功 能在 安全 分析 小节 中 介绍 过 功能 其实 也 没啥 就是 对 的 处理 就 不再 介绍 了 跟 入 getappdetails 接下来 是 通过 应用 商店 对 app 的 细节 数据 做一个 读取 包括 app 名字 评分 价格 下载 url 等待 数据 跟 入 到 文件 中跟 入 之后 进入 二进制 分析阶段 跟 入 到 文件 中 话说 博 主 本来 想着 好 好写 的 看了 半天 发现 这个 代码 文件 中 竟然 没啥 可 讲 的 整个 文件 中 的 功能 是 对 二进制 文件 做了 分析 处理 包括 resassets 目 录下 的 资源 文件 lib 下 的 so 文件 等 跟 入 certinfo 接下来 是 对 证书 做 分析 处理 跟 入 到 文件 中 这个 文件 代码 一 共有 个 函数 因此 也 只有 个 功能 该 函数 并不是 我们 跟进来 的 函数 不过 既然在 一个 文件 中 那就 一并 讲 解下 该 函数 的 功能 是 查找 证书 文件 或 密钥 文件 并 返回 包括 等 证书 文件 以及 jksbks 等 密钥 库 文件 certinfo 该 函数 是 我们 跟进来 的 函数 该 函数 的 功能 是 获取 证书 文件 信息 并 对 其 进行 分析 包括 debug 签名 sha 哈希 不安全 的 签名 正常 签名 等 其实 也 没啥 好说 的 跟 入 apkidanalysis 接下来 是 apkid 分析 梳理 跟 入 到 文件 中 对 apkid 进行 的 分析 处理 其中 背后 的 核心 库 在 目 录下 由于 这个 是 安装 时会 自动 下载 的 因此 这种 库 的 东西 我们 不做 分析 对 apkid 的 分析 处理 并没有 很 复杂 在 做了 简单 的 判断 之后 就 开始 分析 出了 代码 如下 从 导 入库 可以 看到 端倪 跟进 options 到 中 optionsoptions 跟进 outputformatter 到 中 到 以下 的 函数 跟进 后 也是 在上 两个 代码 文件 中 scannerscanner rulesoptions apkfile res res filessanitized 跟 入 trackers 接下来 是 追踪 检测 跟 入 到 文件 中 那么 将该 文件 中 的 所有 函数 功能 一并 讲 解下 updatetrackerdb 函数 的 主要功能 是 更新 跟踪 检测 数据库 函数 的 主要功能 是 编译 与 每个 签名 相关 的 正则表达式 以此 加快 跟踪器 的 检测 速度 函数 的 主要功能 是 从 官方 数据库 加载 跟踪器 签名 函数 的 主要功能 是 从 所有 dex 文件 中 获取 java 类 的 列表 这里 使用 的 工具 是 函数 的 功能 是 根据 上个 函数 提供 的 java 类 列表 检测 嵌入 在 其中 的 跟踪器 并 返回 嵌入 的 跟踪器 列表 detecttrackers 函数 的 主要功能 是 检测 嵌入 的 跟踪器 并 返回 嵌入 的 跟踪器 列表 gettrackers 函数 的 主要功能 是 获取 跟踪器 跟 入 apkjavadexsmali 看完 跟踪器 我们 回 过头 继续 现 在要 跟 入 的 是 将 apk 反编译 为 java 代码 的 功能 和 将 dex 反编译 为 smali 代码 的 功能 跟 入 到 文件 中 dexsmali 函数 是 通过 baksmali 工具 将 dex 反编译 为 smali 代码 其 使用 的 参数 如下 dexpath if len 函数 是 通过 jadx 工具 将 apk 反编译 为 java 代码 相关 代码 比 较长 因为 需 要将 参数 的 源头 也 写入 代码 如下 defapkjava apkgtjava loggerinfo ifospathexists output shutilrmtree output if len jadxosxok oschmod jadxstatsiexec osdevnullw subprocesscall 跟 入 codeanalysis 回 过头 继续 接下来 是 代码 分析 跟 入 到 文件 中 核心 代码 如下 源码 情况下 的 代码 分析 javasrc coderulematcher permskeys 使用 api 情况下 的 代码 分析 apirulematcher apifindingslist permskeys 通过 url 或 邮件 提取 结果 再次 跟 入 到 sharedfunc 以上 代码 跟 入 后 发现 均 来 到了 文件 中 那 我们 继续 来看 这个 文件 中 的 代码 逻辑 这个 文件 的 代码 主 要是 对 app 做 静态 分析 的 包括 apkipaappx 等 因为 将 三者 的 静态 分析 共同 的 部分 放在 一起 因此 文件 名叫 共享 功能 sharedfuncpy 其中 生成 哈希 hashgen 函数 解压 unzip 函数 报告 处理 pdf 函数 api 相关 的 addapis 函数 和 apirulematcher 函数 url 和 邮件地址 提取 函数 我们 就不 看了 不是 主要功能 静态 分析 规则 匹配 coderulematcher 函数 主 要是 通过 遍历 规则 来 分析 得到 相应 的 结果 其 分为 两部分 规则 类型 为 正则表达式 的 和 规则 类型 为 字符串 的 规则 类型 为 正则表达式 的 又 分为 单个 正则表达式 多个 与 关系 的 正则表达式 多个 或 关系 的 正则表达式 多个 与 关系 的 固定 的 正则表达式 等 其 通过 匹配 列表 函数 和 代码 分析 结果 addfindings 函数 做 规则 匹配 最终 产生 结果 规则 类型 为 字符串 的 就 比较复杂 一 点了 其 分为 单个 字符串 多个 与 关系 的 字符串 多个 或 关系 的 字符串 多个 与 或 关系 的 字符串 多个 或与 关系 的 字符串 多个 与 关系 的 固定 的 字符串 多个 或与 关系 的 固定 的 字符串 等 通过 匹配 列表 函数 和 代码 分析 结果 addfindings 函数 做 规则 匹配 最终 产生 结果 代码 如下 规则 类型 为 正则表达式 的 ifruletyperegex 单个 正则表达式 的 addfindings 多个 与 关系 的 正则表达式 的 rule refindall matchtmpdata 多个 或 关系 的 正则表达式 的 rule matchtmpdata addfindings break 多个 与 关系 的 固定 的 正则表达式 的 addfindings 其他 情况 的 报错 elseloggererror 规则 类型 为 字符串 的 单个 字符串 的 多个 与 关系 的 字符串 的 rule matchintmpdata 多个 或 关系 的 字符串 的 rule break 多个 与 或 关系 的 字符串 的 rule addfindings 多个 或与 关系 的 字符串 的 rule addfindings 多个 与 关系 的 固定 的 字符串 的 addfindings 多个 或与 关系 的 固定 的 字符串 的 rule ruleperminperms 其他 情况 的 报错 elseloggererror 规则 类型 为 其他 的 直接 报错 elseloggererror 在这 之后 做了 从 源码 中 提取 url 地址 和 邮件地址 的 操作 没啥 可 讲 的 通过 正则 遍历 源码 实现 的 接下来 呢 是 个 两个 app 比较 的 功能 注意 哈希 值 一样 的 两个 app 不能 比较 哦 再 之后 是 一个 记分 功能 就是 通过 avgcvss 记分 的 高危 high 减去 分 警告 warning 减去 分好 good 增 加分 很简单 的 功能 实现 再 之后 更新 了 最后 扫描时间 函数 检测 打开 的 fire ebase 数据库 openfirebase 函数 检测 firebase 的 函数 之后 没有 之后 了 这个 就 完 结了 获取 字符串 不忘 初心 我们 回到 文件 中 接下来 是 获取 app 的 常量 字符串 代码 如下 stringresurlnf 我们 跟 入 stringsjar 来到 文件 中 它 只有 一个 功 能从 app 中 提取 常量 字符串 数据 准备 及 入库 我们 回到 源头 继续 向后 接下来 是 数据 入库 前 的 检查 以及 数据 存入 数据库 代码 如下 firebase 数据库 检查 list set 域名 提取 和 恶意 软件 检查 loggerinfo list set 复制 app 图标 copyicon appdiczippedapk 其中 函数 我们 刚才 看 过了 copyicon 函数 没啥 可看 的 那 我们 就来 看看 malwarecheck 函数 吧 跟 入 malwarecheck 函数 我们 来到 文件 中 这个 文件夹 主 要是 分析 处理 恶意 软件 对应 静态 分析 报告 中 的 malwareanalysis 栏目 其 包括 子项目 updatemalwaredb 函数 的 功能 是 更新 恶意 软件 数据库 malwarecheck 函数 的 功能 是 校验 恶意 软件 verifydomain 函数 的 功能 是 验证 urlgetnetloc 函数 的 功能 是 获取 单个 url 注意 代码 中 是 用 的 是 函数 的 功能 是 获取 多个 url 注意 代码 中 使用 的 是 domains 好了 看完 domiancheckpy 文件 我们 回 过头 继续 看 文件 接下来 就是 把 数据 往 数据库 里面 放了 这里 跟 入了 函数 来 到了 文件 中 不过 这个 文件 中 的 代码 没啥 可分析 的 之 后又 跟 入了 virustotal 函数 来 到了 文件 中 这是 一个 统计 安全问题 总数 的 地方 也 没啥 可说 的 代码 如下 从 此处 跟 入 ospathjoin apkappdicmd 至此 上传 apk 包 的 静态 分析 就 结束 了 接下来 是 上传 zip 源码 包 的 静态 分析 我们 就不 看了 静态 分析 总结 如果 你 认真 阅 读完 本篇 分析 文章 再 对应 看 静态 分析 报告 你 会 发现 所有 的 功能 我们 都 分析 到了 现在 我们 也 知道 这些 强大 的 功能 背后 是 如何 实现 的 了 静态 扫描 的 源码 分析 就 结束 了 五 动态 扫描 分析 先 捋 一下 代码 和 静态 分析 篇 一样 我 将它 写在 了 最前面 动态 分析 的 核心 部 分在 目 录下 另外 我们 这次 只 分析 android 的 apk 因此 所 分析 的 代码 集中 在 目 录下 toolswebproxypy 设置 代理 httptools 相关 对 动态 分析 得到 的 数据 进行 分析 处理 动态 分析 流程 文件 主 文件 动态 分析 环境 配置 相关 框架 核心 操作 部分 框架 脚本 动态 分析 操作 动态 分析 报告 输出 命令 测试 框架 测试 框架 测试 我们 接下来 的 分析 中 我们 会 按照 流程 一步 一步 走完 动态 分析 出了 非必要 的 其他 代码 都会 涉及到 捋 完 代码 我们 再 继续 再 经过 漫长 的 静态 源码 分析 后 我们 现在 开始 进行 动态 扫描 源码 分析 通过 浏览 dynamicanalyzer 文件 下 的 代码 我们 发现 动态 扫描 其实 只有 android 才有 截止 博 主 分析 日期 最新 的 beta 已经 不再 支持 物理 设备 仅 支持 虚拟 设备 主 要是 genymotion 对于 小于 android 的 系统 版本 会 使用 xposed 框架 对于 大于 等于 android 的 系统 版本 会 使用 frida 框架 android 以下 的 系统 属于 骨灰级 都 年 了 这些 老 系统 连 学习 的 价值 都没有 因此 下文 分析 中所 有 遇到 xposed 的 都将 跳过 不做 分析 我们 回到 最 开始 的 定义 url 的 地方 mobsfurlspy 文件 中找到 动态 分析 的 地方 代码 如下 url url url url rlogcatdzlogcat 以上 任意 函数 跟 入 我们 来到 文件 中 我们 先 不管它 跟进来 是 到 哪个 函数 我们 从上到下 逐次 分析 dynamicanalysis 函数 dynamicanalysis 函数 是 动态 分析 的 入口 点这里 首 先会 检测 模拟器 如果 模拟器 正常 运行 起来 并 被 检 测到 则 获取 设备 数据 跟 进到 mobsfutilspy 文件 的 getdevice 函数 之后 设置 代理 ip 跟 进到 mobsfutilspy 文件 的 getproxyip 函数 其 功能 是 获取 网络 ip 并 根据 它 设置 代理 ip 如果 模拟器 未 启动 或 没有 被 检 测到 则 报错 跟 进到 mobsfutilspy 文件 的 函数 dynamicanalyzer 函数 dynamicanalyzer 函数 主要功能 是 配置 创建 动态 分析 环境 在 获 取到 设备 信息 后 envenvironment identifier 我们 跟 入 environment 函数 来到 环境 配置 在 文件 中 environmentpy 文件 分析 我们 还是 先 不管 跟 入 的 是 哪个 函数 从上到下 讲 解下 各个 函数 功能 connectnmount 函数 的 功能 是 重启 adb 服务 之后 尝试 adb 连接 设备 adbcommand 函数 的 功能 是 adb 命令 包装 所有 将要 执行 的 命令 都会 经过 包装 后 成为 可以 执行 的 命令 然后 执行 dzcleanup 函数 的 功能 是 清除 之前 的 动态 分析 记录 和数 据以 便于 新 的 动态 分析 不受 影响 configureproxy 函数 的 主要功能 是 设置 代理 具体步骤 是 先 调用 httptools 杀死 请求 再在 代理 模式 下 开启 httptools 代码 如下 selfproject stophttptools proxyport 调用 httptools 杀死 请求 startproxy 在 代理 模式 下 开启 httptools 这两个 函数 均 跟 入 到 文件 中 这个 文件 中 的 代码 很简单 就不 再 分析 了 installmobsfca 函数 的 主要功能 是 安装 或 删除 mobsf 的 跟 证书 函数 的 主要功能 是 给 设备 设置 全局 代理 这个 功能 仅 支持 android 及 以上 系统 设置 代理 ip 的 功能 会 跟 入 到 mobsfutilspy 的 getproxyip 函数 中 对于 小于 android 的 系统 版本 会将 代理 设置 为 函数 的 主要功能 是 取消 设置 的 全局 代理 函数 的 主要功能 是 开启 adb 反向 tcp 代 理该 功能 仅 支持 android 以上 的 系统 startclipmon 函数 的 主要功能 是 开始 剪切板 监控 getscreenres 函数 的 主要功能 是 获取 当前 设备 的 屏幕 分辨率 screenshot 函数 的 主要功能 是 截 屏 并 保存为 函数 的 主要功能 是 分析 屏幕 流 函数 的 主要功能 是 获取 apk 的 组件 包括 等 函数 的 主要功能 是 获取 android 版本 getandroidarch 函数 的 主要功能 是 获取 android 体系结构 launch hncapture 函数 的 主要功能 是 启动 和 捕获 activity 是 通过 截 屏 实现 的 ismobsfyied 函数 的 主要功能 是 获取 android 的 mobsfyed 实例 读取 xposed 或 frida 文件 并 输出 代码 如下 getadb 函数 的 主要功能 是 设置 mobsf 代理 安装 xposed 或 frida 框架 代码 如下 系统 版本 小于 安装 xposed 框架 version xposed 系统 版本 大于 等于 安装 frida 框架 frida loggerinfo 函数 的 主要功能 是 安装 mobsf 根 证书 设置 mobsf 代理 xposedsetup 函数 的 主要功能 是 安装 xposed 框架 fridasetup 函数 的 主要功能 是 安装 frida 框架 runfridaserver 函数 的 主要功能 是 运行 frida 框架 至此 文件 的 代码 我们 就 过了 一遍 了 整个 文件 主 要是 做 动态 分析 的 环境 准备工作 代码 逻辑 非常 简单 特别 容易 理解 回 过头 继续 刚才 分析 了 environmentpy 文件 我们 是 按照 代码 从上到下 的 顺序 分析 的 并不是 按 运行 逻辑 顺序 分析 的 现在 我们 按 逻辑 运行 顺序 继续 向下 看一下 看我 写 的 代码 备注 即可 动态 分析 环境 准备 envenvironment identifier 如果 测试 adb 连接 失败 requestmsg 获取 android 版本 loggerinfo 根据 系统 版本 获取 android 的 mobsfyed 实例 如果 失败 version msg loggerwarning msg 设置 mobsf 代理 如果 失败 第一次 运行 xposed 框架 会 重启 设备 以 启用 所有 模块 requestmsg 清除 之前 的 动态 分析 记录 和 数据 envdzcleanup binhash 设置 web 代理 package 开启 adb 反向 tcp 代理 仅 支持 以上 系统 version 给 设备 设置 全局 代理 这个 功能 仅 支持 android 及 以上 系统 version 开始 剪切板 监控 envstartclipmon 获取 当前 设备 的 屏幕 分辨率 loggerinfo installingapk app 目录 app 路径 命令 包装 并 执行 envadbcommand loggerinfo 通过 httpresponse 返回 数据 returnrender httptoolsstart 函数 httptoolsstart 函数 的 主要功能 是 在 代理 模式 下 开启 httptools 这里是 先 调用 httptools 杀死 请求 再在 代理 模式 下 开启 httptools 代码 如下 stophttptools timesleep loggerinfo webproxypy 文件 分析 我们 跟 入 到 文件 中 这个 文件 中 的 代码 很简单 stophttptools 函数 的 主要功能 是 杀死 httptools 分为 两步 第一步 是 通过 调用 httptoolsui 杀死 请求 第二步 是 通过 调用 httptools 代理 杀死 请求 startproxy 函数 的 主要功能 是 在 代理 模式 下 开启 函数 的 功能 是 启动 httptools 的 uicreateca 函数 的 功能 是 第一次 运行时 创建 cagetcadir 函数 的 功能 时 获取 ca 目录 logcat 函数 logcat 函数 主 要是 启动 logcat 流 获取 日志 的 这个 函数 没啥 可分析 的 就 不做 分析 了 来 看看 operationspy 文件 这个 文件 的 主要功能 是 动态 分析 操作 我们 从上到下 看一下 jsonresponse 函数 的 主要功能 是 返回 json 响应 isattackpattern 函数 的 主要功能 是 通过 正则表达式 验证 攻击 函数 的 主要功能 是 通过 正则表达式 校验 包 名称 ispathtraversal 函数 的 主要功能 是 检查 路径 遍历 ismd 函数 的 主要功能 是 通过 正则表达式 检查 是否 是 有效 的 mdinvalidparams 函数 的 主要功能 是 检查 无效 参数 响应 mobsfy 函数 的 主要功能 是 通过 post 方法 配置 实例 以 进行 动态 分析 executeadb 函数 的 主要功能 是 通过 post 方法 执行 adb 命令 getcomponent 函数 的 主要功能 是 通过 post 方法 获取 android 组件 takescreenshot 函数 的 主要功能 是 通过 post 方法 截 屏 screencast 函数 的 主要功能 是 通过 post 方法 投 屏 touch 函数 的 主要功能 是 通过 post 方法 发送 触摸 事件 mobsfca 函数 的 主要功能 是 通过 post 方法 安装 或 删除 mobsf 代理 的 rootca 再 看看 analysispy 文件 该 文件 的 主要功能 是 对 动态 分析 获取 的 数据 进行 分析 我们 也是 从上到下 看一下 runanalysis 函数 的 主要功能 是 运行 动态 文件 分析 首先 收 集了 日志 数据 并 对 日志 进行 遍历 筛选 处理 代码 如下 收集 日志 datasgetlogdata apkdirpackage 遍历 日志 数据 对 日志 数据 进行 处理 loglinereplace cliptag clipboardappend logline 通过 正则表达式 收集 的 url 数据 代码 如下 r w amp reunicode urlsrefindall ifurlsurlslist set urls elseurls 然后 对 恶意 url 进行检查 通过 匹配 这些 url 是否 出现在 恶意 软件 列 表里 实现 代码 如下 urls 跟 入 到 文件 的 malwarecheck 函数 domiancheckpy 文件 在 本篇 的 数据 准备 及 入库 章节 有 讲解 此处 就不 再讲 解了 之后 通过 正则 提 取了 所有 的 电子 邮件地址 代码 如下 rwww if and emailsappend email 然后 做了 结果 汇总 代码 如下 最后 返回 分析 结果 getscreenshots 函数 的 主要功能 是 获 截图 getlogdata 函数 的 主要功能 是 对 日志 数据 进行 分析 通过 执行 adb 或 其他 可执行文件 进行 处理 得到 web 数据 日志 数据 域名 数据 api 数据 frida 数据 并 返回 getappfiles 函数 的 主要功能 是 从 设备 获取 app 文件 包括 提取 设备 数据 对 设备 中 的 数据 做 静态 分析 等 函数 的 主要功能 是 生成 文件 下载 生成 文件 下载 后会 删除 现有 数据 然后 复制 新 数据 至此 android 动态 分析 源代码 分析 就 结束 了 动态 分析 总结 没啥 可 总结 的 该 分析 的 都 分析 了 六 总结 本文 没有 任何 参考文献 因为 网上 所有 的 源码 分析 文章 都已 经 过时 很久很久 了 历时 一星期 博 主要 吐血 了 