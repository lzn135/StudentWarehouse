实战 构建 持续 集成 环境 关于 jenkins 的 文章 比较 多 笔者 决定 写 一篇 比较 详细 的 利用 容器 来 构建 的 文章 来 和 大家 共同 讨论 文章 比 较长 需要 有点 耐心 慢慢 看完 如果 大家 在 实验 的 过程中 遇到问题 可以 留言 一起 讨论 或者 加我 qq 一起 讨论 都行 本文 重点 介绍 jenkins 以及 jenkins 如 何在 docker 容器 中 运行 jenkins 和 docker 私有 仓库 又是 怎么 玩 的 docker 说明 安装 和 git 说明 安 装在 本 文中 不会 特别 详细 的 介绍 并且在 本 文中 不 着重 介绍 原 理性 的 东西 比如 不会 介绍 什么 是 持续 集成 持续 构建 等等 本文 的 重点是 实战 为主 对 持续 集成 持续 交付 持续 部署 等 概念 不太 了解 的 朋友 可以 参考 这篇 文章 了解 一下 背景 说明 jenkins 是 一个 开源 软件 项目 是 基于 java 开发 的 一种 持续 集成 工具 用于 监控 持续 重复 的 工作 旨在 提供 一个 开放 易用 的 软件 平台 使 软件 的 持续 集成 变成 可能 jenkinsdocker 持续 集成 实验 在 互联网 时代 对于 每 一家 公司 软件开发 和 发布 的 重要性 不言而喻 目前 已经 形成 一套 标准 的 流程 最 重要 的 组成部分 就是 持续 集成 ci 及 持续 部署 交付 cd 本文 基于 实现 一套 ci 自动化 发布 流程 先来 了解 一下 比较 典型 的 java 项目 发布 工作 流程 java 项目 开发 gtgt 提交 项目 代码 到 git 或 svn gtgt 拉 取 项目 代码 jenkins 或 手动 gtgt 编译 项目 代码 jenkins 或 手动 gtgt 发布 java 项目 并 运行 java 项目 gtgt 测试 在 来 看看 用 发布 java 项目 流程 又是 怎样 的 呢 java 项目 开发 gtgt 提交 项目 代码 git 容器 gtgtjenkins 容器 拉 取 项目 代码 gtgtmaven 编译 构建 项目 gtgtjenkins 发布 项目 到 tomcat 容器 gtgt 测试 看到 上面 的 流程 后 在 没有 jenkins 的 情况下 这些 步骤 都是 手工 完成 的 有 了 jenkins 的 帮助 在这 步 中 除了 第 步 后续 的 步 都是 自动化 完成 的 当你 完 成了 提交 jenkins 会 自动 运行 你 的 编译 脚本 编译 成功 后 再运行 你 的 测试 脚本 这一步 成功 后 接着 它会 帮你 把 新 程序 发布 出去 特别 的 在 最后 一步 你 可以 选择 手动 发布 或 自动 发布 环境 描述 服务器 部署 信息 说明 本 文中 完全是 模拟 生产 环境 中 服务器 的 规划 git 单独 部署 jenkins 单独 部署 如果 你 没有 这么多 服务器 可以 把 git 服务器 和 jenkins 服务器 放在 一 起来 测试 前提 是 不要 搞 晕了 就可以 tale 是 一个 java 写 的 开源 博客 系统 这个 项目 没有 任何 依赖 所以在 此次 测试 中 可以 用它 做为 构建 部署 的 对象 当然 如果 你 有 其它 的 java 项目 也 可以 不 用它 来 测试 tale 访问 地址 版本 信息 jdk 官方 下载 地址 官方 下载 地址 官方 镜像 地址 官方 镜像 地址 部署 环境 部署 git 服务 注意 这个 步骤 在 gitregistry 服务器 上 操作 安装 创建 git 用户 记得 切换 创建 的 git 用户 操作 创建 仓库 创建 appgit 仓库 仓库 名 自定义 这一步 需要 切换 刚才 创建 的 git 用户 操作 然 后用 ls 查看 一下 appgit 仓库 初始化 完 成了 验证 git 服务 注意 这个 步骤 在 jenkins 服务器 上 操作 正常 来说 开发 用 自己 的 电脑 把 写好 的 代码 push 到 git 仓库 就算 完成 验证 在 本文 中去 github 里 下载 一个 java 项目 tale 来 验证 我们 就用 jenkins 这台 服务器 做为 git 客户端 吧 下载 git 客户端 下载 tale 项目 包 先 创建 个 目录 来 存放 tale 包 随便 放在 哪个 空目录 下 都行 后面 我们 还需 要把 它 移走 在 查看 下载 好 的 tale 项目 生成 公 钥 拷贝到 git 服务器 rootsshidrsa enterpassphrase 把 公 钥 拷贝到 git 服务器 注意 用 刚才 的 git 用户 s s s s s 用 gitclone 验证 先 创建 个 目录 目录名 随便 定义 用于 拉 取 git 服务器 上 创建 的 appgit 仓库 配置 下 git 客户端 的 用户 信息 在 来 gitclone 由于 appgit 仓库 是 空 的 所以会 很快 把 之前 下载 的 tale 项目 push 到 appgit 仓库 中 先 移动 至 刚才 git 目 录下 然后 提 交到 git 仓库 delta reused delta 部署 docker 私有 仓库 注意 这个 步骤 在 gitregistry 服务器 上 操作 我们 还是 用 官方 的 镜像 来 创建 docker 私有 仓库 查看 一下 私有 仓库 已经 起 来了 对 registry 私有 仓库 不太 了解 的 朋友 可以 参考 笔者 的 这篇 文章 docker 用 regis stry 快速 搭建 私有 镜像 仓库 配置 docker 服务器 注意 这个 步骤 在 docker 服务器 上 操作 这台 服务器 就是在 docker 中 运行 刚才 的 tale 这个 java 项目 的 服务器 所以 我们 要在 这 台服 各 器 上 安 装下 docker 安装 配置 镜像 源 为 国内 官方 源 注意 书写 格式 为 json 格式 有 严格 的 书写 要求 第 行 是 国内 镜像 源 第 行 是 docker 私有 仓库 地址 就是 docker 私有 仓库 的 地址 添加 后 连接 docker 私有 仓库 就是 用 http 协议 了 启动 dokcer 服务 部署 jdk 由于 后面 运行 java 容器 需要 jdk 环境 jdk 如果 放在 容器 中 运行 容器 又 相当 重 所以 就在 宿主 机上 部署 jdk 后面 创建 java 容器 的 时候 把 宿 主机 的 jdk 路径 挂 载到 容器 就去 部署 jdk 很简单 解压 就行 我们 把 它 解 压在 docker 这台 宿 主机 的 usrlocal 目录 中 构建 tale 开源 博客 的 基础 镜像 其实 这个 镜像 随便 在哪 台 服务器 上 构建 都 行在 本文 中就 直接 在 这台 docker 服务器 构 建了 说明 此 dockerfile 以 centos 为 基础 镜像 通过 yum 安装 nginxsupervisor 服务 定义 jdk 的 环境变量 并 通过 supervisord 来 启动 nginx 和 java 项目 下面 来 看下 supervisordconf 配置 上面 的 配置 都是 基础 配置 分 别是 通过 javajar 启动 taleleastjar 包 nginxg 启动 nginx 服务 然后 构建 镜像 对 talebase 镜像 打 tag 并上 传到 registry 私有 仓库 部署 jenkins 注意 这个 步骤 在 jenkins 服务器 上 操作 部署 jdk 由于 jenkins 需要 jdk 环境 jdk 如果 放在 容器 中 运行 容器 又 相当 重 所以 就在 宿主 机上 部署 jdk 后面 创建 jekins 容器 的 时候 把 宿 主机 的 jdk 路径 挂 载到 容器 就去 部署 jdk 很简单 解压 就行 我们 把 它 解 压在 宿 主机 的 usrlocal 目录 中 部署 maven 由于 本文 后期 是 通过 jenkins 运行 java 项目 所以 我们 还需要 maven 工具 maven 也 和 jdk 部署 一样 也 不 想在 容器 中 运行 maven 所以 也是 部署 在 宿主 机上 然后 挂 载到 容器 中 也是 直接 解压 查看 一下 这两个 源码 软件 是否 解压 生成 jenkins 镜 像在 本 文中 我们 引用 dockerhub 中 的 官方 镜像 来 编 写个 dockerfile 文件 说明 下面 我 创建 个 目录 来 放置 jenkins 的 dockerfile 文件 这个 文件 随便 放在 哪个 目录 都行 说明 第 行 from 引 用了 官方 镜像 jenkins 这个 jenkins 是 基于 debiant 系统 构建 的 第 行 user 使用 root 用户 来 运行 第 行 run 更 改了 aptget 源 为 国内 的 源 第 行 run 是 安装 git 客户端 由于 官方 的 jenkins 镜像 没有 安装 git 客户端 我们 需 要在 jenkins 容器 中 调用 git 命令 所以 在此 需要 安 装下 git 客户端 当然 你 也 可以 启动 jenkins 容器 后 在 容器 中 安装 不过 笔者 建议 需要 安装 的 东西 最好 的 dockerfile 中就 弄好 构建 jenkins 镜像 创建 jenkins 镜像 参数 说明 上面 的 参数 都是 最 常用 的 都 比较 很简单 很好 理解 d 在 后台 运行 容器 p 映射 端口 v 宿 主机 的 目录 挂 载到 容器 varjenkinshome 这个 目 录在 宿 主机 中空 的 这是 把 容器 中 的 jenkinis 主目录 绑定 到 宿 主机 中 来 其它 的 两个 目录 是 之前 解压 的 工具 来 查看 jenkins 运行 状态 上面 的 两个 状态 显示 jenkins 容器 运行 都是 ok 的 配置 jenkins 初始化 配置 通过 httpip 来访问 jenkins 服务 从 上图 给出 的 提示 需 要从 获取 密码 登录 成功 后 回 让 你 选择 插件 的 安装 可以 选择 建议 的 安装 也 可以 自己 进行 选择 不清楚 的话 可以 使用 建议 的 安装 由于 建议 安装 的 插件 比 较多 安装 的 过程 有点 慢 多 等待 一会 安装 完成后 最好 新创建 一个 管理员 账户 代替 之前 的 临时 自动 生成 的 密码 账户 系统 设置 进入 系统管理 系统 设置 主 要是 把 docker 这台 服务器 通过 ssh 的 形式 添加 进来 后期 部署 dokcer 容器 如 下图 参数 说明 这个 意思 是 把 代码 发布 到 data 目录 中 需要 手动 创建 个 目录 勾 选 它 输入 这台 docker 服务器 的 密码 配置 mavenjdkgit 环境 jdk 配置 进 系统管理 添加 jdk 安装 如 下图 参数 说明 别名 自定义 就行 javahome 这个 是 你 jenkins 容器 里 的 jdk 路径 不是 宿 主机 的 jdk 路径 maven 配置 进 系统管理 添加 maven 安装 如 下图 参数 说明 和 jdk 一样 mavenhome 的 路径 也是 指向 jenkins 容器 里 的 maven 路径 git 配置 这里 我 没有 动 git 的 配置 让 它为 默认 配置 如 下图 配置 java 项目 构建 maven 项目 点击 新建 构建 一个 maven 项目 项目名称 定为 javatale 如 下图 源码 管理 在 源码 管理 项 中 选择 git 只需要 配置 git 仓库 的 地址 r repositoryurl 之前 我们 在 jenkins 服务器 上 把 公 钥 传输 到了 git 服务器 上了 所以 不需 要做 认证 如 下图 构建 触发器 在 构建 触发器 选项 中 选上 pollscm 日程表 每分钟 都去 捡 查 代码 这个 和 linuxcrontab 是 一样 的 含义 这一 项 你 也 可以 不用 测试 如 下图 build 配置 在 build 选项 中 goalsandoptions 输入 cleanpackage 如 下图 构建 后 的 配置 在 poststeps 选项 中 配置 如下 操作 配置 说明 nmae 选择 需要 部署 的 docker 服务器 前面 我们 ssh 增加了 一台 所以 这里 可以 直接 选择 sourcefiles 需要 部署 到 目标 服务 的 打包 成果 路径 配置 的 路径 中 要 移除 的 前缀 remotedirectory 成果 要 发送到 的 远程目标 服务 目录 路径 这个 路径 与 第一步 配置 中 的 remotedirectory 对应 execcommand 成果 发送 完成后 需要 执行 的 命令 具体 如下 在 execcommand 执行 中 的 命令 都是 在 构建 代码 完成后 的 操作 会在 docker 这台 服务器 上 执行 第 条 命令 其实 这 两步 你 先 可以 不用 加上 到了 下一次 构建 的 时候 你 测试 一下 不加 这两条 命令 会有 什么 结果 如果 构建 失败 你 在 加上 这两条 命令 其实 这两条 命令 是 事先 删除 容器 和 镜像文件 然后 通过 第 条 命令 运行 全新 的 容器 第 条 命令 就是 通过 dockerrun 来 运行 taletest 容器 了 并把 docker 这台 服务器 的 jdk 和 tale 目录 挂 载到 容器 中 测试 配置 上 之后 构建 此 项目 查看 控制台 输出 日志 看到 最上面 完成 的 状态 就可以 进行 测试 了 如果是 第一次 构建 时间 会 比较 久 它 需要 下载 maven 相关 的 依赖 包 然后 登录 docker 服务器 查看 一下 运行 的 容器 最后 通过 用 浏览器 来访问 一下 这个 用 java 写 的 tale 开源 博客 项目 从 上面 可以 看到 我 是 通过 docker 那个 服务器 ip 来访问 的 访问 是 ok 的 到此 实战 构建 持续 集成 环境 就 结束 了 总结 首先 要对 整个 流程 熟悉 思路 不能 乱 规划 好 服务器 数量 和 部署 的 应用服务 本文 中用 的 jar 包 来 测试 的 一般 jar 包 直接 用 jar 命令 运行 也 可以 部署 在 tomcat 容器 中 jar 包 不依赖 tomcat 所以 本文 在 基础 镜像 talebase 中 只是 安 装了 nginx 并没有 安装 tomcat 如果 大家用 war 包 那么 这个 基础 镜像 就要 重新 制 作了 在 步 的 第 小步 中 构建 后 的 操作 是不是 有 一堆 命令 其实 也 可以 把 它 写成 一个 shell 脚本 直接 调用 一 执行 看 个人 操作 习惯 还有 就是 用 dockferfile 构建 基础 镜像 中 这些 服务 都是 通过 yum 来 安装 的 我们 也 可以 把 它 换成 源码 安装 大家 可以 自行 测试 一下 遇到 错误 的 时候 自己 先 排错 不要 急于 百度 或 问 别人 答案 容器 这一 块 的 错误 通过 dockerlogs 容器 容器 等 命令 可以 很好 的 定位 错误 并且 可以 很 方便 的 用 dockerexecit 容器 bash 进入 容器 直接 排查 错误 参考 文章 条 评论 按 时间 倒 序 按 时间 正 序 llqzhq 楼 docker 服务器 安装 jdk 的 时候 你 文章 是 显示 的 jenkins 服务器 安装 如果 docker 服务器 不 安装 jdk 会 导致 访问 作者 甘 兵 llqzhq 是的 docker 服务器 运行 的 容器 也 需要 jdk 环境 在 本文 配置 docker 服务器 中 的 第 步 表 明了 docker 服务器 也要 jdk 环境 回复 llqzhq 甘 兵 可能是 部署 jdk 的 时候 上面 显示 的 主机名 是 jenkins 所以 回复 作者 甘 兵 llqzhq 还好 你 提 醒了 笔误 笔误 感谢 已 修正 回复 请问 对于 经常 要 更新 的 java 项目 运 行在 docker 中 jenkins 具体 应该 如何做 ci 回复 wxcbdab 楼 为什么 taleleastjar 总是 不能 复制到 docker 服务器 上 呢 作者 甘 兵 wxcbdab 步骤 有没有 操作 jenkins 服务器 测 一下 能 ssh 到 dokcer 服务器 吗 回复 wxbcefbwxcbdab 老哥 我 的 再 docker 容器 里面 安装 git 总是 报错 能否 加 一个 联系方式 指导 一二 回复 qqadcba 楼 你好 为什么 我 的 jenkins 和 的 管理 页面 跟 您 的 不一样 呢 好多 步骤 找不到 啊 麻烦 问 您 下下 作者 甘 兵 qqadcba 是不是 版本 不一样 你 是 用 的 哪个 jenkins 版本 的 回复 qqadcba 甘 兵 jenkinsver 版本 您好 请问您 的 qq 是多少 可以 加个 好友 吗 回复 wxcbdab 楼 可以 了 昨天 文件夹 写 错了 作者 甘 兵 wxcbdab 不错 厉害 回复 wxbebca 楼 我 的 最终 构建 成功 了 容器 也 启 动了 但是 输入 网址 打开 的 不是 tale 开源 博客 而是 nginx 的 页面 是 挂载 的 nginx 配置文件 有 问题 么 作者 甘 兵 wxbebca 你 对比 一下 步骤 中 的 第 步 构建 tale 开源 博客 的 基础 镜像 对比 一下 dockerfile 文件 回复 wxbebca 甘 兵 nice 已经 好了 是 最后 挂载 的 路径 不对 datataletale 我 的 路径 是 datadatatale 改了 下 就 好了 回复 qqefcdfwxbebca 大佬 我 也 遇 到了 这个 问题 我 对 比了 很 多次 没有 发现 错误 不知道 怎么回事 回复 yikayi 楼 javajar 启动 taleleastjar 包 applicationjava classloaderjava launcherjava classloaderjava 你好 请问 一下 你 的 jenkins 构建 就是 使用 作者 的 代码 构建 没有 修改 什么 吗 回复 quintinxwxbcefb 我 也 遇到 这个 问题 可否 帮忙 回复 wxaace 楼 大佬 qq 是多少 求 加 jranson 楼 请问 生 产中 的 服务 原 先跑 在 传统 服务器 上 应该 怎么 迁 移到 docker 容器 里面 雨后 龙井 楼 好文 能 打 赏 吗 wxce 楼 兵哥 请问 jenkins 容器 配置 jdkmaven 你 的 dockerfile 里 没有 配置 dk 和 maven 的 环境变量 仅仅 启动 时候 挂载 了 这样 的话 可以吗 还是 说 只要 你 在 jenkinsweb 页面 配置 了 jdkmaven 就可以 了 呢 tom 君 君 wxce 是 呀 我 看到 他 文章 里 都没有 配置 jdk 环境变量 回复 