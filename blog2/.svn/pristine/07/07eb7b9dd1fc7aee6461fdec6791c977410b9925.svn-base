系统安全 十一 那些 年 的 熊猫 烧香 及 pe 病毒 行为 机理 分析 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 如果 你想 成为 一名 逆向 分析 或 恶意代码 检测 工程师 或者 对 系统安全 非常 感兴趣 就必须 要 认真 分析 一些 恶意 样本 熊猫 烧香 病毒 就是 一款 非常 具有 代表性 的 病毒 当年 造成了 非常大 的 影响 并且 也有 一定 技术手段 本文 将 详细 讲解 熊猫 烧香 的 行为 机理 并 通过 软件 对 其 功能 行为 进行 分析 这将 有助于 我们 学习 逆向 分析 和 反病毒 工作 后续 作者 还 将对 其 进行 逆向 调试 以及 wannacry 勒索 蠕虫 各种 恶意 样本 及 木马 的 分析 基础性 文章 希望 您 喜欢 同时 本文 部分 实验 参考 姜 晔 老师 的 视频 分析 真的 非常 佩服 和 值得 去 学习 的 一位 老师 技术 路上 哪有 享乐 为了 提升 安全 能力 别 抱怨 干 就 对了 话 不 多说 让我们 开始 新 的 征程 吧 您 的 点 赞 评论 收藏 将是 对 我 最大 的 支持 感恩 安全 路上 一路 前行 如果有 写得 不好 的 地方 可以 联系 我 修改 基础性 文章 希望 对 您 有所 帮助 作者 的 目的 是 与 安 全人 共同进步 加油 也 强烈推荐 大家 去 看看 参考文献 的 视频 和 书籍 文章 目录 一 pe 病毒 概念 二 什么 是 熊猫 烧香 病毒 三 熊猫 烧香 病毒 行为 分析 四 样本 运行 及 查杀 防御 五 procmon 检测 病毒 行为 软件 基本 介绍 病毒 行为 检测 六 总结 作者 的 github 资源 系统安全 网络安全 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 破解 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 系统安全 八 windows 漏洞 利 用之 cve 复现 及 蓝屏 攻击 系统安全 九 windows 漏洞 利 用之 ms 远程 代码 执行 漏洞 复现 及 深度 提 权 系统安全 十 windows 漏洞 利 用之 smbv 服务 远程 代码 执行 漏洞 cve 复现 系统安全 十一 那些 年 的 熊猫 烧香 及 pe 病毒 行为 机理 分析 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 该 样本 不会 分享 给 大家 分析 工具 会 分享 参考文献 见 后 一 pe 病毒 概念 首先 简单 给 大家 普及 下 pe 病毒 的 基础 概念 和 分类 方便 大家 理解 熊猫 烧香 病毒 的 行为 什么 是 pe 病毒 pe 病毒 是以 windowspe 程序 为 载 体能 寄 生于 pe 文件 或 windows 系统 的 病毒 程序 pe 病毒 数量 非常 之多 包括 早起 的 cih 病毒 全球 第一个 可以 破坏 计算机硬件 的 病毒 它会 破坏 主办 的 bios 对 其 数据 进行 擦写 修改 再 比如 熊猫 烧香 机器 狗 等等 其 危害 非常 之大 什么 叫 感染 说到 病毒 不得 不提 感染 感染 是 指在 尽量 不影响 目标 程序 系统 正常 功能 的 前提下 而 使其 具有 病毒 自身 的 功能 什么 叫 病毒 自身 的 功能 呢 一个 病毒 通常 包括 如下 模块 感染 模块 被 感人 程序 同样 具备 感染 能力 触发 模块 在 特定 条件下 实施 相应 的 病毒 功能 比如 日期 键盘输入 等 破坏 模块 其他 模块 编写 病毒 的 核心技术 如果 我们 要 编写 pe 病毒 则 需要 掌握 以下 的 关键技术 病毒 的 重 定位 获取 api 函数 地址 文件 搜索 内存 映射 文件 病毒 如何 感染 其他 文件 病毒 如何 返 回到 host 程序 pe 病毒 分类 以 感染 目标 进行 分类 包括 文件 感染 型 将 代码 寄 生在 pe 文件 病毒 本身 只是 pe 文件 的 一部分 依赖于 感染 目标 通常 也 叫 host 文件 控制权 获得 也 是以 目标 程序 运行 来 获得 的 它 分为 传统 感染 型 以 win 汇编程序 编写 为 主和 捆绑 释放 型 编写 难度 较低 通过 高级 语言 均可 编写 将 目标 程序 和 病毒 程序 捆在 一起 和 捆绑 器 有 相似之处 系统 感染 型 将 代码 或 程序 寄 生在 windows 操作系统 该类 病毒 越来越多 它不 感染 具体 文件 但是 它 会在 操作系统 中 保存 自己 的 实体 同时 也 可以 通过 系统启动 的 方法来 获取 控制权 传播 途径 包括 即时 通信 软件 如 qq 尾巴 u盘 光盘 电子邮件 网络共享 其他 途径 等 熊猫 烧香 病毒 属于 捆绑 释放 型 其 感染 实现 起来 比较简单 目前 很大 一部 分病毒 程序 都 采用 这种 方法 捆绑 释放 型 感染 时 将 目标 host 程序 作为 数据 存储 在 病毒 体内 当 执行 病毒 程 序时 它 先 执行 病毒 程序 然后 还原 并 执行 host 文件 从而 保证 被 感染 的 程序 本身 能 正常 运行 不会 引起 一些 异样 如 下图 所示 左边 是 一个 正常 程序 qq 感染 之后 会将 病毒 放在 前面 正常 程序 放在 后面 程序 运行 之后 病毒 会 拿到 控制权 但 缺点 是 程序 图 标会 显示 前面 的 病毒 程序 显示 熊猫 烧香 这是 一个 明显 的 被 感染 特征 常见 自启动 方式 pe 病毒 运行 之后 需要 使用 自启动 技术 保证 下次 开机 再运行 常见 的 自启动 方式 包括 注册表 中 的 键值 特定 路径 的 特定 文件 系统 中 的 特定 位置 如 explorerexe 显示桌面 利用 系统 自动播放 机制 autoruninf 比如 u盘 病毒 或 光盘 病毒 就是 利用 u盘 或 光盘 的 自动播放 功能 目前 也有 一些 u盘 插入 之后 不需 要你 去 双击 这个 u 盘里 面的 程序 就会 自启动 在其 他 可执行文件 嵌入 少量 触发 代码 比如 修改 引入 函 数节 启动 dll 病毒 文件 添加 相应 结构 初始化 代码 触发 或在 特定 pe 文件 代码 段 插入 触发 代码 等 只需 定位 可执行 程序 并 运行 dll 劫持 替换 已有 dll 文件 很多 应用程序 或 操作系统 执 行时 都 会去 执行 dll 文件 如果 病毒 将 自身 做成 一个 dll 文件 同时 将 系统 dll 文件 替换 可想而知 系统 启动时 它是 根据 文件名 启动 的 此时 病毒 dll 文件 就会 拿到 控制权 如果 拿到 控制权 之后 再进 一步 装载 原始 dll 文件 这样 系统 的 本身 机制 也 不会 受到影响 隐蔽性 更强 该 方法 非常 常见 甚至有 一些 病毒 程序 将 反病毒软件 可 依赖 的 dll 文件 替换 下图 展示 了 autoruns 软件 看到 windows 操作系统 进行 自启动 的 选项 如果 病毒 本身 能 很好 地 结合 这套 机制 它 可以 做的 事情 非常 多 并且 具有 很好 的 隐蔽性 再 比如 我们 之前 分享 的 winrar 漏洞 cve 当 恶意 ace 文件 被 受害者 解压 之 后会 释放 恶意 木马 至 指定 目录 系统 自启动 文件夹 受害者 重启 电脑 会 执行 恶意 木马 如 下图 所示 网络安全 自学 篇 三十六 winrar 漏洞 复现 cve 及 恶意 软件 自启动 劫持 常见 传播 方式 一切 可对 外 交互 的 渠道 都可 传播 包括 各类 存储 设备 软盘 光盘 u盘 移动硬盘 智能 设备 各类 网络通信 方式 qqmsnemail 淘宝 旺旺 微 信 微 博 等 各类 网络连接 方式 有线 wifi 蓝牙 等 各类 网络 应用 迅雷 bt 等 比如 通过 可 移动 存储 设备 传播 的 非 感染 式 病毒 即 autoruninf 下图 显示 了 autoruninf 文件 如果 文件 存在 u盘 根目录 当 我们 双击 这个 u盘 时 它 就会 触发 对应 的 病毒 如果 选择 u盘 盘符 右键 打开 或 打开 资源管理器 这是 进入 的 也是 病毒 程序 当然 演示 的 是 计算器 程序 打开 ampo 资源管理器 ampx 最后 展示 stuxnet 震 网 事件 的 漏洞 利用 过程 和 启动 方式 传统 的 autorun 方式 很 容易 被 禁止 掉 而 stuxnet 利用 的 是 lnk 漏洞 ms 它 会在 目标 u盘 下 放入 lnk 快捷方式 及 病毒 程序 如 dll 文件 不管 通过 什么 方式 进入 u盘 lnk 文件 会被 解析 从而 触发 漏洞 导致 u盘 中 的 病毒 程序 被执行 所以 day 漏洞 也 越来越多 应用到 安全 攻击 中二 什么 是 熊猫 烧香 病毒 熊猫 烧香 wormwhboy 是 一款 拥有 自动 传播 自动 感染 硬盘 能力 和 强大 的 破坏 能力 的 病毒 它不 但能 感染 系统 中 等 文件 它 还能 中止 大量 的 反病毒软件 进程 并且会 删除 扩展 名为 gho 的 文件 该 文件 是 一 系统 备份 工具 ghost 的 备份文件 使 用户 的 系统 备份文件 丢失 被 感染 的 用户 系统 中所 有 exe 可执行文件 全部 被 改成 熊猫 举着 三根 香 的 模样 年月日 由 岁 的 湖北武汉 李 俊 编写 年 月初 肆虐 网络 它 主要 通过 下载 的 文件 传染 传播 年 熊猫 烧香 可谓 是 轰动一时 时隔多年 当 我们 回 过头 再次 来看 该 事件 熊猫 烧香 的 破坏力 远大于 其 技术含量 尤其是 对 网络 信息 安全 产生 深远 的 影响 毕竟 它是 第一个 让 中国 普通用户 对 木马病毒 有所 认识 和 感知 的 现 在从 技术 角度 来看 熊猫 烧香 病毒 技术水平 一般 但 病毒 作者 在当 时 运用 的 各类 技术 手法 还是 值得 安全 人 参考 和 借鉴 的 首先 其 可以 感染 exe 文件 也 可以 将以 gho 结尾 的 文件 删除 其次是 将 源 病毒感染 到 web 文件 使 网页 成为 它 传播 的 介质 然后 在 传播 层面 病毒 作者 使用 众多 传播 途径 最后 是 具备 一定 的 对抗 杀 软 能力 正如 腾讯 安全 联合 实验室 文章 说的 一样 见 参考文献 熊猫 烧香 病毒 如果是 放在 现在 这些 基 本是 所有 病毒 木马 常见 必备 的 技术 但 技术 不可同日而语 随着 人工智能 大数 据云 计算 区块 链 等 先进技术 的 不断发展 病毒 作者 也 将 这些 技术手段 运 用到 各类 安全 攻 击中 危害 大家 典型 的 包括 勒索 病毒 在 年月日 一款 名为 wannacry 勒索 病毒 通过 ms 漏洞 在 全球 范围 大 爆发 感染 了 大量 的 计算机 此后 等 勒索 病毒 相继 对 企业 及 机构 发起 攻击 挖矿 木马 伴随着 比特 币 等 虚拟 数字 货币 交易 火爆 的 同时 越来越多 的人 利用 数字 虚拟 币 交易 大发横财 吸引 大量 黑 产 从业人员 进入 挖矿 产业 这 也是 为什么 年 之后 披露 的 挖矿 木马 攻击 事件 数量 呈现出 爆 发式 的 增长 apt 攻击 当前 鱼叉 攻击 水坑 攻击 远程 可执行 漏洞 和 密码 爆破 攻击 等 手段 依然是 apt 攻击 的 最主要 方式 未来 fileless 攻击 将 通信 的 campc 服务器 存放在 公开 的 社交 网 站上 使用 公开 或者 开源 工具 多 平台 攻击 和 跨 平台 攻击 将成 apt 攻击 技术 的 主要 发展趋势 iot 攻击 黑客 通常 通过 设备 弱 口令 或者 远程 命令 执行 漏洞 对 iot 设备 进行 攻击 攻击者 通过 蠕虫 感染 或者 自主 的 批量 攻击 来 控制 批量 目标 设备 构建 僵尸 网络 iot 设备 成 为了 黑客 最新 热爱 的 武器 除此之外 供应链 攻击 ai 对 对抗 样本 视频 语音 欺骗 等 攻击 延伸 都是 未来 黑客技术 的 发展趋势 这些 都应该 引起 我们 足够 的 重视 这些 病毒 事件 一方 面会 警醒 我们 网络空间 安全 另一方面 也 会 督促 我们 安全 人员 不断 思考 和 对抗 未知 攻 焉知 防 三 熊猫 烧香 病毒 行为 分析 熊猫 烧香 病毒 有 它 的 特殊性 也有 它 的 通用性 下面 结合 第一 部分 pe 病毒 基础知识 介绍 熊猫 烧香 病毒 的 基本 行为 自启动 方式 熊猫 烧香 病毒 将 自身 拷贝 至 系统 目录 同时 修改 注册表 将 自身 设置 为 开机 启动项 这种 方式 也是 绝大部分 病毒 自启动 所 采用 的 方式 拷贝 自身 到 所有 驱动器 根目录 盘符 命名为 setupexe 在 驱动器 根目录 生成 autoruninf 文件 并把 它 设置 为 隐藏 只读 系统 autoruninf 文件 的 作 用是 允许 在 双击 磁盘 时 自动 运行 指定 的 某个 文件 即 运行 setupexe 注意 该 setupexe 文件 被 设置 为 隐藏 只读 系统 虽然 我们 可以 查看 隐藏 的 项目 但 某些 隐藏 的 系统 文件 仍然是 看不到 的 我们 需要 进一步 设置 取消 勾 选 隐藏 保护 的 操作系统 文件 才能 显示 这类 文件 如 下图 所示 而 通常 设置 为 隐藏 的 系统 文件 是 较 难被 觉察 的 尤其 当 这类 文件 被 写入 到 某个 指定 的 操作系统 目录 中 防不胜防 感染 与 传播 方式 感染 可执行文件 熊猫 烧香 病毒 会 搜索 并 感染 系统 中 特定 目录 外 的 所有 exescrpifcom 等 文件 将 自身 捆绑 在被 感染 文件 前端 并在 尾部 添加 标记 信息 whboy 原 文件名 exe 原文件 大小 注意 它 感染 的 是 特定 目录 外 的 而 某些 系统 目录 是 不去 感染 的 因为 windows 系统 某些 可执行文件 是 有 还原 机制 的 系统 文件 修改 有时候 会有 报警 提示 感染 网页 熊猫 烧香 病毒 会 查找 系统 以 html 和 asp 为 后缀 的 文件 在里面 插入 网页 标记 这个 帧 iframe 会将 另外 一个 url 嵌入 到 当前 网页 并且 宽度 和 高度 设置 为 看不到 嵌入 页面 后会 利用 如 ie 浏览器 的 漏洞 来 触发 恶意代码 从而 释放 相应 病毒 出来 通过 弱 口令 传播 这种 传播 方式 非 普遍 它会 访问 局域网 共享 文件夹 将 病毒 文件 拷贝到 该 目 录下 并 改 名为 gamesetupexe 模拟游戏 名称 通过 弱 口令 猜测 从而 进入 系统 c 盘 自我 隐藏 禁用 安全 软件 熊猫 烧香 病毒 会 尝试 关闭 安全 软件 杀毒软件 防火墙 安全 工具 的 窗口 进程 比如 包含 的 名称 等 删除 注册表 中 安全 软件 的 启动项 禁用 安全 软件 的 服务 等 操作 自动 恢复 显示 所有 文件 和 文件夹 选项 隐藏 功能 某些 用户 去看 隐藏 文件 会 主动 点击 查看 隐藏 文件夹 但 这个 病毒 会 自动 恢复 隐藏 删除 系统 的 隐藏 共享 netsharewindows 系统 其实 默认 会 开启 隐藏 共享 c 比如 早期 的 ipc 管道 等 通过 netshare 命令 可以 删除 隐藏 共享 ipc 在 未经 授权 情况 很难 将 木马 拷贝到 别人 的 电脑 上 这里 需要 利用 ipc 漏洞 调用 端口号 实现 端口 中有 个 ipc 称之为 空 连接 没有 固定 文件夹 的 共享 而 cde 代表 分区 共享 是 有 固定 文件夹 的 换句话说 端口 打开 就 相当于 我们 可以 在 局域网 中 轻松 访问 各种 共享 文件夹 如果您 的 电脑 是 弱 密码 很 容易 就被 攻破 这里 使用 ipc 暴力 爆破 ipc 是 共享 命名 管道 的 资源 它是 为了 让 进程 间 通信 而 开放 的 命名 管道 通过 提供 可信任 的 用户名 和 口令 连接 双方 可以 建立 安全 的 通道 并 以此 通道 进行 加密 数据 的 交换 从而 实现 对 远程 计算机 的 访问 ipc 是 nt 的 一项 新功能 它有 一个 特点 即在 同一 时间内 两个 ip 之间 只允许 建立 一个 连接 nt 在 提供 了 ipc 功能 的 同时 在 初次 安装 系统 时 还 打 开了 默认 共享 即 所有 的 逻辑 共享 cde 和 系统 目录 cwindows 共享 所有 的 这些 初衷 都是 为了 方便 管理员 的 管理 但 好 的 初衷 并不一定 有 好 的 收效 一些 别有用心 者 会 利用 ipc 访问 共享资源 导出 用户 列表 并 使用 一些 字典 工具 进行 密码 探测 推荐 作者 前文 网络安全 自学 篇 木马 原理 详解 远程 服务器 ipc 漏洞 及 木马 植入 实验 下图 展示 了 使用 ntscan 软件 暴力 爆破 该软件 支持 远程 连接 ipc 和 利用 字典 文件 运行 软件 输入 ip 地址 选择 ipcsan 连接 共享 ipc 成功 获 取了 密码 com 接着 与 目标 主机 建立 ipc 空 连接 破坏 功能 熊猫 烧香 病毒 同 时会 开 另一个 线程 连接 某 网站 下载 ddos 程序 进行 发动 恶意 攻击 具有 破坏 功能 可 开启 附件 攻击行为 熊猫 烧香 感染 计算机 台数 非常 多 它 就能 发动 多台 电脑 发起 ddos 攻击 删除 扩展 名为 gho 的 文件 延长 存活 时间 该 文件 是 系统 备份 工具 ghost 的 备份文件 从而 使 用户 的 系统 备份文件 丢失 当 用户 中了 病毒 想去 恢复 时 就 存在 困 难了 这 就是 一个 典型 的 病毒 案例 当然 现在 很多 病毒 功能 都 具有 相似性 它们 有 经济利益 趋势 当然 对于 不同 的 病毒 来说 如果 它 的 目的 不一样 其 行为 会 存在 很大 差异 当然 熊猫 烧香 病毒 的 隐蔽性 不是 很好 每一个 感染者 都会 知道 自己 已被 感染 四 样本 运行 及 查杀 防御 首先 作者 将 熊猫 烧香 病毒 拷贝到 虚拟机 系统 中 注意 一定 不能 真 机 去 运行 更不 能去 破坏 或 伤害 他人 该 样本 不会 分享 给 大家 任何 破坏 行为 都将 受到 严惩 我 仅是 从 反病毒 原理 及 防御 方面 进行 技术 分享 实验 环境 windowsxp 实验 文件 熊猫 烧香 exe 正如 姜 晔 老师 说的 一样 手动 查杀 病毒 基本 流程 如下 排查 可疑 进程 因为 病毒 往往会 创建 出来 一个 或者 多个 进程 因此 需要 分 辨出 哪些 进程 是 由 病毒 所 创建 然后 删除 可疑 进程 检查 启动项 病毒 为了 实现 自启动 会 采用 一些 方法 将 自己 添加到 启动项 中 从而 实现 自启动 所以 我们 需 要把 启动项 中 的 病毒 清除 删除 病毒 在上 一步 的 检查 启动项 中 我们 就 能够 确定 病毒 主体 的 位置 这样 就可以 顺藤摸瓜 从根本上 删除 病毒 文件 修复 被 病毒 破坏 的 文件 这一步 一般来说 无法 直接 通过 纯手工 完成 需 利用 相应 的 软件 不是 我们 讨论 的 重点 为什么 计算机中 安 装了 杀毒软件 还 要去 手动 查杀 呢 因为 杀毒软件 存在 严重 的 滞后性 必须 要等 病毒 工程师 抓取 对应 样本 并 进行 分析 总结 病毒 的 特征 码 再 加入 杀 软 病毒库 后 才能 识别 病毒 但 病毒 会 存在 各种 变种 因此 手动 查杀 也是 必要 的 同时 这对 我们 反病毒 工程师 来说 也是 认识 和 熟悉 病毒 的 过程 在技术上 是 非常 必要 的 这 也是 现在 为什么 很 多云 沙箱 云 杀 软 动态 更新 的 技术 不断出现 实验 目的 学会 基本 的 手动 查杀 理论 学会 利用 dos 命令行 删除 病毒 及其 影响 第一步 运行 病毒 前 打开 任务 管理器 观察 此时 打开 的 进程 第二步 运行 程序 可以 发现 任务 管理器 就 自动 关闭 并且 无法 再次 打开 总 一闪而过 那么 我们 怎么 查看 系统 中 的 进程 呢 第三步 打开 cmd 命令提示符 输入 命令 tasklist 查看 显示 进程 信息 如 下图 所示 我们 发现 多 出来 spoclsvexe 进程 该 程序 即为 熊猫 烧香 病毒 创建 出来 的 进程 第四步 输入 taskkillfim 命令 强制 结束 这个 进程 其中 f 表示 强制执行 im 表示 文件 镜像 对应 pid 值 如 下图 所示 成功 杀掉 该 进程 第五步 排查 可疑 进程 之后 我们 接下来 查询 启动项 在 运行 中 输入 msconfig 显示 如 下图 所示 可以 看到 spoclsv 启动项 第六步 检测 该 启动项 创建 的 位置 及 键值 第七步 我们 打开 注册表 查看 对应 的 值 发现 创 建了 一个 svcshare 的 值 并 启动 对应 exe 程序 接着 我们 打开 这个 目录 查看 第八 步 取消 勾 选 spoclsv 启动项 点击 确定 先 暂时不 重启 计算机 接着 刷新 注册表 发现 spoclsv 已经 消失 表示 启动项 已经 成功 被 删除 第九步 我们 需要 删除 这个 病毒 这里 使用 cmd 命令行 对 其 进行 删除 输入 delfspoclsvexe 强制 删除 该 文件 显示 如 下图 所示 成功 删除 写到 这里 我们 是否 真的 成功 清 除了 熊猫 烧香 病毒 呢 no 该 病毒 还将 自身 复制到 每一个 磁盘 的 根目录 下第 十步 删除 隐藏 系统 只读 的 文件 输入 dirah 查看 隐藏 的 文件 发现 autoruninf 和 setupexe 接着 强制 删除 这两个 文件 也 可以 将 文件 属性 修改后 删除 消除 隐藏 系统 只读 属性 重启 系统 后 所有 手动 查杀 病毒 的 工作 完毕 我们 的 系统 就又 恢复 正常 了 五 procmon 检测 病毒 行为 接着 我们 通过 processmonitor 工具 来 监控 熊猫 烧香 病毒 的 行为 软件 基本 介绍 processmonitor 是 微软 推荐 的 一款 系统 监视 工具 能够 实时 显示文件 系统 注册表 读写 网络连接 与 进程 活动 的 高级 工具 它 整合 了 旧 的 sysinternals 工具 filemon 与 regmon 其中 filemon 专门 用来 监视 系统 中 的 任何 文件 操作过程 regmon 用来 监视 注册表 的 读写 操作过程 filemon 文件 监视器 regmon 注册表 监视器 同时 processmonitor 增加了 进程 id 用户 进程 可靠 度 等 监视 项 可以 记 录到 文件 中 它 的 强大 功能 足 以使 processmonitor 成为 您 系统 中 的 核心 组件 以及 病毒 探测 工具 processmonitor 可以 帮助 使用者 对 系统 中 的 任何 文件 注册表 操作 进行 监视 和 记录 通过 注册表 和 文件 读写 的 变化 有效 帮助 诊断 系统故障 或 发现 恶意 软件 病毒 及 木马 下载 procmonexe 软件 后 直接 双击 启动 procmon 会 自动 扫描 分析 系统 当前 程序 的 运行 情况 其中 下图 框出来 的 个 常用 按钮 作用 分别为 捕获 开关 清屏 设置 过滤 条件 查找 最后 个 并排 的 按钮 是 用来 设置 捕获 哪些 类型 的 事件 分别 表示 注册表 的 读写 文件 的 读写 网络 的 连接 进程 和 线程 的 调用 和 配置 事件 一般 选择 前面 个 分别为 注册表 和 文件 操作 输出 结果 中 包括 序号 时间 点 进程 名称 pid 操作 路径 结果 描述 等 监控 项 通常 包括 文件 系统 注册表 进程 跟踪 所有 进程 和 线程 的 创 建和 退出 操作 剖析 事件 扫描 系统 中所 有 活动 线程 为 每个 线程 创建 一个 剖析 事件 记录 它 耗费 的 核心 和 用户 cpu 时间 以及 该 线程 自 上次 剖析 事件 以来 执 行了 多少次 上下文 转换 更多 用法 推荐 作者 的 前文 下面 直接 讲解 针对 熊猫 烧香 病毒 的 行为 分析 网络安全 自学 篇 四十九 procmon 软件 基本 用法 及 文件 进程 注册表 查看 病毒 行为 检测 第一步 打开 procmonexe 软件 第二步 在 筛选 器 中 选择 打开 procmonexe 软件 filter 中 选择 过滤 病毒 的 名称 然后 点击 添加 和 应用 第三步 运行 熊猫 烧香 病毒 可以 看到 它 捕获 了 非常 多 的 病毒 信息 第四步 首先 查看 病毒 的 processtree e 进程 树 可以 看到 setupexe 的 熊猫 烧香 病毒 程序 并 衍 生出 一个 spoclsvexe 程序 位置 信息 为 第五步 发现 spoclsvexe 程序 三次 打开 cmd 运行 netshare 命令 删除 各个 磁盘 共享 及 系统 根目录 共享 虚拟机 共享 功能 盘 此时 我们 总结 病毒 的 行为 第 点 行为 创建 spoclsvexe 程序 并 位于 目录 第 点 行为 命令行 模式 下 使用 netshare 解除 共享 功能 第六步 回到 procmon 软件 进行 深入分析 关闭 其他 结果 只显示 注册表 行为 接着 在过 滤器 中 仅 显示 对 注册表 修改 的 值 如 下图 所示 主要 修改 的 是 seed 项 就是 随机数 种子 的 生成 但 仅仅 通过 这个 信息 无法 推测 注册表 的 行为 所以 该 病毒 对 注册表 并没有 什么 实质性 影响 第七步 查看 病毒 对 文件 的 修改 在过 滤器 中 删除 注册表 的 修改 然后 检测 熊猫 烧香 病毒 是否 创建 文件 创建 文件 也是 病毒 的 重要 手段 可以 看到 主要 创建 的 文件 是 目 录下 其他 并没有 特别 的 东西 所以 setupexe 程序 对 我们 的 系统 并没有 实质性 影响 主要 影响 还是 spoclsvexe 程序 所以 下一步 操作 就是 监控 spoclsvexe 程序 第八 步 在过 滤器 中 删除 对 setupexe 的 监控 设置 对 spoclsvexe 程序 的 监控 第九步 在过 滤器 中 查看 spoclsvexe 删除 注册表 选项 从 这些 名称 可以 看到 它们 都是 常用 的 杀毒 软件名称 其 位置 是 currentversion 的 run 下面 即将 杀毒软件 的 自动 启 项 全部 删除 第 点 行为 删除 安全类 软件 在 注册表 中 自动 启 项 第 十步 在过 滤器 中 查看 spoclsvexe 创建 及 设置 的 注册表 键值 显示 结果 如 下图 所示 病毒 设置 了 自 启动项 要 启动 的 本体 是 drivers 目 录下 的 spoclsvexe 第 点 行为 在 注册表 创建 svcshare 自 启动项 每次 开机 时会 自动 运行 病毒 继续 查看 发现 它对 文件 实现 隐藏 设置 该 值 后 即使 我们 在 文件夹 选项 中 选择 显示 所有 文件 和 文件夹 也 无法 显示 隐藏 文件 第 点 行为 禁用 文件夹 隐藏 选项 修改 注册表 使得 隐藏 文件 无法 通过 普通 设置 显示 从而 隐藏 病毒 自身 第 十 一步 在过 滤器 中 查看 spoclsvexe 文件 操作 熊猫 烧香 病毒 创建 文件 包括 在 中 创建 spoclsvexe 磁盘 根目录 创建 setupexe 与 autoruninf 某些 目录 中 创建 desktopini 文件 由于 创建 这些 文件 之后 就 对 注册表 的 showall 项 进行了 设置 使得 隐藏 文件 无法 显示 那么 有理由 相信 所创 建 出来 的 这些 文件 的 属性 都是 隐藏 的 第 点 行为 将 自身 拷贝到 根目录 并 命名为 setupexe 创建 autoruninf 用于 病毒 的 启动 这两个 文件 的 属性 都是 隐藏 同 时会 创建 desktopini 隐藏 文件 第 十 二步 在过 滤器 中 查看 spoclsvexe 网络 行为 从 监控 结果 可以 看到 病毒 会 向 局域网 发送 并 接收 信息 并 不断 尝试 向外 进行 连接 和 发送 数据包 写到 这里 我们 基本 已经 分析 了 熊猫 烧香 的 病毒 行为 但 这些 行为 仍然 无法 彻底 了解 病毒 的 行为 还需要 通过 ollydbg 逆向 分析 和 ida 静态 分析 来 实现 同时 熊猫 烧香 病毒 还有 一些 其他 的 行为 包括 感染 exe 文件 病毒 会 搜索 并 感染 系统 中 特定 目录 外 的 所有 exescrpifcom 文件 并将 exe 执行 文件 的 图标 改为 熊猫 烧香 的 图标 试图 用以 弱 口令 访问 局域网 共享 文件夹 如果 发现 弱 口令 共享 就将 病毒 文件 拷贝到 该 目 录下 并 改 名为 gamesetupexe 以 达到 通过 局域网 传播 的 功能 查找 系统 以 html 和 asp 为 后缀 的 文件 并在 里面 插入 iframe 该 网页 中 包 含在 病毒 程序 一旦 用户 使 用了 未 安装 补丁 的 ie 浏览器 访问 该 网页 就可能 感染 该 病毒 删除 扩展 名为 gho 的 文件 该 文件 是 系统 备份 工具 ghost 的 备份文件 这样 可使 用户 的 系统 备份文件 丢失 六 总结 写到 这里 这篇 文章 就 介绍 完毕 希望 对 您 有所 帮助 最后 进行 简单 的 总 结下 pe 病毒 概念 什么 是 熊猫 烧香 病毒 熊猫 烧香 病毒 行为 分析 样本 运行 及 查杀 防御 procmon 检测 病毒 行为 同时 请 读者 思考 几个问题 病毒感染 了 多少 文件 重装 操作系统 是否 可以 彻底清除 病毒 如何 编写程序 迅速 扫 描出 恶意 样本 需要 实现 的 操作 及 行为 熊猫 烧香 病毒 传播 时 的 图标 问题是 作者 故 意为 之 病毒 在 什么 情况下 需要 进行 图标 替换 图标 替换 过程中 可能会 遇到 哪些 问题 如何 解决 在 无 文件 加载 中 如果 dll 没有 实体 文件 是否 可以 在 内存 中 完成 dll 加载 病毒 运行 一 定要 开启 新 的 进程 吗 如何 编写 感染性 病毒 的 清除 程序 其 与 系统 感染性 病毒 的 清除 方法 有 何 差异 学 安全 一年 认识了 很多 安全 大佬 和 朋友 希望 大家 一起 进步 这篇 文章 中 如果 存在 一些 不足 还请 海涵 作者 作为 网络安全 初学者 的 慢慢 成长 路 吧 希望 未来 能 更 透彻 撰写 相关 文章 同时 非常感谢 参考文献 中 的 安全 大佬 们 的 文章 分享 深知 自己 很菜 得 努力 前行 有点 想 家和 女神 了 月 是 故乡 圆 啊 接着 加油 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 周一 夜 于 武汉 参考文献 姜 晔 老师 真的 非常 佩服 和 值得 去 学习 希望 自己 和 大家 的 技术 能 不断 提升 加油 网络安全 自学 篇 木马 原理 详解 远程 服务器 ipc 漏洞 及 木马 植入 实验 姜 晔 老师 的 技术 空间 目录 csdn 腾讯 安全 联合 实验室 知 乎 文章 网络安全 自学 篇 七十九 windowspe 病毒 原理 分类 及 感染 方式 详解 姜 晔 老师 技术 分享 b 站 网络安全 自学 篇 四十九 procmon 软件 基本 用法 及 文件 进程 注册表 查看 