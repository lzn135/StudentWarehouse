mysql 查询 优化 必备 查询 优化 本就 不是 一蹴而就 的 需要 学会 使用 对应 的 工具 借鉴 别人 的 经验 来 对 sql 进行 优化 并且 提升 自己 文章 目录 前言 一 创建 索引 规范 二 索引 失效 原因 三 sql 优化 杀手锏 之 explain 四 sql 优化 杀手锏 之慢 查询 五 优化 大法 前言 先来 巩固 一下 索引 的 优点 检索 数据 快 查询 稳定 存储 具有 顺序 性 避免 服务器 建立 临时 表 将 随机 的 io 变为 有序 的 io 但 索引 一旦 创建 的 不 规范 就会 造成 以下 问题 占用 额外 空间 浪费 内存 降低 数据 的 增删 改 性能 所以 只有 在 理解 索引 数据结构 的 基础上 才能 创 建出 高效 的 索引 本文 所有 操作 均在 mysql 一 创建 索引 规范 在 学习 索引 优化 之前 需 要对 创建 索引 的 规范 有 一定 的 了解 此 规范 来自于 阿里巴巴 开发 手册 主键 索引 pkcolumncolumn 唯一 索引 ukcolumncolumn 普通 索引 idxcolumncolumn 二 索引 失效 原因 创建 索引 需 知道 在 什么 情况下 索引 会 失效 只有 了解 索引 失效 的 原 因在 创建 索引 时 才 不会 出现 一些 已知 错误 带头 大哥 不能 死 这局 经典 的 语句 就是 涵盖 创建 索引 时 一 定要 符合 最 左侧 原则 例 如表 结构 为 创建 索 引为 查询 条件 必须 带上 uname 这一 列 不在 索引 列上 做 任何 操作 不在 索引 列上 做 任何 计算 函数 自动 或者 手动 的 类型 转换 否 则会 进行 全 表 扫描 简而言之 不 要在 索引 列上 做 任何 操作 俩 边 类型 不等 例如 建 立了 索引 idxusernamename 字段 类型 为 varchar 在 查询 时 使用 wherenamekaka 这样 的 查询 方式 会 直接 造成 索引 失效 正确 的 用法 为 wherenamekaka 不适当 的 like 查询 会 导致 索引 失效 创建 索 引为 idxusername 执行 语句 为 可以 命中 索引 执行 语句 为 可以 使 用到 索引 仅在 以上 版本 执行 语句 为 会 直接 导致 索引 失效 范围 条件 之后 的 索引 会 失效 创建 索 引为 执行 语句 上面 这条 sql 语句 只会 命中 name 和 age 索引 sex 索引 会 失效 复合 索引 失效 需要 查看 keylen 的 长度 即可 总结 在 后边 会 命令 索引 当 使 用了 覆盖 索引 时 任何 查询 方式 都可 命中 索引 以上 就是 咔 咔 关于 索引 失效 会 出现 的 原因 总 结在 很多 文章 中 没有 标注 mysql 版本 所以 你 有 可能会 看到 isnullor 索引 会 失效 的 结论 三 sql 优化 杀手锏 之 explain 在 写完 sql 语句 之后 必须 要做 的 一件 事情 就是 使用 explain 进行 sql 语句 检测 看 是否 命中 索引 下图 就是 使用 explain 输出 格式 接下来 将 会对 输出 格式 进行 简单 的 解释 id 这 列 就是 查询 的 编号 如果 查询 语 句中 没有 子 查询 或者 联合 查询 这个 标识 就 一直是 如 存在 子 查询 或者 联合 查询 这个 编号 会 自 增 selecttype 最常 见 的 类型 就是 simple 和 primary 此列 知道 就行了 table 理解为 表 名 即可 type 此列 是 在 优化 sql 语句 时 最 需要 关注 的 列 之一 此列 显示 了 查询 使 用了 何种 类型 以下 排序 从 最优 到 最差 system 表 内 只有 一行 数据 const 最多 只会 有 一条 记录 匹配 常 用于 主键 或者 唯一 索 引为 条件 查询 eqref 当 连接 使用 的 索引 为 主键 和 唯一 时会 出现 ref 使用 普通 索引 或 ltgt 运算符 进行 比较 将会 出现 fulltext 使用 全文索引 refornull 跟 ref 类型 类似 只是 增加了 null 值 的 判断 实际 用 的 不多 语句 为 为 普通 索引 indexmerge 查询 语句 使 用了 俩 个 以上 的 索引 常见 在 使用 andor 会 出现 官方 文档 将此 类型 放在 refornull 之后 但是在 很多 的 情况下 由于 读取 索引 过多 性能 有 可能 还 不如 用于 where 中 的 in 查询 完全 替换 子 查询 效率 更高 语句 为 valuein indexsubquery 子 查询 中 的 返回 结果 字段 组合 是 一个 索引 或 索引 组合 但 不是 一个 主键 或 唯一 索引 range 索引 范围 查询 常见于 使用 或者 like 等 运算符 的 查询 中 index 索引 全 表 扫描 把 索引 从头到尾 扫 一遍 all 全 表 扫描 性能 最差 possiblekeys 此列 显示 的 可能 会使 用到 的 索引 key 优化 器 从 possiblekeys 中 命中 的 索引 keylen 查询 用到 的 索引 长度 字节数 keylen 只 计算 where 条件 用到 的 索引 长度 而 排序 和 分组 就算 用 到了 索引 也 不会 计 算到 keylen 中 ref 如果是 使用 的 常数 等值 查询 这里会 显示 const 如果是 连接 查询 被 驱动 表 的 执行计划 这里会 显示 驱动 表 的 关联 字段 如果是 条件 使 用了 表达式 或者 函数 或者 条件 列 发 生了 内部 隐 式 转换 这里 可能 显示 为 funcrows 这是 mysql 估算 的 需要 扫描 的 行数 不是 精确 值 这个 值 非常 直观 显示 sql 的 效率 好坏 原则上 rows 越少 越好 filtered 此列 表示 存储 引擎 返回 的 数据 在 server 层 过滤 后 剩下 多少 满足 查询 的 记录 数量 的 比例 注意 是 百分比 不是 具体 记录 数 extra 在 大多数 情况下 会出 现 以下 几种 情况 usingindex 使 用了 覆盖 索引 查询 列 都为 索引 字段 usingwhere 使 用了 where 语句 usingtemporary 查询 结果 进行 排序 的 时候 使 用了 一张 临时 表 usingfilesort 对 数据 使用 一个 外部 的 索引 排序 使 用了 索引 下推 关于 索引 下推 可以 查看 咔 咔 之前 文章 mysql 索引 一文 总结 以上 就是 关于 explain 所有 列 的 说明 在 平时 开发 的 过程中 一般 只会 关注 这 四列 type 优化 目标 至少 达到 range 级别 要 求是 ref 级别 如果 可以 consts 最好 key 是 查询 使 用到 的 索引 如果 此 列为 空 要么 未 建立 索引 要么 索引 失效 rows 是 这条 sql 语句 扫描 的 行数 越少 越好 extra 此 列为 扩展 列 如果 出现 临时 表 文件 排序 则 需要 优化 四 sql 优化 杀手锏 之慢 查询 上文 说 到了 可以 直接 使用 explain 来 分析 自己 的 sql 语句 是否 合理 接下来 再聊 一个 点 那就是 慢 查询 查看 慢 查询 是否 打开 查看 是否 记录 没有 使用 索引 的 sql 语句 开启 慢 查询 开启 记录 没有 使 用到 索引 的 sql 语句 查询 以上 俩 个 配置 是否 打开 设置 慢 查询 时间 这个 时间 由 自己 把 控 一般 s 即可 如果 查看 这个 时间 没有 变 则 关于 客户端 在 重新 连接 一次 即可 查看 慢 查询 存储 位置 然后 随便 执行 一条 不 执行 索引 的 语句 即可 在 这个 日志 中 查看 到此 语句 上图 中 一般 需要 主要 观察 的 是 querytimesql 语句 内容 以上 就是 关于 如何 使用 慢 查询 来 查看 项目 中 出现问题 的 sql 语句 五 优化 大法 此处 跟 大家 聊 一些 常用 的 sql 语句 优化 方案 以上 的 俩 个 工具 要 好好 的 利用 辅助 我们 进行 打怪 禁止 使用 select 需要 什么 字段 查询 什么 字段 where 字段 设置 索引 groupbyorderby 字段 设置 索引 舍弃 offsetlimit 分页 使用 延迟 关联 来 实现 分页 数据量 不大 时 可 不用 写 分页 时 当 count 为时 直接 返回 避免 执行 分页 语句 利用 覆盖 索引 进行 查询 避免 回 表 建立 复合 索引 时区 分度 最高 的 放在 最 左侧 统计数据 行数 只用 count 别 整 的 花里胡哨 的 关于 in 和 exist 如果 查询 的 俩 个 表 大小 一致 则 性能 差别 可 忽略 如 果子 查询 表 大用 exist 否则 使用 in 查询 一行 数据 时 加上 limit 选择 合理 的 数据类型 在 满足 条件下 数据类型 越小 越好 联合 查询 join 最多 三个 表 并且 需要 join 的 字段 数据类型 保持一致 in 操作 能 避免 尽量 避免 无法 避免 的 情况下 in 元素 控制在 以内 数据 更新 频繁 区 分度 不高 的 列 不适合 建立 索引 explain 中 的 type 至少 要 达到 range 要求 为 ref 联合 索引 满足 最 左侧 原则 坚持 学习 坚持 写 博 坚持 分享 是 咔 咔 从业 以来 一直 所 秉持 的 信念 希望 在 偌大 互联网 中 咔 咔 的 文章 能带 给你 一丝丝 帮助 我 是 咔 咔 下期 见 