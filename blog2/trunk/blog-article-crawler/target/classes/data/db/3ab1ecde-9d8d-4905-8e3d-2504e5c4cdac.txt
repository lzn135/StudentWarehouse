令牌 桶 漏斗 冷启动 限 流在 sentinel 的 应用 分布式 系统 为了 保证 系统 稳定性 在 服务 治理 的 限流 中会 根据 不同 场景 进行 限流 操作 常见 的 限流 算法 有 令牌 桶 可容忍 一定 突发 流量 的 速率 的 限流 令牌 桶 算法 的 原理 是 系统 以 恒定 的 速率 产生 令牌 然后 把 令牌 放到 令牌 桶 中 令牌 桶 有 一个 容量 当 令牌 桶 满了 的 时候 再向 其 中放 令牌 那么 多余 的 令牌 会被 丢弃 当 想要 处理 一个 请求 的 时候 需 要从 令牌 桶 中 取出 一个 令牌 如果 此时 令牌 桶 中 没有 令牌 那么 则 拒绝 该 请求 漏斗 固定 速率 限流 可以 启动 整流 作 用在 分析 sentinel 限流 之前 我们 先 看下 sentinel 是什么 官 网 说明 如下 随着 微 服务 的 流行 服务 和 服务 之间 的 稳定性 变得 越来越重要 sentinel 是 面向 分布式 服务 架构 的 流量 控制 组件 主 要以 流量 为 切入点 从 流量 控制 熔断 降级 系统 自适应 保护 等 多个 维度 来 帮 助您 保障 微 服务 的 稳定性 从 限流 角度 来看 sentinel 的 限流 有种 控制 维度 一个是 qps 一个是 并发 数 qps 这个 很好 理解 也 就是 每秒 处理 请求 量 当 超过 设定 阈值 时会 进行 流 控 策略 有 如下 几种 拒绝 排队 一定 时长 等 并发 数 这个 就是 当前 线程 运 行数 类似于 hystrix 只不过 sentinel 是 进行 线程 个数 统计 判断 是否 达到 线程 设定值 而 hystrix 是 根据 不同 线程 池 来 做的 sentinel 中 处理 流程 是 一个 责任 链 不同 功能 的 逻辑 抽象 成 不同 的 processorslot 组合 在一起 比如 有 限流 的 flowslot 打 日志 的 logsot 数据 统计 的 statisticslot 下面 重点 看 限流 的 throwsthrowable 是否 触发 限流 检查 checkflow 继续 往下 一个 节点 走 fireentry resourcegetname for 多个 限流 规则 检查 if canpasscheck rulegetlimitapp rule canpass canpass 校验 目前 有 以下 几种 实现 类 这 几个 实现 类 分别 使用 了 如下 几种 限流 算法 令牌 桶 漏斗 冷启动 的 令牌 桶 冷启动 的 漏斗 sentinel 中 统计 信息 比如 qpspassblock 等 信息 都是 在 滑动 时间 窗 口中 维护 的 比如 时间 戳 是 时 统计 信息 会 往 对应 的 时间 窗口 更新 当 时间 戳 是 时 由于 时间 窗口 只有 个 每个 ms 因此会 复用 第一个 时间 窗口 在 使用 前 会 先 进行 初始化 该 窗口 统计 值 对于 默认 的 流 控 实现 其 是 根据 时间 窗口 的 统计 值 是否 达 到了 限流 值 来 决定 是否 限流 的 这 也是 把 它 归 为 令牌 桶 算法 的 原因 漏斗 算法 实现 会 记 录上 一次 正常 通过 的 时间 戳 信息 当 判断 是否 限流 时会 根据 当前 时间 是否 大于 间隔 值 大于 的话 表示 可以 正常 通过 小于 的话 表示 刚刚 已经有 流程 正常 通过 此次 需要 排队 等待 等待时间 为 期望 时间 戳 当前 时间 戳 并发 场景 下 多个 线程 可能 都会 走到 等待 这里 因此 需要 cas 操作 判断 当前 需 等待时间 是否 大于 某个 值 大于 的话 直接进行 限流 不再 排队 等待 冷启动 限流 算法 即 预热 冷启动 方式 当 系统 长期 处于 低 水位 的 情况下 当 流量 突然 增加 时 直接 把 系统 拉 升到 高 水位 可能 瞬间 把 系统 压垮 通过 冷启动 让 通过 的 流量 缓慢 增 加在 一定 时间内 逐渐 增加到 阈值 上限 给 冷 系统 一个 预热 的 时间 避免 冷 系统 被 压垮 sentinel 中 通常 冷启动 的 过程 系统 允许 通过 的 qps 曲线 如 下图 所示 冷启动 的 两种 模式 令牌 桶 和 漏斗 大同小异 只不过 在 流量 较大 时 冷启动 过程 令牌 桶 走势 类似于 阶梯 向上 直到 设定 的 限流 值 漏洞 走势 类似于 几个 斜线 向上 之道 设定 的 限流 值 关于 sentinel 更多 的 知识 可 参考 官方 文档 推荐 阅读 常见 限流 方案设计 与 实现 sentineldubbo 适配 机制 sentinel 集群 流 控 原理 sentinel 滑动 窗口 统计 机制 sentinel 核心 概念 