innodb 表 聚集 索引 层高 什么时候 发生变化 导读 本文 略长 主要 解决 以下 几个 疑问 聚集 索引 里 都 存储 了 什么 宝贝 什么时候 索引 层高 会 发生变化 预留 的 空闲 空间 做 什么用 的 记录 被 删除 后 的 空间 能 回收 重复 利用 吗 背景 信息 关于 有 个 选项 用于 定义 innodbpage 的 填充 率 默认值 是 但 其实 最高 只能 填充 约 kb 的 数据 因为 innodb 会 预留 的 空闲 空间 在 innodb 文档 中有 这么 一段话 另外 文档 中 还有 这样 一段话 上面 这 两 段话 综合 起来 理解 就是 即便 也 会 预留 的 空闲 空间 用于 现存 记录 长度 扩展 用在 最佳 的 顺序 写入 数据 模式 下 page 填充 率 有 可能 可以 达到 在 随机 写入 新 数据 模式 下 page 填充 率 约为 预留 这个 规则 只 针对 聚集 索引 的 叶子 节点 有效 对于 聚集 索引 的 非 叶子 节点 以及 辅助 索引 叶子 及 非 叶子 节点 都没有 这个 规则 不过 选项 对 叶子 节点 及 非 叶子 节点 都 有效 但对 存储 textblob 溢 出列 的 page 无效 关于 innodbruby 项目 innodbruby 项目 是 由 jeremycole 和 daviarnaut 两位 大神 开发 的 项目 可 用于 解析 innodb 数据结构 用 ruby 开发 而成 他们 还 维护 了 另一个 众所周知 的 项目 叫 innodbdiagrams 相信 稍微 资深 一点 的 mysqldba 都应该 知道 这个 项目 关于 innblock 工具 由 八 怪 开发 用于 扫描 和 分析 innodbpage 详见 观察 利器 阅读 本文 背景 信息 需要 假设 您对 innodb 的 数据结构 已经有 了 一定 了解 包括 b 树 聚集 索引 辅助 索引 以及 innodbpage 的 一些 简单 结构 测试 验证 一 层高 的 innodb 表 聚集 索引 最 多能 存 多少 条 数据 从 上面 我们 知道 一个 page 最 大约 能 存储容量 扣掉 用于 存储 信息 以及 两条 虚拟 记录 等 必要 的 固定 消耗 之后 实际 大约 只有 字节 可 用于 存储 用户 数据 这样一来 我们 就可以 简单 测 算出 一个 page 大约 能 存储 多少 条 记 录了 本次 用到 的 测 试表 只有 一个 int 列 同时 作为 主键 建议 横版 观看 可 左右 滑动 或者 复制 链 接到 pc 端 打开 观看 效果 更佳 下同 mysql 的 版 本是 perconaserver 我 自己 下载 源码 编译 的 创建 测 试表 iint i 另外 我们 知道 每条 记录 都要 几个 额外 存储 的 数据 dbtrxid 字节 dbrollptr 字节 recordheader 至少 字节 用 上面 这个 测 试表 只需要 字节 不同 数据类型 需要 的 header 长度 也 不同 详见 浅析 及 pageoverflow 因此 一条 数据 需要 消耗 int 列 字节 此外 大约 每条 记录 就需要 一个 directoryslot 每个 slot 需要 字节 综上 假设 可以 存储 n 条 记录 则 nn 可 求得 n 约等于 接下来 我们 验证 一下 往 该 表 中 持续 插入 条 数据 逐次 反复 执行 次 然后 我们 利用 innodbruby 工具 查看 其 数据结构 查看 聚集 索引 page 结构 此时 t 表 的 聚集 索引 树 只有 一 层高 一个 page 即 再用 innblock 工具 扫描 佐证 一下 blocknolevel 查看 其 directoryslot 可以 看到 个 slot 其中 infimum 记录 的 ownedsupremum 记录 的 查看 整个 page 的 全 览 图 前面 是 一堆 头 信息 大概 从 这里 开始 是 第一条 记录 中间 是 用户 数据 这里是 预留 的 空闲 空间 这里是 逆序 存储 trailer 占用 字节 此后 每个 slot 占用 字节 共 个 slot 最后 是 统计 汇总 信息 legend byte 可以 得到 几点 信息 recorddata 共 占用 字节 共 条 记录 每条 记录 字节 pagedirectory 共 字节 个 slot 每个 slot 占用 字节 两条 虚拟 记录 均占 用 字节 含 字节 的 共 字节 共 条 记录 每条 记录 需要 字节 头 信息 再次 提醒 表里 字段 类型 各异 recordheader 也 会 随之 不同 仅在 本例 中 只需要 字节 详见 浅析 及 pageoverflow 提醒 本次 测试 是 顺序 写入 如果是 随机 写入 或 批量 写入 可能 就 没办法 把 的 page 空间 填充 的 满满当当 了 什么时候 发生 b 树 分裂 如果 我们 再 插入 一条 记录 就会 发现 t 表 原本 只有 一 层高 的 b 树 会分 裂成 两层 高度 再次 查看 数据结构 注意到 此时 leaf 节点 的 page 数 为 也 就是 分 裂成 两 层高 度了 用 innblock 工具 扫描 佐证 确认 此时 发生 分 裂了 由 一层 高度 分 裂成 两层 根 节点 levelpageno 叶子 节点 level 分别为 pageno 理论 推演 当 innodb 表 聚集 索引 达到 三 层高 时 大概 可以 存储 几条 记录 分析 根 节点 page 上述 测 试表 此时 是 一个 两 层高 的 聚集 索引 分 别是 根 节点 levelpageno 叶子 节点 levelpageno 此时 根 节点 里 只有 两条 记录 分别 指向 两个 叶子 节点 i record i 再 查看 根 节点 详细 数据 条 系统 记录 即 infim mumsupremum 这两条 虚拟 记录 物理 记录 是 聚集 索引 的 这条 记录 该 表 第一条 记录 我 此前 把 i 记录 给 删了 指针 指向 叶子 节点 pageno 该 记录 消耗 字节 含 字节 的 指针 这条 记录 指针 指向 叶子 节点 pageno 该 记录 消耗 字节 含 字节 的 指针 查看 根 节点 整个 page 的 全 览 图 byte 可以 得到 几点 结论 根 节点 里 共有 两条 记录 每条 记录 占用 字节 由于 整型 只需要 字节 因此 我们 可 推断出 指向 叶子 节点 的 指针 需要 占用 字节 每条 记录 同样 需要 字节 的 recordheader 不同 聚集 索引 列 数据类型 需要 的 recordheader 也 不一样 减去 必要 的 等 头 信息 后 非 叶子 节点 可用 空间 约 字节 综上 假设 非 叶子 节点 可以 存储 n 条 记录 则 nn 可 求得 n 约等于 既然 每个 非 叶子 节点 可 存储 条 记录 每个 叶子 节点 可 存储 条 记录 则 一个 三层 高度 的 innodb 表 聚集 索引 可以 存储 也 就是 约 亿条 记录 所以说 如果 表 足够 窄 的话 一个 三 层高 的 表 足够 存储 上亿 条 数据 其 平均 搜索 效率 并 不差 常规 的 存取 效率 也 不会 太差 当然 了如 果 因为 索引 使用不当 导致 检索 效率 低下 或者 频繁 发生 锁 等待 那要 另当别论 补充 测试 在 两层 高度 时 根 节点 最多 可以 存储 几条 记录 我们 对上 面的 t 表 持续 写入 数据 验证 在 两层 高度 时 根 节点 最多 可以 存储 几条 记录 我们 继续 使用 上面 的 测 试表 经 验证 在 两层 高度 时 根 节点 可以 存储 条 记录 整个 表 最 多条 记录 查看 总 记录 数 fromtcount 查看 聚集 索引 层级 存储 万条 数据 数据表 空间 文件 大小 为 mb 换 算下 如果是 层 高度 的 表 存 满 表 空间 文件 大小 约 查看 根 节点 page 数据 结构图 byte 固定 长度 的 头 信息 部分 我 都给 去 掉了 下同 最后 只 剩 字节 空闲 而 不像 叶子 节点 那样 有 空闲 空间 再 再次 提醒 这都是 基于 只有 一个 int 列 并作 为 主键 的 测试 结果 如果是 其他 主键 类型 或者 不是 顺序 追加 写入 的 模式 则 结论 可能 就不是 这个 了 疑问 innodbpage 预留 的 空闲 空间 做 什么用 的 测试 到 上面 时 我们 可能 会个 疑问 什么 情况下 能把 预留 的 那 部分 空闲 空间 给 用上 呢 我们 再 回顾 下 前面 的 文档 说明 凭直觉 我 认为是 用于 需要 增长 读 chng 扩充 方式 更新 某 条 记录 时 所需 而 不是 用于 写入 新 记录 例如 c 列 定义 为 varchar 第一次 存储 时 只 写了 个字 节 后来 做了 一次 更新 把 它从 个 字节 增长到 个 字节 称为 增长 更新 像 下面 这样 c 列 原值 是 我们 创建 一个 新 的 测 试表 t 这次 增加 一个 可 变长 字符 串列 ccreatetablet iint i engineinnodb 计算 一条 记录 大概 需要 多少 字节 dbtrxid 字节 dbrollptr 字节 recordheader 字节 基础 是 字节 外加 有 个 变 长列 还需要 个 字节 共 字节 因此 一条 数据 需要 消耗 int 列 varchar 但 目前 只 存 了 个字符 字节 此外 大约 每条 记录 就需要 一个 directoryslot 每个 slot 需要 字节 综上 假设 可以 存储 n 条 记录 则 nn 可 求得 n 约等于 插入 条 记录 后 查看 page 数据 结构图 byte 用 innblock 工具 佐证 一下 blocknolevel 确认 当前 只有 一层 高度 还没 分 裂成 两层 进行 一次 增长 更新 一条 记录 后 看 能不 能把 预留 的 空间 给 利用 起来 而 不是 分裂 出 一个 新 sec 确认 还是 只有 一层 高度 树 没有 分裂 blocknolevel 再查 看下 page 数据 结构图 byte 从 上面 这个 结果 可以 看到 几点 看到 garbage 是 字节 也 就是 i 的 那条 旧 数据 长度 不够 存储 新 记录 需要 新 写入 并 删除 旧 记录 看到 recorddata 增加了 字节 因为 我们 对 i 那条 记录 的 c 列增 加了 字节 看到 free 少了 字节 那是 因为 增长 更新 后 的 i 记录 总长度 是 字节 它 需 要从 free 里 分配 新 空间 来 存储 因此 我们 确认 聚集 索引 没有 分裂 而是 优 先把 free 空间 给 利用 起 来了 疑问 garbage 空间 可以 被 重用 吗 先回 答 问题 garbage 空间 是 可以 被 重用 的 在 我们 做 逐次 增长 更新 了 条 记录 后 这时 发现 garbage 比 较大 但 free 已经 几乎 用 完了 也 就是在 这时 如果 按照 常理 再做 一次 增长 更新 就会 造成 当前 的 page 存储 不下 会 进行 分裂 但 事实上 真是 如此 吗 在 继续 做 一次 增长 更新 后 我们 发现 实际上 此时 会把 garbage 的 空间 给 重整 了然 后 继续 利用 起来 而 不是 立即 进行 分裂 已 有条 记录 被 增长 更新 了 rowinset sec 继续 增长 更新 sec 确认 更新 成功 查看 数据结构 此时 发现 garbage 为 而 free 值 增大 了 明显 是 把 garbage 的 空间 给 重整 后 再次 利 用了 很好 我们 可以 再次 得到 几条 结论 一条 记录 被 增长 更新 后 旧 记录 会被 放到 garbage 队列 中 除非 此时 插入 新 记录 的 长度 小于 等于 旧 记录 的 长度 否则 该 记录 总是 不 会被 重用 起来 也 可 参考 这篇 文章 观察 利器 当空 闲 空间 全部 用完 后 若 此时 garbage 队列 不为 的话 则 会对 其 进行 重整 后 变成 可用 空间 再次 被 分配 如果是 缩短 的 更新 方式 缩减 的 空间 并不会 进入 garbage 队列 而是 被 标 记为 碎片 空间 这种 无法 被 重用 除非 全 表 重建 garbage 空间 延伸 测试 更新 数据 的 数据 后面 有 其他 数据 再 来看 个 更为 神奇 的 案例 这次 更新 的 记 录在 它 后面 有 其他 记录 阻碍 它 插入 两条 记录 观察 数据结构 只 保留 几个 有用 信息 对 第一条 记录 先 做 一次 增长 更新 观察 数据结构 只 保留 几个 有用 信息 再做 一次 缩短 更新 观察 数据结构 只 保留 几个 有用 信息 又 做 一次 增长 更新 观察 数据结构 只 保留 几个 有用 信息 最后 发现 garbage 队列 中有 两条 记录 也 就是 两次 增长 更 新都 导致 旧 记录 被 删除 无法 被 重用 即便 第二次 是 缩短 更新 后 产 生了 剩余 碎片 然后 再次 被 增长 更新 也 无法 原地 更新 需要 新 写入 一条 记录 garbage 空间 延伸 测试 更新 数据 的 数据 后面 没有 其他 数据 再 做个 下面 的 测试 案例 这次 表里 只有 一条 记 录在 它 后面 没有 其他 记录 阻碍 它 那么 在后 面的 更新 中都 可以 原地 更新 即便是 增长 更 新旧 记录 也 不需要 先 被 删除 后 新 写 一条 记录 只 插入 一条 记录 观察 数据结构 只 保留 几个 有用 信息 先 做 一次 增长 更新 观察 数据结构 再做 一次 缩短 更新 缩 短了 两个 字节 观察 数据结构 又 做 一次 增长 更新 观察 数据结构 和 第一次 被 增长 更新 后 一样 了 要点 总结 innodb 聚集 索引 由 非 叶子 节点 nonleafpage 和 叶子 节点 leafpage 组成 在 叶子 节 点中 需要 存储 整行 数据 除了 overflow 的 部 分列 因此 可 存储 的 记录 数 一般 更 少些 在 nonleafpage 中 只需要 存储 聚集 索引 列 主键 键值 因此 可 存储 的 记录 数 一般 更 多些 对 变 长列 尽量 比如 从 业务 上 想办法 不要 反复 变长 无论是 增长 还是 缩短 更新 innodbruby 不错 不过 解析 及 以上 版本 可能 有些 地方 会 不 准确 可以用 innblock 工具 辅助 配合 我 不是 源码 级 mysql 内核 开发者 水平 有限 文中 难免 有误 之处 还请 多 指教 enjoymysql 延伸 阅读 观察 利器 浅析 及 pageoverflow 最后 欢迎 扫 码 订阅 乱弹 mysql 专栏 快人 一步 获取 我 最新 的 mysql 技术 分享 