不得 不知 的 mysql 索引 和 查询 优化 阅读 文本 大概 需要 分钟 本文 主要 总 结了 工作中 一些 常用 的 操作 及 不合理 的 操作 在对 慢 查询 进行 优 化时 收集 的 一些 有用 的 资料 和 信息 本文 适合 有 mysql 基础 的 开发人员 索引 相关 索引 基数 基数 是 数据 列 所 包含 的 不同 值 的 数量 例如 某个 数据 列 包含 值 那么 它 的 基数 就是 索引 的 基数 相对于 数据表 行数 较高 也就是说 列 中 包含 很多 不同 的 值 重复 的 值 很少 的 时候 它 的 工作 效果 最好 如果 某 数据 列 含有 很多 不同 的 年龄 索引 会 很 快地 分辨 数据 行 如果 某个 数据 列 用于 记录 性别 只有 m 和 f 两种 值 那么 索引 的 用处 就 不大 如果 值 出现 的 几率 几乎 相等 那么 无论 搜索 哪个 值 都 可能 得到 一半 的 数据 行在 这些 情况下 最好 根本 不要 使用 索引 因为 查询 优化 器 发现 某个 值 出现在 表 的 数据 行 中 的 百分比 很高 的 时候 它 一般 会 忽略 索引 进行 全 表 扫描 惯用 的 百分比 界线 是 索引 失效 原因 索引 失效 的 原因 有 如下 几点 对 索引 列 运算 运算 包括 ltgtlike 放在 前面 类型 错误 如 字段 类型 为 varcharwhere 条件 用 number 对 索引 应用 内部 函数 这种 情况下 应 该要 建立 基于 函数 的 索引 例如 tlogicdbid 此时 应 该建 round tlogicdbid 为 索引 mysql 开始 支持 函数 索引 可以 通过 虚拟 列 的 方式 来 支持 之前 只能 新建 一个 round tlogicdbid 列 然 后去 维护 如果 条件 有 or 即使 其中 有条件 带 索引 也 不会 使用 这 也是 为什么 建议 少 使用 or 的 原因 如果 想 使用 or 又想 索引 有效 只 能将 or 条件 中 的 每个 列 加上 索引 如果 列 类型 是 字符串 那一 定 要在 条件 中 数据 使用 引号 否则 不 使用 索引 btree 索引 isnull 不会 走 isnotnull 会 走 位图 索引 isnullisnotnull 都会 走 组合 索引 遵循 最左 原则 索引 的 建立 索引 的 建立 需要 注意 以下几点 最 重要 的 肯定是 根据 业务 经常 查询 的 语句 尽量 选择 区 分度 高 的 列 作为 索引 区 分度 的 公式 是 count distinctcol count 表示 字段 不 重复 的 比率 比率 越大 我们 扫描 的 记录 数 就 越少 如果 业务 中 唯一 特性 最好 建立 唯 一键 一方面 可以 保证 数据 的 正确性 另一方面 索引 的 效率 能 大大提高 explian 中 有用 的 信息 基本 用法 explian 基本 用法 如下 desc 或者 explain 加上 你 的 加上 你 的 sql 然后 通过 showwarnings 可以 查看 实际 执行 的 语句 这一点 也是 非常 有用 的 很多 时候 不同 的 写 法经 sql 分析 后 实际 执行 的 代码 是 一样 的 提高 性能 的 特性 explian 提高 性能 的 特性 如下 索引 覆盖 coveringindex 需要 查询 的 数据 在 索 引上 都可以 查到 不需 要回 表 extra 列 显示 usingindexicp 特性 本来 index 仅仅是 dataaccess 的 一种 访问 模式 存 数 引擎 通过 索引 回 表 获取 的 数据 会 传递 到 mysqlserver 层 进行 where 条件 过滤 版本 开始 当 icp 打开 时 如果 部分 where 条件 能 使用 索引 的 字段 mysqlserver 会把 这 部分 下 推到 引擎 层 可以 利用 index 过滤 的 where 条件 在 存储 引擎 层 进行 数据 过滤 extra 显示 需要 了解 mysql 的 架构图 分为 server 和 存储 引擎 层 索引 合并 indexmerge 对 多个 索引 分别 进行 条件 扫描 然后 将 它们 各自 的 结果 进行 合并 intersectunion 一般 用 or 会 用到 如果是 and 条件 考虑 建立 复合 索引 explain 显示 的 索引 类型 会 显示 indexmergeextra 会 显示 具体 的 合并 算法 和 用到 的 索引 extra 字段 extra 字段 使用 usingfilesort 说明 mysql 会对 数据 使用 一个 外部 的 索引 排序 而 不是 按 照表 内 的 索引 顺序 进行 读取 mysql 中 无法 利用 索引 完成 的 排序 操作 称为 文件 排序 其实 不一 定是 文件 排序 内部 使用 的 是 快 排 usingtemporary 使 用了 临时 表 保存 中间 结果 mysql 在对 查询 结果 排 序时 使用 临时 表 常见于 排序 orderby 和 分组 查询 表示 相应 的 select 操作 中使 用了 覆盖 索引 coveringindex 避免 访 问了 表 的 数据 行 效率 不错 子句 的 值 总是 false 不能 用来 获取 任何 元组 在 没有 groupby 子句 的 情况下 基于 索引 优化 minmax 操作 或者 对于 myisam 存储 引擎 优化 count 操作 不必 等到 执行 阶段 再 进行 计算 查询 执行计划 生成 的 阶段 即 完成 优化 distinct 优化 distinct 操作 在 找到 第一 匹配 的 元组 后 即 停止 找 同样 值 的 操作 这两项 出 现时 需要 注 意下 这两项 是 十分 耗费 性能 的 在 使用 groupby 的 时候 虽然 没有 使用 orderby 如果 没有 索引 是 可能 同时 出现 的 因为 groupby 就是 先 排序 在 分组 如果 没有 排序 的 需要 可以 加上 一个 orderbynull 来 避免 排序 这样 usingfilesort 就会 去除 能 提升 一点 性能 type 字段 type 字段 使用 system 表 只有 一行 记录 等于 系统 表 这是 const 类型 的 特例 平时 不会 出现 const 如果 通过 索引 依次 就 找 到了 const 用于 比较 主键 索引 或者 unique 索引 因为 只能 匹配 一行 数据 所以 很快 如果 将 主键 置于 where 列表 中 mysql 就能 将该 查询 转 换为 一个 常量 eqref 唯一性 索引 扫描 对于 每个 索引 键 表 中 只有 一条 记录 与 之 匹配 常见于 主键 或 唯一 索引 扫描 ref 非 唯一性 索引 扫描 返回 匹配 某个 单独 值 的 所有 行 本质上 也是 一种 索引 访问 它 返回 所有 匹配 某个 单独 值 的 行 然而 它 可能会 找到 多个 符合 条件 的 行 所以 它 应该 属于 查找 和 扫描 的 混合体 range 只 检索 给定 范围 的 行 使用 一个 索 引来 选择 行 key 列 显示 使 用了 哪个 索引 一般 就是 在你 的 where 语句 中 出现 betweenltgtin 等 的 查询 这种 范围 扫描 索引 比 全 表 扫描 要好 因为 只需要 开始于 缩印 的 某一 点 而 结束 于 另一 点 不用 扫描 全部 索引 与 all 的 区 别为 index 类型 只 遍历 索引 树 这 通常 比 all 快 因为 索引 文件 通常 比 数据文件 小 也就是说 虽然 all 和 index 都是 读 全 表 但 index 是 从 索引 中 读取 的 而 all 是 从 硬盘 读取 的 遍历 全 表 获得 匹配 的 行 字段 类型 和 编码 mysql 返回 字符串 长度 characterlength 同 charlength 方法 返回 的 是 字符 数 length 函数 返回 的 是 字节数 一个 汉字 三个 字节 varchar 等 字段 建立 索引 长度 计算 语句 selectcount distinctleft test count fromtable 越 趋近 越好 mysql 的 utfmysql 的 utf 最大 是 个 字节 不支持 emoji 表情符号 必须 只用 utfmb 需 要在 mysql 配置文件 中 配置 客户端 字符集 为 utfmbjdbc 的 连接 串 不支持 配置 最好 的 办法 是 在 连接 池中 指定 初始化 sql 例如 hikari 连接池 其他 连接池 类似 否则 需要 每次 执行 sql 前 都 先 执行 排序 规则 一般 使用 bin 和 不 区分 大小写 ci 为 caseinsensitive 的 缩写 即 大小写 不 敏感 utfgeneralcs 区分 大小写 cs 为 casesensitive 的 缩写 即 大小写 敏感 但是 目前 mysql 版本 中 已经 不支持 类似于 generacs 的 排序 规则 直接 使用 utfbin 替代 utfbin 将 字符串 中 的 每一个 字符 用 二进制 数据 存储 区分 大小写 那么 同样是 区分 大小写 utfgeneralcs 和 utfbin 有 什么区别 cs 为 casesensitive 的 缩写 即 大小写 敏感 bin 的 意思 是 二进制 也 就是 二进制 编码 比较 utfgeneralcs 排序 规则 下 即便是 区 分了 大小写 但是 某些 西欧 的 字符 和 拉丁 字符 是 不 区分 的 比如 a 但是 有时 并不需要 a 所以 才有 utfbinutfbin 的 特点 在于 使用 字符 的 二进制 的 编码 进行 运算 任何 不同 的 二进制 编码 都是 不同 的 因此在 utfbin 排序 规则 下 ltgta 初始化 命令 sqlyog 中 初始 连接 指定 编码 类型 使用 连接 配置 的 初始化 命令 如 下图 sql 语句 总结 常用 但 容易 忘 的 sql 语句 常用 但 容易 忘 的 总结 如下 如果有 主键 或者 唯 一键 冲突 则不 插入 如果有 主键 或者 唯 一键 冲突 则 更新 注意 这个 会 影响 自 增 的 增量 value sdf 如果有 就用 新 的 替代 values 如果 不 包含 自 增列 自 增列 的 值 会 变化 value sdf 备份 表 复 制表 结构 从 查询 语句 中 导入 或者 insertintouserv idnum 连 表 更新 连 表 删除 锁 相关 锁 相关 作为 了解 很 少用 共享 锁 排 它 锁 优 化时 用到 优 化时 用到 强制 使用 某个 索引 idxuser limit 禁止 使用 某个 索引 idxuser limit 禁用 缓存 在 测试 时 去除 缓存 的 影响 查看 状态 查看 状态 查看 字符集 查看 排序 规则 编写 注意 sql 编写 请注意 where 语句 的 解析 顺序 是 从右到左 条件 尽量 放 where 不要 放 having 采用 延迟 关联 deferredjoin 技术 优化 超 多 分页 场景 比如 limit 延迟 关联 可以 避免 回 表 distinct 语句 非常 损耗 性能 可以 通过 groupby 来 优化 连 表 尽量 不要 超过 三个 表 踩 坑 踩 坑 总结 如下 如果有 自 增列 truncate 语句 会把 自 增列 的 基数 重置 为 有些 场景 用 自 增列 作为 业务 上 的 id 需要 十分重视 聚合 函数 会 自动 滤 空 比如 a 列 的 类型 是 int 且 全部是 null 则 sum a 返回 的 是 null 而 不是 mysql 判断 null 相等 不 能用 anull 这个 结果 永 远为 unknownwhere 和 having 中 unknown 永远 被 视为 falsecheck 约束 中 unknown 就会 视为 true 来 处理 所以 要用 aisnull 处理 千万 大 表 在线 修改 mysql 在 表 数据量 很大 的 时候 如果 修改 表 结构 会 导致 锁 表 业务 请求 被 阻塞 mysql 在 之后 引 入了 在线 更新 但是在 某些 情况下 还是 会 锁 表 所以 一般 都 采用 pt 工具 perconatoolkit 如 对表 添加 索引 慢 查询 日志 有时候 如果 线上 请求 超时 应 该去 关注 下 慢 查询 日志 慢 查询 的 分析 很简单 先 找到 慢 查询 日志 文件 的 位置 然后 利用 mysqldumpslow 去 分析 查询 慢 查询 日志 信息 可以 直接 通过 执行 sql 命令 查看 相关 变量 常用 的 sql 如下 mysqldumpslow 的 工具 十分 简单 我 主要 用到 的 参数 如下 t 限制 输出 的 行数 我 一般 取 前 十条 就 够了 s 根据 什么 来 排序 默认 是 平均 查询 时间 at 我 还 经常 用到 c 查询 次数 因为 查询 次数 很 频繁 但是 时间 不高 也是 有 必要 优化 的 还有 t 查询 时间 查看 那个 语句 特别 卡 v 输出 详细信息 例子 查看 sql 进程 和 杀死 进程 如果 你 执 行了 一个 sql 的 操作 但是 迟迟 没有 返回 你 可以 通过 查询 进程 列表 看看 它 的 实际 执行 状况 如果 该 sql 十分 耗时 为了 避免 影响 线上 可以用 kill 命令 杀死 进程 通过 查看 进程 列表 也 能 直观 的 看下 当前 sql 的 执行 状态 如果 当前 数据库 负载 很高 在 进程 列表 可能会 出现 大量 的 进程 夯 住 执行时间 很长 命令 如下 查看 进程 列表 showprocesslist 杀死 某个 进程 kill 如果 你 使用 的 sqlyog 那么 也有 图形化 的 页面 在 菜单栏 工具 显示 进程 列表 在 进程 列表 页面 可以 右键 杀死 进程 如下 所示 一些 数据库 性能 的 思考 在对 公司 慢 查询 日志 做 优化 的 时候 很多 时候 可能是 忘了 建 索引 像 这种 问题 很 容易 解决 加个 索引 就行了 但是有 几种 情况 就不是 简单 加 索引 能 解决 了 业务 代码 循环 读 数据库 考虑 这样 一个 场景 获取 用户 粉丝 列表 信息 加入 分页 是 十个 其 实像 这样 的 sql 是 十分 简单 的 通过 连 表 查询 性能 也 很高 但是 有时候 很多 开发 采 用了 取出 一串 id 然后 循环 读 每个 id 的 信息 这样 如果 id 很多 对 数据库 的 压力 是 很大 的 而且 性能 也 很低 统计 sql 很多 时候 业务 上 都会 有 排行榜 这种 发现 公司 有 很多 地方 直接 采用 数据库 做 计算 在对 一些 大 表 做 聚合 运算 的 时候 经常 超过 五秒 这些 sql 一般 很长 而且 很难 优化 像 这种 场景 如果 业务 允许 比如 一致 性要求 不高 或者是 隔 一段时间 才 统计 的 可以 专门 在从 库 里面 做 统计 另外 我 建议 还是 采用 redis 缓存 来 处理 这种 业务 超大 分页 在 慢 查询 日志 中 发现了 一些 超大 分页 的 慢 查询 如 limit 因为 mysql 的 分页 是 在 server 层 做的 可以 采用 延迟 关 联在 减少 回 表 但是 看了 相关 的 业务 代码 正常 的 业务 逻辑 是 不会 出现 这样 的 请求 的 所以 很有 可能是 有 恶意 用户 在 刷 接口 最 好在 开发 的 时候 也 对 接口 加上 校验 拦截 这些 恶意 请求 作者 陈 芳 志 出处 往 期 精彩 漫谈 发 版 哪些 事 好 课程 推荐 linux 的 常用 最 危险 的 命令 互联网 支付 系统 整体 架构 详解 优秀 的 java 程序员 必须 了解 的 gc 哪些 it 大 企业 有 哪些 病 别被 这些 病 毁了 自己 关注 我 每天 进步 一点点 你 点 的 每个 在看 我 都 认真 当 成了 喜欢 