innodb 索引 允许 null 对 性能 有影响 吗 谈谈 innodb 辅助 索引 的 几个 特征 阅读 目录 初始化 测 试表 数据 问题 索引 列 允许 为 null 对 性能 影响 有 多少 结论 存储 大量 的 null 值 除了 计算 更 复杂 之外 数据 扫描 的 代价 也 会 更高 一些问题 辅助 索引 需要 mvcc 多 版本 读 的 时候 为什么 需要 依赖 聚集 索引 结论 辅助 索引 中 不 存储 dbtrxid 需要 依托 聚集 索引 实现 mvcc 问题 为什么 查找 数据 时 一 定要 读取 叶子 节点 只读 非 叶子 节点 不 行吗 结论 在 索引 树 中 查找 数据 时 最终 一 定是 要 读取 叶子 节点 才 行 问题 索引 列 允许 为 null 会 额外 存储 更多 字节 吗 结论 定义 列 值 允许 为 null 并不会 增加 物理 存储 代价 但对 索引 效率 的 影响 要 另外 考虑 几点 总结 延伸 阅读 本文 开始 之前 有 几篇 文章 建议 先 复习 一下 innodb 表 聚集 索引 层高 什么时候 发生变化 浅析 innodb 索引 结构 innodb 页 合 并和 页 分裂 观察 利器 接下来 我们 一起 测试 验证 关于 辅助 索引 的 几个 特点 初始化 测 试表 数据测试 表 结构 如下 idint notnullcvarchar notnullcvarchar notnullcvarchar id keyk c engineinnodb 除了 主键 索引 外 还有 个 c 列上 的 辅助 索 引用 灌入 万 测试数据 问题 索引 列 允许 为 null 对 性能 影响 有 多少 把 辅助 索引 列 c 修 改为 允许 null 并且 随机 更新 万条 数据 将 c 列 设置 为 sec 随机 为 好 现在 观察 辅助 索引 的 索引 数据 页 结构 聚集 索引 主键 索引 根 节点 层高 共 层 共 个 中间 节点 层高 共 个 叶子 节点 层高 共 个 辅助 索引 根 节点 层高 共 层 共 个 叶子 节点 层高 共 个 观察 辅助 索引 的 根 节点 里 的 数据 第一条 记录 表示 最小 记录 对应 c 列 值 为 对应 指向 叶子 节点 最后 一条 记录 nextgt 指向 supremum 对应 对应 指向 叶子 节点 lengthgt 经过 统计 根 节 点中 c 列 值 为 null 的 记录 共 有条 其余 条 是 c 列 值 为 非 null 共 条 记录 叶子 节 点中 每个 page 大约 可以 存储 条 记录 共有 万条 记录 值 为 null 因此 需要 至少 个 page 来 保存 ceiling 看下 这个 sql 的 查询 计划 从上 面的 输出 中 我们 能 看到 当 索引 列 设置 允许 为 null 时 是 会对 其 纳入 索引 统计 信息 并且 值 为 null 的 记录 都是 存储 在 索引 树 的 最 左边 接下来 跑 几个 sql 查询 sql 统计 所有 null 值 数量 查看 共 需要 扫描 个 page 根 节点 叶子 节点 正 好个 page 备注 需要用 percona 版本 才 能在 slowquerylog 中有 信息 sql 查询 查看 这次 的 查询 需要 扫描 个 page 除去 个 根 节点 外 还需要 扫描 个 叶子 节点 只是 为了 返回 一条 数据 而已 这 代价 有点 大 如果把 sql 微调 改成 下面 这样 可以 看到 还是 需要 扫描 个 查询 c 任意 非 null 值 如果把 c 列 条件 改成 正常 的 int 值 结果 就 不太 一样 了 sec slowlog 是 这样 的 可以 看到 只需要 扫描 个 page 这个 看起 来就 正常 了 结论 存储 大量 的 null 值 除了 计算 更 复杂 之外 数据 扫描 的 代价 也 会 更高 一些 另外 如果 要 查询 的 c 值 正好 介于 两个 page 的 临界 位置 那么 需要 多 读取 一个 page 扫描 第 号 page 确认 该 数据 页 中 的 最小 和 最大 物理 记录 指定 c 的 值 为 执行 查询 查看 slowlog 确认 都 需要 扫描 个 page 而 如果 换成 介于 这两个 值 之间 的 数据 则 只需要 扫描 个 这是 因为 辅助 索引 是非 唯一 的 即便是 在 等值 查询 时 也 需要 再读 取下 一条 记录 以 确认 已 获取 所有 符合 条件 的 数据 还 有当 利用 辅助 索引 读取 数据 时 如果 要 读取 整行 数据 则需 要回 表 也就是说 除了 扫描 辅助 索引 数据 页 之外 还需要 扫描 聚集 索引 数据 页 来个 例子 看看 就 知 知道了 无需 回 表 时 需 要回 表 时 需 要回 表 时 除了 扫描 辅助 索引 页 个 page 外 还需 要回 表 扫描 聚集 索引 页 而 聚集 索引 是 个 层 树 因此 总共 需要 扫描 个 page 问题 辅助 索引 需要 mvcc 多 版本 读 的 时候 为什么 需要 依赖 聚集 索引 innodb 的 mvcc 是 通过 在 聚集 索引 页 中 同时 存储 了 dbtrxid 和 dbrollptr 来 实现 的 但是 我们 从 上面 pagedump 出来 的 结果 也 很明显 能 看到 附注 索引 页 是 不 存储 dbtrxid 信息 的 所以说 辅助 索 引上 如果 想要 实现 mvcc 需要 通过 回 表 读 聚集 索 引来 实现 结论 辅助 索引 中 不 存储 dbtrxid 需要 依托 聚集 索引 实现 mvcc 问题 为什么 查找 数据 时 一 定要 读取 叶子 节点 只读 非 叶子 节点 不 行吗 在 辅助 索引 的 根 节点 这个 页面 中 pageno 我们 注意到 它 记录 的 最小 记录 minrec 对应 的 是 cnullid 这条 记 录在 它 指向 的 叶子 节点 页面 中 pageno 也 确 认了 这个 情况 现在 把 id 的 记录 删掉 看看 辅助 索引 数据 页 会 发生 什么 变化 sec 先 检查 第 号 数据 页 看到 第四号 数据 页 中最 小 记录 还是 id 没有 更新 再 查看 第 号 数据 页 在这 个 数据 页 叶子 节点 中最 小 记录 已经 被 更新 成 id 这条 数据 了 可见 索引 树 中 的 非 叶子 节点 数据 不是 实时 更新 的 只有 叶子 节点 的 数据 才是 最 准确 的 结论 在 索引 树 中 查找 数据 时 最终 一 定是 要 读取 叶子 节点 才 行 问题 索引 列 允许 为 null 会 额外 存储 更多 字节 吗 之前 流传 有 一种 说法 不允许 设置 列 值 允许 null 是因为 会 额外 多 存储 一个 字节 事 实是 这样 吗 我们 先把 c 列 改成 notnulldefault 当然 了 改 之前 要 先把 所有 null 值 更新 成 在 修改 之前 每条 索引 记录 长度 都是 字节 更新 之后 却 变 成了 个 字节 直接 对比 索引 页 中 的 数据 发现 不同之处 允许 为 null 且 默认值 为 null 时 不允许 为 null 默认值 为时 可以 看到 原先 允许 为 null 时 recordheader 需要 多 一个 字节 共 字节 但 实际 物理 存储 中 无需 存储 null 值 而 当 设置 为 notnulldefault 时 recordheader 只需要 字节 但 实际 物理 存储 却 多了 字节 总共 多了 字节 所以 索引 记录 以前 是 字节 更新 后 变 成了 字节 实际上 代价 反倒 变大 了 列 值 允许 为 null 更多 的 是 计算 代价 变大 了 以及 索引 对 索引 效率 的 影响 反倒 可以说是 节 省了 物理 存储 开销 结论 定义 列 值 允许 为 null 并不会 增加 物理 存储 代价 但对 索引 效率 的 影响 要 另外 考虑 最后 本文 使用 的 mysql 版本 perconaserver 下载 源码 后 自 编译 的 几点 总结 最后 针对 innodb 辅助 索引 总结 几条 建议 吧 a 索引 列 最好 不要 设置 允许 nullb 如果 是非 索引 列 设置 允许 为 null 基本上 无所谓 c 辅助 索引 需要 依托 聚集 索引 实现 mvccd 叶子 节点 总是 存储 最新 数据 而非 叶子 节点 则不 一定 e 尽可 能不 select 尽量 利用 覆盖 索引 完成 查询 能 不回 表 就 不回 表 延伸 阅读 innodb 表 聚集 索引 层高 什么时候 发生变化 浅析 innodb 索引 结构 innodb 页 合 并和 页 分裂 观察 利器 全文完 由 叶 老师 主讲 的 mysql 优化 课 已 升级到 mysql 版本 扫 码 开启 mysql 的 修行 之旅 吧 