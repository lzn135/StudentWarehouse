mvcc 听说 有人 好奇 我 的 底层 实现 mvcc 实现 原理 系列 文章 前言 一 mvcc 到底 是什么 二 悲观 锁 乐观 锁 悲观 锁 悲观 并发 控制 乐观 锁 乐观 并发 控制 三 mvcc 解决 了 哪些 问题 四 当前 读 快 照读 当前 读 快 照读 如何 区分 当前 读 快 照读 五 mvcc 实现 三大 要素 隐 式 字段 undolog 回 滚 日志 undolog 底层 实现 readview 版本 链 对比 规则 六 mvcc 底层 原理 案例 一 案例 二 案例 三 案例 四 小结 七 总结 系列 文章 揭开 mysql 索引 神秘 面纱 mysql 查询 优化 必备 上来 就问 mysql 事务 瑟瑟发抖 mvcc 听说 有人 好奇 我 的 底层 实现 前言 都 知道 事务 的 可 重 复读 级别 实现 原理 是 使用 mvcc 实现 的 那么 你 对 mvcc 的 底层 实现 原理 知道 多少 呢 面试 高频 点 你 值得 拥有 一 mvcc 到底 是什么 mvcc 即 多 版本 控制器 其 特点 就是在 同一时间 不同 事务 可以 读 取到 不同 版本 的 数据 从 而去 解决 脏 读 和 不可重复读 的 问题 这样 的 解释 你 看了 不下 几十 遍 了吧 但是 你 真的 理解 什么 是 多 版本 控制器 吗 生活 案例 搬家 最近 小 q 跟 自己 的 女朋友 搬到 新家 由于 出 小区 的 时候 需要 支付 当月 的 物业费 于是 小 q 跟 自己 的 女朋友 同时 登 录了 小区 提供 的 物业 缴费 系统 悲观 并发 控制 假设 小 q 正在 查 当月 需要 缴纳 的 费用 是多少 进行 支付 的 时候 此时 小 q 查询 的 这条 数据 是 已经 被 锁定 的 那么 小 q 女朋友 是 无法访问 该 数据 的 直至 小 q 支付 完成 或者 退出 系统 将 悲观 锁 释放 小 q 的 女朋友 才 可以 查询 到 数据 悲观 锁 保证 在 同一时间 只能 有 一个 线程 访问 默认 数据 在 访问 的 时候 会 产生 冲突 然后 在 整个 过程 都 加 上了 锁 这样 的 系统 对于 用户 来说 就是 毫无 体验 感 如果 多 个人 同时 需要 访问 一条 信息 只 能在 一台 设备 上 看 喽 乐观 并发 控制在 小 q 查看 物业费 欠费 情况 并且 支付 的 同时 小 q 的 女朋友 也 可以 访 问到 该 数据 乐观 锁 认为 即使 在 并发 环境 下 也 不会 产生 冲突 问题 所以 不会 去做 加锁 操作 而是 在 数据 提交 的 时候 进行 检测 如果 发现有 冲突 则 返回 冲突 信息 小结 innodb 的 mvcc 机制 就是 乐观 锁 的 一种 体现 读 不 加锁 读写 不 冲突 在 不 加锁 的 情况下 能让 多个 事务 进行 并发 读写 并且 解决 读写 冲突 问题 极大 的 提高 系统 的 并 发性 二 悲观 锁 乐观 锁 锁 按照 粒度 分为 表 锁 行 锁 页 锁 按照 使用 方式 分为 共享 锁 排 它 锁 根据 思想 分为 乐观 锁 悲观 锁 无论是 乐观 锁 悲观 锁 都只是 一种 思想 而已 并不是 实际 的 锁 机制 这点 一 定要 清楚 悲观 锁 悲观 并发 控制 悲观 锁 实际 为 悲观 并发 控制 缩写 pcc 悲观 锁 持 消极态度 认为 每一次 访问 数据 时 总是会 发生冲突 因此 每次 访问 必须先 锁住 数据 完成 访问 后 在 释放 锁 保证 在 同一时间 只有 单个 线程 可以 访问 实现 数据 的 排 它 性 同时 悲观 锁 使用 数据库 自身 的 锁 机制 实现 可以 解决 读写 写写 的 冲突 那么 在 什么 场景 下 可以 使用 悲观 锁 呢 悲观 锁 适用于 在 写 多 读 少 的 并发 环境 下 使用 虽然 并发 效率 不高 但是 保证 了 数据 的 安全性 乐观 锁 乐观 并发 控制 跟 悲观 锁 一样 乐观 锁 实际 为 乐观 并发 控制 缩写 为 occ 乐观 锁相 对于 悲观 锁 而言 认为 即使 在 并发 环境 下 外界 对 数据 的 操作 不会 产生 冲突 所以 不 会去 加锁 而是 会在 提交 更新 的 时候 才会 正式 的 对 数据 冲突 与否 进行 检测 如果 发现 冲突 要么 再 重试 一次 要么 切 换为 悲观 的 策略 乐观 并发 控制 要 解决 的 是 数据库 并发 场景 下 的 写写 冲突 指用 无 锁 的 方式 去 解决 三 mvcc 解决 了 哪些 问 题在 事务 并发 的 情况下 会 产生 以下 问题 脏 读读 取 其它 事务 未 提交 的 数据 不可重复读 一个 事务 在 读取 一条 数据 时 由于 另一个 事务 修 改了 这条 数据 并且 提交 事务 再次 读取 时 导致 数据 不一致 幻 读 一个 事务 读 取了 某个 范围 的 数据 同时 另一个 事务 新增 了 这个 范围 的 数据 再次 读取 发现 俩 次 得到 的 结果 不一致 mvcc 在 innodb 存储 引擎 的 实现 主要 是为了 提高 数据库 并发 能力 用 更好 的 方式 去 处理 读写 冲突 同时 做到 不 加锁 非 阻塞 并发 读写 mvcc 可以 解决 脏 读 不可重复读 mvcc 使用 快 照读 解决 了 部分 幻 读 问题 但是在 修 改时 还是 使用 当前 读 所以 还是 存在 幻 读 问题 幻 读 问题 最终 就是 使用 间隙 锁 解决 四 当前 读 快照 读在 了解 mvcc 是 如何 解决 事务 并发 带来 的 问题 之前 需要 先 明白 俩 个 概念 当前 读 快 照读 当前 读给 读 操作 加上 共享 锁 排 它 锁 dml 操作 加 上排 它 锁 这些 操作 就是 当前 读 共享 锁 排 它 锁 也 被 称之为 读 锁 写 锁 共享 锁 与 共享 锁 是 共存 的 但是 要 修改 添加 删除 时 必须 等到 共享 锁 释放 才 可 进行 操作 因为 在 innodb 存储 引擎 中 dml 操作 都会 隐 式 添 加排 它 锁 所以说 当前 读 所 读取 的 记录 就是 最新 的 记录 读取 数据 时 加 上锁 保证 其它 事务 不能 修改 当前 记录 快 照读 如果 你 看到 这里 就 默认 你 对 隔离 级别 有 一定 的 了解 哈 快 照读 的 前提 是 隔离 级别 不是 串行 级别 串行 级别 的 快 照读 会 退 化成 当前 读 快 照读 的 出现 旨在 提高 事务 并 发性 其 实现 基于 本文 的 主角 mvcc 即 多 版本 控制器 mvcc 可以 认为是 行 锁 的 一个 变种 但是 它在 很多 情况下 避免了 加锁 操作 所以说 快 照读 的 数据 有 可能 不是 最新 的 而是 之前 版本 的 数据 为什么 要 提到 快 照读 呢 因为 readview 就是 通过 快 照读 生成 的 为了 防止 后文 概念 模糊 所以 在这里 进行 说明 如何 区分 当前 读 快 照读 不 加锁 的 简单 的 select 都 属于 快 照读 与 之 对应 的 则是 当前 读给 select 加上 共享 锁 排 它 锁 五 mvcc 实现 三大 要素 终于 来到 本文 最 重要 的 部分 前边 的 叙述 都是 为了 给 原理 这一 块 做 铺垫 在这 之前 需要 知道 mvcc 只 在 repeatableread 可 重 复读 和 readcommitted 已 读 提交 这俩 种 隔离 级 别下 适用 mvcc 实现 原理 是 由 俩 个 隐 式 字段 undo 日志 readview 来 实现 的 隐 式 字段 在 innodb 存储 引擎 中 在有 聚 簇 索引 的 情况下 每 一行 记录 中 都会 隐藏 俩 个 字段 如果 没有 聚 簇 索引 则还 有 一个 byte 的 隐藏 主键 这俩 个 隐藏 列 一个 记录 的 是 何时 被 创建 的 一个 记录 的 是什么 时候 被 删除 这里 不要 理解为 是 记录 的 是 时间 存储 的 是 事务 id 俩 个 隐 式 字段 为 没有 聚 簇 索引 还会 有 dbrowid 这个 字段 dbtrxid 记录 创建 这条 数据 上次 修改 它 的 事务 iddbrollptr 回 滚 指针 指向 这条 记录 的 上一个 版本 隐 式 字段 实际 还有 一个 deleteflag 字段 即 记录 被 更新 或 删除 这里 的 删除 并不 代表 真的 删除 而是 将 这条 记录 的 deleteflag 改为 true 这里 埋下 一个 伏笔 数据库 的 删除 是 真的 删除 吗 undolog 回 滚 日志 之前 对 undolog 的 作用 只 提 到了 回 滚 操作 实现 原子 性 现在 需要 知道 的 另一个 作用 就是 实现 mvcc 多 版本 控制器 undolog 细 分为 俩 种 insert 时 产生 的 时 产生 的 undolog 在 innodb 中 insert 产生 的 undolog 在 提交 事务 之后 就会 被 删除 因为 新 插入 的 数据 没有 历史 版本 所以 无需 维护 undologupdate 和 delete 操作 产生 的 undolog 都 属于 一种 类型 在 事务 回 滚 时 需要 而且 在 快 照读 时 也 需要 则 需要 维护 多个 版本 信息 只有 在 快 照读 和 事务 回 滚 不 涉及 该 日志 时 对应 的 日志 才 会被 purge 线程 统一 删除 purge 线程 会 清理 undolog 的 历史 版本 同样 也 会 清理 delflag 标记 的 记录 undolog 在 mvcc 中 的 作用 写到 这里 关于 undolog 在 mvcc 中 的 作用 估计 还是 蒙 圈 的 undolog 保存 的 是 一个 版本 链 也 就是 使用 dbrollptr 这个 字段 来 连接 的当 数据库 执行 一个 select 语句 时会 产生 一致性 视图 readview 那么 这个 readview 是 由 查询 时 所有 未 提交 事务 id 组成 的 数组 数组 中 最小 的 事务 id 为 minid 和 已 创建 的 最大 事务 id 为 maxid 组成 查询 的 数据 结果 需要 跟 readview 做 比较 从而 得到 快照 结果 所以说 undolog 在 mvcc 中 的 作用 就是 为了 根据 存储 的 事务 id 和 一致性 视图 做 对比 从而 得到 快照 结果 undolog 底层 实现 假设 一开始 的 数据 为 下图 此时 执 行了 一条 更新 的 sql 语句 那么 undolog 的 记录 就会 发生变化 也就是说 当 执行 一条 更新 语句 时 会把 之前 的 原有 数据 拷贝到 undolog 日志 中 同时 你 可以 看见 最新 的 一条 记 录在 末尾 处 连 接了 一条线 也就是说 dbrollptr 记录 的 就是 存放在 undolog 日志 的 指针 地址 最终 有 可能 需要 通过 指针 来 找到 历史数据 readview 当 执行 sql 语句 查询 时会 产生 一致性 视图 也 就是 readview 它是 由 查询 的 那一 时间 所有 未 提交 事务 id 组成 的 数组 和 已经 创建 的 最大 事务 id 组成 的 在这 个 数组 中 最小 的 事务 id 被 称之为 minid 最大 事务 id 被 称之为 maxid 查询 的 数据 结果 要根据 readview 做 对比 从而 得到 快照 结果 于是就 产 生了 以下 的 对比 规则 这个 规则 就是 使用 当前 的 记录 的 trxid 跟 readview 进行 对比 对比 规则 如下 版本 链 对比 规则 如果 落在 trxidltminid 表示 此版 本是 已经 提交 的 事务 生成 的 由于 事务 已经 提交 所以 数据 是 可见 的 如果 落在 trxidgtmaxid 表示 此版 本是 由 将来 启动 的 事务 生成 的 是 肯定 不可 见 的 若在 时 如果 row 的 trxid 在 数组 中 表示 此版 本是 由 还没 提交 的 事务 生成 的 不可 见 但是 当前 自己 的 事务 是 可见 的 如果 row 的 trxid 不在 数组 中 表明 是 提交 的 事务 生 成了 该 版本 可见 在这里 还有 一个 特殊情况 那就是 对于 已经 删除 的 数据 在 之前 的 undolog 日志 讲述 时 说了 update 和 delete 是 同一种 类型 的 undolog 同样 也 可以 认为 delete 就是 update 的 特殊情况 当 删除 一条 数据 时 会将 版本 链 上 最新 的 数据 复制 一份 然后 将 trxid 修 改为 删除 时 的 trxid 同时 在 该 记录 的 头 信息 中 存在 一个 deleteflag 标记 将 这个 标记 写上 true 用来 表示 当前 记录 已经 删除 在 查询 时 按照 版本 链 的 规则 查询 到 对应 的 记录 如果 deleteflag 标记 位 为 true 意味着 数据 已经 被 删除 则不 返回 数据 如果 你 对 这里 的 readview 的 生成 和 版本 链 对比 规则 不懂 不要 着急 也 不要 在这里 浪费时间 请 继续 往下 看 咔 咔 会 使用 一个 简单 的 案例 和 一个 复杂 的 案例 给 大家 重现 上述 的 规则 六 mvcc 底层 原理 案例 一 下图 是 准备 的 素材 这里 应该 都 理解 select 返回 的 结果 为 niuniu 即 事务 修改后 的 结果 从上 图中 可以 看到 有 三个 事务 正在进行 事务 id 为 是 修改 的 其它 表 只有 事务 id 为 修改 的 需要 查询 的 这张 表 接下来 看看 select t 这一 列 查询 返回 的 结果 是不是 就是 事务 id 为 修改 的 结果 此时 生成 的 readview 为 那么 现在 就可以 返回 去看 一下 readview 规则 在这里 事务 id 就是 minid 事务 id 就是 maxid 这个 select 语句 返回 结果 肯定是 niuniu 那么 接下来 看一下 在 mvcc 中 是 如何 查找 数据 的 当前 版本 链 那么 就会 拿着 trxid 为 进行 比对 会 发现 这个 就是 maxid 然后 你 再看 一下 版本 链 的 对比 规则 中 第三种 情况 如果 落在 会 存在 俩 种 情况 此时 信息 就 已经 非常 明确 了 事务 id 是 没有 在 数组 中 的 所以 表示 这个 版 本是 已经 提交 的 事务 生成 的 那么 就是 可见 的 呗 毫无疑问 查询 会 返回 niuniu 这个 值 先 通过 这个 简单 的 案例 让 你 对 版本 链 有 一个 简单 的 理解 接下来 将 使用 一个 比较 繁琐 的 案例 再来 跟 大家 演示 一遍 案例 二 本例 要求 知道 select 的 第二个 查询 结果 深黑色 字体 同样是 在 kaka 那一 条 记录 的 基础 上当 事务 id 两次 更新 后 版本 链 也 会改 变 现在 的 版本 链 如 下图 红色 部 分为 最新 数据 蓝色 数据 为 undolog 的 版本 链 数据 对于 此时 生成 的 readview 你 会有 什么 疑问 在 rr 级别 也 就是 可 重 复读 的 隔离 级 别下 当在 一个 事务 下 执行 查询 时 所有 的 readview 都是 沿用 的 第一条 查询 语句 生成 的 那 此时 的 readview 也 就是 看一下 底层 查找 步骤 目前 数据 的 事务 id 为 根据 规 则会 落在 这个 区间 并且 当 前行 的 事务 id 是 在 readview 的 数组 中 的 表示 此时 事务 还没有 提交 则不 可见 继续 在 版本 链 中 往下 寻找 此时 找到 的 事务 id 还是 跟 上述 流程 一致 通过 查找 版本 链 将 发现 事务 id 为 是 readview 的 maxid 同样 也 会 落在 这个 区间 但是 跟 之前 不同 的 是 事务 是 没有 在 数组 中 的 表示 这个 版本 事务 已经 提 交了 所以是 可见 的 最后 返回 的 是 niuniu 案例 三 为了 让 大家 体验 一下 可 重 复读 级别 生成 的 readview 是 根据 在 同一 事务 中 第一条 快 照读 产生 的 再 来看 一个 案例 此时 的 事务 id 也 再 对 数据 更新 两次 然后 在 进行 查询 看一下 会 返回 什么 值 经过 案例 一 案例 二 的 熟悉 现 在对 undolog 的 版本 链 和 对比 规则 已经有 了 一定 的 了解 了吧 案例 三 就不 在 那么 详细 的 说 明了 此时 的 版本 链 如下 此时 的 readview 依然 为 那么 首 先会 根据 事务 去 版本 链 对比 事务 和 事务 都会 落在 这个 区间 并且 还都在 数组 中 所以 数据 是 不可 见 的 那么 继续 往 版本 链 中 寻找 就会 遇到 事务 这个 是 最大 的 事务 id 并且 不在 数组 中所 以是 可见 的 于是 最终 的 返回 结果 还是 niuniu 案例 四 可以 看到 个 案例 三 的 图 不同 的 是 新增 了 一个 查询 语句 那么 假设 这俩 条 语句 执行 的 时间 都是 一致 的 它们 返回 的 结果 会 相同 吗 案例 三 查询 到 的 值 为 niuniu 其实 现在 版本 链 跟 案例 三 也是 一致 的 那么 来 梳理 一下 寻找 过程 首先 这里 的 readview 发 生了 变化 此时 的 readview 为 拿着 当前 的 事务 id 跟 版本 链 规则 进行 对比 落 盘在 并且在 数组 中 则 数据 不可 见 然后 进入 版本 链 找到 下一个 数据 的 事务 id 还是 与 上一个 一致 接下来 是 事务 id 事务 id 是 落在 trxidltminid 表示 此版 本是 已经 提交 的 事务 生成 的 由于 事务 已经 提交 所以 数据 是 可见 的 所以 最终 返回 结果 为 niuniu 小 结在 同一个 事务 中 进行 查询 会 沿用 第一次 查询 语句 生成 的 readview 前提 是 隔离 级 别是 在 可 重 复读 通过 以上 的 四个 案例 在 版本 链 寻找 过程中 可以 总 结出 一个 小 技巧 根据 这个 小 技巧 你 可以 很快 的 得知 此版 本 是否 可见 如果 当前 的 事务 id 在 绿色 部分 是 已经 提交 事务 则 数据 可见 如果 当前 的 事务 id 在 蓝色 部分 会有 俩 种 情况 如果 当前 事务 id 在 readview 数组 内 是 没有 提交 的 事务 不可 见 如果 不在 数组 内 数据 可见 如果 落在 红色 部分 则不 考虑 对于 未来 的 事情 不 去想 即可 七 总结 阅读 本文 后 在 面试 过程中 极大 可能会 遇到 的 问题 就是 聊聊 你 对 mvcc 的 认识 本文 内容 从 浅到 深 从 什么 是 mvcc 到 mvcc 的 底层 实现 一步 一步 地 陈述 了 mvcc 的 实现 原理 本文 简单 总结 mvcc 在 不 加锁 的 情况下 解决 了 脏 读 不可重复读 和 快 照读 下 的 幻 读 问题 一定 不要 认为 幻 读完 全是 mvcc 解决 的 对 当前 读 快 照读 理解 简 单点 说 加锁 就是 当前 读 不 加锁 的 就是 快 照读 mvcc 实现 的 三大 要素 俩 个 隐 式 字段 回 滚 日志 readview 俩 个 隐 式 字段 dbtrxid 记录 创建 这条 记录 最后 一次 修改 该 记录 的 事务 iddbrollptr 回 滚 指针 指向 这条 记录 的 上一个 版本 undolog 在 更新 数据 时会 产生 版本 链 是 readview 获取 数据 的 前提 readview 当 sql 执行 查询 语句 时 产生 的 是 由 为 提交 的 事务 id 组成 的 数组 和 创建 的 最大 事务 id 组成 的 版本 链 规则 看 第六节 的 小结 即可 坚持 学习 坚持 写作 坚持 分享 是 咔 咔 从业 以来 一直 所 秉持 的 信念 希望 在 偌大 互联网 中 咔 咔 的 文章 能带 给你 一丝丝 帮助 我 是 咔 咔 下期 见 