mysql 隐 式 类型 转换 mysql 隐 式 类型 转换 官 网 oidbigint nullcomment 无效 有效 comment 创建 时间 comment 修改 时间 新建 索引 oid email name telephone telephoneemail oidname oidcreatedat oidupdatedat oid 新增 记录 values now 查询 aschar oidnumber emailvarchar telephone values lhrbestgmailcom sec rowsinset sec sec rowinset sec aschar sec convert cast rowinset sec convert cast sec 无效 有效 创建 时间 修改 时间 rowsinset sec sec sec rowinset sec sec sec cpu filter tonumber telephone level memory sorts disk cpu access telephone level memory sorts disk 隐 式 转化 整理 rollenholt 浏览 评论 云 数据库 rds 摘要 前几天 在 微 博 上 看到 一篇 文章 价值 百万 的 mysql 的 隐 式 类型 转换 感觉 写 的 很不错 再加上 自己 之前 也 对 mysql 的 隐 式 转化 这边 并不是 很 清楚 所以 就 顺势 整 理了 一下 希望 对 大家 有所 帮助 当 我们 对 不同 类型 的 值 进行 比较 的 时候 为了 使得 这些 数值 可 比较 也 可以 称为 类型 的 兼容性 mysql 会做 一些 隐 式 转化 前几天 在 微 博 上 看到 一篇 文章 价值 百万 的 mysql 的 隐 式 类型 转换 感觉 写 的 很不错 再加上 自己 之前 也 对 mysql 的 隐 式 转化 这边 并不是 很 清楚 所以 就 顺势 整 理了 一下 希望 对 大家 有所 帮助 当 我们 对 不同 类型 的 值 进行 比较 的 时候 为了 使得 这些 数值 可 比较 也 可以 称为 类型 的 兼容性 mysql 会做 一些 隐 式 转化 比如 下面 的 例子 test gttest 很明显 上面 的 sql 语句 的 执行 过程 中就 出现 了 隐 式 转化 并且 从 结果 们 可以 判断 出 第一条 sql 中将 字符串 的 转 换为 数字 而在 第二条 的 sql 中将 数字 转 换为 字符串 mysql 也 提供 了 cast 函数 我们 可以 使 用它 明确 的 把 数值 转 换为 字符串 当 使用 conca 函数 的 时候 也 可能会 出现 隐 式 转化 因为 它 希望 的 参数 为 字符串 形式 但是 如果 我们 传递 的 不是 字符串 呢 aschar gt 隐 式 转化 规则 官方 文档 中 关于 隐 式 转化 的 规 则是 如下 描述 的 real numbers 翻 译为 中文 就是 两个 参数 至少有 一个是 null 时 比较 的 结果 也是 null 例外 是 使用 ltgt 对 两个 null 做 比较 时会 返回 这两种 情况 都不 需 要做 类型 转换 两个 参数 都是 字符 串会 按照 字符串 来 比较 不做 类型 转换 两个 参数 都是 整数 按照 整数 来 比较 不做 类型 转换 十六进制 的 值 和 非 数字 做 比较 时 会被 当做 二进制 串 有 一个 参数 是 timestamp 或 datetime 并且 另外 一个 参数 是 常量 常量 会被 转 换为 timestamp 有 一个 参数 是 decimal 类型 如果 另外 一个 参数 是 decimal 或者 整数 会将 整数 转 换为 decimal 后 进行 比较 如果 另外 一个 参数 是 浮点数 则 会把 decimal 转 换为 浮点数 进行 比较 所有 其他 情况下 两个 参数 都 会被 转 换为 浮点数 再 进行 比较 注意 点 安全问题 假如 password 类型 为 字符串 查询 条件 为 int 则会 匹 配上 sec sec sec 相信 上面 的 例子 一些 机灵 的 同学 可以 发现 其实 上面 的 例子 也 可以 做 sql 注入 假设 网站 的 登录 那块 做的 比较 挫 使用 下面 的 方式 如果 username 输入 的 是 aor 那么 password 随便 输入 这样 就 生 成了 下面 的 查询 就有 可能 登录 系统 其实 如果 攻击者 看 过了 这篇 文章 那么 就可以 利用 隐 式 转化 来 进行 登录 了 如下 sec sec 之所以 出现 上述 的 原因 是因为 sec sec 下面 通过 一些 例子 来 复习 一下 上面 的 转换规则 sec sec sec 把 字符串 aa 和 进行 求和 得到 因为 aa 和 数字 的 类型 不同 mysql 官方 文档 告诉 我们 查看 warnings 可以 看到 隐 式 转化 把 字符串 转 为了 double 类型 但是 因为 字符串 是非 数字型 的 所以 就 会被 转 换为 因此 最终 计算 的 是 上面 的 例子 是 类型 不同 所以 出现 了 隐 式 转化 那么 如果 我们 使用 相同 类型 的 值 进行 运算 呢 sec sec 是不是 有点 郁闷 呢 之所以 出现 这种 情况 是因为 为 算术 操作符 这样 就可以 解释 为什么 a 和 b 都 转 换为 double 了 因为 转换 之后 其实 就是了 在看 一个 例子 sec sec 现在 就看 也 很好 的 理解 上面 的 例子 了吧 abc 结果 为 在 mysql 中 可以 理解为 true 因为 ab 的 结果 为 c 也 会 隐 式 转 化为 因此 比较 其实是 也 就是 true 也 就是 第二个 需要 注意 点 就是 防止 多 查询 或者 删除 数据 sec sec sec 上面 的 例子 本意 是 查询 id 为 的 那一 条 记录 结果 把 id 为 的 那一 条 也 查询 出 来了 我 想 说明 什么情况 呢 有时候 我们 的 数据库 表 中 的 一些 列 是 varchar 类型 但是 存储 的 值 为 这种 的 纯 数字 的 字符串 值 一些 同学 写 sql 的 时候 又不 习惯 加 引号 这样 当 进行 selectupdate 或者 delete 的 时候 就 可能会 多 操作 一些 数据 所以 应 该加 引号 的 地方 别忘记 了 关于 字符串 转 数字 的 一些 说明 sec sec sec sec sec 从上 面的 例子 可以 看出 当 把 字符串 转为 数字 的 时候 其实是 从 左边 开始 处理 的 如果 字符串 的 第一 个字符 就 是非 数字 的 字符 那么 转 换为 数字 就是 如果 字符串 以 数字 开头 如果 字符串 中 都是 数字 那么 转 换为 数字 就是 整个 字符串 对应 的 数字 如果 字符串 中 存在 非 数字 那么 么 转 换为 的 数字 就是 开头 的 那些 数字 对应 的 值 如果 你 有 其他 更好 的 例子 或者 被 隐 式 转化 坑 过 的 情况 欢迎 分享 参考资料 前言 mysql 的 隐 式 转换 是什么 样子 的 什么时候 会 进行 隐 式 转换 下面 让我们 来 掀开 mysql 隐 式 转换 的 面纱 下面 我们 通过 一 个例 子来 进行 说明 隐 式 转换 的 几种 情况 当 不同 类型 的 字段 一起 使用 时会 发生 隐 式 转换 sec test concat test testrowinset sec 或者 使用 函数 显示 或者 隐 式 进行 转换 aschar cast aschar rowinset sec concat rowinset sec 下面 是 一些 会 发生 隐 式 转换 的 规则 real numbers 下面 是 字符串 转换成 数字 进行 比较 的 sec sec sec sec 如果在 sql 中 对 一个 字符串 和 数字 比较 mysql 不会 使用 索引 sec idint name keyid id sec 浮点数 的 比较 是 近似值 可能 导致 结果 不 准确 可能 会有 取舍 sec 浮点数 与 整数 之间 的 转换 或者 符号 之间 的 转换 最好 使用 函数 cast 避免 隐 式 转换 总结 sql 中 的 where 条件 禁止 进行 不同 字段 类型 的 比较 字符串 类型 和 数字 比较 会 转换成 然后 进行 比较 字符串 转换成 数字 的 时候 是 从 最 左边 开始 的 不是 数字 就是 是 数字 就 匹配 最左 数字 这就 导致 可能会 多 查询 或者 删除 更新 数据 这个 结果 就 比较 悲 催 了 小心 mysql 的 隐 式 类型 转换 陷阱 隐 式 类型 转换 实例 今天 生产 库 上 突然 出现 mysql 线程 数 告警 iops 很高 实例 会话 里面 出现 许多 类似 下面 的 sql 修 改了 相关 字段 和 值 idxcorpidqqid 用 explain 看了 下 扫描 行数 和 索引 选择 情况 共 返回 行 记录 花费 msttb 表 上有 个 索引 uidtypefrid fcolidftype idxcorpidqqid fcolidfqqid 而且 如果 选择 后者 时 fqqid 的 过滤 效果 应该 很 佳 但却 选择 了 前者 当 使用 hintuseindex idxcorpidqqid 时 共 返回 行 记录 花费 idxcorpidqqid where and and 共 返回 行 记录 花费 msrows 列 达到 w 行 但 问题 也 发现了 selecttype 应该是 range 才 对 keylen 看出来 只用 到了 idxcorpidqqid 索引 的 第一 列 上面 explain 使 用了 extended 所以 showwarnings 可以 很 明确 的 看到 fqqid 出现 了 隐 式 类型 转换 fqqid 是 varchar 而后 面的 比较 值 是 整型 解决 该 问题 就是 避免 出现 隐 隐 式 类型 转换 带来 的 不 可控 把 fqqidin 的 内容 写成 字符串 共 返回 行 记录 花费 ms 类似 的 还 出现 过 一例 扫描 行数 从 减少 为 selectcount 借 这个 机会 系统 的 来看 一下 mysql 中 的 隐 式 类型 转换 优化 后 直接 从 扫描 rowsw 行 降为 mysql 隐 式 转换规则 规则 下面 来 分析 一下 隐 式 转换 的 规则 a 两个 参数 至少有 一个是 null 时 比较 的 结果 也是 null 例外 是 使用 ltgt 对 两个 null 做 比较 时会 返回 这两种 情况 都不 需 要做 类型 转换 b 两个 参数 都是 字符 串会 按照 字符串 来 比较 不做 类型 转换 c 两个 参数 都是 整数 按照 整数 来 比较 不做 类型 转换 d 十六进制 的 值 和 非 数字 做 比较 时 会被 当做 二进制 串 e 有 一个 参数 是 timestamp 或 datetime 并且 另外 一个 参数 是 常量 常量 会被 转 换为 timestampf 有 一个 参数 是 decimal 类型 如果 另外 一个 参数 是 decimal 或者 整数 会将 整数 转 换为 decimal 后 进行 比较 如果 另外 一个 参数 是 浮点数 则 会把 decimal 转 换为 浮点数 进行 比较 g 所有 其他 情况下 两个 参数 都 会被 转 换为 浮点数 再 进行 比较 sec sec sec a 转成 double 型 也是 被 截 断成 所以 a 上面 可以 看出 aa 由于 操作符 两边 的 类型 不一样 且 符合 第 g 条 aa 要被 转换成 浮点 型 小数 然而 转换 失败 字母 被 截断 可以 认为 转 成了 整数 被 转成 浮点 型 还是 它自己 所以 aa 等式 比较 也 说 明了 这一点 a 和 转换 后 都 等于 这也 正是 文章 开头 实例 为什么 没 走 索引 的 原因 varchar 型 的 fqqid 转换成 浮点 型 比较 时 等于 的 情况 有无 数种 如 ab 等待 mysql 优化 器 无法 确定 索引 是否 更 有效 所以 选择 了 其它 方案 但 并不是 只要 出现 隐 式 类型 转换 就会 引起 上面 类似 的 性能 问题 最 终是 要看 转换 后 能否 有效 选择 索引 像 就不会 影响 索引 选择 因为 前者 fid 是 整型 即使 与 后面 的 字符串 型 数字 转换成 double 比较 依然 能 根据 double 确定 fid 的 值 索引 依然 有效 后者 是因为 符合 第 e 条 只是 右边 的 常量 做了 转换 开发人员 可能 都 只要 存在 这么 一个 隐 式 类型 转换 的 坑 但却 又 经常 不注意 所以 干脆 无需 记住 那么多 规则 该 什么 类型 就与 什么 类型 比较 隐 式 类型 转换 的 安全问题 不仅 可能 引起 性能 问题 还有 可能 产生 安全问题 假如 应用 前端 没有 waf 防护 那么 下面 的 sql 很 容易 注入 传入 攻击者 更 聪明 一点 fname 传入 abfpassword 传入 sec 参考 mysql 隐 式 转化 整理 whrer 条件 里 的 数据类型 必须 和 字段 数据类型 一致 原文 链接 地址 本文 作者 小 麦苗 部分内容 整理 自 网络 若有 侵权 请 联系 小 麦苗 删除 本文 在 博客园 和 个人 微 信 公众 号 xiaomaimiaolhr 上有 同步 更新 本文 itpub 地址 本文 博客园 地址 本文 pdf 版 个人简介 及 小 麦苗 云 盘 地址 数据库 笔试 面试 题库 及 解答 宝典 今日 头条 号 地址 群 号 满 微 信 群 可加 我 微 信我 拉 大家 进 群 非 诚 勿扰 联系 我 请 加 qq 好友 注明 添加 缘 由于 在 魔 都 完成 文章内容 来源于 小 麦苗 的 学习 笔记 部分 整理 自 网络 若有 侵权 或 不当之处 还请 谅解 版权所有 欢迎 分享 本文 转载 请 保留 出处 小 麦苗 的 微 店 小 麦苗 出版 的 数据库 类 丛书 使用 微 信 客户端 扫描 下面 的 二维码 来 关注 小 麦苗 的 微 信 公众 号 xiaomaimiaolhr 及 qq 群 dba 宝典 学习 最 实用 的 数据库 技术 小 麦苗 的 微 信 公众 号 小 麦苗 的 dba 宝典 qq 群 dba 笔试 面 宝典 读者 群小 麦苗 的 微 店 来自 itpub 博客 链接 如需 转载 请 注明 出处 否 则将 追究 法律责任 转 载于 