mysql 令人咋舌 的 隐 式 转换 导读 作者 徐 晨 亮 mysqldba 知 数 堂 学员 热衷于 数据库 优化 自动化 运 维 及 数据库 周边 工具 开发 对 mysql 源码 有 一定 的 兴趣 本文 建议 横 屏 观看 效果 更佳 一 问题 描述 idvarchar defaultnull sec sec 奇怪 的 现象 sec 什么 鬼 明 明查 的 是 为什么 也 出 来了 二 源码 解释 堆栈 调用 关系 如下 所示 其中 joinexec 是 执行 的 入口 是 进行 等值 判断 的 函数 其 定义 如下 a gtvalreal if a gtnullvalue val b gtvalreal if b gtnullvalue if setnull valltval returnif valval returnreturnif setnull 比较 步骤 如 下图 所示 逐行 读取 t 表 的 id 列 放入 val 而 常量 存在于 cache 中 类型 为 double 类型 e 所以 到 这里 传 值 给 val 后 vale 当 扫 描到 第一 行时 转成 doule 的 值 为 e 等式 成立 判 定为 符合 条件 的 行 继续 往下 扫描 同理 也 同样 符合 如何 检测 string 类型 的 数字 转成 doule 类型 是否 溢出 呢 这里 经过 测试 当 数字 超 过位 以后 转成 double 类型 就 已经 不 准确 了 例如 会 表示 成 如 图中 valmysqlstring 转成 double 的 定义 函数 如下 endnullampamp ampamperrornull resmystrtodint buf return error res 真正 转换 函数 mystrtodint 位置 在 dtoac 太 复杂 了 简单 贴个 注释 吧 dk ek 既然是 这样 我们 测试 下 没有 溢出 的 案例 sec sec 结果 符合 预期 而在 本例 中 正确 的 写法 应当是 sec 三 结论 避免 发生 隐 式 类型 转换 隐 式 转换 的 类型 主要有 字段 类型 不一致 in 参数 包含 多个 类型 字符集 类型 或 校对 规则 不一致 等 隐 式 类型 转换 可能 导致 无法 使用 索引 查询 结果 不 准确 等 因此在 使 用时 必须 仔细 甄别 数字 类型 的 建议 在 字段 定义 时 就 定义 为 int 或者 bigint 表 关联 时 关联 字段 必须 保持 类型 字符集 校对 规则 都 一致 最后 贴 一 下官 网 对于 隐 式 类型 转换 的 说明 吧 real numbers 参考 文章 聊聊 隐 式 转换 感谢 八 怪 的 友情 指导 想 学习 更多 源码 内容 强烈推荐 一下 八 怪 的 专栏 深入 理解 mysql 主从 原理 end 点击 下图 小 程序 订阅 深入 理解 mysql 主从 原理 讲 专栏 可 了解 更多 八 怪 技术文章 扫 码 加入 mysql 技术 q 群 群 号 