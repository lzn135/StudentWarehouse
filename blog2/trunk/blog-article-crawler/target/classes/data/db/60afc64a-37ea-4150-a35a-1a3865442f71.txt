幻 读 听说 有人 认为 我 是 被 mvcc 干掉 的 文章 目录 前言 系列 文章 一 我 是 谁 二 为什么 有人 会 认为 我 是 被 mvcc 干掉 的 三 我 真的 是 被 mvcc 解决 的 四 再聊 当前 读 快 照读 当前 读 快 照读 五 告诉 你们 吧 当前 读 的 情况下 我 是 被 nextkeylocks 干掉 的 六 幻 读 解决方案 七 扩展 事务 id 是 在 何时 分配 的 为什么 事务 id 差异 特别 大 前言 我 是 幻 读 听说 有人 认为 我 是 mvcc 解决 的 为了 让 大家 更 全面 地 理解 我 只能 亲 自来 解释一下 系列 文章 揭开 mysql 索引 神秘 面纱 mysql 查询 优化 必备 上来 就问 mysql 事务 瑟瑟发抖 mvcc 听说 有人 好奇 我 的 底层 实现 一 我 是 谁 先给 大家 做一个 简单 的 自我介绍 我 就是 事务 并发 时会 产生 的 三 大问题 之一 我 的 其它 俩 兄弟 脏 读 不可重复读 被 mvcc 在上 一个 回合 无情 的 干 掉了 至于 上个 回合 发 生了 什么 可以 去看 剧情 回顾 我 的 由来 就是 因为 主 人在 操作 一组 数据 时 还有 很多人 也 在对 这组 数据 进行 操作 举 一个 简单 的 案例 根据 条件 在对 一组 数据 进行 过滤 返回 的 结果 为 个 但是在 主人 操作 的 同时 其他人 又 新增 了 符合 条件 的 数据 然后 主人 再次 进行 查询 时 返回 结果 为 第二次 返回 的 数据 跟 第一次 返回 数据 不一致 于是 我 诞 生了 大家 还给 我 起了 个 很 好听 的 名字 幻 读 为什么 会给 我 起 这个 名字 呢 那是 因为 我 给 人们 的 现象 好像 出了 幻觉 一样 二 为什么 有人 会 认为 我 是 被 mvcc 干掉 的 为了 演示 方便 就 直接 使用 之前 的 测 试表 来 进行 操作 同时 大家 可以 看 到此 表 还有 一些 测试数据 一切 从头开始 清空 表 清空 表 的 命令 执行 这个 命令 会使 表 的 数据 清空 并且 自 增 id 会 从 开始 从 执行 过程 来看 truncatetable 类似于 droptable 然后 在 createtable 这里 的 环境 都是 测试 环境 千万 不要 在线 上 进行 操作 因为 它 绕 过了 dml 方法 是 不能 回 滚 的 进行了 一点 小 插曲 进入 正题 根据 上图 的 执行 步骤 预期 来说 左边 事务 的 第一条 select 语句 查询 结果 为 空 第二个 select 查询 结果 为 条数 据 包含 右边 事务 提交 的 数据 但在 实际 测试 的 情况下 第一次 执行 select 和 第二次 执行 select 返回 结果 一致 从这 个 案例 中 可以 得出结论 确 实在 不可 重复 隔离 级 别下 会 解决 幻 读 问题 在 快 照读 的 前提下 三 我 真的 是 被 mvcc 解决 的 通过 上述 测试 案例 来看 貌似 在 mysql 中 通过 mvcc 就 解决 我 的 引来 的 问题 那 既然 都 解决 了 我 的 问题 为什么 还有 串行化 的 隔离 级别 呢 好 疑惑 啊 带着 这个 疑问 继续进行 实验 为了 方便 就 不再 使用 上边 表 结构 了 建立 一个 简单 的 表 结构 再 进入 一个 小 插曲 你 知道 在 mysql 终端 如何 清屏 吗 执行命令 systemclear 即可 接着 开始 新一轮 的 测试 上图 案例 事务 几次 查询 数据 都是 空 此时 事务 已经 成功 将 数据 插入 并且 提交 但 当 事务 几次 查询 数据 为 空 之后 进行 数据 插 入时 提示 主键 重复 再 来看 一个 案例 step 事务 开启 事务 step 事务 开启 事务 step 事务 查询 数据 只有 一条 数据 step 事务 添加 一条 数据 step 事务 查询 数据 为 一条 step 事务 提交 事务 step 事务 查询 数据 为 一条 step 事务 修改 namestep 猜想 一下 此时 表 内 数据 会 发生 什么 改变 此 案例 中 事务 始终 读取 数据 都是 一条 数据 但是在 修改 数据 时 影响 数据 行数 却是 再次 进行 查看 数据 时 竟然 出现 了 事务 添加 的 数据 这也 可以 看作 是 一种 幻 读 小结 通过 以上 俩 个 案例 得知 在 mysql 可 重 复读 隔离 级别 中 并没有 完全 解决 幻 读 问题 而 只是 解决 了 快 照读 下 的 幻 读 问题 而 对于 当前 读 的 操作 依然 存在 幻 读 问题 也就是说 mvcc 对于 幻 读 的 解决 是 不 彻底 的 四 再聊 当前 读 快照 读 在上 一 回合 中 快 照读 当前 读 已经 被 消 化了 为了 防止 消化不良 这里 再 简单 说明 一下 当前 读 所有 操作 都 加了 锁 并且 锁 之间 除了 共享 锁 都是 互斥 的 如果 想要 增 删改 查 时 都 需要 等待 锁 释放 才 可以 所以 读取 的 数据 都是 最新 的 记录 简单 来说 当前 读 就是 加了 锁 的 增 删改 查 不管 锁 是 共享 锁 排 它 锁 均为 当前 读在 mysql 的 innodb 存储 引擎 下 增 删改 操作 都会 默认 加 上锁 所以 增 删改 操作 默认 就为 当前 读 快 照读 快 照读 的 出现 旨在 提高 事务 并 发性 实现 基于 我 的 敌人 mvcc 简单 来说 快 照读 就是 不 加锁 的 非 阻塞 读 即 简单 的 select 操作 selectfromuser 在 innodb 存储 引擎 下 执行 简单 的 select 操作 时会 记 录下 当前 的 快照 读 数据 之后 的 select 会 沿用 第一次 快 照读 的 数据 即使 有 其它 事务 提交 也 不会 影响 当前 的 select 结果 这就 解决 了 不可重复读 问题 快照 读 读取 的 数据 虽然是 一致 的 但有 可能 不是 最新 的 数据 而是 历史数据 五 告诉 你们 吧 当前 读 的 情况下 我 是 被 nextkeylocks 干掉 的 第二 小节 中 得知 在 快 照读 下 由于 我 引发 的 问题 已经 被 mvcc 消灭 了 但是在 小节 三 进行 案例 测试 发现 在 当前 读 下 我 又 满血 复 活了 我 要是 那么 容易 被 干掉 还 怎么 被称为 打 不死 的 小强 这不是 闹笑话 呢 说 归 说 闹 归 闹 如果 mvcc 把 它 的 小弟 nextkeylocks 带上 那我 就 完了 就不 再像 灰 太 狼 说 经典语录 我 一 定会 回来 的 此时 就要 思考 一个 问 题在 innodb 存储 引擎 下 是 默 认给 快 照读 加 nextkeylocks 还是 说 需要 手动 加锁 通过 官方 文档 对于 nextkeylocks 的 解释 大致 意思 为了 防止 幻 读 innodb 使用 nextkeylock 算法 将 行 锁 recordlock 和 间隙 锁 gaplock 结合 在一起 innodb 行 锁在 搜索 或者 扫描 表 索引 时 会在 遇到 的 索引 记 录上 设置 共享 锁 或者 排 它 锁 因 此行 锁 实际 是 索引 记录 锁 另 外在 索引 记 录上 设置 的 锁 同样会 影响 索引 记录 之前 的 间隙 gap 即 nextkeylock 是 索引 记录 行 加上 索引 记录 之前 的 gap 上 的 间隙 锁定 并且 还给 了 一个 案例 当 innodb 扫描 索引 时 会将 id 大于 地 上锁 阻止 任何 大于 的 数据 添加到 这里 就 回答 了 上边 问 题在 innodb 下 解决 当前 读 产生 的 幻 读 问题 需要 手动 加锁 来 解决 再 来看 一个 案例 下图 为 此时 的 数据 情况 下图 的 这个 案例 就 解决 了 在 第三节 中 第一个 案例 的 幻 读 问题 step 事务 开启 事务 step 事务 开启 事务 step 事务 查询 id 为 的 这条 数据 并且 加 上排 它 锁 step 事务 添加 id 为 的 数据 并且 等待 事务 释放 锁 step 事务 添加 id 为 的 数据 添加 成功 step 事务 查询 当前 数据 step 事务 提交 事务 step 事务 报错 返回 主键 重复 问题 这个 案例 查询 的 索引 列 是 主键 并且是 唯一 的 此时 innodb 引擎 会对 nextkeylock 做 降级 处理 也 就是 只 锁定 当前 查询 的 索引 记录 行 而 不是 范围 锁定 案例 二 还是 使用 上边 的 数据 但是 这次 我们 进行 一次 范围 查找 此时 的 数据 为 查找 的 范围 为 大于 从 下图 可以 看出 当 事务 执行 添加 id 为 的 是 可以 添加 成功 的 但是 当 添加 id 时 需要 等待 此时 若 事务 不 提交 事务 事务 添加 id 为 的 这条 数据 就 执行 不成功 对于 上述 的 sql 语句 执行 返回 的 只有 这一 行 数据 此时 锁定 的 范围 为 所以说 id 为 的 可以 插入 id 为 或者 大于 的 都是 插入 不 了 的 以上 就是在 innodb 中 解决 幻 读 问题 最终 方案 六 幻 读 解决方案 为了 方便 大家 直观 了解 幻 读 的 解决方案 这里 咔 咔 进行 简单 的 总结 通过 mvcc 解决 了 快 照读 下 的 幻 读 问题 为什么 能 解决 在 第一次 执行 简单 的 select 语句 就 生 成了 一个 快照 并且在 后边 的 select 查询 都是 沿用 第一次 快 照读 的 结果 所以说 快 照读 查询 到 的 数据 有 可能是 历史数据 通过 nextkeylock 解决 当前 读 的 幻 读 问题 nextkeylock 是 recordlock 和 gaplock 的 结合 锁定 的 是 一个 范围 如果 查询 数据 为 索引 记录 行 则 只会 锁定 当 前行 也就是说 降级 为 recordlock 若为 范围 查找 时 就会 锁定 一个 范围 例如 上例 中 id 为 查询 大于 的 数据 则 会把 进行 范围 锁定 其它 事务 在 锁 未 释放 之前 是 无法 插入 的 从 官方 文档 还可 得知 如果 需要 验证 数据 唯一性 只需 要给 查询 加上 共享 锁 即可 也 就是 给 select 语句 加上 inlocksharemode 如果 返回 结果 为 空 则 可以 进行 插入 并且 插入 的 这个 值 肯定是 唯一 的 同样 也 可以 添加 nextkeylock 防止 其他人 同时 插入 相同 数据 小节 的 所有 案例 就是 使用 的 nextkeylock 从这一点 可以 得知 nextkeylock 是 可以 锁定 表 内 不存在 的 索引 根据 上述 结论 来看 如果 想要 检测 数据 唯一性 使用 共享 锁 那么 多个 事务 同时 开启 共享 锁 又 同时 添加 相同 的 数据 怎么办 会不会 出现问题 呢 明确地 说明 是 不会 的 如果 多个 事务 同时 插入 相同 数据 只会 有 一个 事务 添加 成功 其它 事务 会 抛出 错误 这个 就是 一个 新 的 概念 死锁 七 扩展 事务 id 是 在 何时 分配 的 在 本文 或者 其它 资料 中 都能 得到 一个 信息 就是 当 执行 一条 简单 的 select 语句 同时 也 会 生成 readview 虽然 快 照读 readview 都是 基于 事务 启动 的 前提下 但是 readveiw 是 通过 未 提交 事务 id 组成 的 那么 到底是 在 何时 分配 事务 id 的 呢 事务 的 启动 方式 有 两种 分别为 显示 启动 另一种 是 设置 autocommit 后 执行 select 就会 启动 事务 在 显示 启动 中最 简单 的 就 是以 begin 语句 开始 也 可以 使用 sta arttransaction 开启 事务 若 使用 开启 事务 也 可以 选择 开始 只读 事务 还是 读写 事务 看了 很多 资料 都说 当 开启 一个 事务 时会 分配 一个 事务 id 那么 来 验证 一下 是 这个 样子 的 吗 通过 上图 可以 看到 当 执行 一个 begin 语句 之后 查询 事务 id 是 空 的 也 就说 当 执行 begin 后 并没有 分配 trxid 那么 当 执行 begin 后 在 支持 dml 语句 呢 根据 文档 得知 执行 begin 命令 并不是 真正 开启 一个 事务 仅仅是 为 当前 线程 设定 标记 表示 为 显 式 开启 的 事务 所以 要 明白 对 数据 进行了 增 删改 查 等 操作 后 才 算 真正 开启 了 一个 事务 此时 会去 引擎 层 开启 事务 为什么 事务 id 差异 特别 大 上 图中 查询 了 当前 活跃 的 事务 id 但是 两个 事务 id 的 差异 特别 大 相信 很多 小伙伴 都 遇到过 这个 问题 有 问题 不 害怕 害怕 的 是 没有问题 事实上 在这 两条 数据 中 只有 是 真正 的 事务 id 那么 第二条 数据 中 的 id 是什么 呢 想知道 这个 数字 是什么 的 前提 是 知道 是 怎么 来 的 从 上图 可以 看出 当 执行 select 语句 后会 产生 一个 非常大 的 事务 id 那能 不能 理解为 这种 差异 非常大 的 事务 id 是 通过 快 照读 的 方式 才会 生成 的 接着 再 这个 事务 下面 在 执行 一个 insert 语句 然后 再查 看一下 事务 id 的 状态 不可思议 的 是 在 事务 中 先 执行 select 语句 然后 执行 insert 语句 事务 id 发 生了 变化 这是 什么原因 呢 经过 资料 查询 得知 当 执行 一个 简单 的 select 语句 时 被 称之为 只读 事务 为了 避免 给 只读 事务 分配 trxid 带来 不必要 的 开销 就 没有 对 其 分配 事务 id 只读 事务 没有 分配 undosegment 也 不会 分配 lock 锁 结构 本质上 只读 事务 的 trxid 的 值 就是 但是 为了 执行 或者 时 就会 通过 reinterpretcast trx maxtrxid 将 指针 转 换为 一个 字节 非 负 整数 然后 位 或 maxtrxid 就是 这么个 值 关于 这个 值 的 生成 过程 就 不用 再去 深究 了 只需 要知道 在 只读 事务 下 是 不会 分配 事务 id 而 查询 出来 的 这个 值 只是 为了 显示 而 存在 的 没有 实际意义 但是 当你 执行 查询 出来 的 事务 id 再 通过 查询 是 查不到 的 在 innodb 下 如果 事务 为 只读 事务 则不 会在 innodb 数据结构 中 显示 因此 你 是 看不到 的 坚持 学习 坚持 写作 坚持 分享 是 咔 咔 从业 以来 一直 所 秉持 的 信念 希望 在 偌大 互联网 中 咔 咔 的 文章 能带 给你 一丝丝 帮助 我 是 咔 咔 下期 见 