java 异构 类型 tornadovm 在 异构 硬件 上 运行 java 程序 java 异构 类型 几乎 所有 计算 系统 中都 存在 异构 硬件 我们 的 智能手机 包含 中央处理器 cpu 和 具有 多个 内核 的 图形 处理 单元 gpu 我们 的 笔记本电脑 很可能 包含 带有 集成 gpu 和 专用 gpu 的 多核 cpu 数据中心 正在 向 其 系统 添加 附加 的 现场 可编程 门阵列 fpga 以 加快 专业化 的 任务 同时 降低 能耗 而且 公司 正在 实施 自己 的 硬件 以 加速 专业 程序 例如 谷歌 开 发了 一种 处理器 用于 更快 地 处理 tensorflow 计算 称为 tensor 处理 单元 tpu 这种 硬件 专业化 和 硬件 加速器 的 最近 流行 是 由于 摩尔定律 的 终 结在 摩尔定律 中 由于 物理 限制 每个 新一代 的 cpu 不再 使 每 处理器 的 晶体管 数量 每 两年 增加一倍 因此 获得 更快 的 硬件 以 加速 应用程序 的 方法 是 通过 硬件 专业化 硬件 专业化 的 主要 挑战 是 可编程 性 每个 异构 硬件 很可能 都有 自己 的 编程 模型 和 自己 的 并行 编程 语言 诸如 openclsycl 和 mapreduce 框架 之类 的 标准 有助于 对 新 硬件 和 或 并行 硬件 进行 编程 但是 许多 并行 编程 框架 都是 为 低级 编程 语言 例如 fortranc 和 c 创建 的 尽管 这些 编程 语言 仍 被 广泛 使用 但 现 实是 工业界 和 学术界 倾向于 使用 更 高级 的 编程 语言 例如 javapythonrubyr 和 javascript 因此 现在 的 问题是 如何 使用 那些 高级 编程 语 言中 的 新 异构 硬件 当前 该 问题 有 两种 主要 解决方案 a 通过 外部 库 其中 用户 可能 仅限于 一组 众所周知 的 功能 b 通过 将 低层 并行 硬件 细节 公 开给 高层 程序 的 包装 器 例如 jocl 是 从 java 编程 opencl 的 包装 器 开发人员 需要 在其 中 了解 opencl 编程 模型 数据管理 线程 调度 等 但是 这些 新 的 并行 和 异构 硬件 的 许多 潜在用户 不一 定是 并行计算 的 专家 也许 需要 更 简单 的 解决方案 在 本 文中 我们 讨论 tornadovm 它是 openjdk 的 插件 它 使 开发人员 能够 在 异构 硬件 上 自动 透明地 运行 java 程序 而 无需 任何 有关 并行计算 或 异构 编程 模型 的 知识 tornadovm 当前 支持 多核 cpugpu 和 fpga 上 的 硬件加速 并且 能够 通过 在 以下 位置 在 多个 设备 之间 执行 代码 迁移 例 如从 多核 系统 到 gpu 来 动态地 使其 执行 适应 最佳 目标 设备 运行 tornadovm 是 由 曼彻斯特 大学 英国 开发 的 研究 项目 它是 完全 开源 的 可在 github 上 使 用在 本 文中 我们 概述 了 tornadovm 以及 程序员 如 何在 多核 cpu 和 gpu 上 自动 加速 摄影 过滤器 tornadovm 如何 工作 tornadovm 的 总体 思想 是 编写 或 修改 尽可能 少 的 代码 行 并在 加速器 例如 gpu 上 自动 执行 该 代码 tornadovm 透明地 管理 执行 内存 管理 和 同步 而 无需 指定 有关 要 运行 的 实际 硬件 的 任何 详细信息 tornadovm 的 体系结构 由 传统 的 分层 体系结构 与 微 内核 体系结构 组成 其中 核心 组件 是 其 运行时 系统 下图 显示 了 所有 tornadovm 组件 以及 它们 之间 如何 交互 的 高层 概述 在 最高级别 tornadovm 向 java 开发人员 公开 api 该 api 允许 用户 通过 在 异构 硬件 上 运行 它们 来 确 定要 加速 的 方法 该 编程 框架 的 一个重要方面 是 它 不会 自动检测 并行性 相反 它在 任务 级别 利用 并行性 其中 每个 任务 对 应于 一个 现有 的 java 方法 tornadovmapi 还 可以 创建 一组 任务 称为 任务 计划 相同 任务 时间表 与 任务 时间表 关联 的 所有 java 方法 内 的 所有 任务 都在 同一 设备 例 如在 同一 gpu 上 上 编译 和 执行 通过 将 多个 任务 方法 作为 任务 计划 的 一部分 tornadovm 可以 进一步 优化 主 主机 cpu 和 目标 设备 例如 gpu 之间 的 数据 移动 这是 由于 主机 和 目标 设备 之间 未 共享 内存 因此 我们 需 要将 数据 从 cpu 的 主 内存 复制到 加速器 的 内存 通常 通过 pcie 总线 这些 数据传输 确实 非常 昂贵 并且 可能 损害 我们 应用程序 的 端 到 端 性能 因此 通过 创建 一组 任务 如果 tornadovm 检 测到 某些 数据 可以 保留在 目标 设备 上 而 无需 与 所 执行 的 每个 内核 java 方法 与 主机 端 同步 则 可以 进一步 优化 数据 移动 还请 参见 您是 哪种 java 开发人员 参加 我们 的 java 测验 找出 答案 以下 代码 段 显示 了 如何 使用 tornadovm 编程 典型 的 mapreduce 计算 的 示例 sample 类 包含 三种 方法 一种 执行 矢量 加法 映射 的 方法 另一种 执行 矢量 加法 映射 另一种 计算 约简 减少 的 方法 最后 一种 创建 任务 计划 并 执行计划 的 方法 要 加速 的 方法 是 方法 图 和 归约 方法 请注意 用户 使用 诸如 parallel 和 reduce 之类 的 注释 扩充 了 序列 代码 这些 注释 用作 tornadovm 编译器 并行 化 代码 的 提示 最后 一个 方法 计算 创建 任务 计划 java 类 的 实例 并 指 定要 加速 的 方法 在下 一部分 中 我们 将 通过 完整 的 示例 详细 介绍 for for s task mapsamplemapabc task streamout output execute tornadovm 运行时 层 分为 两 个子 组件 任务 优化 器 和 字节 码 生成器 任务 优化 器 采用 任务 计划 中 的 所有 任务 并 分析 其中 的 数据 依赖 关系 数据流 运行时 分析 正如 我们 前面 提到 的 此 操作 的 目的 是 优化 跨 任务 的 数据 移动 一旦 tornadovm 运行时 系统 优 化了 数据传输 它就 会 生成 内部 特 定于 tornadovm 的 字节 码 这些 字节 码 对 开发人员 不可 见 它们 的 作 用是 协调 异构 设备 上 的 执行 在下 一个 块 中 我们 将 显示 内部 tornadovm 字节 码 的 示例 生成 tornadovm 字节 码 后 执行 引擎 将在 字节 码 解释 器 中 执行 它们 字节 码 是 简单 的 指令 可以 在内部 对 其 进行 重新 排序 以 执行 优化 例如 将 计算 与 通信 重叠 以下 代码 段 显示 了 为先 前 代码 段 中 所示 的 mapreduce 示例 生成 的 字节 码 的 列表 每个 任务 计划 都 包 含在 beginend 字节 码 之间 每个 字节 码 后面 的 数字 是 任务 计划 中所 有 任务 将 在其 上 执行 的 设备 但是 可以 在运 行 期间 随时 更改 设备 回想 一下 我们 正 在此 特定 的 任务 计划 中 运行 两个 任务 映射 方法 和 简化 方法 对于 每种 方法 或 任务 tornadovm 需要 预分 配 数据 并 执行 相应 的 数据传输 因此 tornadovm 执行 copyin 它 将为 只读 数据 例如 示例 中 的 数组 a 和 b 分配 和 复制 数据 并 通过 调用 以下 命令 为 输出 仅 写 变量 分配 设备 缓冲区 上 的 空间 alloc 字节 码 所有 字节 码 都有 其他 字节 码 可以 引用 的 字节 码 索引 bi 例如 由于 许多 字节 码 的 执行 是非 阻塞 的 因此 tornadovm 通过 运行 adddep 字节 码 和 要 等待 的 字节 码 索引 列表 来 增加 障碍 还请 参见 java 为什么 文本 块 值得 等待 然后 为了 运行 内核 java 方法 tornadovm 执行 字节 码 launch 第一次 执行 此 字节 码 时 tornadovm 将从 java 字节 码 编译 引用 的 方法 在 我们 的 示例 中 为 map 和 reduce 的 方法 到 openclc 由于 编译器 实际上 是 源 到 源 从 java 字节 码 到 openclc 需要 另一个 编译器 后者 的 编译器 是 每个 目标 设备 驱动程序 例如 用于 nvidia 的 gpu 驱动程序 或 用于 intelfpga 的 英特尔 驱动程序 的 驱动程序 的 一部分 它将 openclc 编 译为 二进制 文件 然后 tornadovm 将 最终 的 二进制 文件 存储 在其 代码 缓存 中 如果 任务 计划 被 重用 并 再次 执行 tornadovm 将从 代码 缓存 中 获取 优化 的 二进制 文件 从而 节 省了 重新 编译 的 时间 一旦 所有 任务 执行 完毕 tornadovm 通过 运行 copyoutblock 字节 码 将 最终 结果 复制到 主机 存储器 中 下图 显示 了 tornadovm 如何 执行 和 编译 从 java 到 opencl 的 代码 的 高级 表示 jit 编译器 是 曼彻斯特 大学 开发 的 opencl 的 graaljit 编译器 的 扩展 在内部 jit 编译器 为 输入 程序 构建 控制流程图 cfg 和数 据 流程图 dfg 这些 流程图 在 不同 的 编译 层 中进 行了 优化 在 tornadovmjit 编译器 中 当前 存在 三层 优化 a 与 体系结构 无关 的 优化 hir 例如 循环展开 恒定 传播 并行 循环 探索 或 并行 模式 检测 b 内存 优化 例如 mir 中 的 对齐 以及 c 依赖于 体系结构 的 优化 优化 代码 后 tornadovm 将 遍历 优化 的 图形 并 生成 openclc 代码 如下 图 右侧 所示 此外 执行 引擎 会 自动 处理 内存 并 保持 设备 缓冲区 分配给 目标 设备 和 主机 缓冲区 分配给 java 堆 之间 的 一致性 由于 编译 和 执行 由 tornadovm 自动 管理 因此 tornadovm 的 最终用户 不必 担心 内部 细节 测试 tornadovm 本节 显示 了 一些 如何 编程 和 运行 tornadovm 的 示例 作为 示例 我们 展示 了 一个 简单 的 程序 该 程序 如何将 输入 的 彩色 jpeg 图像 转 换为 灰度 图像 然后 我们 展示 如 何在 不同 的 设备 上 运行 它 并 评估 其 性能 本文 提供 的 所有 示例 均 可在 github 上 在线 获得 灰度 转换 java 代码 将 彩色 jpeg 图像 转 换为 灰度 的 java 方法 如下 for intiiltwi for intjjltsj rgbgtgt ampxffintred rgbgtgt ampxffintgreen rgbgtgt ampxffintblue rgbampxff intgraylevel redgreenblue intgray alphaltlt graylevelltlt graylevelltlt 对于 图像 中 的 每个 像素 都会 获得 alpha 红色 绿色 和 蓝色 通道 然后 将 它们 全部 组 合为 一个 值 以 显示 相应 的 灰色 像素 该 像素 最终 再次 存储 到 像素 的 图像 阵列 中 由于 该 算法 可以 并行 执行 因此 它是 使用 torandovm 进行 硬件加速 的 理想 选择 要 使用 tornadovm 编程 相同 的 算法 我们 首先 使用 parallel 批注 来 注释 可能 并行 运行 的 循环 tornadovm 将 检查 循环 并 分析 两次 迭代 之间 是否 没有 数据 依赖性 在 这种 情况下 tornadovm 将使 代码 专 用于 在 opencl 中 使用 d 索引 对 于此 示例 代码 如下 所示 for for rgbgtgt ampxffintred rgbgtgt ampxffintgreen rgbgtgt ampxffintblue rgbampxff intgraylevel redgreenblue intgray alphaltlt graylevelltlt graylevelltlt 请注意 我们 为 两个 循环 引 入了 parallel 此后 我们 需要 指示 tornadovm 加速 此 方法 为此 我们 创建 一个 任务 计划 如下 所示 s streamin imagergb task streamout imagergb blockingcall tsexecute 任务 计划 是 描述 所有 要 加速 的 任务 的 对象 首先 我们 传递 一个 名称 来 标识 任务 计 划在 本例 中 为 s 但可 以是 任何 名称 然后 我们 定义 要 流式 传 输到 输入 任务 的 java 数组 此 调用 向 tornadovm 表示 每次 调用 execute 方法 时 我们 都 希望 复制 数组 的 内容 否则 如果在 streamin 中 未指定 任何 变量 tornadovm 将为 任务 执行 所需 的 所有 变量 创建 一个 缓存 的 只读 副本 下一个 调 用是 任务 调用 我们 可以 在 同一 任务 计划 中 创建 任意 数量 的 任务 如前 一节 所述 每个 任务 都 引用 一个 现有 的 java 方法 任务 的 参数 如下 首先 我们 传递 一个 名称 在 本例 中 我们 将其 命名为 t 但也 可 以是 任何 其他 名称 然后 我们 传递 lambda 表达式 或 对 java 方法 的 引 用在 我们 的 例子 中 我们 从 java 类 image 中 传 递了 grayscale 方法 最后 我们 将 所有 参数 传 递给 该 方法 就像 其他 任何 方法 调用 一样 之后 我们 需 要向 tornadovm 指示 要与 主 机主 cpu 再次 同步 的 变量 在 我们 的 例子 中 我们 希望 用 加速 的 灰度 更新 同一 张 输入 的 jpeg 图像 在内部 此 调用 将 强制 opencl 中 的 数据 从 设备 移 动到 主机 并将 数据 从 设备 的 全局 内存 复制到 驻 留在 主机 内存 中 的 java 堆 这 四行 仅 声明 要 使用 的 任务 和 变量 但是在 程序员 调用 execute 方法 之前 不会 执行 任何 操作 创建 程序 后 我们 将 使用 标准 javac 对 其 进行 编译 在 tornadosdk 一旦 机器 上 安 装了 tornadovm 中 提供 了 实用程序 命令 以 使用 javac 进行 编译 并 设置 了 所有 类 路径 和 库 在运 行时 我们 使用 tornado 命令 实际上 它是 java 的 别名 具有 通过 java 虚拟机 jvm 运行 tornadovm 所需 的 所有 类 路径 和 标志 但是在 使用 tornadovm 运行 之前 让我们 检查一下 机器 中 可用 的 并行 和 异构 硬件 我们 可以 通过 使用 tornadovmsdk 中 的 以下 命令 来 查询 r openclintel r core tm r core tm r r 在这 台 笔记本电脑 上 我们 具有 和 如图所示 所有这些 设备 均与 opencl 兼容 并且 所有 驱动程序 均已 安装 因此 tornadovm 可以 考虑 所有 可 用于 执行 的 设备 请注意 在这 台 笔记本电脑 上 我们 有 两台 针对 intelcpu 的 设备 一台 使用 intelopencl 驱动程序 另一台 使用 amdopencl 驱动程序 用于 cpu 如果 未指定 任何 设备 tornadovm 将 使用 默认值 一要 使用 tornadovm 运行 我们 的 应用程序 我们 只需 键入 tornadoimage 为了 发现 我们 的 程序 在哪 台 设备 上 运行 我们 可以 使用 debug 标志 通过 tornadovm 查询 基本 调试 信息 如下 所示 available 这 意味着 我们 使 用了 nvidiagpu 笔记本电脑 中 可用 的 gpu 来 运行 此 java 程序 下面 发生 的 是 tornadovm 在运 行时 将 java 方法 grayscale 编译 到 opencl 中 并 使用 可用 的 opencl 支持 的 设备 运行 它在 这种 情况 下在 nvidiagpu 上 调试 模式 下 的 其他 信息 包括 运 行了 多少 线程 以及 它们 的 块 大小 本地 工作 大小 这 由 tornadovm 运行时 自动 确定 并且 取决于 应用程序 的 输入 大小 在 我们 的 例子 中 我们 使 用了 像素 的 输入 图像 到目前为止 我们 设法 使 java 程序 在 gpu 上 自动 透明地 运行 这 很棒 但是 性能 呢 我们 在 测试台 笔记本电脑 上 使用 的 是 intelcpuihq 使用 此 输入 图像 运行 顺序 代码 所 花费 的 时间 为 秒 在 gtxnvidiagpu 上 它 需要 秒 处理 相同 图像 的 速度 提高了 倍 还请 参见 jakartaee 过去 现在 和 未来 我们 还 可以 通过 传递 标志 来 更改 设备 以 在运 行时 运行 例如 以下 代码 片段 显示 了 如何 运行 tornadovm 以 使用 英特尔 集成 r r available 通过 在所 有 设备 上 运行 我们 得到 以下 加速 图 第一 栏 显示 的 是 在 多核 核 cpu 上 运行 的 基准 使用 java 顺序 代码 且 无 加速 运行 而 第二 栏 显示 了 tornadovm 相对于 基准 的 加速 最后 的 条 对 应于 集成 gpu 和 专用 gpu 上 的 加速 通过 使用 tornadovm 运行 此 应用程序 我们 可以 在 java 序 列上 获得 多达 倍 的 性能 提升 nvidiagpu 并且 通过 在 intel 集成显卡 上 运行 可以 达到 倍 的 性能 提升 请注意 在 多核 配置 中 tornadovm 是 超 线性 的 在 核 cpu 上 是 x 这是 因为 生成 的 openclc 代码 可以 利用 cpu 上 的 矢量 指令 例如 每个 内核 可用 的 avx 和 sse 寄存 器用 例 上 一节 显示 了 一个 简单 应用 的 示例 其中 加速 了 摄影 中非 常常 见 的 滤镜 但是 tornadovm 的 功能 超 出了 简单 程序 的 范围 例如 tornadovm 当前 可以 加速 机器 学习 和 深度 学习 应用程序 计算机 视觉 物理 模拟 和 财务 应用程序 tornadovm 已 用于 在 纯 java 的 gpu 上 加速 复杂 的 计算机 视觉 应用程序 kinectfusion 该 gpu 包含 约 k 行 java 代码 该 应用程序 使用 microsoftkinect 摄像机 记录 一个 房间 目标 是 实时 进行 d 空间 重建 为了 获得 实时 性能 必须 以 至少 每秒 帧 fps 的 速度 渲染 房间 原始 java 版本 可 达到 fps 而 运 行在 gtxnvidiagpu 上 的 tornadovm 版本 可 达到 fpskinectfusion 应用程序 的 tornadovm 版 本是 开源 的 可在 github 上 使用 exusltd 是 一家 总部 位于 伦敦 的 公司 目前 正在 通过 提供 患者 住院 再 住院 的 预测 来 改善 英国 nhs 系统 为此 exus 一直 在对 患者 的 数据 进行 关联 这些 数据 包含 其 个人资料 特征 和 医疗 状况 用于 预测 的 算法 是 一种 典型 的 逻辑 回归 具有 数百万 个 元素 作为 数据 集 到目前为止 exus 已 通过 tornadovm 将 k 患者 的 算法 训练 阶段 从 秒 纯 java 应用程序 缩短到 仅 秒 性能 提高了 倍 此外 他们 还 证明 通过 使用 万 患者 的 数据 集 tornadovm 的 执行 效率 提高了 倍 我们 还 尝 试了 通常 用于 物理 模拟 和 信号 处理 的 综合 基准 和 计算 例如 nbody 和 dft 在 这些 情况下 我们 使用 微 体系结构 的 速度 提高了 倍 而 使用 的 速度 提高了 倍 这些 类型 的 应用程序 需要 大量 计算 而 瓶颈 是 内核 处理 时间 因此 拥有 专门 用于 这些 类型 的 计算 的 功率 并行 设备 有助于 提高 整体 性能 tornadovm 的 现在 和 未来 tornadovm 当前 是 曼彻斯特 大学 的 一项 研究 项目 此外 tornadovm 是 欧洲 horizonedata 项目 的 一部分 该 项目 将 tornadovm 与 apacheflink 用于 批处理 和 流 数据处理 的 java 框架 集成 在一起 以 加快 异构 和 分布式 内存 集群 上 典型 的 映射 减少 操作 tornadovm 当前 支持 在 多种 设备 上 进行 编译 和 执行 包括 intel 和 amdcpunvidia 和 amdgpu 以及 intelfpga 我们 正在进行 一项 工作 以 也 支持 xilinxfpga 通过 此 选项 我们 旨在 涵盖 盖 所有 当前 的 云 提供商 产品 此外 我们 正在 集成 更多 的 编译器 和 运行时 优化 例如 使用 设备 内存 层 和 使用 虚拟 共享 内存 以 减少 总 执行时间 并 增加 总体 性能 摘 要在 本 文中 我们 讨论 了 tornadovm 它是 openjdk 的 插件 用于 加速 异构 设备 上 的 java 程序 首先 我们 描述 了 tornadovm 如 何在 异构 硬件 例如 gpu 上 编译 和 执行 代码 然后 我们 提供 了 一个 在 不同 设备 上 编程 和 运行 tornadovm 的 示例 其中 包括 多核 cpu 集成 gpu 和 专用 nvidiagpu 最后 我们 证明了 使用 tornadovm 开发人员 可以 在 保持 应用程序 完全 不依赖 硬件 的 情况下 实现 高性能 我们 相信 tornadovm 提供 了 一种 有趣 的 方法 其中 要 添加 的 代码 易于 读取 和 维护 同时 如果 系统 中 具有 并行 硬件 则 可以 提供 高性能 有关 tornadovm 技术 方面 的 更多 信息 可以 在 下面 找到 参考资料 和 异构 硬件 上 的 动态 应用程序 重新配置 在 第 届 虚拟 执行 环境 国际会议 论文集 vee 中美 国 纽约州 acm 电话 和 年 使用 编译器 片段 在 异构 硬件 上 利用 并行性 java 简化 案例 研究 在 第十届 acmsigplan 虚拟机 和 中间 语言 国际 研讨会 vmil 的 会议记录 中美 国 纽约州 纽约市 詹姆斯 克拉克 森 jamesclarkson 胡 安 富 莫 罗 juanfumero 米歇尔 帕 帕 第 米 特里 福 伊 沃 斯 s 扎 卡 克 foivoss 年 使用 graal 为 java 程序 开发 高性能 的 异构 硬件 在 第 届 国际 托管 语 言和 运行时 会议 论文集 manlang 中 acm 美国纽约 纽约 第 条 共 页 doihttpsdoiorg 与 juanfumero 的 和 mikellujn 异构 托管 运行时 系统 计算机 视觉 案例 研究 sigplan 不是 年月 doihttpsdoiorg 致谢 这项 工作 得 到了 欧盟 horizonedata 和 acticloud 资助 的 部分 支持 特别感谢 exus 的 geraldmema 报 告了 nhs 用 例 翻译 自 异构 类型 