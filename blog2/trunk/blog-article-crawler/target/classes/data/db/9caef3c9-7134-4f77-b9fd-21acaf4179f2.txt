技术 分享 innodb 排序 索引 的 构建 原创 管 长龙 译 作者 satyabodapati 从 mysql 开始 开发人员 改 变了 innodb 构建 二级 索引 的 方式 采用 自下而上 的 方法 而 不是 早期 版本 中 自上而下 的 方法 了 在这 篇文章 中 我们 将 通过 一个 示例 来 说明 如何 构建 innodb 索引 最后 我 将 解释 如何 通 过为 设置 更 合适 的 值 索引 构建 过程 在有 数据 的 表 上 构建 索引 innodb 中有 以下 几个 阶段 读取 阶段 从 聚 簇 索引 读取 并 构建 二级 索引 条目 合并 排序 阶段 插入 阶段 将 排序 记录 插入 二级 索引 在 版本 之前 mysql 通过 一次 插入 一条 记录 来 构建 二级 索引 这是 一种 自上而下 的 方法 搜索 插入 位置 从 树 的 根部 顶部 开始 并 达到 叶 页 底部 该 记录 插入 光标 指向 的 叶 页 上 在 查找 插入 位置 和 进 行业 面 拆分 和 合并 方面 开销 很大 从 mysql 开始 添加 索引 期间 的 插入 阶段 使用 排序 索引 构建 也 称为 批量 索引 加载 在这 种方法 中 索引 是 自下而上 构建 的 即 叶 页 底部 首先 构建 然后 非 叶 级别 直到 根 顶部 示例 在 这些 情况下 使用 排序 的 索引 构建 对于 最后 两个 用 例 alter 会 创建 一个 中间 表 中间 表 索引 主 要和 次要 使用 排序 索引 构建 构建 算法 在 级别 创建 页 还要 为此 页 创建 一个 游标 使用 级 别处 的 游标 插入 页面 直到 填满 页面 填满 后 创建 一个 兄弟 页 不要 插入 到 兄弟 页 为 当前 的 整页 创建 节点 指针 子 页 中 的 最小 键子 页码 并将 节点 指针 插入 上一级 父 页 在 较高 级别 检查 游标 是否 已 定位 如果 没 有请 为 该 级别 创建 父 页 和 游标 在 父 页 插入 节点 指针 如果 父 页 已 填满 请 重复 步骤 现在 插入 兄弟 页 并 使 游标 指向 兄弟 页 在所 有 插入 的 末尾 每个 级别 的 游标 指向 最 右边 的 页 提交 所有 游标 意味着 提交 修改 页面 的 迷你 事务 释放 所有 锁 存 器 为 简单 起见 上述 算法 跳 过了 有关 压缩 页 和 blob 外部 存储 的 blob 处理 的 细节 通过 自下而上 的 方式 构建 索 引为 简单 起见 假设 子 页 和 非子 页 中 允许 的 最大 记录 数 为 createtablet hello hello hello hello hello hello hello hello hello hello b innodb 将 主键 字段 追 加到 二级 索引 二级 索引 k 的 记录 格式 为 ba 在 排序 阶段 完成后 记录 为 初始 插入 阶段 让我们 从 记录 开始 在 级别 叶 级别 创建 页 创建 一个 到 页 的 游标 所有 插入 都将 转 到此 页面 直到 它 填 满了 箭头 显示 游标 当前 指向 的 位置 它 目前 位于 第 页 下一个 插入 将 转 到此 页面 还有 两个 空闲 插槽 因此 插入 记录 和 非常 简单 对于 下一 条 记录 页码 已满 前面 提到 的 假设 最大 记录 数 为 这 就是 步骤 页 填充 时 的 索引 构建 创建 一个 兄弟 页 页码 不要 插入 兄弟 页 在 游标 处 提交 页面 即 迷你 事务 提交 释放 锁 存 器 等 作为 提交 的 一部分 创建 节点 指针 并 将其 插入 到 当前 级别 的 父 页面 中 即在 级别 节点 指针 的 格式 子 页面 中 的 最小 键子 页码 第 页 的 最小 键 是 在 父 级别 插入 记录 级别 的 父 页 尚不 存在 mysql 创建 页码 和 指向 页码 的 游标 将 插入 第 页 现在 返 回到 级 并 创建 从 第 页 到 第 页 的 链接 反之亦然 级别 的 游标 现在 指向 兄弟 页 页码 为 将 插入 第 页 下一个 插入 和 很简单 它们 转到第 页 插入 记录 类似于 除了 父 页面 页面 编号 已经 存在 并且 它有 两个 以上 记录 的 空间 首 先将 节点 指针 插入 第 页 然后 将 记 录到 同级 页 中 插入 记录 和 很简单 因为 第 页 有 两个 空闲 插槽 下一个 插入 将 节点 指针 插入 级别 的 父 页 页码 mysql 在 级 创建 同级 页码 将 记录 插入 第 页 并将 光标 更改 为此 页面 以此类推 在上 面的 示例 中 数据库 在 级别 提 交到 第 页 在 级别 提 交到 第 页 我们 现在 有 了 一个 完整 的 btree 索引 它是 自 下 至上 构建 的 索引 填充 因子 全局变量 用于 设置 插入 btree 页 中 的 空 间量 默认值 为 表示 使用 整个 业 面 不包括 页眉 聚 簇 索引 具有 的 免除 项 在 这种 情况下 聚 簇 索引 也 空间 的 保持 空闲 即 的 空间 用于 未来 的 dml 值 意味着 mysql 使 用了 的 页 空间 填充 预留 于 未来 的 更新 如果 则没 有 剩余 空间 供 未来 插入 二级 索引 如果在 添加 索引 后 期望 表 上有 更多 的 dml 则 可能 导致 业 面 拆分 并 再次 合并在 这种 情况下 建议 使用 之间 的 值此 变量 还会 影响 使用 optimizetable 和 重新 创建 的 索引 也 不应该 设置 太低 的 值 例如 低于 因为 索引 会 占用 浪费 更多 的 磁盘空间 值 较低 时 索引 中 的 页数 较多 索引 统计 信息 的 采样 可能 不是 最佳 的 优化 器 可以 选择 具有 次优 统计 信息 的 错误 查询 计划 排序 索引 构建 的 优点 没有 页面 拆分 不包括 压缩 表 和合 并没有 重复 搜索 插入 位置 插入 不 会被 重做 记录 页 分配 除外 因此 重做 日志 子系统 的 压力 较小 缺点 alter 正在进行 时 插入 性能 降低 bug 但在 后续 版本 中 计划 修复 转 载于 