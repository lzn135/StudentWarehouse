面试官 你 说对 mysql 事务 很熟 那我 问你 10个 问题 微 信 搜 后端 技术 学堂 有 干货 本文 已 收录于 内含 原创 干货 文章 千本 计算机 电子 书本 leetcode 题解 各类 编程 资源 学习 关系 型 数据库 mysql 是 很好 的 切入点 大部分 人工 作 中用 惯了 crud 对 面试官 刨根问底 的 灵魂 拷问 你 还能 对答如流 吗 我们 有 必要 了解 一些 更深 层次 的 数据库 基础 原理 整 理了 面试 中 关于 mysql 事务 和 存储 引擎 个 你想 知道 的 都在 这里 什么 是 事务 事务 就是 一组 原子 性 的 sql 查询 或者说 一个 独立 的 工作 单元 如果 数据库 引擎 能够 成功地 对 数据库 应用 该 组 查询 的 全部 语句 那么 就 执行 该 组 查询 如果 其中有 任何 一条 语句 因为 崩溃 或 其他 原因 无法 执行 那么 所有 的 语句 都不会 执行 也就是说 事务 内 的 语句 要么 全部 执行 成功 要么 全部 执行 失败 事务 控制 语法 知道吗 begin 或 显 式 地 开启 一个 事务 二者 是 等价 的 提交 事务 并 使 已对 数据库 进行 的 所有 修改 成为 永久性 的 回 滚 会 结束 用户 的 事务 并 撤销 正在进行 的 所有 未 提交 的 修改 在 事务 中 创建 一个 保存 点 一个 事务 中 可以 有 多个 删除 一个 事务 的 保存 点 把 事务 回 滚到 标记 点 settransaction 用来 设置 事务 的 隔离 级别 innodb 存储 引擎 提供 事务 的 隔离 级别 有 和 serializable 用 通俗 的 语言 说说 你 理解 的 事务 用 银行业务 举个 栗子 用户 lemon 有 两 银行卡 一张 是 招商银行 cmbc 的 工资卡 另一 张 是 工商银行 icbc 的 储蓄卡 每月 号 发工资 都 要把 招行 卡 的 万 转到 建设银行 储蓄卡 账户 记住 这里 的 银行 缩写 后面 就是 对应 的 数据表 名称 你 要 记不住 我 给你 理 一 理 招商银行 cmbc 存 么 白痴 中国工商银行 icbc 爱 存 不存 中国建设银行 ccb 存 存 不 中国银行 bc 不存 中国农业银行 abc 啊 不存 民生银行 cmsb 存 么 sb 兴业 银行 cib 存 一百 国家开发银行 cdb 存 点 吧 汇丰银行 hsbc 还是 不存 这个 转账 的 操作 可以 简化 抽成 一个 事务 包含 如下 步骤 查询 cmbc 账户 的 余额 是否 大于 万 从 cmbc 账户 余额 中 减去 万 在 icbc 账户 余额 中 增加 万 以下 语句 对应 创 建了 一个 转账 事务 事务 的 acid 特性 是什么 acid 其实是 事务 特性 的 英文 首字母 缩写 具体 的 含义 是 这样 的 原子 性 atomicity 一个 事务 必须 被 视为 一个 不可分割 的 最小 工作 单元 整个 事务 中 的 所有 操作 要么 全部 提交 成功 要么 全部 失败 回 滚 对于 一个 事务 来说 不可能 只 执行 其中 的 一部分 操作 致 性 consistency 数据库 总是 从一 个 一致性 的 状态 转 换到 另外 一个 一致性 的 状态 在前 面的 例子 中 一致性 确保 了 即使 在 执行 第三 四条 语句 之间 时 系统 崩溃 cmbc 账户 中 也 不会 损失 万 不然 lemon 要 哭 死 因为 事务 最终 没有 提交 所以 事务 中所 做的 修改 也 不会 保 存到 数据库 中 隔离 性 isolation 通常 来说 一个 事务所 做的 修 改在 最终 提交 以前 对 其他 事务 是 不可 见 的 在前 面的 例子 中 当 执行 完 第三条 语句 第四条 语句 还未 开始时 此时 如果有 其他人 也 准备 给 lemon 的 cmbc 账户 存钱 那 他 看到 的 cmbc 账户 里 还是 有 万 的 持久性 durability 一旦 事务 提交 则 其所 做的 修改 就会 永久 保 存到 数据库 中 此时 即使 系统 崩溃 修改 的 数据 也 不会 丢失 持久性 是 个 有点 模糊 的 概念 因为 实际上 持久性 也 分 很多 不同 的 级别 有些 持久性 策略 能够 提供 非常 强 的 安全 保障 而 有些 则 未必 而且 不可 能有 能 做到 的 持久性 保证 的 策略 否则 还需要 备份 做什么 什么 是 脏 读 不可重复读 幻 读 脏 读在 事务 a 修改 数据 之后 提交 数据 之前 这时 另一个 事务 b 来 读取 数据 如果 不加 控制 事务 b 读 取到 a 修改 过 数据 之后 a 又对 数据 做了 修改 再 提交 则 b 读到 的 数据 是 脏 数 据此 过程 称为 脏 读 dirtyread 不可重复读 一个 事务 内在 读取 某些 数据 后 的 某个 时间 再次 读取 以前 读过 的 数据 却 发现 其 读出 的 数据 已经 发 生了 变更 或者 某些 记录 已经 被删 除了 幻 读 事务 a 在按 查询 条件 读取 某个 范围 的 记录 时 事务 b 又在 该 范围 内插 入了 新 的 满足 条件 的 记录 当 事务 a 再次 按 条件 查询 记录 时会 产生 新 的 满足 条件 的 记录 幻 行 phantomrow 不可重复读 与 幻 读 有 什么区别 不可重复读 的 重点是 修 改在 同一 事务 中 同样 的 条件 第一次 读 的 数据 和 第二次 读 的 数据 不一样 因为 中间 有 其他 事务 提 交了 修改 幻 读 的 重点 在于 新增 或者 删除 在 同一 事务 中 同样 的 条件 第一次 和 第二次 读出来 的 记录 数 不一样 因为 中间 有 其他 事务 提 交了 插入 删除 sql 的 四个 隔离 级别 知道吗 具体 是什么 解决 了 什么问题 说说看 sql 实现 了 四个 标准 的 隔离 级别 每一种 级别 都 规定 了 一个 事务 中所 做的 修改 哪些 在 事务 内 和 事务 间 是 可见 的 哪些 是 不可 见 的 低级 别的 隔离 级 一般 支持 更高 的 并发 处理 并 拥有 更低 的 系统 开销 各个 隔离 级别 可以 不同 程度 的 解决 脏 读 不可重复读 幻 读 隔离 级别 各有所长 没有 完美 的 解决方案 脱离 业务 场景 谈 具体 实施 都是 耍流氓 mysql 中 哪些 存储 引擎 支持 事务 mysql 中 innodb 和 ndbcluster 存储 引擎 提供 了 事务处理 能力 以及 其他 支持 事务 的 第三 引擎 什么 是 自动 提交 mysql 默认 采用 自动 提交 autocommit 模式 也就是说 如果 不是 显 式 地 开始 一个 事务 则 每个 查询 都被 当作 一个 事务 执行 提交 操作 对于 myisam 或者 内存 表 这些 事务 型 的 表 修改 autocommit 不会有 任何 影响 对 这类 表 来说 没有 commit 或者 rollback 的 概念 也 可以说是 相当于 一直 处于 autocommit 启用 的 模式 在 事务 中 可以 混合 使用 存储 引擎 吗 尽量 不要 再 同一个 事务 中 使用 多种 存储 引擎 mysql 服务器 层 不管 理 事务 事务 是 由 下层 的 存储 引擎 实现 的如 果在 事务 中 混合 使用 了 事务 型 和 非 事务 型 的 表 例如 innodb 和 myisam 表 在 正常 提交 的 情况下 不会有 什么问题 但 如果 该 事务 需 要回 滚 非 事务 型 的 表 上 的 变更 就 无法 撤销 这会 导致 数据库 处于 不一致 的 状态 这种 情况 很难 修复 事务 的 最终 结果 将 无法 确定 所 以为 每张 表 选择 合适 的 存储 引擎 非常重要 mysql 存储 引擎 类型 有 哪些 最 常用 的 存储 引擎 是 innodb 引擎 和 myisam 存储 引擎 innodb 是 mysql 的 默认 事务 引擎 查看 数据库 表 当前 支持 的 引擎 查询 结果 表 中 的 engine 字段 指示 存储 引擎 类型 innodb 存储 引擎 的 特点 和 应用 场景 innodb 是 mysql 的 默认 事务 引擎 被 设置 用来 处理 大量 短期 shortlived 事务 短期 事务 大部分 情况 是 正常 提交 的 很少 会 回 滚 更多 innodb 事务 模型 相关 参考 mysql 官方 手册 这里 贴 一下 链接 历史 现代 mysql 版本 中 的 innodb 在历史上 叫 innodbplugin 这个 mysql 插件 在年 被 开发 出来 直到 在 oracle 收购 了 sun 公司 后 发布 的 mysql 才 正式 使用 innodbplugin 替代 了 旧版本 的 innodb 至此 备胎 成功 转正 成为 mysql 的 御用 引擎 而 不再是 插件 你 看 一个 插件 都 这么 努力 特点 采用 多 版本 并发 控制 来 支持 高 并发 并且 实现 了 四个 标准 的 隔离 级别 通过 间隙 锁 nextkeylocking 策略 防止 幻 读 的 出现 引擎 的 表 基于 聚 簇 索引 建立 聚 簇 索引 对 主键 查询 有 很高 的 性能 不过 它 的 二级 索引 secondaryindex 非 主键 索引 中 必须 包含 主键 列 所以 如果 主键 列 很大 的话 其他 的 所有 索引 都会 很大 因此 若 表 上 的 索引 较多 的话 主键 应当 尽可能 的 小 另外 innodb 的 存储 格式 是 平台 独立 innodb 做了 很多 优化 比如 磁盘 读取 数据 方式 采用 的 可 预测 性 预 读 自动 在 内存 中 创建 hash 索 引以 加 速读 操作 的 自适应 哈希 索引 以及 能够 加速 插入 操作 的 插入 缓冲区 insertbuffer 等 innodb 通过 一些 机制 和 工具 支持 真正 的 热 备份 mysql 的 其他 存储 引擎 不支持 热 备份 要 获取 一致性 视图 需要 停止 对 所有 表 的 写入 而在 读写 混合 场景 中 停止 写入 可能 也 意味着 停止 读取 myisam 存储 引擎 的 特点 和 应用 场景 myisam 是 mysql 及 之前 的 版本 的 默认 的 存储 引擎 myisam 提供 了 大量 的 特性 包括 全文索引 压缩 空间 函数 gis 等 但 myisam 不支持 事务 和 行 级 锁 对于 只读 数据 或者 表 比较 小 可以 容忍 修复 操作 依然 可以 使 用它 特性 myisam 不支持 行 级 锁 而是 对 整 张 表 加锁 读取 时 会对 需要 读到 的 所有 表 加 共享 锁 写 入时 则 对表 加排 它 锁 但在 表 有 读取 操作 的 同时 也 可 以往 表 中 插入 新 的 记录 这 被称为 并发 插入 myisam 表 可以 手工 或者 自动 执行 检查 和 修复 操作 但是 和 事务 恢复 以及 崩溃 恢复 不同 可能 导致 一些 数据 丢失 而且 修复 操作 是 非常 慢 的 对于 myisam 表 即使是 blob 和 text 等长 字段 也 可以 基于 其 前个 字符 创建 索引 myisam 也 支持 全文索引 这是 一种 基于 分词 创建 的 索引 可以 支持 复杂 的 查询 如果 指定 了 delaykeywrite 选项 在 每次 修改 执行 完成 时 不会 立 即将 修改 的 索引 数据 写入 磁盘 而是 会 写到 内存 中 的 键 缓冲区 只有 在 清理 键 缓冲区 或者 关闭 表 的 时候 才会 将 对应 的 索引 块 写入 磁盘 这种 方式 可以 极大 的 提升 写入 性能 但是在 数据库 或者 主机 崩溃 时会 造成 索引 损坏 需要 执行 修复 操作 innodb 与 myisam 对比 说了 这么多 估计 看 一眼 也 没 记住 给你 一张 表 简单 罗列 两种 引擎 的 主要 区别 如 下图 其他 存储 引擎 mysql 还 支持 其他 一些 存储 引擎 比如 memory 引擎 ndb 集群 引擎 csv 引擎 由于 这些 引擎 没有 上述 innodb 和 myisam 常用 这里 不作 介绍 感兴趣 趣 可以 去 翻 mysql 文档 了解 这里 同样 给出 官方 链接 再说 两句 这一 篇 是 mysql 基础 篇 我 力求 用 通俗易懂 和 图表 结合 的 形式 给 大家 梳理 这块 知识 越是 基础 和 底层 的 知识 越 容易 被 考察 掌握 程度 以上 知识点 都可 能成为 面试 中 的 一个 考察 点 相信 看完 对 mysql 事务 和 存储 引擎 应该有 一个 比较 完整 的 理解 最后 感谢 各位 的 阅读文章 的 目的 是 分享 对 知识 的 理解 若 文中 出现 明显 纰漏 也 欢迎 指出 我们 一起 在 探讨 中 学习 看下 我 写 的 其他 精彩文章 超级 干货 我 画了 张 图 帮你 搞懂 linux 内存 管理 能 回 答出 这个 问题 说明 你 真的 懂了 mysql 事务 图解 高频 面试 知识点 面试官 问我 高 并发 服务 模型 哪家 强 图解 一致性 哈希 算法 全 小区 局域网 最 通俗易懂 盘点 数据结构 中 的 那些 树 面试 再也 难不倒 我 资深 程序员 出了 bug 不用 慌 告诉 你 分析 linux 进程 的 个 方法 面试 造 飞机 系列 看 架构师 如何 设计 微 服务 接口 手把手 教你 配置 vscode 远程 开发工具 工作效率 提升 倍 图解 后台 开发 必备 技能 进程 线程 协 程 的 这 几个 特点 你 不得 不知 非常 详细 的 linuxcc 学习 路线 总结 人在 鹅 厂 刚 拿 offer 我 用 大数 据分析 了 一线 城市 多 份 岗位 招聘 需求 告诉 你 如何 科学 找工作 mysql 为什么 要 选择 b 树 做 索引 我 画了 张 图 给你 讲 明白 坚持 原创 真心 不易 点 赞 关注 支持 一下 吧 可以 微 信 搜索 公众 号 后端 技术 学堂 回复 获取 本 计算机 电子书 回复 进 群 拉 你 进 读者 技术交流 群 本文 已 收录于 内含 原创 干货 文章 千本 计算机 电子 书本 leetcode 题解 各类 编程 资源 文章 每周 持续 更新 我们 下期 见 