mysql 内存 管理 内存 分配器 和 操作系统 当 用户 使用 任何 软件 包括 mysql 碰到 内存 问题 时 我们 第一 反应 就是 内存 泄漏 正如 这篇 文章 所示 其实 并不 总是 这样 这篇 文章 阐述 一个 关于 内存 的 链接 链接 所有 percona 所 支持 的 客户 都有 获得 bug 修复 的 资格 但 他们 也有 不同 的 选择 比如 vip 客户 在 软件 补丁 正式 发布 之前 就可以 获得 hotfiix 版本 高级 客户 甚至 不需要 使用 percona 的 软件 我们 也 可 以为 他们 把 补丁 推到 上游 但 对于 与 percona 产品 来说 所有 支持 等级 都 有权 得到 bug 修复 即便如此 这 并不 意味着 我们 会 修复 所有 的 意外 情况 即使 我们 接受 这种 情况 为 一个 有效 bug 做出 这样 的 决定 的 原因 之一 可能是 这个 意外 情况 虽然 很 明 确是 错误 的 但 对于 percona 产品 本身 来说 确实 一个 产品 需求 这个 报告 阐述 了 一种 情况 当 访问 innodb 的 全文索引 的 时候 会 导致 内存 使用量 增长 这种 情况 出现在 一些 全文索引 的 查询 内存 会 持续增长 直到 达到 最大值 并且 很长 时间 不会 释放 来自 percona 工程 团队 的 yurasorokin 研究 表明 这种 情况 并不 属于 内存 泄漏 范畴 memblockt 当 innodb 解析 一个 全文 查询 时 它 会在 函数 中 创建 一个 内存 堆 这个 堆 可能 增长到 m 另外 这个 过程 还会 使 用到 大量 非 连续 块 memblockt 进而 产生 的 内存 碎片 在 函数 出口 这些 内存 堆 会被 释放 innodb 会为 其 分配 的 每一个 块 做 这个 操作 在 函数 执行 结束时 调用 一个 内存 分配器 库 中 的 free 操作 比如 malloc 或者 jemalloc 从 mysql 本身 来看 这都是 没问题 的 不存在 内存 泄漏 然而 free 函数 被 调 用时 确实 应该 释放 内存 但不 需要 将其 返回 给 操作系统 如果 内存 分配器 发现 这些 内存 块 马上 还需 要被 用到 则会 将 他们 保留住 继续 用于 mysqld 进程 这就 解释 了 为什么 mysqld 在 完成 工作 及 释放 内存 都 结束 后 还会 占用 大量 内存 这个 在 实际 生 产中 并不是 一个 大问题 按 道理 不应该 造成 任何 事故 但是 如果 你 需要 更 快地 将 内存 返回 给 操作系统 你 可以 尝试 非传统 的 内存 分配器 类似 jemallolc 它被 证明 可以 解决 pslt 链接 gt 的 问题 另一个 改善 内存 管理 的 因素 是 cpu 内核 数量 在 测试 中 cpu 核 数 越多 内存 返回 给 操作系统 的 速度 会 越快 这 可能是 你 拥有 多个 cpu 而其 中一 个 可 专门 用作 内存 分配器 释放 内存 给 操作系统 正如 我们 的 工程师 yurasorokin 所 发现 的 一样 下面 两点 阐述 了 innodb 全文索引 的 早期 实现 引 入了 这个 缺陷 版本 mysql 最早 对 innodbwl 全文索引 功能 引入 的 介绍 innodb 全文 搜索 支持 实现 wlinnodb 全文 搜索 支持 与 合并 也 存在 同样 的 问题 问题 修复 方法 我们 有 两种 方法来 修复 这个 问题 修改 innodb 全文索引 的 实现 使用 自定义 内存 库 例如 jemalloc 这两种 方法 都有 各自 的 优缺点 方法 意味着 我们 引 入了 与 软件 上游 不 兼容性 的 风险 这 可能会 导致 新版 版本 中 出现 未知 的 错误 也 意味着 彻底 重写 innodb 全文索引 部分 代码 这在 用户 们 使用 的 ga 版本 中 是 有 风险 的 链接 方 法则 意味着 我们 可能会 命中 一些 jemalloc 库 中 专门 为 性能 设计 但 不是 最 安全 的 内存 分配 的 因此 我们 不得 不在 这两个 并不 完美 的 方法 中 选择 一个 鉴于 方法 一 可能 导致 percona 服务 与 上游 的 不 兼容 我们 更 倾向于 用 方法 二来 解决问题 并 期待着 上游 修复 这个 bug 结论 如果 发现 mysqld 进程 占用 内存 很高 并不 代表 一 定是 内存 泄漏 我们 可以 在 中 使用 内存 检测 来 了解 进程 是 如何 使用 已 分配 的 内存 也 可以 尝试 替换 内存 库 来 更好 地 处理 内存 分配 与 释放 关于 ldreload 如何 配置 请 查阅 mysql 用户手册 对应 页面 mysqldsafelt 链接 gt 和 usingsystemlt 链接 gt 链接 链接 链接 链接 链接 链接 链接 