设计 一个 简易 的 引导 任务 框架 2 4.23 粉丝 赠书 今天是 世界 读书 日 公众 号 向 支持 的 小伙伴 们 送出 下面 本 技术 图书 三 选 一 参与 方式 本文 点 赞 留言 必须 超过 字 以及 你 想要 的 图书 名字 参与 活动 积 赞 最多 的 前 名 读者 将会 获得 赠书 三 选 一 活动 截止 时间 明天 晚 上点 请 获奖 读者 通过 公众 号 后台 发送 截图 和您 的 快递 联系方式 领取 赠书 小时 未来 领取 的 视为 放弃 设计 一个 简易 的 引导 任务 框架 前文 导 读上 一篇 分析 了 如何 定位 节点 如何 显示 节点 遮罩 以及 节点 事件 的 确认 原理 和 方法 是 有 了 但 要将 整个 逻辑 链条 串连 起来 还需要 下 一翻 功夫 编 写了 一个 简单 的 引导 任务 框架 想 仅 通过 json 配置 的 方式 完成 上述 步骤 任务 的 执行 实现 一个 配置 式 可编程 的 引导 框架 期望 的 是 让 非 程序 人员 经过 简单 的 学习 也 能 实现 引导 内容 的 制作 我们 先看 一个 任务 配置 案例 进入 商店 点击 主 界面 主页 按钮 点击 主 界面 设置 按钮 下面 是 按 此 配置 执行 的 效果 引导 框架 串联 异步 引导 步骤 前面 讲过 一个 引导 步骤 中 节点 定位 函数 godguidefind 是 通过 回 调 函数 异步 返回 目标 节点 用户 对 目标 节点 的 点击 确定 也是 异步 的 因此 任务 中 的 每一个 step 都是 异步 的 为了 方便 对 流程 的 异步 控制 在这里 使 用了 async 这个 三方 库 如果 你 不习惯 也 可以 更 换为 你 熟悉 的 异步 编程 方式 首先 我们 看看 任务 配置 中 的 steps 异步 串行 处理 run 串行 处理 steps 数组 中 的 每一项 目 元素 asynceachseries thistasksteps stepcb gtprocessstep 是 一个 异步 函数 通过 回 调 通知 step 处理完毕 thisprocessstep stepcb gtthistasksteps 中所 有步骤 处理 完成 关闭 引导 thistasknull 引导 结束 隐藏 遮罩 手指 节点 thisfinger asynceachseries 是 将 steps 数组 中 的 元素 依次 迭代 处理 具体 的 步骤 处理 我们 封 装在 引导 类 的 thisprocessstep 成员 函数 中 当 steps 数组 中所 有步骤 执行 完毕 asynceachseries 最后 一个 回 调 函数 被 触发 退出 引导 状态 引导 步骤 步骤 生命周期 回 调 与 步骤 指令 上面 是 控制 的 是 引导 整体 流程 我们 再 深入 到 thisprocessstep 函数 processstep stepcallback asyncseries 步骤 开始 stepstart cb thiscb cb 步骤 指令 stepcommand cb step gtcb stepdelaytime 步骤 结束 stepend cb thiscb cb callback 步骤 生命周期 回 调 asyncseries 帮助 我们 串行 执行 多个 异步 函数 这里 为 step 设计 了 onstartonend 两个 生命周期 回 调 分别 在上面 stepstart 和 stepend 中 执行 我们 可以 在这 两个 函数 中 做 一些 初始化 条件 检查 等 异步 等待 操作 例 如在 onstart 中 等待 玩家 等级 达到 多少级 或 某个 事件 发 生在 onend 中 等待 服务器 返回 某个 消息 操作 后 等待 某个 动画 的 完成 可以 通过 监听 事件 进行 确认 下面 代码 是 模拟 道具 购买 的 引导 实现 可以 具体 了解 到 onstartonend 的 使用方法 stepsdesc 级 提示 购买 道具 步骤 开始 onstart callback letobj 监听 玩家 等级 变化 ccdirectoron playerlvup player gt 到达 级 显示 商店 界面 if playerlvgt ccdirectoremit showshop 移除 事件 监听 obj 执行 回 调 执行 步骤 指令 callback obj 步骤 指令 定位 商店 界面 中 的 购买 按钮 当 玩家 点击 购买 按钮 进入 onend 事件 回 调 onend callback 使用 网络 代理 模块 监听 指定 网络 事件 netproxyonce messagebuyitem msg gt 事件 发生 执行 callback 回 调 步骤 结束 callback 如果 游戏 比较简单 onstart 和 onend 不是 必须 的 通过 step 上 delaytime 属性 可以 做 简单 的 延时 控制 同样 你 也 可以 将 游 戏中 增加 事件 网络 消息 的 广播 编写成 step 配置 中 的 command 指令 以 降低 配置 的 复杂度 步骤 指令 使用 step 指令 可以 让 步骤 配置 简化 特别是 ui 的 点击 引导 步骤 的 异步 处理 过程中 是 关键 因为 经常 刚 一 进入 某个 场景 时 可能 需要 定位 的 节点 还未 准备好 未 创建 或在 动画 运动 过程中 我们 又 不想 每个 步骤 都去 写 onstart 因此 步骤 上 提供 了 一个 delaytime 的 属性 以 延迟 step 指令 的 执行 这里 实现 了 两个 指令 locator 和 finger 他们 的 本质 都是 异步 执行 的 函数 中 在对 指令 函数 的 调用 看 下面 代码 godcommand 处理 步骤 中 的 指令 cb cmd thislog 执行 步骤 stepdesc 指令 stepcommandcmd cmd thisstep gtthislog 步骤 stepdesc 指令 stepcommandcmd 执行 完毕 cb elseccerror 执行 步骤 stepdesc 指令 stepcommandcmd 不存在 这里 将 指令 函数 编 写在 了 名为 godcommandjs 文件 中 向 指令 函数 传入 当前 引导 对象 和 step 配置 对象 下面 看 定位 指令 的 实现 letgodcommand 定位 节点 locator 取出 指令 参数 调用 引导 类 提供 的 定位 节点 godguidefind args node gt 设置 目标 节点 用于 遮罩 显示 和 点击 放行 点击 确认 nodeonce gtcclog 节点 被 点击 调用 callback 任务 完成 callback 可以 看出 这里 又是 一系列 的 回 调 从 step 中 获取 参数 调用 godguidefind 定位 节点 目标 节点 定位 成功 使用 nodeonce 注册 临时 触摸 监听 当 目标 节点 触摸 事件 发生 执行 locator 输入 的 callback 回 调 指令 完成 需要 注意 任务 完成 时 一 定要 执行 callback 不然 无法 继续 流程 有 了 该 指令 函数 就可以 在 任务 配置文件 中使 用了 使用 方式 desc 点击 主 界面 主页 按钮 中 的 args 参数 由 指令 函数 自行 解释 指令 设计 实现 手指 动画 指令 我们 可以 根据 自己 游戏 的 业务 需求 设计 步骤 指令 上 一 小节 只是 实现 了 节点 的 定位 并没有 手指 动画 在前 面的 基础上 我们 为 节点 定位 增加 一个 手指 动 画在 godguide 预制 体 上 增加了 一个 手指 预制 体 的 属性 你 可以 根据 自己 的 美术 风格 任意 更换 手指 提示 的 表现 看 下图 手指 预制 体 编辑 界面 注意 godfinger 预制 体 锚 点 设置 在 了 手指 指尖 位置 手指 动画 提示 可能 比 遮罩 还 常用 因此 将 手指 动画 的 调用 封 装在 了 godgruid 组件 代码 中 提供 了 一个 fingertonode 的 函数 代码 如下 fingertonode nodecb 手指 节点 不存在 直 接回 调 if thisfinger cb 转换 节点 位置 nodeposition p move 动作 letdurationpsub mag durationp gtcb 完成 回 调 movetocallfunc sequnce 手指 动画 很简单 就是 一个 moveto 的 动作 需要 注意 的 是 节点 坐标 转换 和 动作 完成 回 调 下面 是 finger 指令 的 实现 letgodcommand 定位 节点 locator 定位 节点 显示 一个 手指 动画 finger 定位 节点 godguidefind args node 手指 动画 node gt 点击 确认 nodeonce gtcclog 节点 被 点击 任务 完成 callback 其实 没什么 东西 就在 前面 locator 函数 的 基础上 增加了 的 调用 指令 设计 文本 提示 在 引导 流程 中 更为 常规 的 做法 是 手指 动画 提示 文本 读者 可以 思考 一下 如何 设计 一个 text 的 指令 我们 以 测试 驱动 的 方式 先 给出 引导 配置 stepsdesc 文本 提示 欢迎 来到 xxx 游戏 desc 点击 主 界面 主页 按钮 text 指令 的 参数 是 一个 数组 可接受 两种 类型 文本 字符串 直接 显示 即可 语言 配置 id 有些 游戏 支持 多国 语言 在此 直接 配置 语言 id 同样 我们 使用 异步 控制 串行 逐一 输出 args 中 的 文 本当 玩家 点击 屏幕 时 输出 下一 条 文本 这里 就 不在 帖 出 代码 了 小结 step 和 指令 都是 可 扩展 可编程 的 在 实际 的 项 目中 我们 可能 需要 根据 具体 业务 需求 设计 出 更多 的 指令 方便 引导 任务 的 配置 例如 scrollview 列表 滑动 指令 节点 关闭 指令 玩家 等级 变化 指令 玩家 过关 指令 等等 指令 的 设计 主 要是 对 事件 的 监听 和 异步 流程 的 控制 下一次 我们 再 给 大家 介绍 关于 自动化 的 实现 godguide 框架 已经 上 架 cocosstore 而且 最近 开发者 们 又 来上 新 了 一大堆 好玩 有趣 有价值 的 内容 点击 阅读 原文 来看 看吧 粉丝 福利 快来 参与 吧 参与 方式 本文 点 赞 留言 必须 超过 字 以及 你 想要 的 图书 名字 参与 活动 积 赞 最多 的 前 名 读者 将会 获得 赠书 三 选 一 活动 截止 时间 明天 晚 上点 请 获奖 读者 通过 公众 号 后台 发送 截图 和您 的 快递 联系方式 领取 赠书 小时 未来 领取 的 视为 放弃 