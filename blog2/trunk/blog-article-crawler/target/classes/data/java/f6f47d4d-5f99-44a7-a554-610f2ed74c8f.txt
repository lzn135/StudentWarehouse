全网 最 硬核 redis 高频 面试题 解析 2021年 最新版 前言 最近 囧 辉 发现 自己 的 java 学习 交流 群 里 有 不少 同学 已经 悄悄的 入 职 了 携 程 美 团 阿里 菜鸟 等 大厂 有 不少 同学 也 在 积极 准备 大厂 面试 中 从 聊天 中 可以 看得出来 大家 都 信心 满满 其中有 一个 同学 我 印象 特别 深刻 因为 我 经常 晚上 发 文章 然后 隔天 早上 起来 就看 到他 的 点 赞 了 看得出来 是 有 认真 在看 的 同学 最近 他 已经 入 职 阿里 菜鸟 了 可以说是 悄悄的 努力 惊艳 所有人 的 典范 希望 大家 都能 像他 一样 早日 拿下 大厂 offer 回归 本文 对于 redis 在 面试 中 的 重要 程度 一句话 描述 就是在 当前 java 后端 面试 中所 有 框架 中间件 中被 问到 频率 最高 的 本文 按 bat 面试 标准 给出 解析 有些 题 你 阅读 起来 可能会 很 吃力 建议 收藏 反复 学习 希望 在这 金 三 银 四 的 日子 里 祝你 一臂之力 拿下 大厂 offer 面试 系列 我 自己 前前后后 加起来 总共 应该 参 加了 不下 四五 十次 的 面试 拿 到过 几乎 所有 一线 大厂 的 offer 阿里 字节 美 团 快手 拼 多多 等等 每次 面试 后 我 都 会将 面试 的 题目 进行 记录 并 整 理成 自己 的 题库 最近 我 将 这些 题目 整理出来 并按 大厂 的 标准 给出 自己 的 解析 希望 在这 金 三 银 四 的 季节 里 能 助你 一臂之力 面试 文章 持续 更新 中 内容 链接 地址 面试 经验 分享 天 从 小厂 到 入 职 阿里 两年 java 开发 工作经验 面试 总结 年 java 经验 阿里 网易 拼 多多 面试 总结 心得体会 年 java 经验 字节 美 团 快手 核心 部门 面试 总结 真 题 解析 复习 个月 拿下 美 团 offer 我 都 做了 些 啥 如何 准备好 一场 大厂 面试 简历 如何写 一份 让 hr 眼前一亮 的 简历 附 模板 offer 选择 跳槽 如何 选择 一家 公司 java 基础 java 基础 高频 面试题 年 最新版 一道 有意思 的 初始化 面试题 集合 hashmapjava 集合 框架 高频 面试题 年 最新版 面试 阿里 hashmap 这一 篇 就 够了 并发 编程 面试 必 问 的 线程 池 你 懂 了吗 面试 必 问 的 cas 你 懂 了吗 mysql 面试 必 问 的 mysql 你 懂 了吗 mysqlmvcc 核心 原理 解析 核心 源码 spring 面试 必 问 的 spring 你 懂 了吗 mybatis 面试题 mybatis 中 的 dao 接口 和 xml 文件 里 的 sql 是 如何 建立 关系 的 redis 本文 jvmjava 虚拟机 面试题 精选 二 java 虚拟机 面试题 精选 一 分布式 面试 必 问 的 分布式 锁 你 懂 了吗 算法 位图 法 判断 一 个数 是否 在 亿个 整数 中 正文 redis 是 单线程 还是 多线程 这个 问题 应该 已经 看到过 无数次 了 最近 redis 出来 之后 又被 翻出 来了 redis 之前 redis 是 完全 单线程 的 redis 时 redis 引 入了 多线程 但是 额外 的 线程 只是 用于 后台 处理 例如 删除 对象 核心 流程 还是 完全 单线程 的 这 也是 为什么 有些人 说是 单线程 的 因为 他们 指的是 核心 流程 是 单线程 的 这边 的 核心 流程 指的是 redis 正常 处理 客户端 请求 的 流程 通常 包括 接收 命令 解析 命令 执行命令 返回 结果 等 而在 最近 redis 版本 又一次 引 入了 多线程 概念 与 不同 的 是 这次 的 多线程 会 涉及到 上述 的 核心 流程 redis 中 多线程 主要 用于 网络 io 阶段 也 就是 接收 命令 和 写回 结果 阶段 而在 执行命令 阶段 还是 由 单线程 串行 执行 由于 执 行时 还是 串行 因此 无需 考虑 并发 安全问题 值得注意 的 时 redis 中 的 多线程 组 不会 同时 存 在读 和 写 这个 多线程 组 只会 同时 读 或者 同时 写 redis 加入 多线程 io 之后 处理 命令 的 核心 流程 如下 当 有 读 事件 到 来时 主 线程 将该 客户端 连接 放到 全局 等 待读 队列 读取 数据 主 线程 将 等 待读 队列 的 客户端 连接 通过 轮询 调度 算法 分配给 io 线程 处理 同时 主 线程 也 会 自己 负责处理 一个 客户端 连接 的 读 事件 当 主 线程 处 理完 该 连接 的 读 事件 后会 自旋 等待 所有 io 线程 处理完毕 命令 执行 主 线程 按照 事件 被 加入 全局 等 待读 队列 的 顺序 这边 保证 了 执行 顺序 是 正确 的 串行 执行 客户端 命令 然后 将 客户端 连接 放到 全局 等待 写 队列 写回 结果 跟 等 待读 队列 处理 类似 主 线程 将 等待 写 队列 的 客户端 连接 使用 轮询 调度 算法 分配给 io 线程 处理 同时 自己 也 会 处理 一个 当 主 线程 处理完毕 后会 自旋 等待 所有 io 线程 处理完毕 最后 清空 队列 大致 流程图 如下 为什么 redis 是 单线程 在 redis 之前 redis 的 核心 操作 是 单线程 的 因为 redis 是 完全 基于 内存 操作 的 通常情况下 cpu 不会是 redis 的 瓶颈 redis 的 瓶颈 最有 可能是 机器 内存 的 大小 或者 网络带宽 既然 cpu 不会 成为 瓶颈 那就 顺理成章 地 采用 单线程 的 方案 了 因为 如果 使用 多线程 的话 会 更 复杂 同时 需要 引入 上下文切换 加锁 等等 会 带来 额外 的 性能 消耗 而 随着 近些年 互联网 的 不断发展 大家 对于 缓存 的 性能 要求 也 越来越 高了 因此 redis 也 开始 在 逐渐 往 多线程 方向 发展 最近 的 版 本就 对 核心 流程 引 入了 多线程 主要 用于 解决 redis 在 网络 io 上 的 性能 瓶颈 而 对于 核心 的 命令 执行 阶段 目前 还是 单线程 的 redis 为什么 使用 单 进程 单线程 也 很快 主要有 以下几点 基于 内存 的 操作 使 用了 io 多路复用 模型 selectepoll 等 基于 reactor 模式 开 发了 自己 的 网络 事件 处理器 单线程 可以 避免 不必要 的 上下文切换 和 竞争 条件 减 少了 这方 面的 性能 消耗 以上 这 三点 是 redis 性能 高 的 主要原因 其他 的 还有 一 些小 优化 例如 对 数据结构 进行了 优化 简单 动态 字符串 压缩 列表 等 redis 在 项 目中 的 使用 场景 缓存 核心 分布式 锁 setlua 脚本 排行榜 zset 计数 incrby 消息 队列 stream 地理位置 geo 访客 统计 hyperloglog 等 redis 常见 的 数据结构 基础 的 种 string 字符串 最 基础 的 数据类型 list 列表 hash 哈希 对象 set 集合 sortedset 有序 集合 set 的 基础上 加了 个 分值 高级 的 种 hyperloglog 通常 用于 基数 统计 使用 少量 固定 大小 的 内存 来 统计 集合 中 唯一 元素 的 数量 统计 结果 不是 精确 值 而是 一个 带有 标准差 standarderror 的 近似值 所以 hyperloglog 适用于 一些 对于 统计 结果 精确度 要求 不是 特别高 的 场景 例如 网站 的 uv 统计 georedis 版本 的 新 特性 可以 将 用户 给定 的 地理位置 信息 储存起来 并 对 这些 信息 进行 操作 获取 个 位置 的 距离 根据 给定 地理位置 坐标 获取 指定 范围内 的 地理位置 集合 bitmap 位图 stream 主要 用于 消息 队列 类似于 kafka 可以 认为是 pubsub 的 改进版 提供 了 消息 的 持久 化 和 主 备 复制 功能 可以 让 任何 客户端 访问 任何时刻 的 数据 并且能 记住 每一个 客户端 的 访问 位置 还能 保证 消息 不 丢失 redis 的 字符串 sds 和 c 语言 的 字符串 区别 c 字符串 sds 获取 字符串 长度 的 复杂度 为 o n 获取 字符串 长度 的 复杂度 为 o api 是 不安全 的 可能会 造成 缓冲区 溢出 api 是 安全 的 不会 造成 缓冲区 溢出 修改 字符串 长度 n 次 必然 需要 执行 n 次 内存 重 分配 修改 字符串 长度 n 次 最多 需要 执行 n 次 内存 重 分配 只能 保存 文本 数据 可以 保存 文本 数据 或者 二进制 数据 可以 使用 所有 的 ltstringhgt 库 中 的 函数 可以 使用 一部分 ltstringhgt 库 中 的 函数 sortedset 底层 数据结构 sortedset 有序 集合 当前 有 两种 编码 使用 压缩 列表 实现 当 保存 的 元素 长度 都 小于 字节 同时 数量 小于 时 使用 该 编码 方式 否则 会 使用 skiplist 这两个 参数 可以 通过 来自 定义 修改 skiplistzset 实现 一个 zset 同时 包含 一个 字典 dict 和 一个 跳跃 表 为什么 同时 使用 字典 和 跳跃 表 主要 是为了 提升 性能 单独 使用 字典 在 执行 范围 型 操作 比如 zrankzrange 字典 需要 进行 排序 至少 需要 o nlogn 的 时间 复杂度 及 额外 o n 的 内存空间 单独 使用 跳跃 表 根据 成员 查找 分值 操作 的 复杂度 从 o 上 升为 o logn sortedset 为什么 使用 跳跃 表 而 不是 红 黑 树 主要有 以下 几个 原因 跳表 的 性能 和 红 黑 树 差不多 跳表 更 容易 实现 和 调试 网上 有 同学 说是 因为 作者 不 会红 黑 树 我 觉得 挺有 可能 的 hash 对象 底层 结构 hash 对象 当前 有 两种 编码 使用 压缩 列表 实现 每当 有 新 的 键值 对 要 加入到 哈希 对象 时 程序 会 先将 保存 了 键 的 节点 推入 到 压缩 列表 的 表 尾 然后 再将 保存 了 值 的 节点 推入 到 压缩 列 表表 尾 因此 保存 了 同一 键值 对 的 两个 节点 总是 紧挨 在一起 保存 键 的 节点 在前 保存 值 的 节点 在后 先 添加到 哈希 对象 中 的 键值 对 会被 放在 压缩 列表 的 表头 方向 而 后来 添加 的 会被 放在 表 尾 方向 hashtable 使用 字典 作为 底层 实现 哈希 对象 中 的 每个 键值 对 都 使用 一个 字典 键值 来 保存 跟 java 中 的 hashmap 类似 hash 对象 的 扩容 流程 hash 对象 在 扩容 时 使 用了 一种 叫 渐进式 rehash 的 方式 步骤 如下 计算 新 表 size 掩码 为 新 表 ht 分配 空间 让 字典 同时 持有 ht 和 ht 两个 哈希 表 将 rehash 索引 计数器 变量 rehashidx 的 值 设置 为 表示 rehash 正式 开始 在 rehash 进行 期间 每次 对 字典 执行 添加 删除 査 找 更新 操作 时 程序 除了 执行 指定 的 操作 以外 还会 触发 额外 的 rehash 操作 在 源码 中 的 dictrehashstep 方法 dictrehashstep 从 名字 也 可以 看出来 大意 是 rehash 一步 也 就是 rehash 一个 索引 位置 该 方 法会 从 ht 表 的 rehashidx 索引 位置 上 开始 向后 查找 找到 第一个 不为 空 的 索引 位置 将该 索引 位置 的 所有 节点 rehash 到 ht 当 本次 rehash 工作 完成 之后 将 ht 索引 位置 为 rehashidx 的 节点 清空 同时 将 rehashidx 属性 的 值 加 一将 rehash 分 摊到 每个 操作 上 确实 是 非常 妙 的 方式 但是 万一 此时 服务器 比较 空闲 一直 没有什么 操作 难道 redis 要 一直 持有 两个 哈希 表 吗 答案 当然 不是 的 我们 知道 redis 除了 文件 事件 外 还有 时间 事件 redis 会 定期 触发 时间 事件 这些 时间 事件 用于 执行 一些 后台 操作 其 中就 包含 rehash 操作 当 redis 发现有 字典 正在进行 rehash 操作 时会 花费 毫秒 的 时间 一起 帮忙 进行 rehash 随着 操作 的 不断 执行 最终 在 某个 时间 点 上 ht 的 所有 键值 对 都 会被 rehash 至 ht 此时 rehash 流程 完成 会 执行 最后 的 清理 工作 释放 ht 的 空间 将 ht 指向 ht 重置 ht 重置 rehashidx 的 值 为 渐进式 rehash 的 优点 渐进式 rehash 的 好处 在于 它 采取 分而治之 的 方式 将 rehash 键值 对 所需 的 计算 工作 均 摊到 对 字典 的 每个 添加 删除 查找 和 更新 操作 上 从而 避免了 集中式 rehash 而 带来 的 庞大 计算 量 在 进行 渐进式 rehash 的 过程中 字典 会 同时 使用 ht 和 ht 两个 哈希 表 所以在 渐进式 rehas sh 进行 期间 字典 的 删除 査 找 更新 等 操作 会在 两个 哈希 表 上 进行 例如 要在 字典 里面 査 找 一个 键 的话 程序 会 先在 ht 里面 进行 査 找 如果 没找到 的话 就会 继续 到 ht 里面 进行 査 找 诸如此类 另 外在 渐进式 rehash 执行 期间 新增 的 键值 对 会被 直接 保 存到 htht 不再 进行 任何 添加 操作 这样 就 保证 了 ht 包含 的 键值 对 数量 会 只 减 不 增 并 随着 rehash 操作 的 执行 而 最终 变成 空 表 rehash 流程 在数 据 量大 的 时候 会有 什么问题 吗 hash 对象 的 扩容 流程 在数 据 量大 的 时候 会有 什么问题 吗 扩容 期 开始 时会 先给 ht 申请 空间 所以在 整个 扩容 期间 会 同时 存在 ht 和 ht 会 占用 额外 的 空间 扩容 期间 同时 存在 ht 和 ht 查找 删除 更新 等 操作 有 概率 需要 操作 两张 表 耗 时会 增加 redis 在 内存 使用 接近 maxmemory 并且有 设置 驱逐 策略 的 情况下 出现 rehash 会 使得 内存 占用 超过 maxmemory 触发 驱逐 淘汰 操作 导致 masterslave 均有 有 大量 的 key 被 驱逐 淘汰 从而 出现 masterslave 主从 不一致 redis 的 网络 事件 处理器 reactor 模式 redis 基于 reactor 模式 开 发了 自己 的 网络 事件 处理器 由 个 部分 组成 套接 字 io 多路复用 程序 文件 事件 分派 器 dispatcher 以及 事件 处理器 套接 字 socket 连接 也 就是 客户端 连接 当 一个 套接 字 准备好 执行 连接 写入 读取 关闭 等 操作 时 就会 产生 一个 相应 的 文件 事件 因为 一个 服务器 通常会 连接 多个 套接 字 所以 多个 文件 事件 有 可能会 并发 地 出现 io 多路复用 程序 提供 的 实现 会 根据 当前 系统 自动 选择 最佳 的 方式 负责 监听 多个 套接 字 当 套接 字 产生 事件 时会 向 文件 事件 分派 器 传送 那些 产生 了 事件 的 套接 字 当 多个 文件 事件 并发 出 现时 io 多路复用 程序 会将 所有 产生 事件 的 套接 字 都 放到 一个 队列 里面 然后 通过 这个 队列 以 有序 同步 每次 一个 套接 字 的 方式 向 文件 事件 分派 器 传送 套接 字 当上 一个 套接 字 产生 的 事件 被 处理完毕 之后 才会 继续 传送 下一个 套接 字 文件 事件 分派 器 接收 io 多路复用 程序 传来 的 套接 字 并 根据 套接 字 产生 的 事件 的 类型 调用 相应 的 事件 处理器 事件 处理器 事件 处理器 就是 一个个 函数 定义 了 某个 事件 发生 时 服务器 应该 执行 的 动作 例如 建立 连接 命令 查询 命令 写入 连接 关闭 等等 redis 删除 过期 键 的 策略 缓存 失效 策略 数据 过期 策略 定时 删除 在 设置 键 的 过期 时间 的 同时 创建 一个 定时器 让 定时器 在 键 的 过期 时间 来 临时 立即 执行 对 键 的 删除 操作 对 内存 最 友好 对 cpu 时间 最不 友好 惰性 删除 放任 键 过期 不管 但是 每次 获取 键 时 都 检 査 键 是否 过期 如果 过期 的话 就 删除 该 键 如果 没有 过期 就 返回 该 键 对 cpu 时间 最 优化 对 内存 最不 友好 定期 删除 每隔 一段时间 默认 ms 程序 就 对 数据库 进行 一次 检 査 删除 里面 的 过期 键 至于 要 删除 多少 过期 键 以及 要 检 査 多少个 数据库 则由 算法 决定 前 两种 策略 的 折中 对 cpu 时间 和 内存 的 友好 程度 较 平衡 redis 使用 惰性 删除 和 定期 删除 redis 的 内存 淘汰 驱逐 策略 当 redis 的 内存空间 maxmemory 参数 配置 已经 用 满 时 redis 将 根据 配置 的 驱逐 策略 maxmemorypolicy 参数 配置 进行 相应 的 动作 网上 很多 资料 都是 写 种 但是 其实 当前 redis 的 淘汰 策略 已经有 种了 多余 的 两种 是 redis 新增 的 基于 算法 实现 的 noeviction 默认 策略 不 淘汰 任何 key 直接 返回 错误 allkeyslru 在所 有的 key 中 使用 lru 算法 淘汰 部分 keyallkeyslfu 在所 有的 key 中 使用 lfu 算法 淘汰 部分 key 该 算法 于 redis 新增 allkeysrandom 在所 有的 key 中 随机 淘汰 部分 keyvolatilelru 在 设置 了 过期 时间 的 key 中 使用 lru 算法 淘汰 部分 keyvolatilelfu 在 设置 了 过期 时间 的 key 中 使用 lfu 算法 淘汰 部分 key 该 算法 于 redis 新增 volatilerandom 在 设置 了 过期 时间 的 key 中 随机 淘汰 部分 keyvolatilettl 在 设置 了 过期 时间 的 key 中 挑选 ttltimetolive 剩余 时间短 的 key 淘汰 redis 的 lru 算法 怎么 实现 的 redis 在 redisobject 结构 体 中 定义 了 一个 长度 bit 的 unsigned 类型 的 字段 在 lru 算法 中 用来 存储 对象 最后 一次 被 命令 程序 访问 的 时间 具体 的 lru 算法 经历 了 两个 版本 版本 随机 选取 n 个 淘汰法 最初 redis 是 这样 实现 的 随机 选 n 默 认个 key 把 空闲 时间 idletime 最大 的 那个 key 移除 这边 的 n 可通过 配置 项 修改 就是 这么 简单 简单 得 让 人 不敢相信 了 而且 十分 有效 但是 这个 算法 有 个 明显 的 缺点 每次 都是 随机 从 n 个里 选择 个 并没有 利用 前 一轮 的 历史 信息 其实 在上 一轮 移除 key 的 过程中 其实是 知道了 n 个 key 的 idletime 的 情况 的 那 在下 一轮 移除 key 时 其实 可以 利 用上 一轮 的 这些 信息 这 也是 redis 的 优化 思想 版本 redis 对 lru 算法 进行 改进 引 入了 缓冲 池 pool 默认 的 概念 当 每 一轮 移除 key 时 拿 到了 n 默 认个 key 的 idletime 遍历 处理 这 n 个 key 如果 key 的 idletime 比 pool 里面 的 key 的 idletime 还要 大 就把 它 添加到 pool 里面 去 当 pool 放满 之后 每次 如果有 新 的 key 需要 放入 需 要将 pool 中 idletime 最小 的 一个 key 移除 这样 相当于 pool 里面 始终 维 护着 还 未被 淘汰 的 idletime 最大 的 个 key 当 我们 每 轮 要 淘汰 的 时候 直接 从 pool 里面 取出 idletime 最大 的 key 只 取 个 将之 淘汰 掉 整个 流程 相当于 随机 取 个 key 放入 pool 然后 淘汰 pool 中空 闲 时间 最大 的 key 然后再 随机 取 个 key 放入 pool 继续 淘汰 pool 中空 闲 时间 最大 的 key 一直 持续 下去 在 进入 淘汰 前 会计 算出 需要 释放 的 内存大小 然后就 一直 循环 上述 流程 直至 释放 足够 的 内存 redis 的 持久 化 机制 有 哪几种 各自 的 实现 原理 和 优缺点 redis 的 持久 化 机制 有 rdbaof 混合 持久 化 rdbaofredis 引入 rdb 描述 类似于 快 照在 某个 时间 点将 redis 在 内存 中 的 数据库 状态 数据库 的 键值 对等 信息 保 存到 磁盘 里面 rdb 持久 化 功能 生成 的 rdb 文件 是 经过 压缩 的 二进制 文件 命令 有 两个 redis 命令 可以 用于 生成 rdb 文件 一个是 save 另 一个是 bgsave 开启 使用 savepoint 配置 满足 savepoint 条件 后会 触发 bgsave 来 存储 一次 快照 这边 的 savepoint 检查 就是 在上文 提到 的 servercron 中 进行 savepoint 格式 含义 是 redis 如果在 seconds 秒内 数据 发 生了 changes 次 改变 就 保存 快照 文件 例如 redis 默认 就 配置 了 以 下个 save 秒内 有 个 key 发 生了 变化 则 触发 保存 rdb 文件 save 秒内 有 个 key 发 生了 变化 则 触发 保存 rdb 文件 save 秒内 有 个 key 发 生了 变化 则 触发 保存 rdb 文件 关闭 注释 掉 所有 savepoint 配置 可以 关闭 rdb 持久 化 在所 有 savepoint 配置 后 增加 save 该 配置 可以 删除 所有 之前 配置 的 生成 rdb 快照 文件 但是 会 阻塞 主 进程 服务器 将 无法 处理 客户端 发来 的 命令 请求 所以 通常 不会 直接 使用 该 命令 bgsavefork 子 进程 来 生成 rdb 快照 文件 阻塞 只会 发 生在 fork 子 进程 的 时候 之后 主 进程 可以 正常 处理 请求 详细 过程 如 下图 fork 在 linux 系统 中 调用 fork 时会 创 建出 一个 新 进程 称为 子 进 程子 进程 会 拷贝 父 进程 的 pagetable 如果 进程 占用 的 内存 越大 进程 的 pagetable 也 会 越大 那么 fork 也 会 占用 更多 的 时间 如果 redis 占用 的 内存 很大 那么 在 fork 子 进程 时 则会 出现 明显 的 停顿 现象 rdb 的 优点 rdb 文件 是 是 经过 压缩 的 二进制 文件 占用 空间 很小 它 保存 了 redis 某个 时间 点 的 数据 集 很 适合 用于 做 备份 比如说 你 可以 在 最近 的 小时内 每小时 备份 一次 rdb 文件 并且在 每个月 的 每一天 也 备份 一个 rdb 文件 这样 的话 即使 遇上 问题 也 可以 随时 将 数据 集 还原 到 不同 的 版本 rdb 非常 适用于 灾难 恢复 它 只有 一个 文件 并且 内容 都 非常 紧凑 可以 在 加密 后 将它 传 送到 别的 数据中心 rdb 可以 最大化 redis 的 性能 父 进程 在 保存 rdb 文件 时 唯一 要做 的 就是 fork 出 一 个子 进程 然后 这 个子 进程 就会 处理 接下来 的 所有 保存 工作 父 进程 无须 执行 任何 磁盘 io 操作 rdb 在 恢复 大 数据 集 时 的 速度 比 aof 的 恢复 速度 要快 rdb 的 缺点 rdb 在 服务器 故障 时 容易 造成 数据 的 丢失 rdb 允许 我们 通过 修改 savepoint 配置 来 控制 持久 化 的 频率 但是 因为 rdb 文件 需要 保存 整个 数据 集 的 状态 所以 它是 一个 比 较重 的 操作 如果 频率 太 频繁 可能 会对 redis 性能 产生影响 所以 通常 可能 设置 至少 分钟 才 保存 一次 快照 这时 如果 redis 出现 宕机 等 情况 则 意味着 最多 可能 丢失 分钟 数据 rdb 保存 时 使用 fork 子 进程 进行 数据 的 持久 化 如果 数据 比 较大 的话 fork 可能会 非常 耗时 造成 redis 停止 处理 服务 n 毫秒 如果 数据 集 很大 且 cpu 比较 繁忙 的 时候 停止 服务 的 时间 甚至 会到 一秒 linuxfork 子 进程 采用 的 是 copyonwrite 的 方式 在 redis 执行 rdb 持久 化 期间 如果 client 写入 数据 很 频繁 那么 将 增加 redis 占用 的 内存 最坏 情况下 内存 的 占用 将 达到 原先 的 倍 刚 fork 时 主 进程 和 子 进程 共享 内存 但是 随着 主 进程 需要 处理 写 操作 主 进程 需 要将 修改 的 页面 拷贝 一份 出来 然后 进行 修改 极端 情况下 如果 所有 的 页面 都被 修 改则 此时 的 内存 占 用是 原先 的 倍 aof 描述 保存 redis 服务器 所 执行 的 所有 写 操作 命令 来 记录 数据库 状态 并在 服务器 启动时 通过 重新 执行 这些 命令 来 还原 数据 集 开启 aof 持久 化 默认 是 关闭 的 可以 通过 配置 appendonlyyes 开启 关闭 使用 配置 appendonlyno 可以 关闭 aof 持久 化 aof 持久 化 功能 的 实现 可以 分为 三个 步骤 命令 追加 文件 写入 文件 同步 命令 追 加当 aof 持久 化 功能 打开 时 服务器 在 执行 完 一个 写 命令 之后 会将 被执行 的 写 命令 追 加到 服务器 状态 的 aof 缓冲区 aofbuf 的 末尾 文件 写入 与 文件 同步 可能 有人 不明白 为什么 将 aofbuf 的 内容 写到 磁 盘上 需要 两步 操作 这边 简单 解释一下 linux 操作系统 中 为了 提升 性能 使 用了 页 缓存 pagecache 当我 我们 将 aofbuf 的 内容 写到 磁 盘上 时 此时 数据 并没有 真正 的 落 盘 而是 在 pagecache 中 为了 将 pagecache 中 的 数据 真正 落 盘 需要 执行 fsyncfdatasync 命令 来 强制 刷 盘 这边 的 文件 同步 做的 就是 刷 盘 操作 或者 叫 文件 刷 盘 可能 更 容易 理解 一些 在 文章 开头 我们 提过 servercron 时间 事件 中会 触发 函数 该 函数 会 根据 服务器 配置 的 appendfsync 参 数值 来 决定 是否 将 aofbuf 缓冲区 的 内容 写入 和 保 存到 aof 文件 appendfsync 参数 有 三个 选项 always 每 处理 一个 命令 都将 aofbuf 缓冲区 中 的 所有 内容 写入 并 同步 到 aof 文件 即 每个 命令 都 刷 盘 everysec 将 aofbuf 缓冲区 中 的 所有 内容 写入 到 aof 文件 如果 上次 同步 aof 文件 的 时间 距离 现在 超过 一秒钟 那么 再次 对 aof 文件 进行 同步 并且 这个 同步操作 是 异步 的 由 一个 后台 线程 专门 负责 执行 即 每秒 刷 盘 次 no 将 aofbuf 缓冲区 中 的 所有 内容 写入 到 aof 文件 但 并 不对 aof 文件 进行 同步 何时 同步 由 操作系统 来 决定 即 不 执行 刷 盘 让 操作系统 自己 执行 刷 盘 aof 的 优点 aof 比 rdb 可靠 你 可以 设置 不同 的 fsync 策略 noeverysec 和 always 默认 是 everysec 在 这种 配置 下 redis 仍然 可以 保持 良好 的 性能 并且 就算 发生 故障 停机 也 最多 只会 丢失 一秒钟 的 数据 aof 文件 是 一个 纯 追加 的 日志 文件 即使 日志 因为 某些 原 因而 包 含了 未 写入 完整 的 命令 比如 写 入时 磁盘 已满 写入 中途 停机 等等 我们 也 可以 使用 redischeckaof 工具 也 可以 轻 易地 修复 这种 问题 当 aof 文件 太大 时 redis 会 自动 在 后台 进行 重写 重写 后 的 新 aof 文件 包 含了 恢复 当前 数据 集 所需 的 最小 命令 集合 整个 重写 是 绝对 安全 因为 重写 是 在 一个 新 的 文件 上进 行 同时 redis 会 继续 往 旧 的 文件 追加 数据 当 新文件 重写 完毕 redis 会把 新旧 文件 进行 切换 然后 开始 把 数据 写到 新文件 上 aof 文件 有序 地 保存 了 对 数据库 执行 的 所有 写入 操作 以 redis 协议 的 格式 保存 因此 aof 文件 的 内容 非常 容易 被人 读懂 对 文件 进行 分析 parse 也 很 轻松 如果 你 不小心 执 行了 flushall 命令 把 所有 数据 刷 掉了 但 只要 aof 文件 没有 被 重写 那么 只要 停止 服务器 移除 aof 文件 末尾 的 flushall 命令 并 重启 redis 就可以 将 数据 集 恢复 到 flushall 执行 之前 的 状态 aof 的 缺点 对于 相同 的 数据 集 aof 文件 的 大小 一般 会比 rdb 文件 大 根据 所 使用 的 fsync 策略 aof 的 速度 可能 会比 rdb 慢 通常 fsync 设置 为 每秒 一次 就能 获得 比 较高 的 性能 而 关闭 fsync 可以 让 aof 的 速度 和 rdb 一样 快 aof 在 过去 曾经 发 生过 这样 的 bug 因为 个别命令 的 原因 导致 aof 文件 在 重新 载 入时 无法 将 数据 集 恢复 成 保存 时 的 原样 举个 例子 阻塞 命令 brpoplpush 就 曾经 引起 过 这样 的 bug 虽然 这种 bug 在 aof 文件 中 并不 常见 但是 相较 而言 rdb 几乎是 不可能 出现 这种 bug 的 混合 持久 化 描述 混合 持久 化 并不是 一种 全新 的 持久 化 方式 而是 对 已有 方式 的 优化 混合 持久 化 只 发 生于 aof 重写 过程 使 用了 混合 持久 化 重写 后 的 新 aof 文件 前半段 是 rdb 格式 的 全 量 数据 后半段 是 aof 格式 的 增量 数据 整体 格式 为 rdbfileaoftail 开启 混合 持久 化 的 配置 参数 为 配置 为 yes 时 开启 混合 持久 化 在 redis 刚 引 入时 默认 是 关闭 混合 持久 化 的 但是在 redis 中 默认 已经 打 开了 关闭 使用 配置 即可 关闭 混合 持久 化 混合 持久 化 本质 是 通过 aof 后台 重写 bgrewriteaof 命令 完成 的 不同 的 是 当 开启 混合 持久 化时 fork 出 的 子 进程 先将 当前 全 量 数 据以 rdb 方式 写入 新 的 aof 文件 然后 再将 aof 重写 缓冲区 的 增量 命令 以 aof 方式 写入 到 文件 写入 完成后 通知 主 进程 将 新 的 含有 rdb 格式 和 aof 格式 的 aof 文件 替换 旧 的 的 aof 文件 优点 结合 rdb 和 aof 的 优点 更快 的 重写 和 恢复 缺点 aof 文件 里面 的 rdb 部分 不再是 aof 格式 可读性 差 为什么 需要 aof 重写 aof 持久 化 是 通过 保存 被执行 的 写 命令 来 记录 数据库 状态 的 随着 写入 命令 的 不断 增加 aof 文件 中 的 内容 会 越来越多 文件 的 体积 也 会 越来越大 如果 不 加以 控制 体积 过大 的 aof 文件 可能 会对 redis 服务器 甚至 整个 宿 主机 造成 影响 并且 aof 文件 的 体积 越大 使用 aof 文件 来 进行 数据 还原 所需 的 时间 就 越多 举个 例子 如果 你 对 一个 计数器 调 用了 次 incr 那么 仅仅 是为了 保存 这个 计数器 的 当前 值 aof 文件 就需要 使用 条 记录 然 而在 实际上 只 使用 一条 set 命令 已经 足以 保存 计数器 的 当前 值了 其余 条 记录 实际上 都是 多余 的 为了 处理 这种 情况 redis 引 入了 aof 重写 可以 在 不 打断 服务端 处理 请求 的 情况下 对 aof 文件 进行 重建 rebuild 介绍 下 aof 重写 的 过程 aof 后台 重写 存在 的 问题 如何 解决 aof 后台 重写 存在 的 数据 不一致 问题 描述 redis 生成 新 的 aof 文件 来 代替 旧 aof 文件 这个 新 的 aof 文件 包含 重建 当前 数据 集 所需 的 最少 命令 具体 过程 是 遍历 所有 数据库 的 所有 键 从 数据库 读取 键 现在 的 值 然 后用 一条 命令 去 记录 键值 对 代替 之前 记录 这个 键值 对 的 多条 命令 命令 有 两个 redis 命令 可以 用于 触发 aof 重写 一个是 bgrewriteaof 另 一个是 rewriteaof 命令 开启 aof 重写 由 两个 参数 共同 控制 和 同时 满足 这两个 条件 则 触发 aof 后台 重写 bgrewriteaof 当前 aof 文件 比 上次 重写 后 的 aof 文件 大小 的 增长 比例 超过 当前 aof 文件 的 文件 大小 大于 关闭 指定 的 百分比 以 禁用 自动 aof 重写 功能 进行 aof 重写 但是 会 阻塞 主 进程 服务器 将 无法 处理 客户端 发来 的 命令 请求 通常 不会 直接 使用 该 命令 子 进程 来 进行 aof 重写 阻塞 只会 发 生在 fork 子 进程 的 时候 之后 主 进程 可以 正常 处理 请求 rewriteaof 和 bgrewriteaof 的 关系 与 save 和 bgsave 的 关系 类似 aof 后台 重写 存在 的 问题 aof 后台 重写 使用 子 进程 进行 从 写 解决 了 主 进程 阻塞 的 问题 但是 仍然 存在 另一个 问题 子 进程 在 进行 aof 重写 期间 服务器 主 进程 还需 要继续 处理 命令 请 求新 的 命令 可能 会对 现有 的 数据库 状态 进行 修改 从而 使得 当前 的 数据库 状态 和 重写 后 的 aof 文件 保存 的 数据库 状态 不一致 如何 解决 aof 后台 重写 存在 的 数据 不一致 问题 为了 解决 上述问题 redis 引 入了 aof 重写 缓冲区 这个 缓冲区 在 服务器 创建 子 进程 之后 开始使用 当 redis 服务器 执行 完 一个 写 命令 之后 它会 同时 将 这个 写 命令 追 加到 aof 缓冲区 和 aof 重写 缓冲区 这样一来 可以 保证 现有 aof 文件 的 处理 工作会 如常 进行 这样 即使 在 重写 的 中途 发生 停机 现有 的 aof 文件 也 还是 安全 的 从 创建 子 进程 开始 也 就是 aof 重写 开始 服务器 执行 的 所有 写 命令 会被 记 录到 aof 重写 缓冲区 里面 这样 当 子 进程 完成 aof 重写 工作 后父 进程 会在 servercron 中 检 测到 子 进程 已经 重写 结束 则会 执行 以下 工作 将 aof 重写 缓冲区 中 的 所有 内容 写入 到 新 aof 文件 中 这 时新 aof 文件 所 保存 的 数据库 状态 将 和 服务器 当前 的 数据库 状态 一致 对 新 的 aof 文件 进行 改名 原子 的 覆盖 现有 的 aof 文件 完成 新旧 两个 aof 文件 的 替换 之 后父 进程 就可以 继续 像 往常 一样 接受命令 请求 了 rdbaof 混合 持久 我 应 该用 哪一个 一般来说 如果 想 尽量 保证 数据 安全性 你 应该 同时 使用 rdb 和 aof 持久 化 功能 同时 可以 开启 混合 持久 化 如果 你 非常 关心 你 的 数据 但仍然 可以 承受 数 分钟 以内 的 数据 丢失 那么 你 可以 只 使用 rdb 持久 化 如果 你 的 数据 是 可以 丢失 的 则 可以 关闭 持久 化 功能 在 这种 情况下 redis 的 性能 是 最高 的 使用 redis 通常 都是 为了 提升 性能 而 如果 为了 不 丢失 数据 而将 appendfsync 设置 为 always 级别 时 对 redis 的 性能 影响 是 很大 的 在 这种 不能 接受 数据 丢失 的 场景 其实 可以 考虑 直接 选择 mysql 等 类似 的 数据库 同时 开启 rdb 和 aof 服务 重启 时 如何 加载 简单 来说 如果 同时 启 用了 aof 和 rdbredis 重新启动 时会 使用 aof 文件 来 重建 数据 集 因为 通常 来说 aof 的 数据 会 更 完整 而在 引 入了 混合 持久 化 之后 使用 aof 重建 数据 集 时会 通过 文件 开头 是否 为 redis 来 判断 是否 为 混合 持久 化 完整 流程 如 下图 所示 redis 怎么 保证 高 可用 有 哪些 集群 模式 主从复制 哨兵 模式 集群 模式 主从复制 在 当前 最新 的 redis 中 主从复制 的 完整 过程 如下 开启 主从复制 通常 有 以下 三种 方式 在 slave 直接 执行命令 在 slave 配置文件 中 加入 使用 启动 命令 注 在 redis 之后 slaveof 相关 命令 和 配置 已经 被 替换成 replicaof 例如 为了 兼容 旧版本 通过 配置 的 方式 仍然 支持 slaveof 但是 通过 命令 的 方式 则不 行了 建立 套接 字 socket 连接 slave 将 根据 指定 的 ip 地址 和 端口 向 master 发起 套接 字 socket 连接 master 在 接受 acceptslave 的 套接 字 连接 之 后为 该 套接 字 创建 相应 的 客户端 状态 此时 连接 建立 完成 发送 ping 命令 slave 向 master 发送 一个 ping 命令 以 检 査 套接 字 的 读写 状态 是否 正常 master 能否 正常 处理 命令 请求 身份验证 slave 向 master 发送 authpassword 命令 来 进行 身份验证 发送 端口 信息 在 身份验证 通 过后 后 slave 将 向 master 发送 自己 的 监听 端口号 master 收到 后记 录在 slave 所 对应 的 客户端 状态 的 属性 中 发送 ip 地址 如果 配置 了 slaveannounceip 则 slave 向 mas ster 发送 slaveannounceip 配置 的 ip 地址 master 收到 后记 录在 slave 所 对应 的 客户端 状态 的 slaveip 属性 该 配置 是 用于 解决 服务器 返回 内网 ip 时 其他 服务器 无法访问 的 情况 可以 通过 该 配置 直接 指定 公网 ip 发送 capacapa 全 称是 capabilities 这边 表示 的 是 同步 复制 的 能力 slave 会在 这一 阶段 发送 capa 告诉 master 自己 具备 的 同步 复制 能力 master 收到 后记 录在 slave 所 对应 的 客户端 状态 的 slavecapa 属性数据 同步 slave 将 向 master 发送 psync 命令 master 收到 该 命令 后 判断 是 进行 部分 重 同步 还是 完整 重 同步 然后 根据 策略 进行 数据 的 同步 命令 传播 当 完 成了 同步 之后 就会 进入 命令 传播 阶段 这时 master 只要 一直 将 自己 执行 的 写 命令 发送给 slave 而 slave 只要 一直 接收 并 执行 master 发来 的 写 命令 就可以 保证 master 和 slave 一直 保持一致 了 以 部分 重 同步 为 例 主从复制 的 核心 步骤 流程图 如下 哨兵 哨兵 sentinel 是 redis 的 高 可用性 解决方案 由 一个 或 多个 sentinel 实例 组成 的 sentinel 系统 可以 监视 任意 多个 主 服务器 以及 这些 主 服务器 属下 的 所有 从 服务器 sentinel 可以 在被 监视 的 主 服务器 进入 下线 状态 时 自动 将 下线 主 服务器 的 某个 从 服务器 升级 为 新 的 主 服务器 然 后由 新 的 主 服务器 代替 已 下线 的 主 服务器 继续 处理 命令 请求 哨兵 故障 检测 检查 主观 下线 状态 在 默认 情况下 sentinel 会 以 每秒 一次 的 频率 向 所有 与它 创 建了 命令 连接 的 实例 包括 主 服务器 从 服务器 其他 sentinel 在内 发送 ping 命令 并 通过 实例 返回 的 ping 命令 回复 来 判断 实例 是否 在线 如果 一个 实例 在 毫 秒内 连续 向 sentinel 返回 无效 回复 那么 sentinel 会 修改 这个 实例 所 对应 的 实例 结构 在 结构 的 flags 属性 中 设置 srisdown 标识 以此来 表示 这个 实例 已经 进入 主观 下线 状态 检查 客观 下线 状态 当 sentinel 将 一个 主 服务器 判断 为 主观 下线 之后 为了 确定 这个 主 服务器 是否 真的 下线 了 它会 向 同样 监视 这一 服务器 的 其他 sentinel 进行 询问 看 它们 是否 也 认 为主 服务器 已经 进 入了 下线 状态 可 以是 主观 下线 或者 客观 下线 当 sentinel 从 其他 sentinel 那里 接 收到 足够 数量 quorum 可 配置 的 已 下线 判断 之后 sentinel 就 会将 服务器 置 为 客观 下线 在 flags 上 打上 sriodown 标识 并 对 主 服务器 执行 故障 转移 操作 哨兵 故障 转移 流程 当 哨兵 监 测到 某个 主 节点 客观 下线 之后 就会 开始 故障 转移 流程 核心 流程 如下 发起 一次 选举 选 举出 领头 sentinel 领头 sentinel 在 已 下线 主 服务器 的 所有 从 服务器 里面 挑选出 一个 从 服务器 并 将其 升级 为 新 的 主 服务器 领头 sentinel 将 剩余 的 所有 从 服务器 改为 复制 新 的 主 服务器 领头 sentinel 更新 相关 配置 信息 当 这 个旧 的 主 服务器 重新 上线 时 将其 设置 为 新 的 主 服务器 的 从 服务器 集群 模式 哨兵 模式 最大 的 缺点 就是 所有 的 数据 都 放在 一台 服务器 上 无法 较好 的 进行 水平 扩展 为了 解决 哨兵 模式 存在 的 问题 集群 模式 应运而生 在 高 可用 上 集群 基 本是 直接 复用 的 哨兵 模式 的 逻辑 并且 针对 水平 扩展 进行了 优化 集群 模式 具备 的 特点 如下 采 取去 中心 化 的 集群 模式 将 数据 按 槽 存储 分布 在 多个 redis 节点 上 集群 共有 个 槽 每个 节点 负责处理 部分 槽 使用 crc 算法 来 计算 key 所属 的 槽 crc keykeylen amp 所有 的 redis 节点 彼此 互联 通过 pingpong 机制 来 进行 节点 间 的 心跳 检测 分片 内 采用 一 主 多 从 保证 高 可用 并 提供 复制 和 故障 恢复 功 能在 实际使用 中 通常 会将 主从 分布 在 不同 机房 避免 机房 出现 故障 导致 整个 分片 出问题 下面 的 架构图 就是 这样 设计 的 客户端 与 redis 节点 直连 不需要 中间 代理 层 proxy 客户端 不需要 连接 集群 所有 节点 连接 集群 中 任何 一个 可用 节点 即可 集群 的 架构图 如下 所示 集群 选举 故障 转移 的 第一步 就是 选举 出新 的 主 节点 以下 是 集群 选举 新 的 主 节点 的 方法 当 从 节点 发现 自己 正在 复制 的 主 节点 进入 已 下线 状态 时会 发起 一次 选举 将 currentepoch 配置 纪元 加 然 后向 集群 广播 一条 消息 要求 所有 收到 这条 消息 并且 具有 投票权 的 主 节点 向 这个 从 节点 投票 其他 节点 收到 消息 后会 判断 是否 要给 发送 消息 的 节点 投票 判断 流程 如下 当前 节点 是 slave 或者 当前 节点 是 master 但是 不 负责处理 槽 则 当前 节点 没有 投票权 直接 返回 请求 节点 的 currentepoch 小于 当前 节点 的 currentepoch 校验 失败 返回 因为 发送者 的 状态 与 当前 集群 状态 不一致 可能是 长时间 下线 的 节点 刚刚 上线 这种 情况下 直接 返回 即可 当前 节 点在 该 currentepoch 已经 投过 票 校验 失败 返回 请求 节点 是 master 校验 失败 返回 请求 节点 的 master 为 空 校验 失败 返回 请求 节点 的 master 没有 故障 并且 不是 手动 故障 转移 校验 失败 返回 因为 手动 故障 转移 是 可以 在 master 正常 的 情况下 直接 发起 的 上 一次 为 该 master 的 投票 时间 在 的 倍 范围内 校验 失败 返回 这个 用于 使 获胜 从 节点 有时间 将其 成为 新主 节点 的 消息 通知 给 其他 从 节点 从而 避免 另一个 从 节点 发起 新一轮 选举 又 进行 一次 没必要 的 故障 转移 请求 节点 宣称 要 负责 的 槽 位 是否 比 之前 负责 这些 槽 位 的 节点 具有 相等 或 更大 的 configepoch 如果 不是 校验 失败 返回 如果 通过 以上 所有 校验 那么 主 节 点将 向 要求 投票 的 从 节点 返回 一条 消息 表示 这个 主 节点 支持 从 节点 成为 新 的 主 节点 每个 参与 选举 的 从 节点 都会 接收 消息 并 根据 自己 收 到了 多少 条 这种 消息 来 统计 自己 获得了 多少个 主 节点 的 支持 如果 集群 里 有 n 个 具有 投票权 的 主 节点 那么 当 一个 从 节点 收集到 大于 等于 n 张 支持 票 时 这个 从 节点 就会 当选为 新 的 主 节点 因为 在 每一个 配置 纪元 里面 每个 具有 投票权 的 主 节点 只能 投 一次 票 所以 如果有 n 个 主 节点 进行 投票 那么 具有 大于 等于 n 张 支持 票 的 从 节点 只会 有 一个 这 确保 了 新 的 主 节点 只会 有 一个 如果在 一个 配置 纪元 里面 没有 从 节点 能 收集到 足 够多 的 支持 票 那么 集群 进入 一个 新 的 配置 纪元 并 再次 进行 选举 直到 选 出新 的 主 节点 为止 这个 选举 新主 节点 的 方法 和 选举 领头 sentinel 的 方法 非常 相似 因为 两者 都是 基于 raft 算法 的 领头 选举 leaderelection 方法来 实现 的 如何 保证 集群 在线 扩容 的 安全性 redis 集群 要 增加 分片 槽 的 迁移 怎么 保证 无损 例如 集群 已经 对外 提供 服务 原来 有 分片 准备 新增 个 分片 怎么 在 不 下线 的 情况下 无损 的 从 原有 的 个 分片 指派 若干个 槽 给 这个 分片 redis 使 用了 ask 错误 来 保证 在线 扩容 的 安全性 在 槽 的 迁移 过程中 若有 客户端 访问 依旧 先 访问 源 节点 源 节点 会 先在 自己 的 数据库 里面 査 找 指定 的 键 如果 找到 的话 就 直接 执行 客户端 发送 的 命令 如果 没找到 说明 该 键 可能 已经 被 迁 移到 目标 节 点了 源 节 点将 向 客户端 返回 一个 ask 错误 该 错误 会 指引 客户端 转向 正在 导入 槽 的 目标 节点 并 再次 发送 之前 想要 执行 的 命令 从而 获 取到 结果 ask 错误 在 进行 重新 分片 期间 源 节点 向 目标 节点 迁移 一个 槽 的 过程中 可能会 出现 这样 一种 情况 属于 被 迁移 槽 的 一部分 键值 对保 存在 源 节点 里面 而 另一 部分 键值 对 则 保 存在 目标 节点 里面 当 客户端 向 源 节点 发送 一个 与 数据库 键 有关 的 命令 并且 命令 要 处理 的 数据库 键 恰好 就 属于 正 在被 迁移 的 槽 时 源 节点 会 先在 自己 的 数据库 里面 査 找 指定 的 键 如果 找到 的话 就 直接 执行 客户端 发送 的 命令 否则 这个 键 有 可能 已经 被 迁移 到了 目标 节点 源 节 点将 向 客户端 返回 一个 ask 错误 指引 客户端 转向 正在 导入 槽 的 目标 节点 并 再次 发送 之前 想要 执行 的 命令 从而 获 取到 结果 redis 事务 的 实现 一个 事务 从 开始 到 结束 通常会 经历 以 下个 阶段 事务 开始 multi 命令 将 执行 该 命令 的 客户端 从 非 事务 状态 切换 至 事务 状态 底层 通过 flags 属性 标识 命令 入队 当 客户端 处于 事务 状态 时 服务器 会 根据 客户端 发来 的 命令 执行 不同 的 操作 命令 会被 立即 执行 其他 命令 不会 立即 执行 而是 将 命令 放入 到 一个 事务 队列 然 后向 客户端 返回 queued 回复 事务 执 行当 一个 处于 事务 状态 的 客户端 向 服务器 发送 exec 命令 时 服务器 会 遍历 事务 队列 执行 队列 中 的 所有 命令 最后 将 结果 全部 返回 给 客户端 不过 redis 的 事务 并不 推荐在 实际 中 使用 如果 要使 用 事务 推荐 使用 lua 脚本 redis 会 保证 一个 lua 脚 本里 的 所有 命令 的 原子 性 redis 的 java 客户端 有 哪些 官方 推荐 哪个 redis 官 网 展示 的 java 客户端 如 下图 所示 其中 官方 推荐 的 是 标 星 的 个 jedisredisson 和 lettuceredis 里面 有 亿个 key 其中有 个 key 是 包含 java 如何将 它们 全部 找出来 keysjava 命令 该 命令 性能 很好 但是在 数据量 特别 大 的 时候 会有 性能 问题 scanmatchjava 命令 基于 游标 的 迭代 器 更好 的 选择 scan 命令 是 一个 基于 游标 的 迭代 器 命令 每次 被 调用 之后 都会 向 用户 返回 一个 新 的 游标 用户 在 下次 迭代 时 需要 使用 这个 新 游标 作为 scan 命令 的 游标 参数 以此来 延续 之前 的 迭代 过程 当 scan 命令 的 游标 参数 被 设置 为时 服务器 将 开始 一次 新 的 迭代 而 当 服务器 向 用户 返回值 为 的 游标 时 表示 迭代 已 结束 使 用过 redis 做 消息 队列 么 redis 本身 提供 了 一些 组件 来 实现 消息 队列 的 功能 但是 多多少少 都 存在 一些 缺点 相比 于 市面上 成熟 的 消息 队列 例如 kafkarocketmq 来说 并没有 优势 因此 目前 我们 并没有 使用 redis 来 做 消息 队列 关于 redis 做 消息 队列 的 常见 方案 主要有 以下 redis 之前 可以 使用 等 来 实现 轻量级 的 消息 发布 订阅 功能 组件 但是 这两种 实现 方式 都有 很明显 的 缺点 两者 中 相对 完善 的 pubsub 的 主要 缺点 就是 消息 无法 持久 化 如果 出现 网络 断开 redis 宕机 等 消息 就 会被 丢弃 为了 解决 pubsub 模式 等 的 缺点 redis 在 引 入了 全新 的 streamstream 借鉴 了 很多 kafka 的 设计 思想 有 以下 几个 特点 提供 了 消息 的 持久 化 和 主 备 复制 功能 可以 让 任何 客户端 访问 任何时刻 的 数据 并且能 记住 每一个 客户端 的 访问 位置 还能 保证 消息 不 丢失 引 入了 消费者 组 组 的 概念 不同 组接 收到 的 数据 完全 一样 前提 是 条件 一样 但是 组 内 的 消费者 则是 竞争 关系 redisstream 相比 于 pubsub 已经有 很明显 的 改善 但是 相比 于 kafka 其实 没有 优势 同时 存在 尚未 经过 大量 验证 成本 较高 不支持 分区 partition 无法 支持 大规模 数据 等 问题 redis 和 memcached 的 比较 数据结构 memcached 支持 简单 的 keyvalue 数据结构 而 redis 支持 丰富 的 数据结构 等 数据 存储 memcached 和 redis 的 数据 都是 全部 在 内存 中网 上有 一种 说法 当 物理 内存 用完 时 redis 可以 将 一些 很久 没用到 的 value 交 换到 磁盘 同时 在 内存 中 清除 这边 指的是 redis 里 的 虚拟内存 virtualmemory 功能 该 功 能在 redis 被 引入 但是在 redis 中被 默认 关闭 并 标 记为 废弃 而在 后 续版 中被 完全 移除 持久 化 memcached 不支持 持久 化 redis 支持 将 数据 持久 化 到 磁盘 灾难 恢复 实例 挂掉 后 memcached 数据 不可 恢复 redis 可通过 rdbaof 恢复 但是 还是 会有 数据 丢失 问题 事件 库 memcached 使用 libevent 事件 库 redis 自己 封 装了 简易 事件 库 aeevent 过期 键 删除 策略 memcached 使用 惰性 删除 redis 使用 惰性 删除 定期 删除 内存 驱逐 淘汰 策略 memcached 主 要为 lru 算法 redis 当前 支持 种 淘汰 策略 见 本文 第 题 性能 比较 按 cpu 单核 维度 比较 由于 redis 只 使用 单核 而 memcached 可以 使用 多核 所以在 比较 上 在 处理 小 数据 时 平均 每一个 核 上 redis 比 memcached 性能 更高 而在 k 左右 的 大 数据 时 memcached 性能 要 高于 redis 按 实例 维度 进行 比较 由于 memcached 多线程 的 特性 在 redis 之前 通常情况下 memcached 性能 是 要 高于 redis 的 同时 实例 的 cpu 核 数 越多 memcached 的 性能 优势 越大 至于 网上 说的 redis 的 性能比 memcached 快 很多 这个 说法 就 离谱 redis 实现 分布式 锁 加锁 加锁 通常 使用 set 命令 来 实现 伪 代码 如下 几个 参数 的 意义 如下 keyvalue 键值 对 pxmilliseconds 设置 键 的 过期 时间 为 milliseconds 毫秒 nx 只 在 键 不存在 时 才 对 键 进行 设置 操作 setkeyvaluenx 效果 等同于 参数 则是 用于 解决 没有 解锁 导致 的 死锁 问题 因为 如果 没有 过期 时间 万一 程序员 写 的 代码 有 bug 导致 没有 解锁 操作 则 就 出现 了 死锁 因此 该 参数 起 到了 一个 兜底 的 作用 nx 参数 用于 保证 在 多个 线程 并发 set 下 只会 有 个 线程 成功 起 到了 锁 的 唯一性 解锁 解锁 需要 两步 操作 查询 当前 锁 是否 还是 我们 持有 因为 存在 过期 时间 所以 可能 等 你想 解锁 的 时候 锁 已经 到期 然后 被 其他 线程 获 取了 所以 我们 在 解锁 前 需要 先 判断 自己 是否 还 持有 锁 如果 锁 还是 我们 持有 则 执行 解锁 操作 也 就是 删除 该 键值 对 并 返回 成功 否则 直接 返回 失败 由于 当前 redis 还没有 原子 命令 直接 支持 这 两步 操作 所以 当前 通常是 使用 lua 脚 本来 执行 解锁 操作 redis 会 保证 脚 本里 的 内容 执行 是 一个 原子 操作 脚本 代码 如下 逻辑 比较简单 ifrediscall getkeys delkeys elsereturnend 两个 参数 的 意义 如下 keys 我们 要 解锁 的 keyargv 我们 加锁 时 的 value 用于 判断 当 锁 是否 还是 我们 持有 如果 被 其他 线程 持有 了 value 就会 发生变化 上述 方法 是 redis 当前 实现 分布式 锁 的 主流 方法 可能 会有 一 些小 优 区别 但是 核心 都是 这个 思路 看着 好像 没啥 毛病 但是 真的 是 这个 样子 吗 让我们 继续 往下 看 redis 分布式 锁 过期 了 还没 处 理完 怎么办 为了 防止 死锁 我们 会给 分布式 锁 加 一个 过期 时间 但是 万一 这个 时间 到了 我们 业务 逻辑 还没 处 理完 怎么办 首先 我们 在 设置 过期 时间 时 要 结合 业务 场景 去 考虑 尽量 设置 一个 比较 合理 的 值 就是 理论上 正常 处理 的话 在 这个 过期 时间内 是 一 定能 处理完毕 的 之后 我们 再来 考虑 对 这个 问题 进行 兜底 设计 关于 这个 问题 目前 常见 的 解决方法 有 两种 守护 线程 续 命 额外 起 一个 线程 定期 检查 线程 是否 还 持有 锁 如果有 则 延长 过期 时间 redisson 里面 就 实现 了 这个 方案 使用 看门狗 定期 检查 每 的 锁 时间 检查 次 如果 线程 还 持有 锁 则 刷新 过期 时间 超时 回 滚 当 我们 解锁 时 发现 锁 已经 被 其他 线程 获 取了 说明 此时 我们 执行 的 操作 已经是 不安全 的 了 此时 需要 进行 回 滚 并 返回 失败 同时 需要 进行 告警 人为 介入 验证 数据 的 正确性 然后 找出 超时 原因 是否 需 要对 超时 时间 进行 优化 等等 守护 线程 续 命 的 方案 有 什么问题 吗 redisson 使用 看门狗 守护 线程 续 命 的 方案 在 大多数 场景 下 是 挺不错 的 也 被 广泛 应用于 生产 环境 但是在 极端 情况下 还是 会 存在 问题 问题 例子 如下 线程 首先 获取 锁 成功 将 键值 对 写入 redis 的 master 节 点在 redis 将该 键值 对 同步 到 slave 节点 之前 master 发 生了 故障 redis 触发 故障 转移 其中 一个 slave 升级 为 新 的 master 此 时新 的 master 并不 包含 线程 写入 的 键值 对 因此 线程 尝试 获取 锁 也 可以 成功 拿到 锁 此时 相当于 有 两个 线程 获取 到了 锁 可能会 导致 各种 预期 之外 的 情况 发生 例如 最常 见 的 脏 数据 解决方法 上述问题 的 根本原因 主 要是 由于 redis 异步 复制 带来 的 数据 不一致 问题 导致 的 因此 解决 的 方向 就是 保证 数据 的 一致 当前 比较 主流 的 解法 和 思路 有 两种 redis 作者 提出 的 实现 的 分布式 锁 redlock 首先 该 方案 也是 基于 文章 开头 的 那个 方案 set 加锁 lua 脚本 解锁 进行 改良 的 所以 antirez 只 描述 了 差异 的 地方 大致 方案 如下 假设 我们 有 n 个 redis 主 节点 例如 n 这些 节点 是 完全 独立 的 我们 不 使用 复制 或 任何 其他 隐 式 协调系统 为了 取到 锁 客户端 应该 执行 以下 操作 获取 当前 时间 以 毫秒 为 单位 依次 尝试 从 个 实例 使用 相同 的 key 和 随机 值 例如 uuid 获取 锁 当 向 redis 请求 获取 锁 时 客户端 应该 设置 一个 超时 时间 这个 超时 时间 应该 小于 锁 的 失效 时间 例如 你 的 锁 自动 失效 时间 为 秒 则 超时 时间 应该在 毫秒 之间 这样 可以 防止 客户端 在 试图 与 一个 宕机 的 redis 节点 对话 时长 时间 处于 阻塞状态 如果 一个 实例 不可用 客户端 应该 尽快 尝试 去 另外 一个 redis 实例 请求 获取 锁 客户端 通过 当前 时间 减去 步骤 记录 的 时间 来 计算 获取 锁 使用 的 时间 当 且 仅 当 从 大多数 n 这里是 个 节点 的 redis 节点 都 取到 锁 并且 获取 锁 使用 的 时间 小于 锁 失效 时间 时 锁 才 算 获取 成功 如果 取 到了 锁 其 真正 有效 时间 等于 初始 有效 时间 减去 获取 锁 所 使用 的 时间 步骤 计算 的 结果 如果 由于 某些 原因 未能 获得 锁 无法 在 至少 n 个 redis 实例 获取 锁 或 获取 锁 的 时间 超 过了 有效 时间 客户端 应该 在所 有的 redis 实例 上 进行 解锁 即便 某些 redis 实例 根 本就 没有 加锁 成功 防止 某些 节点 获 取到 锁 但是 客户端 没有 得到 响应 而 导致 接下来 的 一段时间 不能 被 重新 获取 锁 可以 看出 该 方案 为了 解决 数据 不一致 的 问题 直接 舍弃 了 异步 复制 只 使用 master 节点 同时 由于 舍弃 了 slave 为了 保证 可用性 引 入了 n 个 节点 官方 建议 是 该 方案 看着 挺 美好 的 但是 实际上 我 所 了解 到 的 在 实际 生产上 应用 的 不多 主要有 两个 原因 该 方案 的 成本 似乎 有点 高 需要 使用 个 实例 该 方案 一样 存在 问题 该 方案 主要 存 以下 问题 严重 依赖 系统 时钟 如果 线程 从 个 实例 获取 到了 锁 但是 这个 实例 中 的 某个 实例 的 系统 时间 走 的 稍微 快一点 则 它 持有 的 锁 会 提前 过期 被 释放 当 他 释放 后 此时 又有 个 实例 是 空闲 的 则 线程 也 可以 获 取到 锁 则 可能 出现 两个 线程 同时 持有 锁 了 如果 线程 从 个 实例 获取 到了 锁 但是 万一 其中有 台 重启 了 则 此时 又有 个 实例 是 空闲 的 则 线程 也 可以 获 取到 锁 此时 又 出现 两个 线程 同时 持有 锁 了 针对 以上 问题 其实 后续 也 有人 给出 一些 相应 的 解法 但是 整体 上 来看 还是 不够 完美 所以 目前 实际 应用 得 不是 那么多 使用 缓存 时 先 操作 数据库 or 先 操作 缓存 先 操作 数据库 案例 如下 有 两个 并发 的 请求 一个 写 请求 一个 读 请求 流程 如下 可能 存在 的 脏 数据 时间 范围 更新 数据库 后 失效 缓存 前 这个 时间 范围 很小 通常 不会 超过 几 毫秒 先 操作 缓存 案例 如下 有 两个 并发 的 请求 一个 写 请求 一个 读 请求 流程 如下 可能 存在 的 脏 数据 时间 范围 更新 数据库 后下 一次 对 该 数据 的 更新 前 这个 时间 范围 不确定性 很大 情况 如下 如果 下一次 对 该 数据 的 更新 马上 就 到来 那么 会 失效 缓存 脏 数据 的 时间 就 很短 如果 下一次 对 该 数据 的 更新 要 很久 才 到来 那 这 期间 缓存 保存 的 一直是 脏 数据 时间 范围 很长 结论 通过 上述 案例 可以 看出 先 操作 数据库 和 先 操作 缓存 都会 存在 脏 数据 的 情况 但是 相比之下 先 操作 数据库 再 操作 缓存 是 更优 的 方式 即使 在 并发 极端 情况下 也 只会 出现 很 小量 的 脏 数据 为什么 是 让 缓存 失效 而 不是 更新 缓存 更新 缓存 案例 如下 有 两个 并发 的 写 请求 流程 如下 分析 数据库 中 的 数据 是 请求 b 的 缓存 中 的 数据 是 请求 a 的 数据库 和 缓存 存在 数据 不一致 失效 删除 缓存 案例 如下 有 两个 并发 的 写 请求 流程 如下 分析 由 于是 删除 缓存 所以 不存在 数据 不一致 的 情况 结论 通过 上述 案例 可以 很明显 的 看出 失效 缓存 是 更优 的 方式 如何 保证 数据库 和 缓存 的 数据一致性 在上文 的 案例 中 无论是 先 操作 数据库 还是 先 操作 缓存 都会 存在 脏 数据 的 情况 有 办法 避免 吗 答案 是 有的 由于 数据库 和 缓存 是 两个 不同 的 数据源 要 保证其 数据一致性 其实 就是 典型 的 分布式 事务 场景 可以 引入 分布式 事务 来 解决 常见 的 有 pctccmq 事务 消息 等 但是 引入 分布式 事务 必然会 带来 性 能上 的 影响 这与 我们 当初 引入 缓存 来 提升 性能 的 目的 是 相 违背 的 所以在 实际使用 中 通常 不 会去 保证 缓存 和 数据库 的 强 一致性 而是 做出 一定 的 牺牲 保证 两者 数据 的 最终 一致性 如果是 实在 无法 接受 脏 数据 的 场景 则 比较 合理 的 方式 是 放弃 使用 缓存 直 接走 数据库 保证 数据库 和 缓存 数据 最终 一致性 的 常用 方案 如下 更新 数据库 数据库 产生 binlog 监听 和 消费 binlog 执行 失效 缓存 操作 如果 步骤 失效 缓存 失败 则 引入 重试 机制 将 失败 的 数据 通过 mq 方式 进行 重试 同时 考虑 是否 需要 引入 幂 等 机制 兜底 当 出现 未知 的 问题 时 及时 告警 通知 人为 介入 处理 人为 介入 是 终极 大法 那些 外表 看着 光鲜 艳丽 的 应用 其 背后 大多有 一群 苦 逼 的 程序员 在 不断 的 修复 各种 脏 数据 和 bug 缓存 穿透 描述 访问 一个 缓存 和 数据库 都不 存在 的 key 此 时会 直接 打到 数据库 上 并且 查不到 数据 没法 写 缓存 所以 下一次 同样会 打到 数据库 上 此时 缓存 起 不到 作用 请求 每次 都会 走到 数据库 流 量大 时数 数据库 可能会 被打 挂 此时 缓存 就好 像被 穿 透了 一样 起 不到 任何 作用 解决方案 接口 校验 在 正常 业务流程 中 可能会 存在 少量 访问 不存在 key 的 情况 但是 一般 不会 出现 大量 的 情况 所以 这种 场景 最大 的 可能性 是 遭 受了 非法 攻击 可以 在 最 外层 先 做 一层 校验 用户 鉴 权 数据 合法性 校验 等 例如 商品 查询 中 商品 的 id 是 正整数 则 可以 直接 对 非 正整数 直接 过滤 等等 缓存 空 值当 访问 缓存 和 db 都没有 查询 到 值 时 可以 将 空 值 写进 缓存 但是 设置 较短 的 过期 时间 该 时间 需要 根据 产品 业务 特性 来 设置 布 隆 过滤 器使 用布 隆 过滤器 存储 所有 可能 访问 的 key 不存在 的 key 直接 被 过滤 存在 的 key 则 再进 一步 查询 缓存 和 数据库 布 隆 过滤器 布 隆 过滤器 的 特点是 判断 不存在 的 则 一定 不存在 判断 存在 的 大 概率 存在 但也 有 小 概率 不存在 并且 这个 概率 是 可控 的 我们 可以 让 这个 概率 变小 或者 变 高 取决于 用户 本身 的 需求 布 隆 过滤器 由 一个 bitset 和 一组 hash 函数 算法 组成 是 一种 空间 效率 极高 的 概率 型 算法 和 数据结构 主要 用来 判断 一个 元素 是否 在 集合 中 存 在在 初始 化时 bitset 的 每一位 被 初始 化为 同 时会 定义 hash 函数 例如 有 组 hash 函数 hashhashhash 写入 流程 当 我们 要 写入 一个 值 时 过程 如下 以 jionghui 为 例 首 先将 jionghui 跟 组 hash 函数 分别 计算 得到 bitset 的 下标 为 将 bitset 的 这个 下标 标 记为 假设 我们 还有 另外 两个 值 java 和 diaosi 按 上面 的 流程 跟 组 hash 函数 分别 计算结果 如下 javahash 函数 计算 bitset 下标 为 diaosihash 函数 计算 bitset 下标 为 查询 流程 当 我们 要 查询 一个 值 时 过程 如下 同样 以 jionghui 为 例 首 先将 jionghui 跟 组 hash 函数 分别 计算 得到 bitset 的 下标 为 查看 bitset 的 这个 下标 是否 都为 如果 这个 下标 不 都为 则 说明 该 值 必然 不存在 如果 这个 下标 都为 则 只能 说明 可能 存在 并不能 说明 一定 存在 其实 上图 的 例子 已经 说 明了 这个 问题 了当 我们 只有 值 jionghui 和 diaosi 时 bitset 下标 为 的 有当 我们 又 加入 值 java 时 bitset 下标 为 的 还是 这个 所以 当 bitset 下标 为 的 为时 我们 无法 判断 值 java 存 不存 在其 根本 原因是 不同 的 值 在跟 hash 函数 计算 后 可能会 得到 相同 的 下标 所以 某个 值 的 标记 位 可能 会被 其他 值 给 标 上了 这 也是 为啥 布 隆 过滤器 只能 判断 某个 值 可能 存在 无法 判断 必然 存在 的 原因 但是 反过来 如果 该 值 根据 hash 函数 计算 的 标记 位 没有 全部 都为 那么 则 说明 必然 不存在 这个 是 肯定 的 降低 这种 误判 率 的 思路 也 比较简单 一个是 加大 bitset 的 长度 这样 不同 的 值 出现 冲突 的 概率 就 降 低了 从而 误判 率 也 降低 提升 hash 函数 的 个数 hash 函数 越多 每个 值 对应 的 bit 越多 从而 误判 率 也 降低 布 隆 过滤器 的 误判 率 还有 专门 的 推导 公式 有 兴趣 的 可以 去 搜 相关 的 文 章和 论文 查看 缓存 击穿 描述 某一个 热点 key 在 缓存 过期 的 一瞬间 同时 有 大量 的 请求 打进来 由于 此时 缓存 过期 了 所以 请求 最终 都会 走到 数据库 造成 瞬时 数据库 请求 量大 压力 骤增 甚至 可能 打垮 数据库 解决方案 加 互斥 锁在 并发 的 多个 请求 中 只有 第一个 请求 线程 能 拿到 锁 并 执行 数据库 查询 操作 其他 的 线程 拿不到 锁 就 阻塞 等着 等到 第一个 线程 将 数据 写入 缓存 后 直 接走 缓存 关于 互斥 锁 的 选择 网上 看到 的 大部分 文章 都是 选择 redis 分布式 锁 可以 参考 我 之前 的 文章 面试 必 问 的 分布式 锁 你 懂 了吗 因为 这个 可以 保证 只有 一个 请求 会 走到 数据库 这是 一种 思路 但是 其实 仔细 想想 的话 这边 其实 没有必要 保证 只有 一个 请求 走到 数据库 只要 保证 走到 数据库 的 请求 能 大大 降低 即可 所以 还有 另一个 思路 是 jvm 锁 jvm 锁 保证 了 在 单 台 服务器 上 只有 一个 请求 走到 数据库 通常 来说 已经 足够 保证 数据库 的 压力 大大 降低 同时 在 性 能上 比 分布式 锁 更好 需要 注意 的 是 无论是 使用 分布式 锁 还是 jvm 锁 加锁 时 要按 key 维度 去 加锁 我 看 网上 很多 文章 都是 使用 一个 固定 的 key 加锁 这样 会 导致 不同 的 key 之间 也 会 互相 阻塞 造成 性能 严重 损耗 使用 redis 分布式 锁 的 伪 代码 仅供参考 stringkey key 缓存 值 过期 if valuenull lockredis 专门 用于 加锁 的 redisempty 加锁 的 值 随便 设置 都可以 if lockredisset try 查询 数据库 并 写到 缓存 让 其他 线程 可以 直 接走 缓存 key redisset catch exceptione 异常 处理 finally 释放 锁 lockredisdelete key elsesleepms 后 进行 重试 threadsleep returngetdata key returnvalue 热点 数据 不 过期 直接 将 缓存 设置 为 不 过期 然 后由 定时 任务 去 异步 加载 数据 更新 缓存 这种 方式 适用于 比较 极端 的 场景 例如 流量 特别 特别 大 的 场景 使 用时 需要 考虑 业务 能 接受 数据 不一致 的 时间 还有 就是 异常情况 的 处理 不要 到时候 缓存 刷新 不 上 一直是 脏 数据 那就 凉了 缓存 雪崩 描述 大量 的 热点 key 设置 了 相同 的 过期 时间 导 在 缓 存在 同一 时刻 全部 失效 造成 瞬时 数据库 请求 量大 压力 骤增 引起 雪崩 甚至 导致 数据库 被打 挂 缓存 雪崩 其实 有点像 升级版 的 缓存 击穿 缓存 击穿 是 一个 热点 key 缓存 雪崩 是 一组 热点 key 解决方案 过期 时间 打散 既然是 大量 缓存 集中 失效 那 最 容易 想到 就是 让 他们 不 集中 生效 可以 给 缓存 的 过期 时间 时 加上 一个 随机 值 时间 使得 每个 key 的 过期 时间 分布 开来 不会 集中 在 同一 时刻 失效 热点 数据 不 过期 该 方式 和 缓存 击穿 一样 也是 要 着重 考虑 刷新 的 时间 间隔 和 数据 异常 如何 处理 的 情况 加 互斥 锁 该 方式 和 缓存 击穿 一样 按 key 维度 加锁 对于 同一个 key 只允许 一个 线程 去 计算 其他 线程 原地 阻塞 等待 第一个 线程 的 计算结果 然后 直 接走 缓存 即可 最后 恭喜 你 老哥 能 看到 这边 你 已经 超越 了 不少人 了 文中 有些 题目 还是 有点 深度 的 但是 如能 掌握 相信 定能 助你 在 对线 大厂 面试官 时 不落 下风 建议 收藏 反复 阅读 有疑问 的 地方 欢迎 留言 我 看到 后 都会 回复 我 是 囧 辉 一个 坚持 分享 原创 技术 干货 的 程序员 我 的 目标 是 帮助 大家 拿到 心仪 的 大厂 offer 我们 下期 见 