如何 利用 缓存 机制 实现 java 类 反射 性能 提升 30倍 一次 性能 提 高倍 的 java 类 反射 性能 优化 实践 文章 来源 宜 信 技术学院 amp 宜 信 支付 结算 团队 技术 分享 第 期 支付 结算 部 支付 研发 团队 高级工程师 陶红 java 类 反射 技术 amp 优化 分享 者 宜 信 支付 结算 部 支付 研发 团队 高级工程师 陶红 原文 首 发于 宜 信 支付 结算 技术 团队 公 号 野 指针 在 实际 工作中 的 一些 特定 应用 场景 下 java 类 反射 是 经常 用到 必不可少 的 技术 在 项目 研发 过程中 我们 也 遇到 了 不得不 运用 java 类 反射 技术 的 业务 需求 并且 不可避免 地 面临 这个 技术 固有 的 性能 瓶颈 问题 通过 近两年 的 研究 尝试 和 验证 我们 总 结出 一套 利用 缓存 机制 大幅度 提高 java 类 反射 代码 运行 效率 的 方法 和 没有 优化 的 代码 相比 性能 提高了 倍 本文 将与 大家 分享 在 探索 和 解决 这个 问题 的 过程中 的 一些 有价值 的 心得体会 与 实践经验 简述 java 类 反射 技术 首 先用 最 简短 的 篇幅 介绍 java 类 反射 技术 如果 用 一句话 来 概述 java 类 反射 技术 就是 绕开 编译器 在运 行期 直接 从 虚拟机 获取 对象 实例 访问 对象 成员 变量 调用 对象 的 成员 函数 抽象 的 概念 不多 讲 用 代码 说话 举个 例子 有 这样 一个 类 stringfield thisfieldfield 如果 按照 下列 代码 来 使用 这个 类 就是 传统 的 创建 对象 调用 模式 objsetfield value objgetfield 如果 按照 如下 代码 来使 用它 就是 类 反射 模式 直接 获取 对象 实例 直接 访问 field true fieldset objvalue 调用 对象 的 public 函数 getfield string methodinvoke obj 类 反射 属于 古老 而 基础 的 java 技术 本文 不再 赘述 从上 面的 代码 可以 看出 相比较 于 传统 的 创建 对象 调用 模式 类 反射 模式 的 代码 更 抽象 一般 情况下 也 更加 繁琐 类 反射 绕 开了 编译器 的 合法性 检测 比如 访 问了 一个 不存在 的 字段 调 用了 一个 不存在 或 不允许 访问 的 函数 因为 编译器 设立 的 防火墙 失效 了 编译 能够 通过 但是 运行 的 时候 会 报错 实际上 如果 按照 标准 模式 编写 类 反射 代码 效率 明显 低于 传统 模式 在后 面的 章 节会 提到 这一点 缘起 为什么 使用 类 反射 前文 简略 介绍 了 java 类 反射 技术 在 与 传统 的 创建 对象 调用 模式 对比 时 提 到了 类 反射 的 几个 主要 弱点 但是在 实际 工作中 我们 发现 类 反射 无处不在 特别是在 一些 底层 的 基础 框架 中 类 反射 是 应用 最为 普遍 的 核心技术 之一 最常 见 的 例子 spring 容器 这是 为什么 呢 我们 不妨 从实 际 工作中 的 具体 案例 出发 分析 类 反射 技术 的 不可 替代 性 大家 几乎 每天 都 和 银行 打交道 通过 银行 进行 存款 转帐 取 现 等 金融业务 这些 动 账 操作 都是 通过 银行 核心 系统 包括 交易 核心 账务 核心 对外 支付 超级 网 银 等 模块 完成 的 因为 历史 原因 造成 的 技术 路径 依赖 银行 核心 系统 的 报文 几乎 都是 xml 格式 而且 以 这种 格式 最为 普遍 其它 字段 略过 其它 段落 略过 和 常用 的 xml 格式 进行 对比 银行 核心 系统 的 xml 报文 不是 用 标签 的 名字 区分 元素 而是 用 属性 name 属性 区 分在 解析 的 时候 不管是 用 domsax 还是 digester 或 其它 方案 都 要用 条件 判断 语句 分支 处理 伪 代码 如下 接口 类 实例 objnew 接口 类 获取 xml 标签 列表 for if nodegetproperty name 张三 objset 张三 nodegetvalue elseif nodegetproperty name 李四 objset 李四 nodegetvalue 显而易见 这样 的 代码 非常 粗劣 不 优雅 每 解析 一个 接口 的 报文 都 要写 一个 专门 的 类 或者 函数 堆砌 大量 的 条件 分支 语句 难写 难 维护 如果 报文 结构 简单 还好 如果有 一百个 甚至 更多 的 字段 怎么办 毫不 夸 张在 实际 工作中 我 遇到过 一个 银行 核心 接口 有 多个 字段 的 情况 而且 这还 不是 最多 的 试 水 优雅 地 解析 xml 当 我们 碰到 这种 结构 的 xml 而且 字段 还 特别 多 的 时候 解决问题 的 钥匙 就是 类 反射 技术 基本思路 是 从 xml 中 解析 出 字段 的 name 和 value 以 键值 对 的 形式 存储 起 来用 类 反射 的 方法 用 键值 对 的 name 找到 字段 或 字段 对应 的 setter 这是 有 规律 可循 的 然后 把 value 直接 set 到 字段 或者 调用 setter 把 值 set 到 字段 接口 类 应该是 这样 的 结构 nodes 是 存储 字段 的 namevalue 键值 对 的 列表 messagenode 就是 键值 对 结构 如下 stringname stringvalue super createnode 是 在 解析 xml 的 时候 把 键值 对 添加到 列表 的 函数 initialize 是 用 类 反射 方法 根据 键值 对 初始化 每个 字段 的 函数 这样 解析 xml 的 代码 可以 变得 非常 优雅 简洁 如果 用 digester 解析 之前 列举 的 那种 格式 的 银行 报文 可以 这样 写 false parseobj sysheader digesterparse newstringreader msg initialize 函数 的 代码 可以 写在 一个 基 类 里面 子类 继承 基 类 即可 具体 代码 如下 for try 直接 获取 字段 然后 设置 字段 值 nodegetname 只 获取 调用者 自己 的 修饰词 皆可 fieldname 获取 调用者 自己 的 修饰词 皆可 和 从父 类 继承 的 field 必须 是 public 修饰词 getfield fieldname 把 field 设为 可写 true 直接 设置 field 的 值 fieldset 通过 setter 设置 字段 值 nodegetname 调用 catch exceptione logdebug e 上面 被 注释 的 段落 是 直接 访问 field 的 方式 下面 的 段落 是 调用 setter 的 方式 两种 方法 在 效率 上 没有 差别 考虑到 java 语法 规范 书写 bean 的 规范 调用 setter 是 更 通用 的 办法 因为 接口 类 可能是 被 继承 派生 的 子类 无法访问 父 类 用 private 关键字 修饰 的 fieldgetsetter 函数 很简单 就是 用 field 的 名字 反推 setter 的 名字 然 后用 类 反射 的 办法 获取 setter 代码 如下 stringfieldname fieldname 获取 field 的 setter 只 要是 用 public 修饰 的 setter 不管是 自己 的 还是 从父 类 继承 的 都能 取到 getmethod 如果 设计 得好 甚至 可以用 一个 解析 函数 处理 所有 的 接口 这 涉及到 digerser 的 运用 技巧 和 接口 类 的 设计 技巧 本文 不作 深入 讲解 年 我们 在 一个 和 银行 有关 的 金融 增值 服务项目 中使 用了 这个 解决方案 取得了 非常 不错 的 效果 之后 在 公司内部 推广 开来 成 为了 通用 技术 架构 经过 一年多 的 实践证明 这套 架构 性能 稳定 可靠 极 大地 简 化了 代码 编写 和 维护 工作 显著 提高了 生产 效率 问题 类 反射 性能 差 但是 随着 业务量 的 增加 年末 在 进行 压力 测试 的 时候 发现 解析 xml 的 代码 占用 cpu 资源 居高不下 进一步 分析 定位 发现问题 出在 类 反射 代码 上 在 某些 极端 的 业务 场景 下 甚至会 占用 的 cpu 资源 这就 提 出了 性能 优化 的 迫切要求 类 反射 的 性能 优化 不是 什么 新 课题 因此有 一些 成熟 的 第三方 解决方案 可以 参考 比如 运用 比较 广泛 的 reflectasm 据称 可以 比 未经 优化 的 类 反射 代码 提高 左右 的 性能 参考资料 java 高性能 反射 工具包 高效率 java 反射 机制 原理 在 研究 了 reflectasm 的 源代码 以后 我们 决定 不 使用 现成 的 第三方 解决方案 而是 从 底层 入手 自行解决 类 反射 代码 的 优化 问题 主要 基于 两点 考虑 reflectasm 的 基本 技术 原理 是 在运 行期 动态 分析 类 的 结构 把 字段 函数 建立 索引 然后 通过 索引 完成 类 反射 技术上 并不 高深 性能 也 谈不上 完美 类 反射 是 我们 系统 使用 的 关键技术 使用 场景 调用 频率 都 非常 高 从 自主 掌握 和 控制 基础 核心技术 实现 系统 的 性能 最 优化 角度 考虑 应该 尽量 从 底层 技术 出发 独立 可控 地 完成 优化 工作思路 和 实践 缓存 优化 前面 提到 reflectasm 给 类 的 字段 函数 建立 索引 借此 提高 类 反射 效率 进一步 分析 这 实际上 是 变相 地 缓存 了 字段 和 函数 那么 在 我们 面临 的 业务 场景 下 能不 能用 缓存 的 方式 优化 类 反射 代码 的 效率 呢 我们 的 业务 场景 需 要以 类 反射 的 方式 频繁 调用 接口 类 的 setter 这些 setter 都是 用 public 关键字 修饰 的 函数 先是 getmethod 然后 invoke 基于 以上 特点 我们 用 如下 逻辑 和 流程 进行了 技术 分析 用 调试 分析 工具 统计 出 每 一句 类 反射 代码 的 执行 耗时 结果 发现 性能 瓶颈 在 getmethod 分析 java 虚拟机 的 内存 模型 和 管理机制 寻找 解决问题 的 方向 java 虚拟机 的 内存 模型 可以 从 下面 两个 维度 来 描述 a 类 空间 对象 空间 维度 b 堆栈 维度 从 java 虚拟机 内存 模型 可以 看出 getmethod 需要 从不 连续 的 堆 中 检索 代码 段 定位 函数 入口 获得了 函数 入口 invoke 之后 就和 传统 的 函数 调用 差不多 了 所以 性能 瓶颈 在 getmethod 代码 段 属于 类 空间 也有 资料 将其 描述 为 函数 空间 代码 空间 类 被 加载 后 除非 虚拟机 关闭 函数 入口 不会 变化 那么 只 要把 setter 函数 的 入口 缓存 起来 不就 节约 了 getmethod 消耗 的 系统资源 进而 提高了 类 反射 代码 的 执行 效率 吗 把 接口 类 修 改为 这样 的 结构 标 红 的 部分 是 新增 或 修改 settermap 就是 缓存 字段 setter 的 hashmap 为什么 是 两层 嵌套 结构 呢 因为 这个 map 是 写在 基 类 里面 的 静态 变量 每个 从 基 类 派 生出 的 接口 类 都 用它 缓存 setter 所以 第一层 要 区分 不同 的 接口 类 第二层 要 区分 不同 的 字段 如 下图 所示 当 classloader 加载 基 类 时 创建 settermap 内容 为 空 这样 写 可以 保证 settermap 只 被 初始化 一次 initialize 函数 作 如下 改进 先 检查 子类 的 setter 是否 被 缓存 getname if settermapget classname null settermapput classname 遍历 报文 节点 for try 检查 对应 的 setter 是否 被 缓存 了 nodegetname if methodnull 没有 缓存 先 获取 再 缓存 nodegetname settersput nodegetname method 用 类 反射 方式 调用 catch exceptione logdebug e 基本思路 就是 把 setter 缓存 起来 通过 messagenode 的 name 字段 的 名字 找 setter 的 入口 地址 然后 调用 因为 只 在 初始化 第一个 对象 实例 的 时候 调用 getmethod 极 大地 节约 了 系统资源 提高了 效率 测试 结果 也 证实 了 这一点 验证 测试 方法 和 标准 先写 一个 测试 类 结构 如 下在 构造 函数 中用 uuid 初始化 存储 键值 对 的 列表 uuidrandomuuid tostring hashcode thiscreatenode uuidrandomuuid tostring hashcode 之所以 用 uuid 是 保证 每个 实例 每个 字段 的 值 都不 一样 避免 java 编译器 自动 优化 代码 而 破坏 测试 结果 的 原始 性 initializeori 函数 是 用 传统 的 硬 编码 方式 直接 调用 setter 的 方法 初始化 实例 字段 代码 如下 for if nodegetname test thissettest nodegetvalue elseif nodegetname test thissettest nodegetvalue 优化 效果 就以 它 作为 对照 标准 对照 标准 就是 没有 优化 的 类 反射 代码 checkunifomity 函数 用来 验证 代码 是否 用 namevalue 键值 对 正确地 初始 化了 各 字段 for if nodegetname test equals thistest nodegetname test equals thistest 每一种 优化 方案 我们 都会 用它 验证 实例 的 字段 是否 正确 只要 出现 一次 错误 该 方案 就 会被 否定 创建 万个 testinvoke 类 的 实例 然后 循环 调用 每一个 实例 的 initializeori 函数 传统 的 硬 编码 非类 反射 方法 记录 执行 耗时 只 记录 初始化 耗时 创建 实例 的 耗时 不 记录 再 创建 万个 实例 循环 调用 每一个 实例 的 类 反射 初始化 函数 未 优化 记录 执行 耗时 再 创建 万个 实例 改成 调用 优化 后 的 类 反射 初始化 函数 记录 执行 耗时 以上 是 一个 测试 循环 得到 三种 方法 的 耗时 数据 重复 做 次 得到 三组 耗时 数据 把 记 录下 的 数据 去掉 最大 最小值 剩下 的 求 平均值 就是 该 方法 的 平均 耗时 某一 种方法 的 平均 耗时 越短 则 认为 该 方法 的 效率 越高 为了 进一步 验证 三种 方法 在 不同 负载 下 的 效率 变化 规律 改成 创建 万个 实例 重复 两步 得到 另一组 测试 数据测试 结果 显示 在 确保 测试 环境 稳定 一致 的 前提 下个 字段 的 测试 实例 初始化 万个 对象 传统 方法 硬 编码 耗时 毫秒 没有 优化 的 类 反射 方法 耗时 毫秒 优化 后 的 类 反射 代码 耗时 毫秒 万个 测试 对象 的 情况 三种 方法 的 耗时 也 大致 是 这样 的 比例关系 这个 数据 取决于 测试 环境 的 资源 状况 不同 的 机器 不同 时刻 的 测试 结果 都有 出入 但 总 的 规律 是 稳定 的 基于 测试 结果 可以 得出 这样 的 结论 缓存 优化 的 类 反射 代码 比 没有 优化 的 代码 效率 提 高倍 左右 比 传统 的 硬 编码方法 提高了 有 必要 强调 的 是 这个 结论 偏向 保守 和 reflecasm 相比 性能 大幅度 提高 也是 毋庸置疑 的 第一次 迭代 忽略 字段 缓存 优化 的 效果 非常好 但是 这个 方案 真的 完美无缺 了 么 经过 分析 我们 发现 如果 数据 更 复杂 一些 这个 方案 的 缺陷 就 暴 露了 比如 键值 对 列 表里 的 值 在 接口 类 里面 并没有 定义 对应 的 字段 或者是 没有 对应 的 可以 访问 的 setter 性能 就会 明显 下降 这种 情况 在 实际 业务 中 是 很 常见 的 比如 对接 银行 核心 接口 往往 并不需要 解析 报文 的 全部 字段 很多 字段 是 可以 忽略 的 所以 接口 类 里面 不用 定义 这些 字段 但 解析 代码 依然 会把 这些 键值 对 全部 解析 出来 这时 就 会给 优化 代码 造成 麻 烦了 分析 过程 如下 举例 而言 如果 键值 对 里 有 两个 值 在 在 接口 类 interface 并未 定义 假定 名字 是 fieldxfiledy 第一次 执行 initialize 函数 初始 状态下 settermap 检索 不到 interface 类 的 setter 缓存 initialize 函数 会在 第一次 执行 的 时候 根据 键值 对 的 名字 调用 getmethod 函数 初始化 sertter 引用 的 缓存 因为 fieldx 和 fieldy 字段 不存在 找不到 它们 对应 的 setter 缓存 里 也没有 它们 的 引用 第二次 执行 initialize 函数 也 就是 初始化 第二个 对象 实例 键值 对 都 能在 缓存 中找到 setter 的 引用 调用 速度 很快 但 缓存 里 找不到 fieldxfieldy 的 setter 的 引用 于是 再次 调用 getmethod 函数 而 因为 它们 的 setter 根本 不存在 连 这两个 字段 都不 存在 做的 是 无用功 settermap 的 状态 没有 变化 第三次 第四 次第 n 次 都是 如此 白白 消耗 系统资源 运行 效率 必然 下降 测试 结果 印证 了 这个 推断 在 testinvoke 的 构造 函数 增加了 两个 不存在 对应 字段 和 setter 的 键值 对 姑且 称之为 无效 键值 对 进行 万个 实例 的 初始化 测试 经过 优化 的 类 反射 代码 耗时 从 原来 的 毫秒 增加到 毫秒 性能 下降 倍 左右 如果 增加 更多 的 键值 对 不存在 对应 字段 性能 下降 更 严重 所以 必须 进一步 完善 优化 代码 为了 加以 区分 我们 把 之前 的 优化 代码 称为 v 版 进一步 完善 的 代码 称为 v 版 怎么 完善 从上 面的 分析 不难 找到 思路 增加 忽略 字段 ignorefield 缓存 基 类 basemodel 作 如下 修改 标 红 部分 是 新增 或者 修改 增加了 的 数据结构 类似于 settermap 但 第二层 不是 hashmap 而是 set 缓存 每个 子类 需要 忽略 的 键值 对 的 名字 使用 set 更 节约 系统资源 如 下图 所示 同样 的当 classloader 加载 基 类 的 时候 创建 ignoremap 内容 为 空 initialize 函数 作 如下 改进 先 检查 子类 的 setter 是否 被 缓存 getname if settermapget classname null settermapput if ignoremapget classname null ignoremapput classname classname 遍历 报文 节点 for try 检查 该 字段 是否 被 忽略 if ignorescontains sname continue 检查 对应 的 setter 是否 被 缓存 了 sname if methodnull 没有 缓存 先 获取 再 缓存 sname settersput snamemethod 用 类 反射 方式 调用 catch logdebug 找不到 对应 的 setter 放到 忽略 字段 集合 以后 不再 尝试 ignoresadd sname catch logerror try 不能 调用 setter 可能是 虚拟机 回 收了 该 子类 的 全部 实例 入口 地址 变化 更新 地址 再试一次 sname settersput snamemethod methodinvoke catch exceptione logdebug catch exceptione logerror 虽然 代码 复杂 了 一些 但 思路 很简单 用 键值 对 的 名字 寻找 对应 的 setter 时 如果 找不到 就把 它 放进 ignoremap 下次 不再 找了 另外 还 增加了 对 setter 引用 失效 的 处理 虽然 理论 上说 只要 虚拟机 不 重启 setter 的 入口 引用 永远 不会 变在 测试 中 也 从来没有 遇到过 这种 情况 但 为了 覆盖 各种 异常情况 还是 增加了 这段 代码 继续 沿用 前面 的 例子 分析 改进 后 的 代码 的 工作 流程 第一次 执行 initialize 函数 实例 的 状态 是 这样 变化 的 因为 fieldx 和 fieldy 字段 不存在 找不到 它们 对应 的 setter 它们 被 放到 ignoremap 中 再次 调用 initialize 函数 的 时候 因为 检 查到 ignoremap 中 存在 fieldx 和 fieldy 这两个 键值 对 被 跳过 不再 徒劳无功 地 调用 getmethod 其它 逻辑 和 v 版 相同 没有 变化 还是 用 上面 提到 的 testinvoke 类 作 验证 个 字段 个 无效 键值 对 v 版本 虽然 代码 更 复杂 了 但 万条 纪录 的 初始化 耗时 为 毫秒 v 版 代码 这个 时候 的 耗时 猛 增到 毫秒 哪怕 增加 更多 的 无效 键值 对 v 版 代码 耗时 增加 也 不明 显而 这种 情况下 v 版 代码 的 效率 还会 进一步 下降 至此 对 java 类 反射 代码 的 优化 已经 比较完善 覆 盖了 各种 异常情况 如前所述 我们 把 这个 版本 称为 v 版 第二次 迭代 逆向 思维 这样 就 代表 优化 工作 已经 做到 最好 了吗 不是 这样 的 仔细观察 vv 版 的 优化 代码 都是 循环 遍历 键值 对 用 键值 对 的 name 和 字段 的 名字 相同 推算 setter 的 函 数名 然 后去 寻找 setter 的 入口 引用 第一次 是 调用 类 反射 的 getmethod 函数 以后 是 从 缓存 里面 检索 如果 存在 无效 键值 对 那就 必然 出现 空转 循环 哪怕是 v 版 代码 ignoremap 也 不能 避免 这种 空转 循环 虽然 单 次 空转 循环 耗时 非常 短 但在 无效 键值 对比 较多 负载 很大 的 情况下 依然 有 无效 的 资源 开销 如果 采用 逆向 思维 用 setter 去 反推 检索 键值 对 又会 如何 先 分析 业务 场景 以及 由 业务 场景 所 决定 的 数据结构 特点 接口 类 的 字段 数量 可能 大于 setter 函数 的 数量 因为 可能 需要 一些 内部 使用 的 功能性 字段 并不是 从 xml 报文 里 解析 出来 的 xml 报文 里 解 析出 的 键值 对 和 字段 是 交集 关系 多数 情况下 键值 对 的 数量 包 含了 接口 类 的 字段 并且 大 概率 存在 一些 不需要 的 键值 对 相比较 字段 setter 函数 和 需要 解析 的 键值 对 最 接近于 一一对应 关系 出现 空转 循环 的 概率 最小 因为 接口 类 编写 要 遵守 java 编程 规范 从 setter 函数 的 名字 反推 字段 的 名字 进而 检索 键值 对 是 可行 可靠 的 综上所述 逆向 思维 用 setter 函数 反推 检索 键值 对 初始化 接口 类 就是 第二次 迭代 的 具体 方向 需 要把 接口 类 修 改成 这样 的 结构 标 红 的 部分 是 新增 或者 修改 为了 便于 逆向 检索 键值 对 nodes 字段 改成 hashmapkey 是 键值 对 的 名字 value 是 键值 对 的 值 为了 提高 循环 遍历 的 速度 settermap 的 第二层 改成 链表 链表 的 成员 是 内 部类 fieldsetter 结构 如下 methodmethod super 的 第二层 继续 使用 hashmap 也 能 实现 功能 但 循环 遍历 的 效率 hashmap 不如 链表 所以 我们 改用 链表 同样 的 settermap 在 基 类 被 加载 的 时候 创建 内容 为 空 第一次 初始化 某个 接口 类 的 实例 时 调用 initsetters 函数 初始化 getname 遍历 类 的 可 调用 函数 for getmethods 如果 从 名字 推断 是 setter 函数 添加到 setter 函数 列表 if set 反推 field 的 名字 settersadd newfieldsetter fieldnamemethod 缓存 类 的 setter 函数 列表 settermapput 返回 可 调用 的 setter 函数 列表 函数 修 改为 如下 逻辑 从 缓存 获取 接口 类 的 setter 列表 thisgetclass getname 如果 还没有 缓存 初始化 接口 类 的 setter 列表 if settersnull 遍历 接口 类 的 setterfor 用 setter 的 名字 也 就是 字段 的 名字 检索 键值 对 fieldname 没有 检索 到 键值 对 或者 键值 对 没有 赋值 跳过 if fieldvalue 用 类 反射 方式 调用 thisfieldvalue catch logerror 不能 调用 setter 可能是 虚拟机 回 收了 该 子类 的 全部 实例 入口 地址 变化 更新 地址 再试一次 fieldname settersetmethod method methodinvoke thisfieldvalue catch exceptione logdebug catch exceptione logerror 不妨 把 这 版 代码 称为 v 继续 沿用 前面 testinvoke 的 例子 分析 改进 后 代码 的 工作 流程 第一次 执行 initialize 函数 实例 的 状态 是 这样 变化 的 通过 settermap 反向 检索 键值 对 的 值 fieldxfieldy 因为 不存在 对应 的 setter 不 会被 检索 避免了 空转 之后 每一次 初始化 对象 实例 都不 需要 再 初始化 settermap 也 不会 消耗 任何 资源 去 检索 fieldxfieldy 最大 限度 地 节省 资源 开销 因为 取 消了 ignoremap 取 消了 v 版 判断 字段 是否 应 该被 忽略 的 逻辑 代码 更 简洁 也 能 节约 一部分 资源 结果 数据 显示 用 testinvoke 测试 类 个 setter 个 无效 键值 对 的 情况下 进行 万万个 实例 两个 量级 的 对比 测试 v 版 比 v 版 性能 最多 提高 左右 万 实例 初始化 耗时 毫秒 如果 增加 无效 键值 对 的 数量 性能 提高 更为 明显 没有 无效 键值 对 的 最理想 情况下 vvv 版本 的 代码 效率 没有 明显 差别 至此 用 缓存 机制 优化 类 反射 代码 的 尝试 已经 比较 接近 最优 解了 v 版本 的 代码 可以 视为 到目前为止 最好 的 版本 总结 和 思考 方法论 总结 过去 两年 围绕着 java 类 反射 性能 优化 这个 课题 我们 所 进行 的 探索 和 研究 提高到 方法论 层面 可以 提炼出 一个 分析 问题 解决问题 的 思路 和 流程 供 大家 参考 从 实践中 来 多数 情况下 探索 和 研究 的 课题 并不是 坐在 书斋 里 凭空 想出来 的 而是 在 实际 工作中 遇到 具体 的 技术 难 点在 现实 需求 的 驱动 下 发现 需要 研究 的 问题 以 本文 为 例 如果 不是 在 对接 银行 核心 系统 的 时候 遇 到了 大量 的 格式 奇特 的 xml 报文 不会 促使 我们 尝 试用 类 反射 技术 去 优雅 地 解析 报文 也就 不会 面对 类 反射 代码 执行 效率 低 的 问题 自然 不会有 后续 的 研究成果 拿出 手术刀 解剖 一只 麻雀 在实践中 遇 到了 困难 首先要 分析 和 研究 面对 的 问题 不能 着急 要有 解剖 一只 麻雀 的 精神 抽丝剥茧 把 问题 的 根源 找出来 这个 过程中 逻辑 分析 和 实 操 验证 都是 必不可少 的 没有 高屋建瓴 的 分析 就 容易 迷失 大方向 没有 实 操 验证 大 概率 会 陷入 坐而论道 脑 补 的 怪圈 还是 那句话 实践 是 最 宝贵 的 财富 也是 验证 一切 构想 的 终极 考官 是 我们 认识 世界 改造 世界 的 力量 源泉 但 我们 也 不能 陷入 庸俗 的 经验主义 不管怎么说 这个 世界 的 基石 是 有 逻辑 的 回到 本文 的 案例 我们 一方面 研究 java 内存 模型 从 理论上 探寻 类 反射 代码 效率 低下 的 原因 另一方面 也 在 实务 层面 用 实实在在 的 时间 戳 验证 了 java 类 反射 代码 的 耗时 分布 理论 和 实践 的 结合 才能 让我们 找到 解决问题 的 正确方向 二者 不可偏废 头脑 风暴 勇于创新 分析 问题 找到 关键 点 接下来 就是 寻找 解决方案 java 程序员 有 一个 很大 的 优势 同时 也是 很大 的 劣势 第三方 解决方案 非常丰富 java 生态 比较完善 我们 面临 的 麻烦 和 问题 几乎 都有 成熟 的 第三方 解决方案 吃 现成 的 是 优势 也是 劣势 很多 时候 我们 的 创造力 也 因此 被 扼杀 所以 当面 临高 价值 需求 的 时候 应该 拿出 大无畏 的 勇气 啃 硬骨头 做 底层 和 原创 的 工作 就 本文 案例 而言 reflexasm 就是 看起来 很不错 的 方案 比 传统 的 类 反射 代码 性能 提 升了 至少 三分之一 但是 它真 的 就是 最优 解 么 我们 的 实践 否定 了 这一点 java 程序员 要有 吃苦耐劳 以 底层 技术 为 原点 解决问题 的 精神 否则 你 就 会被 别人 所 绑架 失去 寻求 技术 自由空间 的 机会 中国 的 软件 行业 已经 发展 到了 这个 阶段 提 出了 这样 的 需求 我们 应该 顺应 历史潮流 螺旋式 发展 波浪式 前进 研究 问题 和 解决问题 迭代 是非 常 有效 的 工作方法 首先 要有 精益求精 的 态度 不断改进 逼近 最优 方案 迭代 必不可少 其次 对于 比较复杂 的 问题 不要 追求 毕其功于一役 把 一个 大 的 目标 拆 分成 不同 阶段 分步 实施 逐渐 推进 这种 情况下 迭代 更是 解决问题 的 必由之路 我们 解决 java 类 反射 代码 的 优化 问题 就是 经过 两次 迭代 写了 三个 版本 才 得到 最终 的 结果 逼 近了 最优 解 在 迭代 的 过程 中会 逐渐 发现 一些 之前 忽略 的 问题 这 就是 宝贵 的 经验 这些 经验 在 解决 其他 技术问题 时 也 能 发挥作用 比如 hashmap 的 数据结构 非常 合理 经典 平时 使用 的 时候 效率 是 很高 的 如果 不是 迭代 开发 逼近 极限 的 过程 我们 又 怎么可能 发 现在 循环 遍历 状态下 它 的 性能 不如 链表 呢 行文 至此 文章 也 快要 写 完了 细心 的 读者 一定 会有 一个 疑问 自始至终 举 的 例 子类 的 字段 都是 string 类型 类 反射 代码 根本 没有 考虑 setter 的 参数 类型 不同 的 情况 确 实是 这样 的 因为 我们 解决 的 是 银行 核心 接口 报文 解析 的 问题 接口 字段 全部是 string 没有 其它 数据类型 其实 对 类 反射 技术 的 研究 深入 到 这个 程度 解决 这个 问题 并且 维持 代码 的 高效率 易如反掌 比如 给 fieldsetter 类 增加 一个 数据类型 的 字段 初始化 settermap 的 时候 把 接口 类 对应 的 字段 的 数据类型 解析 出来 和 setter 函数 的 入口 一起 缓存 类 反射 调用 setter 时 把 参数 格式 转换 一下 就可以 了 限于 篇幅 这个 问题 就不 展 开了 感兴趣 的 读者 可以 自己 尝试 一下 