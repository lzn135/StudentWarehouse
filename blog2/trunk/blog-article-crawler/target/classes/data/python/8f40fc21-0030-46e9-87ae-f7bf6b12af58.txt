译 apt 分析 报告 04.kraken 新型 无 文件 apt 攻击 利用 windows 错误报告 服务 逃避 检测 这是 作者 新开 的 一个 专栏 主要 翻译 国外 知名 的 安全 厂商 apt 报告 文章 了解 它们 的 安全 技术 学习 它们 溯源 apt 组织 的 方法 希望 对 您 有所 帮助 前文 分享 了 apt 组织 fincarbanak 的 tirion 恶意 软件 包括 opblueraven 行动 这篇 文章 将 介绍 一种 新型 无 文件 apt 攻击 kraken 它会 利用 windows 错误报告 服务 逃避 检测 其中 dllmain 函数 反 分析 检查 以 确保 它 不在 分析 沙箱 环境 或 调试器 中 运行 非常 值得 我们 学习 malwarebytes 研究人员 发现了 一种 名为 kraken 的 新 攻击 该 攻击 利用 windows 错误报告 wer 服务 以 逃避 检测 攻击 始于 一个 包含 的 zip 文件 该 文档 包含 一个 恶意 宏 该 宏 使用 cactustorchvba 模块 的 修改版 通过 使用 vbscript 将 net 编译 的 二进制 文件 加 载到 内存 中 来 执行 以 进行 无 文件 攻击 该 二进制 文件 通过 将 嵌入式 shellcode 注入 windows 错误报告 服务 werfaultexe 来 推 进了 感染 链 此 策略 用于 尝试 逃避 检测 原文 标题 原文 链接 文章 作者 发布 时间 年月日 文章 来源 文章 目录 恶意 诱饵 您 的 赔偿 分析 最终 的 shellcode 究竟是 哪个 apt 组织 的 攻击 呢 年月日 我们 发现了 一种 名为 kraken 的 新 攻击 该 攻击 将其 有效载荷 注入 到 windows 错误报告 服务 中 作为 一种 防御 规避 机制 这个 报告 服务 是 werfaultexe 通常 发 生在 与 操作系统 windows 函数 或 应用程序 相关 的 错误 时 调用 当 受害者 看到 他们 的 计算 机上 运行 werfaultexe 时 他们 可能 认为 发 生了 一些 错误 而在 这种 情况下 他们 实际上 已成为 攻击 的 目标 尽管 这项 技术 不是 什么 新技术 但这次 行动 很 可能是 一个 apt 组织 发动 的 该 组织 先前 曾 使用 网络 钓鱼 攻击 诱使 受害者 提出 工人 赔偿 要求 威胁 攻击者 入侵 了 一个 网站 以 托管 其 有效载荷 然后 使用 cactustorch 框架 执行 无 文件 攻击 filelessattack 随后 采用 多种 反 分析 技术 antianalysis 在 撰写 本文 时 尽管 有 一些 因素 让我们 认为 其 是 越南 apt 组织 但 目前 仍然 不能 明确指出 这次 攻击 的 幕后 发动 者 werfaultexe 是 一个 windows 系统 自带 的 程序 用于 错误报告 显示 在 应用程序 崩溃 时 它 仍然会 执行 未处理 的 异常 处理 程序 但是 该 处理 程序 会 向 wer 服务 发送 消息 并且 服务 会 启动 wer 错误报告 进程 以 显示 错误报告 对话框 恶意 诱饵 您 的 赔偿 月 日 我们 发现了 一种 新型 攻击 该 攻击 从一 个 包含 恶意 文档 的 zip 文件 开始 该 文档 很 可能是 通过 鱼叉 式 网络 钓鱼 攻击 传播 的 文档 名叫 薪酬 手册 伪装成 包含 有关 工人 补偿 权利 的 信息 恶意 文档 如 下图 所示 该 文件 包含 一个 图像 标签 incldepicture 该 图像 标签 连 接到 如下 网址 然后 下载 一张 图片 作为 文档 模板 下 图为 嵌入 在 文档 中 的 图片 标签 imagetag 及 对应 的 您 的 补偿 网站 该 域名 于 年月日 注册 而 文档 创建 时间 为 年月日 这 很可能 表明 它们 属于 同一 攻击 在其 内部 我们 看到 一个 恶意 宏 该 宏 使用 cactustorchvba 模块 的 修改版 来 执行 其 正在 利用 dotnettojscript 技术 将 net 编译 的 二进制 文件 加 载到 内存 中 并从 vbscript 中 执行 下图 显示 了 该 威胁 攻击者 所 使用 的 宏 内容 它 具有 自动 打开 和 自动 关闭 功能 autoopen 只是 显示 一条 错误 消息 而 autoclose 是 执行 函数 的 主体 如上图 所示 已经 定义 了 一个 十六进制 格式 的 序列化 对象 它 包含 一个 正在 加 载到 内存 中 的 net 有效 负载 payload 然后 宏 使用 krakenkraken 作为 值 定义 了 一个 入口 类 这个 值 有 两个 部 分用 一个 点 分隔 net 加载 器 的 名称 和它 目标 类 的 名称 在下 一步 中 它将 创建 一个 序列化 的 binaryformatter 对象 并 使用 binaryformatter 的 deseralize 函数 反 序列化 该 对象 最后 通过 调用 dynamicinvoke 函数 从 内存 中 加载 并 执行 net 有效 负载 payload 与 cactustorchvba 不同 它 指定 了 目标 进程 在 宏 中 注入 payload 该 元素 更 改了 宏 并在 net 有效 负载 中 指定 目标 进程 krakenloader 加载 的 payload 是 一个 名叫 krakendll 的 netdll 该 文件 编译 于 年月日 这个 dll 是 一个 加载 器 它将 嵌入 的 shellcode 注入 到 werfaultexe 中 需要 说明 的 是 这 并不是 此类 技术 的 第一个 例子 以前 在 使用 netwirerat 和 cerber 勒索 软件 时 就 观察 到了 这种 情况 下图 展示 了 krakendll 加载 器 包括 两个 主要 的 类 krakenloader kraken 类 kraken 类 包 含了 shellcode 这些 代码 将被 注入 到 这个 类 中 定义 为 werfaultexe 的 目标 进程 中 它 只有 一个 函数 调用 loader 类 的 load 函数 其 shellcode 和 目标 进程 作为 参数 loaderload loader 类 loader 类 负责 通过 调用 windowsapi 将 shell 代码 注入 到 目标 进程 中 下图 展示 了 load 函数 下面 是 它 执行 注入 过程 的 步骤 startprocess 函数 调用 使用 c 作为 调用 来 定位 目标 进程 的 基址 createsection 调用 来 在 目标 进程 中 创建 一个 节 section 调用 将该 节 绑定 到 目标 进程 以便 通过 调用 copyshellcode 来 复制 通过 调用 和 resumethread 完成 过程 注入 shellcode 分析 使用 hollowhunter 我们 将 注入 的 shellcode 转 储 到 werfaultexe 中 以便 进行 进一步 分析 这个 dll 在 多个 线程 中 执行 其 恶意 活动 使其 分析 更加 困难 这个 dll 通过 调用 main 函 数来 执行 dllentrypoint 主 函数 调用 dllmain 来 创建 一个 线程 在 同一 进程 上下 文中 的 新 线程 中 执行 它 的 函数 dllmain 函数 如上图 所示 创建 的 线程 首先 执行 一些 反 分析 检查 以 确保 它 不在 分析 沙箱 环境 或 调试器 中 运行 它 通过 以下 操作 来 实现 的 通过 调用 gettickcount 来 检查 调试器 的 存在 gettickcount 是 一种 计时 函数 用于 度量 执行 某些 指令集 所 需要 的 时间 在此 线程 中 它在 睡眠 sleep 指令 之前 和 之后 被 调用 两次 然后 计算 差值 如果 不等于 则 程序 退出 因为 标识 着 它 正 在被 调试 创建 线程 代码 如 下图 所示 vm 检测 在此 函数 中 它将 通过 提取 显示 驱动程序 注册 表项 的 提供 程序 名称 来 检查 其 是否 在 vmware 或 virtualbox 中 运行 然后 检查 它 是否 包含 字符串 vmware 或 oracle 此 api 调用 用于 确定 是否 支持 指定 的 处理器 特性 从 下图 可以 看出 x 已 作为 参数 传 递给 此 api 这 意味着 它在 立即 终止 之前 检查 剩余 的 fastfail 支持 代码 检查 peb 结构 中 的 ntglobalflag 来 确定 它 是否 正 在被 调试 为了 识别 调试器 它将 ntglobalflag 值 与 x 进行 比较 通过 调用 来 检查 调试器 是否 存在 下图 展示 了 ntglobalflag 和 检 查在 执行 所有这些 反 分析 检查 之后 它 进入 一个 函数 在 一个 新 线程 中 创建 最终 的 shellcode 通过 调用 resolveimports 函数 可以 动态 混淆 并 解析 在此 部分 中 使用 的 导入 调用 此 函数 使用 loadlibraryex 获取 kerneldll 的 地址 然后 在 循 环中 检索 个 导入 使用 libpeconv 库 我们 能够 获得 已 解析 的 api 调用 表 下面 是 导入 表 我们 可以 预期 它将 执行 一些 进程 注入 在 解析 了 所需 的 api 调用 之后 它 使用 virtualalloc 创建 一个 内存 区域 然后 调用 下面 的 函 数来 解密 最终 shellcode 的 内容 并将 它们 写入 创建 的 内存 中 在下 一个 步骤 中将 调用 virtualprotect 来 更 改对 已 分配 内存 的 保护 以 使其 可执行 最后 createthread 被 调 用来 在 一个 新 线程 中 执行 最后 的 shellcode 最终 的 shellcode 最终 的 shellcode 是 一组 指令 这些 指令 向 硬 编码 域 发出 http 请求 以 下载 恶意 有效 负载 并 将其 注入 到 进程 中 第一步 它 通过 调用 loadlibrarya 加载 wininetapi 第二步 构建 函数 调用 列表 所需 的 http 请求 包括 和 其中 如 下图 所示 第三步 在 准备好 构建 http 请求 的 需求 之后 它将 创建 一个 http 请求 并 通过 调用 发送 该 请求 请求 的 网址 是 在下 一步 中 它将 检查 http 请求 是否 成功 如果 http 请求 不成功 它将 调用 exitprocess 停止 其 进程 如果 的 返回值 为 true 则 表示 请求 成功 并且 代码 继续 执行 下一步 在此 步骤 中 它 调用 virtualallocexa 分配 内存 区域 然后 调用 读取 数据 并 将其 写入 分配 的 内存 调用 如 下图 所示 最后 它 跳 转到 已 分配 内存 的 开头 以 执行 它 这 很有 可能是 另一个 受 感染 的 asiakotobanet 网站 上 托管 的 shellcode 并在 其中 植 入了 伪造 的 图标 由于 在 报告 时 目标 url 已 关闭 因此 我们 无法 检索 此 shellcode 进行 进一步 分析 究竟是 哪个 apt 组织 的 攻击 呢 我们 没有 足够 的 证据 来 确定 这次 攻击 的 原因 但是 我们 发现 其 与 apt 的 松散 联系 并且 仍在 调查 中 apt 是 已知 使用 cactustorchhta 来 删除 denisrat 变 中 的 攻击 组织 之一 然而 由于 我们 无法 获得 最终 的 有效 负载 payload 因此 我们 不能 肯定地 将 这种 攻击 归因于 apt 用于 托管 恶意 档案 和 文档 的 域 在 越南 胡志明市 注册 apt 使 用了 战略性 网络 妥协 方案 来 锁定 受害者 感觉 像是 越南 的 malwarebytes 阻止 访问 托管 有效 负载 的 受 感染 站点 最后 给出 iocs 诱饵 文件 包含 诱饵 文件 的 文档 文档 模板 图片 存档 文件 下载 下载 url 的 最终 最后 希望 这篇 文章 对 您 有所 帮助 感觉 反 分析 和 沙箱 逃逸 部分 知识 挺有 意思 的 后续 不忙 可以 尝试 复现 相关 的 功能 中秋节 和 国庆节 结束 虽然 一直在 忙 大家 接着 加油 某人 照 顾好 自己 喔 前文 分享 译 apt 分析 报告 linux 系统 下 针对性 的 apt 攻击 概述 译 apt 分析 报告 钓鱼 邮件 网址 混淆 url 逃避 检测 译 apt 分析 报告 opblueraven 揭露 apt 组织 fincarbanak 上 tirion 恶意 软件 译 apt 分析 报告 kraken 新型 无 文件 apt 攻击 利用 windows 错误报告 服务 逃避 检测 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 逆向 分析 apt 分析 报告 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 星期 四晚 上点 写 于 武汉 