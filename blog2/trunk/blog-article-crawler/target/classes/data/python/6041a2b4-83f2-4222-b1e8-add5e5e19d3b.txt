系统安全 二十八 wannacry 勒索 病毒 分析 4 全网 最 详细 的 蠕虫 传播 机制 解读 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 前文 分享 了 wannacry 勒索 病毒 逆向 分析 主要 通过 ida 和 od 逆向 分析 蠕虫 传播 部分 这篇 文章 将 继续 详细 讲解 wannacry 蠕虫 的 传播 机制 带领 大家 详细 阅读 源代码 分享 wannacry 勒索 病毒 是 如何 传播 感染 的 作者 分析 该 病毒 一个月 一方面 觉得 自己 技术 菜 另一方面 深知 系统安全 需要 坚持 继续 加油 希望 文章 对 您 有所 帮助 ps 如果 想 面试 病毒 分析 工程师 或 逆向 分析 工程师 wannacry 的 传播 机理 是 常 考 的 一个 知识点 也 希望能 帮助 到 那 部分 同学 而且 其 强大 的 功能 作者 尽最大努力 去 叙述 只 希望能 帮助 更多 该 领域 的 读者 也 希望 github 关注点 赞 一波 感恩 同行 不负 遇见 作者 作为 网络安全 的 小白 分享 一些 自学 基础教程 给 大家 主 要是 关于 安全 工具 和 实践 操作 的 在线 笔记 希望 您们 喜欢 同时 更 希望 您能 与我 一起 操 作和 进步 后续 将 深入 学习 网络安全 和 系统安全 知识 并 分享 相关 实验 总之 希望 该 系列 文章 对 博 友 有所 帮助 写 文 不易 大神 们 不 喜 勿 喷 谢谢 如果 文章 对 您有 帮助 将是 我 创作 的 最大 动 力点 赞 评论 私聊 均可 一起 加油 喔 文章 目录 一 wannacry 背景 二 wannacry 传播 机制 源码 详解 wannacry 蠕虫 传播 流程 程序 入口 start 域名 开关 winmain 参数 判断 sub 蠕虫 安装 流程 subf 蠕虫 服务 传播 流程 sub 蠕虫 初始化 操作 subb 局域网 传播 sub 公网 传播 sub 漏洞 检测 及 创建 通信 连接 sub 发送 smb 数据包 suba 获取 提取 分析 之 安装 后门 shellcode 分析 之 apc 注入 dll 导出 及 分析 释放 资源 taskscheexe 勒索 行为 三 总结 作者 的 github 资源 逆向 分析 网络安全 从 年月 开始 我 来 到了 一个 陌生 的 专业 网络空间 安全 初 入 安全 领域 是 非常 痛苦 和 难受 的 要 学 的 东西 太多 涉及面 太 广 但 好在 自己 通过 分享 篇 网络安全 自学 系列 文章 艰难 前行 着 感恩 这一 年 相识 相知 相 趣 的 安全 大佬 和 朋友们 如果 写得 不好 或 不足之处 还请 大家 海涵 接下来 我 将 开启 新 的 安全 系列 叫 系统安全 也是 免费 的 篇文章 作者 将 更加 深入 的 去 研究 恶意 样本 分析 逆向 分析 内网 渗透 网络 攻防 实战 等 也 将 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 加油 推荐 前文 网络安全 自学 篇 系列 篇 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 系统安全 八 windows 漏洞 利 用之 cve 复现 及 蓝屏 攻击 系统安全 九 windows 漏洞 利 用之 ms 远程 代码 执行 漏洞 复现 及 深度 提 权 系统安全 十 windows 漏洞 利 用之 smbv 服务 远程 代码 执行 漏洞 cve 复现 系统安全 十一 那些 年 的 熊猫 烧香 及 pe 病毒 行为 机理 分析 系统安全 十二 熊猫 烧香 病毒 ida 和 od 逆向 分析 上 病毒 初始化 系统安全 十三 熊猫 烧香 病毒 ida 和 od 逆向 分析 中 病毒 释放 机理 系统安全 十四 熊猫 烧香 病毒 ida 和 od 逆向 分析 病毒 释放 过程 下 系统安全 十五 chrome 浏览器 保留 密码 功能 渗透 解析 蓝屏 漏洞 及 某 音乐 软件 漏洞 复现 系统安全 十六 pe 文件 逆向 基础知识 pe 解析 pe 编辑 工具 和 pe 修改 系统安全 十七 windowspe 病毒 概念 分类 及 感染 方式 详解 系统安全 十八 病毒 攻防 机理 及 winrar 恶意 劫持 漏洞 脚本 病毒 自启动 定时 关机 蓝屏 攻击 系统安全 十九 宏病毒 之 入门 基础 防御 措施 自发 邮件 及 apt 宏 样本 分析 系统安全 二十 pe 数字签名 之 上 什么 是 数字签名 及 signtool 签名 工具 详解 系统安全 二十一 pe 数字签名 之 中 工具 用法 系统安全 二十二 pe 数字签名 之 下 微软 证书 漏洞 cve 复现 及 windows 验证 机制 分析 系统安全 二十三 逆向 分析 之 ollydbg 动态 调试 复习 及 traceme 案例 分析 系统安全 二十四 逆向 分析 之 ollydbg 调试 int 断点 反 调试 硬件 断点 与 内存 断点 系统安全 二十五 wannacry 勒索 病毒 分析 python 复现 永恒 之 蓝 漏洞 实现 勒索 加密 系统安全 二十六 wannacry 勒索 病毒 分析 ms 漏洞 利用 及 病毒 解析 系统安全 二十七 wannacry 勒索 病毒 分析 蠕虫 传播 机制 解析 及 ida 和 od 逆向 系统安全 二十八 wannacry 勒索 病毒 分析 全网 最 详细 的 蠕虫 传播 机制 解读 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 该 样本 不会 分享 给 大家 分析 工具 会 分享 参考文献 见 后 一 wannacry 背景 年月日 wannacry 蠕虫 通过 永恒 之 蓝 ms 漏洞 在 全球 范围 大 爆发 感染 大量 的 计算机 wannacry 勒索 病毒 全球 大 爆发 至少 个 国家 万名 用户 中招 造成 损失 达 亿 美元 已 影响 金融 能源 医疗 教育 等 众多 行业 造成 严重 的 危害 wannacry 是 一种 蠕虫 式 勒索 病毒软件 由 不法分子 利用 nsa 泄露 方程式 工具包 的 危险 漏洞 eternalblue 永恒 之 蓝 进行 传播 该 蠕虫 感染 计算机 后会 向 计算机中 植入 敲诈者 病毒 导致 电脑 大量 文件 被 加密 wannacry 利用 windows 系统 的 smb 漏洞 获取 系统 的 最高 权限 该 工具 通过 恶意代码 扫描 开放 端口 的 windows 系统 被 扫 描到 的 windows 系统 只要 开机 上线 不需要 用户 进行 任何 操作 即可 通过 smb 漏洞 上传 wannacry 勒索 病毒 等 恶意程序 wannacry 利用 永恒 之 蓝 漏洞 进行 网络 端口扫描 攻击 目标 机器 被 成功 攻陷 后会 从 攻击机 下载 wannacry 蠕虫 进行 感染 并 作为 攻击机 再次 扫描 互联网 和 局域网 的 其他 机器 行 成 蠕虫 感染 大范围 超 快速 扩散 木马 母体 为 mssecsvcexe 运行 后会 扫描 随机 ip 的 互联网 机器 尝试 感染 也 会 扫描 局域网 相同 网段 的 机器 进行 感染 传播 此外 会 释放 敲诈者 程序 taskscheexe 对 磁盘 文件 进行 加密 勒索 木马 加密 使用 aes 加密 文件 并 使用 非对称 加密算法 rsa 加密 随机 密钥 每个 文件 使用 一个 随机 密钥 理论上 不可 攻破 同时 显示 勒索 界面 其 核心 流程 如 下图 所示 wannacry 勒索 病毒 主要 行为 是 传播 和 勒索 传播 利用 基于 端口 的 smb 漏洞 ms 永恒 之 蓝 进行 传播 勒索 释放 文件 包括 加密器 解密器 说明 文件 语言 文件 等 加密 文件 设置 桌面背景 窗体 信息 及 付款 账号 等 二 wannacry 传播 机制 源码 详解 wannacry 蠕虫 主要 分为 两个 部分 蠕虫 部分 用于 病毒 传播 并 释放出 勒索 程序 勒索 部分 用于 加密 用户 文件 索要 赎金 大家 可能 看到 的 很多 样本 都是 没有 传播 部分 代码 或 域名 开关 的 接下来 是 作者 一点点 的 摸索 希望 对 您 有所 帮助 也 欢迎批评 和 指正 wannacry 蠕虫 传播 流程 wannacry 运行 的 整体 流程 推荐 安 天 公司 的 框架 图 如 下图 所示 主程序 文件 利用 漏洞 传播 蠕虫 运行 wannacry 勒索 程序 wannacry 勒索 程序 释放 taskscheexe 对 磁盘 文件 进行 加密 勒索 显示 勒索 信息 运行 tor 客户端 其中 图中 上半部 分为 wannacry 蠕虫 的 传播 部分 该 蠕虫 通过 网络 进行 传播 有 自我 复制 和 传播 迅速 等 特点 传播 步骤 如下 连接 远程 域名 开关 判断 参数 个数 选择 蠕虫 安装 流程 或 服务 传播 流程 lt 时 进入 安装 流程 点击 直接 运行 创建 服务 服务 名称 mssecsvc 参数 为 msecurity 释放 并 启动 taskscheexe 程 序时 进入 服务 传播 流程 服务 函数 中 执行 传播 感染 功能 打开 mssecsvc 服务 并 设置 其 状态 蠕虫 初始化 操作 后会 进行 局域网 和 公网 传播 建立 局域网 或 公网 ip 表 创建 ip 线程 尝试 连接 端口 测试 是否 存在 smb 漏洞 如果 存在 漏洞 则 建立 通信 连接 并 发送 payload x 或 x 进行 攻击 执行 shellcode 并 使用 apc 注入 将 生成 的 dll 注入 到 进程 lsassexedll 调用 导出 函数 playgame 释放 资源 文件 并 保存为 mssecsvcexe 执行 作者 的 分析 工具 主 要是 idapro 静态 分析 和 ollydbg 动态 调试 大家 分析 恶意 样本 一 定在 虚拟机 中 并 做好 相关 安全 保护 如 断 网 物理 隔离 共享 协议 端口 关闭 等 程序 入口 start 通过 od 打开 样本 wcryexe 发现 程序 入口 地址 为 xa 对应 start 函数 通过 一些 初始化 设置 紧接着 会 调用 winmain 函数 进入 主程序 主程序 调用 关系 如 下图 所示 调用 地址 为 xb 域名 开关 winmain 主程序 运行 后会 先 连接 域名 如果 该 域名 连接 成功 则 直接 退出 且不 触发 任何 恶意 行为 如果 该 域名 无法访问 则 触发 传播 勒索 行为 执行 sub 函数 该 代码 会 调用 internetopenurl 打开 对应 的 网址 并 根据 其 访问 情况 执行 不同 的 操作 如果 网址 无法访问 会 调用 sub 函数 创建 蠕虫 服务 这也 意味着 如果 蠕虫 作者 注册 并 访 问了 该 urlwannacry 蠕虫 也就 停止 了 传播 目前 该 域名 已被 英国 的 安全 公司 接管 网上 怀疑 该 操作 能 有效 防止 在线 沙箱 检测 参数 判断 sub 接着 进入 sub 函数 通过 判断 参数 个 数来 执行 相应 的 流程 subf 函数 当 参 参数 lt 进入 蠕虫 安装 流程 sub 函数 当 参数 进入 蠕虫 服务 传播 流程 并 创建 mssecsvc 服务 该 函数 调 用了 相关 的 api 函数 比如 创建 服务 openscmanagera 打开 服务 openservicea 等 当 我们 直接 运行 wcryexe 时 传递 的 参数 是 程序 本身 则 进入 蠕虫 安装 程序 当 我们 传递 参数 程序 本身 二进制 程序 服务 参数 时 则 进入 蠕虫 服务 传播 流程 推荐 绿 盟 api 词典 恶意 样本 分析 手册 api 函数 篇 李 东 宏 mssecsvc 服务 对应 的 数据 部分 如 下图 所示 该 服务 会 伪装成 微软 安全 中心 的 服务 服务 的 二进制 文件 路径 为 当前 进程 文件 路径 参数 为 msecurityod 动态 调试 如 下图 所示 包括 调用 call 访问 函数 将 服务 push 入 栈 等 蠕虫 安装 流程 subf 蠕虫 安装 流程 主要 调用 subf 函数 包括 subc 和 subce subc 创建 mssecsvc 服务 并 启动 该 服务 参数 为 msecurity 蠕虫 伪 装为 微软 安全 中心 subce 读取 并 释放 资源 taskscheexe 至 cwindows 路径 创建 线程 运行 主要 调用 的 函数 包括 等 动态 调用 过程 如 下图 所示 释放 的 效果 如 下图 所示 蠕虫 服务 传播 流程 sub 当 参数 时 蠕虫 执行 服务 传播 流程 调用 sub 实现 其 代码 如下 sub 会 打开 mssecsvc 服务 并 设置 其 状态 服务 设置 函数 包括 动态 分析 过程 如 下图 所示 核心 函数 是 subbd 它 的 功能 包括 初始化 操作 局域网 传播 公网 传播 蠕虫 初始化 操作 subb 蠕虫 初始化 操作 主要 调用 subb 函数 实现 具体 功能 包括 wsastartup 初始化 网络 sub 初始化 密码 suba 获取 payload 函数 wsastartup 主 要是 进行 相应 的 socket 库 绑定 函数 原型 如下 intwsastartup 使用 socket 程序 之前 必须 调用 wsastartup 函数 以后 应用程序 就可以 调用 所 请求 的 socket 库 中 的 其它 socket 函数 intwsacleanup void 应用程序 在 完 成对 请求 的 socket 库 的 使 用后 要 调用 wsacleanup 函 数来 解除 与 socket 库 的 绑定 并且 释放 socket 库 所 占用 的 系统资源 接口 的 检索 有关 域名 通信 服务 和 协议 等 internet 信息 的 数据 库函数 继续 调用 suba 函数 从 内存 中 读取 ms 漏洞 利用 代码 payload 分为 x 和 x 两个 版 本位 大小 为 x 位 大小 为 xca 局域网 传播 sub 蠕虫 初始化 操作 后会 生成 两个 线程 分别 进行 局域网 和 公网 传播 resultsubbv void beginthreadex sub v void beginthreadex subv 局域网 传播 蠕虫 根据 用户 内网 ip 生成 覆盖 整个 局域网 网段 表 然后 循环 尝试 攻击 这里 存在 一个 疑问 你 怎么能 确定 v 是 局域网 传播 而 v 是 外网 传播 呢 在 函数 sub 中会 继续 调用 线程 执行 subb 函数 同时 函数 如果 同时 调用 个 以上 ip 地址 会 执行 sleep 暂停 毫秒 秒 毫秒 核心 函数 subb 函数 sub 会 调用 函数 sub 接着 调用 getadaptersinfo 获取 网卡 配置 和 ip 地址 详细信息 最终 进行 局域网 ip 地址 拼接 和 传播 而 外网 传播 的 ip 地址 是 通过 四个 随机数 产生 的 通过 这些 差异 就能 判断 是 局域网 传播 还是 外网 传播 函数 subb 会 连接 端口 如果 端口 连接 成功 接着 发起 漏洞 攻击 如果 连接 超过 分钟 则 终止 该 线程 接下来 调用 sub 函数 发起 漏洞 攻击 核心 函数 sub 公网 传播 sub 公网 传播 公网 ip 地址 通过 个 随机数 拼接 而成 然后 循环 尝试 攻击 sub 函数 会 生成 四个 随机数 然后 调用 adddd 进行 ip 拼接 表示 成 ddddxff 表示 对应 最大 地址 v 余数 不等于 内网 接着 调用 sub 函数 进行 外网 传播 inaddrtinetaddr constcharcp 作用 将 一个 点 分 十进制 的 ip 转换成 一个 长 整数型 数 参数 字符串 一个 点 分 十进制 的 ip 地址 返回值 如果 正确 执 行将 返回 一个 无 符号 长 整数型 数 如果 传入 的 字符串 不是 一个 合法 的 ip 地址 将 返回 structinaddrin 作用 将 一个 十进制 网络 字 节序 转 换为 点 分 十进制 ip 格式 的 字符串 参数 一个 网络 上 的 ip 地址 返回值 如果 正确 返回 一个 字符 指针 指向 一块 存储 着 点 分 格式 ip 地址 的 静态 缓冲区 如果 错误 返回 null 在 sub 函数 中 继续 调用 线程 执行 sub 函数 该 函数 为 漏洞 利用 核心 函数 漏洞 检测 及 创建 通信 连接 subip 地址 拼 接好 后会 创建 漏洞 利用 线程 调用 sub 函数 第一步 检测 目标 是否 可以 安装 双星 脉冲 doublepulsar 端口 如果 需要 后续 可以 分享 一篇 永恒 之 蓝 和 双星 脉冲 相关 知识 第二步 利用 ms 漏洞 尝试 建立 通信 连接 并 发送 漏洞 利用 程序 数据包 通过 connet 建立 socket 通信 连接 再 调用 send 和 recv 进行 数据包 握手 确认 最后 会 调用 核心 函数 subf 发送 smb 数据包 suba 建立 通信 连接 connectsendrecv 发送 利用 eternalblue 的 蠕虫 smb 数据包 具体 流程 包括 还需 进一步 分析 建立 连接 ip 地址 端口 先 发送 一个 smb 请求 接受 正常 回复 后 往 smb 做 缓冲区 溢出 先往 smbv 的 缓冲区 发 数据 然后 是 往 smbv 发 大量 数据 最后 往 smbv 发 数据 smbv 连接 关闭 后 smbv 附近 会 产生 空洞 形成 永恒 之 蓝 攻击 后门 最 后用 双星 脉 冲来 将 dll 注入 有 后门 主机 并 运行 获取 样本 在 利用 漏洞 ms 获取 目标 主机 权限 后 并不会 直接 发送 蠕虫 自身 到 目标 而是 发送 一段 经过 简单 异 或 加密 后 的 payload 到 目标 机器 中 执 行在 suba 函数 中 v 是 系统 标记 当 v 等于 时 表示 位 操作系统 当 v 等于 时 表示 位 操作系统 核心 函数 subf 发送 payloadpayload 由 shellcode 和 包含 样本 自身 的 dll 组成 payload 分为 位 与 位 函数 subf 如 下图 所示 位 shellcode 起始 地址 xe 位 shellcode 起始 地址 xfadll 同样 分为 位 与 位 版本 根据 目标 主机 系统 的 不同 读取 不同 版本 的 dll 位 dll 起始 地址 xb 大小 为 x 字节 位 dll 起始 地址 xf 大小 为 xca 字节 shellcode 相关 信息 位 shellcode 起始 地址 xe 大小 为 x 字节 位 shellcode 起始 地址 xfa 大小 为 x 字节 提取 shellcode 对应 的 反汇编 代码 如下 包括 位 shellcode 获取 xexfad 位 shellcode 提取 xfaxfshellcode 分析 之 安装 后门 shellcode 反汇编 及 功能分析 如下 第一 部分 安装 后门 第二 部分 利用 安装 的 后门 apc 向 应用程序 注入 dll 查找 基 地址 获取 hash 计算方法 根据 基 地址 函数 hash 字符 查找 导出 函数 地址 查找 需要 用到 导出 函数 地址 并 保存 导出 函数 hash 对照表 查找 目标 进程 通过 hash 编码 bfeh 进程 名 查找 lsassexe 使用 查到 导出 函数 的 地址 并 进行 apc 注入 最后 将 shellcode 自身 以及 其所 分配 的 内存 清 shellcode 部分 作者 还需要 进一步 研究 加油 安装 后门 主要 执行 sub 函数 在 远程 电脑 上 安装 双星 脉冲 doublepulsar 后门 shellcode 分析 之 apc 注入 参考 两篇 文章 原创 wannacry 勒索 软件 中 永恒 之 蓝 漏洞 利用 分析 展 博 原创 通过 wannacry 分析 内核 shellcode 注入 dll 技术 第二 部分 是 利用 安装 的 后门 apc 向 应用程序 注入 dll 查找 ntoskrnlexe 基 地址 首先 找到 gs 处 的 kidtentry 指针 在 kidtentry 的 偏移 得到 中断 处理 的 函数 指针 这个 地址 在 ntoskrnlexe 中 我们 就 找 到了 ntoskrnlexe 的 地址 空间 然 后去 地址 空间 的 页 头 地址 对比 pe 头 mz 找到 则 函数 返回 获取 hash 计算方法 需要 使用 的 函数 并没有 硬 编码 写到 程序 里 而是 硬 编码 了 这些 函数 的 hash 值 所以 我们 需要 首先 知道 函数 编码 和 hash 值得 对应 关系 hash 计算方法 如下 用 c 代码 注释 了 一下 根据 ntoskrnlexe 基 地址 函数 hash 字符 查找 导出 函数 地址 findfunc 函数 如下 有 了 ntoskrnlexe 所有 导出 函数 hash 对照表 整个 程序 流程 就 明朗 了 查找 需要 用到 ntoskrnlexe 导出 函数 地址 并 保存 备用 查找 目标 进程 通过 hash 编码 bfeh 进程 名 查找 lsassexe 查找 目标 进程 通过 hash 编码 bfeh 进程 名 查找 直接 没找到 lsassexe 查找 方法 是 使用 pid 暴力 查找 具体 通过 pid 调用 得到 peprocess 结构 指针 再 通过 peprocess 调用 得到 进程 名 使用 查到 导出 函数 的 地址 并 进行 apc 注入 apc 注入 使用 查到 导出 函数 的 地址 注释 见 截图 第六个 参数 包 含了 第三层 shellcode 和 dll 代码 可 自行 dump 出 研究 第七个 参数 指 定为 usermode 最后 将 shellcode 自身 以及 其所 分配 的 内存 清 内核 部分 的 注入 代码 主要 流程 就 分析 完了 到 用户 层 的 shellcode 自己 实现 的 一个 peloader 而 没有 使用 loadlibary 这样 使得 注入 更加 隐蔽 查询 pebldrdata 的 也 查不到 被 注 入了 dlldll 导出 及 分析 shellcode 使用 apc 注入 将 生成 的 dll 注入 到 系统 进程 lsassexe 导出 的 dll 文件 如 下图 所示 火绒 剑 检测 结果 如下 通过 apc 注入 将 生成 的 dll 注入 到 系统 进程 lsassexe 接着 释放 资源 mssecsvcexe 最后 释放 勒索 程序 taskscheexe 释放 资源 taskscheexedll 具有 一个 导出 函数 playgame 它 会将 母体 程序 释 放到 被 攻击 的 计算机 保存为 并 执行 下面 是 作者 分析 导出 的 dll 静态 代码 主 函数 包括 两个 核心 函数 sub 和 subfsub 释放 资源 subf 运 运行 文件 最后 释放 资源 taskscheexe 勒索 加密 程序 到 cwindows 目 录下 并 将其 启动 被 攻击 的 计算机 包含 蠕虫 的 完整 功能 除了 会被 勒索 还会 继续 使用 ms 漏洞 进行 传播 这种 传播 呈几何 级 向外 扩张 也是 该 蠕虫 短时 间内 大规模 爆发 的 主要原因 勒索 行为 勒索 行为 之前 的 文章 已经 进行了 还原 运行 病毒 程序 后 的 界面 如 下图 所示 已经 成功 被 勒索 再次 强调 所有 代码 必 须在 虚拟机 中 执行 并且 关闭 文件 共享 样本 的 解压密码 是 wncryol 通过 资源 工具 也 可以 查 看到 解压 后 的 文件 结构 如下 msg 文件 夹下 就是 所有 的 语言包 其他 文件 内容 如下 下一 篇文章 会 详细 介绍 勒索 原理 bwnry 中招 敲诈者 后 桌面壁纸 cwnry 配置文件 包含 洋葱 域名 比特 币 地址 tor 下载 地址 等 fwnry 可免 支付 解密 的 文件 列表 rwnry 提示 文件 包含 中招 提示 信息 swnryzip 文件 包含 tor 客户端 twnry 测试 文件 uwnry 解密 程序 三 总结 写到 这里 这篇 文章 就 介绍 完毕 主要 讲 解了 wannacry 蠕虫 的 传播 机制 也是 作者 一个月 的 研究成果 感觉 是 全网 wannacry 蠕虫 传播 部分 最 详细 的 一篇 文章 了 最后 感觉 自己 真的 好菜 但也 需要 加油 希望 您 喜欢 这篇 文章 wannacry 蠕虫 传播 流程 程序 入口 start 域名 开关 winmain 参数 判断 sub 蠕虫 安装 流程 subf 蠕虫 服务 传播 流程 sub 蠕虫 初始化 操作 subb 局域网 传播 sub 公网 传播 sub 漏洞 检测 及 创建 通信 连接 sub 发送 smb 数据包 suba 获取 提取 分析 之 安装 后门 shellcode 分析 之 apc 注入 dll 导出 及 分析 释放 资源 taskscheexe 勒索 行为 作者 分享 github 资料 这篇 文章 中 如果 存在 一些 不足 还请 海涵 作者 作为 网络安全 初学者 的 慢慢 成长 路 吧 希望 未来 能 更 透彻 撰写 相关 文章 同时 非常感谢 参考文献 中 的 安全 大佬 们 的 文章 分享 感谢 师傅 师兄 师弟 师姐 师妹 们 的 教导 深知 自己 很菜 得 努力 前行 欢迎 大家 讨论 是否 觉得 这 系列 文章 帮助 到 您 任何 建议 都可以 评论 告知 读者 共勉 byeastmount 深夜 点 写 于 参考文献 为了 更好 帮助 读者 作者 将 参考文献 提前 下面 给 出下 各大 安全 厂商 及 安全 大佬 对 wannacry 蠕虫 分析 的 文章 强烈推荐 大家 阅读 作者 也 吸 取了 它们 的 精华 在此 感谢 安全 厂商 样本 分析 安 天 针对 勒索 蠕虫 魔窟 wannacry 的 深度 分析 报告 分享 勒索 病毒 wannacry 深度 技术 分析 详解 传播 感染 和 危害 细节 火绒 安全 wannacry 勒索 病毒 详细 解读 腾讯 电脑 管家 漏洞 分析 核心 安全 针对 wannaren 勒索 软件 的 梳理 与 分析 安 天 权威 报告 wanacryptr 勒索 蠕虫 完全 分析 报告 追 日 wannacry 勒索 病毒 分析 报告 瑞星 安全 大佬 样本 分析 对 wannacry 的 深度 分析 鬼 手 勒索 部分 详解 原创 wannacry 勒索 软件 中 永恒 之 蓝 漏洞 利用 分析 展 博 原创 通过 wannacry 分析 内核 shellcode 注入 dll 技术 dragonwang 病毒 分析 wannacry 病毒 分析 永恒 之 蓝 小 彩虹 wannacry 勒索 病毒 逆向 和 内网 传播 数据 分析 seczz 首发 wannacry 勒索 软件 母体 主程序 逆向 分析 含 临时 解决方案 自动化 工具 expsky 原创 wannacry 深度 详细分析 报告 很细 很深 