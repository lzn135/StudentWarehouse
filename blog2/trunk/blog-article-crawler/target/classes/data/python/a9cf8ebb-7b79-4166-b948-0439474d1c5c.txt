python 自动化 运 维 实战 使用 python 管理 网络设备 现在 我们 已经 知道 如 何在 不同 的 操作系统 中 使用 和 安装 python 以及 如何 使用 eveng 搭建 网络 拓 扑在 本章 中 我们 将 学习 如何 使用 目前 常用 的 网络 自动化 库 自动 完成 各种 网络 任务 python 可以 在 不同 的 网络 层 上 与 网络设备 进行 交互 首先 python 可以 通过 套接 字 编程 和 socket 模块 操纵 底层 网络 从 而为 python 所在 的 操作系统 和 网络设备 之间 搭建 一个 低层次 的 网络 接口 此外 python 模块 还 可以 通过 telnetssh 和 api 与 网络设备 进行 更高 级别 的 交互 本章 将 深入探讨 如 何在 python 中 使用 telnet 与 ssh 模块 在 远程 设备 上 建立 连接 和 执行命令 本章 主要 介绍 以下内容 使用 python 通过 telnet 连接 设备 python 和 ssh 使用 netaddr 处理 ip 地址 和 网络 网络 自动化 实战 示例 技术 要求 应 检查 是否 正确 安 装了 下列 工具 并 保证 它们 能够 正常 使用 pythonxpycharm 社区 版 或 专业版 eveng 网络 仿真器 的 安装 和 配置 请参阅 第 章 本章 中 出现 的 所有 脚本 请 参见 github 网站 python 和 sshssh 和 telnet 的 不同之处 在于 客户端 与 服务器 之间 交换 数据 的 通道 不一样 ssh 使用 的 是 安全 链 路 在 客户端 和 设备 之间 创 建了 一个 使用 不同 的 安全 机制 进行 加密 的 隧道 通信 内容 很 难被 解密 因此在 需要 保证 网络安全 的 时候 网络 工程师 会 首先 选择 使用 ssh 协议 paramiko 库 遵循 ssh 协议 支持 身份验证 密钥 处理 dsarsaecdsa 和 ed 以及 其他 ssh 功能 如 proxy 命令 和 sftp 在 python 中 当 需要 使用 ssh 连 接到 网络设备 时 通常 使用 这个 库 paramiko 模块 paramiko 是 python 中 应用 最广 的 ssh 模块 模块 本身 使用 python 语言 编写 和 开发 只有 像 crypto 这样 的 核心 函数 才会 用到 c 语言 从 其 github 官方 链 接上 能够 看到 代码 的 贡献者 和 模块 历史 等 诸多 信息 安装 模块 打开 windowscmd 或 linuxshell 运行 下面 的 命令 从 pypi 下载 最新 的 paramiko 模块 如 下图 所示 同时 该 命令 会 自动 下载 其他 依赖 包 如 和 six 并将 它们 安 装到 计算 机上 在 命令行 中 输入 python 然后 导入 paramiko 模块 验证 是否 安装 成功 如 下图 所示 正确 安装 之后 能够 成功 导入 模块 也就是说 命令行 上 不会 出现 任何 错误 提示 用 ssh 连接 网络设备 如前所述 要 使用 paramiko 模块 首先 需 要在 python 脚本 中 导入 它 然后 通过 继承 sshclient 来 创建 ssh 客户端 然后 设置 paramiko 的 参数 使其 能够 自动 添加 任意 未知 的 主机 密钥 并 信任 与 服务器 之间 的 连接 接下来 将 远程 主机 的 信息 ip 地址 用户名 和 密码 等 传 递给 connect 函数 channelconnect autoaddpolicy 是 一种 策略 可以 作为 函数 的 输入 参数 在 虚拟 实验室 环境 中 推荐 使用 这种 策略 但在 生产 环境 中 应当 使用 更加 严格 的 策略 如 warningpolicy 或 rejectpolicy 最后 invokeshell 将 启动 一个 连 接到 ssh 服务器 的 交互式 shell 会话 在 调用 该 函数 时 可以 传入 一些 其他 参数 如 终端 类型 宽度 高度 等 paramiko 的 连接 参数 如下 lookforkeys 默 认为 true 强制 paramiko 使用 密钥 进行 身份验证 也就是说 用户 需要 使用 私钥 和 公 钥 对 网络设备 进行 身份验证 在这里 使用 密码 验证 因此 将该 参数设置 为 falseallowagent 表示 是否 允许 连 接到 ssh 代理 默 认为 true 在用 密钥 验证 时 可能 需要 使用 这个 选项 由于 这里 使用 的 是 用户名 密码 因此 禁用 它 最后 一步 把 各种 命令 如 showipintb 和 showarp 发送到 设备 终端 并将 返回 结果 输 出到 python 窗 口中 shellsend enablen shellsend accessn shellsend terminallengthn shellsend showipintbn shellsend showarpn timesleep printshellrecv channelclose 脚本 运行 结果 如 下图 所示 如果 需 要在 远程 设备 上 执行 耗时 很长 的 命令 就要 强制 python 等待 一段时间 直到 设备 生成 输出 并将 结果 返回 给 python 因此 最好 使用 timesleep 否则 python 可能 得不到 正确 的 输出 结果 netmiko 模块 netmiko 是 paramiko 的 增强 版本 专门 面向 网络设备 虽然 paramiko 能够 处理 与 设备 的 ssh 连接 并 判断 设备 类型 是 服务器 打印机 还是 网络设备 但 netmiko 在 设计 时 针对 网络设备 做了 优化 能够 更 有效地 处理 ssh 连接 netmiko 还 支持 各种 不同 的 设备 厂商 和 平台 netmiko 也是 对 paramiko 的 封装 它 使用 许多 其他 增强 功能 扩展 了 paramiko 比如 使用 启用 的 密码 直接 访问 所 支持 的 设备 从 文件 读取 配置 并将 推 送到 设备 在 登录 期间 禁用 分页 显示 以及 默认 在 每条 命令 后面 加上 回车符 n 支持 的 设备 商 netmiko 支持 许多 供应商 的 设备 并 定期 在 支持 列表 中 添加 新 的 供应商 netmiko 支持 的 供应商 列表 分为 定期 测试 类 有限 测试 类 和 实验 类 在 该 模块 的 github 页 面上 可以 找到 这个 列表 定期 测试 类 中 支持 的 供应商 如 下图 所示 有限 测试 类 中 支持 的 供应商 如 下图 所示 实验 类 中 支持 的 供应商 如 下图 所示 安装 和 验证 安装 netmiko 非常 简单 打开 windows 命令行 窗口 或 linuxshell 执行 下面 的 命令 就可以 从 pypi 获取 最新 版本 的 netmiko 包 见 下图 然后 在 pythonshell 中 导入 netmiko 验证 模块 是否 正确地 安 装到 中 使用 netmiko 建立 ssh 连接 现在 该 开始使用 netmiko 了 让我们 来 看看 它 强大 的 ssh 功能 首先 连 接到 网络设备 并在 上面 执行命令 默认 情况下 netmiko 在 建立 会话 session 的 过程中 会在 后台 处理 许多 操作 如 添加 未知 的 ssh 密钥 主机 设置 终端 类型 宽度 和 高度 在 需要 的 时候 还 可以 进入 特权 enable 模式 然后 通过 运行 供应商 提供 的 命令 来 禁用 分页 首 先以 字典 格式 定义 设备 并 提供 下列 个 必需 的 关键 信息 r 第一个 参数 是 devicetype 为了 执行 正确 的 命令 需要 使用 这个 参 数来 定义 平台 供应商 然后 需要 ssh 的 ip 地址 如果 已经 使用 dns 解析 了 ip 地址 该 参数 可能是 主机名 否则 该 参数 是 ip 地址 接下来 提供 以及 以 secret 参数 传递 的 特权 模式 的 密码 注意 可以 使用 getpass 模块 隐藏 密码 并且 只 在 脚本 执行 期间 提示 它们 虽然 变量 中 的 密钥 序列 不重要 但是 为了 使 netmiko 能够 正确 解析 字典 并 开始 和 设备 建立 连接 密钥 的 名称 应该 和 之前 示例 中 提供 的 密钥 完全 一样 接下来 从 netmiko 模块 导入 connecthandler 函数 并 提供 定义 的 字典 来 开始 建立 连接 因为 所有 的 设备 是 通过 特权 模式 的 密码 配置 的 所以 需 要为 创建 的 连接 提供 enable 以 在 特权 模式 下 访问 使用 sendcommand 在 路由器 终 端上 执行命令 sendcommand 将会 执行命令 并 通过 变量 的 值 显示 设备 的 输出 r showipintb printoutput 脚本 输出 结果 如下 注意 这里 看到 的 输出 结果 去 掉了 命令行 中 的 命令 回 显 和 设备 提示符 默认 情况下 netmiko 会 替换 设备 的 返回 结果 使 输出 更加 整洁 替换 过程 通过 正则表达式 完成 这部 分会 在下 一章 中 介绍 如果 不想 使用 这种 方式 而是 希望 看到 命令提示符 并在 返回 结果 的 后面 执行命令 可以 在 sendcommand 函数 中 加上 以下 参数 和 告诉 netmiko 保留 而 不是 替换 命令行 回 显 和 提示符 默认 情况下 它为 true 可以 根据需要 进行 设置 使用 netmiko 配置 设备 netmiko 可以 通过 ssh 配置 远程 设备 通过 config 方法 进入 设备 的 配置 模式 然后 按照 list 格式 中 的 信息 配置 列表 配置 设备 配置 列表 可以 直接 写在 python 脚本 中 也 可以 从 文件 中 读取 然 后用 readlines 方法 转 换为 列表 swip sw coreswconfig 上面 的 脚 本以 另外 一种 形式 连 接到 sw 并 进入 特权 模式 但这次 使用 的 是 另一个 netmiko 方法 sendconfigset 该 方法 需要 使用 列表 形式 的 配置文件 同时 进入 设备 的 配置 模式 并 根据 列表 对 设备 进行 配置 这里 测 试了 一个 简单 的 配置 即 修改 gig 和 gig 并将 这两个 端口 配成 trunk 模式 在 设备 上 执行 showrun 命令 时 如果 命令 执行 成功 会 出现 类似 下面 的 输出 netmiko 中 的 异常 处理 在 设计 python 脚本 时 我们 可能会 假设 设备 已 启动 并 运行 并且 用户 已 提供 了 正确 的 登录 信息 但 实际情况 并非 总是 如此 有时 python 和 远程 设备 之间 的 网络连接 可能 存在 问题 或者 用户 输 入了 错误 的 登录 信息 如果 发生 这种 情况 python 通常会 抛出 异常 并 退出 但 这种 解决方案 显然 不够 完美 netmiko 中 的 异常 处理 模块 提供 的 一些 异常 处理 类 可以 处理 上面 所说 的 那些情况 第一个 类 能够 捕获 远程 设备 中 的 身份验证 错误 第二个 类 能够 捕获 netmiko 和 设备 之间 的 超 时或 任何 连接 问题 下面 的 例子 中 使用 tryexcept 子句 包 含了 connecthandler 方法 用来 捕获 超时 和 身份验证 异常 deviceip device showipintb deviceip deviceip 设备 自动 发现 netmiko 提供 了 一种 可以 猜测 设备 类型 和 发现 设备 的 机制 通过 组合 使用 snmp 发现 oids 和在 远程 控制 台上 执行 多个 show 命令 这两种 方式 根据 输出 字符串 检测 路由器 的 操作系统 和 类型 然后 netmiko 将 相应 的 驱动程序 加 载到 connecthandler 类 中 device print devicetype print device 在上 面的 脚本 中 应 注意 以下几点 首先 设备 字典 中 的 devicetype 等于 autodetect 也 就是 告诉 netmiko 在 检 测到 设备 类型 之前 不要 加载 驱动程序 然后 使用 netmiko 的 sshdetect 类 发现 设备 它 使用 ssh 连 接到 设备 并 执行 一些 命令 以 找出 操作系统 的 类型 结果 以 字典 形式 返回 接着 使用 autodetect 函数 将 匹配 度 最高 的 结果 赋 给 devicetype 变量 接下来 输出 查看 字典 内 的 全部 返回 结果 最后 可以 更新 设备 字典 并为 其 分配 新 的 devicetype 在 python 中 使用 telnet 协议 telnet 是 tcpip 协议 栈 中 最早 可用 的 协议 之一 主要 用来 在 服务器 和 客户端 之间 建立 连接 交换 数据 服务器端 监听 tcp 端口 等待 客户端 的 连接 请求 在下 面的 例子 中 我们 将 创建 一个 python 脚本 作为 telnet 客户端 拓扑 中 的 其他 路由器 和 交换机 则 作为 telnet 服务器 python 原生 的 telnetlib 库 已经 支持 telnet 所以 不需要 另外 安装 客户端 对象 可以 通过 telnetlib 模块 中 的 telnet 类 实例 化 创建 通过 这个 对象 我们 能够 使用 telnetlib 中 的 两个 重要 函数 readuntil 用于 读取 输出 结果 和 write 用于 向 远程 设备 写入 内容 这两个 函数 用来 和 telnet 连接 交互 从 telnet 连接 读取 或 向 telnet 连接 写入 数据 还有 一点 非常 关键 使用 readuntil 读取 telnet 连接 的 内容 之后 缓冲区 会被 清空 无法 再次 读取 因此 如果 在后面 的 处理 中 还会 用到 之前 读取 的 重要 数据 需 要在 脚 本里 将其 另存为 变量 telnet 数 据以 明文 形式 发送 因此 通过 中间人 攻击 可以 捕获 并 查 看到 telnet 数据 如 用户 信息 和 密码 即便如此 一些 服务 提供商 和 企业 仍然在 使 用它 只是 他们 会 集成 vpn 和 radiustacacs 协议 以 提供 轻量级 和 安全 的 访问 方式 让我们 一步步 分析 这个 脚本 在 python 脚本 中 导入 telnetlib 模块 在 变量 中 定义 用户名 和 密码 代码 如下 定义 一个 变量 用来 和 远程 主机 建立 连接 注意 只需要 提供 远程 主机 的 ip 地址 不 用在 连接 建立 过程中 提供 用户名 或 密码 host 通过 读取 telnet 连接 返回 的 输出 并 搜索 username 关键字 来 提供 telnet 连接 的 用户名 然后 写入 管理员 用户名 如果 需要用 同样 的 方法 输入 telnet 密码 cnxreaduntil username cnxwrite usernamen cnxreaduntil password cnxwrite passwordn cnxreaduntil gt cnxwrite enn cnxreaduntil password cnxwrite enablepasswordn telnet 连接 建好 之后 在 脚本 中 加上 控制台 提示符 非常重要 否则 连接 将 陷入 死循环 接着 python 脚本 就会 超时 并 出现 错误 向 telnet 连接 写入 命令 并 开始 读取 返回 内容 直到 出现 路由器 提示符 为止 通过 以下 命令 可以 得到 路由器 的 接口 配置 cnxreaduntil cnxwrite showipintbn printoutput 完整 的 脚本 如下 所示 脚本 运行 结果 如下 所示 注 意在 输出 中 包 含了 执行 的 命令 showipintb 并且在 stdout 中 输出 和 返 回了 路由器 提示符 r 可以 使用 内置 的 字符串 函数 如 replace 从 输出 中 清除 它们 showipintb replace r 你 可能 已经 注意到 脚本 中使 用了 密码 并将 密码 以 明文 形式 写下来 这样 做 显然是 不安全 的 同时 在 python 脚本 中 使用 硬 编码 也 不是 好习惯 在下 一节 中 我们 将 学习 如何 隐藏 密码 并 设计 一种 机制 从 而在 脚本 运行时 要求 用户 输入 密码 此外 如果 要 执行 那些 输出 结果 可能 跨越 多个 页面 的 命令 如 则需 要在 连 接到 设备 之后 和 发送 命令 之 前先 通过 发送 termindllength 来 禁用 分页 使用 telnetlib 推送 配置 在上 一节 中 我们 通过 执行 showipintbrief 简单 介绍 了 telnetlib 的 操作过程 现在 我们 要用 telnetlib 将 vlan 配置 推 送到 实验室 网络 拓扑 中 的 台 交换机 使用 python 的 range 函数 创建 一个 vlan 列表 遍历 列表 将 vlanid 推 送到 当前 交换机 注意 我们 将 交换机 的 ip 地址 放 到了 另一个 列表 中 使用 外部 for 循环 来 遍历 这个 列表 同时 使用 内置 模块 getpass 隐藏 控制 台中 的 密码 在 脚本 运行时 提示 用户 输入 密码 hostswipstrip username connectionwrite usernamen password connectionwrite passwordn gt connectionwrite enablen password connectionwrite enablepasswordn connectionwrite configterminaln vlanid connectionwrite vlanstr vlanid n timesleep connectionwrite exitn connectionclose 最 外层 的 for 循环 用来 遍历 设备 列表 然后 在 每次 循环 每个 设备 中 生成 范围 为 的 vlanid 并将 它们 推 送到 当前 设备 脚本 运行 结果 如下 当然 也 可以 通过 交换机 控制台 检查 运行 结果 仅 显示 部分 结果 使用 netaddr 处理 ip 地址 和 网络 管理 和 操作 ip 地址 是 网络 工程师 最 重要 的 任务 之一 python 开发人员 提供 了 一个 令人惊叹 的 库 netaddr 它 可以 识别 ip 地址 并 对 其 进行 处理 假设 你 开 发了 一个 应用程序 其中 需要 获取 的 网络地址 和 广播 地址 通过 模块 内 的 内置 方法 network 和 broadcast 可以 轻松 地 获 取到 相应 的 地址 支持 很多 功 能在 第 层 的 地址 中 netaddr 支持 下列 功能 识别 ipv 和 ipv 地址 子网掩码 和 前缀 对 ip 网络 进行 迭代 切片 排序 汇 总和 分类 处理 各种 格式 cidr 任意 子网 长度 nmap 对 ip 地址 和 子网 进行 集合 操作 联合 交叉 等 解析 各种 不同 的 格式 和 符号 查找 ianaip 块 信息 生成 dns 反向 查找 结果 检索 超 网 和 生成 子网 在 第 层 的 地址 中 netaddr 支持 下列 功能 展示 和 操作 mac 地址 与 eui 标识符 查找 ieee 组织 信息 ouiiab 生成 链 路 本地 的 ipv 地址 安装 netaddr 使用 pip 安装 netaddr 模块 命令 如下 安装 完成 之后 打开 pycharm 或 python 控制台 并 导入 模块 验证 模块 是否 安装 成功 如果 没有 出现 错误信息 说明 模块 安装 成功 使用 netaddr 的 方法 netaddr 模块 提供 了 两种 重要 的 方法来 定义 ip 地址 并 对 其 进行 处理 第一 种方法 是 ipaddress 它 用来 定义 具有 默认 子网掩码 的 单个 有 类 ip 地址 第二 种方法 是 ipnetwork 它 使用 cidr 定义 无 类 ip 地址 两种 方法 都将 ip 地址 作为 字符串 来 处理 根据 字符串 返回 ip 地址 或 ip 网络 对象 返回 的 对象 还 可以 继续 执行 许多 方法 比如 判断 ip 地址 是 单播 地址 多 播 地址 环 回 地址 私有 地址 还是 公有 地址 以及 地址 有效 还是 无效 地址 这些 操作 的 结果是 true 或 false 在 python 的 if 条件 中 可以 直接 使用 这些 方法 另外 该 模块 支持 使用 和 等 比较 运算符 比较 两个 ip 地址 从而 生成 子网 它还 可以 检索 一个 给定 ip 地址 或者 子网 术语 的 超 网 列表 最终 netaddr 模块 可以 生成 有效 主机 的 一个 完整 列表 不包括 网络 ip 地址 和 网络 广播 地址 ipaddr ipaddr returnnjoin ipattributes ipnet ipnet netnetwork netnetmask netbroadcast ipversionisstr netversion netinfo netipv netsize tstr ip returnnjoin netattributes ipaddrrawinput ipaddr ipnetrawinput ipnet 在上 面的 脚本 中 首先 使用 rawinput 函数 请求 用户 输入 ip 地址 和 ip 网络 然后 将 输入 的 值 作为 参数 传 递给 两个 用户 方法 checkipaddress 和 并 调用 它们 第一个 函数 checkipaddress 会 检查 输入 的 ip 地址 同时 尝试 生成 有关 ip 地址 属性 的 报告 例如 ip 地址 是 单播 多 播 私有 还是 环 回 地址 并将 输出 返回 给 用户 第二个 函数 用来 完成 和 网络 相关 的 操作 即 生成 网络 id 掩码 广播 版本 网络 上 的 已知 信息 ipv 地址 的 显示 方式 最后 生成 该 子 网内 的 所有 ip 地址 注意 netinfo 只能 对 公共 ip 地址 生成 可用 信息 对 私有 ip 地址 不起作用 同样在 使用 之前 需要 先从 netaddr 模块 导入 ipnetwork 和 ipaddress 脚本 运行 结果 如下 所示 简单 的 用 例 随着 网络 变得 越来越大 其中 包含 更多 来自 各种 不同 供应商 的 设备 这就 需要 创建 模块化 的 python 脚本 来 自动 执行 各种 任务 接下来 的 几节 将 分析 个 用 例 这些 用 例 可以 从 网络 中 收集 不同 信息 缩短 解决问题 所需 的 时间 或者 至 少将 网络 配置 恢复 到 其 上次 已知 的 良好 状态 使用 自动化 工作 流来 处理 网络故障 修复 网络 环境 网络 工程师 能够 更 关心 工作 完成 情况 提高 业务水平 备份 设备 配置 备份 设备 配置 对于 任何 一名 网络 工程师 来说 都是 最 重要 的 任务 之一 在 这个 用 例 中 我们 将 使用 netmiko 库 设计 一个 示例 python 脚 本该 脚本 用来 备份 设备 配置 它 适用于 不同 的 供应商 和 平台 为 方便 日后 访问 或 引用 我们 将 根据 设备 ip 地址 格式化 输出 文件名 例如 sw 备份 操作 的 输出 文件 保 存在 devcfg 中 创建 python 脚本 从 定义 交换机 开始 我们 希望 将其 配置 备份 为 文本文件 设备 文件 用 逗号 分隔 访问 设备 的 用户名 密码 等 详细信息 这样 就可以 在 python 脚本 中 使用 split 函 数来 获取 这些 数据 方 便在 connecthandler 函数 中 使用 这些 数据 此外 还 可以 从 microsoftexcel 工作 表 或 任何 数据库 中 轻松 导出 该 文件 以及 把 该 文件 导入 其中 文件 结构 如下 创建 python 脚本 使用 withopen 子句 在 脚本 中 导入 该 文件 在 导入 的 文件 对象 上 使用 readlines 方法 将 文件 中 的 每 一行 组成 列表 然 后用 for 循环 逐行 遍历 文件 用 split 函数 获取 每 一行 中用 逗号 隔开 的 设备 信息 并将 它们 赋予 相应 的 变量 n ipaddrlinesplit vendorlinesplit ifvendorlower 由于 我们 的 目标 是 创建 模块化 的 支持 多种 设备 供应商 的 脚本 因此在 if 子 句中 需要 检查 设备 供应商 并为 该 设备 分配 正确 的 devicetype 和 backupcommand 接下来 建立 与 设备 的 ssh 连接 使用 netmiko 模块 中 的 send dcommand 方法 执行 备份 命令 printstr datetimenow ipaddr backupcommand printstr datetimenow ipaddr fopen devipaddrcfgw fwrite runningconfig fclose print 在 最后 的 几行 中 以 写入 方式 打开 一个 文件 文件 不存在 时 将 自动 创建 文件名 中 包 含了 前面 从 设备 文件 中 读取 的 ipaddr 变量 脚本 运行 结果 如下 需要 注意 的 是 备份 的 配置文件 存储 在 项目 的 主目录 中 文件名称 包含 每个 设备 的 ip 地址 见 下图 使用 linux 服务器 上 的 cron 任务 或 windows 服务器 上 的 计划任务 可让 服务器 在 指定 时间 运行 上面 的 python 脚本 例如 每天 凌晨 运行 一次 将 配置 信息 存储 在 latest 目录 中 以 方便 运 维 团队 使用 创建 访问 终端 在 python 或 其他 编程 活动 中 你 就是 自己 的 设备 供应商 为了 满足 自己 的 需求 你 可以 创建 任何 喜欢 的 代码 组合 和 程序 在 第二个 例子 中 我们 创建 自己 的 终端 terminal 通过 telnetlib 访问 路由器 只需 要在 终端 写 几个 单词 就会 在 网络设备 中 执行 很多 命令 并 返回 输出 结果 输出 结果 将会 显示 在 标准 输出 或 保 存在 文件 中 host username connectionwrite adminn password connectionwrite accessn gt connectionwrite enn password connectionwrite accessn connectionwrite terminallengthn cmdn 首先 建立 到 路由器 的 telnet 连接 并 输入 相应 的 用户 信息 一 直到 打开 特权 enable 模式 然后 创建 一个 始终 为 true 的 无限 while 循环 使用 内置 的 rawinput 函数 捕捉 用户 输入 的 命令 脚本 捕 获到 用户 输入 之后 在 网络设备 上 执行 这些 命令 如果 用户 输入 关键字 health 或 discover 终端 将 自动 执行 一系列 命令 以 反映 期望 的 操作 这些 关键字 在 排除 网络故障 时 非常 有用 可以 根据 常用 的 操作 自由 扩展 它们 想象 一 下在 需要 解决 两个 路由器 之间 的 开放式 最短 路径 优先 邻居 问题 时 只要 打开 自己 的 python 终端 脚本 这个 脚本 中 已经 写 好了 几个 排除故障 常用 的 命令 并将 这些 命令 打包 到 诸如 tshootospf 之类 的 if 条件 之后 一旦 脚本 看到 这个 关键字 它 就会 执行 这些 命令 输出 ospf 邻居 状态 mtu 的 接口 ospf 的 广播 网络 等 简化 定位 问题 的 过程 通过 在 提示符 中 输入 health 尝试 脚本 中 的 第一条 命令 脚本 输出 结果 如下 可以 看到 脚本 将 返回 在 设备 上 执行 多条 命令 后 的 结果 接着 试一下 第二个 命令 discover 脚本 输出 结果 如下 这次 脚本 返回 discover 命令 的 输出 在后 面的 章节 中 我们 将会 解析 返回 的 输出 结果 并从 中 提取 有用 的 信息 从 excel 工作 表 中 读取 数据网络 和 it 工程师 始终 使用 excel 工作 表 来 存储 基础设施 的 相关 信息 如 ip 地址 设备 供应商 和 登录 凭证 python 支持 从 excel 工作 表 中 读取 数据 并 对 其 进行 处理 以便 我们 在 脚本 中 使用 数据 在 这个 用 例 中 我们 将 使用 excelreadxlrd 模块 读取 ucdevicesxlsx 文件 该 文件 保存 了 基础设施 的 主机名 ip 地址 用户名 普通 密码 特权 模式 下 的 密码 和 供应商 名称 然后 将 读到 的 数据 用作 netmiko 模块 的 输入 excel 工作 表 中 的 内容 如 下图 所示 首 先用 pip 安装 xlrd 模块 因为 需要 用它 来 读取 microsoftexcel 工作 表 模块 能够 读取 excel 工作 表 并将 行 和 列 转 换为 矩阵 比如 row 代表 第一 行 第一 列 的 单元格 右边 紧接着 它 的 单元格 是 row 见 下图 以此类推 xlrd 在 读取 工作 表 时 每次 读取 一行 同时 特殊 计数器 nrows 行数 自动 加 同样 每次 读取 一列 ncols 列 数 自动 加 这样 我们 就 能够 通过 这两个 参数 知道 矩阵 的 大小 然后 在 xlrd 的 openworkbook 函数 中 输入 文件 路径 并用 sheetbyindex 或 sheetbyname 函数 访问 工作 表 在 本例 中 数据 存储 在 第一个 工作 表 index 中 工作 表 文件 存储 在 以 章 为名 的 文件 夹下 接着 遍历 工作 表 的 每 一行 或者 使用 row 函数 来访问 指定 行 返回 的 输出 结果是 一个 列表 使用 索引 可以 访问 列表 中 的 元素 python 脚本 如下 forindexinrange sheetnrows index index index index index index device deviceip device showipintb deviceip deviceip 其 他用 例 使用 netmiko 可以 实现 很多 网络 自动 化用 例 例 如在 升级 期间 从 远程 设备 上传下载 文件 利用 jinja 模板 加载 配置 访问 终端 服务器 访问 终端设备 等 要 了解 更 多用 例 请 参见 github 官 网 见 下图 小 结在 本章 中 我们 开始使用 python 进入 网络 自动化 世界 本章 讨论 了 python 中 的 一些 工具 通过 telnet 和 ssh 建立 到 远程 节点 的 连接 并在 远程 设备 上 执行命令 此外 本章 还 讲述 了如 何在 netaddr 模块 的 帮助 下 处理 ip 地址 和 网络 子网 最后 通过 两个 实际 用 例 巩固 了 这些 知识 本文 摘自 python 自动化 运 维 实战 运 维 工程师 教程 书籍 自动化 运 维 实践 通过 python 模块 库 与 工具 自动 配置 和 管理 大量 服务器 的 讲解 提高 运 维 的 效率 python 自动化 运 维 实战 介绍 了 如何 通过 python 来 自动 完成 服务器 的 配置 与 管理 自动 完成 系统 的 管理 任务 如 用户 管理 数据库 管理 和 进程 管理 以及 完成 这些 工作 所需 的 模块 库 和 工具 此外 本书 还 讲述 了 如何 使用 python 脚本 自动 执行 测试 如何 通过 python 在 云 基础设施 和 虚拟 机上 自动 执行任务 如何 使用 基于 python 的 安全 工具 自动 完成 与 安全 相关 的 任务 本书 适合 运 维 人员 和 开发人员 阅读 也 可 作为 相关 专业人士 的 参考书 