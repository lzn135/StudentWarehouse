cryptopals 解密 之旅 3-2 x 前言 本 系列 文章 将 带来 cryptocals 这套 密码学 挑战 的 writeup 不同于 通过 上课 或者 看书 的 方式 学习 密码学 这些 题目 来自于 现 在生活中 一些 软件 系统 和 密码 构造 中 的 缺陷 本 系列 每一个 题 的 wp 基 本是 采用 如下 结构 题目 解释 相关 知识点 讲解 代码 实现 及 解释 运行 测试 代码 均 采用 python 实现 代码 实现 部分 是 参考 国外 大佬 ricpacca 的 结合 自己 的 理解 及 成文 需要 进行 部分 修改 第三套 一 共有 八关 上篇 文章 我们 解决 了 前 四 关 接下来 我们 来 解答 后 四 关 x 第 题 题目 要求 我们 实现 mt 它是 mersennetwister 的 一种 变体 可以 产生 位 整数 序列 梅 森 旋转 算法 mersennetwister 是 一个 伪 随机数 发生 算法 由 松 本真 和 西村 拓 士 在年 开发 基于 有限 二进制 字段 上 的 矩阵 线性 递归 f 可以 快速 产生 高质量 的 伪 随机数 修正 了 古典 随机数 发生 算法 的 很多 缺陷 mersennetwister 这个 名字 来自 周期 长度 取自 梅 森 素数 的 这样 一个 事实 这个 算法 通常 使用 两个 相近 的 变体 不同之处 在于 使 用了 不同 的 梅 森 素数 一个 更新 的 和 更 常用 的 是 mt 位 字长 还有 一个 变种 是 位 版 的 mt 对于 一个 k 位 的 长度 mersennetwister 会在 k 的 区间 之间 生成 离散 型 均匀分布 的 随机数 mt 的 优点 包括 周期 非常 长 达到 尽管如此 长 的 周期 并不 必然 意味着 高质量 的 伪 随机数 但 短 周期 比如 许多 旧版本 软件包 提供 的 确实 会 带来 许多问题 在 k 的 维度 之间 都可以 均等 分布 除了 在 统计学 意义上 的 不正确 的 随机数 生成器 以外 在所 有 伪 随机数 生成器 法 中 是 最快 的 就 算法 提出 时 而言 后面 几题 都是 与 随机数 相关 的 题目 所以 这里 关于 随机数 再 说明 一下 随机数 在 许多 领域 中都 有着 大量 应用 例如 密码学 游戏 数学 统计 随机数 主要 分 两类 分 别是 确定性 随机数 和 非 确定性 随机数 非 确定性 随机数 也 可 称为 真 随机数 主要 来源于 不可 预测 的 物理 或者 化学 熵 源 例如 电路 噪声 真 随机数 发生器 产生 的 随机数 质量 十分 高 是 最理想 的 随机数 来源 但是 由于 产生 的 速度 太慢 无法 满足 目前 的 信息 的 传输 速度 因此 目前 确定性 随机数 依然 被 广泛 使用 确定性 随机数 发生器 也 称 作伪 随机数 发生器 它 一般 是 一个 随机数 生成 算法 由于 算法 是 固定 的 因此 生成 的 随机数 存在 许多 诸如 可 预测 质量 不高 的 缺点 回到 题目 题目 提示 我们 可以 在 维基百科 上 找到 伪 代码 如 下图 所示 另外 题目 告诉 我们 使用 pythonrubyphp 等 语言 已经 内置 实现 了 mt 而 题目 要求 我们 手动 实 现在 实现 时会 用到 一些 数据 我们 先 给出 梅 森 旋转 算法 实际使用 的 是 旋转 的 广义 反馈 移位寄存器 它 主要 分 初始化 旋转 生成 随机数 以及 xorshift 后期 处理 三个 步骤 由于 mt 的 梅 森 算法 中 生成 的 随机数 为 位 因此 算法 需要 个位 长 的 状态 在 初始化 阶段 即 下图 的 init 工作 是 将 我们 获得 的 随机 种子 经 处理 填 充到 所有 的 个 状态 中 函数 将 输入 的 随机 种子 赋值 给 第 个 状态 剩余 的 个 状态 则用 前 一 状态值 的 一系列 操作 进行 赋值 更新 当 执行 完 这一 算法 后 全部 的 个 状态 已经 填充 完毕 之后 梅 森 算法 便 可以 不断地 生成 伪 随机数 接着是 旋转 生成 随机数 mt 标准 中 定义 a 的 值 为 xbdf 这 部分 是 进行 旋转 操作 每 生成 个 伪 随机数 后 将 执行 一次 上面 的 函数 重新 更新 个 状态 为 生成 下一 批 个 伪 随机数 做准备 之后 是 第三步 后期 处理 每个 状态 都 需要 经过 xorshift 操作 以后 才能 成为 最终 输出 的 伪 随机数 由于 其中 几乎 都是 移位 因此 对 cpu 来说 处理 起来 非常快 完整 的 代码 及 测试 如下 这样 我们 就 手动 实现 了 mt 这里 参考 了 中科院 信 工 所 发表 的 梅 森 旋转 算法 安全性 分析 及 改进 想进 一步 了解 的 同学 可以 看看 这篇 论文 x 第 题 要求 我们 实现 以下 操作 在到 之间 随机 等待 几秒钟 使用 当前 的 unix 时间 戳 作为 种子 再次 等待 随机 秒数 返回 种子 随机数 题目 要求 我们 能够 从 输出 中 破解 得到 种子 题目 还 提示 我们 可以 模拟 时间 从而 避免 真的 要 等待 一段 随机 的 时长 第一个 函数 要 实现 题目 要求 我们 做的 操作 我们 就是 要 逆向 破解 得到 这个 函数 返回 的 随机数 随机数 在 将该 值 作为 参数 传入 破解 种子 的 函数 这里 的 破解 其实 很简单 就是 不断地 测试 改变 可能 作为 种子 的 时间 戳 判断 其 生成 的 随机数 是否 等于 第一次 生成 的 随机数 如果是 则 说明 找 到了 正确 的 种子 返回 即可 完整 的 代码 及 测试 如下 第一 行 是 原 种子 第二 行 是 我们 暴力破解 得到 的 种子 在 实际 运行 时会 发现 过了 一会儿 才会 打 印出 第二 行 的 结果 这是 因为 程序 正在 跑 crackmtseedx 第 题 有 三个 关键 的 点 需要 把握住 要知道 mt 完整 的 内部 状态 由 个位 整数 组成 如果 可以 克隆 这些 整数 则 可以 预测 rng 之后 生成 的 数 内部 状态 中 的 每个 整数 都 按 顺序 直接 与 rng 的 输出 一一对应 内部 状态 中 的 每个 整数 与 输出 的 随机数 的 对应 关系 是 可逆 的 关系 换句话说 给定 了 rng 的 输出 我们 可以 逆向 得到 与 之 相关联 的 内部 状态 中 的 整数 综合 以上 三点 如果 我们 逆向 得 到了 组成 状态 的 个 整数 只 需将 这个 状态 复制到 自己 的 mtrng 中就 可以 得到 原 rng 的 一个 有效 的 克隆 可以 预测 之后 的 随机数 rng 的 输出 是 容易 拿到 的 关键是 怎么 得到 内部 状态 题目 提示 我们 生成 随机数 的 temper 函数 是 可逆 的 就是 我们 在前面 代码 中 写 的 extractnumber 函数 为了 与 题目 相统一 接下来 一律 称为 temper 我们 写 一个 untemper 函数 接收 mt 输出 并 将其 转 换回 mt 状态 数组 的 相应 元素 即 可要 逆向 temper 所做 的 事情 我们 需要 按照 相反 的 顺序 实现 temper 中 的 每个 操作 的 逆 操作 temper 中有 两种 操作 每种 操作 应 用了 两次 一个是 对 右移 值 rightshifted 的 xor 另 一个是 对 左移 leftshifted 值 的 xor 并与 一个 幻数 进行 与 运算 我们 只需要 逆着 实现 就可以 了 先写 两个 逆 操作 的 函数 然后 在 untemper 中 调用 即可 接下来 就是 克隆 一个 新 的 rng 新 的 rng 克隆 了 与 原 rng 相同 的 状态 然后 在 main 中分 别 使用 两个 rng 生成 随机数 便于 比较 完整 代码 及 测试 结果 如下 可以 看到 两个 rng 的 输出 是 相同 的 或者 换句话说 攻击者 通过 本题 介绍 的 攻击 方法 可以 克隆 得到 一个 新 的 rng 用于 预测 原 rng 生成 的 随机数 x 第 题 题目 要求 实现 使用 位 的 种子 传入 mtrng 生成 的 随机数 作为 密钥流 以 该 密钥流 对 明文 加密 明文 可以 任意 可以 加前缀 后缀 然后 暴力 测试 可能 的 密钥 位 的 种子 对 密 文 解密 题目 没有 指定 加解密 的 算法 为了 简单 起见 我们 指定 加密算法 为 将 rng 生成 的 密钥流 与 明文 异 或 这样 解密 和 加密 就是 同样 的 操 作了 暴力 测试 可能 的 密钥 的 函数 如 下在 main 中 构造 任意 明文 加密 得到 密 文 然后 调用 经过 暴力 测试 得到 密钥 最后 用 得到 的 密钥 对 密 文 进行 解密 三个 print 语句 分 别是 用于 打印 暴力 测试 得到 的 密钥 和 原 密钥 以及 使用 暴力破解 得到 的 密钥 解密 出 的 明文 完整 代码 及 测试 结果 如下 可以 看到 暴力破解 得到 的 密钥 和 原 密钥 是 相同 的 并且 密 文 也 被 成功 解密 了 