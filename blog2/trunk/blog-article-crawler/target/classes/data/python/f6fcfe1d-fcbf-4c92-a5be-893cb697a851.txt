系统安全 二十五 wannacry 勒索 病毒 分析 1 python 复现 永恒 之 蓝 漏洞 实现 勒索 加密 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 作者 前文 介绍 了 逆向 分析 之 ollydbg 动态 调试 工具 包括 int 断点 反 调试 硬件 断点 和 内存 断点 这篇 文章 将 分享 新知识 最近 wannaren 勒索 软件 爆发 下图 是 安 天 的 分析攻击 流程 其 名称 和 功 能与 wannacry 相似 所以 接下来 作者 将 连续 分享 wannacry 勒索 病毒 的 复现 及 分析 第一 篇文章 将 采用 github 资源 实现 永恒 之 蓝 漏洞 利用 及 windows 系统 文件 加密 注意 这篇 文章 介绍 的 wannacry 复现 过程 十分 繁琐 仅 推荐 大家 理解 一个 漏洞 利用 的 基本 过程 python 是 如何 构建 shellcode 代码 攻击 的 以及 双星 脉冲 漏洞 dll 文件 的 设置 与 后续 逆向 分析 均 有关 而 下一 篇文章 是 直接 使用 metasploit 中 的 ms 漏洞 实现 勒索 更 简洁 的 给出 永恒 之 蓝 漏洞 的 利用 过程 希望 这 系列 文章 对 您 有所 帮助 文章 目录 一 wannacry 背景 二 实验 环境 搭建 安装 win 系统 和 winserver 系统 windowsserver 系统 中 配置 python 环境 三 kali 生成 dll 攻击 文件 四 利用 永恒 之 蓝 漏洞 获取 shellwinserver 配置 永恒 之 蓝 kali 反弹 shell 实现 doublepulsar 注入 五 上传 勒索 病毒 并 实现 攻击 六 防御 措施 七 总结 作者 的 github 资源 逆向 分析 网络安全 从 年月 开始 我 来 到了 一个 陌生 的 专业 网络空间 安全 初 入 安全 领域 是 非常 痛苦 和 难受 的 要 学 的 东西 太多 涉及面 太 广 但 好在 自己 通过 分享 篇 网络安全 自学 系列 文章 艰难 前行 着 感恩 这一 年 相识 相知 相 趣 的 安全 大佬 和 朋友们 如果 写得 不好 或 不足之处 还请 大家 海涵 接下来 我 将 开启 新 的 安全 系列 叫 系统安全 也是 免费 的 篇文章 作者 将 更加 深入 的 去 研究 恶意 样本 分析 逆向 分析 内网 渗透 网络 攻防 实战 等 也 将 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 加油 推荐 前文 网络安全 自学 篇 系列 篇 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 系统安全 八 windows 漏洞 利 用之 cve 复现 及 蓝屏 攻击 系统安全 九 windows 漏洞 利 用之 ms 远程 代码 执行 漏洞 复现 及 深度 提 权 系统安全 十 windows 漏洞 利 用之 smbv 服务 远程 代码 执行 漏洞 cve 复现 系统安全 十一 那些 年 的 熊猫 烧香 及 pe 病毒 行为 机理 分析 系统安全 十二 熊猫 烧香 病毒 ida 和 od 逆向 分析 上 病毒 初始化 系统安全 十三 熊猫 烧香 病毒 ida 和 od 逆向 分析 中 病毒 释放 机理 系统安全 十四 熊猫 烧香 病毒 ida 和 od 逆向 分析 病毒 释放 过程 下 系统安全 十五 chrome 浏览器 保留 密码 功能 渗透 解析 蓝屏 漏洞 及 某 音乐 软件 漏洞 复现 系统安全 十六 pe 文件 逆向 基础知识 pe 解析 pe 编辑 工具 和 pe 修改 系统安全 十七 windowspe 病毒 概念 分类 及 感染 方式 详解 系统安全 十八 病毒 攻防 机理 及 winrar 恶意 劫持 漏洞 脚本 病毒 自启动 定时 关机 蓝屏 攻击 系统安全 十九 宏病毒 之 入门 基础 防御 措施 自发 邮件 及 apt 宏 样本 分析 系统安全 二十 pe 数字签名 之 上 什么 是 数字签名 及 signtool 签名 工具 详解 系统安全 二十一 pe 数字签名 之 中 工具 用法 系统安全 二十二 pe 数字签名 之 下 微软 证书 漏洞 cve 复现 及 windows 验证 机制 分析 系统安全 二十三 逆向 分析 之 ollydbg 动态 调试 复习 及 traceme 案例 分析 系统安全 二十四 逆向 分析 之 ollydbg 调试 int 断点 反 调试 硬件 断点 与 内存 断点 系统安全 二十五 wannacry 勒索 病毒 分析 python 复现 永恒 之 蓝 漏洞 实现 勒索 加密 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 该 样本 不会 分享 给 大家 分析 工具 会 分享 参考文献 见 后 一 wannacry 背景 年月日 wannacry 蠕虫 通过 永恒 之 蓝 ms 漏洞 在 全球 范围 大 爆发 感染 大量 的 计算机 wannacry 勒索 病毒 全球 大 爆发 至少 个 国家 万名 用户 中招 造成 损失 达 亿 美元 已 影响 金融 能源 医疗 教育 等 众多 行业 造成 严重 的 危害 wannacry 是 一种 蠕虫 式 勒索 病毒软件 由 不法分子 利用 nsa 泄露 方程式 工具包 的 危险 漏洞 eternalblue 永恒 之 蓝 进行 传播 该 蠕虫 感染 计算机 后会 向 计算机中 植入 敲诈者 病毒 导致 电脑 大量 文件 被 加密 wannacry 利用 windows 系统 的 smb 漏洞 获取 系统 的 最高 权限 该 工具 通过 恶意代码 扫描 开放 端口 的 windows 系统 被 扫 描到 的 windows 系统 只要 开机 上线 不需要 用户 进行 任何 操作 即可 通过 共享 漏洞 上传 wannacry 勒索 病毒 等 恶意程序 wannacry 利用 永恒 之 蓝 漏洞 进行 网络 端口扫描 攻击 目标 机器 被 成功 攻陷 后会 从 攻击机 下载 wannacry 木马 进行 感染 并 作为 攻击机 再次 扫描 互联网 和 局域网 的 其他 机器 行 成 蠕虫 感染 大范围 超 快速 扩散 木马 母体 为 mssecsvcexe 运行 后会 扫描 随机 ip 的 互联网 机器 尝试 感染 也 会 扫描 局域网 相同 网段 的 机器 进行 感染 传播 此外 会 释放 敲诈者 程序 taskscheexe 对 磁盘 文件 进行 加密 勒索 木马 加密 使用 aes 加密 文件 并 使用 非对称 加密算法 rsa 加密 随机 密钥 每个 文件 使用 一个 随机 密钥 理论上 不可 破解 同时 显示 勒索 界面 其 核心 流程 如 下图 所示 wannacry 勒索 病毒 主要 行为 是 传播 和 勒索 传播 利用 基于 端口 的 smb 漏洞 ms 永恒 之 蓝 进行 传播 勒索 释放 文件 包括 加密器 解密器 说明 文件 语言 文件 等 内存 加载 加密器 模块 加密 执行 类型 文件 全部 加密 后 启动 解密器 解密器 启动 后 设置 桌面背景 显示 勒索 信息 弹出 窗口 显示 付款 账号 和 勒索 信息 二 实验 环境 搭建 实验 环境 攻击机 kalilinuxip 攻击机 winserverip 受害 主机 win 位 ip 实验 工具 wcryexe 实验 步骤 配置 实验 环境 kali 检测 受害 主机 端口 smb 协议 是否 开启 运行 永恒 之 蓝 python 脚本 利用 dll 后门 文件 进行 doublepulsar 注入 metaploit 获取 受害 主机 的 shell 运行 wcryexe 母体 程序 实现 勒索 和 文件 加密 切记 切记 切记 实验 复现 过程中 必 须在 虚拟机 中 完成 运行 之前 关闭 虚拟机 win 文件 共享 真 机上 一旦 被 感染 你 就 真的 只能 想 哭了 wannacry 安装 win 系统 和 winserver 系统 创建 虚拟机 并 安装 windowsx 位 操作系统 安装 系统 如下 win 设置 开启 端口 同时 关闭 防火墙 注意 关闭 虚拟机 文件 共享 功能 安装 windowsserver 系统 其 ip 地址 为 保证 攻击机 攻击机 和 受害 机 相互 通讯 均在 同一个 局域网 中 攻击机 kalilinuxip 攻击机 winserverip 受害 主机 win 位 ipwindowsserver 系统 中 配置 python 环境 第一步 下载 实验 相关 工具 工具包 第二步 安装 python 配置 环境变量 第三步 傻瓜式 安装 pythonwinpy 第四步 安装 在 windows 文件夹 中新 建 文件夹 logs 和 listeningposts 用 记事本 打开 windows 文件夹 中 的 fuzzbunchxml 文件 并 修改 resourcesdir 和 loogdir 的 路径 修改 resourcesdir 和 loogdir 路径 为 和 logs 第五步 运行 永恒 之 蓝 工具 若 出现 以下 界面 则 工具 安装 成功 三 kali 生成 dll 攻击 文件 第一步 扫描 靶机 是否 开启 端口 nmapss 第二步 使用 msfvenom 工具 生成 后门 文件 指定 使用 模块 类型 lshot 指定 本地 iplport 指定 本地 端口 f 指定 文件 类型 第三步 上传 dll 文件 到 攻击机 windowsserver 中 这里 使用 wmvaretools 复制 或 xshell 软件 实现 四 利用 永恒 之 蓝 漏洞 获取 shellwinserver 配置 永恒 之 蓝 第一步 在 cmd 中 运行 永恒 之 蓝 设置 受害 主机 ip 攻击机 ip 是否 重定向 新建 项目名称 默认 目标 ip 地址 靶机 ip 默认 回弹 ip 地址 攻击机 ip 地址 是否 使用 重定向 新建 项目 createanewp project 新建 项目 命名 其他 选项 全部 默认 直接 enter 即可 第二步 加载 永恒 之 蓝 模块 获取 受害 主机 的 系统 权限 加载 永恒 之 蓝 useeternalblue 设置 受害 主机操作系统 windowsx 模式 mode 选择 fb 该 模式 下 进行 交互性 参数 输入 其他 大部 分为 确认 信息 参数 可 设置 为 默认 或 自行 修改 设置 攻击 参数 和 操作系统 等 信息 当 我们 看到 win 和 信息 表示 受害 机 的 权限 获取 成功 fbpy 源代码 为 ospathrealpath file ospathabspath file edflibdir fbdirpayloads fbdirexploits fbdirtouches fbdirimplants lpdirospathjoin fbdirtriggers fbdirspecials fbdirlogs fb gvarsglobals gvarsquit codeinteract defmain fb fbprintbanner retarget fb fb fbiopreinput none fbioprintmsg loadingplugins fbiopostinput addplugins addplugins addplugins addplugins addplugins addplugins addplugins addplugins fbprintbanner loadplugins fb main fb kali 反弹 shell 接着 设置 kali 系统 通过 metasploit 等待 返回 的 shell 具体步骤 如下 加载 msfconsole 使用 handle 操作 命令 为 设置 paylod 命令 为 设置 本地 ip 地址 命令 为 setlhost 设置 本地 端口 命令 为 setlport 开启 监听 run 实现 doublepulsar 注入 接下来 kali 处于 监听 状态 我们 在 windowsserver 中 进行 doublepulsar 注入 双倍 脉冲 具体 流程 如下 第一步 输入 usedoublepulsar 加载 双倍 脉冲 注入 第二步 设置 相关 参数 包括 选择 smb 协议 后门 利用 方法 为 rundll 选择 协议 smb 后门 方法 rundll 设置 dll 路径 为 cabcdll 默认 操作 输入 enter 键 注入 成功 后 显示 第三步 返回 kali 查看 meterpreter 此时 成功 获取 受害 机 shelldirgetuid 第四步 在 kali 中 查看 win 系统盘 目录 如 下图 所示 五 上传 勒索 病毒 并 实现 攻击 第一步 在 kali 中 上传 勒索 病毒 程序 wcryexe 至 受害 主机 上传 之后 如 下图 所示 注意 如果 程序 运行 时间长 可能 需要 重新 执行 相关 命令 我们 再 重新 回顾 下 这些 核心 命令 kaliwinserver 第二步 获取 受害 主机 shell 如果 出现 中文 乱码 输入 chcp 设置 编码 接着 我们 运行 win 上面 的 病毒 程序 运 行前 的 受害 主机 界面 如 下图 所示 运行 病毒 程序 后 的 界面 如 下图 所示 已经 成功 被 勒索 再次 强调 所有 代码 必 须在 虚拟机 中 执行 并且 关闭 文件 共享 加密 系统 中 的 文件 被 加密 的 文件 后缀名 统一 修 改为 wncrybwnry 中招 敲诈者 后 桌面壁纸 cwnry 配置文件 包含 洋葱 域名 比特 币 地址 tor 下载 地址 等 fwnry 可免 支付 解密 的 文件 列表 rwnry 提示 文件 包含 中招 提示 信息 swnryzip 文件 包含 tor 客户端 twnry 测试 文件 uwnry 解密 程序 六 防御 措施 勒索 软件 防御 常见 的 措施 如下 开启 系统 防火墙 关闭 等 端口 连接 开启 系统 自动更新 下载 并 更新 补丁 及时 修复 漏洞 安装 安全 软件 开启 主动 防御 进行 拦截 查杀 如 非 服务 需要 建议 把 高危 漏洞 的 端口 都 关闭 比如 等 由于 wannacry 勒索 病毒 主要 通过 端口 入侵 计算机 关闭 的 方法 如下 控制面板 gtwindows 防火墙 gt 高级 选项 gt 入 站 规则 新建 规则 gt 选择 端口 gt 指定 端口号 选择 阻止 连接 gt 配置文件 全选 gt 规则 名称 gt 成功 关闭 实验 在 虚拟机 中 进行 也 需要 关闭 共享 文件夹 功能 如 下图 所示 七 总结 写到 这里 这篇 wannacry 勒索 病毒 复现 和 分析 的 文章 就 介绍 结束 了 希望 对 您 有所 帮助 同时 您可 能感 觉 到了 调用 别人 的 python 资源 方法 比较 繁琐 我们 是否能 直接 调用 ms 再 上传 勒索 病毒 实现 攻击 呢 并且 作者 后续 会 深入 地 逆向 分析 该 勒索 病毒 的 原理 及 调用 关系 也 推荐 大家 阅读 参考文献 大佬 们 的 文章 继续 加油 这篇 文章 中 如果 存在 一些 不足 还请 海涵 作者 作为 网络安全 初学者 的 慢慢 成长 路 吧 希望 未来 能 更 透彻 撰写 相关 文章 同时 非常感谢 参考文献 中 的 安全 大佬 们 的 文章 分享 感谢 师傅 师兄 师弟 师姐 师妹 们 的 教导 深知 自己 很菜 得 努力 前行 欢迎 大家 讨论 是否 觉得 这 系列 文章 帮助 到 您 如果 存在 不足之处 还请 海涵 任何 建议 都可以 评论 告知 读者 共勉 逆向 分析 网络安全 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 晚 上点 夜 于 武汉 参考文献 勒索 病毒 wannacry 之 复现 过程 永恒 之 蓝 weixinwindows 再 曝 wannacry 级 漏洞 cve 专治 xpwinfb 客户 对 wannacry 的 深度 分析 鬼 手 安 天 针对 勒索 蠕虫 魔窟 wannacry 的 深度 分析 报告 wannacry 蠕虫 详细分析 freebuf 腾讯 病毒 分析 wannacry 病毒 分析 永恒 之 蓝 小 彩虹 威胁 预警 蠕虫 级 漏洞 bluekeep cve exp 被 公布 斗 象 智能 安全 平台 反病毒 病毒 分析 实战篇 远 控 病毒 分析 i 春秋 老师 等 病毒 样本 csdn 下载 针对 wannaren 勒索 软件 的 梳理 与 分析 安 天 