系统安全 二十一 pe 数字签名 之 中 signcode peview 010editor asn1view 工具 用法 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 作者 前文 介绍 了 什么 是 数字签名 并 采用 signtool 工具 对 exe 文件 进行 签名 后续 深入分析 数字签名 的 格式 及 pe 病毒 内容 这篇 文章 将 详细 解析 数字签名 采用 signtool 工具 对 exe 文件 进行 签名 接着 利用 等 工具 进行 数据 提取 和 分析 这是 全网 非 常新 的 一篇 文章 希望 对 您 有所 帮助 这些 基础 性知识 不仅 和 系统安全 相关 同样 与 我们 身边 常用 的 软件 文档 操作系统 紧密联系 希望 这些 知识 对 您 有所 帮助 更 希望 大家 提高 安全意识 安全 保障 任重道远 本文 参考 了 参考文献 中 的 文章 并 结合 自己 的 经验 和 实践 进行 撰写 也 推荐 大家 阅读 参考文献 文章 目录 一 pe 文件 数字签名 过程 基础 概念 数字签名 操作 二 pe 文件 签名 数据 提取 peview 查看 签名 信息 editor 提取 签名 数据 三 pe 文件 签名 数据 分析 asndump 分析 签名 数据 asnview 提取 证书及 分析 数据 四 pe 签名文件 新增 数据 五 总结 从 年月 开始 我 来 到了 一个 陌生 的 专业 网络空间 安全 初 入 安全 领域 是 非常 痛苦 和 难受 的 要 学 的 东西 太多 涉及面 太 广 但 好在 自己 通过 分享 篇 网络安全 自学 系列 文章 艰难 前行 着 感恩 这一 年 相识 相知 相 趣 的 安全 大佬 和 朋友们 如果 写得 不好 或 不足之处 还请 大家 海涵 接下来 我 将 开启 新 的 安全 系列 叫 系统安全 也是 免费 的 篇文章 作者 将 更加 深入 的 去 研究 恶意 样本 分析 逆向 分析 内网 渗透 网络 攻防 实战 等 也 将 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 加油 推荐 前文 网络安全 自学 篇 系列 篇 作者 的 github 资源 逆向 分析 网络安全 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 系统安全 八 windows 漏洞 利 用之 cve 复现 及 蓝屏 攻击 系统安全 九 windows 漏洞 利 用之 ms 远程 代码 执行 漏洞 复现 及 深度 提 权 系统安全 十 windows 漏洞 利 用之 smbv 服务 远程 代码 执行 漏洞 cve 复现 系统安全 十一 那些 年 的 熊猫 烧香 及 pe 病毒 行为 机理 分析 系统安全 十二 熊猫 烧香 病毒 ida 和 od 逆向 分析 上 病毒 初始化 系统安全 十三 熊猫 烧香 病毒 ida 和 od 逆向 分析 中 病毒 释放 机理 系统安全 十四 熊猫 烧香 病毒 ida 和 od 逆向 分析 病毒 释放 过程 下 系统安全 十五 chrome 浏览器 保留 密码 功能 渗透 解析 蓝屏 漏洞 及 某 音乐 软件 漏洞 复现 系统安全 十六 pe 文件 逆向 基础知识 pe 解析 pe 编辑 工具 和 pe 修改 系统安全 十七 windowspe 病毒 概念 分类 及 感染 方式 详解 系统安全 十八 病毒 攻防 机理 及 winrar 恶意 劫持 漏洞 脚本 病毒 自启动 定时 关机 蓝屏 攻击 系统安全 十九 宏病毒 之 入门 基础 防御 措施 自发 邮件 及 apt 宏 样本 分析 系统安全 二十 pe 数字签名 之 上 什么 是 数字签名 及 signtool 签名 工具 详解 系统安全 二十一 pe 数字签名 之 中 工具 用法 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 该 样本 不会 分享 给 大家 分析 工具 会 分享 参考文献 见 后 一 pe 文件 数字签名 过程 基础 概念 pe 文件 数字签名 能够 有效 保证 文件 未被 非法 篡改 安全 软件 通过 验证 文件 是否 有 正规 厂商 的 数字签名 来 降低 误报 其 基本 流程 如 下图 所示 签名 软件 发布者 使用 散 列 算法 如 md 或 sha 计算 pe 文件 的 散 列 值 软件 发布者 使用 私钥 对 散 列 值 进行 签名 得到 签名 数据 将 签名 私钥 对应 的 公 钥 和 签名 数据 等 以 证书 的 形式 附 加在 pe 文件 之中 形成 经过 数字签名 的 pe 文件 软件 发布者 将 经过 数字签名 的 pe 文件 进行 发布 验证 从 pe 文件 证书 中 提取 软件 发布者 的 公 钥 使用 的 散 列 算法 签名 算法 原始 散 列 值 的 签名 数据 使用 提取 的 公 钥 和 对应 签名 验证 算法 将 签名 数据 还 原为 原始 pe 文件 的 原始 散 列 值 对 现有 pe 文件 使用 同样 的 散 列 算法 计算出 对应 的 散 列 值 对比 两个 散 列 值 是否 一致 从而 判断 数据 是否 被 破坏 和 篡改 pe 文件 数字签名 所 使用 的 工具 包括 makecertexe 生成 数字签名 证书 signcodeexe 数字签名 工具 testexe 被 数字签名 的 目标 pe 文件 testcer 数字证书 文件 testpvk 数字签名 的 私钥 文件 我们 首先 需要 通过 makecertexe 工具 生成 证书 testcer 和 私钥 文件 testpvk 接着 调用 signcodeexe 工具 对 目标 pe 文件 testexe 进行 数字签名 其中 通过 makecertexe 生成 需要 的 证书 常见 参数 如下 r 自 签名 n 证书 名称 格式 为 ncn 名称 eemailo 组织 名称 c 国家 s 省份 州 p 县城 a 指定 散 列 算法 其 值 必须 是 md 默认值 或 sha 指定 证书 的 签名 权限 其 值 必须 是 commercial 商业软件 或 individual 个人 软件 b 证书 有效期 的 开始 时间 格式 为 mmddyyyye 证书 有效期 的 结束 时间 格式 为 egfreddews suchasaurl 数字签名 操作 第一步 打开 cmd 调用 makecertexe 并 输入 命令 生成 证书 文件 参数 表示 自 签名 个人 软件 授权 者 为 yxz 组织 单位 是 whu 国家 及 省份 散 列 算法 采用 md 有效期 是 到 需要 注意 设置 密码 如 成功 之后 可以 看到 新 增加 的 两个 证书 和 私钥 文件 第二步 双击 testcer 点击 安装 证书 并 设置 信任 根 证书 机构 信任 之后 此时 的 证书 是 受 信任 且 合法 的 查看 证书 详细信息 能够 看到 签名 算法 mdrsa 散 列 算法 md 颁发 者 信息 及 有效期 等 如 下图 所示 第三步 利用 signcodeexe 工具 进行 数据 签名 选择 需要 加密 的 testexe 文件 选择 我们 生成 的 数字证书 testcer 和 私钥 文件 testpvk 注意 这里 的 散 列 算法 选择 sha 这里 的 散 列 算法 是 pe 文件 的 签名 信息 而 之前 makecertexe 设置 的 md 是 证书 的 散 列 算法 暂时不 设置 时间 戳 最终 成功 为 testexe 进行 数字 签 签名 第四步 打开 testexe 文件 属性 可以 看到 它 增加了 一个 数字签名 的 区域 并且 能够 看 到此 数字签名 是 正常 的 及 详细信息 第五步 我们 采用 peview 打开 已 签名 和 未 签名 的 pe 文件 对比 发现 区域 为 前面 信息 注意 图中 ppt 均为 作者 制作 相关 视频 在 网易 云中 查看 二 pe 文件 签名 数据 提取 pe 文件 数字签名 信息 存放在 位置 同时 pe 文件 可选 文 件头 datadirecotry 第 项 记录 文件 偏移 及 大小 下 图为 pe 文件 数字 前面 的 pkcs 格式 参考文献 查看 签名 信息 第一步 使用 peview 查看 签名 的 testexe 文件 可以 看到 存储 相关 签名 信息 文件 开始 位置 a 长度 h 表项 长度 字节 头部 和 签名 数据 的 总长度 证书 版本 字节 常见 x 表示 wincertrevision 证书 类型 字节 常见 x 表示 包含 pkcs 的 signdata 结构 signeddata 包含 pe 文件 hash 值 的 签名 数据 软件 发布者 公 钥 选用 的 签名 及 散 列 算法 等 在 文件 中 为 asn 编码 对应 的 结构 第二步 在 pe 文件 可选 文 件头 datadirecotry 第 项 查看 文件 签名 信息 的 偏移 及 大小 此时 的 偏移 地址 是 a 大小 为 h 而 未 前面 的 pe 文件 其 值 均为 第三步 wrevision 表示 证书 的 版本号 表示 证书 类型 其 值 为 x 表示 包含 pkcs 的 signeddata 结构 接下来 我们 对 所 提取 的 签名 数据 就 需要用 该 格式 进行 解析 editor 提取 签名 数据 第一步 通过 editor 打开 签名 后 的 testexe 文件 第二步 这里 推荐 读者 在 editor 中 导入 pe 文件 解析 模板 更 方便 读者 对 pe 文件 的 解析 模板 运行 结果 如 下图 所示 我们 可以 查看 各个 区域 的 信息 后 一篇 文章 将 讲解 pe 文件 的 存储 格式 第三步 通过 运行 模板 找到 数字签名 的 偏移 地址 ah 和 大小 h 第四步 定位 到 签名 偏移 地址 从 第 个 字节 开始 后为 签名 信息 将其 复制 另存为 另一个 文件 如 testdat 此时 我们 的 签名 信息 成功 导出 后续 需要 进行 数据 分析 三 pe 文件 签名 数据 分析 pkcs 微软 官方 文档 一个 pkcssigneddata 结构 包括 pe 文件 的 哈希 值 一个 被 软件 出版 厂商 的 私钥 创建 的 签名 和 将 软件 出版 厂商 的 签名 密钥 和 法人代表 进行 绑定 的 系列 xv 证书 pkcs 版本 规范 定义 了如 下 关于 signeddata 的 asn 抽象 语法 符号 结构 注意 导出 的 testdat 签名 数据 为 asn 抽象 结构 需要 采用 asnview 或 asndump 进行 解析 其 效果 如 下图 所示 asndump 分析 签名 数据 第一步 调用 asndump 打开 testdat 解析 基础 数据 每个 字段 有 对应 的 flag 比如 指定 signeddata 结构 值 为 表示 采用 pkcs 结构 生成 签名 的 哈希 算法 mdshasha 签名 属性 spc 第二步 获取 证书 颁发 者 信息 包括 mdwithrsa 签名 证书 颁发 者 yxz 组织 whu 国家 及 省份 每块 数据通 常有 一个 标记变量 标记变量 对应 有 相关 值 比如 颁发 者 标记 和 颁发 者 yxz 散 列 算法 和 散 列 值 等第 三步 其他 相关 信息 核心 数据 包括 散 列 算法 摘要 数据 公 钥 数据 签名 后 数据 注意 rsa 签名 后 的 数据 和 公 钥 值 会 还原 出来 第一个 hash 值 摘要 数据 和 散 列 算法 将 计算 第二个 hash 值 如果 两个 值 一致 则 表示 该 pe 文件 在 传输 过程中 未被 篡改 或 破坏 且 受 信任 否则 已经 被 破坏 asnview 提取 证书及 分析 数据 第一步 回顾 我们 前面 的 签名 信息 和 证书 信息 如 下图 所示 pe 文章 签名 信息 的 散 列 算法 是 sha 签名 算法 是 rsa 签名 证书 的 散 列 算法 是 md 第二步 采用 asnview 打开 testdat 主 要由 三 部分 组成 左边 是 树形 asn 层次 结构 右上 部分 是 地址 数据 和 值 右下 部分 是 对应 的 解析 结构 接着 回到 最早 的 签名 结构图 我们 分 别对 每部 分 数据 进行 分析 第三步 分析 contentinfo 部分 数据 该 部分 主要 存储 pe 文件 的 hash 值 以及 标记变量 散 列 算法 等 比如 sha 散 列 算法 第四步 分析 certificates 部分 数据 该 部分 主要 存储 证书 相关 信息 包括 证书 发布者 证书 时间 戳 等 信息 注意 该 部分内容 可以 直接 导出 再 和 testexe 的 数字证书 进行 对比 比如 省份 hubei 接下来 我们 需要 导出 该 部分 的 证书 信息 下图 的 前个 字节 为 地址 和 大小 我们 从 开始 复制 这里 采用 editor 工具 复制 第五步 采用 editor 导出 证书 部分 数据 并 进行 对比 实验 对比 从 editor 导出 的 outputcer 证书 和 testexe 数字签名 信息 发 现是 一致 的 包括 公 钥 该 实验 也 证明了 签名 数据 的 第二部 分为 证书 信息 第六 部分 分析 signerinfos 部分 数据 该 部分 主要 存储 签名 使用者 的 信息 签名 的 hash 时间 戳 utc 时间 摘要 信息 签名 算法 等 如 下图 所示 第三 部分 的 长度 为 从 开始 为 第三 部分 的 具体 值 重要 的 值 包括 散 列 算法 sha 摘要 数据 标 记为 messagedigest 对应 的 值 存储 在 该 节点 的 set 部分 rsa 签名 后 的 数据 四 pe 签名文件 新增 数据 这里 我 提出 一个 问题 恶意 软件 是否能 隐藏 合法 证书 并 进行 签名 呢 pe 签名文件 是否能 新增 数据 而 不影响 签名 的 效果 呢 chrome 浏览器 中签 名 目录 曾 附加 数据 配置 数据 或 许可证 信息 如 等 那么 我们 是否 也 能 完成 相关 的 实验 呢 参考文献 当 我们 修改 pe 文件 的 签名 数据 或 新增 错误 数据 时 该 pe 文件 的 签名 信息 会 显示 被 破坏 如何 有效 的 新增 数据 呢 下面 开始 我们 的 实验 第一步 用 editor 打开 已 签名 的 testexe 文件 并 导入 pe 模板 第二步 修改 pe 文件 数字签名 的 大小 我们 将 h 修 改为 h 相当于 增加 h 第三步 并且在 数字签名 的 末尾 增加 h 内容 需要 注意 增加 的 字节 为 的 倍数 第四步 查看 testexe 属性 发现 数字签名 仍然 存在 且 正常 最终 我们 成功 的 在 数字签名 后 增加 信息 并且 没有 破坏 数字签名 如果 我们 将 恶意代码 隐 藏在 该 数字签名 中 是不是 其 危害 更大 如果能 绕过 杀毒软件 并进 行 相关 的 hook 或 植入 是不是 非常 可怕 呢 五 总结 文章 写到 这里 就 介绍 完毕 本文 主要 讲解 pe 文件 数字签名 并 对 其 进行 详细 解析 属于 系统安全 和 pe 逆向 相关 知识 希望 对 您 有所 帮助 内容 包括 pe 文件 数字签名 过程 pe 文件 签名 数据 提取 pe 文件 签名 数据 分析 pe 签名文件 新增 数据 文章 同时 也 加深 了 读者 对 相关 pe 解析 工具 的 使用 理解 包括 pevieweditor 及 模板 后续 将 学习 pe 文件 结构 知识 图标 修改 对话框 分析 exe 解析 加 壳 解密 等 希望 这 系列 文章 对 您 有所 帮助 同时 真的 感觉 自己 技术 好菜 要 学 的 知识 好多 从 网络安全 到 系统安全 从 木马病毒 到 后门 劫持 从 恶意代码 到 溯源 分析 从 渗透 工具 到 二进制 工具 还有 python 安全 安全 论文 黑客 比赛 和 漏洞 分享 未知 攻 焉知 防 人生 漫漫 其 路 远 兮 作为 初学者 自己 真是 爬着 前行 感谢 很多人 的 帮助 继续 爬着 继续 加油 欢迎 大家 讨论 是否 觉得 这 系列 文章 帮助 到 您 如果 存在 不足之处 还请 海涵 任何 建议 都可以 评论 告知 读者 共勉 逆向 分析 网络安全 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 晚 上点 写 于 贵阳 参考文献 武大 软件 安全 课程 网络安全 自学 篇 五十七 pe 文件 逆向 之 什么 是 数字签名 及 signtool 签名 工具 详解 一 对 windows 平 台下 pe 文件 数字签名 的 一些 研究 哈希 hash 数字签名 phant 恶意 文件 分析 系统 中 的 数字签名 验证 绿 盟 科技 翻译 windowspe 文件 中 的 数字签名 格式 看 雪 银 雁 冰 大神 pe 文件 数字签名 工具 ahuope 文件 解析 异常 处理表 与 数字签名 签名 伪造 pe 文件 的 签名 伪造 与 签名 验证 劫持 嘶吼 roartalk 数字签名 ctfwiki 数字签名 算法 介绍 和 区别 infinisign 求助 关于 pe 文件 的 数字签名 看 雪 论坛 区块 链 数字签名 是什么 chinakingkong 校验文件 数字签名 的 合法性 verifype ahuo 数字签名 shinymood 恶意 文件 分析 系统 中 的 数字签名 验证 百度 文库 如何 判断 一个 文件 是否 已经有 数字签名 csdn 论坛 