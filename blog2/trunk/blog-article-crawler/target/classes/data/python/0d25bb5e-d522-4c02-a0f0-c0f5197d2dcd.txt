系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 系统安全 系列 作者 将 深入研究 恶意 样本 分析 逆向 分析 攻防 实 战和 windows 漏洞 利用 等 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 前文 介绍 了 ollydbg 和 cheatengine 工具 逆向 分析 用法 完成 植物 大战 僵尸 的 游戏 辅助 器 包括 修改 阳光 值 和 自动 拾取 阳光 两个 功能 这篇 文章 将 带领 大家 来 学习 科 锐 钱 林 松 老师 的 视频 详细 讲解 条件 语句 和 循环 语句 源码 还原 及 流程 控制 逆向 希望 对 入门 的 同学 有 帮助 话 不 多说 让我们 开始 新 的 征程 吧 您 的 点 赞 评论 收藏 将是 对 我 最大 的 支持 感恩 安全 路上 一路 前行 如果有 写得 不好 的 地方 可以 联系 我 修改 基础性 文章 希望 对 您 有所 帮助 作者 的 目的 是 与 安 全人 共同进步 加油 文章 目录 一 c 逆向 条件 结构 基础 入门 单 分支 结构 分析 双 分支 结构 分析 二 c 逆向 循环 结构 基础 入门 dowhile 结构 分析 while 结构 分析 for 结构 分析 三 总结 作者 的 github 资源 系统安全 网络安全 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 破解 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 一 c 逆向 条件 结构 基础 入门 大家 写过 相关 的 算法 吗 加密 代码 中会 涉及 循环 和 分支 你 要 识别 算法 首先 就是 需要 将它 的 算法 处理 流程 识别 出来 当 我们 还原 出 等价 的 高级 代码 之后 就 没有 逆向 分析 人员 的 事情 了 因为 接下来 涉及到 密码学 数学 相关 人员 的 工作 逆向 人员 把 加密 的 代码 还原 出来 后 就应该 扔给 研究 密码学 的 数学家 他们 负责 玩 数学 对抗 而 逆向 关注 的 是 编译 原理 和 代码 还原 同时 逆向 还 涵 盖了 识别 对象 识别 算法 识别 优化 识别 虚 函数 对象 的 继承 关系 等等 这里 主要 结合 项目 相关 的 加密 和 解密 进行 讲解 接着 作者 准备 穿插着 vc 和 vs 两个 版本 进行 讲解 单 分支 结构 分析 第一步 通过 vc 编写 一个 最 简单 的 程序 创建 工程 名 称为 resf 运行 结果 如 下图 所示 可以 看到 helloworld 第二步 编写 单 分支 结构 的 相关 代码 intargccharargv if argcgt printf argcgtrn return 接着 选择 winrelease 编译 运行 代码 第三步 接着 用 od 软件 打开 exe 文件 此时 创建 的 工程 目录 分布 如 下图 所示 ollydbg 打开 之后 显示 如 下图 所示 的 界面 程序 入口 地址 是 x 程序 入口 x 第四步 首先 我们 需要 定位 main 函数 其 方法 非常 简单 找到 有 三个 push 的 下面 就是 main 函数 因为 main 函数 有 三个 参数 argcargvenvp 接着 按 f 下 断 点主 函数 x 继续 按 下 f 跟进 会 看到 一个 单 分支 结构 那么 单 分支 结构 它有 什么 特点 呢 进 入主 函数 x 第五步 先给 大家 普及 单 分支 语句 的 代码 定式 基础知识 在 高级 语 言中 单 分支 代码 定式 如下 程序语言 if 代码 定式 为什么 需要 记住 这个 代码 定式 呢 因为 对于 流程 控制 的 识别 我们 关键是 要 找到 if 语句 的 作用 域 上界 和 下界 上界 在 jxx 的 位置 称之为 ifbegin 接着 有 个 jxx 条件 跳转 跳 转到 目标 且 没有 其他 的 特征 这种 就 称之为 单 分支 的 代码 定式 回到 我们 的 汇编 代码 拿到 这个 代码 之后 发现 存在 一个 箭头 指向 跳转 目标 这样 就 出现 了 if 模块 的 上界 和 下界 条件 判断 作为 if 的 上界 条件 跳转 的 目标 作为 if 下界 通过 这种 套路 方式 来 还原 代码 第六步 分析 嵌套 的 单 分支 语句 假设 我们 的 判断 中 再 嵌套 一层 或 增加 一个 分支 又该 怎么 判断 呢 对于 我们 还原 代码 的人 来说 不用 管它 你 把 上 下界 圈 出来 然后 递归 解决 所有 流程 问题 只要 找到 上 下界 剩下 的 问题 就 变 成了 顺序 结构 再 看着 代码 一条条 还原 即可 intargccharargv if argcgt printf argcgtrn if argclt printf argcltrn system pause return 接着 运行 程序 生成 新 的 exe 程序 然后 通过 od 软件 打开 分析 给 主 函数 下个 断点 然后 进 入主 函数 显示 如 下图 所示 的 界面 主 函数 内容 x 第七步 同样 的 方法 将 两层 单 分支 语句 的 上 下界 圈 出来 我们 发现 这两个 判断 的 下界 重合 了 都是 跳 转到 x 位置 这就 明显 是 个 嵌套 总 结下 if 语句 的 特点 观察 它 的 条件 跳上 下界 条件 跳 的 目标 上面 的 代码 没有 其他 特征 即 addesp 那么 怎么 还原 出 高级 代码 呢 第八 步 通过 汇编 代码 还原 出 高级 代码 还原 代码 需要 进行 反 条 节 操作 并且 学会 查询 相关 指令 比如 jlejge 是什么 意思 呢 汇编语言 中 的 条件 转移 指令 小于 或 等于 则 条件 转移 jge 大于 或 等于 转移 指令 注 意在 还原 的 时候 需 要做 反 条件 操作 那么 什么 叫 反 条件 呢 具体 解释 如下 jle 小于 等于 跳转 gt 代码 还原 就是 不小于 等于 即 大于 跳转 jge 大于 等于 跳转 gt 代码 还原 就是 不大于 等于 即 小于 跳转 反 条件 因为 当 我们 满足 这个 条件 的 时候 它会 跳 转到 另一个 地方 结束 地方 它 没有 执行 具体 的 代码 所以 如果 我们 想要 执行 模块 中 的 代码 就需要 反 条件 处理 即 汇编 的 语义 和 高级 语言 的 语义 是 反 的 高级 语言 的 语义 是 满足 条件 则 执行 语句 块 而 汇编 的 语义 是 满足 条件 不 执行 语句 块 接着 我们 继续 看 触发 跳转 的 代码 它是 通过 cmp 比较 来 触发 的 cmpesiesi 是 通过 参数 传递 过来 的 然后 和 进行 不小于 等于 的 比较 cmpesiesi 和 进行 不大于 等于 的 比较 此时 我们 再将 单 分支 步骤 简单 归纳如下 通过 反汇编 代码 序列 匹配 代码 定式 如果是 单 分支 if 结果 则将 条件 转义 指令 jxx 做 反 条件 还原 第九步 接着 我们 换个 工具 用 vs 打开 我们 的 代码 生成 新 的 release 版本 然后 删除 本地 的 release 资源 生成 一个 新 的 release 方案 第 十步 用 idapro 打开 可执行 exe 程序 进行 分析 同样 使用 ida 也是 可以 进行 逆向 分析 的 打开 新 生成 的 逆向 分析 工具 如下 所示 右键 选择 textview 查看 源代码 找到 main 函数 然后 点击 main 位置 高亮 显示 按 下 n 键 可 以对 函数 进行 重命名 如 下图 所示 注意 前面 分享 的 识别方法 和 编译器 版本 编程 语言 cvb 等 都没有 关系 它是 编译 原理 的 问题 接着 我们 重点 还是 回 归到 代码 上去 点击 loc 函数 高亮 同样 的 方法 划 分出 这个 单 分支 的 上界 和 下界 并且 嵌 套了 一个 单 分支 最终 还原 出 源代码 所以 不论 使用 vc 或 vs 编译 工具 还是 使用 ida 或 od 分析 工具 它们 还原 代码 的 原理 及 方法 都是 一样 的 在 实际 项 目中 不论 你 用 什么 分析 工具 最 终能 分 析出 结果 就好 双 分支 结构 分析 第一步 编写 双 分支 代码 第二步 普及 双 分支 语句 的 代码 定式 基础知识 在 高级 语 言中 双 分支 代码 定式 如下 该 代码 序列 关键是 发现 jxx 后 需要 检查 目标 看看 下面 有没有 一个 jmp 指令 如果有 个 jmp 且 是 往下跳 的 ifelse 就 成 立了 程序语言 if else 代码 定式 第三步 接着 生成 新 的 exe 文件 用 od 打开 分析 同样 的 方法 进 入主 函数 然后 f 单步 步入 x 位置 如 下图 所示 核心 代码 及其 跳转 如 下图 所示 jlegtxepush 操作 jmpgtxcall 操作 双 分支 结构 特点 jxx 的 目标 处 上 一行 指令 为 jmp 而且 是 往 高 地址 去 的 jmp 往下跳 如果是 循环 后面 会 讲到 它 可能 往上 跳 确定 上 下界 之后 生成 如 下图 所示 的 if 模块 和 else 模块 同样 的 反 条件 处理 还原 代码 注意 这里有 一个 小小的 优化 编译 原理 中 的 代码 外 提 它是 什么意思 呢 假设有 个 节点 a 现在 有 了 流程 分支 b 和 bb 完成后 执行 cb 完成后 也 会 执行 c 编译器 为了 减小 代码 的 节点 因为 代码 节点 越多 代码 越长 就 做了 等价 流程 的 代码 外 提 优化 从而 汇总 到 c 少了 一个 节点 编译器 会 视 情况 减少 节点 的 优化 编译器 也 会 增加 节 点来 减小 路径 的 优化 第四步 采用 同样 的 方法 用 ida 工具 分析 还原 代码 其 效果 也 一样 接着 你 可能会 疑问 这两个 push 是 干啥 呢 语 言中 没有 标准 的 高级 语法 对应 汇编 中 的 push 操作 说明 它有 代码 优 化了 就是 代码 外 提 操作 它们 有 个 公共 的 函数 调用 被 提到 下面 去了 就是 下图 所示 的 两行 代码 这个 时候 我们 要把 它 放 回去 方便 还原 接着 我们 复制 汇编 代码 至 c 语言 中 进行 还原 方便 大家 理解 代码 如下 此时 增加了 if 和 else 的 上 下界 但 发现 两个 push 无法 还原 同时 将 代码 外 提 部分 分别 放到 if 和 else 模块 中 就能 实现 最终 代码 还原 如 下图 所示 最后 删 除掉 多余 的 汇编 注释 即可 继续 还原 条件 判断 内容 jle 小于 等于 换成 大于 就 好在 真实 环境 中 还会 遇到 双 分支 中有 循环 或 条件 嵌套 的 问题 不要 担心 找到 上 下界 继续 分析 即可 intargccharargv argcgt argcgtrn argcltrn pause return 二 c 逆向 循环 结构 基础 入门 dowhile 结构 分析 循环 包括 dowhilewhile 和 for 三种 你 会 觉得 哪一种 消息 最高 呢 dowhile 是 三种 循 环中 效率 最高 的 由于 其 无条件 先 执行 一次 所以 大家 很少 使用 但 其 效率 很高 基本 语法 先 执行 再 判断 先 执行 一遍 循环 操作 若 符合 条件 循环 操作 继续 执行 否则 退出 循环 do 循环 操作 语句 whlie 循环 条件 第一步 我们 编写 一个 加到 的 循环 代码 这次 直接 使用 debug 版本 intargccharargv 执行 一次 nlt printf dnsum system pause return 第二步 通过 od 打开 运行 的 exe 程序 rexhexe 程序 入口 地址 x 第三步 往下 查找 代码 发现 个 push 后 参数 就是 主 函数 然后 f 添加 断点 并 f 步 入主 函数 主 函数 callrexh 第四步 分析 汇编 代码 这里 存在 一个 jle 跳转 如果 条件 跳 往上 跳 就是 dowhile 循环 循环 肯定会 往上走 否则 构 成不了 循环 它 需要 反复 执行 同一 代码 段 如果 跳转 的 目标 没有 检查 条件 就是 dowhile 循环 简单 总 结下 识别 dowhile 循环 步骤 识别 代码 定式 如果是 do 循环 则按 jxx 同 条件 还原 等价 高级 代码 注 意同 条件 的 就只 有 dowhile 结构 在 dowhile 循 环中 它 跟 汇编 的 语义 是 一样 的 只 有当 条件 满足 则 流程 更 新到 循环 的 起始 地点 所以 它是 正 条件 还原 而 前面 的 ifelse 判断 都是 反 条件 程序语言 dowhile xxx 代码 定式 结构 分析 基本 语法 先 判断 再 执行 whlie 循环 条件 循环 操作 语句 第一步 我们 编写 一个 加到 的 循环 代码 intargccharargv nlt dnsum system pause return 第二步 分析 while 循环 的 代码 定式 注意 该 循环 的 debug 版本 和 release 版本 存在 差异 接下来 会对 比 分析 我们 先 给出 代码 定式 如下 所示 程序语言 while xxx 代码 定式 循环 的 条件 跳 是 往上 跳 的 它 需要 反复 执行 同一 代码 段 第三步 通过 od 打开 运行 的 exe 程序 rexhexe 程序 入口 地址 x 第四步 往下 查找 代码 发现 个 push 后 参数 就是 主 函数 然后 f 添加 断点 并 f 步 入主 函数 主 函数 callrexh 第五步 分析 汇编 代码 这里 存在 一个 jg 跳转 它 有点像 if 语句 下面 还有 一个 jmp 有点像 ifelse 指令 但是 它 的 跳转 是 地址 减量 跳 或 往上 跳 所以 它是 循环 这时 会 发现 while 循环 比 刚才 的 多了 一个 跳转 我们 会 过 计算机 组成 原 理当 处理器 执行 跳转 指令 时 流水线 会 暂时 挂起 失效 本来 流水线 在 取 指令 时 已经 准备 预 读后 面的 代码 了结 果在 译码 过程中 是 个 跳转 后面 的 代码 预 读 就会 出错 然后 做 流水线 清理 工作 所以 while 循环 有 两 跳 对流 水线 的 伤害 比 dowhile 大 第六步 接着 我们 用 高 版本 vs 编译 一个 release 版本 并用 ida 进行 分析 看看 高 版本 有 什么 优化 查看 textview 我们 定位 到 main 函数 之后 看看 它 做的 优化 它把 循环 的 起点 对齐 到 十六进制 的 倍数 地址 中间 会用 nop 进行 空 指令 填充 同时 它 的 汇编 循环体 变 成了 dowhile 循环 注意 前面 的 vcdebug 版本 用 ida 工具 打开 如 下图 所示 上图 和 下图 同样 都是 while 循环 但 低版本 可以 看到 jg 往下跳 和 jmp 往上 跳 两个 跳转 典型 的 while 循环 而 高 版本 的 却 修改 成了 dowhile 循环 的 形式 问题 由于 dowhile 循环 会 执行 一次 循环体 难道 它不 担心 编译器 出错 吗 其实 它 比较 的 数值 是 常量 常量 可以 在 编译 期间 预置 其 结果 的 其实 编译器 在 第一次 的 判断 时 先进 行了 一次 常量 传播 令 n 等于 即 判断 的 是 while lt 比较 和 的 关系 条件 必 成立 问题 那么 如果 将 替换成 变量 编译器 还能 识别 吗 或者 会 报错 此时 的 编译器 会 将其 进行 转换 变成 如 下图 所示 的 形式 再 执行 dowhile 循环 其中 if nltargc 条件 判断 嵌套 一个 循环 对应 的 汇编 代码 如下 其中 jlshortloc 往下跳 还原成 一个 单 分支 循环 里面 还有 一个 跳转 jleshortlocf 往上 跳 满足 dowhile 循环 最终 还原成 if 加 dowhile 或者 你 知道 有 这个 优化 直接 还原成 带 变量 的 while 循环 也 可以 但 需要 注意 能不 能把 dowhile 直接 还原成 while 循环 还需要 看看 这两个 条件 有没有 相关性 如果有 相关性 才能 还原 比如 外层 判断 是 文件 的 打开 状态 while 是 迭代 n 值 这种 情况 不能 还原 下图 可以 看到 if 和 循环 都是 eax 参数 比较 所以 具有 相关性 for 结构 分析 下面 开始 分析 for 循环 结构 for 表达式 表达式 表达式 语句 第一步 我们 编写 一个 for 循环 代码 intargccharargv intnsumfor intnnltargcn nsumnsumnprintf dnsum system pause return 第二步 编译 生成 新 的 debug 版 可执行 程序 第三步 通过 ida 打开 运行 的 exe 程序 rexhexe 产 出了 三个 跳转 代码 如 下图 所示 其 代码 定式 如下 所示 可以 看到 jmpjg 和 jmp 三个 跳转 注意 for 循 环中 forstep 地址 是 低于 body 执行 体 的 地址 的 第四步 分析 汇编 代码 首先 mov 进行 初始化 赋值 接着 jmp 跳 转到 比较 部分 比较 不成立 则 jg 直接 跳出 循环 否则 执行 循环体 body 内容 接着 继续 jmp 跳转 上去 执行 n 操作 注意 由于 release 版本 都被 编译器 优化 成了 dowhile 循环 所以 我们 需 要在 debug 版 下 进行 对比 第五步 通过 vs 生成 release 版本 然 后用 ida 打开 代码 对比 ida 打开 如 下图 所示 发现 和 dowhile 一样 高 版本 做了 一点 小 处理 每次 循环 总 次数 增加了 addeax 从而 提升 效率 三 总结 写到 这里 这篇 文章 就 介绍 完毕 希望 对 您 有所 帮助 最后 进行 简单 的 总 结下 条件 语句 逆向 分析 循环 语句 逆向 分析 学 安全 一年 认识了 很多 安全 大佬 和 朋友 希望 大家 一起 进步 这篇 文章 中 如果 存在 一些 不足 还请 海涵 作者 作为 网络安全 初学者 的 慢慢 成长 路 吧 希望 未来 能 更 透彻 撰写 相关 文章 同时 非常感谢 参考文献 中 的 安全 大佬 们 的 文章 分享 深知 自己 很菜 得 努力 前行 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 周五 夜 于 武汉 参考资料 真心 推荐 大家好 好看 看 这些 视频 和 文章 感恩 这些 大佬 前 非常 推荐 钱 老师 的 视频 感谢 华 科 up 主科 锐 逆向 的 钱 林 松 老师 受 华中 科技大学 邀请 逆向 分析 计算 引导 c 语言 逆向 工 程之 游戏 辅助 开发 c 语言 