译 apt 分析 报告 08. 漏洞 利用 图谱 通过 查找 作者 的 指纹 来 寻找 漏洞 这是 作者 新开 的 一个 专栏 主要 翻译 国外 知名 安全 厂商 的 apt 报告 了解 它们 的 安全 技术 学习 它们 溯源 apt 组织 和 恶意代码 分析 的 方法 希望 对 您 有所 帮助 当然 由于 作者 英语 有限 会 借助 机 翻 进行 校验 还请 包涵 前文 分享 了 apt 组织 拉 撒 路 lazarus 使用 的 两款 恶意 软件 后 渗透 工具 和 blindingcan 这篇 文章 将 详细 讲解 checkpoint 公司 提出 的 一个 新技术 即 漏洞 利用 图谱 通过 查找 作者 的 指纹 来 寻找 利用 漏洞 文章内容 非常 值得 我们 学习 尤其 搞 科研 研究 的 读者 原文 标题 原文 链接 文章 作者 伊 泰 科 金 iyalitkin 伊 泰 科 恩 itaycohen 发布 时间 年月日 文章 来源 文章 目录 一 背景 二 漏洞 利用 集成 三 指纹 漏洞 利用 开发者 四 我们 行动 者 的 漏洞 利用 五 作者 指纹 playbit 又名 操作系统 指纹 内核 地址 泄漏 tokenswap 六 客户 分析 七 结论 附录 ioc 表 在 过去 的 几个 月中 我们 的 漏洞 和 恶意 软件 研究 团队 共同努力 专注 于 恶意 软件 内部 的 漏洞 利用 研究 尤其是 漏洞 利用 者 本身 从一 个 事件 响应 案例 开始 我们 构 建了 windows 最 活跃 的 漏洞 利用 开发人员 之一 的 档案 称为 volodya 或 buggicorp 到目前为止 我们 设法 跟踪 了 他们 windows 内核 本地 特权 升级 lpe 漏洞 中 的 多个 其中 许多 漏洞 为 day 漏洞 一 背景 正如 所有 有趣 故事 一样 我们 的 故事 始于 一个 应急 响应 案例 在 分析 针对 我们 客户 的 一个 复杂 攻击 时 我们 注意到 该 恶意 软件 执 行了 一个 很小 的 位 可执行文件 该 样本 包 含了 一些 不寻常 的 调试 字符串 这些 调试 字符串 指向 试图 利用 受害者 计算 机上 的 漏洞 更 重要 的 是 该 示例 有 一个 遗留 的 pdb 路径 并 指向 了 该 二进制 目标 文件 由于 cve 实 现时 没有 任何 在线 资源 我们 意识到 我们 看到 的 不是 一个 公开 可用 的 poc 而是 一个 真实 的 开发工具 这 激 发了 我们 深入 挖掘 的 兴趣 对 漏洞 进行 逆向 工程 非常 直接 二进制 文件 很小 并且 调试 消息 在那里 指导 我们 它 利 用了 createwindowsex 中 的 一个 uaf 漏洞 来 获取 父 进程 的 更高 特权 我们 很快 发现了 一个 有趣 的 现象 似乎 这个 漏洞 和 恶意 软件 本身 并不是 由 同一 个人 编写 的 其 代码 质量 缺乏 混淆 pdb 和 时间 戳 都 表 明了 这个 结论 图 createwindowex 调用 如 cutter 所示 特权 提升 漏洞 cve 是 createwindowex 函数 中 提供 的 useafterfree 漏洞 当 wink 组件 无法 正确处理 内存 中 的 对象 时 windows 中 存在 一个 特权 提升 漏洞 成功 利用 此 漏洞 的 攻击者 可以 在 内核 模式 下 运行 任意 代码 然后 攻击者 可以 安装 程序 查看 更改 或 删除 数据 或 创建 具有 完全 用户 权限 的 新 帐户 二 漏洞 利用 集成 我们 倾向于 将 特定 恶意 软件 家族 背后 的 人们 视为 一个 完整 的 单元 设想 每一个 组件 都是 由 一个人 团队 或 小组 编写 而成 事 实是 编写 一个 高级 恶意 软件 无论是 国家 还是 apt 组织 都 需要 不同 技能 的 不同 人群 一个 国家 的 网络 攻击 组织 很可 能在 不同 的 组织 和 分支 中有 数百 甚至 数千 名 员工 组织 中 的 每个 工人 都有 一个 特定 的 角色 并 通过 特殊 的 技术培训 和 多年 的 专业知识 进行 调整 在 这样 的 组织 中 编写 公共 组件 的 工作量 被 分解 到 专门 的 团队 中 不同 的 团队 将 负责 初始 访问 收集 敏感数据 横向 移动 等等 模块 一个 运营 实体 的 目标 是 在 它 的 恶意 软件 中 嵌入 一个 漏洞 利用 模块 exploit 不能 只 依赖 恶意 软件 开发人员 发现 漏洞 并 可靠地 利用 漏洞 很 可能是 由 专门从事 特定 角色 的 特定 团队 或 个人 来 完成 的 对于 恶意 软件 开发人员 来说 他们 并不 真正 关心 其 幕后 是 如何 工作 的 他们 只是 想 集成 这个 模块 并 完成 它 为了 实现 这种 劳动 分工 两个 团队 需 要就 一些 api 达成 共识 这些 api 将 成为 不同 组件 之间 的 桥梁 这种 集成 api 并不是 国家 参与者 所 独有 的 而是 漏洞 利用 自由市场 中 很 常见 的 功能 无论是 在 地下 论坛 漏洞 利用 经纪人 还是 网络 攻击 组织 他们 都会 向 客户 提供 如何将 利用 漏洞 利用 程序 集成 到 恶意 软件 中 的 指导 手册 从 本质上 讲 这个 集成 点 是 我们 研究 的 重点 假设 利用 漏洞 的 作者 独立 工作 并且 只将 他们 的 代码 二进制 模块 分 发给 恶意 软件作者 我们 决定 对 他们 进行 更改 通过 分析 嵌入 在 恶意 软件 样本 中 的 漏洞 利用 程序 我们 可以 了解 有关 漏洞 利用 程序 作者 的 更多 信息 希望 通过 研究 他们 的 编码 习惯 以及 将其 产品 分 发给 编写 恶意 软件 的 同 行时 留下 的 其他 线索 来 区分 他们 的 身份 作者 简单 总结 下在 大型 网络 攻击 活动 或 apt 组织 中 由于 需要 不同 团队 协作 来 完成 攻击 事件 因此 各个 团队 间 需要 调用 api 来 搭建 桥梁 比如 实现 初始 访问 数据 收集 横向 移动 等功能 最终 构建 恶意程序 并且会 提供 相应 的 集成 手册 基 于此 会 造成 他们 的 编程 习惯 漏洞 利用 细节 信息 不同 这篇 文章 将 通过 收集 漏洞 利用 的 线索 来 区分 他们 的 身份 三 指纹 漏洞 利用 开发者 本文 不是 专注 于 一个 完整 的 恶意 软件 溯源 和 寻找 新 样本 的 恶意 软件 家族 或 参与者 而是 想 提供 另一种 观点 并 决定 专注 于 漏洞 利用 开发人员 编写 的 这 几个 功能 从 事件 响应 案例 中 获得 这个 小 的 位 二进制 文件 看起来 是 个 不错 的 开始 该 二进制 文件 除了 利用 cve 之外 什么 也 没做 并且 它不 基于 开源 的 源代码 或 poc 由于 可执行文件 是 由 漏洞 利用 作者 攻击者 以外 的 其他人 编写 而成 因此 它 非常 适合 指纹识别 此外 可执行文件 与 恶意 软件 的 主要 二进制 文件 是 分离 的 一个 臭名昭著 的 犯罪 软件 这 让我们 相信 这个 漏洞 不是 由 恶意 软件 开发人员 内部 开发 的 带着 这个 希望 我们 开始 寻找 同一 作者 编写 的 更多 的 exploit 我们 首 先从 已经 拥有 的 二进制 文件 中 收集 简单 的 信息 checkpoint 字符串 内部 文件名 时间 戳 pdb 路径 第一个 结果 立即 出现 了 一个 与 位 示例 完全 匹配 的 位 可执行文件 具体来说 正如 它们 的 时间 戳 和 嵌入式 pdb 路径 所 显示 的 那样 它们 是 在 同一时间 从 相同 的 源代码 中一 起 编译 的 现在 我们 有 了 这两个 样本 我们 就能 得出 要 寻找 的 东西 为了 对 这个 漏洞 的 作者 进行 指纹识别 我们 将 目光 投向 了 以下 方面 二进制 文件 中 的 独特 工件 硬 编码 值 加密 常量 垃圾 值 例如 x 数据表 通常是 特 定于 版本 的 配置 字符串 gdi 对象 名称 等 pdb 路径 代码 段 独特 的 功能 实现 a 系统 调用 包装 器 syscallb 内联 汇编 c 专有 加密 函数 实现 技术 和 习惯 a 首选 的 泄漏 技术 等 b 首选 的 提升 技术 如何 执行 token 替换 c 堆 溢出 技术 使用 构架 a 漏洞 利用 流程 选项 几乎没有 分支 的 主要 漏洞 利用 流程 选项 针对 不同 版本 操作系统 的 多个 扭曲 和 旋钮 b 代码 和 函数 的 结构 模块化 功能 分离 结构 分离 以 清除 阶段 初始化 配置 喷涂 令牌 交换 等 全局变量 哪些 信息 存储 在 全局变量 中 操作系统 版本 枚举 操作系统 版本 特定 字段 偏移量 c 特 定于 版本 的 配置 字段 偏移量 哪些 字段 特别 重要 首选 系统 调用 系统 调用 的 首选 集合 d 提供给 客户 的 api 图 寻找 的 与 利用 漏洞 相关 的 工件 集 对应 原文 带着 这些 属性 回到 我们 拥有 的 两个 样本 并 标 记了 一些 我们 认为 独特 的 工件 即使 只有 两个 小 的 二进制 文件 本质上 是 相同 的 我们 仍然 能够 创建 搜寻 规则 来 查找 该 开发人员 编写 的 更多 示例 令 我们 惊讶 的 是 我们 能够 找到 比 想象 中 更多 的 东西 一个 接 一个 的 出现 了 几十个 样本 随着 每一个 样本 的 出现 我们 改 进了 搜寻 规则 和 方法 通过 对 样本 的 仔细分析 我们 能够 了解 哪些 样本 利 用了 哪个 cve 并以 此为 基础 创 建了 一个 时间表 以 了解 该 漏洞 是 在 暴露 之前 的 day 漏洞 还是 基于 补丁 扩散 和 类似 技术 实现 的 day 漏洞 到目前为止 仅 基于 我们 的 指纹识别 技术 且 没有 进一步 的 情报信息 我们 就可以 将 多个 cve 归因于 同一个 漏洞 利用 开发人员 后来 公开 的 报告 披 露了 我们 的 目标 漏洞 利用 exploit 销售者 的 名 称为 volodya 又名 volodimir 以前 称为 buggicorp 似乎 我们 不是 唯一 跟踪 此 漏洞 卖家 的 卡巴 斯基 也 报道 关于 他们 的 一些 相关 信息 此外 eset 在 vb 关于 buhtrap 的 演讲 中 还提 到了 volodya 的 一些 重要 线索 根据 卡巴 斯基 的 说法 volodya 最初 以其 buggicorp 绰号 成为 头条新闻 当时 他们 在 臭名昭著 的 exploit 网络 犯罪 论坛 上 宣传 了 windowsday 的 待售 广告 起价 为 万美元 多年来 价格 不断 上涨 他们 的 一些 windowslpeday 漏洞 利用 软件 的 售价 高达 万美元 正如 卡巴 斯基 报告 中所 发表 的 后来 得到 我们 的 证实 volodya 将 漏洞 利用 软件 卖给 了 犯罪 软件 和 apt 团体 我们 将在 客户 一节 中 详细 讨论 actor 的 客户 四 我们 行动 者 的 漏洞 利用 尽管 我们 最初 的 一些 狩猎 规则 需要 进行 一些 微调 但 即使是 我们 得到 的 即时 结果 也 相当 令人 惊讶 经过 进一步 的 校准 后 我们 找 到了 许多 示例 所有这些 示例 都是 windows 中 的 本地 特权 升级 漏洞 从 这些 样本 中 我们 的 行动 者 actor 能够 确定 所 利用 的 cve 列表 注意 在对 漏洞 进行 分类 时 我们 选择 了 一种 保守 的 方法来 决定 一个 给定 的 漏洞 是 day 还是 day 如果 其他 安全 供应商 将 在野 的 漏洞 归因于 我们 的 行动 者 那么 它 就是 day 如果 我们 发现 足够 的 证据 表明 我们 的 某个 样本 的 确是 利用 在外 传播 的 漏洞 就像 供应商 在 他们 的 报告 中 描述 的 那样 那么 我们 也 会 标记 它为 day 在所 有 其他 情况下 我们 将该 漏洞 标 记为 day 宁愿 有 较低 数量 的 day 而 不 错误 计数 超过 正确 的 数量 cve 分类 day 基本 描述 在 中 释放 后 使用 useafterfreeday 报告 供应商 fireeye 在 以下 恶意 软件 样本 中 发现 ursnifbuhtrap 我们 的 漏洞 利用 示例 使 用了 与 初始 报告 中 所述 不同 的 内存 整形 技术 喷射 而 而 不是 加速器 表 此外 我们 最早 和 最基本 的 攻击 示例 包含 以下 pdb 路径 这表明 作者 已经 知道该 漏洞 的 分类 day 基本 描述 中 未 初始化 的 内核 指针 报告 供应商 na 从来没有 在野 被 当做 day 利 用过 在 以下 恶意 软件 样本 中 发现 ursnif 该 漏洞 利用 已 用于 单个 样 本该 样本 还 包含 前面 描述 的 cve 漏洞 如果 目标 是 windows 之前 的 windows 版本 则 选择 此 漏洞 否则 使用 cvecve 分类 day 基本 描述 在 中 释放 后 使用 useafterfreeday 报告 供应商 fireeye 在 以下 恶意 软件 样本 中 发现 punchbuggy 我们 的 漏洞 利用 样本 与 在野 的 漏洞 利用 技术 报告 完全 吻合 cve 分类 day 基本 描述 在 中 释放 后 使用 useafterfreeday 报告 供应商 kaspersky 被 卡巴 斯基 发现 但未 公开 发布 任何 报告 在 以下 恶意 软件 样本 中 发现 ursnif 这是 一个 有趣 的 案例 我们 方案 的 daycve 已于 年月 由 microsoft 修补 该 补丁 也 修复 了 cve 该 漏洞 也 被 广泛 在外 使用 为了 寻找 新 的 漏洞 进行 利用 我们 的 行动 可 能对 微软 的 修补 程序 进行了 不同 的 修补 并 发现了 一个 认为是 修 补过 的 day 漏洞 此 漏洞 源于 之前 漏洞 中 修 补过 的 函数 注意 我们 从 他们 针对 该 漏洞 的 漏洞 样本 中找到 多个 迹象 表明 该 漏洞 作者 或 他们 的 客户 确定 他们 已 出售 了 一个 针对 cve 的 漏洞 可悲 的 是 在 分析 这个 漏洞 之后 我们 确定 这个 被 利用 的 漏洞 是 一个 不同 的 漏洞 图 调试 字符串 显示 cve 的 混淆 可以 从 cutter 中 看到 这种 困惑 可能是 由于 微软 发布 了 一个 解决 多个 漏洞 的 单一 修复 而且 它们 是 唯一 一个 在 每个 代码 修复 与 为 其 发布 的 cve 之间 有 完整 映射 的 补丁 cve 分类 day 基本 描述 在 中 内存 损坏 报告 供应商 google 被 谷歌 发现 通过 技术 报告 趋势 科技 trendmicro 在 以下 恶意 软件 样本 中 发现 apt 又叫 fancybear 或 sednit 后来 被 使 用在 中 我们 的 漏洞 利用 样本 完美地 与 在野 漏洞 利用 技术 报告 吻合 后来 这个 特定 的 漏洞 被 不同 的 勒索 软件 参与者 广泛 使用 此外 我们 还看 到了 其他 针对 这个 特定 漏洞 的 利用 这些 漏洞 在 day 期间 被 卖给 了 其他 勒索 软件 参与者 注意 我们 有 多个 间接 证据 认为 这个 day 就是 那个 由 buggicorp 在 年月 发布 到 exploit 著名 广告 中 提到 的 漏洞 cve 分类 day 基本 描述 在 中 释放 后 使用 useafterfreeday 报告 供应商 na 从来没有 在野 被 当做 day 利 用过 在 以下 恶意 软件 样本 中 发现 turla 归因于 turla 后来 被 使 用在 ursnif 中 turlafireeye 在 操作 中 当作 day 漏洞 使 用过 cve 分类 day 基本 描述 在 中 释放 后 使用 useafterfreeday 报告 供应商 eset 在 以下 恶意 软件 样本 中 发现 apt 又叫 fancybear 或 sednit 我们 的 漏洞 利用 样本 与 在野 的 漏洞 利用 技术 报告 完全 吻合 cve 分类 day 基本 描述 在 重复 释放 doublefreeday 报告 供应商 na 从来没有 在野 被 当做 day 利 用过 在 以下 恶意 软件 样本 中 发现 magniber 同样 识别 使 用过 的 day 通常 比 识别 day 漏洞 更难 这一次 我们 找不到 任何 可能 暗示 参与者 认为 他们 正在 利用 的 漏洞 示例 我们 发现该 漏洞 已于 年月 被 微软 修补 在 扫描 此 补丁 中 解决 的 漏洞 列表 后 我们 非常 确定 微软 将此 漏洞 标 记为 cve 但 我们 无法 确认 年月日 卡巴 斯基 在其 博客 上 发表 了 一份 通过 大规模 漏洞 利用 工具 分发 的 漏洞 利用 攻击 在 他们 的 博 文中 卡巴 斯基 分析 了 magniber 使用 的 lpe 漏洞 将其 归因于 volodya 并 预测 其 可能是 cve 这 进一步 通过 卡巴 斯基 的 独立 结论 验证 了 我们 的 初步 估计 cve 分类 day 基本 描述 在 createwindowex 中 释放 后 使用 useafterfreeday 报告 供应商 kaspersky 在 以下 恶意 软件 样本 中发 现 用作 一个 独立 的 组件 被 注入 或 加载 我们 无法 将其 归因于 任何 特定 的 apt 恶意 软件 我们 的 漏洞 利用 示例 与 有关 野生 漏洞 利用 的 技术 报告 完全 吻合 我们 的 研究 始于 在 客户 网络 中 发现 的 这种 漏洞 利用 的 单个 样本 在 我们 后来 发现 的 样本 中 我们 可以 看清 这个 pdb 字符串 该 字符串 和 我们 最初 示例 中 的 pdb 字符串 相反 分类 day 基本 描述 在 中空 指针 引用 报告 供应商 eset 在 以下 恶意 软件 样本 中 发现 归因于 buhtrap 我们 有 多个 理由 相信 这是 volodya 的 另一个 day 漏洞 因为 报告 中 的 多个 技术细节 匹配 他们 典型 的 利用 方式 此外 该 漏洞 报告 其中 嵌 入了 以下 pdb 路径 然而 这是 我们 列表 中 唯一 尚未 找到 样本 的 漏洞 因此 我们 不能 确定 这一 漏洞 的 归属 cve 分类 day 基本 描述 在 窗口 切换 时 内存 损坏 day 报告 供应商 kaspersky 初始 报告 详细 报告 在 以下 恶意 软件 样本 中 发现 归因于 操作 wizardopium 我们 的 漏洞 利用 和 技术 报告 里 的 漏洞 利用 不一致 此外 在 他们 的 详细 报告 中 卡巴 斯基 指出 同样 有趣 的 是 我们 在 补丁 发布 一周 后 就 发现了 另一个 day 漏洞 这表明 利用 这个 漏洞 非常 简单 事实上 我们 的 样 本是 在 卡巴 斯基 首次 报告 后 的 第 天 最后 通过 下表 总 结了 我们 列出 的 个 漏洞 五 作者 指纹 现在 我们 从 volodya 那里 发现了 多个 不同 的 exploit 我们 可以 更 详细 地 审查 它们 并 熟悉 actor 的 工作 习惯 从一 开始 我们 就很 清楚 我们 的 参与者 可能有 一个 简单 的 模板 他们 可以 针对 不同 的 漏洞 利用 程序 进行 部署 因为 每个 漏洞 利用 程序 的 功能 流程 甚至 不同 功能 的 顺序 都在 大多数 漏洞 利用 程序 之间 共享 在 本节 中 我们 将 描述 一组 关键 特征 这些 特征 反映 了 在 创建 exploit 模板 时 volodya 所做 的 不同 实现 选择 我们 将 他们 的 实现 与 昵 称为 playbit 的 另一个 exploit 编写 器 的 实现 进行 比较 通过 这种 比较 旨在 概述 漏洞 利用 各部分 中 存在 的 各种 实现 选项 从 而使 每个 作者 的 实现 选择 集 成为 他们 思 维和 工作方式 的 独特 签名 playbit 又名 luxor 使用 我们 用来 搜寻 volodya 漏洞 的 相同 技术 我们 设法 追踪 了 playbit 编写 的 个 windowslpeday 漏洞 以及 作者 多年来 销售 的 其他 工具 我们 从 revil 勒索 软件 使用 的 cve 样本 开始 并 使用 playbits 的 独特 指纹 来 寻找 更多 漏洞 我们 发现 以下 windowslpe 漏洞 由 作者 实 施为 daycvecvecvecve 这是 volodya 的 daycve 从技术上 讲 playbit 还 出售 了 针对 cve 一个 sandboxescaper 漏洞 和 cve 的 两个 漏洞 但是 我们 忽略 这些 漏洞 因为 它们 不是 内存 损坏 漏洞 而是 不同 服务 中 的 漏洞 因此 具有 不同 的 结构 注意 关于 playbit 的 更 深入分析 以及 他们 开发 和 销售 的 不同 漏洞 将在 即将 发布 的 博 文中 发布 的 所有 exploit 样本 中 的 api 总是 相同 的 无论 它是 嵌入 在 一个 恶意 软件 样本 中 还是 一个 独立 的 poc 该 漏洞 都有 以下 签名 的 单一 api 函数 boolelevate inttargetpid 图 调用 elevate targetpid 函数 可以 在 cutter 中 看到 该 漏洞 本身 并不 包括 将 shellcode 注入 到 另一个 进程 或 任何 类似 的 功能 它 向 所需 的 进程 授予 系统 特权 只 接受 其 pid 作为 参数 sleep 该 elevate 函数 在被 恶意 软件 调 用后 所做 的 第一 件事 是 调用 sleep 函数 休眠 毫秒 的 固定 时间 图 通过 调用 sleep 来 启动 漏洞 如 cutter 中 所示 为什么 sleep 会出 现在 模板 中 还 不是 很 清楚 我们 怀疑 这是 为了 避免 不必要 的 不稳定 特别 是因为 这些 漏洞 是 基于 时间 安排 uafraces 因此 短时间 的 等待 与 io 和 内存 访问 相关 的 活动 结束 可以 提高 稳定性 由于 这些 漏洞 是 恶意 软件 的 一部 分在 漏洞 利用 程序 执行 之前 所有这些 与 恶意 软件 相关 的 代码 都会 导致 cpu 磁盘 ram 出现 短暂 的 峰值 因此在 进行 实际 漏洞 利用 之前 让 情况 有所 缓和 可能是 有意义 的 对于 短期 峰值 负载 在 启动 新 进程 从 磁盘 读写 文件 等 情况下 自然会 发生 它 应该 足足 等待 毫秒 尽管 我们 在 最近 的 示例 中 注意到 这种 模式 的 变化 但是 仍然 可以 在 我们 发现 的 个 漏洞 中找到 该 功 能与 playbit 的 比较 playbit 在其 利用 中 没有 任何 此类 功能 操作系统 指纹 sleep 函数 结束 后 该 漏洞 利用 程序 就会 识别 并 校准 目标 的 windows 版本 以便 为 尽可能 多 的 os 版本 提供 支持 从 我们 的 样本 中 作者 似乎 使 用了 两种 技术 来 查询 操作系统 解析 ntdlldll 的 头部 这是 最 常用 的 技术 ntdlldll 句柄 用于 查找 imagentheaders 的 偏移量 从 这里 解析 和 字段 getversionex 该 技术 通常 与 前一种 技术 一起 使用 仅 在年 至 年初 的 样品 中 使用 这可 能 是因为 这个 api 现在 已经 弃 用了 图 调用 getversionexw 以 获取 windows 版本 如 cutter 所示 在这 两种 技术 中 目标 都是 查询 操作系统 的 主 版本 和 次 版本 并 相应 地 配置 漏洞 利用 程序 的 全局变量 虽然 大多数 的 利用 都 支持 多种 windows 版本 但 volodya 似乎 从不 关心 目标 的 特定 服务 包 也 不关心 它 是否 是 windows 服务器 除了 对 特定 的 windows 构建 版本 感兴趣 之外 仅在 cve 漏洞 中 使用 我们 的 actor 只 使 用了 主要 版本 和 次要 版本 仅此而已 与 playbit 的 比较 再 再次 使用 getversionex 通常 随后 还要 对 流程 环境 块 peb 本身 的 主次 编号 进行 额外 解析 如图所示 不仅 使用 peb 代替 ntdlldllplaybit 还从 getversionex 输出 中 提取 额外 的 信息 如 计算机 的 服务 包 servicepack 甚至 检查 目标 计算机 是否 使用 服务器 操作系统 图 从 peb 中 提取 主要 版本 和 次要 版本 如 cutter 所示 这是 两个 行动 者 在 操作 方式 上 的 明显 区别 它们 不 仅以 不同 的 方式 提取 相同 的 信息 而且 即使 它们 都 利 用了 相同 的 漏洞 cvevolodya 感兴趣 的 信息 也 远 少于 playbit 通常 两个 参与者 都 持有 详细 的 特 定于 版本 的 配置 一旦 确定 了 操作系统 版本 他们 就从 这些 配置 加载 相关 信息 两者之间 的 主要 区 别是 volodya 的 漏洞 利用 代码 流 很少 依赖于 操作系统 版本 playbit 使 用了 多种 依赖于 操作系统 版本 的 ifcheck 来 进行 多重 扭曲 和 旋转 这 反过来 又 影 响了 它们 对 确切 版本 细节 的 不同 兴趣 内核 地址 泄漏 在 绝大多数 漏洞 利用 中 操作者 使用 内核 指针 泄漏 原语 来 调整 漏洞 利 用在 除 cve 之外 的 所有 漏洞 利用 中 此 漏洞 原语 都是 众所周知 的 技术 是 userdll 的 一个 内部 未 导出 函数 它被 各种 函数 如 ismenu 所 利用 并可 用于 获取 所有 windows 版本 直到 windowsrs 中 不同 window 对象 的 内核 地址 这种 技术 很 有名 早 在年 就 开始使用 了 当时 大多数 开发 教程 都 选择 专门 解析 ismenu 来 找到 的 地址 令人 惊讶 的 是 在数 十个 用于 查找 的 不同 函数 中 参与者 只是 简单 地 遵循 了 著名 的 教程 并 选择 了 使用 ismenu 更 令人 惊讶 的 是 多年来 这种 常见 的 利用 技术 仍然 非常 有效 使得 参与者 没有 动力 通过 选择 一个 不太 为人所知 的 函数 如 来 隐藏 泄露 给 我们 的 信息 如下 我们 窗口 的 内核 地址 threadinfopti 字段 的 内核 地址 该 漏洞 利用 过程中 的 多个 步骤 将 使用 此 信息 地址 在 指向 创建 假 的 内核 结构 体 时 使用 确保 我们 的 内核 地址 是 有效 的 unicode 字符串 不 包含 两个 连续 的 x 字节 该 pti 用于 定位 一个 有效 的 eprocess 然后 其 在 令牌 交换 阶段 中 使用 与 playbit 的 比较 playbit 选择 通过 直接 访问 用户 模式 桌面 堆 来 实现 此 功能 关于 这个 主题 的 更多 内容 可以 在 未来 关注 这个 actor 的 博 文中 找到 tokenswap 该 漏洞 的 最终目标 是 根据 给定 的 pid 参数 将 系统 权限 授予 所需 进程 传统 上 实现 这一点 的 方法 是 用 系统 进程 的 令牌 替换 结构 中 的 进程 令牌 下面 是 一些 常用 的 技巧 您 会 惊讶 地 发现有 多少 不同 的 选项 可以 实现 此 功能 使用 ps 符号 内核 包含 以下 与 进程 相关 的 函数 和 全局变量 获取 一个 指向 进程 eprocess 的 指针 全局变量 它 保存着 一个 指向 系统 eprocess 的 指针 返回 一个 指向 进程 主 令牌 token 的 指针 通过 在 内核 模式 下 执行 这些 函数 一个 给定 的 shellcode 可以 很 容 易地 定位 系统 的 令牌 但是 它 仍然 不能解决 如何 在 所需 的 eprocess 中 分配 它 的 问题 为此 有 两种 常见 的 解决方案 使用 特定 版本 的 偏移量 直接 访问 eprocess 内部 的 正确 偏移量 扫描 eprocess 查找 我们 自己 的 指针 通过 前 面对 的 调用 知道 一旦 找到 匹配 的 条目 就 替换 它 这种 技术 需要 以 内核 模式 执行 代码 因此 会被 smep 保护 阻止 除非 部署 了 额外 的 smep 旁路 扫描 pslist 查找 目标 进程 和 系统 进程 eprocess 的 常见 替代 方法 是 扫描 双向 链接 的 进程 列表 称为 pslist 此 技术 涉及 的 步骤 为 找到 一个 初始 过程 使用 泄漏 的 pti 字段 扫描 pslist 以 查找 具有 目标 pid 的 eprocess 通过 查找 pid 为 或 名 称为 的 方式 扫描 pslist 以 搜索 system 的 eprocesssys 提取 令牌 并 将其 放置 在 目标 进程 中 的 匹配 偏移量 中 谨慎 更新 system 令牌 的 引用 计数 图 使用 任意 读 原语 搜索 sys 的 volodya 漏洞 可以 在 cutter 中 看到 这种 技术 需要 pslist 的 主 令牌 和 listentry 的 偏移量 要求 它们 都 存储 在 特 定于 版本 的 配置 中 该 技术 的 主要 优点 是 尽 管它 仍然 可以 作为 一个 简单 的 shellcode 在 内核 模式 下 执行 正如 cve 所做 的 那样 但 它也 可以 在 用户 模式 下 完全 实现 为此 您 需要 两个 利用 原语 一个 用于 任意 读来 自 内核 空间 另一个 用于 任意 写进 入 内核 空间 在 用户 模式 下 运行 解决 了 我们 之前 详细 介绍 的 关于 smep 的 问题 使 这种 保护 对 此类 exploit 原语 毫无用处 由于 令牌 是 一个 引用 计数 对象 因此 正确 注册 刚刚 添加 的 引用 非常重要 以 避免 在 升级 的 进程 终止 时 出现 蓝屏 死机 bsod 事实 上有 两种 不同 的 引用 计数 令牌 是 一个 exfastref 对象 较低 的 指针 位 用作 引用 计数 将 anobjectheader 存储 在 令牌 之前 并 保留 另一个 引用 计数 由于 参与者 选择 更新 后 一个 引用 计数 字段 因此 需要 执行 以下 步骤 从 标记 的 指针 中 屏蔽掉 refcount 位 在位 进程 上 应该 对齐 到 字节 在位 进程 上 应该 对齐 到 字节 减去 指向 objectheader 的 refcount 字段 所需 的 常量 读 取值 使用 任意 读取 的 exploit 原语 相应 地 增加 它 回 写 更新 后 的 值 但是 如图所示 我们 在 包含 此 功能 的 所有 位 漏洞 利用 程序 中 发现了 以下 错误 图位 漏洞 利用 中 的 引用 计数 更新 中 的 实现 错误 读取 引用 计 数值 时 对齐 掩码 对齐 到 字节 而回 写 更新 后 的 值 时 使用 不同 的 掩码 如果 令牌 将被 存储 在 一个 对齐 到 字节 而 不是 对齐 到 字节 的 内存地址 中 写 操作 将 更新 错误 的 字段 虽然 cve 和 cve 使用 的 是 ps 技术 但 到目前为止 扫描 pslist 是 我们 的 actor 最喜欢 的 执行 令牌 交换 的 方式 在 他们 的 个 漏洞 中使 用过 在 其中 的 个 例子 中 他们 使 用了 用户 模式 的 任意 读 和 任意 写 与 playbit 的 比较 在 他们 的 所有 样本 中 我们 总是 看到 playbit 使用 ps 函数 进行 令牌 交换 这一 决定 迫使 参与者 实现 了 一些 smep 绕过 他们 将 这些 绕过 集成 到 cve 和 cve 的 后续 攻 击中 这种 设计 选择 解释 了 为什么 参与者 不 麻烦 地 实现 适当 的 任意 读取 原语 作为 利用 的 一部分 playbit 不使 用 版本 特定 的 配置 来 对 eprocess 中 的 令牌 偏移量 进行 搜索 而是 总是 扫描 eprocess 来 搜索 它 通常 使用 x 或 x 作为 搜索 的 上限 值得注意 的 是 playbit 在 不同 的 攻击 中 使用 的 内存 破坏 技术 也 被 duqu 所 使用 并在 微软 年 的 vb 演讲 中进 行了 分析 通过 这种 内存 破坏 它们 可以 触发 从 内核 内 存到 内核 内存 的 一些 内存 读写 这 将在 攻击 期间 起到 帮助 作用 图 playbit 漏洞 扫描 eprocess 以 搜索 令牌 如 cutter 所示 尽管 我们 可以 讨论 其他 方面 例如 每个 参与者 在 开发 过程中 喜欢 使用 的 不同 系统 调用 对 windows 和 scrollbars 之类 的 已 创建 对象 的 命名 约定 但 我们 相信 上面 的 清单 清楚地 证明了 我们 方法 的 效率 有效性 从上 面的 列表 可以 看出 漏洞 利用 程序 的 几乎 每个 方面 都可以 几种 不同 的 方式 实现 尽管如此 我们 两个 演员 在 各自 的 剥削 程序上 都 非常 一致 每个人 都 坚持 自己 喜欢 的 方式 六 客户 分析 在 我们 的 整个 研究 过程中 我们 想把 重点 放在 开发 作者 本身 无论是 volodyaplaybit 或 其他 然而 我们 认为 通过 观察 这些 利用 作者 的 客户 还有 很多 东西 要 学习 volodya 的 客户名单 多种多样 包括 ursnif 等 银行家 木马 作者 gandcrabcerber 和 magniber 等 勒索 软件作者 以及 turlaapt 和 buhtrap 等 apt 组织 有趣 的 是 我们 可以 看到 volodya 的 day 更有 可能 卖给 apt 组织 而 day 则 被 多个 犯罪 软件 组织 购买 没有 进一步 的 情报 我们 只能 假设 一旦 day 漏洞 被 安全 行业 检 测到 该 漏洞 就 会被 回收 并以 更低 的 价格 作为 非 排他性 的 day 漏洞 出售 apt 的 客户 turlaapt 和 buhtrap 都被 普遍 认为是 俄罗斯 的 有趣 的 是 即使是 这些 高级 团队 也 购买 漏洞 而 不是 自己 开发 这是 另一 点 进一步 加 强了 我们 的 假设 编写 exploits 可以 作为 一个 单独 的 和 不同 的 部分 恶意 软件 处理 下表 总结 并 显示 了 我们 能够 归因于 volodya 的 cve 以及 使用 这些 漏洞 发现 的 客户 或 恶意 软件 组 标有 蓝色 的 cve 为 day 自然 更 昂贵 左侧 高亮 显示 的 组 被 视为 apt 图 volodya 的 客户 和 他们 使用 的 cve 在 回顾 我们 在 一段 时间内 检查 漏洞 样本 时 注意到 的 不同 趋势 之前 我们 应该 强调 我们 的 可 见性 有限 因为 我们 不能 讨论 尚未 捕获 的 day 此外 我们 只能 尝试 确定 样本 的 年代 直到 它们 被 捕获 之前 但 令人遗憾 的 是 我们 通常 基本上 确定 的 是 这种 漏洞 首次 在野外 被 发现 的 时间 此外 值得一提的是 volodya 在 开发 第一个 漏洞 cve 时 就 已经 非常 专业 了 例如 它有 一个 独特 的 任意 编写 原语 我们 无法 追踪 到任 何其 他 的 exploit 教程 或 exploit 在 分析 这些 漏洞 以及 我们 收集 的 数十 个 恶意 软件 样本 的 过程中 我们 注意到 一个 有趣 的 变化 早期 的 volodya 漏洞 作为 源代码 出售 以 嵌入 恶意 软件 中 后来 的 漏洞 作为 接受 特定 api 的 外部 工具 出售 这一 变化 表明 volodya 采 取了 更多 的 预防措施 在年 至 年 期间 我们 也 注意到 volodya 的 技术 技能 有 了 显著 的 提高 当 他们 变得 更好 和 更有 经验 时 volodya 开始使用 更 有效 的 任意 读 和 写 原语 他们 甚至 修复 了 这些 原语 之间 的 一个 bugcve 和 cve 此外 这些 漏洞 的 代码 变得 更加 模块化 因为 大型 函数 被 分 割成 更小 的 子 例程 同时 他们 在 各种 结构 中 搜索 和 访问 特定 偏移量 的 技术 也 得 到了 改 进在 最近 的 实现 中 它 变得 更加 动态 和 安全 因为 它在 windows 的 小 版本 中 更好 地处 理了 变化 这 不仅 显示 了 我们 actor 的 学习曲线 和 发展 也 暗示 了 他们 的 技能 找到 并 可靠地 利用 windows 内核 漏洞 的 能力 并不是 那么 简单 的 相比之下 playbit 在年 期间 在 这个 市场上 非常 活跃 他们 的 重点是 销售 day 漏洞 其中之一 是 day 的 volodya 漏洞 cve 七 结论 我们 的 研究 方法 是 对 漏洞 利用 作者 的 特征 进行 指纹识别 然后 再将 这些 属性 用作 唯一 的 狩猎 签名 在 跟踪 volodya 和 playbit 的 漏洞 时 我们 两次 部署 了 此 技术 有 了 这两个 成功 的 测试 案例 我 我们 相信 该 研究 方法 可 用于 确定 其他 漏洞 利用 程序 作者 我们 建议 其他 研究人员 尝试 我们 建议 的 技术 并 将其 用作 其 武器库 中 的 其他 工具 在 这项 研究 中 我们 重点 研究 了 apt 攻击 和 商品 恶意 软件 尤其是 勒索 软件 中 不同 恶意 软件 系列 所 使用 或 嵌入 的 漏洞 尽管 它们 很 普遍 但 我们 经常 发现 详尽 的 恶意 软件 报告 而 忽略 了 提及 手边 的 恶意 软件 也 利用 漏洞 来 提升 其 特权 的 报告 事实上 我们 能够 反复 地 使用 我们 的 技术 来 跟踪 个 windowslpe 漏洞 这些 漏洞 是 由 两个 不同 的 角色 编写 和 销售 的 这是 非常 令人 惊讶 的 考虑到 其中 个 是 在年 的 时间 框架 内 我们 有理由 认为 它们 构 成了 开发 市场 的 重要 份额 特别是 针对 windowslpe 的 开发 最后 我们 不可 能说 出 windows 内核 day 漏洞 的 总数 这些 漏洞 正 在被 广泛 利用 我们 仍然 可以 通过 观察 被捕 捉到 的 漏洞 来 获得 洞见 同时 记住 这种 生存 偏差 去年 卡巴 斯基 报告 说 一个 单一 的 参与者 分 发了 超过 个 day 的 利用 框架 把 这些 数字 加起来 我们 发现 个 零日 漏洞 中有 个 超过 一半 的 市场份额 是 由 两名 actor 完成 的 这 意味着 我们 的 研究 技术 有 可能 被 用于 追踪 可视 市场 中 的 许多 actor 如果 不是 全部 的话 保护 建议 checkpoint 威胁 模拟 可 针对 以下 威胁 提供 保护 前文 分享 译 apt 分析 报告 linux 系统 下 针对性 的 apt 攻击 概述 译 apt 分析 报告 钓鱼 邮件 网址 混淆 url 逃避 检测 译 apt 分析 报告 opblueraven 揭露 apt 组织 fincarbanak 上 tirion 恶意 软件 译 apt 分析 报告 kraken 新型 无 文件 apt 攻击 利用 windows 错误报告 服务 逃避 检测 译 apt 分析 报告 turla 新型 水坑 攻击 后门 netflash 和 pyflash 译 apt 分析 报告 猖獗 的 小猫 针对 伊朗 的 apt 攻击 活动 详 解译 apt 分析 报告 拉 撒 路 lazarus 使用 的 两款 恶意 软件 分析 译 apt 分析 报告 漏洞 利用 图谱 通过 查找 作者 的 指纹 来 寻找 漏洞 年月 新开 的 娜 璋 ai 安全 之家 主要 围绕 python 大数 据分析 网络空间 安全 逆向 分析 apt 分析 报告 人工智能 web 渗透 及 攻防 技术 进行 讲解 同时 分享 ccfsci 南 核 北 核 论文 的 算法 实现 娜 璋 之家 会 更加 系统 并 重构 作者 的 所有 文章 从 零 讲解 python 和 安全 写了 近十年 文章 真心 想把 自己 所学 所 感 所做 分享 出来 还请 各位 多多指教 真诚 邀 请您 的 关注 谢谢 byeastmount 星期 二晚 上点 写 于 武汉 附录 ioc 表 